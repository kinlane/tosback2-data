rb.registerNamespace("rb.widget");rb.widget.storepicker=rb.widget.base.extend({get_moviesUrl:function(){return this._moviesUrl},set_moviesUrl:function(a){this._moviesUrl=a},get_getSuggestions:function(){return this._getSuggestions},set_getSuggestions:function(a){this._getSuggestions=a},get_inTitlesContext:function(){return this._inTitlesContext},set_inTitlesContext:function(a){this._inTitlesContext=a},get_searchUrl:function(){return this._searchUrl},set_searchUrl:function(a){this._searchUrl=a},init:function(){this._super();this._buttonSetWidget=null;this._currentStoreSuggestion=null;this._getSuggestions=false;this._moviesUrl=null;this._productRef=null;this._inTitlesContext=null;this._processStoreChange=false;this._searchUrl=null;this._suggestionCache=[];this._buttonList=null;this._buttonTemplate=null;this._dialogHandler=null;this._rentButton=null;this._searchBox=null;this._searchButton=null;this._searchIcon=null;this._storeList=null;this._storeTemplate=null;this._widget=null;this._delegates={onChangeLocation:rb.createDelegate(this,this._onChangeLocation),onSearch:rb.createDelegate(this,this._onSearch),onSuggestionsLoaded:rb.createDelegate(this,this._onSuggestionsLoaded)};this._subscriptions=[this.events.storeChange]},loadSuggestions:function(a){this._productRef=a;if(this._getSuggestions){this.lock();if(this._suggestionCache[this._productRef]){this._onSuggestionsLoaded(this._suggestionCache[this._productRef])}else{rb.api.store.getSuggestedStoresWithInventory(a,this._delegates.onSuggestionsLoaded,this._baseDelegates.onAjaxFailDelegate)}}},lock:function(){this._locked=true;this.getControl("Stores").hide();this.getControl("ProgressBar").show()},unlock:function(){this._locked=false;this.getControl("ProgressBar").hide()},_onLoad:function(a,b){this._super(a,b);this._buttonList=this.getControl("ButtonList");this._buttonTemplate=this.getControl("ButtonTemplate");this._dialogHandler=this.getControl("DialogHandler");this._searchBox=this.getControl("SearchBox");this._searchButton=this.getControl("SearchButton");this._searchIcon=this.getControl("SearchIcon");this._storeList=this.getControl("StoreList");this._storeTemplate=this.getControl("StoreTemplate");this._widget=this.getControl("Widget");this._buttonSetWidget=rb.component.findFirstByType("buttonset");this._widget.find(".sp-btn").click(this._delegates.onChangeLocation);this._searchBox.attr("title",this.getText("EnterAddressOrZip")).simpleWaterMark("watermark");this._searchButton.click(this._delegates.onSearch);this._searchIcon.click(this._delegates.onSearch);var c=rb.persistence.cookie.get("locationSearchValue");if(c){this._searchBox.val(c)}},_onStoreChange:function(a,b){if(b.state=="completed"&&this._processStoreChange&&b.store&&b.store.id){this._suggestionCache=[];this._recordSelectKiosk(b.store.id);this._dialogHandler.click();if(this._rentButton){this._buttonSetWidget.onClick(this._rentButton,true)}else{if(!this._inTitlesContext&&b.store.id>-1){this.navigate(this._moviesUrl)}}this._processStoreChange=false}},_onChangeLocation:function(b){var c=$(b.currentTarget);var a=c.parent("[kioskID]").attr("kioskID");if(c.hasClass("rb-btn-rent")&&c.attr("buttonkey")>0){this._rentButton=b}else{this._rentButton=null}if(c.hasClass("sp-btn-clear")){this._processStoreChange=false}else{this._processStoreChange=true}rb.app.store.selectStore(a)},_onKeyEnter:function(a){this._onSearch();return false},_recordSelectKiosk:function(c){if(!c){return}var b=[];b.push("event32");var a={prop17:c,eVar32:c};rb.rec.Omn.RecordAction("SelectedLocation",a,b)},_onSearch:function(){var a=this._searchBox.val();var b=this._productRef?"&productRef="+this._productRef:"";if(this._validate(a)){rb.persistence.cookie.set("locationSearchValue",a);this.navigate(this._searchUrl+"?loc="+a+b)}},_onSuggestionsLoaded:function(a){if(this._productRef){this._suggestionCache[this._productRef]=a}if(a&&a.data&&a.data.length>0){rb.parseTemplate(this._storeTemplate,this._storeList,a.data.skiptake(0,3));rb.parseTemplate(this._buttonTemplate,this._buttonList,a.data.skiptake(0,3));this._widget.find(".location-kiosk-content").show();if(this._productRef){this._widget.find(".sp-btn").text(this.getText("Rent")).attr("buttonkey",this._productRef).button().click(this._delegates.onChangeLocation)}else{this._widget.find(".sp-btn").text(this.getText("Select")).button().click(this._delegates.onChangeLocation)}this.getControl("Stores").show()}this.unlock()},_validate:function(b){if(b.length<2){return false}var a=this.getText("EnterAddressOrZip");if(b.substring(0,a.length)===a){return false}return true}});