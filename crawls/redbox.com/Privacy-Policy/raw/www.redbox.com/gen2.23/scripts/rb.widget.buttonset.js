var lockRecord=false;rb.registerNamespace("rb.widget");rb.widget.buttonset=rb.widget.base.extend({get_rent:function(){return this._rent},set_rent:function(a){this._rent=a},get_inCart:function(){return this._inCart},set_inCart:function(a){this._inCart=a},get_find:function(){return this._find},set_find:function(a){this._find=a},get_findNearby:function(){return this._findNearby},set_findNearby:function(a){this._findNearby=a},get_remindMe:function(){return this._remindMe},set_remindMe:function(a){this._remindMe=a},get_processing:function(){return this._processing},set_processing:function(a){this._processing=a},get_inventory:function(){return this._inventory},set_inventory:function(a){this._inventory=a},get_reminders:function(){return this._reminders},set_reminders:function(a){this._reminders=a},get_runView:function(){return this._runView},set_runView:function(a){this._runView=a},get_enableSuggestedStores:function(){return this._enableSuggestedStores},set_enableSuggestedStores:function(a){this._enableSuggestedStores=a},get_locationsUrl:function(){return this._locationsUrl},set_locationsUrl:function(a){this._locationsUrl=a},init:function(){this._super();this._cart=null;this._inventory=null;this._registeredSets={};this._reminders=null;this._runView=null;this._currentCtx=null;this._enableSuggestedStores=null;this._locationsUrl=null;this._storeChanged=null;this._storePicker=null;this._rent=null;this._inCart=null;this._find=null;this._findNearby=null;this._remindMe=null;this._processing=null;this._isCompletedCart=false;this._subscriptions=[this.events.storeChange,this.events.cartChange]},lock:function(a){if(a.data("locked")==null||a.data("locked")==false){a.data("locked",true);if(a.find(".ui-button-text").size()>0){a.data("button-text",a.find(".ui-button-text").html());a.find(".ui-button-text").html("<span>"+this.get_processing()+"</span>")}}},isCompletedCart:function(a){this._isCompletedCart=a},unlock:function(a){if(a.data("locked")==true){a.data("locked",false);if(a.find(".ui-button-text").size()>0){a.find(".ui-button-text").html("<span>"+a.data("button-text")+"</span>")}}},updateButton:function(a,h){this.unlock(a);var e=a.attr("buttonkey");var c=a.attr("comingsoon");var b=a.siblings(".rb-ribbon");if(h===undefined){h=this.resolveButtonSet(a)}var g="";var f="";var d="";if(c&&c=="1"){if(this._isReminded(e)){d='<div class="rb-btn-reminded-'+h+'">'+this.get_remindMe()+"</div>";g="rb-blue rb-btn-reminded";f="rb-ribbon-blue"}else{if(this._isCompletedCart){d='<div class="rb-btn-remind-'+h+'">'+this.get_remindMe()+"</div>";g=" rb-red rb-btn-remind";f="rb-ribbon-red"}else{d='<div class="rb-btn-remind-'+h+'">'+this.get_remindMe()+"</div>";g=" rb-red rb-btn-remind";f="rb-ribbon-red"}}}else{if(this._isInCart(e)){d=this.get_inCart()+'<div class="rb-btn-cart-'+h+'"></div>';g="in-cart rb-blue rb-btn-cart";f="rb-ribbon-blue";if(this._isKioskSelected()&&!this._isInStock(e)){g+=" rb-btn-oos"}}else{if(this._isKioskSelected()){if(this._isInStock(e)){d=this.get_rent();g="w-loc rb-blue rb-btn-rent";f="rb-ribbon-red"}else{d=this.get_findNearby();g="ooo rb-orange rb-btn-find rb-btn-oos";f="rb-ribbon-orange"}}else{d=this.get_find();g="no-loc rb-blue rb-btn-find";f="rb-ribbon-red"}}}if(a.find(".ui-button-text").size()>0){a.find(".ui-button-text").html("<span>"+d+"</span>");a.removeClass("w-loc no-loc ooo rb-red rb-blue rb-orange rb-btn-remind rb-btn-reminded rb-btn-cart rb-btn-rent rb-btn-find rb-btn-oos").addClass(g)}else{a.html(d);a.addClass(g)}if(b.size()>0){b.removeClass("rb-ribbon-red rb-ribbon-blue rb-ribbon-orange").addClass(f)}},createButton:function(c){var b=rb.component.findFirstByType("buttonset");var a=c.find("[buttonkey]:first");b.updateButton(a,b.resolveButtonSet(a));if(a.attr("latebind")!="true"){b.registerSingle(a)}},onClick:function(a,b){this._storeChanged=(b)|false;this._onButtonClicked(a)},refresh:function(a){this._onRegistered(this._registeredSets[a].find(".rb-btn-unreg"))},raiseStoreDialog:function(a,c){if(this._enableSuggestedStores){if(this._storePicker==null){this._storePicker=this.findFirstChildByType("storepicker")}var b=this;this._storePicker.loadSuggestions(a);this._raiseDialog("StoreDialog",function(){b._recordFindingMethod(c);b._closeDialog(true)},null,"380px")}else{if(a){this.navigate(this._locationsUrl+"?productRef="+a)}else{this.navigate(this._locationsUrl)}}},register:function(d,c,a,b){if(this._registeredSets[d]!=undefined&&this._registeredSets[d].autoUpdate==true){return}this._registeredSets[d]=c;if(a==true){this._registeredSets[d].autoUpdate=true;this._registeredSets[d].auCallback=b}else{this._registeredSets[d].autoUpdate=false;this._registeredSets[d].auCallback=null}this.refresh(d)},registerSingle:function(a){this._onRegistered(a)},resolveButtonSet:function(a){return a.parents("[buttonset]:first").attr("buttonset")},_onLoad:function(a,b){this._super(a,b);this._storeChanged=false;if($("[buttonset]").size()>0){var c=this;$("[buttonset]").each(function(){var e=$(this);c.register(e.attr("buttonset"),e)});rb.app.store.requireInventoryOnStoreChange();this._cart=rb.app.cart.getItems();var d=rb.persistence.cookie.get("addreminder");if(rb.app.user.isLoggedIn()&&d!=null){rb.api.account.addComingSoonNotify(d,function(){c._reminders.push(d);rb.persistence.cookie.remove("addreminder");c._refreshButtons('[buttonkey="'+d+'"]');var e=false;c._recordClick(null,d,null,"comingSoon",e,"remind")})}}},_isInCart:function(a){if(this._cart){for(i=0;i<=this._cart.length-1;i++){if(this._cart[i]["productRef"]==a){return true}}}return false},_isInStock:function(a){if(this._inventory){for(i=0;i<=this._inventory.length-1;i++){if(this._inventory[i]["id"]==a&&this._inventory[i]["stock"]){return true}}}return false},_isReminded:function(a){if(this._reminders){for(i=0;i<=this._reminders.length-1;i++){if(this._reminders[i]==a){return true}}}return false},_isKioskSelected:function(){return rb.app.store.isStoreSelected()},_onButtonClicked:function(e){var b=$(e.currentTarget);var g=b.data("locked");this._currentCtx=b;if(g==null||g==false){var f=b.attr("buttonkey");var l=this._getProduct(f);var h=b.attr("incartPromotion");if(h==null){h=0}var m=b.parents("[buttonset]:first").attr("fromCart");var c=this;if(b.hasClass("rb-btn-remind")){if(rb.app.user.isLoggedIn()){this.lock(b);rb.api.account.addComingSoonNotify(f,function(){c._reminders.push(f);c._refreshButtons('[buttonkey="'+f+'"]');c._recordClick(null,f,null,"comingSoon",m,"remind");c.unlock(b)},function(n){if(n.success==false&&n.msg=="Permission Denied."){rb.persistence.cookie.set("addreminder",f);rb.app.user.showLogin("ComingSoon",true,f);this.unlock(b)}})}else{rb.persistence.cookie.set("addreminder",f);rb.app.user.showLogin("ComingSoon",true,f)}}if(b.hasClass("rb-btn-reminded")){this.lock(b);rb.api.account.removeComingSoonNotify(f,function(){if($.inArray(f,c._reminders)>=0){c._reminders.splice($.inArray(f,c._reminders),1)}c._refreshButtons(".rb-btn-reminded")})}if(b.hasClass("rb-btn-cart")){this.lock(b);this.navigate(rb.app.cart.getUrl());return}var k=b.parents("[buttonset]:first");var d=k.attr("cartredir")==null||(k.attr("cartredir")!=null&&k.attr("cartredir")!="false");if(l&&b.hasClass("rb-btn-rent")){this.lock(b);var j=k.attr("origin");var m=k.attr("fromCart");this._recordClick(b,f,k.attr("buttonset"),j,m,"rent");var a=rb.api.product.getFormatName(l.fmt);if(rb.app.cart.isFull()){this._raiseDialog("MaxItemsDialog",function(){this.navigate(rb.app.cart.getUrl());c._closeDialog(true)},b);return}else{if(a=="bluray"){this._raiseDialog("BlurayDialog",function(){c._recordFindingMethod(b);rb.app.cart.addItem(l.ID,c._runView,d,h);c._closeDialog(true)},b);return}else{this._recordFindingMethod(b);rb.app.cart.addItem(l.ID,this._runView,d,h);return}}}if(l&&b.hasClass("rb-btn-find")){this.raiseStoreDialog(f,b)}}},_getContainerName:function(a){return $(a).closest("div").attr("container")},_onCartChange:function(a,b){this._cart=rb.app.cart.getItems();rb.app.store.getInventory(rb.createDelegate(this,this._onStoreChanged));if(this._currentCtx){this.unlock(this._currentCtx)}},_onStoreChange:function(a,b){this._cart=rb.app.cart.getItems();if(b.state=="completed"){rb.app.store.getInventory(rb.createDelegate(this,this._onStoreChanged))}},_onStoreChanged:function(a){this._inventory=a;this._refreshButtons()},_onRegistered:function(a){a.button().removeClass("rb-btn-unreg").addClass("rb-btn-reg").unbind("click").click(rb.createDelegate(this,this._onButtonClicked))},_raiseDialog:function(a,d,f,e){this._currentCtx=f;this._activeDialog=this.getControl(a).attr("type",a);var b=this._activeDialog.find(".rb-dialog-disabled").prop("checked",rb.persistence.cookie.get(a+"Disabled")!=true?false:true);var g=e||520;if(b.size()>0&&b.is(":checked")){d()}else{this._activeDialog.find(".rb-dialog-yes").unbind("click").click(rb.createDelegate(this,d));this._activeDialog.find(".rb-dialog-no").unbind("click").click(rb.createDelegate(this,this._closeDialog));var c=this;this._activeDialog.dialog({dialogClass:"rb-dialog-red rb-dialog",autoOpen:false,width:g,height:"auto",minHeight:120,modal:true,draggable:false,resizable:false,open:function(j,h){window.setTimeout(function(){jQuery(document).unbind("mousedown.dialog-overlay").unbind("mouseup.dialog-overlay")},100)},closeOnEscape:false});this._activeDialog.dialog("open");$(".ui-widget-overlay").click(function(){c._closeDialog()})}},_closeDialog:function(a){if(this._activeDialog){if(a!=true&&this._currentCtx){if(this._storeChanged&&this._activeDialog.selector.indexOf("BlurayDialog">-1)){rb.app.store.selectPreviousStore()}this.unlock(this._currentCtx)}this._activeDialog.dialog("close");var b=this._activeDialog.find(".rb-dialog-disabled");if(b.size()>0){rb.persistence.cookie.set(this._activeDialog.attr("type")+"Disabled",b.is(":checked"))}}this._storeChanged=false},_getProduct:function(a){var b=rb.api.product.getProducts([{name:"ID",val:a,matchType:"exact"}]);if(b&&b.data&&b.data[0]){return b.data[0]}else{return null}},_refreshButtons:function(a){for(var c in this._registeredSets){if(this._registeredSets[c].autoUpdate||a!=undefined){var d=this;var b;if(a===undefined){b=this._registeredSets[c].find("[buttonkey]")}else{b=this._registeredSets[c].find(a)}if(b.size()>0){if(this._registeredSets[c].auCallback){this._registeredSets[c].auCallback({state:"pending",buttons:null})}b.each(function(){d.updateButton($(this))});if(this._registeredSets[c].auCallback){this._registeredSets[c].auCallback({state:"completed",buttons:b})}}}}},_recordClick:function(c,d,h,f,g,a){var b=[];var e={products:";"+d};if(a=="rent"){if(typeof(c.attr("incartpromotion"))!="undefined"&&c.attr("incartpromotion")>0){return}if(f=="titleMarketing"){e.eVar3="cart recommendation - title marketing"}if(f=="default"&&g=="True"){e.eVar3="cart recommendation - double feature"}if(g=="True"){e.eVar31="cart"}b.push("scAdd");if(h&&h.indexOf("productlist")==0){b.push("prodView")}if(rb.app.cart.hasItems()==false){b.push("scOpen")}rb.rec.Omn.RecordAction("Add to Cart",e,b)}else{if(a=="remind"){if(f=="comingSoon"){e.eVar3="coming soon"}if(g=="True"){e.eVar31="cart"}b.push("event31");rb.rec.Omn.RecordAction("Coming Soon",e,b)}}},_recordFindingMethod:function(a){if(a){var b=this._getContainerName(a);if(b=="FT"){lockRecord=true;rb.rec.Omn.RecordAction("Featured Titles Add",{eVar3:"Featured Titles"});setTimeout("lockRecord = false;",1000)}}}});