var feedbackSurvey=null;var firstOpen=true;var submitStatus="No";$(document).ready(init);function init(){var className;var obj;var url;var surveyName="";var lang=$("html").first().attr("lang");var url="/feedback/survey/index";$("#feedback").click(function(event){if(firstOpen){firstOpen=false;className=$(this).children().first().attr("className");obj=this;if(className=="openSurvey"){if(feedbackSurvey==null||typeof(feedbackSurvey)==="undefined"){$.post(url,{lang:lang},function(data){feedbackSurvey=new Survey(obj,"survey",data);feedbackSurvey.showSurvey();surveyName="Survey"+$('#feedbackForm input:[name="surveyId"]').val();generic_vs_logger("LinkClicked",window.location.pathname,"LinkClicked","PublicSite"+surveyName);});}else{feedbackSurvey.showSurvey();feedbackSurvey.setRadioVals();}return false;}}});}function Survey(evt,survey,data){this.flashBugBrowser=false;this.listenersAdded=false;this.shadow=null;this.coords=null;this.radiosChecked=new Array();this.lang=$("html").first().attr("lang");this.shim=document.createElement("iframe");this.name=survey;this.tab=document.createElement("div");this.version="";var evt=evt||window.event;if(evt.target){this.trigger=evt.target;}else{if(evt.srcElement){this.trigger=evt.srcElement;}else{this.trigger=evt;}}this.container=document.createElement("div");this.ieversion=null;this.offsetX=0;this.offsetY=0;this.form=null;this.firstClick=true;this.textMax=4000;this.DSoffset=13;this.shadowSrc="";this.position="";if($("#printLink").length){this.position="middle";this.shadowSrc="/img/box_shadow_mid1.png";}else{this.position="right";this.shadowSrc="/img/box_shadow_right1.png";}if(/Firefox/.test(navigator.userAgent)){this.version="ff";this.offsetX=-2;this.DSoffset=15;var release=new Number(RegExp.$1);if(release<3.6){this.flashBugBrowser=true;}}if(/Safari/.test(navigator.userAgent)){this.flashBugBrowser=true;}if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){this.version="ie";this.ieversion=new Number(RegExp.$1);this.offsetY=2;}this.container.innerHTML=data;this.container.id="survey";this.box=this;this.offsetX-=20;}Survey.prototype.positionBox=function(){this.coords=Utility.findElementPosition(this.trigger);$("body").append(this.container);this.container.style.left=this.coords[0]+this.offsetX+"px";this.container.style.top=this.coords[1]+this.offsetY+"px";if(this.position==="right"){$(".surveyContent").addClass("right");}};Survey.prototype.attachShim=function(){this.shim.setAttribute("src","/img/s.gif");this.shim.frameBorder="0";this.shim.className="transparent";var surveyContentCoords=$(".surveyContent").offset();this.shim.style.left=(surveyContentCoords.left-3)+"px";this.shim.style.top=surveyContentCoords.top+"px";this.shim.style.height=$(".surveyContent").height()+22+"px";this.shim.style.width="280px";$("body").append(this.shim);};Survey.prototype.addShadow=function(){if(this.ieversion===null||this.ieversion>6){this.shadow=document.createElement("img");this.shadow.src=this.shadowSrc;this.shadow.className="surveyDropShadow";this.shadow.style.height=$("#survey").height()+10+"px";this.shadow.style.width=$(".surveyContent").width()+39+"px";$("body").append(this.shadow);if(this.version==="ff"&&this.position==="middle"){this.shadow.style.left=(this.coords[0]-80)+"px";}else{if(this.version!=="ff"&&this.position==="middle"){this.shadow.style.left=(this.coords[0]-78)+"px";}else{if(this.version==="ff"&&this.position==="right"){this.shadow.style.left=(this.coords[0]-192)+"px";}else{if(this.version!=="ff"&&this.position==="right"){this.shadow.style.left=(this.coords[0]-190)+"px";}}}}this.shadow.style.top=(this.coords[1]-15)+"px";}};Survey.prototype.reposition=function(){this.coords=Utility.findElementPosition(this.trigger);this.container.style.left=this.coords[0]+this.offsetX+"px";this.container.style.top=this.coords[1]+this.offsetY+"px";var surveyContentCoords=$(".surveyContent").offset();this.shim.style.left=(surveyContentCoords.left-3)+"px";this.shim.style.top=surveyContentCoords.top+"px";this.shim.style.height=$("#feedbackThankYou").height()+35+"px";this.shim.style.width="280px";if(this.ieversion===null||this.ieversion>6){this.shadow.style.height=$("#survey").height()+10+"px";this.shadow.style.width=$(".surveyContent").width()+39+"px";if(this.version==="ff"&&this.position==="middle"){this.shadow.style.left=(this.coords[0]-80)+"px";}else{if(this.version!=="ff"&&this.position==="middle"){this.shadow.style.left=(this.coords[0]-78)+"px";}else{if(this.version==="ff"&&this.position==="right"){this.shadow.style.left=(this.coords[0]-192)+"px";}else{if(this.version!=="ff"&&this.position==="right"){this.shadow.style.left=(this.coords[0]-190)+"px";}}}}this.shadow.style.top=(this.coords[1]-15)+"px";}};Survey.prototype.setFocus=function(){this.container.getElementsByTagName("*")[0].tabIndex=0;this.container.getElementsByTagName("*")[0].focus();this.container.getElementsByTagName("*")[0].style.outline="none";};Survey.prototype.checkForm=function(event){var lang=this.lang;var textAreaEmpty=true;var minComplete=false;$("#feedbackForm input").each(function(){if($(this).attr("checked")===true){minComplete=true;}});$("#feedbackForm select").each(function(){if($(this).val()!=0){minComplete=true;}});$("#feedbackForm textarea").each(function(){if(event.data.box.firstClick===false){if($(this).val()!==""){textAreaEmpty=false;}}});if($(this).attr("name")==="submitSurvey"){if(minComplete==true||textAreaEmpty==false){event.data.box.sendForm(event.data.box);}else{$("#surveyForm .warning").show();}}else{if(minComplete===true||$(this).attr("id")==="feedbackComments"){$("#surveyForm .warning").hide();$("#feedbackForm .primary").removeClass("disabled");$("#feedbackForm .primary").attr("disabled",false);}}};Survey.prototype.showThankyou=function(){var thisBox=this;$("#surveyForm").hide();$("#feedbackThankYou").show();if(this.position==="middle"){this.shadowSrc="/img/box_shadow_mid2.png";}else{this.shadowSrc="/img/box_shadow_right2.png";}if(this.ieversion===null||this.ieversion>6){$("body").remove(this.shadow);this.shadow.src=this.shadowSrc;$("body").append(this.shadow);}this.reposition();$("input#closeThankYou").bind("click",{box:thisBox},thisBox.removeSurvey);};Survey.prototype.testData=function(data){alert("PurposeOfVisit: "+data.purposeOfVisit);};Survey.prototype.errorHandler=function(){};Survey.prototype.sendForm=function(box){var str="";var defaultComments="";var inputs=$("#feedbackForm input");var surveyAction;$(inputs).each(function(){if($(this).attr("type")==="radio"){if($(this).attr("checked")===true){str+="&"+$(this).attr("name")+"="+$(this).val();}}else{if($(this).attr("type")==="hidden"&&$(this).attr("name")==="surveyaction"){surveyAction=$(this).val();}else{if($(this).attr("type")==="hidden"&&$(this).attr("name")==="defaultComments"){defaultComments=$(this).val();}else{str+="&"+$(this).attr("name")+"="+$(this).val();}}}});var selects=$("#feedbackForm select");$(selects).each(function(){str+="&"+$(this).attr("name")+"="+$(this).val();});var textarea=$("#feedbackForm textarea");$(textarea).each(function(){if($(this).val()===defaultComments){}else{str+="&"+$(this).attr("name")+"="+encodeURIComponent($(this).val());}});str=str.slice(1,str.length);if(submitStatus=="Yes"){box.showThankyou(box);}else{sendInfo();}function sendInfo(){$.ajax({url:"/feedback/survey/index?action="+surveyAction,global:false,type:"POST",data:str,dataType:"json",async:false,timeout:5000,error:function(data){box.showThankyou(box);},success:function(data){box.showThankyou(box);}});}submitStatus="Yes";generic_vs_logger("LinkClicked",window.location.pathname,"PageDisplayed","PublicSiteFeedbackThankYou");};Survey.prototype.addListeners=function(){var thisBox=this.box;var textMax=this.textMax;$("#feedbackForm input").bind("click",{box:thisBox},thisBox.checkForm,thisBox);$("#feedbackForm select").bind("change",{box:thisBox},thisBox.checkForm,thisBox);$("#feedbackForm textarea").bind("click",{box:thisBox},thisBox.checkForm,thisBox);$("#feedbackForm textarea").bind("blur",{box:thisBox},thisBox.checkForm,thisBox);
$("#feedbackForm div.buttonBarPage input#submitSurvey").bind("click",{box:thisBox},thisBox.checkForm,thisBox);$("input#closeThankYou").bind("click",{box:thisBox},thisBox.removeSurvey);$("#feedbackForm div.buttonBarPage .cancelSurvey").bind("click",{box:thisBox},thisBox.removeSurvey);$(".helpWindow").click(function(event){newWindow(popup($(this).attr("href"),3));event.preventDefault();});thisBox.container.getElementsByTagName("textarea")[0].onkeypress=function(e){var e=e||window.event;var keyCode=e.keyCode||e.charCode;if((thisBox.container.getElementsByTagName("textarea")[0].value.length+1)>textMax){if(keyCode!=8){return false;}}else{if(keyCode===8){if((thisBox.container.getElementsByTagName("textarea")[0].value.length)<1){return false;}}}};thisBox.container.getElementsByTagName("textarea")[0].onfocus=function(){if(thisBox.firstClick===true){thisBox.container.getElementsByTagName("textarea")[0].value="";thisBox.firstClick=false;}};thisBox.listenersAdded=true;};Survey.prototype.flashRewrite=function(movie,el,wmode){var s="";if(el.children("style").length>0){s+='<style type="text/css">'+el.children("style").attr("innerHTML")+"</style>";}s+='<embed src="'+movie.src+'" scale="noscale" id="'+movie.id+'" quality="high" bgcolor="#ffffff" name="'+movie.name+'" flashvars="'+movie.flashvars+'" play="true" loop="false" allowscriptaccess="sameDomain" pluginspage="https://www.adobe.com/go/getflashplayer" wmode="'+wmode+'" type="application/x-shockwave-flash" align="'+movie.align+'" width="'+movie.width+'"  height="'+movie.height+'"><noscript><a href="/exitpage?exitPageId=2"><img src="/img/wfonline/tour/img_msr_bob_flash_tour.gif" alt="Adobe Flash Player 10 or above is required. Download the latest free flash player by clicking on the link below or typing it into a browser." /></a></noscript>';return s;};Survey.prototype.showSurvey=function(){var thisBox=this.box;if(document.getElementsByTagName("embed").length>0&&thisBox.flashBugBrowser===true){$(".c59media, #L6Tool").each(function(){var embedObj=$(this).children("embed");if(embedObj.length>0){var movie=document.embeds[embedObj.attr("name")];if(movie.type==="application/x-shockwave-flash"){var str=thisBox.flashRewrite(movie,$(this),"opaque");$(this).attr("innerHTML",str);}}});}this.positionBox();$("#feedbackForm .primary").removeClass("disabled");$("#feedbackForm .primary").attr("disabled",false);$(this.container).fadeIn("fast",function(){$("#printLink").addClass("faded");thisBox.attachShim();thisBox.addShadow();$("#feedback .openSurvey").remove();var closeSurvey=document.createElement("div");var feedbackLink=document.createElement("a");feedbackLink.href="javascript:void(0);";if(thisBox.lang==="es"){feedbackLink.innerHTML="Comentarios";}else{feedbackLink.innerHTML="Feedback";}$(closeSurvey).append(feedbackLink);$(closeSurvey).addClass("closeSurvey");$("#feedback").append(closeSurvey);$(closeSurvey).bind("click",{box:thisBox},thisBox.removeSurvey);if(thisBox.listenersAdded===false){thisBox.addListeners();}$(window).resize(function(){thisBox.reposition();});});};Survey.prototype.getRadioVals=function(){var thisBox=this.box;var radios=$("#feedbackForm input:radio");radios.each(function(index){if($(this).attr("checked")===true){thisBox.radiosChecked.push(index);}});};Survey.prototype.setRadioVals=function(){var radios=$("#feedbackForm input:radio");if(this.radiosChecked!=null){$(this.radiosChecked).each(function(index,data){$(radios[data]).attr("checked",true);});}};Survey.prototype.removeSurvey=function(event){var thisBox=event.data.box;if(document.getElementsByTagName("embed").length>0&&thisBox.flashBugBrowser===true){$(".c59media, #L6Tool").each(function(){var embedObj=$(this).children("embed");if(embedObj.length>0){var movie=document.embeds[embedObj.attr("name")];if(movie.type==="application/x-shockwave-flash"){var str=thisBox.flashRewrite(movie,$(this),"window");$(this).attr("innerHTML",str);}}});}var evt=event||window.event;if(evt.target){var trigger=evt.target;}else{if(evt.srcElement){var trigger=evt.srcElement;}}var whichScreen="";if(thisBox.shadowSrc==="/img/box_shadow_mid2.png"||thisBox.shadowSrc==="/img/box_shadow_right2.png"){whichScreen="screen2";}else{whichScreen="screen1";}if($(thisBox.shadow)!=null){$(thisBox.shadow).remove();}if($(thisBox.shim)!=null){$(thisBox.shim).remove();}thisBox.radiosChecked.length=0;$(thisBox.container).fadeOut("fast",function(){$("#feedback .closeSurvey").remove();if($("#feedback").children(".openSurvey").length<1){var openSurvey=document.createElement("div");$(openSurvey).attr("className","openSurvey");var feedbackLink=document.createElement("a");$(openSurvey).append(feedbackLink);feedbackLink.href="javascript:void(0)";if(thisBox.lang==="es"){feedbackLink.innerHTML="Comentarios";}else{feedbackLink.innerHTML="Feedback";}$("#printLink").removeClass("faded");$("#feedback").append(openSurvey);}if(trigger.name==="cancelSurvey"||whichScreen==="screen2"){$(thisBox.container).remove();feedbackSurvey=null;}else{thisBox.getRadioVals();}firstOpen=true;});};