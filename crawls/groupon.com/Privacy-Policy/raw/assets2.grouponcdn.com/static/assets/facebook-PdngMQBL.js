(function(){var Facebook,fadeOutFadeIn,postActionDeal;Facebook={init:function(){return FB.init({appId:Groupon.Facebook.config.app_id,status:false,cookie:true,xfbml:true,channelUrl:""+window.location.protocol+"//"+window.location.host+"/facebook/xd_receiver.html"});},login:function(permissions,callback){if(typeof permissions!=='string'){callback=permissions;permissions=Groupon.Facebook.config.perms;}
return FB.login(callback,{scope:permissions});},userId:function(){try{return FB.getAuthResponse().userID;}catch(err){return null;}},getMyPages:function(callback){return FB.api('/me/accounts',callback);},onReady:function(cb,timeout){var done;if(timeout==null){timeout='8000';}
if(typeof FB!=="undefined"&&FB!==null){return cb();}
done=false;Groupon.onFacebookReady(function(){if(!done&&(typeof FB!=="undefined"&&FB!==null)){done=true;return cb();}});return setTimeout(function(){if(!done){done=true;return cb('timeout');}},timeout);}};postActionDeal=function(action,deal,cb){var req;req=$.post('/open_graph',{verb:action,deal:deal},function(res){Facebook.OpenGraph.responses.push(res);if(res.result==='ok'){return cb(null,res);}
return cb((res.error!=null?res.error:'error'),res);});return req.error(function(err){Facebook.OpenGraph.errors.push(err);return cb(err);});};fadeOutFadeIn=function($el1,$el2){return $el1.fadeOut((function(){return $el2.fadeIn();}));};Facebook.OpenGraph={responses:[],errors:[],buyDeal:function(permalink,cb){return postActionDeal('buy',permalink,function(err,res){var payload,success_or_error;if(cb){cb(err,res);}
success_or_error=err||(res!=null?res.result:void 0)==='error'?'error':'success';payload={action:'buy',deal:permalink,user:Groupon.currentUser.trackingCode,response:res};return Groupon.Analytics.trackEvent('fb_open_graph',success_or_error,payload);});},"delete":function(id,cb){return $.ajax({type:'DELETE',url:'/open_graph',data:{id:id},success:function(data,text_status,jqXHR){Facebook.OpenGraph.responses.push(data);if(data.result==='ok'){return cb(null,data);}
return cb('error',data);},error:function(err){Facebook.OpenGraph.errors.push(err);return cb(err);},dataType:'json'});},postPurchaseShare:function(deal,cb){var $connect,$el,$loading,$posted,$posting;$el=$('#publish_to_open_graph');$posting=$el.find('.posting');$connect=$el.find('.connect');$posted=$el.find('.posted');$loading=$el.find('.loading');$el.find('> div').hide();$posting.show();return Groupon.Facebook.OpenGraph.buyDeal(deal,function(err,res){if(err){fadeOutFadeIn($posting,$connect);if(cb){return cb(err);}}else{fadeOutFadeIn($posting,$posted);if(cb){return cb();}}});}};window.Groupon||(window.Groupon={});window.Groupon.Facebook=Facebook;}).call(this);Groupon.FacebookConnect=(function(){var _request_url=null;var userAttrs=['email','first_name','last_name','current_location','hometown_location','about_me','email_hashes','timezone','proxied_email','birthday_date','sex'];var accessToken=null;function getSessionCreationUrl(){var protocol;if(Groupon.sslEnabled){protocol="https://";}else{protocol="http://";}
return protocol+Groupon.Application.windowHost()+"/session";}
var sessionCreationUrl=getSessionCreationUrl();function init(){FB.Event.subscribe('edge.create',function(href,widget){var grp_att=undefined;if(widget.dom.attributes["grp"]){grp_att=widget.dom.attributes["grp"].value;}
Groupon.Analytics.trackClick('Share',widget.dom.nodeName,grp_att);});}
function whenConnected(callback){FB.getLoginStatus(function(response){var authResponse=response.authResponse;if(authResponse){callback(authResponse);}});}
function convertResultsToParams(results,additionalParameters){var user=results.user;var friendCount=results.friends;var appFriendCount=results.appFriends;var params={'fb[access_token]':accessToken,'fb[uid]':Groupon.Facebook.userId(),'fb[email]':user.email,'fb[first_name]':user.first_name,'fb[last_name]':user.last_name,'fb[about_me]':user.about_me,'fb[timezone]':user.timezone,'fb[gender]':user.sex,'fb[birth_date]':user.birthday_date,'fb[email_hashes]':user.email_hashes.join(','),'fb[friend_count]':friendCount,'fb[app_friend_count]':appFriendCount};var location=(user.current_location&&user.current_location.city)?user.current_location:user.hometown_location;if(location){params['fb[city]']=location.city;params['fb[state]']=location.state;params['fb[country]']=location.country;}
if(additionalParameters){$.each(additionalParameters,function(key,value){if(value){params[key]=value;}});}
params.request_url=_request_url||Groupon.Application.windowLocation();return params;}
function submitSessionCreationRequestViaHttpPost(params){Groupon.Application.submitFormData(sessionCreationUrl,params);}
function submitSessionCreationRequestViaAjax(results,additionalParameters){$.ajax({url:sessionCreationUrl,type:'POST',data:Groupon.FacebookConnect.convertResultsToParams(results,additionalParameters),dataType:'json',success:function(response){Groupon.FacebookConnect.onFacebookSessionCreateSuccess(results,response);},error:function(response){Groupon.FacebookConnect.onFacebookSessionCreateFailure();}});}
function postToFacebookConnect(results){if(Groupon.Application.isSSL()){submitSessionCreationRequestViaAjax(results);}else{submitSessionCreationRequestViaHttpPost(Groupon.FacebookConnect.convertResultsToParams(results));}}
function onFacebookSessionCreateSuccess(results,sessionCreationResponse){if(sessionCreationResponse.confirmEmail){this.Modals.Ajax.confirmEmailAddress(sessionCreationResponse.confirmEmail,results);}else if(sessionCreationResponse.specifyAccount){this.Modals.Ajax.linkToExistingAccount(results);}
else if(sessionCreationResponse.passwordFailure){addAlert('error','Incorrect email/password combination.');}
else if(sessionCreationResponse.facebookUserIsDeleted){addAlert("error",sessionCreationResponse.errorMessage);}
else if(sessionCreationResponse.location){Groupon.Application.redirectTo(sessionCreationResponse.location);}else{Groupon.Application.reloadPage();}}
function onFacebookSessionCreateFailure(){addAlert('error','There was a problem with Facebook login. Please try again later.');for(var i=0;i<_onFacebookSessionCreateFailure.length;++i){_onFacebookSessionCreateFailure[i]();}}
var _onFacebookSessionCreateFailure=[];function bindOnFacebookSessionCreateFailure(func){_onFacebookSessionCreateFailure.push(func);}
function onConnect(request_url){_request_url=request_url;var uid=Groupon.Facebook.userId();if(Groupon.Application.isConnectedWithFacebook())return;FB.getLoginStatus(function(response){var authResponse=response.authResponse;if(!authResponse)return;accessToken=authResponse.accessToken;FB.api({method:"fql.multiquery",queries:{"user_query":"SELECT "+userAttrs.join(",")+" FROM user WHERE uid='"+uid+"'","friend_query":"SELECT is_app_user FROM user where uid IN (SELECT uid2 FROM friend where uid1="+uid+")"}},function(response){if(!response||response.error_code){return;}
results={};var appFriends=0;for(var i=0;i<response.length;i++){if(!response[i].fql_result_set)continue;if(response[i].name=="user_query"&&response[i].fql_result_set[0]){results.user=response[i].fql_result_set[0];}
else if(response[i].name=="friend_query"){results.friends=response[i].fql_result_set.length;$.map(response[i].fql_result_set,function(val,i){if(val.is_app_user)appFriends++;});}}
results.appFriends=appFriends;postToFacebookConnect(results);});});}
function getGrouponFriendCount(callback){FB.getLoginStatus(function(response){if(response.authResponse){FB.Data.query("SELECT '' FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1={0}) AND is_app_user",Groupon.Facebook.userId()).wait(function(results){callback(results.length);});}});}
function getGrouponFriendUid(callback){FB.getLoginStatus(function(response){if(response.authResponse){FB.Data.query("SELECT uid FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1={0}) AND is_app_user order by rand() limit 10",Groupon.Facebook.userId()).wait(function(results){var facebook_friends=[];results.each(function(friend){facebook_friends.push(friend.uid);});callback(facebook_friends);});}});}
function disconnect(){var uid=Groupon.Facebook.userId();if(uid){FB.api({method:'auth.revokeAuthorization',uid:uid},function(response){window.location.href=window.location.href;});}}
function publishCampaignPurchase(campaign){FB.api({method:'stream.publish',message:'',attachment:{name:'Groupon '+campaign.division.name,description:campaign.title,href:campaign.url,media:[{type:'image',src:campaign.image,href:campaign.url}]},action_links:[{text:'Get the Deal',href:campaign.url}]});}
function shareURL(url){FB.ui({method:'stream.share',u:url});}
function shareBitlyCBURL(data){var shortUrlObj;for(var longUrl in data.results){shortUrlObj=data.results[longUrl];break;}
shareURL(shortUrlObj["shortUrl"]);}
function loginWithOnlyFacebookCredentialsViaAjax(facebookQueryResults){this.submitSessionCreationRequestViaAjax(facebookQueryResults,{no_groupon_credentials:true});}
function loginWithOnlyFacebookCredentialsViaHttpPost(facebookParams){facebookParams.no_groupon_credentials=true;this.submitSessionCreationRequestViaHttpPost(facebookParams);}
return{getSessionCreationUrl:getSessionCreationUrl,init:init,onConnect:onConnect,getGrouponFriendCount:getGrouponFriendCount,getGrouponFriendUid:getGrouponFriendUid,publishCampaignPurchase:publishCampaignPurchase,convertResultsToParams:convertResultsToParams,disconnect:disconnect,shareURL:shareURL,shareBitlyCBURL:shareBitlyCBURL,whenConnected:whenConnected,postToFacebookConnect:postToFacebookConnect,loginWithOnlyFacebookCredentialsViaAjax:loginWithOnlyFacebookCredentialsViaAjax,loginWithOnlyFacebookCredentialsViaHttpPost:loginWithOnlyFacebookCredentialsViaHttpPost,submitSessionCreationRequestViaAjax:submitSessionCreationRequestViaAjax,submitSessionCreationRequestViaHttpPost:submitSessionCreationRequestViaHttpPost,onFacebookSessionCreateSuccess:onFacebookSessionCreateSuccess,onFacebookSessionCreateFailure:onFacebookSessionCreateFailure,bindOnFacebookSessionCreateFailure:bindOnFacebookSessionCreateFailure};})();Groupon.FacebookConnect.LinkToGrouponAccount=(function(modal){function bindSubmitButton(onSuccess){$("#modal_window_confirm input[type='submit']").click(function(e){e.preventDefault();if(typeof(onSuccess)!=="undefined"){onSuccess({email:$("#modal_window_confirm input[name='email']").val(),password:$("#modal_window_confirm input[name='password']").val()});}
Control.Modal.close();});}
function bindCancelButton(onCancel){$('#cancel').click(function(){if(typeof(onCancel)!=='undefined'){onCancel();}
Control.Modal.close();});}
function showDialog(){Control.Modal.open('#modal_window_confirm',{fade:true,afterClose:function(){this.destroy();}});}
function retrieveDialog(responseText,settings){$(document.body).insert(responseText);bindSubmitButton(settings['success']);bindCancelButton(settings['cancel']);showDialog();}
function displayModal(url,settings){if(typeof(settings)==='undefined'){settings={};}
Control.Modal.close();if($('#modal_window_confirm').length===0){$.ajax({url:url,data:settings['data']||{},dataType:'html',success:function(responseText){retrieveDialog(responseText,settings);}});}else{showDialog();}}
return{display:displayModal};})();Groupon.FacebookConnect.Modals=(function(){function retrySubmissionHttpPost(facebookRailsParams,formFields){var params=$.extend(JSON.parse(facebookRailsParams),formFields);Groupon.FacebookConnect.submitSessionCreationRequestViaHttpPost(params);}
function linkToExistingAccount(settings){Groupon.FacebookConnect.LinkToGrouponAccount.display('/users/link_to_groupon_account_modal',settings);}
function confirmEmailAddress(email,settings){var fullSettings=$.extend(settings,{data:{email_address:email}});Groupon.FacebookConnect.LinkToGrouponAccount.display('/users/confirm_password_modal',fullSettings);}
function linkToExistingAccountHttpPost(facebookRailsParams){linkToExistingAccount({success:_.bind(retrySubmissionHttpPost,this,facebookRailsParams),cancel:_.bind(Groupon.FacebookConnect.loginWithOnlyFacebookCredentialsViaHttpPost,Groupon.FacebookConnect,JSON.parse(facebookRailsParams))});}
function confirmEmailAddressHttpPost(email,facebookRailsParams){confirmEmailAddress(email,{success:_.bind(retrySubmissionHttpPost,this,facebookRailsParams)});}
function linkToExistingAccountAjax(facebookQueryResults){linkToExistingAccount({success:_.bind(Groupon.FacebookConnect.submitSessionCreationRequestViaAjax,Groupon.FacebookConnect,facebookQueryResults),cancel:_.bind(Groupon.FacebookConnect.loginWithOnlyFacebookCredentialsViaAjax,Groupon.FacebookConnect,facebookQueryResults)});}
function confirmEmailAddressAjax(email,facebookQueryResults){confirmEmailAddress(email,{success:function(form_fields){Groupon.FacebookConnect.submitSessionCreationRequestViaAjax(facebookQueryResults,form_fields);}});}
return{HttpPost:{linkToExistingAccount:linkToExistingAccountHttpPost,confirmEmailAddress:confirmEmailAddressHttpPost},Ajax:{linkToExistingAccount:linkToExistingAccountAjax,confirmEmailAddress:confirmEmailAddressAjax}};})();$(document).observe("facebook:loaded",function(){Groupon.FacebookConnect.init();});