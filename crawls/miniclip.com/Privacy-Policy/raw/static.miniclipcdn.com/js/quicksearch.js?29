var Sitesearch=function(a,b){this.results=[];this.input=null;this.hook=null;this.overlay=null;this.timeout=null;this.prev_q="";this.search_timeout=100;this.min_chars=2;this.cache={};this.props={classes:{overlay:"sr-overlay",row:"game-icon",info_wrapper:"sr-info-wrapper",title:"sr-title",descr:"sr-desc",more_button:"sr-more-button"},ids:{row_prefix:"sr-row-"}};this.input=$(a);if(this.input.length===0){throw ('Input "'+a+'" not found!')}this.hook=$(b);if(this.hook.length===0){throw ('Input "'+b+'" not found!')}this.input.focus($.proxy(function(d){if(this.input.val()&&!this.overlayExists()){this.search()}},this));var c=this;this.input.blur($.proxy(function(){setTimeout(function(){c.destroyOverlay()},500)},this));this.input.keydown($.proxy(function(d){this.handleOnKeyDown(d)},this));this.input.keyup($.proxy(function(d){this.handleOnKeyUp(d)},this));this.overlayExists=function(){return(this.overlay!==null)};this.showOverlay=function(){if(this.overlayExists()){this.clearOverlay()}else{this.overlay=$("<div></div>").addClass(this.props.classes.overlay);$("body").append(this.overlay);this.overlay.css("display","block");this.overlay.css("position","absolute");this.overlay.attr("id","search-suggestions");var d=this.hook.offset();this.overlay.css("top",d.top+this.hook.outerHeight());this.overlay.css("left",d.left)}};this.destroyOverlay=function(){if(this.overlayExists()){this.input.removeClass("search-active");this.overlay.remove();this.overlay=null;$("#game-container").stop().animate({"margin-top":0},250)}};this.clearOverlay=function(){if(this.overlayExists()){this.overlay.html("")}};this.populateOverlay=function(){this.showOverlay();this.clearOverlay();$("#game-container").stop().animate({"margin-top":340},250);this.input.addClass("search-active");var d=$("<ul></ul>");$(this.results).each($.proxy(function(h,m){if(m.is_more_button!==true){var p=$("<li></li>");var o=$("<a></a>");if(m.entry_type=="hub"){o.attr("href","/hub/"+m.hub_url).addClass(this.props.classes.row).attr("id",this.props.ids.row_prefix+m._id)}else{if(m.entry_type=="category"){var l=m.filename;l=l.toLowerCase();l=l.replace(/&amp;/g,"and");l=l.replace(/ - /g,"-");l=l.replace(/ /g,"-");l=l.replace(/&/g,"and");l=l.replace(/([^0-9|a-z|_|-])/g,"");var e="http://"+document.domain+"/games/en/"+l+".php";o.attr("href",e).addClass(this.props.classes.row).attr("id",this.props.ids.row_prefix+m._id)}else{o.attr("href","/games/"+m.game_url_key+"/").addClass(this.props.classes.row).attr("id",this.props.ids.row_prefix+m._id)}}if(m.highlighted===true){o.addClass("highlighted")}o.attr("qs_phrase",this.input.val());o.attr("qs_key",m.game_url_key);o.click(function(){statTracker("/elastic-search/search/"+$(this).attr("qs_phrase"));statTracker("/elastic-search/play/"+$(this).attr("qs_key"))});var g=new Image();if(m.icon_filename!=""&&m.icon_filename!=null){g.src="/content/game-icons/small/"+m.icon_filename+".jpg"}else{g.src="/i/creatives/icons/defaultsmallicon.jpg"}var f=$("<span></span>").append(g).addClass("icon-wrap");f.css("width","auto");f.css("height","auto");o.append(f);if(m.entry_type!="game"){var n=$("<span></span>").addClass("game-name").html(m.name)}else{var n=$("<span></span>").addClass("game-name").html(m.short_name)}o.append(n);var k=m.short_description?m.short_description:m.description;var j=$("<span></span>").addClass("game-description").html(k);o.append(j);o.bind("mouseover",$.proxy(function(i){this.removeAllHighlights();this.results[h].highlighted=true;this.updateHighlights(m)},this));o.bind("mousedown",$.proxy(function(i){if(m.is_more_button){this.input.closest("form").submit();return false}},this));p.append(o);d.append(p)}},this));this.overlay.append(d);if(this.input.val().length>0){this.overlay.append('<div class="action-button orange"><a href="/games/search/en/'+this.input.val()+'/">'+translate.show_more_results+"</a></div>")}else{this.overlay.append('<div class="action-button orange"><a href="/games/search/en/">'+translate.show_more_results+"</a></div>")}};this.showNoResultsOverlay=function(){};this.updateHighlights=function(d){if(!this.overlayExists()){return}if(!d){this.removeAllHighlights();return}var e=this.props.ids.row_prefix+d._id;this.overlay.find("a").each(function(g,f){f=$(f);if(f.attr("id")==e){f.addClass("highlighted")}else{f.removeClass("highlighted")}})};this.getHighlightedItem=function(){for(var d=0;d<this.results.length;d++){if(this.results[d].highlighted===true){return this.results[d]}}return null};this.removeAllHighlights=function(){for(var d=0;d<this.results.length;d++){this.results[d].highlighted=false}this.overlay.find("a").each(function(f,e){$(e).removeClass("highlighted")})};this.handleOnKeyDown=function(d){if(d.keyCode==13){return this.handleReturn(d)}};this.handleOnKeyUp=function(d){if(this.input.val()!==this.prev_q){this.prev_q=this.input.val();clearTimeout(this.timeout);var e=this;this.timeout=setTimeout(function(){e.search()},this.search_timeout);return}if(d.keyCode==38){return this.handleArrowUp(d)}else{if(d.keyCode==27){return this.destroyOverlay()}else{if(d.keyCode==40){return this.handleArrowDown(d)}else{if(d.keyCode==13){return this.handleReturn(d)}}}}};this.handleArrowDown=function(g){if(this.results.length>0){var d=null;if(this.results.length>1){var f=this.results.length-1;for(var e=0;e<this.results.length;e++){if(this.results[e].highlighted===true){if(e<f){this.results[e].highlighted=false;this.results[e+1].highlighted=true;d=this.results[e+1];break}else{return}}}}if(d===null){this.results[0].highlighted=true;d=this.results[0]}this.updateHighlights(d)}return false};this.handleArrowUp=function(f){if(this.results.length>0){var d=null;if(this.results.length>1){for(var e=0;e<this.results.length;e++){if(this.results[e].highlighted===true){this.results[e].highlighted=false;if(e>0){this.results[e-1].highlighted=true;d=this.results[e-1]}break}}}this.updateHighlights(d)}return false};this.handleReturn=function(g){var e=this.getHighlightedItem();$(g.target.form).submit(function(h){return true});if(e){if(e.is_more_button!==true){$(g.target.form).submit(function(h){return false});statTracker("/elastic-search/search/"+this.input.val());statTracker("/elastic-search/play/"+e.game_url_key+"/");if(e.entry_type=="hub"){window.location.href="/hub/"+e.hub_url}else{if(e.entry_type=="category"){var f=e.filename;f=f.toLowerCase();f=f.replace(/&amp;/g,"and");f=f.replace(/ - /g,"-");f=f.replace(/ /g,"-");f=f.replace(/&/g,"and");f=f.replace(/([^0-9|a-z|_|-])/g,"");var d="http://"+document.domain+"/games/en/"+f+".php";window.location.href=d}else{window.location.href="/games/"+e.game_url_key+"/"}}return false}}g.target.form.submit();return false};this.search=function(){var f=this.input.val();if(f.length<this.min_chars){this.destroyOverlay();return}if(this.cache[f]!==undefined){if(this.cache[f]!==false){this.results=this.cache[f];this.populateOverlay()}else{this.showNoResultsOverlay()}return}var d="/games/ajax/gamesearch/";var e={query:f};$.ajax({url:d,data:e,dataType:"json",type:"POST",success:$.proxy(function(g){if(g.success&&g.result.length){this.results=[];$(g.result).each($.proxy(function(h,i){i.highlighted=(h===0);this.results.push(i)},this));this.results.push({_id:"more",is_more_button:true,highlighted:false});this.cache[f]=this.results;this.populateOverlay()}else{this.cache[f]=false;this.showNoResultsOverlay()}},this)})}};$(function(){if($("#search-text").length>=1){new Sitesearch("#search-text","#search-form")}});