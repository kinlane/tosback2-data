(function(a,B,G){var j=MySpace.Cookies.PLAYERSTATE||new MySpace.Cookie("PLAYERSTATE",""),z="",D=0,I=(j._values.Volume||50)/100,u={},y=0,t,q="relay",n,f,F={},p=window.console?function(){console.log.apply(console,arguments)}:a.noop,c=a("#musicPlayer"),b=c.find(".cover"),E=0,l={externalint:"MySpace.PersistentPlayer",xumopath:"http://cache.vindicosuite.com/xumo/swf/prod/Xumo.swf"},v=(function(){var M=[],O=M,K=-1;M.add=function(R,P){var Q=this.find(R.songId);if(Q!=-1){this.splice(Q,1);if(Q<P){P--}}this.splice(P,0,R);return Q};M.find=function(Q){for(var P=this.length;P--&&this[P].songId!=Q;){}return P};function J(S,Q,R){if(S.type=="songs"){S.ids=S.id;delete S.id}function P(W){var T=S.at,aa=O!=M;if(S.replace){v.load(W);v.shuffle(!aa)}else{for(var U=0,X=W.length;U<X;U++){var V=W[U],Y=T+U,Z=M.add(V,Y);V.justAdded=true;if(Z>-1&&Z<Y){T--}if(aa){Z=O.add(V,K+U+1)}if(Z>-1&&Z<K){K--}}v.shuffle(!aa);h("queueChanged",M.slice())}if(Q){Q(W)}}jQuery.ashx("queue.ashx",S,{area:"music",success:function(T){if(!R){P(a.makeArray(JSON.parse(T)))}},error:function(){h("error",{type:"queue failure",cmd:"add",params:S})}});if(R){P(a.makeArray(R))}}function L(P){u=O[K];if(typeof(u.streamURL)!="undefined"&&!u.streamURL){h("error",{type:"permissions",code:3,msg:"Song unplayable in the current region.",song:u});if(v.next()){L(0)}else{v.pause()}return}F.load=+new Date;B.loadSong(u.songId,u.artistId,u.isFullLength,u.isExplicit,u.isPremium,u.songTitle,u.duration,u.streamURL,P||0,!!t,u.releaseId);H({SongId:u.songId,IsPlaying:!t,CurrentTime:P||0});D=P||0;z="buffering";h("buffering",a.extend({time:P||0,isPlaying:!t},u))}function N(Q,P){return Math.floor(Math.random()*(P-Q+1))+Q}return{find:function(P){return M[M.find(P)]},pause:function(){t=true;B.pauseCurrentTrack()},now:function(Q){if(z){t=0}if(Q){var U=Q.time,V=o(Q),W=Q[V],R=typeof W=="object"?W[V+"Id"]:W;if(V=="song"){var T=O.find(R);if(T>-1){K=T;L(U);return}}var S=M.find(u.songId)+1;function P(X){var Y=X[0];if(!Y){return}K=O.find(Y.songId);L(U)}J({type:V,id:R,at:S,replace:Q.replace,owner:Q.owner},P,R==W?null:W)}else{if(K==-1){v.next()}else{L()}}},shuffle:function(U){var S=M!=O;if(!arguments.length){return S}if(U){O=M;if(S){h("shuffle",false)}return}else{if(!S){O=M.slice();O.add=M.add;O.find=M.find;h("shuffle",true)}}if(M.length<2){return}for(var P=K,R=O.length-1,Q,T;P<O.length;P++){Q=N(P,R);T=O[P];O[P]=O[Q];O[Q]=T}},next:function(P){if(P&&P.source!="controls"){var T=o(P),U=P[T],Q=typeof U=="object"?U.id:U,S=M.find(u.songId)+1;if(T=="song"){var R=M[S];if(R&&R.songId==Q){if(M!=O){O.add(R,K+1)}return}}J({type:T,id:Q,at:S,replace:P.replace,owner:P.owner},null,Q==U?null:U);return}else{if(P&&P.source=="controls"&&q=="radio"){jQuery.ashx("SkipSong.ashx",{songId:O[K].songId,duration:D},{area:"music"})}}if(M.length==0){return null}if(K==M.length-1){v.shuffle(O==M);if(y){K=0}else{return false}}else{K++}L();return true},previous:function(){if(M.length==0){return null}if(K==0){if(y){K=M.length-1}else{return false}}else{K--}L();return true},last:function(P){var S=o(P),T=P[S],Q=typeof T=="object"?T.id:T;if(S=="song"&&M.length){var R=M[M.length-1];if(R&&R.songId==Q){if(M!=O){O.add(R,M.length)}return}}J({type:S,id:Q,at:M.length,replace:P.replace,owner:P.owner},null,Q==T?null:T)},remove:function(Q){if(u.songId==Q&&!v.next()&&!v.previous()){v.pause()}jQuery.ashx("removesongfromqueue.ashx?songid="+Q,null,{area:"music",error:function(){h("error",{type:"queue failure",cmd:"remove",songId:Q})}});var P=M.find(Q);if(P==-1){return}M.splice(P,1);if(M!=O){O.splice(O.find(Q),1)}if(M.length==0){K=-1;H({SongId:-1,IsPlaying:false,CurrentTime:0})}else{K=O.find(u.songId)}h("queueChanged",M.slice())},clear:function(){v.pause();u={};M.length=0;O.length=0;K=-1;H({SongId:-1,IsPlaying:false,CurrentTime:0});h("queueChanged",M.slice());jQuery.ashx("clearsongqueue.ashx",null,{area:"music",error:function(){h("error",{type:"queue failure",cmd:"clear"})}})},list:function(){return M.slice()},load:function(P){P=a.makeArray(P);K=P.length?0:-1;M.length=0;M.push.apply(M,P);O=M;h("queueChanged",M.slice())},reorder:function(P){var Q=M.find(P.songId);if(Q==-1){return}jQuery.ashx("movesong.ashx?songId="+P.songId+"&oldPosition="+Q+"&newPosition="+P.newIndex,null,{area:"music",error:function(){h("error",{type:"queue failure",cmd:"reorder",data:P})}});var R=M[Q];M.splice(Q,1);M.splice(P.newIndex,0,R);h("queueChanged",M.slice())}}})(),C={activate:e,play:function(J){if(!J){if(z=="paused"){C["goto"](L,true)}else{v.now()}return}var L=J.time,M=o(J),N=J[M],K=typeof N=="object"?N.id:N;if(M=="song"&&K==u.songId){C["goto"](L,true)}else{v.now(J)}},"goto":function(K,J){if(z=="paused"&&J){B.resumeCurrentTrack(K||D);t=0}else{B.setCurrentPlayTime(K||D)}},pause:v.pause,volume:function(J){if(a.isFunction(J)){J(I);return}if(J>1){J=((I*10)+1)/10}else{if(J<0){J=((I*10)-1)/10}}if(J<0){J=0}else{if(J>1){J=1}}H({Volume:J*100});B.setCurrentVolume(J)},playing:function(J){if(a.isFunction(J)){J(a.extend({state:z,mode:q,time:D},u))}},queue:function(J){if(a.isFunction(J)){J(v.list())}},shuffle:function(J){if(a.isFunction(J)){J(v.shuffle())}else{v.shuffle(!J);H({Shuffle:""+!!J})}},next:v.next,last:v.last,previous:v.previous,clear:v.clear,remove:v.remove,reorder:v.reorder,"*":function(J){throw new Error("music."+J+" is not a valid command")}},w={activate:e,play:function(J){if(!J){if(z=="paused"){C["goto"](D,true)}else{v.now()}}else{e({mode:"player"},function(){C.play(J)})}},"goto":C["goto"],pause:v.pause,volume:C.volume,playing:C.playing,next:v.next,"*":C["*"]},x={activate:function(K,J){scomm.ready(function(){if(f){if(K.local){h("error",{type:"duplicate activation",cmd:J,data:K})}else{scomm.send("music.activate",K,f.id,function(){k();x.activate(K)})}}else{if(K.local){e(K)}else{s(null,K.url)}}})},"*":function(K,L){if(!/play|pause|next|last|previous|focus/.test(K)){return}if(f){scomm.ready(function(){scomm.send("music."+K,L,f.id,function(){k();x["*"](K,L)})})}else{if(!L){s()}else{if(K!="focus"){p("no active player found");var N=o(L),J=K=="play"?"now":K,M=["?",{song:"sid",album:"aid",playlist:"pid",songs:"songs"}[N],"=",L[N],"&ac=",J].join("");if(N=="playlist"){M+="&owner="+(L.owner||MySpace.ClientContext.DisplayFriendId||MySpace.ClientContext.UserId)}s(M)}}}}},i=a.comm.own("music",x),r=(function(J){return function(K){namespace("MySpace.PersistentPlayer",{onPlayerLoaded:function(){B=document.getElementById("persistentPlayer");B.setCurrentVolume(I);h("ready");for(var L=0;L<J.length;L++){J[L]()}J=G;r=function(M){setTimeout(M)}},onSongLoaded:function(M,N,L){p(arguments);z=L?"paused":"playing";h(z,a.extend({time:N,isPlaying:!L},v.find(M)));if(!L){_gaq.push(["_trackEvent","Song Play",(MySpace.ClientContext.FunctionalContext==="POMPV3")?"Queue":"Radio",M||"not set",(document.referrer.indexOf("facebook.com")>-1)?1:0])}},onPlayingNewTrack:a.noop,onPausingCurrentTrack:function(){z="paused";H({IsPlaying:false});h("paused",a.extend({},u))},onResumePlay:function(){z="playing";H({IsPlaying:true});h("playing",a.extend({},u))},onCurrentTime:function(L){D=L;H({CurrentTime:Math.round(L)});E++;i.broadcast("totalTime",E);i.broadcast("time",L);if(F.load){_gaq.push(["_trackEvent","Song Start",(+new Date)-F.load,u.songId]);F.load=0}},onStop:function(L,M,N){z="stopped";H({CurrentTime:0,IsPlaying:false});h("end",L);if(MySpace.PersistentPlayer&&MySpace.PersistentPlayer.VideoAdOn&&MySpace.Ads.MusicPlayerVideoAd&&E>MySpace.Ads.MusicPlayerVideoAd.triggerIntervals*60){t=1;l.forcefeed=(MySpace.Ads.MusicPlayerVideoAd.foreground)?MySpace.Ads.MusicPlayerVideoAd.adcall:MySpace.Ads.MusicPlayerVideoAd.backgroundAdCall;swfobject.embedSWF(MySpace.StaticContentBase+"/modules/common/static/swf/videoadwrapper.swf","videoAd","400","279","9.0.0","",l,{wmode:"transparent",allowScriptAccess:"always"},null,function(O){if(O.success){b.addClass("dialog videoAd").find(".videoAd p").click(MySpace.PersistentPlayer.videoEnd)}else{t=0}})}if(!v.next()){h("queueEnd")}},onError:function(L){console.error(L);h("error",{type:"flash",code:2,msg:L})},displayAd:function(M,L){},setCurrentPlayTime:function(L){D=L;H({CurrentTime:L});h("time",L)},onVolumeChange:function(L){I=L;h("volume",L)},onScrub:function(){},stopAdDisplay:function(){}});a("<div id=persistentPlayer>").appendTo("body");swfobject.embedSWF(MySpace.UI.Links.PixelPlayerUrl,"persistentPlayer","1","1","9.0.0","",null,{allowScriptAccess:"always"},null,function(L){if(!L.success){h("error",{type:"flash",code:1})}});r=function(L){J.push(L)};r(K)}})([]);function e(K,J){if(n){n.abort()}K=K||{};if(!K.mode){if(K.url){location.href=K.url;return}else{K.mode="player"}}else{if(!/radio|player/.test(K.mode)){throw new Error("Invalid data- Cannot activate music player")}}g();q=K.mode;h("activating",K);function M(Q){if(a.type(Q)=="string"){Q=a.makeArray(JSON.parse(Q))}i.abandon();if(q=="radio"){i=a.comm.own("music",w);h("modeChanged",q);v.load(Q);r(function(){v.now()})}else{if(q=="player"){i=a.comm.own("music",C);h("modeChanged",q);v.load(Q);if(K.usePrestate){var O=j._values.Shuffle&&j._values.Shuffle.toLowerCase()!="true";v.shuffle(O);var P=+j._values.SongId;if(P>0){r(function(){var R=j._values.CurrentTime|0;t=j._values.IsPlaying!="true";v.now({song:P,time:R})})}}}}r(function(){if(J){J()}})}var N=q=="radio"&&m(K);if(a.isArray(K.queue)){M(K.queue)}else{var L=(q==="player")?"queue.ashx":"getradiosongs.ashx?radio"+N+"="+K[N];n=jQuery.ashx(L,null,{area:"music",success:M})}}function g(){scomm.send("music.active",+new Date);setTimeout(g,1500)}function s(P,Q){var K=screen.availHeight,R=screen.availWidth,L=K-40-75,N=20,O=Math.max(R/3,750),M=20,J=["top=",N,",left=",M,",toolbar=no,titlebar=no,resizable=yes,menubar=no,scrollbars=no,location=no,personalbar=no,status=no,dependent=no"].join("");window.open((Q||"/music/player")+(P||""),"Myspace",J)}function o(J){for(var K in J){if(/song|album|playlist|songs/.test(K)){return K}}throw new Error("Type not found")}function m(J){for(var K in J){if(/seed|artist|genre/.test(K)){return K}}}function h(J,K){i.broadcast(J,K);scomm.ready(function(){scomm.send("music."+J,K)})}function H(J){if(q!="player"){return}a.extend(j._values,J);MySpace.Cookies.save(j,"."+document.domain,new Date().addDays(30))}var d={"music.focus":function(){p("focus?")},"music.update":function(J,K){if(!J){scomm.send("music.update",a.extend({state:z},u),K)}else{i.broadcast("update",J)}}},A={relay:x,player:C,radio:w};a.each("music.play music.pause music.next music.last music.activate".split(" "),function(K,J){d[J]=function(L,N){var M=A[q];(M[J.substr(6)]||M["*"])(L)}});function k(){clearTimeout(f.timeout);f=G;a("#siteFooter").removeClass("playerActive");i.broadcast("deactivate")}scomm.add(function(K,L,M){if(K=="_remove"){if(f&&f.id==M){k()}}else{if(q=="relay"){if(!/^music\./.test(K)){return}if(K=="music.active"){if(!f){a("#siteFooter").addClass("playerActive");scomm.send("music.update",null,M)}else{clearTimeout(f.timeout)}f={id:M,ts:L,timeout:setTimeout(function(){k()},2250)}}else{if(K=="music.modeChanged"){}else{i.broadcast(K.substr(6),L)}}}else{var J=d[K];if(J){J(L,M)}}}});namespace("MySpace.PersistentPlayer").videoEnd=function(){b.find("#videoAd").replaceWith('<div id="videoAd"></div>');b.removeClass("dialog videoAd");a.comm.send("music.play");E=0};a.comm.listen("page.idle",function(J){if(J==60&&!/stopped|paused/.test(z)){C.pause();h("idle")}})})(jQuery);(function(a){var b=["play","next","last","embed"],c={play:1100,pause:1101,next:1102,last:1103},h,l="",g={music:{"+buffering":function(q){l="buffering";j(q.songId,"activating")},"+playing":function(q){l="playing";h=q;j(q.songId,"playing").each(m)},"+paused":function(q){l="paused";j(q.songId,"paused")},"+end":function(){l="stopped";a("div.playAction[data-type]").each(i)},"+update":function(q){if(/playing|paused/.test(q.state)){g.music["+"+q.state](q)}},"+queueChanged":function(t){if(!h||!h.songId){return}var q=h.songId;for(var r=0,s=t.length;r<s;r++){if(t[r].songId==q){return}}g.music["+end"]()}},MusicPlayer:{"+openPopOut":function(q){a.comm.send("music.activate",q)}}};g.music["+deactivate"]=g.music["+end"];a.comm.listen(g);function i(s,r){r.className=r.className.replace(/ ?playing|paused|activating|disabled/g,"");var q=r.querySelector("button");q.className=q.className.replace("pause","play")}function j(q,r){return a("div.playAction[data-type]").each(i).filter("[data-songid="+q+"]").addClass(r)}function n(q){var r=q=="pause"?"play":"pause";$playPause.data("action",q).removeClass(r+"CirclePlayerIcon27").addClass(q+"CirclePlayerIcon27")}function m(s,r){var q=r.querySelector("button");q.className=q.className.replace("play","pause")}function k(r,t,s){var q=a("<div>"+MySpaceRes.MusicPlayer.PB_CopyNPasteEmbed+"<textarea style='width:290px;height:200px;'></textarea><a href='/music/buttons'>"+MySpaceRes.MusicPlayer.MoreEmbedOptions+"</a></div>").dialog({title:MySpaceRes.MusicPlayer.PB_GetEmbedCode,width:"small",dialogClass:"pending"}).bind("dialogclose",function(){q.dialog("destroy").remove()});e(27,{id:r,type:t,owner:s},function(u){q.find("textarea").text(u).closest(".glue-dialog").removeClass("pending")},function(){q.find("textarea").text(MySpaceRes.MusicPlayer.SorryError).closest(".glue-dialog").removeClass("pending")})}var p={"15":"-132px","20":"-112px","27":"-85px","35":"-50px","50":"0"};function e(v,r,s,t,u,q){var w=p[t];if(!w){t=27;w=p[t]}jQuery.ashx("musicdata.ashx",{id:r,type:v,owner:s},{area:"music",success:function(x){if(typeof x!="string"){if(q){q()}return}x=JSON.parse(x);var y=[(v=="album")?x.albumTitle:x.songTitle," ",MySpaceRes.MusicPlayer.By," ",x.artistName].join("");u(['<a class="',"my_play my_",t,'" title="',y,'" href="http://www.myspace.com/music/player?',v,"=",r,s?("&owner="+s):"",'"style="display:inline-block;margin:0;padding:0;border:0;width:',t,"px;height:",t,"px;overflow:hidden;text-indent:-9999px;background:url(http://x.myspacecdn.com/modules/common/static/img/playbuttonsprite.png) no-repeat 0 ",p[t],';">',y,'</a><script defer="true" src="http://www.myspace.com/music/buttons/js"></script>'].join(""))},error:q})}namespace("MySpace.UI.PlayButton",{getEmbedCode:e});a.comm.listen("page.changed",function(r){var q=a("div.playAction",r).addClass("ready").filter(".noMenu[data-type]").removeClass("noMenu").click(function(v){var s=a(this),t=s.hasClass("playing")?"pause":(s.hasClass("paused")||v.target.nodeName=="BUTTON")?"play":b[a(v.target).closest("li").index()],y=s.data("type"),w=s.data(y=="songs"?"songidlist":y+"Id"),x=MySpace.ClientContext.DisplayFriendId||MySpace.ClientContext.UserId,u={};u[y]=w;if(t=="embed"){k(w,y,x);return}if(y=="playlist"){u.owner=x}a.comm.send("music."+t,u);if(MySpace.Music!==undefined&&MySpace.Music.Beacon!==undefined){MySpace.Music.Beacon.SendBeacon(1,c[t],y=="songs"?"sl":y.charAt(0),w,y!="songs"?0:x)}s.addClass("disabled");setTimeout(function(){if(t!="play"){s.removeClass("disabled")}},1000)});if(h&&q.length){g.music["+update"](h)}},true);var o=a(".wrap");function f(q){for(var r in q){if(/[sap]id/.test(r)){return r}}throw new Error("Type not found")}var d={sid:"song",aid:"album",pid:"playlist"};o.click(function(s){var q=a(s.target).closest("a")[0];if(!q){return}var t=q.href;var v=/(\/music)?\/([^\/]+)\/radio(?=[?#]|$)/.exec(t);if(v){a.comm.send("music.activate",{url:v[0]});return false}v=/\/music\/player\/?(\?[^#]+)?/.exec(t);if(v){if(!v[1]){a.comm.send("music.activate",{});return false}var w=MySpace.Util.parseNameValuePairs(t.substr(t.indexOf("?")+1)),x=f(w),u=w[x],r={owner:w.owner};r[d[x]]=u;a.comm.send("music.play",r);return false}})})(jQuery);(function(a){var b=a("#siteFooter");b.find(".pompy, .musicControls").click(function(c){a.comm.send("music.focus")})})(jQuery);