var fitbit=(function(b,c){b.modules=b.modules||{};if(c.isFunction(b.modules.dropdown)){return b;}var a=function(d,e){if(!d||!d.length){return this._throwError("no catalyst specified");}this.catalyst=c(d).first();this.catalystActiveClass=null;this.anchorPoint="left below";this.elements={root:null,content:null};this.fadeEffectDuration=200;this.hideDelay=500;this.isManualShowEnabled=false;this.isMouseBoundaryDetectionEnabled=true;this.isMouseCursorInsideDropdown=false;this.namespace={css:"module-dd",event:"module-dropdown-"};this.positionOffset={x:0,y:0};this._initialize(e);};a.prototype={cancelHide:function(){if(this.hideTimer){clearTimeout(this.hideTimer);this.hideTimer=null;}},clear:function(){c(this.elements.content).empty();},destroy:function(){this._fireCustomEvent("destroy");this.catalyst.off("."+this.namespace.event);for(var d in this.elements){c(d).remove();}this.catalyst.removeData("module-dropdown-id");delete this;},getCatalystPosition:function(){return this._getCatalystPosition();},getRootElement:function(){return(this.elements.root&&this.elements.root.length)?this.elements.root.get(0):null;},hide:function(){var d=c(this.elements.root);if(!d.is(":animated")){this._fireCustomEvent("beforeHide");this.catalyst.removeClass(this.catalystActiveClass);d.fadeOut(this.fadeEffectDuration,c.proxy(function(){this._fireCustomEvent("hide");},this));}},isVisible:function(){try{return this.elements.root.is(":visible");}catch(d){return false;}},render:function(d,e){if(d){if(!e){this.clear();}c(this.elements.content).append(d);this._fireCustomEvent("render");return true;}return false;},setPosition:function(){this._setPosition();},setPositionOffset:function(d,e){if(c.isNumeric(d)){this.positionOffset.x=d;}if(c.isNumeric(e)){this.positionOffset.y=e;}},show:function(){this.setPosition();this._fireCustomEvent("beforeShow");this.catalyst.addClass(this.catalystActiveClass);c(this.elements.root).fadeIn(this.fadeEffectDuration,c.proxy(function(){this._fireCustomEvent("show");},this));},subscribe:function(d,f,e){if(typeof d==="string"&&c.isFunction(f)){this.catalyst[(e===true)?"one":"on"](this._getEventName(d),f);return true;}return false;},toggle:function(){return this._toggle();},unsubscribe:function(d,e){if(typeof d==="string"){this.catalyst.off(this._getEventName(d),e);return true;}return false;},_applyConfiguration:function(e){if(c.isPlainObject(e)){var d=function(f){return(typeof f==="string"&&!(/^\s*$/).test(f));};if(d(e.anchorPoint)){this.anchorPoint=e.anchorPoint;}if(d(e.className)){this.customClassName=e.className;}if(d(e.catalystActiveClass)){this.catalystActiveClass=e.catalystActiveClass;}if(c.isNumeric(e.hideDelay)){this.hideDelay=e.hideDelay>0?e.hideDelay:0;}if(c.isNumeric(e.fadeEffectDuration)||e.fadeEffectDuration===false){this.fadeEffectDuration=e.fadeEffectDuration;}this.isMouseBoundaryDetectionEnabled=!(e.mouseBoundaryDetectionEnabled===false);this.isManualShowEnabled=(e.manualShowEnabled===true);}},_buildStructure:function(){var f=c.proxy(function(g){var h=this.namespace.css;if(typeof g==="string"){h+="-"+g.replace(/\s+/,"-");}return h;},this);var e=c("<div/>").addClass(f()).hide();if(this.customClassName){e.addClass(this.customClassName);}var d=c("<div/>").addClass(f("content")).appendTo(e);e.appendTo(document.body);c.extend(this.elements,{root:e,content:d});},_defineAnchorPointStrategies:function(){if(!this.anchorPointStrategies){this.anchorPointStrategies={"below":c.proxy(function(){var d=this._getCatalystPosition();return{"top":parseInt(this.positionOffset.y+d.y+d.h,10)+"px","bottom":"auto"};},this),"left":c.proxy(function(){var d=this._getCatalystPosition();return{"left":parseInt(this.positionOffset.x+d.x,10)+"px","right":"auto"};},this),"right":c.proxy(function(){var d=this._getCatalystPosition();return{"right":parseInt(c(window).width()-((0-this.positionOffset.x)+d.x+d.w),10)+"px","left":"auto"};},this)};}},_fireCustomEvent:function(d){this.catalyst.trigger(this._getEventName(d),this);},_getCatalystPosition:function(){var d=this.catalyst;var e=d.offset();return{x:Math.round(e.left),y:Math.round(e.top),w:Math.round(d.outerWidth()),h:Math.round(d.outerHeight())};},_getEventName:function(d){return(typeof d==="string"||c.isArray(d))?d+"."+this.namespace.event:null;},_getEventNames:function(d){if(d){if(typeof d==="string"){d=[d];}c.each(d,c.proxy(function(f,e){d[f]=this._getEventName(e);},this));}return(d&&d.length)?d:null;},_getPositionByAnchorPoint:function(){var e=this.anchorPoint.split(" ");if(e.length!==2){this._throwError("anchor point is invalid");}var d={};c.each(e,c.proxy(function(f,g){c.extend(d,this.anchorPointStrategies[g]());},this));if(c.isEmptyObject(d)){this._throwError("could not determine dropdown position from anchor point");}return d;},_getUniqueId:function(){if(!c.isNumeric(this.uniqueId)){if(!c.isNumeric(b.modules.dropdown.numInstances)){b.modules.dropdown.numInstances=0;}this.uniqueId=b.modules.dropdown.numInstances=b.modules.dropdown.numInstances+1;}return this.uniqueId;},_initialize:function(d){var e=this._getUniqueId();this.namespace.event+=e;this._applyConfiguration(d);this._buildStructure();c(this.catalyst).add(this.elements.root).data("module-dropdown-id",e);this._initializeCatalyst();this._initializeMouseBoundaryDetection();this._defineAnchorPointStrategies();c(window).on(this._getEventName("resize"),c.proxy(function(){if(this.isVisible()){this._fireCustomEvent("hideAfterResize");this.hide();}},this));c(document.body).on(this._getEventName("click"),c.proxy(function(g){var f=c(g.target);if(this.isVisible()&&!(f.closest([this.catalyst,"."+this.namespace.css]).length)){this.hide();}},this));this._fireCustomEvent("initialize");},_initializeCatalyst:function(){if(!this.isManualShowEnabled&&!this.isMouseDelayedShowEnabled){this.catalyst.on(this._getEventName("click"),c.proxy(function(d){if(d){d.preventDefault();}this._toggle();},this));}},_initializeMouseBoundaryDetection:function(){if(this.isMouseBoundaryDetectionEnabled){this.elements.root.on(this._getEventName("mouseenter"),c.proxy(function(){this._setMouseCursorInsideDropdown(true);},this)).on(this._getEventName("mouseleave"),c.proxy(function(){this._setMouseCursorInsideDropdown(false);if(!this.hideTimer&&this.isVisible()){this.hideTimer=setTimeout(c.proxy(function(){if(!this.isMouseCursorInsideDropdown){this.hide();}this.cancelHide();},this),this.hideDelay);}},this));}},_setMouseCursorInsideDropdown:function(d){if(d){this.isMouseCursorInsideDropdown=true;this._fireCustomEvent("mouseEnterDropdown");}else{this.isMouseCursorInsideDropdown=false;this._fireCustomEvent("mouseLeaveDropdown");}},_setPosition:function(){this.elements.root.css(this._getPositionByAnchorPoint());this._fireCustomEvent("position");},_throwError:function(d){console.log("fitbit.modules.dropdown : "+(d||"unknown error"));},_toggle:function(){if(this.isVisible()){this.hide();return false;}else{this.show();return true;}}};b.modules.dropdown=a;return b;}(fitbit||{},jQuery));
$(function(){var b=$(".wrapper-header").first();var o=b.find(".wrapper-nav");var f=b.hasClass("nav-app");o.on("click",".nav > li",function(q){if($(q.currentTarget).hasClass("nav-products")){q.preventDefault();}else{var p=$(this).find("a").first().attr("href");if(p){q.preventDefault();location.href=p;}}});var i=$(".wrapper-system-alerts");if(i.length){var h=".system-alert";var e=i.find(h);e.find(".exit").one("click",function(){var t=$(this).closest(h);var q={alertType:t.data("type"),deviceType:t.data("device")};var r=t.data("cw-program");if(r!=null){q.attributes={CORPORATE_PROGRAM_ID:r};}var s=JSON.stringify(q);var p={request:JSON.stringify({template:"user/dash/alertResponse.json.jsp",serviceCalls:[{name:"alert",method:"processAlert",args:{action:"CLOSE",alert:s}}]})};$.ajax({type:"post",url:"/ajaxapi",data:p,dataType:"json"});t.trigger("destroy.systemAlert");var u=(e.length>1)?"fadeOut":"slideUp";t[u](function(){var v=t.next(h);if(v.length){v.fadeIn(function(){t.remove();m(v);v.trigger("impression.systemAlert");});}else{i.slideUp(function(){i.remove();setTimeout(function(){$("body").trigger("resetGlobalTimeSelector");},0);});}});});var m=function(r){if(!r){return;}var p=r.first().data("cookie");if(p&&!(/^\s*$/).test(p)){var q=new Date();q.setTime(q.getTime()+2629743830);document.cookie="system_alert"+"="+p+"; expires="+q.toGMTString()+"; path=/;";}};var d=e.first();m(d);var n=function(q){if(typeof q!=="string"){return;}var p=["_trackEvent","GlobalAlertProductReview-"+q];if(arguments.length>1){p=p.concat(Array.prototype.slice.call(arguments,1));}fitbit.util.deferredTrack(p);};e.filter(".amazon-review").one("impression.systemAlert",function(){n($(this).data("device"),"Display","Show");}).one("click",".message a",function(p){n($(p.delegateTarget).data("device"),"Click","LinkToAmazon");}).one("destroy.systemAlert",function(p){n($(p.target).data("device"),"Click","CloseForever");});if(d.hasClass("amazon-review")){d.trigger("impression.systemAlert");}}var j=$.isFunction(fitbit.modules.dropdown)&&fitbit.modules.dropdown;if(j){var l="active";var g="subnav";if(f){g+=" subnav-app";}var a=o.find(".hasdropdown");a.each(function(u,q){var r=$(q);var t=null;var s=null;var w=null;var y=false;function p(){if(w){clearTimeout(w);w=null;}if(s){clearTimeout(s);s=null;}}function x(){y=false;p();if(t&&t.isVisible()){s=setTimeout(function(){if(!t.isMouseCursorInsideDropdown&&!y){t.hide();r.removeClass(l);}p();},200);}}function v(){y=true;p();if(t){t.cancelHide();if(!t.isVisible()){w=setTimeout(function(){t.show();p();},350);}}}r.one("mouseover",function(){t=new j(r,{className:g,catalystActiveClass:l,hideDelay:200,manualShowEnabled:true});t.render(r.find(".subnav-content").first());v();}).on("mouseenter",v).on("mouseleave",x);});var c=b.find(".account > .profile");if(c.length){var k=".productNavDevices";c.one("mouseover"+k+" mousedown"+k,function(s){c.off(k);if(typeof Handlebars!=="undefined"){var p=Handlebars.compile("device_name_{{deviceType}}");var r=Handlebars.compile("device_displayName_{{deviceType}}");var q="com.fitbit.app.device.message.";var u=function(v){return fitbit.i18n.getResource(q+v);};var t=function(x,v){var w=r({deviceType:x});return u(w)||null;};$.post("/ajaxapi",{request:JSON.stringify({serviceCalls:[{name:"trackerSettings",method:"getAlarms"},{name:"device",method:"getOwnerDevices"}],template:"common/defaultResponse.json.jsp"})},function(w){var x=w[0];var A=w[1];var y=[];if(A.length){$.each(A,function(B,D){var C={className:"device-"+D.productName.toLowerCase(),displayName:t(D.type,D.productName),lastSyncActual:D.lastSyncTime,batteryLevel:D.battery?u("battery_"+D.battery.toLowerCase()):"",batteryClassName:D.battery?D.battery.toLowerCase():"",link:D.settingsUrl};if(D.lastSyncTime>0){C["lastSyncRelative"]=fitbit.util.getRelativeDate(D.lastSyncTime,false);}var E;$.each(x,function(F,G){if(G.trackerId===D.id&&G.enabled&&G.nextAlarmTimeUTC){if(!E){E=G;}else{if(G.nextAlarmTimeUTC<E.nextAlarmTimeUTC){E=G;}}}});if(E){C["nextAlarmTime"]=E.nextAlarmLocalDay+" "+E.localTime;C["link"]="/settings/alarms/";}y.push(C);});var z=$("#headerProfileSubNav").html();var v=Handlebars.compile(z)({devices:y});if(v){$("#profile-subnav").prepend(v);}}},"json");}}).one("click",function(q){q.preventDefault();var p=new j(c,{anchorPoint:"below right",className:g+" subnav-profile",catalystActiveClass:l,mouseBoundaryDetectionEnabled:false});var r=$("#profile-subnav");p.render(r);p.subscribe("beforeShow",function(){r.find(".device .sync").each(function(t,u){var s=parseInt($(u).attr("data-time"));if(s>0){$(u).text(fitbit.util.getRelativeDate(s,false));}});});p.subscribe("beforeShow",function(){var s=p.getRootElement();$(s).find(".link-dashboard").on("click",function(t){t.preventDefault();$.get("userSettings/dh/save?apiFormat=json&settings['show%20galileo%20dashboard']="+$(this).data("setting"),function(){window.location.reload();});});},true);p.show();});}}});
