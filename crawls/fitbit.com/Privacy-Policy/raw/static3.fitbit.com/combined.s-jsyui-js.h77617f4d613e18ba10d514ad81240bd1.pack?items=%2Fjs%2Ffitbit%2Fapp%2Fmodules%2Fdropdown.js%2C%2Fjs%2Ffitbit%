var fitbit=(function(b,c){b.modules=b.modules||{};if(c.isFunction(b.modules.dropdown)){return b;}var a=function(d,e){if(!d||!d.length){return this._throwError("no catalyst specified");}this.catalyst=c(d).first();this.catalystActiveClass=null;this.anchorPoint="left below";this.elements={root:null,content:null};this.fadeEffectDuration=200;this.hideDelay=500;this.isManualShowEnabled=false;this.isMouseBoundaryDetectionEnabled=true;this.isMouseCursorInsideDropdown=false;this.namespace={css:"module-dd",event:"module-dropdown-"};this.positionOffset={x:0,y:0};this._initialize(e);};a.prototype={cancelHide:function(){if(this.hideTimer){clearTimeout(this.hideTimer);this.hideTimer=null;}},clear:function(){c(this.elements.content).empty();},destroy:function(){this._fireCustomEvent("destroy");this.catalyst.off("."+this.namespace.event);for(var d in this.elements){c(d).remove();}this.catalyst.removeData("module-dropdown-id");delete this;},getCatalystPosition:function(){return this._getCatalystPosition();},getRootElement:function(){return(this.elements.root&&this.elements.root.length)?this.elements.root.get(0):null;},hide:function(){var d=c(this.elements.root);if(!d.is(":animated")){this._fireCustomEvent("beforeHide");this.catalyst.removeClass(this.catalystActiveClass);d.fadeOut(this.fadeEffectDuration,c.proxy(function(){this._fireCustomEvent("hide");},this));}},isVisible:function(){try{return this.elements.root.is(":visible");}catch(d){return false;}},render:function(d,e){if(d){if(!e){this.clear();}c(this.elements.content).append(d);this._fireCustomEvent("render");return true;}return false;},setPosition:function(){this._setPosition();},setPositionOffset:function(d,e){if(c.isNumeric(d)){this.positionOffset.x=d;}if(c.isNumeric(e)){this.positionOffset.y=e;}},show:function(){this.setPosition();this._fireCustomEvent("beforeShow");this.catalyst.addClass(this.catalystActiveClass);c(this.elements.root).fadeIn(this.fadeEffectDuration,c.proxy(function(){this._fireCustomEvent("show");},this));},subscribe:function(d,f,e){if(typeof d==="string"&&c.isFunction(f)){this.catalyst[(e===true)?"one":"on"](this._getEventName(d),f);return true;}return false;},toggle:function(){return this._toggle();},unsubscribe:function(d,e){if(typeof d==="string"){this.catalyst.off(this._getEventName(d),e);return true;}return false;},_applyConfiguration:function(e){if(c.isPlainObject(e)){var d=function(f){return(typeof f==="string"&&!(/^\s*$/).test(f));};if(d(e.anchorPoint)){this.anchorPoint=e.anchorPoint;}if(d(e.className)){this.customClassName=e.className;}if(d(e.catalystActiveClass)){this.catalystActiveClass=e.catalystActiveClass;}if(c.isNumeric(e.hideDelay)){this.hideDelay=e.hideDelay>0?e.hideDelay:0;}if(c.isNumeric(e.fadeEffectDuration)||e.fadeEffectDuration===false){this.fadeEffectDuration=e.fadeEffectDuration;}this.isMouseBoundaryDetectionEnabled=!(e.mouseBoundaryDetectionEnabled===false);this.isManualShowEnabled=(e.manualShowEnabled===true);}},_buildStructure:function(){var f=c.proxy(function(g){var h=this.namespace.css;if(typeof g==="string"){h+="-"+g.replace(/\s+/,"-");}return h;},this);var e=c("<div/>").addClass(f()).hide();if(this.customClassName){e.addClass(this.customClassName);}var d=c("<div/>").addClass(f("content")).appendTo(e);e.appendTo(document.body);c.extend(this.elements,{root:e,content:d});},_defineAnchorPointStrategies:function(){if(!this.anchorPointStrategies){this.anchorPointStrategies={"below":c.proxy(function(){var d=this._getCatalystPosition();return{"top":parseInt(this.positionOffset.y+d.y+d.h,10)+"px","bottom":"auto"};},this),"left":c.proxy(function(){var d=this._getCatalystPosition();return{"left":parseInt(this.positionOffset.x+d.x,10)+"px","right":"auto"};},this),"right":c.proxy(function(){var d=this._getCatalystPosition();return{"right":parseInt(c(window).width()-((0-this.positionOffset.x)+d.x+d.w),10)+"px","left":"auto"};},this)};}},_fireCustomEvent:function(d){this.catalyst.trigger(this._getEventName(d),this);},_getCatalystPosition:function(){var d=this.catalyst;var e=d.offset();return{x:Math.round(e.left),y:Math.round(e.top),w:Math.round(d.outerWidth()),h:Math.round(d.outerHeight())};},_getEventName:function(d){return(typeof d==="string"||c.isArray(d))?d+"."+this.namespace.event:null;},_getEventNames:function(d){if(d){if(typeof d==="string"){d=[d];}c.each(d,c.proxy(function(f,e){d[f]=this._getEventName(e);},this));}return(d&&d.length)?d:null;},_getPositionByAnchorPoint:function(){var e=this.anchorPoint.split(" ");if(e.length!==2){this._throwError("anchor point is invalid");}var d={};c.each(e,c.proxy(function(f,g){c.extend(d,this.anchorPointStrategies[g]());},this));if(c.isEmptyObject(d)){this._throwError("could not determine dropdown position from anchor point");}return d;},_getUniqueId:function(){if(!c.isNumeric(this.uniqueId)){if(!c.isNumeric(b.modules.dropdown.numInstances)){b.modules.dropdown.numInstances=0;}this.uniqueId=b.modules.dropdown.numInstances=b.modules.dropdown.numInstances+1;}return this.uniqueId;},_initialize:function(d){var e=this._getUniqueId();this.namespace.event+=e;this._applyConfiguration(d);this._buildStructure();c(this.catalyst).add(this.elements.root).data("module-dropdown-id",e);this._initializeCatalyst();this._initializeMouseBoundaryDetection();this._defineAnchorPointStrategies();c(window).on(this._getEventName("resize"),c.proxy(function(){if(this.isVisible()){this._fireCustomEvent("hideAfterResize");this.hide();}},this));c(document.body).on(this._getEventName("click"),c.proxy(function(g){var f=c(g.target);if(this.isVisible()&&!(f.closest([this.catalyst,"."+this.namespace.css]).length)){this.hide();}},this));this._fireCustomEvent("initialize");},_initializeCatalyst:function(){if(!this.isManualShowEnabled&&!this.isMouseDelayedShowEnabled){this.catalyst.on(this._getEventName("click"),c.proxy(function(d){if(d){d.preventDefault();}this._toggle();},this));}},_initializeMouseBoundaryDetection:function(){if(this.isMouseBoundaryDetectionEnabled){this.elements.root.on(this._getEventName("mouseenter"),c.proxy(function(){this._setMouseCursorInsideDropdown(true);},this)).on(this._getEventName("mouseleave"),c.proxy(function(){this._setMouseCursorInsideDropdown(false);if(!this.hideTimer&&this.isVisible()){this.hideTimer=setTimeout(c.proxy(function(){if(!this.isMouseCursorInsideDropdown){this.hide();}this.cancelHide();},this),this.hideDelay);}},this));}},_setMouseCursorInsideDropdown:function(d){if(d){this.isMouseCursorInsideDropdown=true;this._fireCustomEvent("mouseEnterDropdown");}else{this.isMouseCursorInsideDropdown=false;this._fireCustomEvent("mouseLeaveDropdown");}},_setPosition:function(){this.elements.root.css(this._getPositionByAnchorPoint());this._fireCustomEvent("position");},_throwError:function(d){console.log("fitbit.modules.dropdown : "+(d||"unknown error"));},_toggle:function(){if(this.isVisible()){this.hide();return false;}else{this.show();return true;}}};b.modules.dropdown=a;return b;}(fitbit||{},jQuery));
(function(){var g=$(".wrapper-header").first();var f=g.find(".wrapper-nav");var e=g.hasClass("nav-app");f.on("click",".nav > li",function(i){if($(i.currentTarget).hasClass("nav-products")){i.preventDefault();}else{var h=$(this).find("a").first().attr("href");if(h){i.preventDefault();location.href=h;}}});var a=$.isFunction(fitbit.modules.dropdown)&&fitbit.modules.dropdown;var c="active";var b="subnav";if(e){b+=" subnav-app";}d();$(function(){var j=$(".wrapper-system-alerts");if(j.length){var m=".system-alert";var h=j.find(m);h.find(".exit").one("click",function(){var s=$(this).closest(m);var p={alertType:s.data("type"),deviceType:s.data("device")};var q=s.data("cw-program");if(q!=null){p.attributes={CORPORATE_PROGRAM_ID:q};}var r=JSON.stringify(p);var o={request:JSON.stringify({template:"user/dash/alertResponse.json.jsp",serviceCalls:[{name:"alert",method:"processAlert",args:{action:"CLOSE",alert:r}}]})};$.ajax({type:"post",url:"/ajaxapi",data:o,dataType:"json"});s.trigger("destroy.systemAlert");var t=(h.length>1)?"fadeOut":"slideUp";s[t](function(){var u=s.next(m);if(u.length){u.fadeIn(function(){s.remove();i(u);u.trigger("impression.systemAlert");});}else{j.slideUp(function(){j.remove();setTimeout(function(){$("body").trigger("resetGlobalTimeSelector");},0);});}});});var i=function(q){if(!q){return;}var o=q.first().data("cookie");if(o&&!(/^\s*$/).test(o)){var p=new Date();p.setTime(p.getTime()+2629743830);document.cookie="system_alert"+"="+o+"; expires="+p.toGMTString()+"; path=/;";}};var l=h.first();i(l);var n=function(p){if(typeof p!=="string"){return;}var o=["_trackEvent","GlobalAlertProductReview-"+p];if(arguments.length>1){o=o.concat(Array.prototype.slice.call(arguments,1));}fitbit.util.deferredTrack(o);};h.filter(".amazon-review").one("impression.systemAlert",function(){n($(this).data("device"),"Display","Show");}).one("click",".message a",function(o){n($(o.delegateTarget).data("device"),"Click","LinkToAmazon");}).one("destroy.systemAlert",function(o){n($(o.target).data("device"),"Click","CloseForever");});if(l.hasClass("amazon-review")){l.trigger("impression.systemAlert");}}if(a){var k=f.find(".hasdropdown");k.each(function(t,p){var q=$(p);var s=null;var r=null;var v=null;var x=false;function o(){if(v){clearTimeout(v);v=null;}if(r){clearTimeout(r);r=null;}}function w(){x=false;o();if(s&&s.isVisible()){r=setTimeout(function(){if(!s.isMouseCursorInsideDropdown&&!x){s.hide();q.removeClass(c);}o();},200);}}function u(){x=true;o();if(s){s.cancelHide();if(!s.isVisible()){v=setTimeout(function(){s.show();o();},350);}}}q.one("mouseover",function(){s=new a(q,{className:b,catalystActiveClass:c,hideDelay:200,manualShowEnabled:true});s.render(q.find(".subnav-content").first());u();}).on("mouseenter",u).on("mouseleave",w);});}});function d(){var h=g.find(".account > .profile");if(h.length&&a){var i=".productNavDevices";h.one("mouseover"+i+" mousedown"+i,function(m){h.off(i);if(typeof Handlebars!=="undefined"){var j=Handlebars.compile("device_name_{{deviceType}}");var l=Handlebars.compile("device_displayName_{{deviceType}}");var k="com.fitbit.app.device.message.";var o=function(p){return fitbit.i18n.getResource(k+p);};var n=function(r,p){var q=l({deviceType:r});return o(q)||null;};$.post("/ajaxapi",{request:JSON.stringify({serviceCalls:[{name:"trackerSettings",method:"getAlarms"},{name:"device",method:"getOwnerDevices"}],template:"common/defaultResponse.json.jsp"})},function(q){var r=q[0];var u=q[1];var s=[];if(u.length){$.each(u,function(v,x){var w={className:"device-"+x.productName.toLowerCase(),displayName:n(x.type,x.productName),lastSyncActual:x.lastSyncTime,batteryLevel:x.battery?o("battery_"+x.battery.toLowerCase()):"",batteryClassName:x.battery?x.battery.toLowerCase():"",link:x.settingsUrl};if(x.lastSyncTime>0){w["lastSyncRelative"]=fitbit.util.getRelativeDate(x.lastSyncTime,false);}var y;$.each(r,function(z,A){if(A.trackerId===x.id&&A.enabled&&A.nextAlarmTimeUTC){if(!y){y=A;}else{if(A.nextAlarmTimeUTC<y.nextAlarmTimeUTC){y=A;}}}});if(y){w["nextAlarmTime"]=y.nextAlarmLocalDay+" "+y.localTime;w["link"]="/settings/alarms/";}s.push(w);});var t=$("#headerProfileSubNav").html();var p=Handlebars.compile(t)({devices:s});if(p){$("#profile-subnav").prepend(p);}}},"json");}}).one("click",function(k){k.preventDefault();var j=new a(h,{anchorPoint:"below right",className:b+" subnav-profile",catalystActiveClass:c,mouseBoundaryDetectionEnabled:false});var l=$("#profile-subnav");j.render(l);j.subscribe("beforeShow",function(){l.find(".device .sync").each(function(n,o){var m=parseInt($(o).attr("data-time"));if(m>0){$(o).text(fitbit.util.getRelativeDate(m,false));}});});j.subscribe("beforeShow",function(){var m=j.getRootElement();$(m).find(".link-dashboard").on("click",function(n){n.preventDefault();$.get("userSettings/dh/save?apiFormat=json&settings['show%20galileo%20dashboard']="+$(this).data("setting"),function(){window.location.reload();});});},true);j.show();});}}}());
