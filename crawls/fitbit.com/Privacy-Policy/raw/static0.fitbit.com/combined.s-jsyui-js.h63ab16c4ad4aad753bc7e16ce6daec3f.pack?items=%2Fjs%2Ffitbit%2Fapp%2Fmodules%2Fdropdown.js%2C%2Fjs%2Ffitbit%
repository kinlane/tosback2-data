(function(){var a=window.define||function(b){return b();};a(function(d){var c=(typeof d==="function");var f=c?d("jquery"):window.jQuery;if(!c){var e=window.fitbit||{};e.modules=e.modules||{};if(f.isFunction(e.modules.dropdown)){return e;}}var b=function(g,h){if(!g||!g.length){return this._throwError("no catalyst specified");}this.catalyst=f(g).first();this.catalystActiveClass=null;this.anchorPoint="left below";this.elements={root:null,content:null};this.fadeEffectDuration=200;this.hideDelay=500;this.isManualShowEnabled=false;this.isMouseBoundaryDetectionEnabled=true;this.isMouseCursorInsideDropdown=false;this.namespace={css:"module-dd",event:"module-dropdown-"};this.positionOffset={x:0,y:0};this._initialize(h);};b.prototype={cancelHide:function(){if(this.hideTimer){clearTimeout(this.hideTimer);this.hideTimer=null;}},clear:function(){f(this.elements.content).empty();},destroy:function(){this._fireCustomEvent("destroy");this.catalyst.off("."+this.namespace.event);for(var g in this.elements){f(g).remove();}this.catalyst.removeData("module-dropdown-id");delete this;},getCatalystPosition:function(){return this._getCatalystPosition();},getRootElement:function(){return(this.elements.root&&this.elements.root.length)?this.elements.root.get(0):null;},hide:function(){var g=f(this.elements.root);if(!g.is(":animated")){this._fireCustomEvent("beforeHide");this.catalyst.removeClass(this.catalystActiveClass);g.fadeOut(this.fadeEffectDuration,f.proxy(function(){this._fireCustomEvent("hide");},this));}},isVisible:function(){try{return this.elements.root.is(":visible");}catch(g){return false;}},render:function(g,h){if(g){if(!h){this.clear();}f(this.elements.content).append(g);this._fireCustomEvent("render");return true;}return false;},setPosition:function(){this._setPosition();},setPositionOffset:function(g,h){if(f.isNumeric(g)){this.positionOffset.x=g;}if(f.isNumeric(h)){this.positionOffset.y=h;}},show:function(){this.setPosition();this._fireCustomEvent("beforeShow");this.catalyst.addClass(this.catalystActiveClass);f(this.elements.root).fadeIn(this.fadeEffectDuration,f.proxy(function(){this._fireCustomEvent("show");},this));},subscribe:function(g,i,h){if(typeof g==="string"&&f.isFunction(i)){this.catalyst[(h===true)?"one":"on"](this._getEventName(g),i);return true;}return false;},toggle:function(){return this._toggle();},unsubscribe:function(g,h){if(typeof g==="string"){this.catalyst.off(this._getEventName(g),h);return true;}return false;},_applyConfiguration:function(h){if(f.isPlainObject(h)){var g=function(i){return(typeof i==="string"&&!(/^\s*$/).test(i));};if(g(h.anchorPoint)){this.anchorPoint=h.anchorPoint;}if(g(h.className)){this.customClassName=h.className;}if(g(h.catalystActiveClass)){this.catalystActiveClass=h.catalystActiveClass;}if(f.isNumeric(h.hideDelay)){this.hideDelay=h.hideDelay>0?h.hideDelay:0;}if(f.isNumeric(h.fadeEffectDuration)||h.fadeEffectDuration===false){this.fadeEffectDuration=h.fadeEffectDuration;}this.isMouseBoundaryDetectionEnabled=!(h.mouseBoundaryDetectionEnabled===false);this.isManualShowEnabled=(h.manualShowEnabled===true);}},_buildStructure:function(){var i=f.proxy(function(j){var k=this.namespace.css;if(typeof j==="string"){k+="-"+j.replace(/\s+/,"-");}return k;},this);var h=f("<div/>").addClass(i()).hide();if(this.customClassName){h.addClass(this.customClassName);}var g=f("<div/>").addClass(i("content")).appendTo(h);h.appendTo(document.body);f.extend(this.elements,{root:h,content:g});},_defineAnchorPointStrategies:function(){if(!this.anchorPointStrategies){this.anchorPointStrategies={"below":f.proxy(function(){var g=this._getCatalystPosition();return{"top":parseInt(this.positionOffset.y+g.y+g.h,10)+"px","bottom":"auto"};},this),"left":f.proxy(function(){var g=this._getCatalystPosition();return{"left":parseInt(this.positionOffset.x+g.x,10)+"px","right":"auto"};},this),"right":f.proxy(function(){var g=this._getCatalystPosition();return{"right":parseInt(f(window).width()-((0-this.positionOffset.x)+g.x+g.w),10)+"px","left":"auto"};},this)};}},_fireCustomEvent:function(g){this.catalyst.trigger(this._getEventName(g),this);},_getCatalystPosition:function(){var g=this.catalyst;var h=g.offset();return{x:Math.round(h.left),y:Math.round(h.top),w:Math.round(g.outerWidth(false)),h:Math.round(g.outerHeight(false))};},_getEventName:function(g){return(typeof g==="string"||f.isArray(g))?g+"."+this.namespace.event:null;},_getEventNames:function(g){if(g){if(typeof g==="string"){g=[g];}f.each(g,f.proxy(function(i,h){g[i]=this._getEventName(h);},this));}return(g&&g.length)?g:null;},_getPositionByAnchorPoint:function(){var h=this.anchorPoint.split(" ");if(h.length!==2){this._throwError("anchor point is invalid");}var g={};f.each(h,f.proxy(function(i,j){f.extend(g,this.anchorPointStrategies[j]());},this));if(f.isEmptyObject(g)){this._throwError("could not determine dropdown position from anchor point");}return g;},_getUniqueId:function(){if(!f.isNumeric(this.uniqueId)){this.uniqueId=parseInt(Math.random().toString().replace(".",""),10);}return this.uniqueId;},_initialize:function(g){var h=this._getUniqueId();this.namespace.event+=h;this._applyConfiguration(g);this._buildStructure();f(this.catalyst).add(this.elements.root).data("module-dropdown-id",h);this._initializeCatalyst();this._initializeMouseBoundaryDetection();this._defineAnchorPointStrategies();f(window).on(this._getEventName("resize"),f.proxy(function(){if(this.isVisible()){this._fireCustomEvent("hideAfterResize");this.hide();}},this));f(document.body).on(this._getEventName("click"),f.proxy(function(j){var i=f(j.target);if(this.isVisible()&&!(i.closest(this.catalyst).length||i.closest("."+this.namespace.css).length)){this.hide();}},this));this._fireCustomEvent("initialize");},_initializeCatalyst:function(){if(!this.isManualShowEnabled&&!this.isMouseDelayedShowEnabled){this.catalyst.on(this._getEventName("click"),f.proxy(function(g){if(g){g.preventDefault();}this._toggle();},this));}},_initializeMouseBoundaryDetection:function(){if(this.isMouseBoundaryDetectionEnabled){this.elements.root.on(this._getEventName("mouseenter"),f.proxy(function(){this._setMouseCursorInsideDropdown(true);},this)).on(this._getEventName("mouseleave"),f.proxy(function(){this._setMouseCursorInsideDropdown(false);if(!this.hideTimer&&this.isVisible()){this.hideTimer=setTimeout(f.proxy(function(){if(!this.isMouseCursorInsideDropdown){this.hide();}this.cancelHide();},this),this.hideDelay);}},this));}},_setMouseCursorInsideDropdown:function(g){if(g){this.isMouseCursorInsideDropdown=true;this._fireCustomEvent("mouseEnterDropdown");}else{this.isMouseCursorInsideDropdown=false;this._fireCustomEvent("mouseLeaveDropdown");}},_setPosition:function(){this.elements.root.css(this._getPositionByAnchorPoint());this._fireCustomEvent("position");},_throwError:function(g){console.log("Fitbit Dropdown Widget : "+(g||"unknown error"));},_toggle:function(){if(this.isVisible()){this.hide();return false;}else{this.show();return true;}}};if(c){return b;}else{e.modules.dropdown=b;return e;}});}());
(function(){var a=window.define||function(b){return b();};a(function(f){var j=(typeof f==="function");var q=document.getElementById("requirejs");if(j){var c=f("jquery");var n=f("fitbit-widget-dropdown");f("fitbit-header-notificationDropdown");}else{var c=window.jQuery;var n=c.isFunction(fitbit.modules.dropdown)&&fitbit.modules.dropdown;}if(j&&!q){var p=f("galileo/util/date").getRelativeDate;var t=f("messages-deviceNames");var m=f("messages-batteryLevels");var l="???";var i=function(v,u){return(t[v]&&t[v][u])?t[v][u]:l;};var e=function(u){return m[u]?m[u]:l;};}else{var p=fitbit.util.getRelativeDate;var s="com.fitbit.app.device.message.";var i=function(v,u){return fitbit.i18n.getResource(s+"device_"+u+"_"+v);};var e=function(u){return fitbit.i18n.getResource(s+"battery_"+u);};}var b=function(){var v=window.mixpanel;var u=v.master;return u?u:v;};var o=c(".wrapper-header").first();if(o.data("fitbitHeaderInitialized")){return;}o.data("fitbitHeaderInitialized",true);var g=o.find(".wrapper-nav");var d=o.hasClass("nav-app");var r="active";var h="subnav";if(d){h+=" subnav-app";}g.on("click",".nav > li",function(v){if(c(v.currentTarget).hasClass("nav-products")){v.preventDefault();}else{var u=c(this).find("a").first().attr("href");if(u){v.preventDefault();location.href=u;}}});k();c(function(){var A=c(".wrapper-system-alerts");if(A.length){var x=".system-alert";var w=A.find(x);w.find(".exit").one("click",function(){var I=c(this).closest(x);var F={alertType:I.data("type"),deviceType:I.data("device")};var G=I.data("cw-program");if(G!=null){F.attributes={CORPORATE_PROGRAM_ID:G};}var H=JSON.stringify(F);var E={request:JSON.stringify({template:"user/dash/alertResponse.json.jsp",serviceCalls:[{name:"alert",method:"processAlert",args:{action:"CLOSE",alert:H}}]})};c.ajax({type:"post",url:"/ajaxapi",data:E,dataType:"json"});I.trigger("destroy.systemAlert");var J=(w.length>1)?"fadeOut":"slideUp";I[J](function(){var K=I.next(x);if(K.length){K.fadeIn(function(){I.remove();C(K);K.trigger("impression.systemAlert");});}else{A.slideUp(function(){A.remove();setTimeout(function(){c("body").trigger("resetGlobalTimeSelector");},0);});}});});var C=function(G){if(!G){return;}var E=G.first().data("cookie");if(E&&!(/^\s*$/).test(E)){var F=new Date();F.setTime(F.getTime()+2629743830);document.cookie="system_alert"+"="+E+"; expires="+F.toGMTString()+"; path=/;";}};var v=w.first();C(v);var D=function(F){if(typeof F!=="string"){return;}var E=["_trackEvent","GlobalAlertProductReview-"+F];if(arguments.length>1){E=E.concat(Array.prototype.slice.call(arguments,1));}try{fitbit.util.deferredTrack(E);}catch(G){if(console){console.log("header.js: 'fitbit.util.deferredTrack' is not available");}}};var B=function(F,E,G){if(!F){return;}var H={};E&&(H["!PRODUCT_SHOWN"]=E);typeof G!=void 0&&(H["!ACTION"]=G);b().track(F,H);};var y=function(E,F){B("Dash: Amazon Review Alert Clicked",E,F);};w.filter(".amazon-review").one("impression.systemAlert",function(){var E=c(this).data("device");D(E,"Display","Show");B("Dash: Amazon Review Alert",E);}).one("click",".message a",function(F){var E=c(F.delegateTarget).data("device");D(E,"Click","LinkToAmazon");y(E,"review");}).one("destroy.systemAlert",function(F){var E=c(F.target).data("device");D(E,"Click","CloseForever");y(E,"close");});w.filter(".newDashInvite").one("impression.systemAlert",function(){b().track("Dash: Preview Promo");});v.trigger("impression.systemAlert");}if(n){var u=g.find(".hasdropdown");u.each(function(J,F){var G=c(F);var I=null;var H=null;var L=null;var N=false;function E(){if(L){clearTimeout(L);L=null;}if(H){clearTimeout(H);H=null;}}function M(){N=false;E();if(I&&I.isVisible()){H=setTimeout(function(){if(!I.isMouseCursorInsideDropdown&&!N){I.hide();G.removeClass(r);}E();},200);}}function K(){N=true;E();if(I){I.cancelHide();if(!I.isVisible()){L=setTimeout(function(){I.show();E();},350);}}}G.one("mouseover",function(){I=new n(G,{className:h,catalystActiveClass:r,hideDelay:200,manualShowEnabled:true});I.render(G.find(".subnav-content").first());K();}).on("mouseenter",K).on("mouseleave",M);});}var z=o.find(".nav-item-cart");if(z.length){c(document.body).on("hideCartIcon.siteHeader",function(){z.hide();}).on("showCartIcon.siteHeader",function(){z.show();});}});function k(){var u=o.find(".account > .nav-item-settings");if(u.length&&n){var v=".accountSettingsDropdown";u.one("mouseover"+v+" mousedown"+v,function(w){u.off(v).addClass("hasdropdown");c.post("/ajaxapi",{request:JSON.stringify({serviceCalls:[{name:"trackerSettings",method:"getAlarms"},{name:"device",method:"getOwnerDevices"}],template:"common/defaultResponse.json.jsp"})},function(y){var z=y[0];var A=y[1];var x=[];if(A.length){c.each(A,function(C,F){x.push(c("<li>").addClass("device-divider").append(c("<div>").addClass("hr")));var E=c("<li>").addClass("device").addClass("device-"+F.productName.toLowerCase());var D=c("<a>").addClass("gotoSettings").appendTo(E);F.settingsUrl&&D.attr("href",F.settingsUrl);D.append(c("<div>").addClass("icon"));var B=c("<div>").addClass("info").append(c("<span>").addClass("type").text(i(F.type,"displayName")),c("<br>"),c("<span>").addClass("sync deviceDetail").data("time",F.lastSyncTime).text(F.lastSyncTime>0?p(F.lastSyncTime):"")).appendTo(D);var G;c.each(z,function(H,I){if(I.trackerId===F.id&&I.enabled&&I.nextAlarmTimeUTC){if(!G){G=I;}else{if(I.nextAlarmTimeUTC<G.nextAlarmTimeUTC){G=I;}}}});if(G){B.append(c("<br>"),c("<span>").addClass("alarm deviceDetail").text(G.nextAlarmLocalDay+" "+G.localTime));D.attr("href","/settings/alarms/");}B.append(c("<div>").addClass("battery").addClass(F.battery?F.battery.toLowerCase():"").attr("title",F.battery?e(F.battery.toLowerCase()):""));x.push(E);});}x.push(c("<li>").addClass("divider"));c.each(x.reverse(),function(){c("#header-settings-subnav").prepend(this);});},"json");}).one("click",function(x){x.preventDefault();var w=new n(u,{anchorPoint:"below right",className:h+" subnav-settings",catalystActiveClass:r,mouseBoundaryDetectionEnabled:false});var y=c("#header-settings-subnav");w.render(y);w.subscribe("beforeShow",function(){y.find(".device .sync").each(function(A,B){var z=parseInt(c(B).attr("data-time"));if(z>0){c(B).text(p(z));}});});w.subscribe("beforeShow",function(){var z=w.getRootElement();c(z).find(".link-dashboard").on("click",function(C){C.preventDefault();var A=c(this);var B=A.data("setting");c.get("/userSettings/dh/save?apiFormat=json&settings['show%20galileo%20dashboard']="+B,function(){window.location="/";});});},true);w.show();});}}});}());
