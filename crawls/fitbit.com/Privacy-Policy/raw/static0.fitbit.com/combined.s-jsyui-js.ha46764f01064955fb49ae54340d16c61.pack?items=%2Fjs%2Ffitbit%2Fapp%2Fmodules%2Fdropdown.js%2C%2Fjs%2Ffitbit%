(function(){var a=window.define||function(b){return b();};a(function(d){var c=(typeof d==="function");var f=c?d("jquery"):window.jQuery;if(!c){var e=window.fitbit||{};e.modules=e.modules||{};if(f.isFunction(e.modules.dropdown)){return e;}}var b=function(g,h){if(!g||!g.length){return this._throwError("no catalyst specified");}this.catalyst=f(g).first();this.catalystActiveClass=null;this.anchorPoint="left below";this.elements={root:null,content:null};this.fadeEffectDuration=200;this.hideDelay=500;this.isManualShowEnabled=false;this.isMouseBoundaryDetectionEnabled=true;this.isMouseCursorInsideDropdown=false;this.namespace={css:"module-dd",event:"module-dropdown-"};this.positionOffset={x:0,y:0};this._initialize(h);};b.prototype={cancelHide:function(){if(this.hideTimer){clearTimeout(this.hideTimer);this.hideTimer=null;}},clear:function(){f(this.elements.content).empty();},destroy:function(){this._fireCustomEvent("destroy");this.catalyst.off("."+this.namespace.event);for(var g in this.elements){f(g).remove();}this.catalyst.removeData("module-dropdown-id");delete this;},getCatalystPosition:function(){return this._getCatalystPosition();},getRootElement:function(){return(this.elements.root&&this.elements.root.length)?this.elements.root.get(0):null;},hide:function(){var g=f(this.elements.root);if(!g.is(":animated")){this._fireCustomEvent("beforeHide");this.catalyst.removeClass(this.catalystActiveClass);g.fadeOut(this.fadeEffectDuration,f.proxy(function(){this._fireCustomEvent("hide");},this));}},isVisible:function(){try{return this.elements.root.is(":visible");}catch(g){return false;}},render:function(g,h){if(g){if(!h){this.clear();}f(this.elements.content).append(g);this._fireCustomEvent("render");return true;}return false;},setPosition:function(){this._setPosition();},setPositionOffset:function(g,h){if(f.isNumeric(g)){this.positionOffset.x=g;}if(f.isNumeric(h)){this.positionOffset.y=h;}},show:function(){this.setPosition();this._fireCustomEvent("beforeShow");this.catalyst.addClass(this.catalystActiveClass);f(this.elements.root).fadeIn(this.fadeEffectDuration,f.proxy(function(){this._fireCustomEvent("show");},this));},subscribe:function(g,i,h){if(typeof g==="string"&&f.isFunction(i)){this.catalyst[(h===true)?"one":"on"](this._getEventName(g),i);return true;}return false;},toggle:function(){return this._toggle();},unsubscribe:function(g,h){if(typeof g==="string"){this.catalyst.off(this._getEventName(g),h);return true;}return false;},_applyConfiguration:function(h){if(f.isPlainObject(h)){var g=function(i){return(typeof i==="string"&&!(/^\s*$/).test(i));};if(g(h.anchorPoint)){this.anchorPoint=h.anchorPoint;}if(g(h.className)){this.customClassName=h.className;}if(g(h.catalystActiveClass)){this.catalystActiveClass=h.catalystActiveClass;}if(f.isNumeric(h.hideDelay)){this.hideDelay=h.hideDelay>0?h.hideDelay:0;}if(f.isNumeric(h.fadeEffectDuration)||h.fadeEffectDuration===false){this.fadeEffectDuration=h.fadeEffectDuration;}this.isMouseBoundaryDetectionEnabled=!(h.mouseBoundaryDetectionEnabled===false);this.isManualShowEnabled=(h.manualShowEnabled===true);}},_buildStructure:function(){var i=f.proxy(function(j){var k=this.namespace.css;if(typeof j==="string"){k+="-"+j.replace(/\s+/,"-");}return k;},this);var h=f("<div/>").addClass(i()).hide();if(this.customClassName){h.addClass(this.customClassName);}var g=f("<div/>").addClass(i("content")).appendTo(h);h.appendTo(document.body);f.extend(this.elements,{root:h,content:g});},_defineAnchorPointStrategies:function(){if(!this.anchorPointStrategies){this.anchorPointStrategies={"below":f.proxy(function(){var g=this._getCatalystPosition();return{"top":parseInt(this.positionOffset.y+g.y+g.h,10)+"px","bottom":"auto"};},this),"left":f.proxy(function(){var g=this._getCatalystPosition();return{"left":parseInt(this.positionOffset.x+g.x,10)+"px","right":"auto"};},this),"right":f.proxy(function(){var g=this._getCatalystPosition();return{"right":parseInt(f(window).width()-((0-this.positionOffset.x)+g.x+g.w),10)+"px","left":"auto"};},this)};}},_fireCustomEvent:function(g){this.catalyst.trigger(this._getEventName(g),this);},_getCatalystPosition:function(){var g=this.catalyst;var h=g.offset();return{x:Math.round(h.left),y:Math.round(h.top),w:Math.round(g.outerWidth(false)),h:Math.round(g.outerHeight(false))};},_getEventName:function(g){return(typeof g==="string"||f.isArray(g))?g+"."+this.namespace.event:null;},_getEventNames:function(g){if(g){if(typeof g==="string"){g=[g];}f.each(g,f.proxy(function(i,h){g[i]=this._getEventName(h);},this));}return(g&&g.length)?g:null;},_getPositionByAnchorPoint:function(){var h=this.anchorPoint.split(" ");if(h.length!==2){this._throwError("anchor point is invalid");}var g={};f.each(h,f.proxy(function(i,j){f.extend(g,this.anchorPointStrategies[j]());},this));if(f.isEmptyObject(g)){this._throwError("could not determine dropdown position from anchor point");}return g;},_getUniqueId:function(){if(!f.isNumeric(this.uniqueId)){this.uniqueId=parseInt(Math.random().toString().replace(".",""),10);}return this.uniqueId;},_initialize:function(g){var h=this._getUniqueId();this.namespace.event+=h;this._applyConfiguration(g);this._buildStructure();f(this.catalyst).add(this.elements.root).data("module-dropdown-id",h);this._initializeCatalyst();this._initializeMouseBoundaryDetection();this._defineAnchorPointStrategies();f(window).on(this._getEventName("resize"),f.proxy(function(){if(this.isVisible()){this._fireCustomEvent("hideAfterResize");this.hide();}},this));f(document.body).on(this._getEventName("click"),f.proxy(function(j){var i=f(j.target);if(this.isVisible()&&!(i.closest(this.catalyst).length||i.closest("."+this.namespace.css).length)){this.hide();}},this));this._fireCustomEvent("initialize");},_initializeCatalyst:function(){if(!this.isManualShowEnabled&&!this.isMouseDelayedShowEnabled){this.catalyst.on(this._getEventName("click"),f.proxy(function(g){if(g){g.preventDefault();}this._toggle();},this));}},_initializeMouseBoundaryDetection:function(){if(this.isMouseBoundaryDetectionEnabled){this.elements.root.on(this._getEventName("mouseenter"),f.proxy(function(){this._setMouseCursorInsideDropdown(true);},this)).on(this._getEventName("mouseleave"),f.proxy(function(){this._setMouseCursorInsideDropdown(false);if(!this.hideTimer&&this.isVisible()){this.hideTimer=setTimeout(f.proxy(function(){if(!this.isMouseCursorInsideDropdown){this.hide();}this.cancelHide();},this),this.hideDelay);}},this));}},_setMouseCursorInsideDropdown:function(g){if(g){this.isMouseCursorInsideDropdown=true;this._fireCustomEvent("mouseEnterDropdown");}else{this.isMouseCursorInsideDropdown=false;this._fireCustomEvent("mouseLeaveDropdown");}},_setPosition:function(){this.elements.root.css(this._getPositionByAnchorPoint());this._fireCustomEvent("position");},_throwError:function(g){console.log("Fitbit Dropdown Widget : "+(g||"unknown error"));},_toggle:function(){if(this.isVisible()){this.hide();return false;}else{this.show();return true;}}};if(c){return b;}else{e.modules.dropdown=b;return e;}});}());
(function(){var a=window.define||function(b){return b();};a(function(f){var j=(typeof f==="function");var q=document.getElementById("requirejs");if(j){var c=f("jquery");var n=f("fitbit-widget-dropdown");f("fitbit-header-notificationDropdown");}else{var c=window.jQuery;var n=c.isFunction(fitbit.modules.dropdown)&&fitbit.modules.dropdown;}if(j&&!q){var p=f("galileo/util/date").getRelativeDate;var t=f("messages-deviceNames");var m=f("messages-batteryLevels");var l="???";var i=function(v,u){return(t[v]&&t[v][u])?t[v][u]:l;};var e=function(u){return m[u]?m[u]:l;};}else{var p=fitbit.util.getRelativeDate;var s="com.fitbit.app.device.message.";var i=function(v,u){return fitbit.i18n.getResource(s+"device_"+u+"_"+v);};var e=function(u){return fitbit.i18n.getResource(s+"battery_"+u);};}var b=function(){var u=window.mixpanel;return u.master?u.master:window.mixpanel;};var o=c(".wrapper-header").first();if(o.data("fitbitHeaderInitialized")){return;}o.data("fitbitHeaderInitialized",true);var g=o.find(".wrapper-nav");var d=o.hasClass("nav-app");var r="active";var h="subnav";if(d){h+=" subnav-app";}g.on("click",".nav > li",function(v){if(c(v.currentTarget).hasClass("nav-products")){v.preventDefault();}else{var u=c(this).find("a").first().attr("href");if(u){v.preventDefault();location.href=u;}}});k();c(function(){var w=c(".wrapper-system-alerts");if(w.length){var A=".system-alert";var u=w.find(A);u.find(".exit").one("click",function(){var G=c(this).closest(A);var D={alertType:G.data("type"),deviceType:G.data("device")};var E=G.data("cw-program");if(E!=null){D.attributes={CORPORATE_PROGRAM_ID:E};}var F=JSON.stringify(D);var C={request:JSON.stringify({template:"user/dash/alertResponse.json.jsp",serviceCalls:[{name:"alert",method:"processAlert",args:{action:"CLOSE",alert:F}}]})};c.ajax({type:"post",url:"/ajaxapi",data:C,dataType:"json"});G.trigger("destroy.systemAlert");var H=(u.length>1)?"fadeOut":"slideUp";G[H](function(){var I=G.next(A);if(I.length){I.fadeIn(function(){G.remove();v(I);I.trigger("impression.systemAlert");});}else{w.slideUp(function(){w.remove();setTimeout(function(){c("body").trigger("resetGlobalTimeSelector");},0);});}});});if(u.is(".newDashInvite")){b().track("Dash: Preview Promo");}var v=function(E){if(!E){return;}var C=E.first().data("cookie");if(C&&!(/^\s*$/).test(C)){var D=new Date();D.setTime(D.getTime()+2629743830);document.cookie="system_alert"+"="+C+"; expires="+D.toGMTString()+"; path=/;";}};var z=u.first();v(z);var B=function(D){if(typeof D!=="string"){return;}var C=["_trackEvent","GlobalAlertProductReview-"+D];if(arguments.length>1){C=C.concat(Array.prototype.slice.call(arguments,1));}try{fitbit.util.deferredTrack(C);}catch(E){if(console){console.log("header.js: 'fitbit.util.deferredTrack' is not available");}}};u.filter(".amazon-review").one("impression.systemAlert",function(){B(c(this).data("device"),"Display","Show");}).one("click",".message a",function(C){B(c(C.delegateTarget).data("device"),"Click","LinkToAmazon");}).one("destroy.systemAlert",function(C){B(c(C.target).data("device"),"Click","CloseForever");});if(z.hasClass("amazon-review")){z.trigger("impression.systemAlert");}}if(n){var y=g.find(".hasdropdown");y.each(function(H,D){var E=c(D);var G=null;var F=null;var J=null;var L=false;function C(){if(J){clearTimeout(J);J=null;}if(F){clearTimeout(F);F=null;}}function K(){L=false;C();if(G&&G.isVisible()){F=setTimeout(function(){if(!G.isMouseCursorInsideDropdown&&!L){G.hide();E.removeClass(r);}C();},200);}}function I(){L=true;C();if(G){G.cancelHide();if(!G.isVisible()){J=setTimeout(function(){G.show();C();},350);}}}E.one("mouseover",function(){G=new n(E,{className:h,catalystActiveClass:r,hideDelay:200,manualShowEnabled:true});G.render(E.find(".subnav-content").first());I();}).on("mouseenter",I).on("mouseleave",K);});}var x=o.find(".nav-item-cart");if(x.length){c(document.body).on("hideCartIcon.siteHeader",function(){x.hide();}).on("showCartIcon.siteHeader",function(){x.show();});}});function k(){var v=o.find(".account > .nav-item-settings");if(v.length&&n){var x=".accountSettingsDropdown";var u=function(A){var z,y;return function(){if(z){return y;}z=true;y=A.apply(this,arguments);A=null;return y;};};var w=function(y,A){var B,z=u(A);B=setTimeout(z,300);b().track("Dash: Profile Menu Clicked",{"!CLICKED":y.data("mp-type")},function(){clearTimeout(B);z();});};v.one("mouseover"+x+" mousedown"+x,function(y){v.off(x).addClass("hasdropdown");c.post("/ajaxapi",{request:JSON.stringify({serviceCalls:[{name:"trackerSettings",method:"getAlarms"},{name:"device",method:"getOwnerDevices"}],template:"common/defaultResponse.json.jsp"})},function(A){var B=A[0];var C=A[1];var z=[];if(C.length){c.each(C,function(E,H){z.push(c("<li>").addClass("device-divider").append(c("<div>").addClass("hr")));var G=c("<li>").addClass("device").addClass("device-"+H.productName.toLowerCase());var F=c("<a>").addClass("gotoSettings").appendTo(G);H.settingsUrl&&F.attr("href",H.settingsUrl);F.append(c("<div>").addClass("icon"));var D=c("<div>").addClass("info").append(c("<span>").addClass("type").text(i(H.type,"displayName")),c("<br>"),c("<span>").addClass("sync deviceDetail").data("time",H.lastSyncTime).text(H.lastSyncTime>0?p(H.lastSyncTime):"")).appendTo(F);var I;c.each(B,function(J,K){if(K.trackerId===H.id&&K.enabled&&K.nextAlarmTimeUTC){if(!I){I=K;}else{if(K.nextAlarmTimeUTC<I.nextAlarmTimeUTC){I=K;}}}});if(I){D.append(c("<br>"),c("<span>").addClass("alarm deviceDetail").text(I.nextAlarmLocalDay+" "+I.localTime));F.attr("href","/settings/alarms/");}D.append(c("<div>").addClass("battery").addClass(H.battery?H.battery.toLowerCase():"").attr("title",H.battery?e(H.battery.toLowerCase()):""));z.push(G);});}z.push(c("<li>").addClass("divider"));c.each(z.reverse(),function(){c("#header-settings-subnav").prepend(this);});},"json");}).one("click",function(z){z.preventDefault();var y=new n(v,{anchorPoint:"below right",className:h+" subnav-settings",catalystActiveClass:r,mouseBoundaryDetectionEnabled:false});var A=c("#header-settings-subnav");y.render(A);y.subscribe("beforeShow",function(){var B=function(C){C!=null&&(location.href=C);};A.find(".device .sync").each(function(D,E){var C=parseInt(c(E).attr("data-time"));if(C>0){c(E).text(p(C));}});A.find("[data-mp-type]:not(.link-dashboard)").on("click",function(D){D.preventDefault();var C=c(this);w(C,B.bind(null,C.attr("href")));});});y.subscribe("beforeShow",function(){var C=function(D){D!=null&&c.get("/userSettings/dh/save?apiFormat=json&settings['show%20galileo%20dashboard']="+D,function(){window.location="/";});};var B=y.getRootElement();c(B).find(".link-dashboard").on("click",function(E){E.preventDefault();var D=c(this);w(D,C.bind(null,D.data("setting")));});},true);y.show();b().track("Dash: View Profile Menu");});}}});}());
