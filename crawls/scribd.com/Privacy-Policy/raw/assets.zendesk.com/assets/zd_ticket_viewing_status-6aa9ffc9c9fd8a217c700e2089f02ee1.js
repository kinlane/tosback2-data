window.Zendesk.NS("Ticket.ViewingStatus",window.jQuery,window.Zendesk,window.currentUser,function($,Zendesk,currentUser){var accountID="",ticketNiceID="",otherViewers=[],banner=null,originalViewTime=new Date(),ticketLastUpdated=null,pollPeriods=[15*1000,30*1000,45*1000,60*1000],pollPeriodIndex=0,ignoreViewing=false,ignoreUpdates=false,toIgnore=null,idleTimeout=14*60*1000,idle=false,stopped=false,quietMode=false,ticketViewingStatusURL;function active(){return !idle&&!stopped}function pollPeriod(){return pollPeriods[pollPeriodIndex]}function pollSlower(){pollPeriodIndex=Math.min(pollPeriodIndex+1,pollPeriods.length-1)}function pollFaster(){pollPeriodIndex=0}function showBanner(message,type,showReload){banner.setContent(message).addClass(type);if(showReload){banner.reload().show()}else{banner.reload().hide()}if(banner.hidden()){banner.appear()}}function hideBannerCallback(){banner.removeClass("normal urgent");if(toIgnore==="Viewing"){ignoreViewing=true}else{if(toIgnore==="Updates"){ignoreUpdates=true}}}function hideBanner(){if(banner.visible()){banner.disappear(hideBannerCallback)}else{hideBannerCallback()}}function showOrHideBanner(){if(ticketLastUpdated&&ticketLastUpdated>originalViewTime&&!ignoreUpdates){toIgnore="Updates";showBanner(I18n.t("txt.ticket.collision.updated"),"urgent",true)}else{if(otherViewers.length>=3&&!ignoreViewing){toIgnore="Viewing";showBanner(this.otherViewers.slice(0,2).join(", ")+", and "+(this.otherViewers.length-2)+(this.otherViewers.length>3?" others":" other")+" are also viewing this ticket.","normal")}else{if(otherViewers.length===2&&!ignoreViewing){toIgnore="Viewing";showBanner(otherViewers.join(" and ")+" are also viewing this ticket.","normal")}else{if(otherViewers.length===1&&!ignoreViewing){toIgnore="Viewing";showBanner(I18n.t("txt.ticket.collision.other_viewers.one",{person:otherViewers[0]}),"normal")}else{toIgnore=null;hideBanner()}}}}}function viewStatusChanged(json){var changed=false;if(json&&json.others_viewing){changed=changed||!arrayEquals(otherViewers,json.others_viewing);otherViewers=json.others_viewing}if(json&&json.updated_at){var updatedAt=new Date(json.updated_at);changed=changed||!dateEquals(ticketLastUpdated,updatedAt);ticketLastUpdated=updatedAt}return changed}function doPoll(){var ajaxData={};if(!quietMode){ajaxData._method="PUT"}if(active()){$.ajax({url:ticketViewingStatusURL,dataType:"json",type:(quietMode?"GET":"POST"),data:ajaxData,success:function(data,textStatus,XMLHttpRequest){if(active()){if(viewStatusChanged(data)){showOrHideBanner();pollFaster()}else{pollSlower()}setTimeout(doPoll,pollPeriod())}},error:function(XMLHttpRequest,textStatus,errorThrown){}})}}function prepareIdleTimeouts(){$(document).bind("idle.idleTimer",function(){idle=true});$(document).bind("active.idleTimer",function(){idle=false;doPoll()});$.idleTimer(idleTimeout)}function stopPollingOnFormSubmission(){$("form").submit(function(){stopped=true;return true})}function setQuietMode(){quietMode=currentUser&&currentUser.quietMode}function setTicketViewingStatusURL(){ticketViewingStatusURL="/api/v1/tickets/"+ticketNiceID+"/viewing_status"}function loadTicketData(){var data=$("#ticket_viewing_status_data").html();if(data&&data.length>0){data=JSON.parse(data);accountID=data.accountID;ticketNiceID=data.ticketID;otherViewers=data.otherViewers||[];return(accountID&&ticketNiceID)}else{return false}}this.init=function(){if(loadTicketData()){banner=Zendesk.Banner.create();prepareIdleTimeouts();stopPollingOnFormSubmission();setQuietMode();setTicketViewingStatusURL();showOrHideBanner();setTimeout(doPoll,pollPeriod())}};$(function(){Zendesk.Ticket.ViewingStatus.init()})});