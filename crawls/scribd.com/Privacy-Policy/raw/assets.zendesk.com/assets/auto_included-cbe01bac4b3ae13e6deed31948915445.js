$z.defModule("access/index",{initialize:function(){$j("#password_help").data("originalURL",$j("#password_help").attr("href"));this.addEmailToPasswordHelpLink();$j("#user_email").change(function(){$z("access/index").addEmailToPasswordHelpLink()})},addEmailToPasswordHelpLink:function(){var passwordHelpLink=$j("#password_help");var email=$j("#user_email").val();var originalURL=$j("#password_help").data("originalURL");if($j.trim(email)===""){passwordHelpLink.attr("href",originalURL)}else{email=encodeURIComponent(email);passwordHelpLink.attr("href",originalURL+"?email="+email)}}});$z.defModule("account/business_hours_definitions/show",{initialize:function(){if($j("form#business_hours_form").attr("data-has-business-hours")==="false"){$j("#business_hours_definition_is_active_false").click();$j("form#business_hours_form :input").prop("disabled",true);$j("#sub_setting_is_active").show()}}});$z.defModule("account/dropboxes/edit",{initialize:function(){var $form=$j("#dropbox_form"),$upgradeField=$form.find(".upgrade_field"),$upgradeLink=$form.find("a.upgrade"),$currentVersion=$form.find(".current_version");$upgradeLink.click(function(){if(!confirm("Upgrade this Feedback Tab?")){return false}$j.ajax({url:$upgradeLink.attr("href"),type:"POST",dataType:"JSON",data:{_method:"PUT"}}).done(function(json){showFlash("Upgraded","notice");$currentVersion.html(json.version);$upgradeField.removeClass("upgradeable").addClass("not_upgradeable")}).fail(function(response){var json=JSON.parse(response.responseText);json.error&&showFlash(json.error,"error")});return false})}});$z.defModule("account/dropboxes/version1",{initialize:function(){this._hostName=$j("#zenboxForm").attr("data-zd-host-name");if(!this._hostName){console.warn("No host name found. Is there a #zenboxForm[data-zd-host-name] element?")}$j("#zenboxForm input").change(this.update.bind(this));Zenbox.init(this._settings());this.update({init:true})},update:function(options){var settings=this._settings();this._applySettingsToDropbox(settings);this._writeTemplate(settings,options)},_settings:function(){return{url:this._hostName,tab_id:this._tabID(),tab_color:$j.trim($j("#zenbox_color").val()),title:$j.trim($j("#zenbox_title").val()).replace(/"/g,"'"),text:this._applyHTMLLineBreaks(($j("#zenbox_text").val())).replace(/"/g,"'"),tag:$j("#zenbox_tag").val()}},_applySettingsToDropbox:function(settings){var tab=$j("#zenbox_tab");tab.css("backgroundColor",settings.tab_color);tab.css("borderColor",settings.tab_color);$j("#overlay_zenbox_title").html(settings.title);$j("#overlay_zenbox_text").html(settings.text);$j("#zenbox_tab").css("backgroundImage","url(http://assets.zendesk.com/external/zenbox/images/tab_"+settings.tab_id+".png)")},_writeTemplate:function(settings,options){var output=$j("#zenbox_output");output.val($j.mustache(this._template,settings));if(options&&!options.init){output.effect&&output.effect("highlight",{},2000)}},_template:'<script type="text/javascript" src="//assets.zendesk.com/external/zenbox/overlay.js"><\/script>\n<style type="text/css" media="screen, projection">\n  @import url(//assets.zendesk.com/external/zenbox/overlay.css);\n</style>\n<script type="text/javascript">\n  if (typeof(Zenbox) !== "undefined") {\n    Zenbox.init({\n      url:       "{{ url }}",\n      tab_id:    "{{ tab_id }}",\n      tab_color: "{{ tab_color }}",\n      title:     "{{ title }}",\n      text:      "{{ text }}",\n      tag:       "{{ tag }}"\n    });\n  }\n<\/script>\n',_applyHTMLLineBreaks:function(t){return $j.trim(t).replace(/\r\n|\n/g,"<br/>")},_tabID:function(){return $j('input:checked[type="radio"][name="zenbox_tab_id"]').val()}});$z.defModule("account/monitored_twitter_handles/index",{initialize:function(){var addMonitorLink=$j("p.add_monitor_handle a#add-twitter");if(arguments[0]==true){addMonitorLink.click(function(){$j("div.help-bubble").slideDown("200")})}else{addMonitorLink.click(this.addTwitterMonitorHandle())}MTH.initialize()},addTwitterMonitorHandle:function(){$j.colorbox({href:"/account/monitored_twitter_handles/new"})}});var MTH={initialize:function(){$j("input.handle_master").each(function(index,checkbox){$j(checkbox).click(MTH.setPrimary)})},setPrimary:function(event){var checkbox=$j(event.target);var id=checkbox.attr("id").split("_").last();var checked=checkbox.attr("checked");if(checked){MTH.uncheckSiblings(checkbox)}MTH.togglePrimaryFlag(id,checked);MTH.requestUpdate(id,checked)},showSpinner:function(id){$j("#spinner-"+id).show()},hideSpinner:function(id){$j("#spinner-"+id).hide()},uncheckSiblings:function(checkbox){$j("input.handle_master").prop("checked",false);checkbox.attr("checked",true)},togglePrimaryFlag:function(id,checked){$j(".primary-selector").hide();if(checked){$j("#primary-selector-"+id).show()}},requestUpdate:function(id,checked){MTH.showSpinner(id);$j.ajax({type:"PUT",url:"/account/channels/"+id,data:{handle:{master:checked}},success:function(){MTH.hideSpinner(id)}})}};$z.defModule("archived_tickets/index",{initialize:function(){this.updateUI();$j("select#filter_by").change(this.updateUI)},updateUI:function(){["requester","organization"].each(function(item){if(item==$j("select#filter_by").val()){$j("#"+item).show()}else{$j("#"+item).hide()}})}});$z.defModule("categories/form",{initialize:function(){$j("#category_name").focus()}});$z.defModule("categories/show",{initialize:function(){$z("forums/index").initialize()}});$j(document).ready(function(){$j("#chat_availability").click(function(event){event.preventDefault();window.open("/chat","chatWindow","toolbar=0, menubar=0, width=620, height=594, location=0, status=0, directories=0")})});Zendesk.NS("CMS");Zendesk.CMS.Bootstrap=function(){if((typeof(currentAccount)=="undefined")||!currentAccount.hasFeature("ahab")){return}$j("[data-placeholder-id]").each(function(idx,element){var element=$j(element);if(!element.data("ahab")){var inputField=(element.find("textarea")||element.find("input[type=text]"));var target=element.find(".placeholder-info")||$j("<div></div>").insertAfter(inputField);var ahabWidget=target.ahab(inputField);element.data("ahab",ahabWidget)}})};Zendesk.CMS.Ahab=function(linkElement,targetInput){this.targetInput=targetInput;this.linkElement=linkElement;this.list=null};Zendesk.CMS.Ahab.prototype={show:function(){if((typeof(this.list)=="undefined")||(this.list==null)){this._prepare()}var self=this;$j(this.list).iosMenu({title:"Insert Placeholder",slideDuration:50,click:function(iosMenu,listItem){var placeholderData=listItem.data("value");if(placeholderData){$j(self.targetInput).insertAtCaret("{{"+placeholderData+"}}");iosMenu.toggle()}},backTextFunction:function(submenu){return $j(submenu).parent().find("> a").html()}});return this},_prepare:function(){var list=this._render(Zendesk.CMS.texts);var container=$j(this.linkElement).html(list);this.list=container.find("ul.root")},_render:function(root){var listRoot=$j('<ul class="menu root" style="display: none;">');var rendered=_.reduce(this._renderLevel(root),function(m,n){return m.append(n)},listRoot);return rendered},_renderLevel:function(listItems){var self=this;var subItemNames=_.without(_.keys(listItems),"id","title");var sortedSubItems=_.sortBy(subItemNames,function(e){return e});var items=_.map(sortedSubItems,function(subItemName){return self._renderItem(subItemName,listItems[subItemName])});return items},_renderItem:function(name,element){var subItem=$j("<li></li>");subItem.append(name);var subLevelItems=this._renderLevel(element);if(_.any(subLevelItems)){subLevel=_.reduce(subLevelItems,function(m,n){return m.append(n)},$j('<ul class="sd"></ul>'));subItem.append(subLevel).addClass("sub")}else{subItem.addClass("link")}subItem.data("full-title",element.title);subItem.data("value",element.id);return subItem},_calculateTitles:_.memoize(function(){return _.map($j("li.ui-menu-item.link"),function(e){return $j(e).data("full-title")})}),_searchResultRenderer:function(result){var query=$j("input.ios-menu-search-field").val();var parts=result.toLowerCase().split(query.toLowerCase());var annotatedResult=_.reduce(parts,function(memo,substr){return memo+"<strong>"+query+"</strong>"+substr});return"<li><a>"+annotatedResult+"</a></li>"}};jQuery.fn.extend({ahab:function(inputField){return new Zendesk.CMS.Ahab(this,inputField).show()}});$j("#cms_variant_is_fallback").change(function(){if($j("#cms_variant_is_fallback").attr("checked")=="checked"){$j("#cms_variant_active_true").attr("checked",true);$j("#cms_variant_active_false").attr("disabled",true)}else{$j("#cms_variant_active_false").attr("disabled",false)}});$j("#get_more_macros").click(function(){$j("#get_more_macros").hide();$j(".macros_reference").fadeIn()});$j("#get_more_triggers").click(function(){$j("#get_more_triggers").hide();$j(".triggers_reference").fadeIn()});$j("#get_more_automations").click(function(){$j("#get_more_automations").hide();$j(".automations_reference").fadeIn()});$j("#cms_texts_filter_form").change(function(){$j(this).closest("form").submit()});Zendesk.NS("CRM");Zendesk.CRM.Application=function(renderer){this.renderer=renderer;this.initialDelay=5000;this.backoff=0};Zendesk.CRM.Application.prototype={renderData:function(records,status){if(status){this.renderer.render(records,status)}else{this.renderer.render(records,"ok")}},fetchAndRenderData:function(url){this.url=url;this._setupPoller();this.renderer.renderWaiting();this.poller.start()},_setupPoller:function(){var self=this;this.poller=new Zendesk.CRM.Poller(function(poller){self._pollerCallback(self,poller)},{initialDelay:this.initialDelay,backoff:this.backoff})},_pollerCallback:function(self,poller){$j.ajax({type:"get",url:this.url,success:function(response){if(response.status==="ok"){self.poller.stop();self.renderData(response.records)}else{if(response.status=="errored"){self.poller.stop();self.renderData(response.records,response.status)}else{self.poller.resume()}}},error:function(){self.poller.stop();self.renderData([],"errored")}})}};Zendesk.NS("CRM");Zendesk.CRM.Poller=function(callback,options){this.initialDelay=options.initialDelay||10000;this.backoff=options.backoff||5000;this.waitForCallback=options.waitForCallback||false;this.callback=callback;this.state="stopped";this.currentDelay=this.initialDelay;this.waitDelay=options.waitDelay||2000;this.debug=!!options.debug;this.trace=""};Zendesk.CRM.Poller.prototype={start:function(){this.state="polling";this._schedulePoll(this.initialDelay);this._trace("[started]")},stop:function(){this.state="stopped"},reset:function(){this.state="resetting"},pause:function(){this.state="paused";this._trace("[paused]")},resume:function(){if(this.state=="paused"){this._trace("[resuming]");this.state="resuming"}},_schedulePoll:function(after){var self=this;setTimeout(function(){self._pollerCallback()},after)},_pollerCallback:function(){if(this.state=="polling"){this.currentDelay=this.currentDelay+this.backoff;var delay=this.currentDelay;if(this.waitForCallback){this._trace("[pausing]");this.pause();delay=this.waitDelay}this._trace("[callback]");this.callback(this);this._schedulePoll(delay)}else{if(this.state=="resetting"){this.state="polling";this.currentDelay=this.initialDelay;this._schedulePoll(this.initialDelay)}else{if(this.state=="paused"){this._trace(".");this._schedulePoll(this.waitDelay)}else{if(this.state=="resuming"){this._trace("[resumed]");this.state="polling";this._schedulePoll(this.currentDelay)}}}}},_trace:function(msg){if(this.debug){this.trace=this.trace+msg}}};Zendesk.NS("CRM");Zendesk.CRM.ProfileRenderer=function(){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading")};Zendesk.CRM.ProfileRenderer.prototype={renderWaiting:function(){this.loading.show()},render:function(records,status){if(status=="ok"){this._renderSuccess(records)}else{if(status=="pending"){this.renderWaiting()}else{this._renderError()}}},_renderSuccess:function(records){var self=this;_(records).each(function(record){record.fields=self._splitFields(record.fields)});var html=$j.mustache(this.success_template,{records:records});this.element.html(html);this.loading.hide()},_renderError:function(){this.element.html(this.error_template);this.loading.hide()},_splitFields:function(fields){var arr=[];var record1,record2;for(var i=0;i<fields.length;i++){record1=fields[i];if(fields[i+1]){record2=fields[i+1];i=i+1}else{record2={label:"&nbsp;",value:"&nbsp;",empty:true}}arr.push({record1:record1,record2:record2})}return arr}};Zendesk.NS("CRM");Zendesk.CRM.SidebarRenderer=function(profile_url){this.element=$j("#crm_user_data");this.success_template=$j("#crm_template").html();this.error_template=$j("#crm_error_template").html();this.loading=$j("#crm_loading");this.profile_url=profile_url;this.fieldsToShow=10};Zendesk.CRM.SidebarRenderer.prototype={renderWaiting:function(){this.loading.show()},render:function(records,status){if(status=="ok"){this._renderSuccess(records)}else{if(status=="pending"){this.renderWaiting()}else{this._renderError()}}},_renderSuccess:function(records){if(records.length>0){var mainRecord=this._addMoreLink(records[0]);var self=this;var subRecords=_(records.slice(1)).map(function(record){return self._addMoreLink(record)});var showMore=subRecords.length}else{var mainRecord=null;var subRecords=null;var showMore=null}var html=$j.mustache(this.success_template,{mainRecord:mainRecord,subRecords:subRecords,showMore:showMore});this.element.html(html);this.loading.hide();var self=this;$j(".crm-records-toggle",self.element).click(function(event){$j("#crm-sub-records",self.element).slideToggle(function(){$j(".crm-records-toggle",self.element).toggle()});event.stopPropagation();event.preventDefault()})},_addMoreLink:function(record){if(record.fields&&record.fields.length>this.fieldsToShow){record.fields=record.fields.slice(0,this.fieldsToShow);record.moreLink=this.profile_url}return record},_renderError:function(){this.element.html(this.error_template);this.loading.hide()}};$z.defModule("entries/_forums2_show",{initialize:function(params){var self=this;self.zd_label_answered=$j("div.frame > div.entry span.zd_label.answered");$j("div#history.frame > div.item").each(function(index,element){var post_id=$j(element).attr("data-post_id");if(params["is_moderator?"]===true){$j(element).find("div.user_formatted span.label_theanswer").click(self.set_the_answer_toggle_option(post_id))}});$j("a[property='is_locked']").click(function(event){$j("div.commenting-controls div.control").toggle()})},set_the_answer_toggle_option:function(post_id){var self=this;return(function(event){var answer_span=$j(this);answer_span.toggleClass("answered").addClass("ajax");var set_answer_label=self.set_answered_label(answer_span.hasClass("answered"));$j.post(answer_span.attr("data-update_answer_path"),{is_answer:answer_span.hasClass("answered")},function(){$j.ajax({url:answer_span.attr("data-is_answered_path"),dataType:"json",type:"GET",success:set_answer_label,complete:function(){answer_span.removeClass("ajax")}})})})},set_answered_label:function(is_answered){var self=this;if(is_answered===true){self.zd_label_answered.addClass("selected")}else{return function(msg){self.zd_label_answered.toggleClass("selected",msg)}}this.zd_label_answered.toggleClass("selected",is_answered)},set_moderator_toggle_option_for:function(property,on){$(property+"_option").children[0].className=(on?"selected":"deselected");$(property+"_option").children[0].className=(on?"deselected":"selected")},set_moderator_idea_label:function(flag){$("flag_option").children[0].className=(flag==1?"selected":"deselected");$("flag_option").children[1].className=(flag==200?"selected":"deselected");$("flag_option").children[2].className=(flag==201?"selected":"deselected")}});$z.defModule("entries/_sidebar_moderator",{initialize:function(params){var self=this;self.moderatorBox=$j("#moderator_box");self.actionDiv=$j("#contentcolumn > div.content > div.action");self.adminLabels=$j("#moderator_box > p.labels");self.zdLabels=$j("div.entry");self.setModeratorToggleOptionFor();self.renderModeratorIdeaLabelFor()},setModeratorToggleOptionFor:function(){var self=this;self.moderatorBox.find("ul.actions > li > a.mod_option").click(self.selectToggle())},renderModeratorIdeaLabelFor:function(){var self=this;self.moderatorBox.find("p.labels > a").click(self.selectToggle())},selectToggle:function(){var self=this;var ajaxOptions={url:$j(this).attr("data-deselected_entry_path"),data:{authenticity_token:Zendesk.currentUser.authenticityToken},dataType:"json",type:"put"};var successFunc=function(state,property){return function(){self.updatePage(state,property)}};return function(event){if($j(this).hasClass("selected")){$j(this).removeClass("selected");ajaxOptions.success=successFunc("deselected",$j(this).attr("property"));ajaxOptions.url=$j(this).attr("data-deselected_entry_path")}else{$j(this).addClass("selected");ajaxOptions.success=successFunc("selected",$j(this).attr("property"));ajaxOptions.url=$j(this).attr("data-selected_entry_path")}$j.ajax(ajaxOptions)}},updatePage:function(state,property){var self=this;switch(property){case"planned":if(state==="selected"){self.adminLabels.find("a.topic_label_done").removeClass("selected");self.adminLabels.find("a.topic_label_not_planned").removeClass("selected");self.zdLabels.find("span.done").removeClass("selected");self.zdLabels.find("span.not_planned").removeClass("selected");self.zdLabels.find("span.planned").addClass("selected")}else{self.adminLabels.find("a.topic_label_planned").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected")}break;case"done":if(state==="selected"){self.adminLabels.find("a.topic_label_planned").removeClass("selected");self.adminLabels.find("a.topic_label_not_planned").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected");self.zdLabels.find("span.not_planned").removeClass("selected");self.zdLabels.find("span.done").addClass("selected")}else{self.adminLabels.find("a.topic_label_done").removeClass("selected");self.adminLabels.find("span.done").removeClass("done");self.zdLabels.find("span.done").removeClass("selected")}break;case"not_planned":if(state==="selected"){self.adminLabels.find("a.topic_label_planned").removeClass("selected");self.adminLabels.find("a.topic_label_done").removeClass("selected");self.zdLabels.find("span.planned").removeClass("selected");self.zdLabels.find("span.done").removeClass("selected");self.zdLabels.find("span.not_planned").addClass("selected")}else{self.adminLabels.find("a.topic_label_not_planned").removeClass("selected");self.adminLabels.find("span.not_planned").removeClass("done");self.zdLabels.find("span.not_planned").removeClass("selected")}break;case"answered":if(state==="selected"){self.zdLabels.find("span.answered").addClass("selected")}else{self.zdLabels.find("span.answered").removeClass("selected")}break}}});$z.defModule("entries/edit",{initialize:function(params){$("entry_title").focus();$j("form#entryform").submit(function(){if(typeof(entryTagField)!="undefined"){entryTagField.beforeFormSubmit()}if(typeof(entryPhrasesField)!="undefined"){entryPhrasesField.beforeFormSubmit()}})},applyTagsToField:function(field,id,tags,allow_spaces,undefined){var self=this;if(self.fields===undefined){self.fields={}}if(self.fields[field]!==undefined){}else{self.fields[field]=null}$j(function(){function valueTest(value,event){if(allow_spaces==true){return event.keyCode==188||event.keyCode==13}else{return true}}self.fields[field]=new Autocompleter.MultiValue(id,Autocompleter.cachedLookupTag,tags,{frequency:0.3,minChars:2,acceptNewValues:true,newValueChecker:valueTest})})}});$z.defModule("entries",{});$z.defModule("entries/index",{initialize:function(){}});$z.defModule("entries/show",{initialize:function(params){if(typeof(currentUser)!=="undefined"){$j("input[name='authenticity_token']").each(function(){$j(this).attr("value",currentUser.authenticityToken)})}$z("forums/index").initialize()},showFormFor:function(postId){$j("#view-post-"+postId).hide();$j("#edit-post-"+postId).show();tinyMCE.execCommand("mceAddControl",false,"post-edit-field-"+postId);InputTracking.fixSubmit($("post-edit-form-"+postId),"onsubmit");$j("#edit-link-for-"+postId).removeAttr("onclick");$j("#edit-link-for-"+postId).click(function(){$j("#view-post-"+postId).hide();$j("#edit-post-"+postId).show();return false})},hideFormFor:function(postId){$j("#edit-post-"+postId).hide();$j("#view-post-"+postId).show();InputTracking.trackedElements=[]}});Zendesk.NS("Facebook.integration",function($j){function available_pages(current,limit){var colorbox=$j("#to_colorbox");if(colorbox.length==0){return}data=colorbox.html();colorbox.html("");$j.colorbox({html:data,onComplete:function(){var existingPages=$j("#active_facebook_pages .facebook-page").length;var totalPages=$j(".add_page").length;$j("#available_facebook_pages").parent().addClass("colorbox-facebook");$j("#available_facebook_pages").parent().css({height:"100%"});$j(".setting").click(function(){if($j(this).hasClass("selected")){$j(this).removeClass("selected")}else{$j(this).addClass("selected")}});$j(".add_page").click(function(){var pageId=this.id.split("-")[1];$j("#pageframe-"+pageId).fadeOut();current++;var page_div=get_page_div(current,limit);var settings=get_settings(pageId);$j.colorbox.resize();$j.post("/facebook/pages/select",{id:pageId,settings:settings},function(data){$j("#fbpages").show();page_div.html(page_div.html()+data);style_facebook_pages(limit);if(current-existingPages==totalPages){$j.colorbox.close()}})})},onClosed:function(){$j.get("/facebook/pages/close_pages",function(data){});window.location.replace("/facebook/settings#general_settings")}})}$j(function(){var pages=$j("#facebook-page-limit-notify");var box=$j("#to_colorbox").html();if(pages.length>0){available_pages(pages.find("#current").html(),pages.find("#limit").html())}else{if(box!=null){available_pages(0,0)}}});function get_settings(page_id){var settings=$j("#settings_"+page_id);pages=settings.find("#enable_wall_posts").hasClass("selected");messages=settings.find("#enable_messages").hasClass("selected");activity=settings.find("#import_acstivity").hasClass("selected");return[pages,messages,activity]}function get_page_div(current,limit){if(current<=limit){$j("#facebook-page-limit-notify").html(I18n.t("txt.facebook_integration.views.colorbox.pages_added",{active_pages:current,page_limit:limit}))}var div="#active_facebook_pages";if(current>limit){div="#inactive_facebook_pages";$j(div).show()}return $j(div)}function style_facebook_pages(limit){var facebook_pages=$j(".facebook_page");$j("#no_pages").hide();facebook_pages.removeClass("nobottom");$j(facebook_pages[limit-1]).addClass("nobottom");$j(facebook_pages[facebook_pages.length-1]).addClass("nobottom")}var master_selector=$j("#comment_is_public");master_selector.change(function(){if(master_selector.is(":checked")===true){$j("#facebook-controls").show()}else{$j("#facebook-controls").hide()}})},jQuery);$z.defModule("feeds/index",{initialize:function(){},renderLatestComment:function(nice_id){$j.ajax({url:"/tickets/"+nice_id+"/events?for=feed&filter=latest",dataType:"html",context:$j("#"+nice_id+"-reply"),success:function(transport){$j("#"+nice_id+"-ticket-form").hide();$j("#ticket-form").appendTo($j("#ticket-form-home"));this.replaceWith(transport)}})},renderRemainingComments:function(nice_id){this.remoteCall("/tickets/"+nice_id+"/events?for=feed&filter=remaining","li#"+nice_id+"-all")},renderCommentBody:function(comment_id){this.remoteCall("/events/"+comment_id+"?for=feed","span#"+comment_id+"-comment-body")},remoteCall:function(url,context){$j.ajax({url:url,dataType:"html",context:$j(context),success:function(transport){this.replaceWith(transport)}})},renderTicketForm:function(nice_id,status_id,priority_id,group_id,assignee_id){$j(".fake-text-area").show();$j("#show-ticket-properties").show();$j("#ticket-properties").hide();$j("#ticket-status-new").prop("disabled",status_id!="0");$j("#"+nice_id+"-fake-reply").hide();$j("#ticket-form").appendTo($j("#"+nice_id+"-ticket-form"));$j("#ticket_status_id").val(status_id);$j("#ticket_priority_id").val(priority_id);$j("#ticket_group_id").val(group_id);$j("#ticket_assignee_id").val("");$j("#comment_value").val("");$j("#comment_is_public").prop("checked",false);updateProperties(assignee_id);$j("#"+nice_id+"-ticket-form").show();$j("#ticket-form").show();$j("#comment_value").focus()}});(function($){function showBounds(bounds){var div=$("<div/>").css({position:"absolute",left:bounds.left+"px",top:bounds.top+"px",width:(bounds.right-bounds.left)+"px",height:(bounds.bottom-bounds.top)+"px",outline:"red 1px solid"});$("body").append(div);window.setTimeout(function(){div.remove()},1000)}$.fn.bounds=function(withPadding,withMargin){withPadding=withPadding||withMargin;var bounds={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:function(){return this.right-this.left},height:function(){return this.bottom-this.top},show:function(){showBounds(this);return this},toString:function(){return JSON.stringify(this)}};this.each(function(i,el){var elQ=$(el),off=elQ.offset();if(withPadding){off.right=off.left+$(elQ).outerWidth(withMargin);off.bottom=off.top+$(elQ).outerHeight(withMargin)}else{off.right=off.left+$(elQ).width();off.bottom=off.top+$(elQ).height()}if(off.left<bounds.left){bounds.left=off.left}if(off.top<bounds.top){bounds.top=off.top}if(off.right>bounds.right){bounds.right=off.right}if(off.bottom>bounds.bottom){bounds.bottom=off.bottom}});return bounds}})($j);(function($){$.fn.filterOrFind=function(selector){var $this=$(this);return $this.find(selector).add($this.filter(selector))}})($j);(function(){var forumsSearch=Zendesk.NS("Forums.Search");$z.defModule("forums/_search",{initialize:function(params){params=params||{};params.forumsSearch=true;forumsSearch.Instant.setup(params);forumsSearch.Autocomplete.setup(params)}})})();$z.defModule("forums/form",{initialize:function(params){$j("input#forum_visibility_restriction_id_1, input#forum_visibility_restriction_id_2").click(function(){$j("#forum_is_locked_false").prop("disabled",false);$j(".forum-language-selector").show("slow")});$j("input#forum_visibility_restriction_id_3").click(function(){$j("#forum_is_locked_false").prop("disabled",true);$j("#forum_is_locked_true").prop("checked",true);$j(".forum-language-selector").hide();$j("#forum_translation_locale_id").val("")});$j("form.edit_forum").submit(function(){if(typeof(forumTagField)!="undefined"){forumTagField.beforeFormSubmit()}})}});(function(){function setNav(active){if(active!="stats"){$j(".sparkline").removeClass("active")}$j(".forum-nav a.active").removeClass("active");if(active){$j("#forum_nav_"+active).addClass("active")}else{$j(".forum-nav a:first").addClass("active")}}function setUpCategoryHeaders(){if($j(".category-header").attr("id")){$j(".category-header").map(function(x,el){categoryTopRightEdit($j(el).attr("id"));makeCategorizedForumsDraggable($j(el).parent().find(".category").attr("id"))});$j(".buttons-right .reorder").show();addCategoryReordering();categoryDescription();$j(".category-header").show()}else{return false}}function fetchContent(section){$j(".buttons-right .reorder").hide();$j("#detailed_stats_graph_container").hide();$j("#content_entries .frame:first").html('<div id="topic_search_loading" class="loading"></div>');$j.ajax({url:$j("#forum_nav_"+section).attr("url"),data:{xhr:true}}).done(function(body){$j("#content_entries .frame:first").html(body);$j("#search-result").paginateResults();$j(".forum_tabs").trigger("events-loaded.entries.zendesk");if(section=="overview"){setUpCategoryHeaders()}});setNav(section)}function showCommentSection(){$j("#comments_section").show();setNav("comments")}var forum_module={initialize:function(params){params=params||{};params.scopeSammyTo=params.scopeSammyTo||".forum_tabs";$j(".category li span").truncateViaFade();this.sammy_app=$j.sammy(params.scopeSammyTo,function(){this.get("#stats/:statName",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();var statName=this.params.statName;Zendesk.Stats.ForumUI.showDetailGraph(".sparkline#"+statName);setNav("stats")});this.get("#stats",function(){$j(".buttons-right .reorder").hide();$j("#comments_section").hide();Zendesk.Stats.ForumUI.showDetailGraph(".sparkline:first");setNav("stats")});this.get("#overview",function(){fetchContent("overview")});this.get("#recent",function(){fetchContent("recent")});this.get("#popular",function(){fetchContent("popular")});this.get("#unanswered",function(){fetchContent("unanswered")});this.get("#answered",function(){fetchContent("answered")});this.get("#planned",function(){fetchContent("planned")});this.get("#not_planned",function(){fetchContent("not_planned")});this.get("#done",function(){fetchContent("done")});this.get("#comments",function(){showCommentSection()});this.get("",function(){$j("#detailed_stats_graph_container").hide();var firstTab=$j(".forum-nav a:first").attr("href");if(firstTab){if(firstTab=="#comments"){showCommentSection();return false}setNav(firstTab.replace("#",""));setUpCategoryHeaders();$j(".forum_tabs").trigger("events-loaded.entries.zendesk")}})});Zendesk.Stats.ForumUI.setup(this.sammy_app);this.sammy_app.disable_push_state=true;this.sammy_app.run()}};$z.defModule("forums/index",forum_module);$z.defModule("forums/show",forum_module);$z.defModule("forums/forums1_index",forum_module);$z.defModule("forums/forums2_index",forum_module)}());function InvitationForm(container){this.container=$j(container);this.emails=[];this.fieldColor=this.field().css("color");this.fieldText=this.field().val();this.resetField();this.registerEvents();this.invite()}InvitationForm.prototype={container:null,emails:null,fieldText:null,fieldColor:null,registerEvents:function(){var self=this;self.form().submit(function(){$j.ajax({data:$j(this).serialize(),type:$j(this).attr("method"),url:$j(this).attr("action"),beforeSend:function(request){self.inviting()},success:function(response){self.add(response);self.invited()},error:function(request,textStatus,errorThrown){self.error().html(request.responseText);self.error().show();self.enableButton()}});return false});self.link().click(function(){self.invite();return false});self.field().click(function(){if(self.field().val()===self.fieldText){self.field().css("color",self.fieldColor);self.field().val("")}});self.field().blur(function(){if($j.trim(self.field().val()).length===0){self.resetField()}})},add:function(addresses){var self=this;$j.each(addresses.split(", "),function(index,email){if(!self.emails.include(email)){self.emails.push(email)}})},present:function(){return this.emails.join(", ")},invite:function(){this.enableButton();this.form().show();this.link().hide();this.notice().hide();this.error().hide()},inviting:function(){this.button().val("Sending invitation...");this.button().prop("disabled",true)},invited:function(){this._trackInvitation(this.emails);this.notice().html("You have invited "+this.present()+" to your help desk.");this.form().hide();this.resetField();this.link().show();this.notice().show();this.error().hide()},enableButton:function(){this.button().val("Invite!");this.button().prop("disabled",false)},resetField:function(){this.field().val(this.fieldText);this.field().css("color","gray")},form:function(){return this.container.find("form")},link:function(){return this.container.find("a")},notice:function(){return this.container.find("div#notice")},error:function(){return this.container.find("div#error")},field:function(){return this.container.find("textarea#email")},button:function(){return this.container.find("input[type='submit']")},_trackInvitation:function(emails){var form=this.form();_(emails).each(function(emailAddress){form.trackEvent()})}};Zendesk.NS("GettingStartedLocalized",function($j){var instrumentationModule="Admin GS Localized";function trackEvents(){$j("#getting_started_localized").attr("data-tracking-module",instrumentationModule);trackEvent("Load")}function trackEvent(action){Zendesk.Instrumentation.ToTango.track(action,instrumentationModule)}function setupFeedbackTab(){var contact_us=$j("#contact_us");if(!contact_us.exists()){return}Zenbox.init({dropboxID:contact_us.data("feedback-tab-id"),url:"https://support.zendesk.com",tabID:"support",tabColor:"black",tabPosition:"Left",hide_tab:true});contact_us.find("a").click(function(){Zenbox.show();trackEvent("Contact us link")})}$j(document).ready(function(){if(!$j("#getting_started_localized").exists()){return}trackEvents();setupFeedbackTab()})},this.jQuery);function PhotoForm(){this.container=$j("#customize_photo");this.registerEvents();if(this.image().attr("src")===this.defaultImage){this.showForm()}else{this.showLinks()}this.error().hide()}PhotoForm.prototype={defaultImage:"/images/frame_user.png",container:null,registerEvents:function(){var self=this;self.field().change(function(){if($j.trim(self.field().val()).length!==0){self.processing(I18n.t("txt.admin.public.javascript.views.getting_started.uploading_image"));self.form().submit()}return false});self.frame().load(function(){var content=$j("#upload_frame").contents().find("body").text();if($j.trim(content).length!==0){try{var photo=$j.parseJSON(content);self.setPhoto(photo.public_filename,photo.id);self.form().trackEvent();self.error().hide()}catch(e){self.error().html(I18n.t("txt.admin.public.javascript.views.getting_started.error_while_uploading_image"));self.error().show()}self.showLinks()}});self.changeLink().click(function(){self.showForm();return false});self.deleteLink().click(function(){if(!self.photoId()){self.error().html(I18n.t("txt.admin.public.javascript.views.getting_started.sorry_gravatars_cannot_be_deleted"));self.error().show();return false}$j.ajax({type:"delete",url:"/photos/"+self.photoId()+"?format=js",beforeSend:function(request){self.processing(I18n.t("txt.admin.public.javascript.views.getting_started.deleting_image"))},success:function(response){self.setPhoto(self.defaultImage,"");self.showForm();self.error().hide()},error:function(request,textStatus,errorThrown){self.error().html("There was an error deleting the image. Please try again or contact our support team.");self.error().show();self.showLinks()}});return false})},showForm:function(){this.processingIndicator().hide();this.form().show();this.modifyLinks().hide()},processing:function(message){this.processingMessage().html(message);this.processingIndicator().show();this.form().hide();this.modifyLinks().hide()},showLinks:function(){this.field().val("");this.processingIndicator().hide();this.form().hide();this.modifyLinks().show()},photoId:function(){return this.image().attr("data-id")},setPhoto:function(path,id){this.image().attr("data-id",id);this.image().attr("src",path)},processingIndicator:function(){return this.container.find("div#processing_indicator")},processingMessage:function(){return this.container.find("span#processing_message")},modifyLinks:function(){return this.container.find("div#modify_photo")},changeLink:function(){return this.container.find("a#change_photo")},deleteLink:function(){return this.container.find("a#delete_photo")},error:function(){return this.container.find("div#error")},frame:function(){return this.container.find("#upload_frame")},image:function(){return this.container.find("img#user_photo")},field:function(){return this.container.find("input[type='file']")},form:function(){return this.container.find("form")}};Zendesk.NS("GettingStarted",function($j){var inviteBlock=$j("#invite_block");var testBlock=$j("#test_block");var customizeBlock=$j("#customize_block");var blocks=$j(".block");var timeoutId=null;var instrumentationModule="Admin GS";function openBlock(block){block.removeClass("closed").removeClass("shrunk").addClass("opened");blocks.not(block).addClass("closed").addClass("shrunk").removeClass("opened")}function blockDone(block){block.addClass("done")}function closeBlocks(){blocks.addClass("closed").removeClass("shrunk").removeClass("opened")}function blockButtons(){$j(".opened .block_button").live("click",function(){blockDone($j(this).closest(".block"));closeBlocks();saveBlocks()});$j(".closed .block_button, .shrunk .block_button").live("click",function(){openBlock($j(this).closest(".block"));saveBlocks()});$j(".block_button").mouseover(function(){$j(this).closest(".block").addClass("highlighted")}).mouseout(function(){$j(this).closest(".block").removeClass("highlighted")});$j(".close_block_link").click(function(){closeBlocks();saveBlocks();return false})}function invitationForm(){inviteBlock.find("form").submit(function(){var button=$j(this).find("input[type='submit']");var field=$j(this).find("input[type='text']");var result=$j("#invitation_result");$j.each(field.val().split(/[\s,;]+/),function(index,email){trackEvent("Invite agent")});$j.ajax({data:$j(this).serialize(),type:$j(this).attr("method"),url:$j(this).attr("action"),beforeSend:function(request){button.prop("disabled",true).val("Inviting...")},success:function(response){result.html("Invite sent successfully!");field.val("")},error:function(request,textStatus,errorThrown){result.html(request.responseText)},complete:function(){button.prop("disabled",false).val("Invite!")}});return false})}function testTicketButton(){testBlock.find("form").submit(function(){var button=$j(this).find("input[type='submit']");var result=$j("#test_ticket_result");$j.ajax({data:$j(this).serialize(),type:$j(this).attr("method"),url:$j(this).attr("action"),beforeSend:function(request){button.prop("disabled",true).val("Sending Test Email...")},success:function(response){button.hide();result.html("Test ticket was sent successfully.")},error:function(request,textStatus,errorThrown){button.prop("disabled",false).val("Error. Try again...")}});return false})}function testMacroButton(){$j("#test_macro_form").submit(function(){var button=$j(this).find("input[type='submit']");$j.ajax({data:$j(this).serialize(),type:$j(this).attr("method"),url:$j(this).attr("action"),beforeSend:function(request){button.prop("disabled",true).val("Creating ticket and macro...")},success:function(response){button.val("Ticket and macro created")},error:function(request,textStatus,errorThrown){button.prop("disabled",false).val("Error. Try again...")}});return false})}function continueSetup(){$j(".setup_item.closed").mouseover(function(){$j(this).addClass("highlighted")}).mouseout(function(){$j(this).removeClass("highlighted")});$j(".setup_item.closed").click(function(){$j(this).removeClass("closed").addClass("opened");$j(this).find(".setup_item_content").slideDown()});$j(".setup_item .close_setup_item").click(function(){$j(this).siblings(".setup_item_content").hide();$j(this).closest(".setup_item").removeClass("opened").addClass("closed");return false});$j("#macros_setup").trigger("click")}function showMeHowLinks(){$j(".show_unsolved_tickets").click(function(){return showMeHow("tab_views",null,"tickets_arrow")});$j(".show_forums").click(function(){return showMeHow("tab_forums",null,"forums_arrow")});$j(".show_customization").click(function(){return showMeHow("tab_settings","settings_account","customization_arrow")});$j(".show_people_agents").click(function(){return showMeHow("tab_manage","manage_people","people_agents_arrow")});$j(".show_people_groups").click(function(){return showMeHow("tab_manage","manage_people","people_groups_arrow")});$j(".show_ticket_fields").click(function(){return showMeHow("tab_manage","ticket_fields","ticket_fields_arrow")});$j(".show_triggers").click(function(){return showMeHow("tab_manage","triggers","triggers_arrow")});$j(".show_macros").click(function(){return showMeHow("tab_manage","macros","macros_arrow")});$j(".show_automations").click(function(){return showMeHow("tab_manage","automations","automations_arrow")})}function showMeHow(mainMenu,subMenu,arrow){$j("li.tab_manage, li.tab_settings").removeClass("over");$j(".show_me_arrow").hide();clearTimeout(timeoutId);$j("html,body").animate({scrollTop:0},"slow");mainMenu=$j("li."+mainMenu);arrow=$j("#"+arrow);var offset="0 2";if(subMenu){subMenu=$j("li[data-menu-item-name="+subMenu+"]");mainMenu.addClass("over");offset="-192 -33"}arrow.show();arrow.position({my:"top",at:"bottom",of:subMenu||mainMenu,offset:offset});timeoutId=setTimeout(function(){arrow.hide();mainMenu.removeClass("over")},5000);return false}function trackEvents(){$j("#getting_started_revamp").attr("data-tracking-module",instrumentationModule);$j(".block_button").click(function(){var block=$j(this).closest(".block");var activity=block.attr("data-tracking-activity");if(block.hasClass("opened")){trackEvent(activity+": Done")}else{if(block.hasClass("done")){trackEvent(activity+": Revisit")}else{trackEvent(activity+": Start")}}});trackEvent("Load")}function trackEvent(action){Zendesk.Instrumentation.ToTango.track(action,instrumentationModule)}function saveBlocks(){blocks.each(function(){Zendesk.SettingsCookie.set(blockCookieId($j(this)),$j(this).attr("class"))})}function restoreBlocks(){blocks.each(function(){var block=$j(this);var cookie=Zendesk.SettingsCookie.get(blockCookieId(block));if(cookie&&cookie.include("done")){blockDone(block)}if(cookie&&cookie.include("opened")){openBlock(block)}})}function blockCookieId(block){return"_zendesk_getting_started_"+block.prop("id")}$j(document).ready(function(){if(!$j("#getting_started_revamp").exists()){return}blockButtons();invitationForm();testTicketButton();continueSetup();testMacroButton();showMeHowLinks();restoreBlocks();trackEvents()})},this.jQuery);$z.defModule("getting_started/show",{initialize:function(params){if(!$j("#getting_started").exists()){return}this.setInstrumentationModule();new InvitationForm("div#invite_agents");new InvitationForm("div#invite_testers");new SignatureForm();new PhotoForm();this.attachModalVideo();this.trackPageView();$j("#getting_started .adventure_set a, #getting_started .getting-started-steps a").instrumentTracking()},attachModalVideo:function(){$j(".aside_fixed a").instrumentTracking().click(function(event){event.preventDefault();$j.colorbox({inline:true,href:"#modal_content"})})},setInstrumentationModule:function(){var module;if(currentUser.isAdmin){module="Admin Getting Started"}else{module="Agent Getting Started"}$j("#getting_started").attr("data-tracking-module",module);this.instrumentationModule=module},trackPageView:function(){Zendesk.Instrumentation.ToTango.track("Load",this.instrumentationModule)}});function SignatureForm(){this.container=$j("#customize_signature");this.registerEvents();this.send()}SignatureForm.prototype={container:null,registerEvents:function(){var self=this;self.form().submit(function(){$j.ajax({data:$j(this).serialize()+"&id="+Zendesk.currentUser.id+"&authenticity_token="+encodeURIComponent(Zendesk.currentUser.authenticityToken),type:"PUT",url:$j(this).attr("action")+"?format=js",beforeSend:function(request){self.sending()},success:function(response){var signature=$j.parseJSON(response);self.text().html(signature.value);self.sent();self.form().trackEvent()},error:function(request,textStatus,errorThrown){self.error().html(request.responseText);self.error().show();self.enableButton()}});return false});self.link().click(function(){self.send();return false})},send:function(){this.enableButton();this.form().show();this.link().hide();this.notice().hide();this.error().hide()},sending:function(){this.button().val(I18n.t("txt.admin.public.javascript.views.getting_started.saving_signature"));this.button().prop("disabled",true)},sent:function(){this.notice().html(I18n.t("txt.admin.public.javascript.views.getting_started.signature_updated"));this.form().hide();this.link().show();this.notice().show();this.error().hide()},enableButton:function(){this.button().val(I18n.t("txt.admin.public.javascript.views.getting_started.save_signature"));this.button().prop("disabled",false)},form:function(){return this.container.find("form")},link:function(){return this.container.find("a")},notice:function(){return this.container.find("div#notice")},error:function(){return this.container.find("div#error")},text:function(){return this.form().find("textarea")},button:function(){return this.form().find("input[type='submit']")}};var HeaderRenderer={};HeaderRenderer.hasRenderedTopRight=false;HeaderRenderer.renderTopRight=function(){var topRight=$j("#top-right");if(!topRight||HeaderRenderer.hasRenderedTopRight){return}HeaderRenderer.hasRenderedTopRight=true;var menuItems=[];if(!currentUser.isAnonymous){var name=currentUser.first_name;if(currentAccount.isSandbox){name=name+" (SANDBOX)"}if(currentUser.isAgent||currentAccount.showUserProfile){menuItems.push($j("<a />",{id:"top-right-name",href:"/users/"+currentUser.id,html:name}))}else{menuItems.push($j("<span/>",{id:"top-right-name",html:name}));if(currentAccount.showChangePassword){menuItems.push($j("<a/>",{href:"/password",text:I18n.t("txt.layout.change_pwd")}))}}}if(currentUser.showCookieLink){var cookieLink=$j("<a />",{href:"/cookie_policy",text:I18n.t("txt.layout.cookie_policy")});cookieLink.colorbox();menuItems.push(cookieLink)}if((currentUser.isAdmin||(currentAccount.isLotusVisibleToAgents&&currentUser.isAgent))&&currentAccount.hasFeature("lotus")){menuItems.push('<a href="/agent">'+I18n.t("txt.views.shared.header.try_the_new_zendesk")+"</a>")}if(Zendesk.viewedOnMobileDevice&&currentAccount.hasFeature("mobileV2")){var returnToUrl=document.location.href;menuItems.push('<a href="/mobile/switch?return_to='+escape(returnToUrl)+'">'+I18n.t("txt.views.shared.header.go_to_mobile_site")+"</a>")}if(currentUser.isAgent&&currentAccount.lastTrialDay){menuItems.push(I18n.t("txt.admin.public.javascript.header_renderer.days_left_in_trial_label_with_params",{count:currentAccount.daysLeftInTrial}));jQuery("#expires_badge .count").text(currentAccount.daysLeftInTrial)}if(currentUser.isAdmin){menuItems.push('<a href="http://support.zendesk.com">'+I18n.t("txt.admin.public.javascript.header_renderer.help")+"</a>")}if(currentUser.assumed){menuItems.push('<a href="/users/revert">'+I18n.t("txt.javascript.views.agent_console.revert_identity")+"</a>")}if(currentUser.isAnonymous){menuItems.push($j("<a/>",{href:"/login",text:I18n.t("txt.layout.login")}));if(currentAccount.isOpen&&!currentAccount.hasRemoteAuthentication){menuItems.push($j("<a/>",{href:"/registration",text:I18n.t("txt.layout.signup")}))}}else{var logoutUrl=currentAccount.secureUrlPrefix+"/access/logout";if(currentAccount.urlPrefix!=currentAccount.secureUrlPrefix){logoutUrl=logoutUrl+"?return_to="+escape(currentAccount.urlPrefix+"/access/logout")}menuItems.push($j("<a/>",{href:logoutUrl,text:I18n.t("txt.layout.logout")}))}if(menuItems.length>0){topRight.append(menuItems.shift());menuItems.each(function(item){topRight.append(" | ");topRight.append(item)})}};HeaderRenderer.hasUpdatedTabs=false;HeaderRenderer.updateTabs=function(){var topMenu=$j("#top-menu > ul#green").first();if(!topMenu||HeaderRenderer.hasUpdatedTabs){return}HeaderRenderer.hasUpdatedTabs=true;if(currentUser.isAnonymous){if(!currentAccount.isOpen){topMenu.find("> li:not(.right, .tab_home)").remove()}else{if(!currentAccount.hasRemoteAuthentication&&!currentUser.hasEmail){topMenu.find("> li.tab_new a").attr("href","/anonymous_requests/new")}}}if(currentUser.accessibleForums){var forumsTab=$j('<li class="main tab_forums"/>');forumsTab.append($j("<a/>",{"class":"tab",href:"/forums",text:currentAccount.forumsTitle}));topMenu.find("> li.tab_home").after(forumsTab)}if(currentUser.isEndUser){if(currentUser.canViewOrganization){var previousTab=topMenu.find("> li:not(.right)").last();var organizationTab=$j('<li class="main tab_organization"/>');organizationTab.append($j("<a/>",{"class":"tab",href:"/organization_requests",text:currentUser.organization.name.truncate(35)}));previousTab.after(organizationTab)}}topMenu.find("> li.first").removeClass("first");topMenu.find("> li.active").removeClass("active");topMenu.find("> li").first().addClass("first");topMenu.find("> li").addClass("main");var activeTab=topMenu.find("> li.tab_"+Zendesk.tab);activeTab.removeClass("main").addClass("active");activeTab.next().addClass("first")};if(typeof(currentUser)!=="undefined"){HeaderRenderer.renderTopRight();HeaderRenderer.updateTabs()}(function(){var forumsSearch=Zendesk.NS("Forums.Search");$z.defModule("home/_home_page_search_box",{initialize:function(params){params=params||{};params.homePageSearch=true;forumsSearch.Autocomplete.setup(params)}})})();$z.defModule("home/index",{initialize:function(){if(currentUser.isAgent){$j("#dashboard").ready(function(){$j("#dashboard").show();$j.get("/home/dashboard",function(data){$j("#dashboard").html(data).show()})})}if(currentUser.isAdmin){new IntroductoryTextForm()}if(currentUser.managePinnedOrder){$z("home/reorder_pinned_entries").initialize()}$z("forums/index").initialize()}});(function(window,$){var IntroductoryTextForm=window.IntroductoryTextForm=function(){this.form=$("#introductory_text .introductory_text_form");this.display=$("#introductory_text .introductory_display_texts");this.editLink=this.display.find(".edit_this");this.cancelLink=this.form.find(".cancel_link");this.setup()};IntroductoryTextForm.prototype={setup:function(){var scope=this;this.form.hide();this.editLink.click(function(){scope.display.hide();scope.form.show()});this.cancelLink.click(function(){scope.form.hide();scope.display.show()})}}}(window,$j));(function($,_){var pinnedEntriesReorderingTemplate,$showLink,$thingsToHideWhileReordering,$widgetContainer,$pinnedEntriesReorderer,$spinner;function onSaveSuccess(){document.location.href="/home"}function onSaveError(){alert("Sorry, there was an error saving your changes.")}function saveOrder(){var $this=$(this);var idsAsQuery=$pinnedEntriesReorderer.find("ol").sortable("serialize",{key:"ids[]"});if(idsAsQuery=="ids[]="){idsAsQuery=""}else{idsAsQuery=idsAsQuery+"&"}$.ajax({url:$this.attr("action"),type:$this.attr("method"),data:idsAsQuery+$this.serialize(),success:onSaveSuccess,error:onSaveError});return false}function hidePinnedEntriesReorderer(){$widgetContainer.hide();$thingsToHideWhileReordering.show();$pinnedEntriesReorderer.remove();$pinnedEntriesReorderer=null}function addReorderingBehavior(){$pinnedEntriesReorderer.find("a.cancel").click(function(){hidePinnedEntriesReorderer();return false}).end().find("form").submit(saveOrder);var lists=$pinnedEntriesReorderer.find("ul,ol");lists.each(function(){$(this).sortableWithEmptyTarget({emptyTargetText:I18n.t("txt.admin.views.home._reorder_pinned_entries.drag_topics_here_label"),emptyTargetClass:"item sortable",axis:"y",placeholder:"sortable item target",connectWith:lists.not(this)})})}function hasPinnedIndex(entry){return !!entry.pinned_index}function renderPinnedEntriesReorderer(){if($pinnedEntriesReorderer){return}$.getJSON($showLink.attr("href"),null,function(pinnedEntries){pinnedEntries=_(pinnedEntries);$pinnedEntriesReorderer=$($.mustache(pinnedEntriesReorderingTemplate,{orderedEntries:pinnedEntries.select(hasPinnedIndex),unorderedEntries:pinnedEntries.reject(hasPinnedIndex)})).appendTo($widgetContainer);$spinner.hide();addReorderingBehavior()})}function showPinnedEntriesReorderer(){$thingsToHideWhileReordering.hide();$widgetContainer.show();renderPinnedEntriesReorderer()}function initialize(){pinnedEntriesReorderingTemplate=$("#reorder_pinned_entries_template").html();$widgetContainer=$('<div class="frame"></div>').hide().insertAfter($("#pinned_topics_title"));$spinner=$('<div class="loading">&nbsp;</div>').appendTo($widgetContainer);$showLink=$("#show_pinned_entries_reordering").click(function(){showPinnedEntriesReorderer();return false});$thingsToHideWhileReordering=$("#pinned-entries-frame, #entries_pagination").add($showLink)}$z.defModule("home/reorder_pinned_entries",{initialize:initialize})}(this.jQuery,this._));jQuery(function($){var $searchForm=$(".home #suggest_form");if($searchForm.length===0){return}var $searchResultsContainer=$("#topic_search"),$searchOutput=$("#topic_search_result"),$searchLoader=$("#topic_search_loading"),$moreResults=$("#show_more_results");function onSearchResults(content){$searchLoader.removeClass("loading");$searchResultsContainer.show();$searchOutput.html(content);var nextPage=Zendesk.ResultsPaginator.parseNextPageFrom($searchOutput);if(nextPage==null){$moreResults.hide();if($searchOutput.is(":empty")){$searchOutput.html('<h2 class="empty_suggestion_set">'+I18n.t("txt.entries.list.empty")+"</h2>")}}else{$searchOutput.paginateResults()}}function onSearch(event){$searchResultsContainer.hide();$searchLoader.addClass("loading");$searchOutput.html("");$.get("/categories/search_for_home_page_box?"+$searchForm.serialize(),{format:"html",for_search:1,page:1}).done(onSearchResults);return false}$searchForm.submit(onSearch)});if(!this.Zendesk){this.Zendesk={}}(function($,console,Zendesk,_){Zendesk.Banner={containerSelector:"#banners",container:function(){var self=Zendesk.Banner;var container=$(self.containerSelector);if(container.length<=0){console.error("Could not find a banner container. Do you have an "+self.containerSelector+" element?")}else{return self._bindIgnoreEventListenerIfNeeded(container)}},templateSelector:"#banner-item-template",template:function(){var self=Zendesk.Banner;if(!self._template){var templateContainer=$(self.templateSelector).first();if(templateContainer.length<=0){console.error("Could not find a Banner template. Do you have an "+self.templateSelector+" element?")}else{self._template=templateContainer.html()}}return self._template},_ignoreEventListenerBound:false,_bindIgnoreEventListenerIfNeeded:function(container){var self=Zendesk.Banner;if(!self._ignoreEventListenerBound){container.bind("ignore.zd.banner",function(event,banner){banner.disappear();return true});container.bind("reload.zd.banner",function(event,banner){window.location.reload(true);return true});self._ignoreEventListenerBound=true}return container},create:function(options){var self=Zendesk.Banner;var banner=$.extend({},self._buildLI(options||{}),self._enhancements);$(banner).find(".ignore").click(function(){$(banner).trigger("ignore.zd.banner",[banner])});$(banner).find(".reload a").click(function(){$(banner).trigger("reload.zd.banner",[banner]);return false});return banner.appendTo(self.container())},_buildLI:function(options){var li=$($.mustache(Zendesk.Banner.template(),{text:(options.text||"")}));if(!(options.visible)){li.hide()}["icon","ignore","reload"].each(function(property){if(options[property]===false){li.find("."+property).hide()}});return li},_enhancements:{toString:function(){return"<banner text="+this.content().text()+">"},setContent:function(content){this.content().html(content);return this},appear:function(callback){var self=this;self.slideDown(null,function(){self.trigger("appear.zd.banner",[self]);callback&&callback()});return self},disappear:function(callback){var self=this;self.slideUp(null,function(){self.trigger("disappear.zd.banner",[self]);callback&&callback()});return self},visible:function(){return this.filter(":visible").length>0},hidden:function(){return this.filter(":hidden").length>0}}};_(["icon","content","ignore","reload"]).each(function(component){Zendesk.Banner._enhancements[component]=function(){return $(this).find("."+component)}})})(this.jQuery,this.console,this.Zendesk,this._);jQuery(function($){$("#top-menu li.tab_getting_started").each(function(i,li){var $li=$(li);var activity=$li.find("> a").text().strip();if(activity.length>0){$li.attr("data-tracking-activity",activity);$li.find("a").instrumentTracking()}})});$z.defModule("monitor/children/show",{initialize:function(params){$j("#subscription_payment_method_type").change(function(){if($j("#subscription_payment_method_type").val()==0){$j("#manual-discount-options").show()}else{$j("#manual-discount-options").hide()}});$j("#subscription_payment_method_type").change();$j("#account_settings_monitored_facebook_page_limit").change(function(){$j("#fb_page_limit").html($j(this).val())});$j("#get_unadded_numbers").click(function(){var account_id=$j(this).attr("value");$j("#unadded_numbers").html("Loading");$j.get("/monitor/children/find_unadded_numbers",{account_id:account_id},function(data){$j("#unadded_numbers").html(data);$j(".add_phone_number").click(function(){var account_id=$j("#get_unadded_numbers").attr("value");var number=$j(this);var sid=number.attr("sid");var country=$j("input[@name=country"+sid+"]:checked");if(country.length==0){country=$j("input[name$=country"+sid+"]")}$j("#unadded_number_"+sid).html("<td colspan='4'>Loading</td>");$j.post("/monitor/children/add_unadded_number",{account_id:account_id,phone_number:number.attr("number"),sid:sid,country:country[0].value},function(data){$j("#unadded_number_"+sid).html(data)})})})})}});$z.defModule("monitor/coupons/edit",{initialize:function(params){var self=this;self.radioButtons=$j('input[name="coupon[type]"]');self.radioButtons.click(function(){self._showFieldsForSelected(this)});$j(".optional").hide();self._showFieldsForSelected(self.radioButtons)},_showFieldsForSelected:function(radioButtons){$j(radioButtons).filter(":checked").each(function(){$j(".optional").hide();$j('.optional[data-show-if-selected="'+$j(this).attr("id")+'"]').show()})}});$z.defModule("monitor/coupons/index",{initialize:function(params){$j("#coupons tbody tr").hover(function(){$j(".edit a",$j(this)).css("visibility","visible")},function(){$j(".edit a",$j(this)).css("visibility","hidden")})}});$z.defModule("monitor/payments/show",{initialize:function(params){$j("#refund_button").click(function(){$j.colorbox({href:"#refund_form",inline:true});return false})}});Zendesk.NS("Monitor");Zendesk.Monitor.PermissionsPage=function(){this.init()};Zendesk.Monitor.PermissionsPage.prototype={init:function(){var self=this;$j("#permission_email").change(function(){self.loadData(this.value)})},loadData:function(currentElement){$j.ajax({url:"/monitor/permissions/permissions_for?user_id="+currentElement,success:function(data){var table=$j("div.item-info").html("");if(data.length===0){return}var permissions=data;var list=$j("<ul>");_.each(permissions,function(permission){var permissionString=permission.permission_id.replace(/_/g," ");permissionString=permissionString.charAt(0).toUpperCase()+permissionString.slice(1);var permissionResource="permissions/"+permission.id;list.append($j("<li>").append(permissionString).append($j("<a>").attr({rel:"no-follow",href:permissionResource,"data-method":"delete"}).html(" revoke")))});table.html(list)}})}};$z.defModule("monitor/search/index",{initialize:function(){this.checkIndexed();this.captureReindex()},checkIndexed:function(){var self=this;$j(".indexable").each(function(){self.updateIndexed($j(this))})},updateIndexed:function(el){var bits=el.attr("data-indexable").split("-");$j.getJSON("/monitor/search/check_indexed",{id:bits[0],account:bits[1]},function(indexed){el.addClass("indexable indexed").toggleClass("not",!indexed).text(indexed?"indexed":"unindexed")})},captureReindex:function(){var self=this;$j(".reindexable").each(function(){$j(this).bind("submit",function(event){var $target=$j(event.target);var eid=$target.attr("id");var bits=eid.split("-")[1].split("_");var id=bits[0];var type=bits[1];var account=bits[2];$j.post($target.attr("action"),{id:id,type:type,account:account},function(){$j($target.find("button").first()).text("Reindexed");var idAndType=id.split("@").reverse().join("_");self.updateIndexed($j("#check_indexed-"+id+"_"+type+"_"+account))});return false})})}});$z.defModule("people/groups/show",{initialize:function(){$z("people/search/index").initialize()}});$z.defModule("people/organizations/edit",{initialize:function(organizationId){$j("form#account-settings").submit(function(){if(typeof(organizationTagField)!="undefined"){organizationTagField.beforeFormSubmit()}})}});$z.defModule("people/organizations/show",{initialize:function(){$z("people/search/index").initialize()}});Zendesk.NS("People.Passwords",function($j){var sequenceNumber=0;var showPasswordValidations=function(data){var newSequenceNumber=data.sequence;if(sequenceNumber<newSequenceNumber){sequenceNumber=newSequenceNumber;var errors=_(data.errors);var passwordRequirements=$j("#password_requirements ul li");_(passwordRequirements).each(function(e){var element=$j(e);var errorText=$j.trim(element.text());if(errors.contains(errorText)){element.addClass("invalid").removeClass("valid")}else{element.addClass("valid").removeClass("invalid")}})}};$j(document).ready(function(){$j(".validate_password").keyup(function(event){var url=currentAccount.secureUrlPrefix+"/people/password/validate_password";$j.ajax({type:"POST",url:url,data:{password:$j(this).val(),sequence:sequenceNumber+1},success:showPasswordValidations})})})},jQuery);Zendesk.NS("People.Roles",function($j){var ticketAccess=$j("#permission_set_permissions_ticket_access");var forumAccess=$j("#permission_set_permissions_forum_access");var peopleAccess=$j("#permission_set_permissions_end_user_profile");var form=$j("#permission_set_form");var isLightAgent=form.data("light-agent");function setupAssignedTicketsOnlyDependencies(ticketAccess){var ticketAccessMessage=$j("#ticket_access_message");var assignToAnyGroup=$j("#assign_to_any_group");var ticketEditing=$j("#permission_set_permissions_ticket_editing");var ticketEditingLabel=$j("label[for='permission_set_permissions_ticket_editing']");var disableDependency=function(){var tooltip="To deselect this option, you must change ticket access selection";ticketEditing.prop("checked",true).prop("disabled",true).prop("title",tooltip).change();ticketEditingLabel.prop("title",tooltip)};var enableDependency=function(){ticketEditing.prop("disabled",isLightAgent).removeAttr("title");ticketEditingLabel.removeAttr("title")};var showGroupMessage=function(){ticketAccessMessage.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_group")).show()};var showAssignToAnyGroup=function(){assignToAnyGroup.show()};var showOrganizationMessage=function(){ticketAccessMessage.html(I18n.t("txt.admin.javascrips.views.people.roles.user_belongs_organization")).show()};var hideMessage=function(){ticketAccessMessage.hide()};var hideAssignToAnyGroup=function(){assignToAnyGroup.hide()};var interactions={"assigned-only":[hideMessage,hideAssignToAnyGroup,disableDependency],"within-groups":[showGroupMessage,showAssignToAnyGroup,enableDependency],"within-organization":[showOrganizationMessage,hideAssignToAnyGroup,enableDependency],all:[hideMessage,hideAssignToAnyGroup,enableDependency]};if(ticketEditing.exists()){ticketAccess.selectInteraction(interactions)}}function setupForumFullAccessDependencies(forumAccess){var forumRestrictedContent=$j("#permission_set_permissions_forum_access_restricted_content");var forumRestrictedContentLabel=$j("label[for='permission_set_permissions_forum_access_restricted_content']");var lockFullAccess=function(){var tooltip="To deselect this option, you must change forums editing permission";forumRestrictedContent.prop("checked",true).prop("disabled",true).prop("title",tooltip);forumRestrictedContentLabel.prop("title",tooltip)};var unlockFullAccess=function(){forumRestrictedContent.prop("disabled",false).removeAttr("title");forumRestrictedContentLabel.removeAttr("title")};var interactions={full:lockFullAccess,"default-interaction":unlockFullAccess};if(forumRestrictedContent.exists()){forumAccess.selectInteraction(interactions)}}function setupPeopleDependencies(peopleAccess){var peopleDependencies=$j("#people_editing_options");var groupOrgRestriction=$j("#permission_set_permissions_edit_organizations");var showDependency=function(){peopleDependencies.slideDown();groupOrgRestriction.prop("disabled",false)};var hideDependency=function(){peopleDependencies.slideUp();groupOrgRestriction.prop("disabled",true)};var interactions={edit:showDependency,full:showDependency,"default-interaction":hideDependency};$j(peopleAccess).selectInteraction(interactions)}function setupPermissionDependencies(){if(ticketAccess.exists()){setupAssignedTicketsOnlyDependencies(ticketAccess)}if(forumAccess.exists()){setupForumFullAccessDependencies(forumAccess)}if(peopleAccess.exists()){setupPeopleDependencies(peopleAccess)}}function setupLightAgentForm(){var assignToAnyGroupField=$j("[name='permission_set[permissions][assign_tickets_to_any_group]']");form.find(":input").not(":submit, [name='_method']").not(ticketAccess).not(assignToAnyGroupField).prop("disabled",true)}$j(document).ready(function(){setupPermissionDependencies();if(isLightAgent){setupLightAgentForm()}})},this.jQuery);function UserMergeWizard(redirectToWinner){this.redirectToWinner=redirectToWinner;this.registerEvents()}UserMergeWizard.prototype={redirectToWinner:false,lookupUser:function(loser,searchTerm,callback){var url="/people/user_merge/autocomplete";var parameters={name:searchTerm,rand:(new Date()).getTime(),user_id:loser};new Ajax.Request(url,{parameters:parameters,onSuccess:function(response){callback(response.responseJSON)}})},registerEvents:function(){var self=this;$j("#merge_link").live("click",function(){$j.colorbox({href:$j(this).attr("href"),onComplete:function(){var loser=self.winnerForm().attr("data-loser");var cache=new Autocompleter.Cache(self.lookupUser.curry(loser));new Autocompleter.Json("winner","winner_auto_complete",cache.lookup.bind(cache),{frequency:0.1,minChars:3});$j("input[placeholder]").placeholder()}});return false});self.winnerLinks().live("click",function(){$j.colorbox({href:$j(this).attr("href")});return false});self.winnerForm().live("submit",function(){$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(response){$j.colorbox({html:response})},error:function(request,textStatus,errorThrown){$j.colorbox({html:request.responseText})}});return false});if(!self.redirectToWinner){self.confirmForm().live("submit",function(){$j.ajax({data:$j(this).serialize(),type:"POST",url:$j(this).attr("action")+"?format=js",beforeSend:function(request){self.confirmButton().val("Merging users...");self.confirmButton().prop("disabled",true)},success:function(response){$j.colorbox.close()},error:function(request,textStatus,errorThrown){$j.colorbox({html:request.responseText});self.confirmButton().val("Confirm and Merge");self.confirmButton().prop("disabled",false)}});return false})}},winnerForm:function(){return $j("#winner_form")},winnerField:function(){return this.winnerForm().find("input[type='text']")},continueButton:function(){return this.winnerForm().find("input[type='submit']")},winnerLinks:function(){return $j(".winner_selector")},confirmForm:function(){return $j("#confirm_merge_form")},confirmButton:function(){return this.confirmForm().find("input[type='submit']")}};$z.defModule("people/users/edit",{initialize:function(userId){var self=this;this.confirmationMessages={leavingLegacy:I18n.t("txt.admin.public.javascripts.views.people.users_edit.assigning_new_role"),downgradingRole:I18n.t("txt.admin.public.javascripts.views.people.users_edit.downgrading_role")};if($j("#original_roles").exists()){this.setupNonEnterpriseRoles(userId);$j("#user_default_group_id").live("change",function(){var selectedGroupId=$j(this).val();$j("#user_groups_"+selectedGroupId).prop("checked",true)})}else{$j("#user_default_group_id").change(function(){self.enableGroup($j("#group_"+$j(this).val()))});self.enableGroup($j("#group_"+$j("#user_default_group_id").val()))}var roleGroupsForm=$j("#role_and_groups_form");this.formElm=roleGroupsForm.exists()?roleGroupsForm:$j("#user-form");if($j(".role_groups").exists()){$j(".user_type, #user_role_or_permission_set").change($j.proxy(this.manageRoleDisplay,this));this.manageRoleDisplay();$j("#group_tiles .tile").click(function(evt){var clickedGroupElm=$j(evt.target).hasClass("tile")?$j(evt.target):$j(evt.target).parents(".tile");self.selectGroup(clickedGroupElm)});this.formElm.submit($j.proxy(this.confirmSaveForEnterprise,this))}else{this.formElm.submit({userId:userId},$j.proxy(this.confirmSave,this))}$j("form#user-form [type=submit]").bind("click",function(e){if(typeof(userTagField)!="undefined"){userTagField.beforeFormSubmit()}});if($j("#identities").exists()){$j(".email.unverified_email .add_identity, .twitter .add_identity, .google .add_identity, .facebook .add_identity").colorbox({onComplete:function(){$j("#focus").focus()}});this.identitiesManager=new Zendesk.IdentitiesManager(userId,$j.proxy(this.setupPrimary,this));this.renderIdentities(userId);$j("#add_openid").live("click",function(){$j(this).hide();$j("#openid_identity_list").hide();$j("#add_openid_form").show()})}$j("#status_spinner").addClass("spinner small").hide();$j("#test_call_button").click(function(event){event.preventDefault();$j("#test_call_status").removeClass("test_call_error");if($j("#test_call_button").val()===I18n.t("txt.admin.views.people.users.basic_info.test_call")){var number=$j("#user_voice_number").val();$j("#test_call_button").val(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.calling")+"...");$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.dialing",{number:number}));var ext=$j("#user_voice_extension").val();$j("#status_spinner").fadeIn("slow");var call_sid=$j.post("/voice/confirm_numbers/test_call",{number:number,ext:ext},function(sid){return sid});function checkStatus(){var status=$j.get("/voice/confirm_numbers/test_call_status",{call_sid:call_sid.responseText},function(current_status){return current_status});status.always(function(){var state=status.responseText;if(state==="queued"||state==="ringing"||state==="retry"){setTimeout(checkStatus,500)}else{if(state==="in-progress"){$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.forward_success",{number:number}));setTimeout(checkStatus,500)}else{if(state==="completed"){$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.test_success"));$j("#test_call_button").val(I18n.t("txt.admin.views.people.users.basic_info.test_call"));$j("#status_spinner").fadeOut("slow")}else{$j("#test_call_status").html(I18n.t("txt.admin.assets.javascripts.views.people.users.users-edit.test_error",{number:number}));$j("#test_call_status").addClass("test_call_error");$j("#test_call_button").val(I18n.t("txt.admin.views.people.users.basic_info.test_call"));$j("#status_spinner").fadeOut("slow")}}}})}}call_sid.always(function(){setTimeout(checkStatus,1500)})})},setupNonEnterpriseRoles:function(userId){if($j("#user_roles_4").is(":checked")){$j("#agent_groups").html($j("#group-block").html())}if($j("#user_roles_2").is(":checked")){$j("#admin_groups").html($j("#group-block").html())}$j("#user-radio").click(function(){$j("#agent_groups, #admin_groups").empty();$j("#end_user_block").show();$j("#agent_block, #admin_groups").hide();$j("#user_restriction_id_4").click();$j("#display_name").hide()});$j("#user_roles_4").click(function(){$j("#agent_groups").html($j("#group-block").html());$j("#admin_groups").empty();$j("#agent_block").show();$j("#admin_groups, #end_user_block").hide();$j("#user_restriction_id_0").click();$j("#display_name").show()});$j("#user_roles_2").click(function(){$j("#admin_groups").html($j("#group-block").html());$j("#agent_groups").empty();$j("#agent_block, #end_user_block").hide();$j("#admin_groups").show();$j("#display_name").show()})},manageRoleDisplay:function(e){this.roleData=this.roleData||$j.parseJSON($j("#role_data").html());var agentRoleRadioElm=$j("#roles_agent"),agentRoleDetailsElm=$j("#agent_details"),agentRoleDescriptionElm=agentRoleDetailsElm.find(".description"),agentRoleHeadcountElm=agentRoleDetailsElm.find(".headcount"),enduserRoleDetailsElm=$j("#enduser_details"),endUserRestrictionElms=$j('#enduser_details input[name="user[restriction_id]"]'),endUserSelected=$j("#roles_enduser").prop("checked"),selectedPermissionSetElm=$j("#user_role_or_permission_set"),selectedPermissionSet=_(this.roleData).find(function(permission_set){return permission_set.id==selectedPermissionSetElm.val()});selectedPermissionSetElm.prop("disabled",endUserSelected);enduserRoleDetailsElm.toggle(endUserSelected);agentRoleDetailsElm.toggle(!endUserSelected);if(!endUserSelected){endUserRestrictionElms.prop("disabled",true);agentRoleRadioElm.val(selectedPermissionSet.id=="admin"?2:4);agentRoleDescriptionElm.html(selectedPermissionSet.description);agentRoleHeadcountElm.html(selectedPermissionSet.headcount)}else{endUserRestrictionElms.prop("disabled",false)}this.displayGroups(endUserSelected)},displayGroups:function(endUserSelected){$j("#groups_unavailable").toggle(endUserSelected);$j("#groups_available").toggle(!endUserSelected);if(endUserSelected){$j("#group_tiles input").prop("disabled",true)}else{$j("#group_tiles input.empty").prop("disabled",false);_($j("#group_tiles .tile")).each(function(tileElm){tileElm=$j(tileElm);if(tileElm.hasClass("selected")){$j(tileElm.find("input")).prop("disabled",false)}})}},selectGroup:function(selectedGroupElm){if(selectedGroupElm.hasClass("selected")){this.disableGroup(selectedGroupElm)}else{this.enableGroup(selectedGroupElm)}},enableGroup:function(selectedGroupElm){selectedGroupElm.addClass("selected");$j("input",selectedGroupElm).prop("disabled",false)},disableGroup:function(selectedGroupElm){selectedGroupElm.removeClass("selected");$j("input",selectedGroupElm).prop("disabled",true)},confirmSaveForEnterprise:function(e){if(e){e.stopPropagation();e.preventDefault()}var isLegacyAgent=$j("#user_role_or_permission_set option:first-child").val()==="";var legacyAgentNotSelected=$j("#user_role_or_permission_set").val()!=="";var agentRoleSelected=$j("#roles_agent").prop("checked");if(isLegacyAgent&&agentRoleSelected&&legacyAgentNotSelected){if(!confirm(this.confirmationMessages.leavingLegacy)){return false}}else{if(!this.confirmDemotion($j("#roles_enduser").prop("checked"))){return false}}this.formElm.unbind("submit");this.formElm.submit()},confirmSave:function(e){if(e){e.stopPropagation();e.preventDefault()}if(!this.confirmDemotion($j("#user-radio").prop("checked"))){return false}var userType=$j("#user_roles_4").is(":checked")?"Agent":($j("#user_roles_2").is(":checked")?"Admin":"End-User");Zendesk.Instrumentation.ToTango.track(userType,"User - Save");$j("#submit-button").val(e.data.userId?I18n.t("txt.users.edit.updating"):I18n.t("txt.users.edit.creating")).prop("disabled",true);this.formElm.unbind("submit");this.formElm.submit()},confirmDemotion:function(toEndUser){var was_agent=this.formElm.data("is-agent");if(was_agent&&toEndUser){return confirm(this.confirmationMessages.downgradingRole)}else{return true}},renderIdentities:function(userId){var removeLink,identityNameElm,primaryLabelElm,unverifiedLabelElm,primaryIdentity,primaryIdentityElm;var hasPrimaryIdentity=this.identitiesManager.allPrimaryCandidates().length!==0;$j(this.identitiesManager.identities).each($j.proxy(function(i,identity){removeLink=$j("<a>",{href:"javascript: void(0);",html:I18n.t("txt.users.edit.delete_identity")}).click($j.proxy(this.deleteIdentity,this)).data("elmId",identity.elmId).addClass("remove_link");identityNameElm=$j("<span>",{html:identity.name}).addClass("identity_name");primaryLabelElm=$j("<span>",{html:"("+I18n.t("txt.users.edit.primary")+")",style:"display: none"}).addClass("primary_label");unverifiedLabelElm=$j("<span>",{html:"("+I18n.t("txt.users.edit.email_not_verified")+")"}).addClass("status unverified");$j("<li>",{id:identity.elmId}).append(identityNameElm).append(identity.isUnverified()?unverifiedLabelElm:"").append((identity.isPrimaryCandidate()&&!identity.isUnverified())?primaryLabelElm:"").append(removeLink).appendTo($j(identity.listElmId));if(this.identitiesManager.limitToSingleIdentity(identity)){$j("."+identity.identity_type+" .add_identity").hide()}if(!hasPrimaryIdentity&&identity.isExternalIdentity){$j("#"+identity.elmId).find(".remove_link").hide()}},this));primaryIdentity=this.identitiesManager.primary();if(typeof primaryIdentity!=="undefined"){primaryIdentityElm=$j("#"+primaryIdentity.elmId);primaryIdentityElm.find(".primary_label").show();primaryIdentityElm.find(".remove_link").hide()}this.setupPrimary()},setupPrimary:function(){if(this.identitiesManager.allPrimaryCandidates().length<=1){$j("#primary_section").hide();return}else{$j("#primary_section").show()}var selectElm=$j("#primary_identity");this.renderPrimary(this.identitiesManager.primary());selectElm.unbind("change",$j.proxy(this.updatePrimary,this));selectElm.bind("change",$j.proxy(this.updatePrimary,this))},renderPrimary:function(primaryIdentity){var selectElm=$j("#primary_identity");selectElm.html("");selectElm.append($j("<option>",{value:primaryIdentity.elmId,html:primaryIdentity.name+" ("+I18n.t("txt.users.edit.primary")+")"}));_(this.identitiesManager.allPrimaryCandidates()).each(function(identity){if(identity!=primaryIdentity){selectElm.append($j("<option>",{value:identity.elmId,html:identity.name}))}})},updatePrimary:function(e){if(e){e.stopPropagation();e.preventDefault()}if(this.identitiesManager.allPrimaryCandidates().length<=1){$j("#primary_section").hide();return}var selectElm=$j("#primary_identity");var selectedIdentity=this.identitiesManager.find(selectElm.val());var spinner=$j("<div>").addClass("spinner small").insertAfter(selectElm);this.identitiesManager.makePrimary(selectedIdentity).done(function(){spinner.remove()}).fail(function(){spinner.remove()}).done($j.proxy(function(){this.renderPrimary(selectedIdentity);$j(".remove_link").show();$j("#"+selectedIdentity.elmId).find(".remove_link").hide();$j(".primary_label").hide();$j("#"+selectedIdentity.elmId).find(".primary_label").show();clearFlash()},this)).fail($j.proxy(function(response){this.setupPrimary();showFlash(response,"error")},this))},deleteIdentity:function(e){if(e){e.stopPropagation();e.preventDefault()}var targetElm=$j(e.target);var identity=this.identitiesManager.find(targetElm.data("elmId"));if(!confirm(I18n.t("txt.users.edit.remove_account_confirmation",{identityName:identity.name}))){return false}var spinner=$j("<div>").addClass("spinner small").insertAfter(targetElm);targetElm.hide();this.identitiesManager.remove(identity).done(function(){spinner.remove()}).fail(function(){spinner.remove()}).done(function(){$j("."+identity.identityType+" .add_identity").show();$j("#"+identity.elmId).remove();clearFlash()}).fail(function(response){var json=JSON.parse(response.responseText);json.error&&showFlash(json.error,"error")})}});$z.defModule("people/search/index",{initialize:function(){if($j("#bulk_update").exists()){this.setupBulkUpdate()}},setupBulkUpdate:function(){var allCheckboxContent=$j(".individual_bulk_checkbox");this.activeCheckboxes=$j(_(allCheckboxContent.find(".checkbox")).select(function(checkbox){return !$j(checkbox).prop("disabled")}));if(this.activeCheckboxes.length<1){$j("#bulk_update").hide();allCheckboxContent.hide()}else{this.bulkSubmitElm=$j("#bulk_submit");this.toggleBulkSubmit();$j("#bulk_check").change($j.proxy(this.manageBulkUpdate,this));this.activeCheckboxes.change($j.proxy(this.toggleBulkSubmit,this));$j("#bulk_submit").click($j.proxy(this.submitBulkForm,this))}},manageBulkUpdate:function(e){var bulkCheckSelected=$j("#bulk_check").prop("checked");this.activeCheckboxes.not(".disabled").prop("checked",bulkCheckSelected);this.toggleBulkSubmit()},submitBulkForm:function(e){if(e){e.stopPropagation();e.preventDefault()}if(!this.anyChecked()){return}$j("#bulk_check").hide();$j("#bulk_spinner").show();$j.ajax({type:"POST",url:"/people/users/select_bulk_action",data:($j("#bulk_form").serialize()),success:function(response){clearFlash();$j.colorbox({html:response});$j("#bulk_spinner").hide();$j("#bulk_check").show()},error:function(response){showFlash("Error:"+response,"error");$j("#bulk_spinner").hide();$j("#bulk_check").show()}})},toggleBulkSubmit:function(e){if(this.anyChecked()){this.bulkSubmitElm.prop("disabled",false);this.bulkSubmitElm.removeClass("button_disabled");this.bulkSubmitElm.addClass("button")}else{this.bulkSubmitElm.prop("disabled",true);this.bulkSubmitElm.removeClass("button");this.bulkSubmitElm.addClass("button_disabled")}},anyChecked:function(){return _(this.activeCheckboxes).any(function(checkbox){return $j(checkbox).prop("checked")})}});$z.defModule("people/users/merge",{initialize:function(){},switch_to_password_form:function(){$j("#user_merge_email_form").hide();$j("#user_merge_password_form").show();$j.colorbox.resize();$j("#user_merge_email_for_password_form").val($j("#user_merge_email").val());$j("#user_merge_password_email_display").html($j("#user_merge_email").val())},on_email_submit:function(){if(this.email_validate($j("#user_merge_email").val())){this.toggle_form("email");return false}else{alert(I18n.t("txt.user.merge.enter_valid_email"));return true}},on_password_submit:function(){if($j("#user_merge_password").val()!==""){this.toggle_form("password");return false}else{alert(I18n.t("txt.user.merge.enter_valid_password"));return true}},email_validate:function(address){var reg=/^([A-Za-z0-9_\+\-\.])+(\+[0-9]+)?\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return reg.test(address)},password_does_not_match:function(text){this.toggle_form("password");alert(text)},toggle_form:function(type){$j("#user_merge_waiting_for_"+type).toggle();$j("#user_merge_submit_"+type).toggle()}});$z.defModule("people/users/new",{initialize:function(userId){$z("people/users/edit").initialize(userId)}});$z.defModule("people/users/show",{initialize:function(userId){this.userId=userId;var suspendUserElm=$j("#suspend_access");this.userSuspended=(suspendUserElm.attr("data-user-suspended")!=="false");if(this.userSuspended){$j("#suspended").show()}$j("a.toggle-twitter-data").click(function(){$j(this).closest("p.user-twitter").next(".twitter-properties").slideToggle(50)});$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle()});$j("#make_direct_number_link").click(function(e){$j.colorbox({inline:true,href:"#make_direct_number_layer"});if(e){e.preventDefault()}});$j("#edit_number_link").click(function(e){$j.colorbox({inline:true,href:"#edit_number_layer"});if(e){e.preventDefault()}});new UserMergeWizard(true);this.setSuspensionActionText();suspendUserElm.click($j.proxy(this.setSuspensionStatus,this))},setSuspensionStatus:function(e){e.preventDefault();if(this.settingStatus===true){return}this.settingSuspensionStatus=true;var suspendAccessUrl="/users/"+this.userId;$j.ajax({url:suspendAccessUrl,type:"PUT",dataType:"json",dataFilter:function(data){trimmed_data=$j.trim(data);if(trimmed_data==""){return"{}"}else{return data}},data:{authenticity_token:currentUser.authenticityToken,user:{suspended:!this.userSuspended}},success:$j.proxy(function(){this.userSuspended=!this.userSuspended;this.setSuspensionActionText();$j("#suspended").toggle(this.userSuspended);showFlash((this.userSuspended?I18n.t("txt.admin.javascrips.users_show.user_suspended_label"):I18n.t("txt.admin.javascrips.users_show.user_unsuspended_label")),"notice");this.settingSuspensionStatus=false},this),error:function(response){var action=this.userSuspended?"suspend":"unsuspend";if(action=="suspend"){message=I18n.t("txt.admin.javascrips.users_show.suspend_user_label")}else{message=I18n.t("txt.admin.javascrips.users_show.unsuspend_user_label")}showFlash(message,"error");this.settingSuspensionStatus=false}})},setSuspensionActionText:function(){$j("#suspend_access").html(this.userSuspended?I18n.t("txt.admin.javascrips.users_show.unsusped_access_label"):I18n.t("txt.admin.javascrips.users_show.suspend_access_label"))}});$z.defModule("reports/edit",{initialize:function(params){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge()}});Zendesk.NS("Reports");Zendesk.Reports.ForumAnalytics=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app);this.routes={TAB:"#forum_analytics",STATS:"#forum_analytics/stats/:statName"}};Zendesk.Reports.ForumAnalytics.prototype={$:function(selector){return $j(selector,this.container)},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){if(data.tabID!=="forum_analytics"){return}if(!self.$("#stats_summary_container").length){return}self._initUI();self._loadDefaultState();var params;if(this.matchPath(data.path,self.routes.TAB)){self._getRouteTab()}else{if(params=this.matchPath(data.path,self.routes.STATS)){self._getRouteStats(params)}}})},_getRouteStats:function(params){var sparkline=this.$(".sparkline#"+params.statName);if(sparkline.hasClass("active")){return}Zendesk.Stats.ForumUI.showDetailGraph(sparkline,{container:this.container})},_getRouteTab:function(){this._getRouteStats({statName:this.$(".sparkline:first").attr("id")})},_loadDefaultState:function(){if(!this.$(".sparkline > div:not(:empty)").length){Zendesk.Stats.ForumUI._drawSparklines({container:this.container})}},_initUI:function(){if(this._initialized){return}this._initialized=true;Zendesk.Stats.ForumUI._bindSparklineHandlers(this.sammyApp,{statsURL:"#forum_analytics/stats",container:this.container})}};Zendesk.NS("Reports");Zendesk.Reports.Overview=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app)};Zendesk.Reports.Overview.prototype={$:function(selector){return $j(selector,this.container)},_bindSparklineHandlers:function(){var self=this,sparklines;sparklines=[{context:".ticket_stats .search_sparkline",path:"#reports"},{context:"#forum_views",path:"#forum_analytics/stats/entry_view"},{context:"#forum_topics",path:"#forum_analytics"},{context:"#search_total_searches",path:"#search_analytics"},{context:"#search_tickets_created",path:"#search_analytics/stats/tickets"}];$j(sparklines).each(function(index,el){$j(el.context).bind("click",function(){self.sammyApp.setLocation(el.path)})})},_drawAllSparklines:function(){var self=this,sparklineGraphs;sparklineGraphs=[{div:"#tickets_created_sparkline",statName:"created_count",draw:this._drawTicketSparklines},{div:"#tickets_solved_sparkline",statName:"solve_count",draw:this._drawTicketSparklines},{div:"#tickets_first_response_time_sparkline",statName:"first_response_time",draw:this._drawTicketSparklines},{div:"#tickets_satisfaction_sparkline",statName:"csr",draw:this._drawTicketSparklines},{div:"#forum_views_sparkline",statName:"entry_view",draw:this._drawForumSparklines},{div:"#forum_topics_sparkline",statName:"entry_create",draw:this._drawForumSparklines},{div:"#search_total_searches_sparkline",statName:"searches",draw:this._drawSearchSparklines},{div:"#search_tickets_created_sparkline",statName:"tickets",draw:this._drawSearchSparklines}];$j(sparklineGraphs).each(function(index,graph){graph.draw.call(self,graph)})},_drawForumSparklines:function(graph){var graphDiv=this.$(graph.div),sparkline,statsInfo=Zendesk.Stats.ForumUI._statsInfo(this.$("#stats_object"));sparkline=new Zendesk.Stats.Graph(graphDiv,{graphType:"sparkline",resource:"forum",objectType:statsInfo.objectType,objectId:statsInfo.objectId,statName:graph.statName,start:statsInfo.windowStart,totalCountDiv:graphDiv.closest(".sparkline_container").find(".stat_total")});sparkline.draw()},_drawSearchSparklines:function(graph){var graphDiv=this.$(graph.div),sparkline;sparkline=new Zendesk.Stats.Graph(graphDiv,{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:graph.statName,totalCountDiv:graphDiv.closest(".sparkline_container").find(".stat_total")});sparkline.draw()},_drawTicketSparklines:function(graph){var graphDiv=this.$(graph.div),sparkline;sparkline=new Zendesk.Stats.Graph(graphDiv,{graphType:"sparkline",searchStatURL:"/account/0/ticket_stats_by_account",statName:graph.statName,totalCountDiv:graphDiv.closest(".sparkline_container").find(".stat_total")});$j.getJSON(sparkline.statsURL,{start:sparkline.startTime,interval:86400}).done($j.proxy(this._drawSparkline,sparkline,sparkline.statsURL,this._calculateTotal))},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){if(data.tabID!=="overview"){return}if(!self.$(".stats_summary_container").length){return}self._initUI();var sparklines=self.$(".search_sparkline > div:not(:empty)");if(sparklines.length){return}self._drawAllSparklines()})},_drawSparkline:function(url,calculateTotal,data){this.data=data.data;this.draw();var format="0,0",total=calculateTotal(data.data,data.counts);if(this.statName==="csr"){format="0,0%";total*=100}if(this.statName==="first_response_time"){total=total/3600}$j(this.totalCountDiv).append(Zendesk.Stats.formatNumber(format,total))},_calculateTotal:function(data,counts){var points=0,total=0;if(counts&&counts.length===data.length){for(var i=0;i<data.length;i++){if(counts[i]===undefined){continue}total+=data[i][1]*counts[i];points+=counts[i]}total/=points}else{for(var j=0;j<data.length;j++){total+=data[j][1]}}return total},_initUI:function(){if(this._initialized){return}this._initialized=true;this._bindSparklineHandlers()}};Zendesk.NS("Reports.Page");Zendesk.Reports.Page.init=function(){var tabbedContainer=new Zendesk.TabbedContainer.SammyApp();new Zendesk.Reports.Overview({app:tabbedContainer.app,container:"#overview"});new Zendesk.Reports.ForumAnalytics({app:tabbedContainer.app,container:"#forum_analytics"});new Zendesk.Reports.SearchAnalytics({app:tabbedContainer.app,container:"#search_analytics"});tabbedContainer.app.bind("tab.change",function(e,data){var tab=$j("#"+data.tabID);var trigger=function(){tabbedContainer.app.trigger("tab.changed_and_loaded",data)};if(tab.data("loaded")){trigger()}else{tab.data("loaded",true);tab.responsiveLoad("/reports?tab="+data.tabID,trigger)}});tabbedContainer.init()};Zendesk.NS("Reports");Zendesk.Reports.SearchAnalytics=function(options){options=options||{};this.container=options.container;this.sammyApp=this._extendSammyApp(options.app);this.routes={STATS:"#search_analytics/stats/:statName",TAB:"#search_analytics",TABLE:"#search_analytics/table/:orderField/:sortDirection/page/:page"}};Zendesk.Reports.SearchAnalytics.prototype={$:function(selector){return $j(selector,this.container)},_extendSammyApp:function(app){var self=this;return app.bind("tab.changed_and_loaded",function(e,data){self.searchStatsTable=self._initializeTable();if(data.tabID!=="search_analytics"){return}if(!self.$(".stats_summary_container").length){return}self._initUI();self._loadDefaultState();var params;if(this.matchPath(data.path,self.routes.TAB)){self._getRouteTab()}else{if(params=this.matchPath(data.path,self.routes.TABLE)){self._getRouteTable(params)}else{if(params=this.matchPath(data.path,self.routes.STATS)){self._getRouteStats(params)}}}})},_getRouteStats:function(params){var statName=params.statName,sparkline=this.$(".search_sparkline#"+statName);if(sparkline.hasClass("active")){return}this._drawDetailGraph(sparkline);this._setTableDescription(statName);this._fetchTableForSparkline(statName);this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show();if(statName!=="searches"){this._addPercentageSelectMenu(statName)}else{this.$("#stats_graph_select_menu").empty()}},_getRouteTab:function(){this._getRouteStats({statName:this.$(".search_sparkline:first").attr("id")})},_getRouteTable:function(params){this._loadDefaultGraph();var orderField=params.orderField,page=parseInt(params.page,10),sortDirection=params.sortDirection;this.$("#search_string_stats table th img").hide();this._sortTopStats(this.$("#search_string_stats table th."+orderField),sortDirection,page)},_initializeTable:function(){if(!this.$(".stats_summary_container").length){return undefined}var options={divTable:"#search_string_stats",statsType:"all",orderField:"searches",searchStatsTemplate:"#search_stats_template",divPaginationTotal:"#pagination_total",container:this.container};this.$("#search_string_feedback_checkbox").hide();this.$(options.divTable+" #show_more").hide();var searchStatsTable=new Zendesk.Stats.SearchStatsTable(options);this._displayFeedbackCheckbox(searchStatsTable);return searchStatsTable},_loadDefaultGraph:function(){if(this.$("#detailed_stats_graph").is(":empty")){this._drawDetailGraph(this.$(".search_sparkline:first"))}},_loadDefaultState:function(){if(!this.$(".search_sparkline > div:not(:empty)").length){this._drawSparklines()}},_setFeedbackCheckbox:function(isFeedbackData){if(isFeedbackData===true){this.$("#search_string_feedback_checkbox").show()}},_displayFeedbackCheckbox:function(table){table.isFeedbackData(this,this._setFeedbackCheckbox);var checkbox=this.$("#search_string_stats #feedback_tag");checkbox.prop("checked",false);checkbox.click(function(){var statsType=($j(this).is(":checked")?"feedback_tab":"all");table.modifyDisplayed({statsType:statsType})})},_bindSparklineHandlers:function(){var self=this;this.$(".search_sparkline").bind("click",function(){if(($j(this).hasClass("active"))){return false}else{self.sammyApp.setLocation("#search_analytics/stats/"+$j(this).attr("id"))}})},_sortByColumn:function(){var self=this;var sortableHeaders=this.$("table.tickets th").slice(0,-1);sortableHeaders.css({cursor:"pointer"});sortableHeaders.click(function(){var orderField=$j(this).attr("class"),page=self.searchStatsTable.statOptions.page,sortDirection=self.searchStatsTable.getNextSortDirection(orderField);self.sammyApp.setLocation("#search_analytics/table/"+orderField+"/"+sortDirection+"/page/"+page);return false})},_bindTableHandlers:function(){this._sortByColumn();var self=this;this.$("#search_string_stats #show_more a").click(function(){self.$("table.tickets tr:hidden").show();var table=self.searchStatsTable,orderField=table.statOptions.orderField,page=table.nextPage(),sortDirection=table.getCurrentSortDirection(orderField);self.sammyApp.setLocation("#search_analytics/table/"+orderField+"/"+sortDirection+"/page/"+page);return false})},_bindSelectMenuHandler:function(){var self=this;this.$("#stats_graph_select_menu select").live("change",function(){var selected=$j(this).find("option:selected").val();if(selected==="percentage"){self._showPercentageGraph()}else{self._showOriginal()}})},_showOriginal:function(){this.$("#percentage_stats_graph").hide();this.$("#detailed_stats_graph").show()},_showPercentageGraph:function(){var total=this.$("#searches_sparkline").data("graph_data").data;var current=this.$(".active").find("div").data("graph_data").data;var average=[];for(var i=0;i<total.length;i++){var percentage=parseInt((parseInt(current[i][1],10)*100)/parseInt(total[i][1],10),10);average.push([total[i][0],(isNaN(percentage)?0:percentage)])}this.$("#detailed_stats_graph").hide();this.$("#percentage_stats_graph").show();var graph=new Zendesk.Stats.Graph(this.$("#percentage_stats_graph"),{graphType:"percentage",data:average});graph.draw()},_drawSparklines:function(){var sparklineGraphs=[{div:"#searches_sparkline",statName:"searches"},{div:"#no_results_sparkline",statName:"no_results"},{div:"#no_clicks_sparkline",statName:"no_clicks"},{div:"#tickets_sparkline",statName:"tickets"}];for(var i=0;i<sparklineGraphs.length;i++){var sparkline=new Zendesk.Stats.Graph(this.$(sparklineGraphs[i].div),{graphType:"sparkline",searchStatURL:"/account/search_account_stats",statName:sparklineGraphs[i].statName,totalCountDiv:this.$(sparklineGraphs[i].div).parent().parent().find(".stat_total")});sparkline.draw()}},_drawDetailGraph:function(sparkline){this.$(".search_sparkline.active").removeClass("active");this.$(sparkline).addClass("active");var statName=this.$(sparkline).prop("id");var graph=new Zendesk.Stats.Graph(this.$("#detailed_stats_graph"),{graphType:"area",searchStatURL:"/account/search_account_stats",statName:statName});graph.draw();$j(window).resize(function(){graph.draw()})},_setTableDescription:function(stat){var tableDescription={searches:{title:I18n.t("txt.admin.public.javascript.views.reports.top_500_searches"),description:""},no_results:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_results_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.search.top_500_searches_no_results_description")},no_clicks:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_no_clicks_description")},tickets:{title:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_label"),description:I18n.t("txt.admin.public.javascript.views.reports.search.top_500_searches_tickets_created_description")}}[stat];this.$(".stats_summary_description").empty();this.$(".stats_summary_description").append(tableDescription.title);this.$(".stats_summary_extra_description").empty();this.$(".stats_summary_extra_description").append(tableDescription.description)},_fetchTableForSparkline:function(stat){var statData={searches:["searches","desc"],no_results:["avg_results","asc"],no_clicks:["ctr","asc"],tickets:["tickets","desc"]}[stat];if(stat!=="searches"){this.$("#search_string_feedback_checkbox input[type=checkbox]").prop("checked",false);this.searchStatsTable.statOptions.statsType="all"}this._sortTopStats(this.$("th."+statData[0]),statData[1],1,this._filterCallback)},_addPercentageSelectMenu:function(stat){var selectMenuDiv=this.$("#stats_graph_select_menu");var statTitle=this.$("#"+stat).parent().find(".stat_title").html().toLowerCase();var selectMenu=[];var originalTitle=this._getPercentageSelectMenuTranslation(statTitle);selectMenu.push("<select>");selectMenu.push('<option value="original">'+originalTitle+"</option>");selectMenu.push('<option value="percentage">'+I18n.t("txt.admin.public.javascript.views.reports.search.percent_of_total_searches_option")+"</option>");selectMenu.push("</select>");selectMenuDiv.empty();selectMenuDiv.append(selectMenu.join())},_getPercentageSelectMenuTranslation:function(statTitle){if(statTitle==I18n.t("txt.admin.views.reports.tabs.search.with_no_results_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_results_label")}else{if(statTitle==I18n.t("txt.admin.views.reports.tabs.search.with_no_clicks_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_with_no_clicks_label")}else{if(statTitle==I18n.t("txt.admin.views.reports.tabs.search.tickets_created_label").toLowerCase()){return I18n.t("txt.admin.views.reports.tabs.search.number_tickets_created_label")}else{return"Number "+statTitle}}}},_filterCallback:function(stat){this.$("table.tickets td."+stat).each(function(){if(stat=="ctr"||stat=="avg_results"){if(parseFloat($j(this).html())>0.05){$j(this).parent().hide()}}if(stat=="tickets"){if(parseFloat($j(this).html())<1){$j(this).parent().hide()}}});if(this.$(".active").attr("id")!=="searches"){var sorted=this.$("table.tickets tbody tr:visible").sort(function(a,b){return parseInt($j(b).find(".searches").html(),10)-parseInt($j(a).find(".searches").html(),10)});this.$("table.tickets tbody").empty();this.$("table.tickets tbody").append(sorted);this.$("#show_more").hide();this.$(".view_sort").remove();this.$("th.searches").children("div.title").append('<img alt="Table-arrow" class="view_sort" src="/images/table-arrow.png"/>');this.$("table.tickets th").css({cursor:"default"});this.$("table.tickets th").unbind("click");if(this.$("#search_string_feedback_checkbox").is(":visible")){this.$("#search_string_feedback_checkbox").hide();this.$("#search_string_feedback_checkbox").data("show_again",true)}}else{if(this.$("#search_string_feedback_checkbox").data("show_again")){this.$("#search_string_feedback_checkbox").show();this.$("#search_string_feedback_checkbox").data("show_again",false)}this._sortByColumn()}},_setSortImage:function(column,sortDirection){this.$(".view_sort").remove();var sortImage=(sortDirection==="desc"?"/images/table-arrow.png":"/images/table-arrow1.png");column.children("div.title").append('<img alt="Table-arrow" class="view_sort" src="'+sortImage+'"/>')},_sortTopStats:function(column,sortDirection,page,callback){var orderField=column.prop("class"),table=this.searchStatsTable,pageSize=(this.$(".active").attr("id")==="searches")?15:100;table.setSort(orderField,sortDirection);table.modifyDisplayed({page:page,pageSize:pageSize},this,callback);this._setSortImage(column,sortDirection)},_initUI:function(){if(this._initialized){return}this._initialized=true;this._bindSparklineHandlers();this._bindTableHandlers();this._bindSelectMenuHandler()}};$z.defModule("rules/_bulk_update",{initialize:function(){var bulkForm=$j("#ticket-chat");bulkForm.submit(function(e){$j.ajax({url:bulkForm.attr("action"),type:"POST",data:bulkForm.serialize()+"&background=true",dataType:"json",success:function(job){var jobStatus=new Zendesk.JobStatus(job.status_url,{title:I18n.t("txt.public.javascripts.views.rules._bulk_update.processing_tickets"),renderResult:function(jobStatus){var output={title:I18n.t("txt.public.javascripts.views.rules._bulk_update.tickets_processed",{count:jobStatus.results.length}),body:$j("<ul/>")};if(jobStatus.status==="completed"){document.location="/tickets/bulk_result?background="+jobStatus.job.id+"&return_to="+escape(document.location)}return output}})}});$j("#bulk-update").hide();$j("table.tickets th.checkbox input").remove();$j("table.tickets input.tickets_to_bulk_update").remove();return false})}});$z.defModule("rules/analysis/show",{initialize:function(params){$j("select#analysis-filter").change(function(event){var filterSelected=$j("select#analysis-filter option:selected").val();var queryParams=jQuery.queryParameters();var rawParams={filter:queryParams.filter};if(typeof(filterSelected)!="undefined"){rawParams.filter=filterSelected}if(typeof(queryParams.select)=="string"){rawParams.select=queryParams.select}if(typeof(queryParams.key)=="string"){rawParams.key=queryParams.key}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+$j(location).attr("pathname")+"?"+$j.param(rawParams)})}});$z.defModule("rules/edit",{initialize:function(){$j("fieldset.conditions span select").autocompleteFromSelectIfLarge()}});jQuery(function($){var lists=$("#view_output_columns").find(".sortablelist");if(!lists.exists()){return}lists.each(function(){$(this).sortableWithEmptyTarget({emptyTargetClass:"item sortable",placeholder:"sortable target",connectWith:lists.not(this)})});$j("#result_columns").bind("sortreceive",function(event,ui){if($j(this).find("li").size()>11){$j(ui.sender).sortable("cancel")}})});$z.defModule("rules/index",{initialize:function(params){var sortByHtml=function(a,b){return($j(a).html()<$j(b).html())?-1:($j(a).html()>$j(b).html())?1:0};$j("div#active-rules_sort input.sort_asc").click(function(event){var sortedRules=$j("ul#active-rules-sort-list li.item.sortable").sort(function(a,b){return sortByHtml(a,b)});$j("ul#active-rules-sort-list li.item.sortable").remove();$j("ul#active-rules-sort-list").prepend(sortedRules)});$j("div#active-rules_sort input.sort_desc").click(function(event){var sortedRules=$j("ul#active-rules-sort-list li.item.sortable").sort(function(a,b){return sortByHtml(b,a)});$j("ul#active-rules-sort-list li.item.sortable").remove();$j("ul#active-rules-sort-list").prepend(sortedRules)});$j("a.cancel-sorting").click(function(event){Ordering.cancelOrdering("div#active-rules")});$j("select#rule-select, select#rule-sort").change(function(event){var sortSelected=$j("select#rule-sort option:selected").val();var groupSelected=$j("select#rule-select option:selected").val();var query="/rules?";var queryParams=jQuery.queryParameters();var rawParams={filter:queryParams.filter};if(typeof(sortSelected)!="undefined"){rawParams.sort=sortSelected}if(typeof(groupSelected)!="undefined"){rawParams.select=groupSelected}window.location.href=$j(location).attr("protocol")+"//"+$j(location).attr("host")+query+$j.param(rawParams)})}});$z.defModule("rules/show",{initialize:function(){var selector="textarea[id*='ticket_fields'], input[id*='ticket_fields']";var defaultColor=$j(selector).css("color");$j(selector).css("color","gray");$j(selector).click(function(){$j(this).css("color",defaultColor)});$j(selector).blur(function(){if($j(this).val()==I18n.t("control.dropdown.value.no_change")){$j(this).css("color","gray")}});var subjectTh=$j("th:contains('Subject')");if(subjectTh.width()>50){subjectTh.css("width",subjectTh.width())}else{subjectTh.css("width","50px")}var comment_id="textarea#comment_value";var placeholder_warning_id="p#placeholders_in_comment_notice";$(document).observe("macro:applied",function(){if(($j(comment_id).val().indexOf("{{")>-1)||($j(comment_id).val().indexOf("{%")>-1)){$j(placeholder_warning_id).show()}else{$j(placeholder_warning_id).hide()}})}});Zendesk.NS.extend("Satisfaction",{Score:{offered:1,poor:4,good:16},ScoreValue:{"1":"offered","4":"poor","5":"poor","16":"good","17":"good"},Input:{init:function(){if($j(this._rootSelector).length){this._satisfactionButtons=$j("#satisfaction_rating form .rating");this._currentRatingContainer=$j("#current_rating");this._currentRating=this._parseCurrentRating();this._ratingTemplate=$j("#current_rating_template").html();this._form=$j("#satisfaction_rating form");this._app=this._buildSammyApplication(jQuery,this._rootSelector)}},_scoreSpanTemplate:'<span class="rating selected {{scoreKey}}">{{scoreText}}</span>',_ensureVisible:function(){if($j(this._rootSelector).is(":hidden")){if(this._currentRating&&this._currentRating.score>1){this._form.hide();this._renderRating(this._currentRating).show()}else{this._currentRatingContainer.hide();this._form.show()}$j(this._rootSelector).show()}},_parseCurrentRating:function(){var encodedHTML=$j("#current_rating_data").html();var decodedHTML=$j("<div />").html(encodedHTML).text();return JSON.parse(decodedHTML)},_renderRating:function(rating){var scoreKey=Zendesk.Satisfaction.ScoreValue[rating.score];var scoreText=$j.mustache(this._scoreSpanTemplate,{scoreKey:scoreKey,scoreText:I18n.t("txt.satisfaction.score."+scoreKey)});var presenter={header:I18n.t("txt.satisfaction.score.current",{score:scoreText}),commentHeader:I18n.t("txt.satisfaction.header.comment"),showComment:I18n.t("txt.satisfaction.comment.show"),hideComment:I18n.t("txt.satisfaction.comment.hide"),modifyRating:I18n.t("txt.satisfaction.rating.modify"),anonymousModifyRating:I18n.t("txt.satisfaction.rating.anonymous_modify"),comment:rating.comment,canModify:rating["can_modify?"],isAnonymous:currentUser.isAnonymous};return this._currentRatingContainer.html($j.mustache(this._ratingTemplate,presenter))},_rootSelector:"#satisfaction_rating",_buildSammyApplication:function($,root){var app=$.sammy(root,function(){this.debug=true;this.before(function(){Zendesk.Satisfaction.Input._ensureVisible();return true});this.get("#/satisfaction",function(){});this.post(/^\/requests\/.+\/satisfaction/,function(context){var form=Zendesk.Satisfaction.Input._form;jQuery.ajax({url:form.attr("action"),type:form.attr("method").toUpperCase(),data:form.serialize(),dataType:"json",error:function(request,textStatus,errorThrown){context.redirect("#/satisfaction/error")},success:function(data,textStatus,XMLHttpRequest){Zendesk.Satisfaction.Input._currentRating=data;context.trigger("ticket.satisfaction.created",data);context.redirect("#/satisfaction/success")}})});this.get("#/satisfaction/success",function(){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._renderRating(Zendesk.Satisfaction.Input._currentRating).show();this.redirect("#/satisfaction")});this.get("#/satisfaction/error",function(){});this.get("#/satisfaction/cancel",function(){Zendesk.Satisfaction.Input._satisfactionButtons.removeClass("selected");if(Zendesk.Satisfaction.Input._currentRating){Zendesk.Satisfaction.Input._form.hide();Zendesk.Satisfaction.Input._currentRatingContainer.show()}else{$j("#satisfaction_form_body").slideUp(500)}});this.get("#/satisfaction/comment/hide",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideUp().end().find("a.hide_comment").hide().end().find("a.show_comment").show()});this.get("#/satisfaction/comment/show",function(){Zendesk.Satisfaction.Input._currentRatingContainer.find(".comment").slideDown().end().find("a.show_comment").hide().end().find("a.hide_comment").show()});this.before("#/satisfaction/new",function(){Zendesk.Satisfaction.Input._currentRatingContainer.hide();Zendesk.Satisfaction.Input._form.show()});this.get("#/satisfaction/new",function(){});this.get("#/satisfaction/new/:ratingName",function(){var ratingName=this.params.ratingName;var selected=Zendesk.Satisfaction.Input._satisfactionButtons.filter("."+ratingName);if(!selected.hasClass("selected")){Zendesk.Satisfaction.Input._satisfactionButtons.not(selected).removeClass("selected");selected.addClass("selected");$j("#satisfaction_form_body:hidden").slideDown(500);$j("#ticket_satisfaction_score").val(Zendesk.Satisfaction.Score[ratingName])}})});app.run("#/satisfaction");return app}}});jQuery(function(){Zendesk.Satisfaction.Input.init()});$z.defModule("scheduled_csv_exports/_edit_form",{formIds:["edit_form","edit_form","test_form","delete_form"],initialize:function(){var self=this;$j("#submit_button").click(function(){if($j("#scheduled_csv_export_callback_url").val().include("gooddata.com")!=-1){Zendesk.Instrumentation.ToTango.track("Enabled","GoodData")}if(($j("#scheduled_csv_export_callback_url").val().include("gooddata.com")!=-1)&&($j("#scheduled_csv_export_show_metrics_false").is(":checked"))){alert("If you are using GoodData for Zendesk, please ensure that you have selected 'CSV Content > Full' to export all ticket metrics to your GoodData project.")}else{self.submit()}});$j("#test_form").submit(function(){self.preserveUserInput()});$j("#edit_form").submit(function(){self.handleFireNow()});if($j("#scheduled_csv_export_callback_url").val().include("gooddata.com")&&$j("#scheduled_csv_export_show_metrics_true").is(":checked")){$j("#scheduled_csv_export_show_metrics_false").change(function(){if(!confirm("If you are using GoodData for Zendesk, switching back to Basic CSV Content may delete your advanced reports and metrics. We recommend you use Full CSV Content. Are you sure you want to switch back to basic format?")){$j("#scheduled_csv_export_show_metrics_true").click()}})}self.callbackClick()},updateButtonColor:function(index){var method=(index==3)?"addClass":"removeClass";$j("#submit_button")[method]("negative")},submit:function(){var index=$j("#submit_type").val();var form=$j("#"+this.formIds[index]);form.submit()},preserveUserInput:function(){$j("#test_scheduled_at").val($j("#scheduled_csv_export_hour").val());$j("#test_callback_url").val($j("#scheduled_csv_export_callback_url").val());$j("#test_auth_type").val($j("#edit_form").find("input:checked").val())},handleFireNow:function(){var index=$j("#submit_type").val();if(index==1){this.addFireNow()}},addFireNow:function(){var fireNow=$j("<input>",{type:"hidden",value:"1",name:"scheduled_csv_export[fire_after_save]"});$j("#edit_form").append(fireNow)},callbackClick:function(){$j("#callback_code").click(function(){$j("#callback_pre").slideDown(200);$j("#callback_code").toggle();$j("#callback_show_text").toggle()});$j("#callback_pre").click(function(){$j("#callback_pre").slideUp(200);$j("#callback_code").toggle();$j("#callback_show_text").toggle()})}});Zendesk.NS("Zuora");Zendesk.Zuora.InvoicePage=function(){};Zendesk.Zuora.InvoicePage.prototype={show:function(){var self=this;$j("button[data-invoice-id]").click(function(){var currentElement=$j(this);var invoiceItemRowId="invoice-items-for-"+currentElement.data("invoice-id");var invoiceItemRow=function(){return $j("#"+invoiceItemRowId).first()};currentElement.find("span").html(invoiceItemRow().is(":visible")?"Show":"Hide");if(_.any(invoiceItemRow())){invoiceItemRow().toggle();return}$j(currentElement).addClass("activity").prop("disabled",true);$j.ajax({url:"/zuora/invoice/invoice_items.json?invoice_id="+$j(currentElement).data("invoice-id"),success:function(data){var invoiceItemRows=self.prepareInvoiceItems(data);var invoiceItemTable=$j('<table class="invoice-items">');invoiceItemTable.append('<tr><th>Description</th><th class="count">Quantity</th><th class="money">Amount</th><th class="money">Discount</th><th class="money">Total</th></tr>');_.each(invoiceItemRows,function(invoiceItem){var discountTotal=invoiceItem.discountAmount()+invoiceItem.discountPercentage();var invoiceItemRow=$j("<tr>").append($j("<td>").html(invoiceItem.description()).append($j("<div>").html(invoiceItem.serviceStartDate()+" to "+invoiceItem.serviceEndDate()))).append($j("<td>").addClass("count").html(invoiceItem.quantity()+" Agent(s)")).append($j("<td>").addClass("money").html("$"+invoiceItem.chargeAmount())).append($j("<td>").addClass("money").html("$"+discountTotal)).append($j("<td>").addClass("money").html("$"+invoiceItem.totalAmount()));invoiceItemTable.append(invoiceItemRow)});var currentRow=$j(currentElement).closest("tr");currentRow.after($j("<tr>").attr("id",invoiceItemRowId).append($j("<td colspan=5>").css("background-color",currentRow.find("td").first().css("background-color")).append(invoiceItemTable)));$j(currentElement).removeClass("activity").prop("disabled",false)}})})},prepareInvoiceItems:function(invoiceItems){var knownStartDates=_.uniq(_.pluck(invoiceItems,"service_start_date"));var dateAlignedCharges=_.map(knownStartDates,function(startDate){return _.filter(invoiceItems,function(item){return item.service_start_date==startDate})});return _.map(dateAlignedCharges,function(charges){return new Zendesk.Zuora.InvoiceItemRow(charges)})}};Zendesk.Zuora.InvoiceItemRow=function(attributeArray){this.rawInvoiceItems=attributeArray};Zendesk.Zuora.InvoiceItemRow.prototype={description:function(){return this._charge().charge_name},serviceStartDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_start_date))},serviceEndDate:function(){return $j.datepicker.formatDate("mm-dd-yy",new Date(this.rawInvoiceItems[0].service_end_date))},hasDiscount:function(){return _.any(this.rawInvoiceItems,function(invoiceItem){return invoiceItem.processing_type=="1"})},discountAmount:function(){if(!this.hasDiscount()){return 0}return parseFloat(this._discount().charge_amount)},discountPercentage:function(){if(!this.hasDiscount()){return 0}return" ("+this._discount().unit_price+"%)"},totalAmount:function(){return parseFloat(this.chargeAmount())+parseFloat(this.discountAmount())},chargeAmount:function(){return parseFloat(this._charge().charge_amount).toFixed(2)},perUnitCharge:function(){return parseFloat(this._charge().unit_price).toFixed(2)},quantity:function(){return this._charge().quantity},_charge:function(){return _.find(this.rawInvoiceItems,function(invoiceItem){return invoiceItem.processing_type=="0"})},_discount:function(){return _.find(this.rawInvoiceItems,function(invoiceItem){return invoiceItem.processing_type=="1"})}};jQuery(function($){var subscriptionSettingsForm=$("form#subscription_settings");if(subscriptionSettingsForm.length===0){return}var PERIOD_VALUES={1:"monthly",2:"quarterly",3:"biannually",4:"annually"};var SIZE_CLASSES=[null,"small","medium","large","extra_large"];var PLANS=JSON.parse($("#plan_data").html());_(JSON.parse($("#billing_cycle_labels").html())).each(function(labels,id){PLANS[id].billingCycleLabels=_(labels)});_(PLANS).each(function(plan,id){id=parseInt(id,10);if(isNaN(id)){return}plan.id=id;plan.className=SIZE_CLASSES[id];PLANS[id]=PLANS[plan.className]=plan});var originalPlan,currentPlan;originalPlan=currentPlan=PLANS[subscriptionSettingsForm.data("plan-type")||3];var MUST_CONFIRM_CHANGE=(currentAccount.isPayingCustomer);var plan=subscriptionSettingsForm.find("#subscription_plan_type"),agents=subscriptionSettingsForm.find("#subscription_max_agents"),agentsError=subscriptionSettingsForm.find("#subscription_max_agents_error"),billingCycle=subscriptionSettingsForm.find("#subscription_billing_cycle_type"),coupon=subscriptionSettingsForm.find("#coupon_code"),voiceOptIn=subscriptionSettingsForm.find("#voice_optin"),voiceTransOptIn=subscriptionSettingsForm.find("#voice_transcription_optin"),voicePricing=subscriptionSettingsForm.find(".voice_option .pricing"),voiceTransPricing=subscriptionSettingsForm.find(".voice_transcription_optin .pricing"),voiceTransSub=subscriptionSettingsForm.find(".voice_transcription_optin"),couponError=subscriptionSettingsForm.find("#coupon_code_error"),couponExpiry=subscriptionSettingsForm.find("#coupon_expiry"),subtotal=subscriptionSettingsForm.find("#subtotal"),discount=subscriptionSettingsForm.find("#discount"),couponDiscount=subscriptionSettingsForm.find("#coupon_discount"),total=subscriptionSettingsForm.find("#total"),billingOutput=subscriptionSettingsForm.find("#billing_period .period"),afterCouponExpiry=subscriptionSettingsForm.find("#after_coupon_expiry"),submitButton=subscriptionSettingsForm.find(".button.save"),cancelSubscription=subscriptionSettingsForm.find("#cancel_warning"),agreeToTerms=subscriptionSettingsForm.find("#terms_agree");voiceOptIn.change(function(){var element=$(this);if(element.prop("checked")){voicePricing.addClass("active");voiceTransOptIn.attr("disabled",false);voiceTransSub.removeClass("disabled")}else{voicePricing.removeClass("active");voiceTransOptIn.attr("disabled",true);voiceTransSub.addClass("disabled")}});voiceTransOptIn.change(function(){var element=$(this);if(element.prop("checked")){voiceTransPricing.addClass("active")}else{voiceTransPricing.removeClass("active")}});if(!voiceOptIn.is(":checked")){voiceTransOptIn.attr("disabled",true);voiceTransSub.addClass("disabled")}function downgrading(){return currentAccount.isPayingCustomer&&!currentAccount.isInTrial&&currentPlan&&originalPlan&&currentPlan.id<originalPlan.id}function agentCount(){return parseInt(agents.val(),10)}function updateBillingCycleOptions(size){if(currentPlan.restricted_to_annual_billing){billingCycle.val(4);$j(".billing_cycle_input").hide();return}var current=billingCycle.val();billingCycle.find("option").remove();currentPlan.billingCycleLabels.each(function(text,id){billingCycle.append('<option value="'+id+'">'+text+"</option>")});billingCycle.val(current);$j(".billing_cycle_input").show()}function format$(dollars){return"$"+addCommas(dollars.toFixed(2))}function updatePriceOutputs(calculationData){coupon.val(calculationData.coupon_code);subtotal.html(format$(calculationData.cycle_undiscounted_price));discount.html("-&nbsp;"+format$(calculationData.cycle_discount_no_coupon));couponDiscount.html("-&nbsp;"+format$(calculationData.cycle_coupon_discount));total.html(format$(calculationData.cycle_discounted_price));couponError.toggle(calculationData.coupon_error!=null).html(calculationData.coupon_error);couponExpiry.toggle(calculationData.coupon_expires_on!=null).html("Through "+calculationData.coupon_expires_on);afterCouponExpiry.toggle(calculationData.coupon_expires_on!=null).find(".value").html(format$(calculationData.cycle_undiscounted_price-calculationData.cycle_discount_no_coupon))}function validateAgentCount(){var agents=agentCount(),message;if(isNaN(agents)){message=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_number_of_agents_is_Required")}else{if(agents<currentPlan.max_agent_floor){message=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_this_plan_requires_at_least",{number_of_agents:currentPlan.max_agent_floor})}else{if(agents>currentPlan.max_agent_ceiling){message=I18n.t("txt.admin.public.javascripts.views.settings.account.oops_this_plan_allows_no_more_than",{number_of_agents:currentPlan.max_agent_ceiling})}}}agentsError.toggle(!!message).html(message);return !message}function validate(){return validateAgentCount()}function recalculatePrice(){if(isNaN(agentCount())){return}var done=false;setTimeout(function(){if(!done){subscriptionSettingsForm.addClass("recalculating");submitButton.prop("disabled",true)}},200);$.getJSON("/account/subscription/calculate",subscriptionSettingsForm.serialize()).done(updatePriceOutputs).always(function(){done=true;subscriptionSettingsForm.removeClass("recalculating");submitButton.prop("disabled",false)})}function updateBillingCycleOutput(){var current=billingCycle.val();if(current){billingOutput.html(I18n.t("txt.admin.views.accounts.subscription._subscription_summary.billed_"+PERIOD_VALUES[current].capitalize()))}}function confirmChangeURL(){return"/account/subscription/confirm?subscription[plan_type]="+plan.val()+"&subscription[max_agents]="+agentCount()+"&subscription[billing_cycle_type]="+billingCycle.val()+"&coupon_code="+coupon.val()+"&voice_optin="+(voiceOptIn.is(":checked")?"1":"0")+"&voice_transcription_optin="+(voiceTransOptIn.is(":checked")?"1":"0")}function setupConfirmationBindings(){var sammyApp=this;$("#colorbox").find("#terms_agree").change(function(){var termsAccepted=$(this).is(":checked");$(this).closest("form").find("footer input").prop("disabled",!termsAccepted);agreeToTerms.val(termsAccepted)}).end().find("#cboxClose,.close").click(function(){sammyApp.trigger("confirmation-dismissed");return false}).end().find("form").submit(function(){sammyApp.trigger("update-confirmed");return false})}function closeConfirmationDialog(){this.redirect("#subscription","plan",currentPlan.className)}function configureForFixedAgentCount(){if(currentPlan.fixed_agent_count){$(".max_agent_input").hide()}else{$(".max_agent_input").show()}}function capAgentCount(){var count=Math.min(agentCount(),currentPlan.max_agent_ceiling);agents.val(Math.max(count,currentPlan.max_agent_floor));configureForFixedAgentCount()}function configureCausewareBanners(size){if(size=="small"){$j(".causeware").show()}else{$j(".causeware").hide()}}var app=$.sammy("#subscription_settings",function(){this.bind("update-confirmed",function(){$.colorbox.close();subscriptionSettingsForm.trigger("submit",{confirmed:true})});this.bind("confirmation-dismissed",function(){$.colorbox.close();this.redirect("#subscription","plan",currentPlan.className)});this.get("#subscription/plan/:size",function(){var size=this.params.size;subscriptionSettingsForm.removeClass(SIZE_CLASSES.join(" ")).addClass(size);configureCausewareBanners(size);currentPlan=PLANS[size];plan.val(currentPlan.id);capAgentCount();validate();updateBillingCycleOptions(size);updateBillingCycleOutput();recalculatePrice()});this.get("#subscription/cancel",function(){cancelSubscription.show()});this.get("#subscription/confirmUpdate",function(){$.colorbox({href:confirmChangeURL(),width:"600px",maxWidth:"600px",onComplete:$.proxy(setupConfirmationBindings,this),onCleanup:$.proxy(closeConfirmationDialog,this)})});this.get(/#\/?subscription\/?$/,function(){this.redirect("#subscription","plan",currentPlan.className)})});agents.change(validate);agents.add(billingCycle).change(recalculatePrice);billingCycle.change(updateBillingCycleOutput);coupon.blur(recalculatePrice);subscriptionSettingsForm.submit(function(event,data){data=data||{};if($(this).hasClass("recalculating")){return false}if(!validate()){return false}if(downgrading()){window.location=subscriptionSettingsForm.data("downgrade-url")+"?"+subscriptionSettingsForm.serialize();return false}if(MUST_CONFIRM_CHANGE&&!data.confirmed){app.setLocation("#subscription/confirmUpdate");return false}});app.run("#/subscription");updateBillingCycleOutput();Zendesk.Instrumentation.ToTango.track("Subscription","Load")});(function($){Zendesk.SalesforceConfiguration={init:function(){this.cache();this.events()},cache:function(){this.$openEditorLnk=$(".edit_salesforce_object");this.$expandLnk=$(".expand_link");this.$contractLnk=$(".contract_link");this.$selectLnk=$(".add_link a");this.$deselectLnk=$(".remove_link a");this.$objectForm=$("#salesforce_object_form");this.$confSelector=$("#account_settings_use_salesforce_configuration");this.$configuration=$("#salesforce_configuration");this.$lookupChx=$("#account_settings_salesforce_integration");this.$lookupField=$("#lookup_field");this.boxWidth="820px";this.boxHeight="600px";this.sortTarget="salesforce_selected_objects";this.sortContainer="salesforce_selected_objects_sort";this.sortList="salesforce_selected_objects_sort_list"},events:function(){var _this=this;this.$openEditorLnk.live("click",function(){$.colorbox({href:$(this).attr("href"),width:_this.boxWidth,height:_this.boxHeight,onComplete:function(){_this.objSelector().change()}});return false});this.$expandLnk.live("click",function(){var folder,children;folder=$(this).closest(".folder");children=_this.getChildren(folder);if(folder.data("loaded")===false){_this.loadFolder(folder,children,$(this))}_this.expandFolder(folder,children);return false});this.$contractLnk.live("click",function(){var folder,children;folder=$(this).closest(".folder");children=_this.getChildren(folder);_this.contractFolder(folder,children);return false});this.$selectLnk.live("click",function(){var field=$(this).closest(".field").data("field");_this.selectField(field);return false});this.$deselectLnk.live("click",function(){var field=$(this).closest("li").data("field");_this.deselectField(field);return false});this.$objectForm.live("submit",function(){if($("#mapping_salesforce_field option").length===0){alert(I18n.t("txt.admin.views.settings.extensions._salesforce3.select_some_field_alert"));return false}var formData,labels,relationships;formData=$(this).serializeArray();labels={};relationships={};$(".selected_fields li.field.selected").each(function(){var field,title,folder;field=$(this).data("field");title=$(this).data("title");formData.push({name:"fields[]",value:field});labels[field]=title;folder=_this.getFolder($(this));if(folder.exists()){relationships[folder.data("relationship")]={object:folder.data("object"),type:folder.data("type")}}});formData.push({name:"labels",value:JSON.stringify(labels)});formData.push({name:"relationships",value:JSON.stringify(relationships)});formData.push({name:"mapping_salesforce_field_type",value:$("#mapping_salesforce_field option:selected").data("type")});formData.push({name:"authenticity_token",value:Zendesk.currentUser.authenticityToken});$.post(_this.saveObjectUrl(),$.param(formData)).done(function(data){$("#salesforce_configuration").html(data)}).fail(function(jqXHR){$("#salesforce_configuration").prepend(jqXHR.responseText)}).always(function(){_this.setupSort();$.colorbox.close()});return false});this.objSelector().live("change",function(){var fieldsContainer,loadingMessage,object;object=$(this).val()||"";fieldsContainer=$("#salesforce_fields");loadingMessage=_this.loadingImage()+"  "+I18n.t("txt.admin.views.settings.extensions._salesforce3.loading_fields",{object_name:object});fieldsContainer.html('<div class="salesforce_item">'+loadingMessage+"</div>");fieldsContainer.load(_this.fieldsUrl(object))});this.testForm().find(":submit").live("click",function(){var fields,testData,crmApp;fields=_this.testForm().find("input[type=text]");testData=fields.serializeArray();crmApp=new Zendesk.CRM.Application(new Zendesk.CRM.SidebarRenderer());crmApp.fetchAndRenderData(_this.testUrl()+"?format=json&"+$.param(testData));return false});this.$confSelector.change(function(){var value=$(this).val();if(value==="0"){_this.$configuration.slideUp()}else{_this.$configuration.slideDown()}});this.$confSelector.change();this.$lookupChx.change(function(){if($(this).is(":checked")){_this.$lookupField.slideDown()}else{_this.$lookupField.slideUp()}});this.$lookupChx.change();$("a#cancel_sorting").live("click",function(){Ordering.cancelOrdering("#"+_this.sortTarget);return false});$("a#start_sorting").live("click",function(){Ordering.SetOrder("#"+_this.sortTarget);return false});this.setupSort()},selectField:function(field){var fieldElement,folder,title,type;fieldElement=$('li[data-field="'+field+'"]');folder=this.getFolder(fieldElement);fieldElement.removeClass("non_selected");fieldElement.closest("li").addClass("selected");folder.removeClass("non_selected");folder.closest("li").addClass("selected");if(!field.include("::")){title=fieldElement.data("title");type=fieldElement.data("type");this.mappingSalesforceField().append('<option value="'+field+'" data-type="'+type+'">'+title+"</option>")}},deselectField:function(field){var fieldElement,folder;fieldElement=$('li[data-field="'+field+'"]');fieldElement.removeClass("selected");fieldElement.closest("li").addClass("non_selected");folder=this.getFolder(fieldElement);if(this.getChildren(folder).find("li.field.selected").length===0){folder.removeClass("selected");folder.closest("li").addClass("non_selected")}this.mappingSalesforceField().find("option[value='"+field+"']").remove()},expandFolder:function(folder,children){children.show();folder.addClass("expanded");folder.removeClass("contracted")},contractFolder:function(folder,children){children.hide();folder.addClass("contracted");folder.removeClass("expanded")},getChildren:function(folder){return folder.parent().find(".children")},getFolder:function(field){return field.parents(".folder_container").find(".folder")},fieldsUrl:function(object){var params={object:object};return"extensions/edit_salesforce_fields?"+$.param(params)},relatedFieldsUrl:function(folder){var params={object:folder.data("object"),relationship:folder.data("relationship")};return"extensions/salesforce_related_fields?"+$.param(params)},saveObjectUrl:function(){return"extensions/save_salesforce_object"},testUrl:function(){return"/crm/sync_ticket_info"},setupSort:function(){$("#"+this.sortList).sortable();submit_sortable_list(this.sortTarget,this.sortContainer,this.sortList,"extensions/sort_salesforce_objects")},loadFolder:function(folder,children){var _this,contractLink,contractImage;_this=this;contractLink=folder.find(".contract_link");contractImage=contractLink.html();contractLink.html(this.loadingImage);children.load(_this.relatedFieldsUrl(folder),function(){folder.data("loaded",true);_this.copyFolder(folder.data("relationship"),children);contractLink.html(contractImage)})},loadingImage:function(){return'<img src="/images/ajax_loader_small.gif" style="width:9px">'},copyFolder:function(relationship,children){var selectedFolder=this.selectedFields().find('li[data-relationship="'+relationship+'"]');selectedFolder.data("loaded",true);selectedFolder.addClass("expanded");selectedFolder.removeClass("contracted");this.getChildren(selectedFolder).html(children.html())},selectedFields:function(){return $(".selected_fields")},testForm:function(){return $("#crm_test_form")},objSelector:function(){return $("#salesforce_object")},mappingSalesforceField:function(){return $("#mapping_salesforce_field")}}}(jQuery));$z.defModule("settings/extensions/show",{initialize:function(params){$j("#crm_integration").change(function(){var value=$j(this).val();if(value=="SalesforceIntegration"){$j("#sugar, #ms_dynamics").hide();$j("#salesforce").show()}else{if(value=="SugarCrmIntegration"){$j("#salesforce, #ms_dynamics").hide();$j("#sugar").show()}else{if(value=="MsDynamicsIntegration"){$j("#salesforce, #sugar").hide();$j("#ms_dynamics").show()}}}});$j("#ms_dynamics_integration_type_code").change(function(){$j(".ms_dynamics_on_premise").toggle();$j(".ms_dynamics_on_cloud").toggle()});if($j("#ms_dynamics_form").data("on-premise")){$j(".ms_dynamics_on_premise").show();$j(".ms_dynamics_on_cloud").hide()}else{$j(".ms_dynamics_on_premise").hide();$j(".ms_dynamics_on_cloud").show()}$j("#settings_extensions_ms_dynamics_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#ms_dynamics_form").submit()});$j("#settings_extensions_sugar_crm_save_button").click(function(){$j(this).val(I18n.t("txt.admin.public.javascript.views.settings.extensions.testing_connection_please_wait")).prop("disabled",true);$j("#sugar_crm_form").submit()});$j("#settings_extensions_salesforce_connect_button").click(function(){this.href="/settings/extensions/connect_to_salesforce?salesforce_environment="+$j("select#salesforce_environment option:selected").val();Zendesk.Instrumentation.ToTango.track("Enabling salesforce.com","CRM")});Zendesk.SalesforceConfiguration.init()}});(function($){Zendesk.NS("Branding");Zendesk.Branding={init:function(branding,dynamicContent){this.branding=branding;this.dynamicContent=dynamicContent;this.cache();this.imgloader();this.autocomplete();this.events()},cache:function(){this.$el={previewHeaderWrapper:$("div#mobile-settings #settings_mobile_preview"),previewHeader:$("div#mobile-settings #mobile-header-wrapper header"),previewHeaderTitle:$("div#mobile-settings #settings_mobile_preview h1"),previewHeaderLogo:$("div#mobile-settings #logo-wrapper img"),previewHeaderSearch:$("div#mobile-settings #search-button"),inputTitle:$("#account_mobile_title"),inputFileLogo:$("#mobile_logo_uploaded_data:file"),pageHeaderDarker:$("#branding_tab_background_color"),revertColorsLink:$("#revert_colors_link"),headerColor:$("#branding_header_color"),pageBackgroundColor:$("#branding_page_background_color"),sideboxColor:$("#branding_sidebox_color"),tabBackgroundColor:$("#branding_tab_background_color"),tabHoverColor:$("#branding_tab_hover_color"),textColor:$("#branding_text_color"),classicLogo:$("#image-block-header_logo img"),mobileLogo:$("#image-block-mobile_logo img"),saveButton:$("#settings_account_branding_save_button")}},imgloader:function(){this.fileReader=window.FileReader?new FileReader():false},autocomplete:function(){if(currentAccount.hasFeature("placeholderSuggestions")){this.suggest=new Suggest();this.suggest.suggestions=this.placeholders()}else{this.suggest=false}},placeholders:function(){var dc,placeholders={},placeholder;for(dc in this.dynamicContent){placeholder=this.dynamicContent[dc];placeholders["{{"+dc+"}}"]=placeholder.name}return placeholders},calculateLogoDimension:function(size){if(size>55){size=parseInt((size/114)*55)}else{size=null}return size},events:function(){var _this=this;if(this.fileReader){this.$el.inputFileLogo.change(function(){if(this.files&&this.files[0]){_this.fileReader.readAsDataURL(this.files[0])}});this.fileReader.onload=function(event){var img=$("<img src='"+event.target.result+"' />").load(function(){$(img).attr({width:_this.calculateLogoDimension(this.width),height:_this.calculateLogoDimension(this.height)});_this.updateLogo.call(_this,img)})}}if(this.suggest){this.$el.inputTitle.bind({focusin:function(event){_this.suggest.attach(this,event)},focusout:function(event){_this.suggest.detach(this,event)}})}this.$el.inputTitle.keyup(function(){_this.updateTitle()});this.$el.headerColor.change(function(){_this.updateHeaderColors()});this.$el.pageBackgroundColor.change(function(){_this.updatePageBgColor()});this.$el.revertColorsLink.click(function(){_this.revertColors();_this.updateHeaderColors()});this.$el.previewHeaderWrapper.click(function(){return false});this.$el.saveButton.click(function(event){if(_this.doubleCheck()){return true}var msg=I18n.t("txt.admin.views.settings.account._branding.hex_not_valid");alert(msg);event.preventDefault();return false})},updateLogo:function(img){this.$el.previewHeaderLogo.replaceWith(img);this.$el.previewHeaderLogo=img},updateTitle:function(){var title=this.$el.inputTitle.val(),dynamicTitle=this.dynamicTitle(title);this.$el.previewHeaderTitle.text(dynamicTitle)},dynamicTitle:function(title){var reg=new RegExp("{{([^}]{2,})}}","gi"),_this=this;return title.replace(reg,function(placeholder){var key=placeholder.substring(2,placeholder.length-2);return _this.dynamicContent[key].value})},updatePageBgColor:function(){var color=this.$el.pageBackgroundColor.val(),hex=this.getValid(color);if(!hex){return false}this.$el.pageBackgroundColor.val(hex);return true},updateHeaderColors:function(){var color=this.$el.headerColor.val(),hex=this.getValid(color);if(!hex){return false}var rgb=YAHOO.util.Color.hex2rgb(hex),hsv=YAHOO.util.Color.rgb2hsv(rgb[0],rgb[1],rgb[2]),tabBgColor=this.getTabBgHexFrom(hsv),tabHoverColor=this.getTabHoverHexFrom(hsv),textColor=this.getTextHexFrom(hsv),borderColor=this.getBorderColor(tabBgColor),bgColor=hex;this.updateInputFields(bgColor,tabBgColor,tabHoverColor,textColor);this.updateHeaderPreview(bgColor,tabBgColor,borderColor,textColor);this.updateLogoBackgrounds(bgColor);return true},getValid:function(hex){if(this.isValid(hex)){hex=this.removeHashFrom(hex);hex=this.sixDigit(hex);return hex}else{return false}},isValid:function(hex){var strPattern=/^#?[0-9a-f]{3,6}$/i;return strPattern.test(hex)},removeHashFrom:function(hex){return hex.replace(/#/gi,"")},sixDigit:function(hex){return hex.length===6?hex:hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]},getTabBgHexFrom:function(hsv){var h=hsv[0]*1.03>1?1:hsv[0]*1.03,s=hsv[1]*0.87,v=hsv[2]*0.83;return this.hsvToHex([h,s,v])},hsvToHex:function(hsv){var rgb=YAHOO.util.Color.hsv2rgb(hsv[0],hsv[1],hsv[2]);return YAHOO.util.Color.rgb2hex(rgb[0],rgb[1],rgb[2])},getTabHoverHexFrom:function(hsv){var h=hsv[0],s=hsv[1]*0.62,v=hsv[2]*1.02>1?1:hsv[2]*1.02,hsvNew=this.hsvToHex([h,s,v]);return hsvNew==="FFFFFF"?"E8E8E8":hsvNew},getTextHexFrom:function(hsv){return hsv[2]>0.85?"2A2A2A":"FFFFFF"},getBorderColor:function(hex){var rgb=YAHOO.util.Color.hex2rgb(hex),hsv=YAHOO.util.Color.rgb2hsv(rgb[0],rgb[1],rgb[2]);if(hsv[2]<0.5){hsv[2]*=1.2}else{hsv[2]*=0.8}rgb=YAHOO.util.Color.hsv2rgb(hsv[0],hsv[1],hsv[2]);return YAHOO.util.Color.rgb2hex(rgb[0],rgb[1],rgb[2])},updateInputFields:function(bgColor,tabBgColor,tabHoverColor,textColor){this.$el.headerColor.val(bgColor);this.$el.tabBackgroundColor.val(tabBgColor);this.$el.tabHoverColor.val(tabHoverColor);this.$el.textColor.val(textColor)},updateHeaderPreview:function(bgColor,bgColorDarker,borderColor,textColor){this.$el.previewHeader.css({"background-color":"#"+bgColor}).css({"background-image":"-webkit-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"-moz-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"-ms-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"-o-linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"}).css({"background-image":"linear-gradient(top, #"+bgColor+", #"+bgColorDarker+")"});this.$el.previewHeaderSearch.css({"background-color":"#"+bgColorDarker});this.$el.previewHeader.css({"border-bottom-color":"#"+borderColor});this.$el.previewHeaderTitle.css({color:"#"+textColor,"text-shadow":textColor==="FFFFFF"?"0px -1px rgba(0, 0, 0, 0.5)":"none"})},updateLogoBackgrounds:function(bgColor){this.$el.classicLogo.css({"background-color":"#"+bgColor});this.$el.mobileLogo.css({"background-color":"#"+bgColor})},revertColors:function(){this.$el.sideboxColor.val(this.branding.sidebox_color);this.$el.headerColor.css("background-color","#"+this.branding.header_color).val(this.branding.header_color);this.$el.pageBackgroundColor.css("background-color","#"+this.branding.page_background_color).val(this.branding.page_background_color)},doubleCheck:function(){return this.updateHeaderColors()&&this.updatePageBgColor()}}}(jQuery));$z.defModule("settings/account/_branding",{initialize:function(branding,dynamicContent){Zendesk.Branding.init(branding,dynamicContent)}});(function($z,$j,_){var options={searchBoostSliderSelector:null,onlyEnduserSliderLabel:"",onlyAgentsSliderLabel:""};function initializeBoostCuratedContentSlider(){var valueMappings={"10:1":-0.9,"4:1":-0.75,"2:1":-0.5,"1:1":0,"1:2":0.5,"1:4":0.75,"1:10":0.9};valueMappings[options.onlyAgentsSliderLabel]=-1;valueMappings[options.onlyEnduserSliderLabel]=1;function keyOfValue(value){var key,found=_.find(valueMappings,function(eachValue,eachKey){key=eachKey;return value===eachValue});return found!==undefined&&key}function onSliderChange(value){$j("#account_settings_boost_curated_content").val(value);var $label=$j("#curated-search-slider .label"),key=keyOfValue(value);$label.text(key)}function setupBackGround(){var bg=$j("div.slider-bg");bg.html("<div/><div/><div/>");var divs=$j("div.slider-bg > div"),sliderWidth=divs.parent().width(),smallWidth=10,spacing=6;divs.filter(":nth-child(1)").css({width:smallWidth,left:0});divs.filter(":nth-child(2)").css({width:sliderWidth-smallWidth-smallWidth-2*spacing,left:smallWidth+spacing});divs.filter(":nth-child(3)").css({width:smallWidth,left:sliderWidth-smallWidth})}var relativePositions={"10:1":1+10*0.01,"4:1":1+10*0.3,"2:1":1+10*0.4,"1:1":1+10*0.5,"1:2":1+10*0.6,"1:4":1+10*0.7,"1:10":1+10*0.99};relativePositions[options.onlyAgentsSliderLabel]=1-0.9;relativePositions[options.onlyEnduserSliderLabel]=1+10+0.9;function valuePosition(val){return relativePositions[keyOfValue(val)]}setupBackGround();var values=_.values(valueMappings),value=parseFloat($j("#account_settings_boost_curated_content").val())||0,valuePositions=values.collect(function(value){return valuePosition(value)});$z.Slider.setup(options.searchBoostSliderSelector,{onSliderChange:onSliderChange,range:[0,12],relativePositions:valuePositions,values:values,value:value,showTicks:true})}$z.defModule("settings/portal/_settings",{initialize:function(params){options.searchBoostSliderSelector=params&&params.sliderId;if(!options.searchBoostSliderSelector){return}options.onlyEnduserSliderLabel=params.enduser_string;options.onlyAgentsSliderLabel=params.agents_string;$j(initializeBoostCuratedContentSlider)}})})(this.Zendesk,this.jQuery,this._);Zendesk.NS("Screenr");Zendesk.Screenr.Provisioning={init:function(domain,triggeringCheckBoxId,scope){Zendesk.Screenr.Provisioning.requestedDomain=domain;Zendesk.Screenr.Provisioning.scope=scope;this.bindCheckBox(triggeringCheckBoxId);this.bindProvisioningForm()},requestedDomain:"",triggeringCheckBoxId:"",scope:"",bindCheckBox:function(checkBoxId){$j(checkBoxId).click(function(event){this.showProvisioningModal();event.preventDefault()}.bind(this));Zendesk.Screenr.Provisioning.triggeringCheckBoxId=checkBoxId},showProvisioningModal:function(){$j.colorbox({inline:true,href:"#screenr_provisioning",width:"620px",onComplete:function(){$j("#screenr_provisioning  #domain").focus()},onClosed:function(){Zendesk.Screenr.Provisioning._removeError()}})},bindProvisioningForm:function(){$j("#screenr_provisioning form").submit(function(event){event.preventDefault();this.onSubmit()}.bind(this))},onSubmit:function(){Zendesk.Screenr.Provisioning._disableSubmitButton();Zendesk.Screenr.Provisioning._removeError();Zendesk.Screenr.Provisioning._enqueueProvisioning()},_enqueueProvisioning:function(){if(this.poller){this.poller.stop()}$j("#provisioning_spinner").show();$j.ajax({type:"POST",url:"/screenr_tenants",data:{domain:Zendesk.Screenr.Provisioning.requestedDomain,scope:Zendesk.Screenr.Provisioning.scope},success:this._startPoller.bind(this)})},_startPoller:function(response){var ajaxParams={url:response.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(ajaxParams,1000,20000,this._pollingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start()},_pollingCallback:function(response){switch(response.job_status.status){case"completed":this._onCompletedPolling(response.job_status.results);break;case"failed":this._errorCallback(this);break;case"killed":this._errorCallback(this);break;default:return true}},_onCompletedPolling:function(results){switch(results.api_status){case"provisioned":this._onSucessfulProvisioning();break;case"validation_failed":this._onValidationFailed(results.message,results.error_on);break;default:this._errorCallback(this)}},_onSucessfulProvisioning:function(){$j("#provisioning_spinner").hide();var account_created_text=I18n.t("public.javascripts.views.settings.screencasts.screenr_account_created"),close_text=I18n.t("public.javascripts.views.settings.screencasts.close_window_button"),final_feedback_text=I18n.t("public.javascripts.views.settings.screencasts.final_feedback"),feedback_modal=$j('<div class="info">'),feedback_main=$j("<p>"),close_bt_wrapper=$j('<div class="submit">'),close_bt=$j('<input class="button" name="commit" type="submit"/>');$j("#screenr_provisioning").html("");feedback_modal.html("&#10004;&nbsp; "+account_created_text).appendTo($j("#screenr_provisioning"));feedback_main.html(final_feedback_text).appendTo($j("#screencasts_wrapper"));close_bt.attr("value",close_text).appendTo(close_bt_wrapper).click(function(event){$j.colorbox.close();feedback_main.effect("highlight",{},3000)}.bind(this));close_bt_wrapper.appendTo($j("#screenr_provisioning"));Zendesk.Screenr.Provisioning._setTriggeringCheckboxAsChecked(Zendesk.Screenr.Provisioning.triggeringCheckBoxId);$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_setTriggeringCheckboxAsChecked:function(checkBoxId){$j(checkBoxId).attr("checked",true).unbind().click(function(event){event.preventDefault()})},_onValidationFailed:function(message,error_on){this._displayError(message);$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_errorCallback:function(response){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_timeoutCallback:function(response){this._displayError(I18n.t("public.javascripts.views.settings.screencasts.screenr_unavailable"));$j("#provisioning_spinner").hide();$j("#downgrading_spinner").hide();this._enableSubmitButton();this._enableDowngradingButton()},_displayError:function(message){$j(".error").html(message).show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_removeError:function(){$j(".error").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_disableSubmitButton:function(){$j("#screenr_provisioning .button").attr("disabled","disabled")},_enableSubmitButton:function(){$j("#screenr_provisioning .button").removeAttr("disabled")},recorderId:null,host:null,screenrBaseUri:null,confirmState:false,setupDowngrade:function(recorderId,host,screenrBaseUri){this.recorderId=recorderId;this.host=host;this.screenrBaseUri=screenrBaseUri;this._bindDowngradeLink()},_bindDowngradeLink:function(){$j("#screenr_downgrade").click(function(event){this._checkTenantStatus();event.preventDefault()}.bind(this))},_checkTenantStatus:function(){var checkUrl=Zendesk.Screenr.Helper.publicUrlToTenantStatus(this.recorderId,this.host,this.screenrBaseUri);$j.ajax({type:"GET",url:checkUrl,success:this._parseTenantStatus.bind(this),error:this._errorCallback.bind(this)})},_parseTenantStatus:function(data){var response=data;if(typeof response=="string"){response=response.evalJSON()}switch(response.StatusCode){case 200:this._displayDowngrade();break;case 403:this._displayImpossibleToDowngrade();break;default:this._errorCallback()}},_displayImpossibleToDowngrade:function(){var modal=$j("#screenr_downgrading");modal.find("#no_downgrade").show();modal.find("#close_modal").click(function(event){$j.colorbox.close();event.preventDefault()}.bind(this));this._showDowngradingModal()},_displayDowngrade:function(){var modal=$j("#screenr_downgrading");modal.find("#downgrade").show();modal.find("#downgrade_button").click(function(event){if(!this.confirmState){this.confirmState=true;this._onDowngradeClick()}event.preventDefault()}.bind(this));modal.find("#close_modal").click(function(event){$j.colorbox.close();event.preventDefault()}.bind(this));this._showDowngradingModal();this.confirmState=false},_onDowngradeClick:function(){var answer=confirm(I18n.t("public.javascripts.views.settings.screencasts.sure_you_want_downgrade"));if(answer){this._enqueueDowngrading()}else{$j.colorbox.close()}},_enqueueDowngrading:function(){if(this.poller){this.poller.stop()}$j("#downgrading_spinner").show();this._disableDowngradingButton();$j.ajax({type:"POST",url:"/screenr_tenant_downgrades",success:this._startDowngradingPoller.bind(this)})},_startDowngradingPoller:function(response){var ajaxParams={url:response.status_url,type:"GET",dataType:"json"};this.poller=new Zendesk.Utils.Poller(ajaxParams,1000,20000,this._pollingDowngradingCallback.bind(this),this._errorCallback.bind(this),this._timeoutCallback.bind(this));this.poller.start()},_pollingDowngradingCallback:function(response){switch(response.job_status.status){case"completed":this._onCompletedDowngradingPolling(response.job_status.results);break;case"failed":this.confirmState=false;this._errorCallback(this);break;case"killed":this.confirmState=false;this._errorCallback(this);break;default:return true}},_onCompletedDowngradingPolling:function(results){switch(results.api_status){case"downgraded":this._onSucessfulDowngrading();break;case"validation_failed":this.confirmState=false;this._onValidationFailed(I18n.t("public.javascripts.views.settings.screencasts.screenr_account_impossible_to_downgrade"),"");break;default:this._errorCallback(this)}},_onSucessfulDowngrading:function(){var modal,button;modal=$j('<div class="info">'+I18n.t("public.javascripts.views.settings.screencasts.screenr_account_downgraded")+'</div><form><fieldset><input id="close_button" class="button" name="commit" type="submit" /></fieldset></form>');button=modal.find("#close_button");button.attr("value",I18n.t("public.javascripts.views.settings.screencasts.screenr_account_downgraded_close_button")).click(function(event){event.preventDefault();$j.colorbox.close()}.bind(this));$j("#provisioning_spinner").hide();$j("#screenr_downgrading").empty();modal.appendTo($j("#screenr_downgrading"));$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})},_disableDowngradingButton:function(){$j("#screenr_downgrading .button").attr("disabled","disabled")},_enableDowngradingButton:function(){$j("#screenr_downgrading .button").removeAttr("disabled")},_showDowngradingModal:function(){$j.colorbox({inline:true,href:"#screenr_downgrading",width:"620px",onComplete:function(){},onClosed:function(){Zendesk.Screenr.Provisioning._removeError()}})}};$z.defModule("settings/security/show",{initialize:function(params){$j("#account_security_policy_id_400").click(function(){$j("#custom_security_policy_options").show()})}});Zendesk.NS("Alerts");Zendesk.Alerts={showTwitterAuthorization:function(){var alertType="twitter_authorization_failure";var unauthorizedAccounts=_.select(currentAccount.twitterAccounts,function(twitterAccount){if(twitterAccount.screen_name!=null){return twitterAccount.authorized==false}});if(_.size(unauthorizedAccounts)>0){$j("#flash").append(this.renderTwitterAuthorization(unauthorizedAccounts));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showFacebookAuthorization:function(){var alertType="facebook_authorization_failure";var unauthorizedPages=_.select(currentAccount.facebookPages,function(page){return page.unauthorized});if(_.size(unauthorizedPages)>0){$j("#flash").append(this.renderFacebookAuthorization(unauthorizedPages));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showPasswordExpiration:function(){var alertType="password_expiration";if(currentUser.isPasswordExpiring()){$j("#flash").append(this.renderPasswordExpiration(alertType));new Zendesk.AlertManager("#"+alertType,this.cookieName(alertType)).show()}},showSystemNotice:function(alertName){new Zendesk.AlertManager("#"+alertName,alertName).show()},cookieName:function(alertType){return"accounts."+currentAccount.id+"."+alertType},renderTwitterAuthorization:function(twitterAccounts){var i18n_first_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_no_longer");var i18n_second_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_twitter");var template='<div id="twitter_authorization_failure" style="display:none" class="alert">'+i18n_first_part+"<ul>        {{#accounts}}        <li>{{screen_name}}</li>        {{/accounts}}      </ul>"+i18n_second_part;return jQuery.mustache(template,{accounts:twitterAccounts})},renderFacebookAuthorization:function(facebookPages){var i18n_first_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.your_account_not_longer_permissions_facebook");var i18n_second_part=I18n.t("txt.admin.public.javascripts.views.shared._alert.reauthorize_facebook");var template='<div id="facebook_authorization_failure" style="display:none" class="alert">'+i18n_first_part+'<ul>        {{#pages}}        <li>{{name}} - <span class="facebook_authorization_failure_reason">{{reason_for_unauthorization}}</span></li>        {{/pages}}      </ul>'+i18n_second_part+"</div>";return jQuery.mustache(template,{pages:facebookPages})},renderPasswordExpiration:function(id){var template='<div id="password_expiration" style="display:none" class="alert">{{{message}}}      <a style="margin-left:10px" id="hide_expiration" class="close" href="#">'+I18n.t("txt.public.javascripts.views.shared._alert.hide_this_notice")+"</a></div>";var message=I18n.t("txt.security_policy.expiration_alert",{count:i18n_distance_of_time_in_words(currentUser.passwordExpiresAt,new Date()),url:"/password"});return jQuery.mustache(template,{message:message})}};(function($,Zendesk){var firstDay=Number(I18n.t("date.datepicker.first_day"));var isRTL=Boolean(Number(I18n.t("date.datepicker.is_rtl")));var showMonthAfterYear=Boolean(Number(I18n.t("date.datepicker.show_month_after_year")));var defaultDateFormat="yy-mm-dd";function localizeCalendarDates(){$(".new_date_picker").each(function(){try{var parsed=$.datepicker.parseDate(defaultDateFormat,$(this).val());var formatted=$.datepicker.formatDate(I18n.t("date.datepicker.date_format"),parsed);$(this).val(formatted)}catch(exception){}var altFieldSelector="#"+$(this).data("field");if($(altFieldSelector).exists()){$(this).datepicker("option","altField",altFieldSelector);$(this).datepicker("option","altFormat",defaultDateFormat)}})}$(document).ready(function(){$.datepicker.regional.localized_datepicker={closeText:I18n.t("date.datepicker.close_text"),dayNamesMin:I18n.t("date.min_day_names"),prevText:I18n.t("date.datepicker.prev_text"),nextText:I18n.t("date.datepicker.next_text"),currentText:I18n.t("date.datepicker.current_text"),monthNames:I18n.t("date.month_names").slice(1),monthNamesShort:I18n.t("date.abbr_month_names").slice(1),dayNames:I18n.t("date.min_day_names"),dayNamesShort:I18n.t("date.abbr_day_names"),weekHeader:I18n.t("date.datepicker.week_header"),dateFormat:I18n.t("date.datepicker.date_format"),firstDay:firstDay,isRTL:isRTL,showMonthAfterYear:showMonthAfterYear,yearSuffix:I18n.t("date.datepicker.year_suffix")};$.datepicker.setDefaults($.datepicker.regional.localized_datepicker);$(".new_date_picker").datepicker({showOn:"both",buttonImage:"/images/calendar_date_select/calendar.gif",buttonImageOnly:true,showAnim:"slideDown",defaultDate:+7});$(".new_date_picker").keyup(function(e){if((e.keyCode==46||e.keyCode==8)&&$(this).data("clear-allowed")){$.datepicker._clearDate($(this))}});localizeCalendarDates()})}(window.jQuery,window.Zendesk));$z.defModule("shared/_help_container",{initialize:function(){$j("span.question-link").click(function(){$j(this).nextAll(".help-bubble").slideToggle(50)});$j("span.question-link img").hover(function(){$j(this).attr("src","/images/question-hover.png")},function(){$j(this).attr("src","/images/question.png")})}});zd.jsInitializers.push(["shared/_help_container",[]]);if(!Zendesk){Zendesk={}}if(!Zendesk.UI){Zendesk.UI={}}Zendesk.UI.MacroList={MAX_RESULTS:20,initialize:function(macros,macro_search_enabled,id){var self=this;self.root=$j(id);self.macro_search_enabled=macro_search_enabled;$j(document).bind("keydown","ctrl+m",self.toggle_macro_menu_with_key_combo());$j("form#ticket-chat").find("input,textarea,select").bind("keydown","ctrl+m",self.toggle_macro_menu_with_key_combo());$j(document).keydown(self.escape_close());if(macro_search_enabled){self.search_results=self.root.find("ul.search_results");self.nested_macros=self.root.find("ul.first-drop > li");self.root.data("cache",{"":{results:[],max_index:0}});self.root.data("full_results",$j.map(macros,function(macro,index){return(index)}));self.macros=macros;self.root.data("macro_list",self.root.find("ul.search_results li.search_result"));self.add_apply_macro();self.root.data("input",$j(id+"_search"));self.root.find("ul.drop-list li ul.first-drop div.search img.clear").click(function(event){self.clear()});self.root.find("ul.drop-list li ul.first-drop ul.search_results li.no_results div.explain p.try_again a.clear_search").click(function(event){self.clear()});self.root.data("input").bind("keydown",self.escape_clear()).bind("keyup change",self.on_text_changed(id,self.root.data("cache"),self.root.data("full_results"),macros,self.root.data("macro_list")));self.root.find("ul.drop-list > li").click(function(event){self.root.data("input").focus()});self.root.data("input").keydown(self.advance_on_key(38,-1)).keydown(self.advance_on_key(40,1)).keydown(self.select_with_enter())}},select_with_enter:function(){var self=this;return(function(event){var selection=self.search_results.data("selection");if(event.keyCode===13&&(selection!==undefined)){event.preventDefault();event.stopPropagation();self.root.data("macro_list").eq(selection).click()}})},advance_on_key:function(key_code,steps){var self=this;return(function(event){if(event.keyCode===key_code){event.stopPropagation();event.preventDefault();self.advance_selection(steps)}})},advance_selection:function(steps){var self=this;var search_term=(typeof(self.root.data("search_term"))!=="undefined")?self.root.data("search_term"):"";var cache=self.root.data("cache")[search_term];if(cache.results.length>0){steps%=cache.max_index;var selection_index=((typeof(self.search_results.data("selection_index"))==="undefined")?0:self.search_results.data("selection_index")+steps+cache.max_index)%cache.max_index;self.select(selection_index)}},select:function(selection_index){var self=this;var previous_selection=self.search_results.data("selection");var search_term=(typeof(self.root.data("search_term"))!=="undefined")?self.root.data("search_term"):"";var cached_results=self.root.data("cache")[search_term].results;if(typeof(previous_selection)!=="undefined"){self.root.data("macro_list").eq(previous_selection).removeClass("selected")}if(typeof(selection_index)==="number"&&selection_index>=0){self.search_results.data("selection_index",selection_index);self.search_results.data("selection",cached_results[selection_index]);self.root.data("macro_list").eq(cached_results[selection_index]).addClass("selected")}else{self.search_results.data("selection",null)}},toggle_macro_menu_with_key_combo:function(){var self=this;var menu=self.root.find("ul.first-drop");return(function(event){event.stopPropagation();event.preventDefault();if(menu.css("display")==="none"){self.open_macro_menu()}else{self.close_macro_menu()}})},close_macro_menu:function(){var self=this;self.root.find("ul.first-drop").hide();if(self.macro_search_enabled){self.clear()}},open_macro_menu:function(){var self=this;self.root.find("ul.first-drop").show();if(self.macro_search_enabled){self.root.data("input").focus()}},clear:function(){var self=this;self.root.data("input").val("");self.root.data("input").change()},escape_close:function(){var self=this;return(function(event){if(event.keyCode===27){self.close_macro_menu()}})},escape_clear:function(){var self=this;return(function(event){if(event.keyCode===27){event.preventDefault();if($j.trim($j(this).val())!==""){event.stopPropagation();self.clear()}}})},on_text_changed:function(id,cache,full_results,macros,macro_list){var self=this;var no_results=self.root.find("ul.search_results li.no_results");var display_term=no_results.find("span.search_term");var search_img=self.root.find("ul.drop-list li ul.first-drop div.search img.search");var clear_img=self.root.find("ul.drop-list li ul.first-drop div.search img.clear");var highlight=function(index,regex){return(macros[index].label.replace(regex,'<span class="highlight">$1</span>'))};var update_macro=function(index,new_html){macro_list.eq(index).find(" > a").html(new_html)};return(function(event){var previous_search_term=(typeof(self.root.data("search_term"))!=="undefined")?self.root.data("search_term"):"";var previous_cache=cache[previous_search_term];var search_term=$j.trim($j(this).val());self.root.data("search_term",search_term);var cachify=function(superset,hide_previous_results){if(typeof(hide_previous_results)==="undefined"){hide_previous_results=false}var regex_escaped_search_term=$j.ui.autocomplete.escapeRegex(search_term);var regex=RegExp(regex_escaped_search_term,"i");var highlight_regex=RegExp("("+regex_escaped_search_term+")","gi");var highlighted;var superset_index=0;var subset=[];var highlights=[];if(hide_previous_results){for(var i=0;i<previous_cache.max_index;i++){macro_list.eq(previous_cache.results[i]).hide()}for(;subset.length<self.MAX_RESULTS&&superset_index<superset.length;superset_index++){if(macros[superset[superset_index]].label!==(highlighted=highlight(superset[superset_index],highlight_regex))){subset.push(superset[superset_index]);highlights.push(highlighted);update_macro(superset[superset_index],highlighted);macro_list.eq(superset[superset_index]).show()}}}else{for(;subset.length<self.MAX_RESULTS&&superset_index<superset.length;superset_index++){if(macros[superset[superset_index]].label===(highlighted=highlight(superset[superset_index],highlight_regex))){macro_list.eq(superset[superset_index]).hide()}else{subset.push(superset[superset_index]);highlights.push(highlighted);update_macro(superset[superset_index],highlighted);macro_list.eq(superset[superset_index]).show()}}for(;superset[superset_index]<previous_cache.results[previous_cache.max_index];superset_index++){macro_list.eq(superset[superset_index]).hide();if(regex.test(macros[superset[superset_index]].label)){subset.push(superset[superset_index])}}}for(;superset_index<superset.length;superset_index++){if(regex.test(macros[superset[superset_index]].label)){subset.push(superset[superset_index])}}cache[search_term]={max_index:Math.min.apply(Math,[subset.length,self.MAX_RESULTS]),regex:regex,results:subset,highlights:highlights}};if(search_term!==previous_search_term){if(search_term.length===0){clear_img.hide();search_img.show();self.search_results.hide();self.nested_macros.show();for(var i=0;i<previous_cache.max_index;i++){macro_list.eq(previous_cache.results[i]).hide()}}else{if(previous_search_term.length===0){search_img.hide();clear_img.show();self.nested_macros.hide();self.search_results.show()}var previous_index=0,current_index=0;if(previous_search_term.length>0&&search_term.length>previous_search_term.length&&previous_cache.regex.test(search_term)){if(typeof(cache[search_term])==="object"&&cache[search_term].max_index>0){if(previous_cache.results[previous_cache.max_index-1]<cache[search_term].results[cache[search_term].max_index-1]){for(;previous_index<previous_cache.max_index;previous_index++){if(previous_cache.results[previous_index]<cache[search_term].results[current_index]){macro_list.eq(previous_cache.results[previous_index]).hide()}else{update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);current_index++}}for(;current_index<cache[search_term].max_index;current_index++){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);macro_list.eq(cache[search_term].results[current_index]).show()}}else{for(;cache[search_term].results[current_index]<=previous_cache.results[previous_cache.max_index-1];current_index++){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);for(;previous_cache.results[previous_index]<cache[search_term].results[current_index];previous_index++){macro_list.eq(previous_cache.results[previous_index]).hide()}if(previous_cache.results[previous_index]===cache[search_term].results[current_index]){previous_index++}}for(;previous_index<previous_cache.max_index;previous_index++){macro_list.eq(previous_cache.results[previous_index]).hide()}}}else{cachify(previous_cache.results,false)}}else{if(typeof(cache[search_term])==="object"){for(previous_index=0,current_index=0;previous_index<previous_cache.max_index&&current_index<cache[search_term].max_index;){if(previous_cache.results[previous_index]<cache[search_term].results[current_index]){macro_list.eq(previous_cache.results[previous_index]).hide();previous_index++}else{if(previous_cache.results[previous_index]>cache[search_term].results[current_index]){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);macro_list.eq(cache[search_term].results[current_index]).show();current_index++}else{update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);current_index++;previous_index++}}}if(previous_index===previous_cache.max_index){for(;current_index<cache[search_term].max_index;current_index++){update_macro(cache[search_term].results[current_index],cache[search_term].highlights[current_index]);macro_list.eq(cache[search_term].results[current_index]).show()}}if(current_index===cache[search_term].max_index){for(;previous_index<previous_cache.max_index;previous_index++){macro_list.eq(previous_cache.results[previous_index]).hide()}}}else{cachify(full_results,true)}}if(cache[search_term].results.length>0){self.select(0);if(previous_cache.results.length===0){no_results.hide()}}else{self.select();display_term.html(search_term);if(previous_cache.results.length>0||previous_search_term.length===0){no_results.show()}}}}})},add_apply_macro:function(index){var self=this;self.root.find("ul.search_results li.search_result").each(function(index,element){var case_id=self.macros[index].value;if(Number(case_id)>=0){$j(element).click(function(event){var ticketForm=$j("#ticket-chat");if(typeof(ticket_id)==="undefined"){var this_id=0}else{var this_id=ticket_id}if(jQuery("#tickets_to_bulk_update",ticketForm).length>0){new Zendesk.API.Macro(case_id).applyToTicket(null,ticketForm)}else{new Zendesk.API.Macro(case_id).applyToTicket(this_id,ticketForm)}$j(this).fadeOut("fast").fadeIn("fast",function(){self.clear();self.root.find("ul.drop-list li ul.first-drop").hide()})})}})}};$z.defModule("shared/_macro_list",{initialize:function(macros,macroSearchEnabled,id){Zendesk.UI.MacroList.initialize(macros,macroSearchEnabled,id)}});(function($,Zendesk){var container,links,linksContainer,contentContainers,sharedContent;function selectTab(link){var otherLinks=links.not(link);var tabID=link.attr("href");var newlySelectedTab=contentContainers.filter(tabID);var otherTabs=contentContainers.not(newlySelectedTab);otherLinks.removeClass("current");otherTabs.hide();link.addClass("current");newlySelectedTab.trigger("tab.show");newlySelectedTab.show();sharedContent.forceRedraw()}function selectInitialTab(){$.history.init(function(hash){var tab=links.filter('[href="#'+hash+'"]');if(tab.length===0){tab=links.first()}selectTab(tab)})}function addHandlers(){$(window).bind("popstate:tabs",function(event){selectInitialTab()});links.click(function(event){var hash=$(this).attr("href").replace(/^.*#/,"");$.history.load(hash);event.preventDefault()})}function init(root){container=$(root||".tabbed_container");links=$(".tab_links a",container);linksContainer=$(".tab_links",container);contentContainers=$(".tabs_content .tabs_canvas > div",container);sharedContent=$(".tabs_content .tabs_canvas",container).siblings();addHandlers();selectInitialTab()}Zendesk.NS.extend("TabbedContainer",{init:function(root){init(root)},destroy:function(){$(window).unbind("popstate:tabs")}});$(document).ready(function(){if($("div.tabbed_container[mode!='static']").length>0){Zendesk.TabbedContainer.init()}})}(window.jQuery,window.Zendesk));Zendesk.TabbedContainer.SammyApp=function(options){options=options||{};this.options=options;this.container=options.root||".sammy_tabbed_container";this.links=$j(".tab_links a",this.container);this.contentContainers=$j(".tabs_content .tabs_canvas > div",this.container);this.app=this._createSammyApp();this.PATH_NAME_MATCHER=/:([\w\d]+)/g;this.PATH_REPLACER="([^/]+)"};Zendesk.TabbedContainer.SammyApp.prototype={init:function(){this.app.disable_push_state=true;this.app.run()},extractParams:function(path,pathParams,paramNames){var self=this,params={};$j.each(pathParams,function(i,param){if(paramNames[i]){params[paramNames[i].slice(1)]=self._decode(param)}else{if(!params.splat){params.splat=[]}params.splat.push(self._decode(param))}});return params},selectTab:function(tab){var id="#"+tab,link=this.links.filter('[href="'+id+'"]');if(link.length===0||(link.hasClass("current"))){return}this.links.removeClass("current");link.addClass("current");this.contentContainers.hide().filter(id).show()},_createSammyApp:function(){var self=this;return $j.sammy(this.container,function(app){this.helpers({matchPath:function(path,routePath){var paramNames=routePath.match(self.PATH_NAME_MATCHER)||[],pathParams;routePath=new RegExp(routePath.replace(self.PATH_NAME_MATCHER,self.PATH_REPLACER)+"$");if(!(pathParams=path.match(routePath))){return}return self.extractParams(path,pathParams.slice(1),paramNames)}});this.get(/\#([\w\d]*)[\/]?(.*)/,function(){var subPath=this.params.splat[1],tabID=this.params.splat[0];self.selectTab(tabID);this.trigger("tab.change",{tabID:tabID,path:this.path,subPath:subPath})});this.get("",function(){app.setLocation(self.links.first().attr("href"))})})},_decode:function(str){return decodeURIComponent((str||"").replace(/\+/g," "))}};$z.defModule("shared/_tickets_table",{initialize:function(){$j("input.tickets_to_bulk_update").enableCheckboxRangeSelection()}});(function($){$.fn.enableCheckboxRangeSelection=function(){var lastCheckbox=null;var $spec=this;$spec.unbind("click.checkboxrange");$spec.bind("click.checkboxrange",function(e){if(lastCheckbox!=null&&(e.shiftKey||e.metaKey)){$spec.slice(Math.min($spec.index(lastCheckbox),$spec.index(e.target)),Math.max($spec.index(lastCheckbox),$spec.index(e.target))+1).attr({checked:e.target.checked?"checked":""})}lastCheckbox=e.target})}})(jQuery);zd.jsInitializers.push(["shared/_tickets_table",[]]);$z.defModule("tabindex",{addtabindexes:function(){var args=Array.prototype.slice.call(arguments);var tabindex=args.slice(-1)[0];if(typeof(tabindex)==="number"){args.pop()}else{tabindex=1}$j(args).each(function(index,selector){$j(selector).each(function(index,element){$j(element).attr({tabindex:tabindex++})})})}});$z.defModule("tags/show",{initialize:function(){},showTagJobStatus:function(request){var job=request.responseJSON;var jobStatus=new Zendesk.JobStatus(job.status_url,{title:I18n.t("txt.js.tags.processing_tags"),renderResult:function(jobStatus){var output={title:""+I18n.t("txt.js.tags.processed_tags",{number:jobStatus.results.total}),body:$j("<ul/>")};if(jobStatus.status==="completed"){document.location="/tags/bulk_result?background="+jobStatus.job.id}return output}})}});$z.defModule("ticket_fields/_list_for_index",{initialize:function(params){$j("a.cancel-sorting").click(function(event){Ordering.cancelOrdering("div#fields")})}});$z.defModule("ticket_fields/_field_tagger",{initialize:function(options){var self=$z("ticket_fields/_field_tagger");$j("fieldset.conditions a").live("click",function(event){event.preventDefault();$j(this).closest("fieldset.conditions").remove();return false});$j(".customFieldName").live("blur",function(){var valueField=$j(this).closest("fieldset.conditions").find(".customFieldValue");if(valueField.val()===""){var nameToValue=$j(this).val().replace(/[^A-Za-z0-9]+/g,"_").toLowerCase();valueField.val(nameToValue)}});$j("fieldset.conditions.add").click(function(event){event.preventDefault();self.insertOptionRow("","","");return false});options&&options.each(function(field){self.insertOptionRow(field)})},insertOptionRow:function(field){var self=$z("ticket_fields/_field_tagger");field.index=self._nextIndex();var newOptionRow=$j.mustache(self.optionRowTemplate(),field);self.optionsContainer().append(newOptionRow)},optionsContainer:function(){return $j("#optionsContainer")},optionRowTemplate:function(){var self=$z("ticket_fields/_field_tagger");if(self._optionRowTemplate){return self._optionRowTemplate}self._optionRowTemplate=$j("#custom-field-fieldset-template").html();return self._optionRowTemplate},_nextIndex:function(){this._nextFieldsetIndex=(this._nextFieldsetIndex||-1)+1;return this._nextFieldsetIndex}});$z.defModule("tickets/_editable_notes",{initialize:function(field,url){button=$j("#"+field+"-submit");button.click(function(event){data=$j("#"+field+"-form").serialize();data._method="put";jQuery.post(url,data);InputTracking.trackedElements=[]});$j("#"+field+"-link-show").click(function(){$j("div#"+field+"-edit").toggle();$j("div#"+field+"-show").toggle()})}});$z.defModule("tickets/_user_details",{initialize:function(user_id){$j.ajax({url:"/monitor/children/find_for_user?user_id="+user_id,dataType:"json",success:$j.proxy(function(data){if(data.length>0){this.buildAccountList(data)}},this)})},buildAccountList:function(accounts){var output=$j("#account-stats");var list=$j("#account-stats-list");var link,item;accounts.each($j.proxy(function(account){item=$j("<li>").addClass("link");link=$j("<a>",{href:"/monitor/children/show/"+account.id,html:"<b>"+account.name+"</b> ("+account.max_agents+" agents on "+account.plan+")"});link.appendTo(item);item.appendTo(list)},this));output.show()}});Zendesk.NS("Ticket",function(){this.CommentDrafts=function(niceID,userID,commentSelector,commentPrivacySelector){this.niceID=niceID;this.userID=userID;this.key="drafts/"+this.niceID+"/"+this.userID;this.timestampKey=this.key+"/ts";this.privacyKey=this.key+"/privacy";this.translatedVersion=this.key+"/translated";this.translatedHash=this.key+"/translatedHash";this.commentSelector=commentSelector;this.commentPrivacySelector=commentPrivacySelector;this.translationSelector="#translated_flag";this._keyHandler=_.debounce(this._keyHandler,300)};this.CommentDrafts.STALE_TIMEOUT_SECONDS=8*60*60;this.CommentDrafts.prototype={clear:function(){if(!Zendesk.Storage.isSupported()){return}this.localStorage=Zendesk.Storage.handle();return this._clear()},startWatching:function(){if(!Zendesk.Storage.isSupported()){return}this.localStorage=Zendesk.Storage.handle();this.commentInput=$j(this.commentSelector);this.commentPrivacyInput=$j(this.commentPrivacySelector);this.translationLink=jQuery(this.translationSelector);if(this._isStale()){this._clear()}var savedComment=this._load();if(savedComment.comment){this.comment=savedComment.comment;this.commentInput.val(this.comment);this._renderDraftNotification(I18n.t("comment_draft.recovered_a_comment_from_draft"))}else{this.comment=this.commentInput.val()}if(savedComment.commentPrivacy){this.commentPrivacy=savedComment.commentPrivacy;this.commentPrivacyInput.prop("checked",this.commentPrivacy==="public").change()}else{this.commentPrivacy=this.commentPrivacyInput.prop("checked")?"public":"private"}this._bindEvents()},_bindEvents:function(){$j(this.commentInput).keyup($j.proxy(function(e){this._keyHandler(e)},this));var proxiedHandler=$j.proxy(function(e){this._updateDraftFromDom(e)},this);$j(this.commentInput).change(proxiedHandler);$j(document).bind("applied.macro.zendesk",proxiedHandler);$j(this.commentPrivacyInput).change(proxiedHandler);$j(this.translationLink).bind("saveTranslated",proxiedHandler)},_keyHandler:function(evt){this._updateDraftFromDom(evt)},_updateDraftFromDom:function(event){var privacy=(this.commentPrivacyInput.prop("checked")?"public":"private");if((this.comment!=this.commentInput.val())||(this.commentPrivacy!=privacy)){if(!$j(event.target).is(this.commentPrivacyInput)){this._renderDraftSaveNotification()}this._store(this.commentInput.val(),privacy)}},_renderDraftSaveNotification:function(){var message=I18n.t("txt.public.javascript.views.tickets.comment_drafts.comment_draft_saved");var displayed_message=message+' (<abbr id="draft_timestamp" title="'+this._iso8601Timestamp(new Date())+'"></abbr>)';this._renderDraftNotification(displayed_message);$j("#draft_timestamp").timeago()},_store:function(str,privacy){this.comment=str;this.commentPrivacy=privacy;this.localStorage.setItem(this.timestampKey,(new Date()).toString());this.localStorage.setItem(this.privacyKey,this.commentPrivacy);if(jQuery("#translated_flag").exists()&&jQuery("#translated_flag").val()=="true"){this.localStorage.setItem(this.translatedVersion,this.comment)}else{this.localStorage.setItem(this.key,this.comment)}},_renderDraftNotification:function(message){this.commentInput.css({backgroundPosition:"bottom center"});if($j("#draft_status").length===0){this.commentInput.after('<div id="draft_status"></div>')}$j("#draft_status").html(message)},_zeropad:function(num){return((num<10)?"0":"")+num},_iso8601Timestamp:function(date){return date.getUTCFullYear()+"-"+this._zeropad(date.getUTCMonth()+1)+"-"+this._zeropad(date.getUTCDate())+"T"+this._zeropad(date.getUTCHours())+":"+this._zeropad(date.getUTCMinutes())+":"+this._zeropad(date.getUTCSeconds())+"Z"},_load:function(){return{comment:this.localStorage.getItem(this.key),commentPrivacy:this.localStorage.getItem(this.privacyKey)}},_clear:function(){this.localStorage.removeItem(this.key);this.localStorage.removeItem(this.timestampKey);this.localStorage.removeItem(this.privacyKey)},_isStale:function(){var timestamp=this.localStorage.getItem(this.timestampKey);if(!timestamp){return false}var curTime=(new Date()).getTime();timestamp=new Date(timestamp).getTime();return(curTime-timestamp)>Zendesk.Ticket.CommentDrafts.STALE_TIMEOUT_SECONDS*1000}}});(function($j){$j.widget("zd.ticketTagger",{_create:function(){var fieldID=this.element.data("field-id");this.$input=this.element.parent().find("#ticket_fields_"+fieldID);this.$output=this.element.find("#title-tagger-"+fieldID);this._addBindings()},val:function(newValue){if(arguments.length===1){this.$input.val(newValue).change();return this}else{return this.$input.val()}},_addBindings:function(){var widget=this;this.element.delegate("li.link","click.ticketTagger",function(){widget.$input.val($j(this).data("value")).trigger("change.ticketTagger");selection_feedback($(this));return false});this.$input.bind("change.ticketTagger",function(event,source){var $li=widget._findLIByValue($j(this).val());widget.$output.html($li.data("full-title"))})},_findLIByValue:function(value){return this.element.find('li.link[data-value="'+value+'"]')}});$j(".field-tagger").ticketTagger()}(jQuery));function IncidentsWarning(){this._registerEvents()}IncidentsWarning.instance=null;IncidentsWarning.getInstance=function(){if(IncidentsWarning.instance==null){IncidentsWarning.instance=new IncidentsWarning()}return IncidentsWarning.instance};IncidentsWarning.prototype={confirmed:false,isShowingWarning:function(){var self=this;if($j("#associated_incidents_warning").length!=0&&self._updating()&&self._solving()&&self._addingPublicComment()&&!self.confirmed){$j.colorbox({inline:true,href:"#associated_incidents_warning"});return true}else{return false}},_registerEvents:function(){var self=this;$j("#confirm_incidents_warning").click(function(event){$j.colorbox.close();self.confirmed=true;submitTicketForm()});$j("#cancel_incidents_warning").click(function(event){$j.colorbox.close()})},_updating:function(){var type=$j("#submit_type").val();return type==""||type=="macro"||type=="entry"},_solving:function(){return $j("#ticket_status_id").val()=="3"},_addingPublicComment:function(){return $j.trim($j("#comment_value").val()).length!=0&&$j("#comment_is_public").is(":checked")}};$j(function(){var jiraElement=$j("#jira_details");if(jiraElement.length){var ticketID=jiraElement.data("ticketid");$j.ajax({url:"/tickets/"+ticketID+"/jira_ticket_details"}).done(function(jira){jira=$j.makeArray(jira)[0];var resolution=(jira.RESOLUTION||" - ");var assignee=(jira.ASSIGNEE||" - ");var string="<ul>";string=string+"<li><strong>Issue ID</strong>: <a href="+jira.URL+">"+jira.KEY+"</a></li>";string=string+"<li><strong>Resolution</strong>: "+resolution+"</li>";string=string+"<li><strong>Assignee</strong>: "+assignee+"</li>";string=string+"</ul>";$j("#jira_ticket #jira_details").html(string)}).fail(function(){$j("#jira_ticket #jira_details").html("Unable to retrieve issue details from JIRA.")})}});jQuery(function($){var projectIDElm,projectID,projectOptions,issueIDElm,issueOptions,projectIssues,jiraProjects;var selectedAgreementElm,jiraAgreementIDs,agreementID;var agreementIDElm=$("#ticket_agreement_id");if(!agreementIDElm.length){return}projectIDElm=$("#jira_project_id");issueIDElm=$("#issue_type_id");jiraProjects={};function isJiraAgreementSelected(agreementID){jiraAgreementIDs=agreementIDElm.data("jira-agreement-ids");return($.inArray(agreementID,jiraAgreementIDs)!==-1)}function updateIssues(){if(!jiraProjects){return}projectID=$("#jira_project_id option:selected").val();if(!projectID){return}issueOptions="";projectIssues=jiraProjects[projectID].issueTypes;for(var issue in projectIssues){if(projectIssues.hasOwnProperty(issue)){issueOptions+='<option value="'+projectIssues[issue].id+'">'+projectIssues[issue].name+"</option>"}}issueIDElm.html(issueOptions)}function updateProjects(){projectOptions="";for(var project in jiraProjects){if(jiraProjects.hasOwnProperty(project)){projectOptions+='<option value="'+project+'">'+jiraProjects[project].name+"</option>"}}projectIDElm.html(projectOptions)}function getJIRAInfo(){if(!jiraProjects){return}$.ajax({url:"/sharing_agreements/"+agreementID+"/jira_projects"}).done(function(data){data.each(function(project){jiraProjects[project.id]=project});updateProjects();updateIssues()}).fail(function(){$("#jira_projects").html("Unable to load projects from JIRA");$("#jira_issues").html("Unable to load issues types from JIRA")})}function showColorbox(){$.colorbox({width:"550px",inline:true,href:"#jira_sharing_options",onComplete:getJIRAInfo,onLoad:function(){$("#cboxClose").remove()},overlayClose:false,escKey:false})}function saveAndClose(){$.colorbox.close()}function clearOptions(){projectIDElm.val("");issueIDElm.val("");$("#jira_issue_key").val("")}function agreementChanged(e){agreementID=parseInt(e.target.value,10);if(isJiraAgreementSelected(agreementID)){showColorbox()}else{clearOptions()}}function cancel(){clearOptions();$.colorbox.close()}$("#jira_sharing_options a").click(function(event){event.preventDefault()});$("#cancel_jira_sharing_options").click(cancel);$("#save_jira_sharing_options").click(saveAndClose);agreementIDElm.change(agreementChanged);projectIDElm.change(updateIssues)});function NewUserFromTicket(){this.registerEvents()}NewUserFromTicket.prototype={type:null,registerEvents:function(){var self=this;self.link().click(function(){self.type=$j(this).attr("data-type");$j.colorbox({href:$j(this).attr("href"),onComplete:function(){self.emailField().focus()}});return false});self.form().live("submit",function(){var email=$j.trim(self.emailField().val());if(email===""){alert(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.please_enter_an_email_address_new_user"));self.emailField().focus()}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),beforeSend:function(request){self.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.creating")).prop("disabled",true)},success:function(response){var value=null;if(response.email!=null&&response.email!==""){value=response.name+" <"+response.email+">"}if(self.type==="requester"){$j("#ticket_requester_name").val(value);$j("#ticket_requester_name").effect("highlight",{},3000)}else{collaboratorsInput.addEntry(response.id,value);$j("div#edit_cc li[choice_id="+response.id+"]").effect("highlight",{},3000)}$j.colorbox.close()},error:function(request,textStatus,errorThrown){self.submitButton().val(I18n.t("txt.public.javascripts.views.tickets.new_user_from_ticket.create")).prop("disabled",false);if(request.responseText.include("The organization")){self.organizationField().focus();new Effect.Highlight(self.organizationField().attr("id"),{duration:3})}else{self.emailField().focus();new Effect.Highlight(self.emailField().attr("id"),{duration:3})}}})}return false})},link:function(){return $j("a.new_user_from_ticket")},form:function(){return $j("#new_user_form")},emailField:function(){return this.form().find("#user_email")},organizationField:function(){return this.form().find("#user_organization_name")},submitButton:function(){return this.form().find("input[type='submit']")}};var hexcase=0;var b64pad="";function hex_md5(s){return rstr2hex(rstr_md5(str2rstr_utf8(s)))}function b64_md5(s){return rstr2b64(rstr_md5(str2rstr_utf8(s)))}function any_md5(s,e){return rstr2any(rstr_md5(str2rstr_utf8(s)),e)}function hex_hmac_md5(k,d){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)))}function b64_hmac_md5(k,d){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)))}function any_hmac_md5(k,d,e){return rstr2any(rstr_hmac_md5(str2rstr_utf8(k),str2rstr_utf8(d)),e)}function md5_vm_test(){return hex_md5("abc").toLowerCase()=="900150983cd24fb0d6963f7d28e17f72"}function rstr_md5(s){return binl2rstr(binl_md5(rstr2binl(s),s.length*8))}function rstr_hmac_md5(key,data){var bkey=rstr2binl(key);if(bkey.length>16){bkey=binl_md5(bkey,key.length*8)}var ipad=Array(16),opad=Array(16);for(var i=0;i<16;i++){ipad[i]=bkey[i]^909522486;opad[i]=bkey[i]^1549556828}var hash=binl_md5(ipad.concat(rstr2binl(data)),512+data.length*8);return binl2rstr(binl_md5(opad.concat(hash),512+128))}function rstr2hex(input){try{hexcase}catch(e){hexcase=0}var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var output="";var x;for(var i=0;i<input.length;i++){x=input.charCodeAt(i);output+=hex_tab.charAt((x>>>4)&15)+hex_tab.charAt(x&15)}return output}function rstr2b64(input){try{b64pad}catch(e){b64pad=""}var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var output="";var len=input.length;for(var i=0;i<len;i+=3){var triplet=(input.charCodeAt(i)<<16)|(i+1<len?input.charCodeAt(i+1)<<8:0)|(i+2<len?input.charCodeAt(i+2):0);for(var j=0;j<4;j++){if(i*8+j*6>input.length*8){output+=b64pad}else{output+=tab.charAt((triplet>>>6*(3-j))&63)}}}return output}function rstr2any(input,encoding){var divisor=encoding.length;var i,j,q,x,quotient;var dividend=Array(Math.ceil(input.length/2));for(i=0;i<dividend.length;i++){dividend[i]=(input.charCodeAt(i*2)<<8)|input.charCodeAt(i*2+1)}var full_length=Math.ceil(input.length*8/(Math.log(encoding.length)/Math.log(2)));var remainders=Array(full_length);for(j=0;j<full_length;j++){quotient=Array();x=0;for(i=0;i<dividend.length;i++){x=(x<<16)+dividend[i];q=Math.floor(x/divisor);x-=q*divisor;if(quotient.length>0||q>0){quotient[quotient.length]=q}}remainders[j]=x;dividend=quotient}var output="";for(i=remainders.length-1;i>=0;i--){output+=encoding.charAt(remainders[i])}return output}function str2rstr_utf8(input){var output="";var i=-1;var x,y;while(++i<input.length){x=input.charCodeAt(i);y=i+1<input.length?input.charCodeAt(i+1):0;if(55296<=x&&x<=56319&&56320<=y&&y<=57343){x=65536+((x&1023)<<10)+(y&1023);i++}if(x<=127){output+=String.fromCharCode(x)}else{if(x<=2047){output+=String.fromCharCode(192|((x>>>6)&31),128|(x&63))}else{if(x<=65535){output+=String.fromCharCode(224|((x>>>12)&15),128|((x>>>6)&63),128|(x&63))}else{if(x<=2097151){output+=String.fromCharCode(240|((x>>>18)&7),128|((x>>>12)&63),128|((x>>>6)&63),128|(x&63))}}}}}return output}function str2rstr_utf16le(input){var output="";for(var i=0;i<input.length;i++){output+=String.fromCharCode(input.charCodeAt(i)&255,(input.charCodeAt(i)>>>8)&255)}return output}function str2rstr_utf16be(input){var output="";for(var i=0;i<input.length;i++){output+=String.fromCharCode((input.charCodeAt(i)>>>8)&255,input.charCodeAt(i)&255)}return output}function rstr2binl(input){var output=Array(input.length>>2);for(var i=0;i<output.length;i++){output[i]=0}for(var i=0;i<input.length*8;i+=8){output[i>>5]|=(input.charCodeAt(i/8)&255)<<(i%32)}return output}function binl2rstr(input){var output="";for(var i=0;i<input.length*32;i+=8){output+=String.fromCharCode((input[i>>5]>>>(i%32))&255)}return output}function binl_md5(x,len){x[len>>5]|=128<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd)}return Array(a,b,c,d)}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)}function md5_ff(a,b,c,d,x,s,t){return md5_cmn((b&c)|((~b)&d),a,b,x,s,t)}function md5_gg(a,b,c,d,x,s,t){return md5_cmn((b&d)|(c&(~d)),a,b,x,s,t)}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|(~d)),a,b,x,s,t)}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&65535)}function bit_rol(num,cnt){return(num<<cnt)|(num>>>(32-cnt))}var TicketForm=function(){};TicketForm.prototype={_cacheFollowing:function(mth,requester,value){TicketForm.twitterFollowingCache=TicketForm.twitterFollowingCache||{};var cache=TicketForm.twitterFollowingCache;var cacheKey=[mth.screenName,requester.screenName].join(",");if(value!==undefined){return cache[cacheKey]=value}else{return cache[cacheKey]}},isFollowing:function(mth,requester){var self=this;var cached=this._cacheFollowing(mth,requester);if(cached!==undefined){jQuery("#comment_channel_back option[value='dm']").prop("disabled",(cached!==true));return}jQuery.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+mth.id+"/1/friendships/exists.json",data:{screen_name_a:requester.screenName,screen_name_b:mth.screenName},type:"GET",success:function(data){self.isFollowingCallback(data,mth,requester)}})},isFollowingCallback:function(data,mth,requester){var following=data;this._cacheFollowing(mth,requester,following);jQuery("#comment_channel_back option[value='dm']").prop("disabled",following!==true)},updateBalloon:function(){var checkbox=jQuery("#comment_is_public");var balloon=jQuery("#comment_type");if(checkbox.attr("checked")){balloon.removeClass("private");balloon.addClass("public")}else{balloon.removeClass("public");balloon.addClass("private")}},hidePreviewComment:function(){var self=this;var checkbox=jQuery("#comment_is_public");var preview=jQuery("#preview_translated_comment");var warning=jQuery("#warning_gist_translation");if(jQuery("#tickets_to_bulk_update").exists()){preview.hide();warning.hide()}else{if(checkbox.attr("checked")){preview.show("fast");warning.show("fast")}else{preview.hide("fast");warning.hide("fast");if(jQuery("#translated_flag").val()=="true"){self.revertToOriginalMessage()}}}},previewComment:function(locale){var locale=locale;var self=this;jQuery("#preview_translated_comment").click(locale,function(event){var local_storage_md5_key="drafts/"+ticket_id+"/"+currentUser.id+"/translatedHash";var local_storage_translated_key="drafts/"+ticket_id+"/"+currentUser.id+"/translated";if(jQuery("#translated_flag").val()=="false"){var saved_md5_hash=localStorage.getItem(local_storage_md5_key);var comment=jQuery("textarea#comment_value").val();var comment_value=jQuery.trim(comment);var new_md5_hash=hex_md5(comment_value);if((saved_md5_hash===null)||(saved_md5_hash!==new_md5_hash)){self.getTranslationOfComment(locale,local_storage_md5_key,comment,new_md5_hash)}else{var saved_translated_value=localStorage.getItem(local_storage_translated_key);jQuery("#translated_flag").val("true");jQuery("textarea#comment_value").val(saved_translated_value);jQuery("#preview_translated_comment").text(I18n.t("ticket_form.translate_comment.revert_to_my_language_v2"))}}else{self.revertToOriginalMessage()}})},getTranslationOfComment:function(locale,local_storage_md5_key,comment,new_md5_hash){var url=currentAccount.secureUrlPrefix+"/tickets/get_translated_comment?callback=?";var comment_value=comment;var md5hash_comment=new_md5_hash;$j.getJSON(url,{body:comment_value,locale:locale},function(data){var translated_comment=data.comment_body;localStorage.setItem(local_storage_md5_key,md5hash_comment);jQuery("textarea#comment_value").val(translated_comment);jQuery("#translated_flag").val("true");jQuery("#translated_flag").trigger("saveTranslated");jQuery("#preview_translated_comment").text(I18n.t("ticket_form.translate_comment.revert_to_my_language_v2"))})},revertToOriginalMessage:function(){revert=localStorage.getItem("drafts/"+ticket_id+"/"+currentUser.id);jQuery("textarea#comment_value").val(revert);jQuery("#translated_flag").val("false");jQuery("#preview_translated_comment").text(I18n.t("ticket_form.translate_comment.preview_my_comment_v2"))},updateTwitterControls:function(){var checkbox=jQuery("#comment_is_public");var controls=jQuery("#twitter_controls");(checkbox.attr("checked"))?controls.show():controls.hide()},updateTwitterCounter:function(){var checkbox=jQuery("#comment_is_public");var counter=jQuery("#charcounter");var channel=jQuery("#comment_channel_back").val();var dm=jQuery("#comment_channel_back_dm");counter.toggle(checkbox.is(":checked")&&(channel=="1"||channel=="dm"))},updateMthSelector:function(){var checkbox=jQuery("#comment_is_public");var selector=jQuery("#monitored_twitter_handle_selection");(checkbox.attr("checked"))?selector.show():selector.hide()},bindEditRequesterLink:function(){$j("#edit_requester_link a").bind("click",function(event){$j("#edit_requester").show();$j("#dynamic_requester").hide();$j("#static_requester").show();$j("#edit_requester_link").hide();return false})},bindCheckbox:function(){var self=this;jQuery("#comment_is_public").change(function(){self.updateBalloon();self.updateMthSelector();self.updateTwitterControls();self.updateTwitterCounter();self.hidePreviewComment()})},bindRadioButtons:function(){var self=this;jQuery('#twitter_controls input[type="radio"]').click(function(){self.updateTwitterCounter()})}};function TicketMergeWizard(){this.url="/merge/new?source_ids="+this.sources()+"&unchecked="+this.unchecked();this.registerEvents();this.show()}TicketMergeWizard.prototype={url:null,registerEvents:function(){var self=this;self.winnerLinks().live("click",function(e){$j("#target_id").val($j(this).data("target-id"));self.winnerForm().submit();return false});$j(document).bind("cbox_closed",function(){$j("#submit-button").val("Submit").prop("disabled",false)})},show:function(){var self=this;$j.colorbox({href:this.url,onComplete:function(){if(self.loaded){return}self.winnerForm().submit(function(){var niceId=$j.trim($j("#target_id").val());if(niceId===""){alert("Please enter a ticket ID")}else{$j.ajax({type:$j(this).attr("method"),data:$j(this).serialize(),url:$j(this).attr("action"),success:function(response){$j.colorbox({html:response});self.appendComment()},error:function(request,textStatus,errorThrown){$j.colorbox({html:request.responseText})}})}return false})}})},appendComment:function(){if($j.trim($j("#comment_value").val())!==""){var text="\n\nComment during merge: "+$j("#comment_value").val();$j("#target_comment").append(text);$j("#source_comment").append(text)}},sources:function(){if($j("#ticket-chat").attr("data-ticket")!==undefined){return $j("#ticket-chat").attr("data-ticket")}else{return this.checked()}},checked:function(){return this.values("input.tickets_to_bulk_update:checked")},unchecked:function(){return this.values("input.tickets_to_bulk_update:not(:checked)")},values:function(filter){var array=[];$j(filter).each(function(){array.push($j(this).val())});return array.join(",")},winnerForm:function(){return $j("#merge_form")},winnerField:function(){return this.winnerForm().find("input[type='text']")},continueButton:function(){return this.winnerForm().find("input[type='submit']")},winnerLinks:function(){return $j(".winner_selector")}};$z.defModule("tickets/new",{initialize:function(){$j("input#ticket_requester_name").focus();$z("tabindex").addtabindexes("input#ticket_requester_name","#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags],form#ticket-chat div.selects div.select > select[readonly != readonly],form#ticket-chat div.selects div.select > textarea[readonly != readonly]","textarea#comment_value","#ticket_tags",".selects .multi_value_field .search_field_item input","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect()}new NewUserFromTicket();if(currentUser&&currentUser.isAgent){Zendesk.Instrumentation.ToTango.trackOperatingSystem()}}});$z.defModule("tickets/show",{initialize:function(){$j("textarea#comment_value").focus();$z("tabindex").addtabindexes("#edit_cc input","form#ticket-chat div.selects div.select > input[readonly != readonly][attribute_name != additional_tags], form#ticket-chat div.selects div.select > select[readonly != readonly], form#ticket-chat div.selects div.select > textarea[readonly != readonly]","#ticket_tags",".selects .multi_value_field .search_field_item input","textarea#comment_value","input#comment_is_public","select#submit_type","input#submit_type","input#submit-button");$z("tickets").addSubmitBindings();$z("tickets").monitorRequesterChange();$z("tickets").autoselectAssigneesIfManyAgents();if($j("#ticket_linked_id").attr("auto-complete")){$j("#ticket_linked_id").autocompleteFromSelect()}$j(".visibility-controls").click(function(){$j("a.toggle-twitter-data",this).toggle()});$j("a.toggle-twitter-data").click(function(){$j(".twitter-properties").toggle();return false});$j("#comment_full .link, #comment_partial .link").click(function(){$j("#comment_full, #comment_partial, #comment_up, #comment_down").toggle();return false});$j("#sharing_with :first-child").hover(function(){$j("#shared_tickets_list").fadeIn(300)},function(){$j("#shared_tickets_list").fadeOut(100)});if($j("body.tickets-show").length&&currentAccount.daysLeftInTrial){Zendesk.Instrumentation.ToTango.track("View Ticket","Trial")}new UserMergeWizard(false);new NewUserFromTicket();$j("input, select, textarea","#ticket_properties.read_only").prop("disabled",true);if(currentUser&&currentUser.isAgent){Zendesk.Instrumentation.ToTango.trackOperatingSystem()}Zendesk.Ticket.commentDrafts=new Zendesk.Ticket.CommentDrafts(ticket_id,currentUser.id,"#comment_value","#comment_is_public");Zendesk.Ticket.commentDrafts.startWatching();new Zendesk.Twitter.TicketCreationForm()._updateCounter()},setupCommentCharacterCounter:function(options){options=options||{};options.ticketPage=true;new Zendesk.Twitter.TicketCreationForm().setupTweetCounter(options)}});$z.defModule("tickets",{addSubmitBindings:function(){function submit(event){event.preventDefault();if($j("input#submit-button").is(":disabled")){return}$j("input#submit-button").click()}function submitAndNext(event){$j("form#submit_form select#submit_type option[value='next']").prop("selected",true);submit(event)}(function($){var s=83;function submitOnKeyEvents(event){if(event.ctrlKey&&event.which===s){if(event.shiftKey){submitAndNext(event)}else{submit(event)}}}$(document).bind("keydown.zendesk.keyboard-shortcut",submitOnKeyEvents)})(jQuery)},autoselectAssigneesIfManyAgents:function(){if(typeof(agents)!=="undefined"&&agents.length>LARGE_SELECT_LENGTH){$j("select.assignee").autocompleteFromSelect()}},monitorRequesterChange:function(){var re=new RegExp(/<(.*)>/);$j("#ticket_requester_name").observe_field(3,function(){if(re.test($j(this).val())){$z("tickets").requesterChanged($j(this))}})},requesterChanged:function(ticketForm){$j.ajax({url:"/tickets/requester_change",data:ticketForm.serialize(),beforeSend:function(){$j("#user_details").fadeOut("fast");$j("#add_widget_button").hide()},success:function(){$j("#user_details").fadeIn("fast");$j("#add_widget_button").show()}})}});Zendesk.NS("Twitter");Zendesk.Twitter.SearchApplication=function($,options){options=options||{};var savedSearches=options.savedSearches,shortenedUrlFrequency=options.shortenedUrlFrequency,defaultSearch=savedSearches[0];var findInArray=function(array,matcher){var matchedElement=null;$j.each(array,function(idx,element){if(matcher(element)){matchedElement=element;return}});return matchedElement};var startPolling=function(query,mostRecentTweetId){stopPolling();this.poller=new TwitterSearchPoller(defaultSearch.monitored_twitter_handle,query,mostRecentTweetId);this.poller.start()};var stopPolling=function(){if(this.poller){this.poller.stop();this.poller=null}};var setReplyDropdownDefault=function(){if($j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").length){$j("#monitored_twitter_handle_selection #monitored_twitter_handle_id").val(self.currentSearch.monitored_twitter_handle.id)}};var app=$.sammy(function(){this.element_selector="#twitter_search";this.any("#/",function(context){var self=this;var query=this.params.q;var searchId=this.params.id;stopPolling();this.currentSearch=findInArray(savedSearches,function(element){return(element.id==searchId)});self.currentMonitoredAccount=this.currentSearch.monitored_twitter_handle;Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:query});self.currentSearchStream=new TwitterSearchStream(self.currentMonitoredAccount).searchFor(query,1,function(streamData){Sammy.apps["#twitter_search"].trigger("search-configuration-changed",{search:this.currentSearch,query:query});startPolling(query,streamData[0].id_str)});return false});this.bind("on-error",function(event,errorString){$j("#twitter_search_loading_indicator").html(Zendesk.Twitter.Templates.twitter_is_down_template);$j("#twitter_search_loading_indicator").show()});this.bind("twitter-search-started",function(e){var template=Zendesk.Twitter.Templates.tweet_downloading_template;var thinkingPleaseWait=$j.mustache(template);$j("#twitter_search_loading_indicator").html(thinkingPleaseWait);$j("#twitter_search_loading_indicator").show();$j("#no_results").empty();$j("#twitter_new_result_count").empty()});this.bind("twitter-search-completed",function(event,searchResults){new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#twitter_search_loading_indicator").slideUp("slow",function(){$j("#twitter_search_loading_indicator").empty()});if(searchResults&&searchResults.results&&searchResults.results.length>0){new Zendesk.Twitter.SearchRenderer(searchResults).render();var searchId=self.currentSearch.id;var sinceId=searchResults.results[0].id_str;if((typeof(Zendesk.Twitter._notifier)!="undefined")&&Zendesk.Twitter._notifier){Zendesk.Twitter._notifier.recordView(searchId,sinceId)}Sammy.apps["#twitter_search"].trigger("update-timestamps")}else{if(typeof(Zendesk.Twitter._notifier)!="undefined"){Zendesk.Twitter._notifier.recordView(searchId,"0")}$j("#twitter_search_results").html("Your search returned no results.")}});this.bind("search-configuration-changed",function(e,config){self.currentSearch=config.search;self.currentMonitoredAccount=self.currentSearch.monitored_twitter_handle;$j("#twitter_search_name").html(config.search.safe_name);if(config.search.editable){$j("#twitter_edit_search_link").show();$j("#twitter_edit_search_link").attr("href","/twitter/search/"+config.search.id+"/edit")}else{$j("#twitter_edit_search_link").hide()}$j('#twitter_search_bar input[type="text"]').val($("<div/>").html(config.query).text());$j('#twitter_search_bar input[type="hidden"]').val(config.search.id)});this.bind("convert-status-to-ticket",function(e,statusMessage){var container=$j("#tweet_"+statusMessage.id_str+" .drawer");setReplyDropdownDefault();new Zendesk.Twitter.TweetActivation().activate(statusMessage.id_str);new Zendesk.Twitter.TicketCreationForm().showSingleTicketForm(statusMessage,container,self.currentSearch.monitored_twitter_handle,shortenedUrlFrequency);container.find("#new_ticket #ticket_subject").val(statusMessage.text)});this.bind("drawer-cancel-btn-clicked",function(){new Zendesk.Twitter.TweetActivation().makeInactive()});this.bind("retweet-button-clicked",function(e,statusMessage){new Zendesk.Twitter.Retweet().show(statusMessage,self.currentMonitoredAccount);new Zendesk.Twitter.TweetActivation().activate(statusMessage.id_str)});this.bind("show-bulk-ticket-form-link-clicked",function(e,data){var statusMessageIds=[];$j(".tweet_checkbox:checked").map(function(idx,e){statusMessageIds.push($j(e).val())});if(statusMessageIds.length>0){stopPolling();setReplyDropdownDefault();new Zendesk.Twitter.TweetActivation().activateBulkAction();new Zendesk.Twitter.TicketCreationForm().showBulkTicketForm(statusMessageIds,$j("#twitter_bulk_ticket_form"),shortenedUrlFrequency)}else{alert("Please select at least one tweet.")}});this.bind("mark-as-reviewed",function(event,data){new TwitterSearchActions().markAsReviewed(data)});this.bind("follow-button-clicked",function(event,data){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).displayConfirmationMessage(data);new Zendesk.Twitter.TweetActivation().activate(data.searchObj["id_str"])});this.bind("follow-success",function(event){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow()});this.bind("retweet-success",function(event){new Zendesk.Twitter.FollowActions(self.currentMonitoredAccount).successfulFollow()});this.bind("next-page-btn-clicked",function(event,queryString){$j("#twitter_search #show_more").html('<img src="/images/loader.gif" />').css("background","none");new TwitterMultiRequest(self.currentMonitoredAccount).nextPage(queryString,function(data){new Zendesk.Twitter.SearchRenderer(data,false).render();Sammy.apps["#twitter_search"].trigger("update-timestamps")})});this.bind("update-timestamps",function(event){$j("a.timeago").attr("title",function(idx,txt){return new Date(txt).toISOString()});$j("a.timeago").timeago()});this.bind("ticket-creation-success",function(event,data){var tweetElement=$j("#tweet_"+data.statusMessageId);tweetElement.find("input.tweet_checkbox").attr("checked",false).prop("disabled",true).addClass("inactive");tweetElement.find("a.convert_to_ticket").replaceWith('<span class="converted">'+I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket")+"</span>");tweetElement.find(".review_status").html('<a href="/tickets/'+data.ticketId+'" class="ticket_badge" target="_blank">#'+data.ticketId+"</a>");if(self.bulkTicketWatcher){self.bulkTicketWatcher.markCompleted(data.statusMessageId)}else{new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive()}});this.bind("ticket-creation-failure",function(event,data){if(self.bulkTicketWatcher){self.bulkTicketWatcher.markFailed(data.statusMessageId)}else{new Zendesk.Twitter.TicketCreationForm()._showError(data);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false)}});this.bind("bulk-ticket-creation-started",function(event,statusMessages){self.bulkTicketWatcher=new Zendesk.Twitter.BulkTicketWatcher(statusMessages)});this.bind("bulk-ticket-request-completed",function(event,requestCount){$j("#bulk_creation_counter span").html(requestCount);new Zendesk.Twitter.BulkActions().checkForBulkActivation()});this.bind("bulk-ticket-creation-complete",function(event,numberCreated){self.bulkTicketWatcher=null;new Zendesk.Twitter.TicketCreationForm()._cancelForm();$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false);new Zendesk.Twitter.TweetActivation().makeInactive()});this.bindToAllEvents(function(){setTimeout(function(){new Zendesk.UI.NestedMenu("div.frame_header ul.drop-list").collapse()},50)})});$(function(){app.run("#/?q="+encodeURIComponent(defaultSearch.query)+"&id="+defaultSearch.id)});return app};Zendesk.NS("Twitter");Zendesk.Twitter.BulkActions=function(){};Zendesk.Twitter.BulkActions.prototype={setup:function(){$j("#bulk_review").click(function(event){event.preventDefault();var selectedTweets=[];$j("#twitter_search_results input:checked").each(function(i,checkbox){selectedTweets.push($j(checkbox).val())});Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",selectedTweets);return false});$j("#bulk_select").click(function(event){if($j("#bulk_select:checked").size()>0){$j(".tweet_checkbox:not(.inactive)").each(function(idx,element){element.checked=true})}else{$j(".tweet_checkbox:checked").each(function(idx,element){element.checked=false})}new Zendesk.Twitter.BulkActions().checkForBulkActivation()})},checkForBulkActivation:function(){if($j(".tweet_checkbox:checked").length>0){$j(".bulk_convert_button").prop("disabled",false)}else{$j(".bulk_convert_button").prop("disabled",true)}}};Zendesk.NS("Twitter");Zendesk.Twitter.BulkTicketWatcher=function(statusMessageIds){this.messageIds=statusMessageIds;this.requestCounter=0};Zendesk.Twitter.BulkTicketWatcher.prototype={markCompleted:function(statusMessageId){this._observeRequestCompleted()},markFailed:function(statusMessageId){this._observeRequestCompleted()},_observeRequestCompleted:function(){this.requestCounter+=1;Sammy.apps["#twitter_search"].trigger("bulk-ticket-request-completed",this.requestCounter);if(this.requestCounter>=this.messageIds.length){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-complete",this.requestCounter)}}};Zendesk.NS("Twitter");Zendesk.Twitter.FollowActions=function(twitterAccount){this.twitterAccount=twitterAccount};Zendesk.Twitter.FollowActions.prototype={displayConfirmationMessage:function(data){var self=this;var tweetElement=$j(data.tweetElement);var template=Zendesk.Twitter.Templates.follow_confirmation_template;var content=$j.mustache(template,data.searchObj);tweetElement.find(".drawer").first().html(content).show();tweetElement.find(".drawer .confirm").first().click(function(){$j(".drawer .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});self.follow(data.searchObj.from_user);return false});tweetElement.find(".drawer .cancel").click(function(event){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");event.preventDefault();return false})},follow:function(screenName){$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/1/friendships/create.json",type:"POST",data:{screen_name:screenName,follow:"true"},success:function(){Sammy.apps["#twitter_search"].trigger("follow-success")}})},successfulFollow:function(){$j(".activated a.follow").replaceWith('<span class="following">'+I18n.t("txt.admin.views.twitter.search.templates._tweet_controls_template.Following_label")+"</span>");new Zendesk.Twitter.TweetActivation().makeInactive()}};Zendesk.NS("Proxy");Zendesk.Proxy={domain:function(){var proxyDomain=window.location.protocol+"//"+window.location.hostname;if(proxyDomain.indexOf("localhost")!=-1){proxyDomain+=":3000"}return proxyDomain+"/proxy"}};Zendesk.NS("Twitter");Zendesk.Twitter.Retweet=function(){};Zendesk.Twitter.Retweet.prototype={show:function(statusMessage,monitoredAccount){var template=Zendesk.Twitter.Templates.retweet_template;var content=$j($j.mustache(template,{screen_name:monitoredAccount.screen_name}));content.find(".confirm").first().click(function(){$j("#tweet_"+statusMessage.id_str+" .confirm").html(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")+' <img src="/images/indicator2.gif" />').css({backgroundColor:"#fff"});$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+monitoredAccount.id+"/1/statuses/retweet/"+statusMessage.id_str+".json",type:"POST",success:function(data){$j("#tweet_"+statusMessage.id_str+" .retweet").replaceWith('<span class="retweeted">'+I18n.t("txt.admin.views.twitter.search.templates._tweet_controls_template.Retweeted_label")+"</span>");var screen_name=monitoredAccount.screen_name.substring(1);$j("#tweet_"+statusMessage.id_str+" .meta").append('<span class="retweeted_by">'+I18n.t("txt.admin.javascript.views.twitter.retweeted_by_twitter")+'<a href="http://twitter.com/'+screen_name+'">'+screen_name+"</a>");new Zendesk.Twitter.TweetActivation().makeInactive()}})});$j("#tweet_"+statusMessage.id_str+" .drawer").html(content).show();$j("#tweet_"+statusMessage.id_str+" .drawer .cancel").click(function(event){Sammy.apps["#twitter_search"].trigger("drawer-cancel-btn-clicked");event.preventDefault();return false})}};Zendesk.NS("Twitter");Zendesk.Twitter.TicketCreationForm=function(){};Zendesk.Twitter.TicketCreationForm.prototype={_updateFollowing:function(statusMessage,mth){var requester={id:statusMessage.profile.id,screenName:statusMessage.profile.screen_name.replace(/@/,"")};new TicketForm().isFollowing(mth,requester)},showSingleTicketForm:function(statusMessage,targetContainer,defaultMTH,shortenedUrlFrequency){var formArgs={statusMessageIds:[statusMessage.id_str],targetContainer:targetContainer,shortenedUrlFrequency:shortenedUrlFrequency};this._showForm(formArgs);if(statusMessage.follower){targetContainer.find("#comment_channel_back option[value='dm']").prop("disabled",false)}else{targetContainer.find("#comment_channel_back option[value='dm']").prop("disabled",true)}if(defaultMTH){targetContainer.find("#ticket_monitored_twitter_handle_id").val(defaultMTH.id);var mth={id:defaultMTH.id,screenName:defaultMTH.screen_name.replace(/@/,"")};this._updateFollowing(statusMessage,mth)}var self=this;targetContainer.find("#ticket_monitored_twitter_handle_id").change(function(){var selector=targetContainer.find("#ticket_monitored_twitter_handle_id");var mth={id:selector.val(),screenName:selector.find("option:selected").html().replace(/@/,"")};self._updateFollowing(statusMessage,mth)})},showBulkTicketForm:function(statusMessageIds,targetContainer,shortenedUrlFrequency){var formArgs={statusMessageIds:statusMessageIds,targetContainer:targetContainer,statusMessageSelector:this._getSelectedTweets,shortenedUrlFrequency:shortenedUrlFrequency};this._showForm(formArgs);$j(".cancel_link.bottom").show();targetContainer.find("#channel_back_dm").show();targetContainer.find("#submit_button").click(function(){Sammy.apps["#twitter_search"].trigger("bulk-ticket-creation-started",statusMessageIds)});var updateTicketCount=function(){var update_translated_message=I18n.t("txt.public.javascripts.views.twitter.search.ticket_creating_form.convert_many_tweets_to_tickets",{count:$j(".tweet input:checked").length});if($j(".tweet input:checked").length==1){update_translated_message=I18n.t("txt.public.javascripts.views.twitter.search.ticket_creating_form.convert_one_tweet_to_ticket")}$j("#twitter_convert_to_ticket h3:first").html(update_translated_message)};updateTicketCount();$j(".tweet input:not(.inactive)").bind("click.updateCount",function(){updateTicketCount()});targetContainer.find("#submit_button").bind("click.updateCount",function(){var messageCount=$j(".tweet input:checked").length;$j(".cancel_link.bottom").hide();$j(this).after('<span id="bulk_creation_counter">'+I18n.t("txt.javascript.twitter.search.ticket_creating_form.bulk_ticket_update",{amount:messageCount})+"</span>")})},_getSelectedTweets:function(){var filteredIds=[];$j(".tweet_checkbox:checked").map(function(idx,e){filteredIds.push($j(e).val())});return filteredIds},_updateCounter:function(){if($j("textarea#comment_value").length===0){return}$j("div#charcounter > div").html(140-($j("#charcounter").data("offset")+$j("textarea#comment_value").val().length))},_setupCharCounter:function(){var self=this;if($j("#charcounter").length===0){$j("div#comment_type").prepend('<div id="charcounter"><div title="Remaining Character Count: Characters past this limit will be truncated on Twitter but appear in their entirety in Zendesk. A shortened link to this ticket will be appended to the tweet, depending on the setup of your zendesk."></div></div>');$j("textarea#comment_value").keyup(function(){self._updateCounter()})}},_setOffset:function(options){options=options||{};var offset,screenName,shortenedUrlFrequency;screenName=(options.ticketPage)?$j(".options .twitter a").html():$j("#tweet_"+options.statusMessageIds[0]+" .screen_name").html();shortenedUrlFrequency=options.shortenedUrlFrequency;offset=shortenedUrlFrequency&&shortenedUrlFrequency==="always"?21:0;if(options.ticketPage){offset+=screenName.length+1}else{if(options.statusMessageIds.length===1){offset+=screenName.length+2}}this._setupCharCounter();$j("#charcounter").data("offset",offset);$j("div#charcounter > div").html(140-offset)},_handleReplyOrNot:function(){var option=$j("#comment_channel_back_optional_add_url");$j("#comment_channel_back").change(function(){option.toggle($j(this).val()!="no_action");new TicketForm().updateTwitterCounter()})},_handleAppendTicketUrl:function(){var self=this;$j("#comment_add_short_url").change(function(){var originalOffset=$j("#charcounter").data("offset");if($j(this).is(":checked")){$j("#charcounter").data("offset",originalOffset+21)}else{$j("#charcounter").data("offset",originalOffset-21)}self._updateCounter()})},setupTweetCounter:function(options){options=options||{};this._setOffset(options);this._handleReplyOrNot();this._handleAppendTicketUrl()},_showForm:function(options){options=options||{};var self=this,statusMessageIds=options.statusMessageIds,targetContainer=options.targetContainer,statusMessageSelector=options.statusMessageSelector,shortenedUrlFrequency=options.shortenedUrlFrequency;this._addFormToContainer(targetContainer);targetContainer.slideDown(200);$j(".cancel_link.bottom").show();this.setupTweetCounter({ticketPage:false,statusMessageIds:statusMessageIds,shortenedUrlFrequency:shortenedUrlFrequency});targetContainer.find(".cancel_link").click(function(event){self._cancelForm();new Zendesk.Twitter.TweetActivation().makeInactive();return false});this._fillFormWithTweetInfo(self,statusMessageIds,targetContainer,statusMessageSelector,shortenedUrlFrequency)},showSuccess:function(callbackData){var ticketResource=callbackData.location.match(/[0-9]+.json/ig)[0];var ticketId=ticketResource.split(".")[0];Sammy.apps["#twitter_search"].trigger("ticket-creation-success",{statusMessageId:callbackData.statusMessageId,ticketId:ticketId,url:callbackData.location})},apply_macro:function(macro_id,evt){var ticketForm=$j("#twitter_convert_to_ticket #new_ticket");new Zendesk.API.Macro(macro_id).applyToTicket(0,ticketForm);var e=(evt)?evt:window.event;Event.stop(e);var li=e.findElement();selection_feedback(li);return(false)},_addFormToContainer:function(container){container.children().remove();$j("#twitter_convert_to_ticket").appendTo(container);container.find(".cancel_link").unbind("click");container.find("#comment_add_short_url").unbind("change");container.find("#submit_button").unbind("click")},_fillFormWithTweetInfo:function(self,statusMessageIds,targetContainer,statusMessageSelector,shortenedUrlFrequency){targetContainer.find("select.assignee").autocompleteFromSelectIfLarge();targetContainer.find("#submit_button").click(function(event){targetContainer.find("#submit_button").val(I18n.t("txt.admin.javascript.views.twitter.please_wait_label")).prop("disabled",true);var bulkTicketCreator=new Zendesk.API.TicketForm("#new_ticket");var statusMessageIdsForCreation=(typeof(statusMessageSelector)=="undefined")?statusMessageIds:statusMessageSelector();$j.each(statusMessageIdsForCreation,function(index,statusMessageId){var ticketOptions={"ticket[twitter_status_message_id]":statusMessageId,"comment[is_public]":"1"};var tweetElement=jQuery("#tweet_"+statusMessageId);if(statusMessageIds.length>1&&tweetElement.attr("data-follower")!="1"){ticketOptions["ticket[skip_dm]"]="1"}var errorCallback=function(httpRequest,textStatus,errorThrown){Sammy.apps["#twitter_search"].trigger("ticket-creation-failure",{statusMessageId:statusMessageId,response:httpRequest.responseText})};bulkTicketCreator.createTicket([ticketOptions]).done(function(data,textStatus,httpRequest){var ticketLocation=httpRequest.getResponseHeader("Location").match(/\/tickets\/[0-9]+\.json$/)[0];var successCallback=function(){self.showSuccess({statusMessageId:statusMessageId,location:ticketLocation})};if(bulkTicketCreator.hasComment()){var data={"comment[value]":bulkTicketCreator.ticketForm.find('[name="comment[value]"]').val(),"comment[is_public]":bulkTicketCreator.ticketForm.find('[name="comment[is_public]"][type="checkbox"]').is(":checked"),"comment[channel_back]":bulkTicketCreator.ticketForm.find('[name="comment[channel_back]"]').val()};if(shortenedUrlFrequency==="optional"){data["comment[add_short_url]"]=bulkTicketCreator.ticketForm.find('[name="comment[add_short_url]"][type="checkbox"]').is(":checked")}$j.ajax({url:ticketLocation,dataType:"text",type:"PUT",data:data}).done(successCallback).fail(errorCallback)}else{successCallback.call(this)}}).fail(errorCallback);Zendesk.Instrumentation.ToTango.track("Created","Twicket")});event.preventDefault();return false})},_cancelForm:function(){$j(".ticket_errors").hide();$j("#twitter_convert_to_ticket").appendTo($j("#ticket-conversion-template"));var form=$j("#twitter_convert_to_ticket form");form[0].reset();$j("input, select",form).css("color","");if(typeof(ticketTagField)!="undefined"){ticketTagField.clear()}form.find("#ticket_monitored_twitter_handle_id").unbind("change");form=new TicketForm();form.updateBalloon();form.updateTwitterControls();form.updateMthSelector()},_showError:function(callbackData){var template=Zendesk.Twitter.Templates.ticket_conversion_error_template;var model={messageId:callbackData.statusMessageId,errorMessages:this._errorMessages(callbackData)};var errorContent=$j($j.mustache(template,model));$j("#twitter_convert_to_ticket .cancel_link.top").after(errorContent);$j("#submit_button").val(I18n.t("txt.admin.views.twitter.search._ticket_form.Create_Ticket")).prop("disabled",false)},_errorMessages:function(callbackData){var parsedData=null;try{parsedData=$j.parseJSON(callbackData.response)}catch(e){return[{message:"An error has occurred. Please try again."}]}var errorMessages=[];$j.each(parsedData,function(idx,element){if(element[0]=="base"){errorMessages.push({message:element[1]})}else{errorMessages.push({message:element[0]+" "+element[1]})}});return errorMessages}};Zendesk.NS("Twitter");Zendesk.Twitter.TweetActivation=function(){};Zendesk.Twitter.TweetActivation.prototype={makeInactive:function(tweetId){$j("#twitter_convert_to_ticket h3:first").html(I18n.t("txt.admin.views.twitter.search._ticket_form.Convert_to_Ticket"));$j(".tweet input:not(.inactive)").unbind("click.updateCount");$j("#submit_button").unbind("click.updateCount");$j("#bulk_creation_counter").remove();if($j(".activated").length>0){if($j("html, body").scrollTop()>$j(".activated:first").offset().top){$j("html, body").animate({scrollTop:$j(".activated:first").offset().top},500)}$j(".activated:first").effect("highlight",{},1200)}new TwitterSearchActions().dropDrawers()},activate:function(tweetId){$j(".tweet_actions").removeClass("enabled");$j("#tweet_"+tweetId).addClass("activated");$j(".tweet input").prop("disabled",true)},activateBulkAction:function(){$j(".tweet_actions").removeClass("enabled")}};var TwitterMultiRequest=function(twitterAccount){this.mthId=twitterAccount.id;this.twitterAccount=twitterAccount;this.tweetsPerPage=30};TwitterMultiRequest.prototype={searchFor:function(query,callback){this.callback=callback;this.searchType="query";this.fireRequests(query)},nextPage:function(queryString,callback){this.callback=callback;this.searchType="nextPage";this.fireRequests(queryString)},fireRequests:function(query){this.reset();this.search(query);this.getRetweets();this.getFriends();this.getFollowers()},reset:function(){this.metaData=null;this.searchData=null;this.retweetData=null;this.friendsData=null;this.followerData=null;this.lookupData=null;this.reviewedData=null},search:function(query){var options=this.searchOptions();if(this.searchType==="query"){options.data={rpp:this.tweetsPerPage,q:query}}else{options.url=options.url+query}$j.ajax(options)},searchOptions:function(){var self=this;return{url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/search.json",type:"GET",dataType:"jsonp",success:function(data){self.searchCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}}},getMetaData:function(tweetIds){var self=this;$j.ajax({url:"/twitter/tickets/exist.json",data:{q:tweetIds.join(",")},type:"GET",success:function(data){self.metaDataCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getRetweets:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/statuses/retweeted_by_me.json",type:"GET",dataType:"jsonp",success:function(data){self.retweetCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getFriends:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/friends/ids.json",data:{screen_name:this.twitterAccount.screen_name},type:"GET",dataType:"jsonp",success:function(data){self.friendsCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getFollowers:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/followers/ids.json",data:{screen_name:this.twitterAccount.screen_name},type:"GET",dataType:"jsonp",success:function(data){self.followersCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},getReviewed:function(tweetIds){var self=this;$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:tweetIds.join(",")},type:"GET",success:function(data){self.reviewedCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},lookupUsers:function(screenNames){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.mthId+"/1/users/lookup.json",data:{screen_name:screenNames.join(",")},type:"GET",dataType:"jsonp",success:function(data){self.lookupCallback(data)},error:function(data,errorString){Sammy.apps["#twitter_search"].trigger("on-error",errorString)}})},searchCallback:function(data){var tweetIds=[];var screenNames=[];var screenNameSet={};this.searchData=data;if(!this.searchData.results){Sammy.apps["#twitter_search"].trigger("on-error");return}$j.each(this.searchData.results,function(index,item){tweetIds.push(item.id_str);screenNameSet[item.from_user]=1});for(var i in screenNameSet){screenNames.push(i)}if(tweetIds.length===0||screenNames.length===0){$j("#show_more").empty();$j("#twitter_search_loading_indicator").empty();$j("#twitter_search_results").html('<div id="no_results" class="message">'+I18n.t("txt.admin.public.javascript.views.twitter.search.application.your_search_returned_no_results_twitter")+"</div>")}else{this.getMetaData(tweetIds);this.lookupUsers(screenNames);this.getReviewed(tweetIds)}},metaDataCallback:function(data){this.metaData=data;this.synchronizeCallbacks()},retweetCallback:function(data){this.retweetData=data;this.synchronizeCallbacks()},friendsCallback:function(data){this.friendsData=data;this.synchronizeCallbacks()},followersCallback:function(data){this.followersData=data;this.synchronizeCallbacks()},lookupCallback:function(data){this.lookupData=data;this.synchronizeCallbacks()},reviewedCallback:function(data){this.reviewedData=data;this.synchronizeCallbacks()},synchronizeCallbacks:function(){if(this.metaData&&this.retweetData&&this.friendsData&&this.lookupData&&this.followersData&&this.reviewedData){this.passThroughGate();this.working=false}},passThroughGate:function(){if(typeof(this.callback)!=="undefined"){var data=this.compileData();this.callback(data)}},compileData:function(){var data={results:[],nextPage:this.searchData.next_page};var self=this;$j.each(this.searchData.results,function(i,result){$j.each(self.metaData.tickets,function(j,meta){if(meta.status_id_str===result.id_str){result.ticketId=meta.ticket_id;return false}});$j.each(self.retweetData,function(j,retweet){if(retweet&&retweet.retweeted&&retweet.retweeted_status&&retweet.retweeted_status.id_str==result.id_str){result.retweeted=true;result.retweeted_by=retweet.user.screen_name;return false}});$j.each(self.lookupData,function(j,profile){if(profile.screen_name.toLowerCase()===result.from_user.toLowerCase()){result.profile=profile;return false}});$j.each(self.friendsData,function(j,friendId){if(typeof(friendId)=="string"){friendId=Number(friendId)}var isFollowing=typeof(friendId)=="number"?friendId==result.profile.id:(friendId.indexOf&&friendId.indexOf(result.profile.id)>-1);if(result.profile&&isFollowing){result.friend=true;result.profile.friend=true;return false}});$j.each(self.followersData,function(j,followerId){if(result.profile&&followerId==result.profile.id){result.follower=true;return false}});data.results.push(result)});if(data.results.length===this.tweetsPerPage){data.displayMoreLink=true}return data}};var TwitterSearchActions=function(mthId){this.mthId=mthId};TwitterSearchActions.prototype={dropDrawers:function(){$j(".tweet_actions").addClass("enabled");$j(".tweet input:not(.inactive)").prop("disabled",false);$j(".tweet .drawer").hide();$j(".tweet.activated").removeClass("activated")},showLoading:function(twitterStatusId,selector){var tweet=$j("#tweet_"+twitterStatusId);var loadingImage=$j('<span><img src="/images/ajax_small_bar.gif" /></span>');tweet.find(selector).html(loadingImage)},markAsReviewed:function(twitterStatusIds){this.dropDrawers();var self=this;$j.each(twitterStatusIds,function(i,twitterStatusId){self.showLoading(twitterStatusId,"span.review_status")});$j.ajax({url:"/twitter/reviewed_tweets.json",data:{tweet_ids:twitterStatusIds.join(",")},type:"POST",success:function(data){self.reviewedCallback(data)}})},reviewedCallback:function(data){$j.each(data,function(i,twitterStatusId){var tweet=$j("#tweet_"+twitterStatusId);tweet.find(".review_status").first().html('<span class="reviewed">Reviewed</span>')})}};var TwitterSearchPoller=function(twitterAccount,query,mostRecentTweetId){this.twitterAccount=twitterAccount;this.query=query;this.mostRecentTweetId=mostRecentTweetId;this.tweetsPerPage=30;this.sleepTime=15000;this.killed=false};TwitterSearchPoller.prototype={start:function(){this.sleepThenPoll()},stop:function(){this.killed=true;$j("#twitter_new_result_count").empty()},sleepThenPoll:function(){var self=this;var t=setTimeout(function(){self.poll()},this.sleepTime)},poll:function(){var self=this;$j.ajax({url:Zendesk.Proxy.domain()+"/twitter/api/"+this.twitterAccount.id+"/search.json",type:"GET",dataType:"jsonp",data:{rpp:this.tweetsPerPage,q:this.query,since_id:this.mostRecentTweetId},success:function(data){self.callback(data)}})},callback:function(data){if(this.killed){return}var newTweetCount=this.calculateNewTweetCount(data);if(newTweetCount>0&&newTweetCount<this.tweetsPerPage){this.renderNewTweetMessage(newTweetCount)}if(newTweetCount>=this.tweetsPerPage){this.renderMaxTweetsMessage()}else{this.sleepThenPoll()}},calculateNewTweetCount:function(data){if(data&&data.results&&data.results.length){return data.results.length}else{return 0}},renderNewTweetMessage:function(count){if(count!=1){tweet=I18n.t("txt.admin.views.twitter.search.templates._more_tweets_template.count_new_tweets_plural",{count:count})}else{tweet=I18n.t("txt.admin.views.twitter.search.templates._more_tweets_template.count_new_tweets_singular")}var object={tweets:tweet};var message=$j.mustache(Zendesk.Twitter.Templates.more_tweets_template,object);$j("#twitter_new_result_count").html(message);$j("a.twitter_search_refresh").click(function(event){Sammy.apps["#twitter_search"].refresh();return false})},renderMaxTweetsMessage:function(){var message=$j.mustache(Zendesk.Twitter.Templates.max_tweets_template,{max:this.tweetsPerPage});$j("#twitter_new_result_count").html(message);$j("a.twitter_search_refresh").click(function(event){Sammy.apps["#twitter_search"].refresh();return false})}};var TwitterSearchPreview=function(){};TwitterSearchPreview.prototype={startQuery:function(query){var self=this;$j.ajax({url:"https://search.twitter.com/search.json",type:"GET",dataType:"jsonp",data:{rpp:"5",q:query},success:function(data){self.queryCallback(data)}})},queryCallback:function(data){var template=Zendesk.Twitter.Templates.tweet_preview_template;var renderedTweets=$j.mustache(template,data);$j("#tweet_preview_container").empty();$j("#tweet_preview_container").append(renderedTweets);$j("a.timeago").attr("title",function(idx,txt){return new Date(txt).toISOString()});$j("a.timeago").timeago()}};Zendesk.NS("Twitter");Zendesk.Twitter.SearchRenderer=function(data,removeExistingStatuses){this.data=data;if(typeof(removeExistingStatuses)=="undefined"){this.removeExistingStatuses=true}else{this.removeExistingStatuses=removeExistingStatuses}};Zendesk.Twitter.SearchRenderer.prototype={render:function(){var self=this;this.removeTemporaryElements();$j.each(this.data.results,function(i,statusMessage){var tweet=self.buildTweet(statusMessage);var controls=self.buildTweetControls(statusMessage);tweet.find(".tweet_body").append(controls);if(typeof(statusMessage.ticket_id)==="undefined"){self.attachEventsTo(tweet,statusMessage)}self.attachProfileMouseOver(tweet,statusMessage);$j("#twitter_search_results").append(tweet)});$j(".tweet_checkbox").unbind("change").change(function(event){new Zendesk.Twitter.BulkActions().checkForBulkActivation()});if(this.data.displayMoreLink){this.appendMoreLink()}},removeTemporaryElements:function(){$j("#twitter_search_results .temp").remove();if(this.removeExistingStatuses){$j("#twitter_search_results").empty()}},buildTweet:function(statusMessage){statusMessage.html=Zendesk.Text.autoLink(statusMessage.text);return $j($j.mustache(Zendesk.Twitter.Templates.tweet_template,statusMessage))},buildTweetControls:function(statusMessage){return $j.mustache(Zendesk.Twitter.Templates.tweet_controls_template,statusMessage)},attachEventsTo:function(element,twitterStatusMessage){var self=this;element.find("a.convert_to_ticket").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("convert-status-to-ticket",twitterStatusMessage)});element.find("a.retweet").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("retweet-button-clicked",twitterStatusMessage)});element.find("a.follow").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("follow-button-clicked",{tweetElement:element,searchObj:twitterStatusMessage})});element.find("a.review").first().click(function(event){event.preventDefault();Sammy.apps["#twitter_search"].trigger("mark-as-reviewed",[twitterStatusMessage.id_str])})},attachProfileMouseOver:function(element,tweet){if(tweet.profile){var image=element.find("img.profile_image").first();var profile=element.find(".profile_details").first();var template=Zendesk.Twitter.Templates.tweet_profile_hover;var content=$j.mustache(template,tweet.profile);profile.html(content);image.mouseenter(function(){$j("#twitter_search_results .tweet").css("z-index","1");element.css("z-index","2");jQuery(".profile_details").hide();profile.show()});profile.mouseleave(function(){$j("#twitter_search_results .tweet").css("z-index","");profile.hide()})}},appendMoreLink:function(){var self=this;more_link=$j("<a>"+I18n.t("txt.admin.javascript.views.twitter.twitter_search_renderer.show_more_results_label")+"</a>").click(function(event){Sammy.apps["#twitter_search"].trigger("next-page-btn-clicked",self.data.nextPage)});$j("#twitter_search #show_more").html(more_link)}};var TwitterSearchStream=function(twitterAccount){this.twitterAccount=twitterAccount;this.multiRequest=new TwitterMultiRequest(this.twitterAccount)};TwitterSearchStream.prototype={searchFor:function(query,page,successCallback){Sammy.apps["#twitter_search"].trigger("twitter-search-started");var self=this;this.streamData=null;this.multiRequest.searchFor(query,function(data){Sammy.apps["#twitter_search"].trigger("twitter-search-completed",data);if(typeof(successCallback)!="undefined"){successCallback(data.results)}})},data:function(){return this.streamData},client:function(){return new TwitterSearchActions(this.twitterAccount.id)}};var TwitterSearchSorter=function(root){this.rootElement=root.first()};TwitterSearchSorter.prototype={init:function(){var self=this;this.reorderButton=this.rootElement.parent().find("a.reorder").first();this.reorderButton.click(function(event){self.rootElement.sortable();var cancelLink=jQuery("<a class='cancel-sorting'>"+I18n.t("txt.admin.javascript.views.twitter.cancel_label")+"</a>").click(function(){self.cancelSort()});var doneButton=jQuery('<button class="button">'+I18n.t("txt.admin.javascript.views.twitter.done_label")+"</button>").click(function(){self.updatePositions()});self.rootElement.parent().find(".temp").append(doneButton).append("&nbsp;").append(cancelLink);self.rootElement.parent().find(".edit_this").hide();self.reorderButton.parent().removeClass("item");self.reorderButton.hide()})},cancelSort:function(){try{this.rootElement.sortable("cancel")}catch(e){}this.rootElement.sortable("destroy");this.reset()},updatePositions:function(){var self=this;var path="/twitter/search/update_positions";this.rootElement.sortable("disable");jQuery.ajax({url:path+"?"+self.rootElement.sortable("serialize"),type:"POST",success:function(){self.updatePositionsCallback()}})},updatePositionsCallback:function(){this.rootElement.sortable("enable").sortable("destroy");this.reset()},reset:function(){var rootElementParent=this.rootElement.parent();rootElementParent.find(".temp").empty();rootElementParent.find(".edit_this").show();this.reorderButton.parent().addClass("item");this.reorderButton.show()}};Zendesk.NS("Twitter");Zendesk.Twitter.Menu={init:function(){this.bindDismissTwitterMenu()},bindDismissTwitterMenu:function(){var self=this;jQuery(".hide_twitter_menu").click(function(event){event.preventDefault();self.dismissTwitterMenu()})},dismissTwitterMenu:function(){var self=this;jQuery.ajax({type:"PUT",url:"/twitter/settings.json",data:{account:{settings:{twitter_search_stream:0}}},success:function(){self.hideTwitterMenu()}})},hideTwitterMenu:function(){$j("#twitter_menu").remove()}};Zendesk.NS("Twitter");Zendesk.Twitter.Settings={init:function(){this.bindSettingsToggle();this.bindAddHandleLink();this.bindMakePrimary();this.bindRemovePrimary();this.bindChangeURLShortener();this.bindTestURLShortener()},bindSettingsToggle:function(){var settingsLink=jQuery("#monitored_accounts_frame .twitter_profile_card .toggle");settingsLink.toggle(function(){jQuery(this).html("Close settings").parents(".twitter_profile_card").addClass("activated")},function(){jQuery(this).html("Settings").parents(".twitter_profile_card").removeClass("activated")})},bindAddHandleLink:function(){var addHandleLink=jQuery("a#add_twitter_account");addHandleLink.click(function(){$z("account/monitored_twitter_handles/index").addTwitterMonitorHandle()()})},bindMakePrimary:function(){var self=this;jQuery("#monitored_accounts .make_primary").click(function(event){event.preventDefault();var id=jQuery(event.target).attr("id").split("_").last();self.makePrimary(id)})},makePrimary:function(id){var self=this;jQuery.ajax({type:"PUT",url:"/account/channels/"+id,data:{monitored_twitter_handle:{master:true}},success:function(){self.displayPrimary(id)}})},displayPrimary:function(id){jQuery("#monitored_accounts .twitter_profile").removeClass("is_primary");jQuery("#monitored_accounts #twitter_profile_"+id).addClass("is_primary")},hidePrimary:function(id){jQuery("#monitored_accounts .twitter_profile").removeClass("is_primary");jQuery("#monitored_accounts #twitter_profile_"+id).removeClass("is_primary")},bindRemovePrimary:function(){var self=this;jQuery("#monitored_accounts .remove_primary").click(function(event){event.preventDefault();var id=jQuery(event.target).attr("id").split("_").last();self.removePrimary(id)})},removePrimary:function(id){var self=this;jQuery.ajax({type:"PUT",url:"/account/channels/"+id,data:{monitored_twitter_handle:{master:false}},success:function(){self.hidePrimary(id)}})},bindChangeURLShortener:function(){$j("#url_shortener_name").change(function(){$j("#test_url_results").hide();var selected=$j(this).val();$j(this).siblings("[data-if-shortener]").each(function(i,item){item=$j(item);if(item.attr("data-if-shortener")===selected){$j("input, textarea, select",item).prop("disabled",false);item.show()}else{item.hide();$j("input, textarea, select",item).prop("disabled",true)}});$j("#test_url_shortener").show()}).change()},bindTestURLShortener:function(){$j("#test_url_shortener_link").click(function(){$j.ajax({url:"/twitter/settings/test_shorten",data:{name:$j("#url_shortener_name").val(),username:$j("#url_shortener_username:enabled").val(),api_key:$j("#url_shortener_api_key:enabled").val(),url:$j("#url_shortener_url:enabled").val()},dataType:"json",beforeSend:function(request){$j("#test_in_process").show();$j("#test_url_shortener").hide()},success:function(data){$j("#test_url_results").css("color","#333");$j("#test_url_results").html(I18n.t("txt.public.javascripts.twitter.settings.zendesk_twitter_settings.successfully_shortened_long_to_short",{long_url:"<a href="+data.long_url+">"+data.long_url+"</a>",short_url:"<a href="+data.short_url+">"+data.short_url+"</a>"})).show();$j("#test_in_process").hide()},error:function(){$j("#test_url_results").css("color","red");$j("#test_url_results").html(I18n.t("txt.admin.public.javascript.views.twitter.settings.zendesk_twitter_settings.check_your_settings")).show();$j("#test_in_process").hide();$j("#test_url_shortener").show()}});return false})}};(function(a){a.fn.zclip=function(b){if("object"==typeof b&&!b.length){var c=a.extend({path:"ZeroClipboard.swf",copy:null,beforeCopy:null,afterCopy:null,clickAfter:!0,setHandCursor:!0,setCSSEffects:!0},b);return this.each(function(){var b=a(this);if(b.is(":visible")&&("string"==typeof c.copy||a.isFunction(c.copy))){ZeroClipboard.setMoviePath(c.path);var d=new ZeroClipboard.Client;a.isFunction(c.copy)&&b.bind("zClip_copy",c.copy);a.isFunction(c.beforeCopy)&&b.bind("zClip_beforeCopy",c.beforeCopy);a.isFunction(c.afterCopy)&&b.bind("zClip_afterCopy",c.afterCopy);d.setHandCursor(c.setHandCursor);d.setCSSEffects(c.setCSSEffects);d.addEventListener("mouseOver",function(){b.trigger("mouseenter")});d.addEventListener("mouseOut",function(){b.trigger("mouseleave")});d.addEventListener("mouseDown",function(){b.trigger("mousedown");a.isFunction(c.copy)?d.setText(b.triggerHandler("zClip_copy")):d.setText(c.copy);a.isFunction(c.beforeCopy)&&b.trigger("zClip_beforeCopy")});d.addEventListener("complete",function(d,g){a.isFunction(c.afterCopy)?b.trigger("zClip_afterCopy"):(500<g.length&&(g=g.substr(0,500)+"...\n\n("+(g.length-500)+" characters not shown)"),b.removeClass("hover"),alert("Copied text to clipboard:\n\n "+g));c.clickAfter&&b.trigger("click")});d.glue(b[0],b.parent()[0]);a(window).bind("load resize",function(){d.reposition()})}})}if("string"==typeof b){return this.each(function(){var c=a(this);b=b.toLowerCase();var d=c.data("zclipId"),d=a("#"+d+".zclip");"remove"==b?(d.remove(),c.removeClass("active hover")):"hide"==b?(d.hide(),c.removeClass("active hover")):"show"==b&&d.show()})}}})(jQuery);var ZeroClipboard={version:"1.0.7",clients:{},moviePath:"ZeroClipboard.swf",nextId:1,$:function(a){"string"==typeof a&&(a=document.getElementById(a));a.addClass||(a.hide=function(){this.style.display="none"},a.show=function(){this.style.display=""},a.addClass=function(a){this.removeClass(a);this.className+=" "+a},a.removeClass=function(a){for(var c=this.className.split(/\s+/),e=-1,d=0;d<c.length;d++){c[d]==a&&(e=d,d=c.length)}-1<e&&(c.splice(e,1),this.className=c.join(" "));return this},a.hasClass=function(a){return !!this.className.match(RegExp("\\s*"+a+"\\s*"))});return a},setMoviePath:function(a){this.moviePath=a},dispatch:function(a,b,c){(a=this.clients[a])&&a.receiveEvent(b,c)},register:function(a,b){this.clients[a]=b},getDOMObjectPosition:function(a,b){var c={left:0,top:0,width:a.width?a.width:a.offsetWidth,height:a.height?a.height:a.offsetHeight};a&&a!=b&&(c.left+=a.offsetLeft,c.top+=a.offsetTop);return c},Client:function(a){this.handlers={};this.id=ZeroClipboard.nextId++;this.movieId="ZeroClipboardMovie_"+this.id;ZeroClipboard.register(this.id,this);a&&this.glue(a)}};ZeroClipboard.Client.prototype={id:0,ready:!1,movie:null,clipText:"",handCursorEnabled:!0,cssEffects:!0,handlers:null,glue:function(a,b,c){this.domElement=ZeroClipboard.$(a);a=99;this.domElement.style.zIndex&&(a=parseInt(this.domElement.style.zIndex,10)+1);"string"==typeof b?b=ZeroClipboard.$(b):"undefined"==typeof b&&(b=document.getElementsByTagName("body")[0]);var e=ZeroClipboard.getDOMObjectPosition(this.domElement,b);this.div=document.createElement("div");this.div.className="zclip";this.div.id="zclip-"+this.movieId;$j(this.domElement).data("zclipId","zclip-"+this.movieId);var d=this.div.style;d.position="absolute";d.left=""+e.left+"px";d.top=""+e.top+"px";d.width=""+e.width+"px";d.height=""+e.height+"px";d.zIndex=a;if("object"==typeof c){for(addedStyle in c){d[addedStyle]=c[addedStyle]}}b.appendChild(this.div);this.div.innerHTML=this.getHTML(e.width,e.height)},getHTML:function(a,b){var c="",e="id="+this.id+"&width="+a+"&height="+b;if(navigator.userAgent.match(/MSIE/)){var d=location.href.match(/^https/i)?"https://":"http://",c=c+('<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+d+'download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+a+'" height="'+b+'" id="'+this.movieId+'" align="middle"><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+ZeroClipboard.moviePath+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+e+'"/><param name="wmode" value="transparent"/></object>')}else{c+='<embed id="'+this.movieId+'" src="'+ZeroClipboard.moviePath+'" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+a+'" height="'+b+'" name="'+this.movieId+'" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+e+'" wmode="transparent" />'}return c},hide:function(){this.div&&(this.div.style.left="-2000px")},show:function(){this.reposition()},destroy:function(){if(this.domElement&&this.div){this.hide();this.div.innerHTML="";var a=document.getElementsByTagName("body")[0];try{a.removeChild(this.div)}catch(b){}this.div=this.domElement=null}},reposition:function(a){a&&((this.domElement=ZeroClipboard.$(a))||this.hide());if(this.domElement&&this.div){var a=ZeroClipboard.getDOMObjectPosition(this.domElement),b=this.div.style;b.left=""+a.left+"px";b.top=""+a.top+"px"}},setText:function(a){this.clipText=a;this.ready&&this.movie.setText(a)},addEventListener:function(a,b){a=a.toString().toLowerCase().replace(/^on/,"");this.handlers[a]||(this.handlers[a]=[]);this.handlers[a].push(b)},setHandCursor:function(a){this.handCursorEnabled=a;this.ready&&this.movie.setHandCursor(a)},setCSSEffects:function(a){this.cssEffects=!!a},receiveEvent:function(a,b){a=a.toString().toLowerCase().replace(/^on/,"");switch(a){case"load":this.movie=document.getElementById(this.movieId);if(!this.movie){var c=this;setTimeout(function(){c.receiveEvent("load",null)},1);return}if(!this.ready&&navigator.userAgent.match(/Firefox/)&&navigator.userAgent.match(/Windows/)){c=this;setTimeout(function(){c.receiveEvent("load",null)},100);this.ready=!0;return}this.ready=!0;try{this.movie.setText(this.clipText)}catch(e){}try{this.movie.setHandCursor(this.handCursorEnabled)}catch(d){}break;case"mouseover":this.domElement&&this.cssEffects&&(this.domElement.addClass("hover"),this.recoverActive&&this.domElement.addClass("active"));break;case"mouseout":this.domElement&&this.cssEffects&&(this.recoverActive=!1,this.domElement.hasClass("active")&&(this.domElement.removeClass("active"),this.recoverActive=!0),this.domElement.removeClass("hover"));break;case"mousedown":this.domElement&&this.cssEffects&&this.domElement.addClass("active");break;case"mouseup":this.domElement&&this.cssEffects&&(this.domElement.removeClass("active"),this.recoverActive=!1)}if(this.handlers[a]){for(var h=0,g=this.handlers[a].length;h<g;h++){var f=this.handlers[a][h];if("function"==typeof f){f(this,b)}else{if("object"==typeof f&&2==f.length){f[0][f[1]](this,b)}else{if("string"==typeof f){window[f](this,b)}}}}}}};(function($,Zendesk){var log=Minilog("voice");var app=$.sammy("#call-console",function(){this.use("Mustache");this.use("ActiveTemplate");this.call=null;this.state="idle";this.restoring=false;this.maxDisplayStringLength=30;this.init=function(switchBoard,capabilityToken){this.switchBoard=switchBoard;this.capabilityToken=capabilityToken;this.clientAvailable=false;this.name="CallConsole";log.info("#init");$(window).load(function(){_.delay(function(){log.info("#twilio-load-start");$.getScript("//static.twilio.com/libs/twiliojs/1.0/twilio.min.js",function(data,textStatus,jqxhr){log.info("#twilio-load-finish",{status:textStatus});if(textStatus==="success"){if(!window.Twilio){log.error("#twilio-load-error",{message:"ec5"});Zendesk.voiceMenu&&Zendesk.voiceMenu.updateAvailability("off","twilio");alert(I18n.t("txt.voice.error.ec5"));return}$("#__soundFlash__").css("visibility","hidden");if(Zendesk.voiceMenu){var bO=Zendesk.voiceMenu.backOff([1,2,4,8],function(){return Twilio&&Twilio.MediaStream});bO.done(function(){$("#__soundFlash__").css("visibility","hidden")})}app.hookUpTwilioDevice()}else{log.error("#twilio-load-error",{message:"ec10"});Zendesk.voiceMenu&&Zendesk.voiceMenu.updateAvailability("off","twilio-asset");alert(I18n.t("txt.voice.error.ec10"))}})},100)});$(window).unload(function(){window.voiceUnloading=true});this.setupVoiceInMaintenance();this.callOverlay=new Zendesk.CallOverlay();this.banner=new Zendesk.VoiceBanner();this.switchBoard.bind("Zendesk.CallConsoleApp.call",function(data){app.safeTrigger(data.status,data)});if(Zendesk.currentUser.voice.current_call){app.setCurrentCall(Zendesk.currentUser.voice.current_call)}};this.showConsoleIfNeeded=function(){if(!this.$element().is(":visible")){this.trigger("show-console")}};this.hideConsoleIfNeeded=function(){if(this.$element().is(":visible")){this.trigger("close-console")}};this.logTrigger=function(name,data){log.info("#trigger",{name:name,payload:data});this.trigger.apply(this,[name,data])};this.safeTrigger=_.debounce(this.logTrigger,300);this.retrigger=function(){if(this.lastTrigger){log.info("#retrigger",{last:this.lastTrigger});this.safeTrigger(this.lastTrigger)}};this.getCallInfo=function(sid,tries,untilFunc,dfd){var self=this;if(!dfd){dfd=new jQuery.Deferred()}if(this.callInfoDeferred){this.callInfoDeferred.reject();this.callInfoDeferred=dfd}var data={};if(app.call&&app.call.id){data.call_id=app.call.id}else{data.outgoing_sid=sid}$.ajax({url:"/voice/calls/incoming_info",type:"GET",data:data,dataType:"json"}).always(function(data){if(data.outbound){self.setCurrentCall(data);dfd.resolveWith(data)}else{if(untilFunc&&!untilFunc(data)&&!dfd.isResolved()){if(tries<1){if(data&&sid&&!data.outgoing_sid){data.outgoing_sid=sid}self.setCurrentCall(data);log.error("#incoming-info-failed",{sid:sid,data:data});dfd.reject()}else{var getCallInfo=_.bind(self.getCallInfo,self);_.delay(getCallInfo,1000,sid,tries-1,untilFunc,dfd);log.info("#incoming-info-retry",{sid:sid,tries:tries})}}else{log.debug("#incoming-info-retrieved",{sid:sid,tries:tries});self.setCurrentCall(data);dfd.resolveWith(data)}}});return dfd.promise()};this.waitForAfterSetup=function(){log.info("#twilio-device-wait");if(!Twilio.Device.__afterSetup){log.info("#twilio-device-still-waiting");setTimeout(this.waitForAfterSetup.bind(this),100)}else{if(this.afterSetupCallback){this.afterSetupCallback()}}};this.hookUpTwilioDevice=function(){var self=this;log.info("#hookup-device-start");if(!window.Twilio){log.info("#hookup-device-error",{message:"no-twilio"});return}this.switchBoard.bind("Zendesk.currentUser.availableForVoiceOn",function(available){self._acceptCalls=(available!=="off");if(available==="client"&&!self.clientAvailable&&!self.clientReadying){self.clientReadying=true;Zendesk.voiceMenu.catchFlash(function(){self.afterSetupCallback=function(){log.info("#twilio-device-after-setup-callback");if(Twilio.Device.__afterSetup){Twilio.Device.__afterSetup(function(){Twilio.Device.instance.log.handler=function(x){if(typeof x==="string"){log.debug("#twilio-device",x)}else{log.debug("#twilio-device",JSON.stringify(x))}}})}if(window.WebSocket&&!window.WebSocket.__flash&&window.WebSocket.__initialize){WebSocket.__initialize()}log.info("#twilio-device-setup",{token:self.capabilityToken,debug:Zendesk.currentUser.voice.logging});Twilio.Device.setup(self.capabilityToken,{debug:Zendesk.currentUser.voice.logging})};if(Zendesk.currentUser.voice.logging){self.waitForAfterSetup()}else{self.afterSetupCallback()}})}});Zendesk.switchBoard.triggerInternal("Zendesk.currentUser.availableForVoiceOn",Zendesk.currentUser.availableForVoiceOn);Twilio.Device.ready(function(device){log.info("#twilio-ready",{status:device._status});self.clientAvailable=true;self.clientReadying=false;if(!self.fightStaged){self.fight=new Zendesk.Fight("ringer",{win:function(){Twilio.Device.sounds.incoming(true)},lose:function(){Twilio.Device.sounds.incoming(false)},check:function(){return Twilio.Device.sounds.incoming()}})}self.fightStaged=true;if(Zendesk.voiceMenu.flashPermissionsDeferred){Twilio.MediaStream.__queue(function(){Zendesk.voiceMenu.showFlashPermissions()});Zendesk.voiceMenu.flashPermissionsDeferred=null}});Twilio.Device.incoming(function(conn){log.info("#twilio-incoming",{conn:conn.parameters});self.connection=conn;if(!self._acceptCalls&&conn){conn.disconnect()}conn.error(function(error){log.error("#twilio-error2",{conn:conn.parameters,message:error.message,code:error.code})});self.clearState();self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.status=="routing"}).always(function(){self.gotCallInfo=true;if(self.call.outbound&&app.connection){app.connection.accept()}self.trigger("routing");self.gotCallInfo=false}).fail(function(){self.call.human_calling_number="Unknown"})});Twilio.Device.connect(function(conn){log.info("#twilio-connect",{conn:conn.parameters});self.connection=conn;self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.status==="in_conference"}).done(function(){self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.connected_at}).always(function(){self.trigger("in_conference");self.lastTrigger="in_conference";self.callOverlay.show();self.getCallInfo(conn.parameters.CallSid,5,function(call){return call&&call.ticket&&call.ticket.nice_id}).done(function(call){self.retrigger()})}).fail(function(){self.call.connected_at=new Date();self.retrigger()})}).fail(function(){if(Zendesk.currentUser.availableForVoiceOn==="client"){Twilio.Device.instance.disconnectAll()}})});Twilio.Device.disconnect(function(conn){log.info("#twilio-disconnect",{conn:conn.parameters});self.connection=null;self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.status==="completed"}).done(function(){self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.recording_url&&call.is_recording_url_ready}).always(function(){self.trigger("completed");self.switchBoard.triggerExternal("Zendesk.CallConsoleApp.call",self.call);self.lastTrigger="completed";self.callOverlay.hide();self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.ticket&&call.ticket.nice_id}).always(function(call){self.retrigger()})})}).fail(function(){self.trigger("missed-call")})});Twilio.Device.cancel(function(conn){log.info("#twilio-cancel",{conn:conn.parameters});self.connection=null;self.getCallInfo(conn.parameters.CallSid,3,function(call){return call&&call.id&&call.reasons&&call.reasons[Zendesk.currentUser.id]}).done(function(){self.trigger("missed-call")}).fail(function(){self.trigger("close-console")})});Twilio.Device.offline(function(){log.error("#twilio-offline",{args:arguments});self.connection=null;self.clientAvailable=false;self.clientReadying=false;if(self.checkingOffline||Zendesk.currentUser.availableForVoiceOn!=="client"){return}var b0=Zendesk.voiceMenu.backOff([2,4,8,16],function(){if(Twilio.Device.status()!=="ready"){Twilio.Device.setup(self.capabilityToken,{debug:Zendesk.currentUser.voice.logging});return false}else{return true}});b0.fail(function(){self.knockOfflineIfNotUnloading()}).always(function(){self.checkingOffline=false});self.checkingOffline=true});self.invalidTokenCount=0;self.refreshing=false;Twilio.Device.error(function(error){log.error("#twilio-error",{conn:self.connection&&self.connection.parameters,message:error.message,code:error.code});self.connection=null;if(Zendesk.currentUser.availableForVoiceOn!=="client"){return}if((self.fight&&self.fight.check())||!self.clientAvailable){if(error.message==="No microphone is available"){log.error("#twilio-no-microphone-error",{message:"ec2"});alert(I18n.t("txt.voice.error.ec2"));Zendesk.voiceMenu.updateAvailability("off","error-ec2")}else{if(error.message==="This AccessToken is no longer valid"){self.refreshCapabilityToken()}else{log.error("#twilio-unknown-error",{message:"ec3"});alert(I18n.t("txt.voice.error.ec3"));Zendesk.voiceMenu.updateAvailability("off","error-ec3")}}}});log.info("#hookup-device-finish")};this.refreshCapabilityToken=function(){var self=this;var oldToken=Zendesk.currentUser.voice.client_capability_token;if(this.refreshing){return}if(this.invalidTokenCount>=3){log.error("#invalid-token-error",{message:"ec13"});Zendesk.voiceMenu.updateAvailability("off","error-ec13");alert(I18n.t("txt.voice.error.ec13"));return}this.refreshing=true;this.invalidTokenCount++;log.info("#refresh-token",{count:self.invalidTokenCount});jQuery.getScript("/generated/javascripts/voice.js").done(function(){if(oldToken!=Zendesk.currentUser.voice.client_capability_token){log.info("#new-token","#twilio-device-setup",{count:self.invalidTokenCount,token:Zendesk.currentUser.voice.client_capability_token});Twilio.Device.setup(Zendesk.currentUser.voice.client_capability_token,{debug:Zendesk.currentUser.voice.logging})}else{log.error("#stale-token",{count:self.invalidTokenCount,token:oldToken})}self.refreshing=false})};this.knockOfflineIfNotUnloading=function(){var self=this;var bO=Zendesk.voiceMenu.backOff([1,2,3],function(){return window.voiceUnloading});bO.fail(function(){if(self.fight&&self.fight.check()){log.error("#twilio-offline-error",{message:"ec1"});Zendesk.voiceMenu.updateAvailability("off","offline");alert(I18n.t("txt.voice.error.ec1"))}})};this.setupVoiceInMaintenance=function(){if(!Zendesk.currentUser.voice.in_maintenance){return}$(".console-title-bar").addClass("notice");$(".console-title-notice").css("display","block")};this._muteCall=function(muted){if(this.connection){if(muted){log.info("#mute");this.connection.mute()}else{log.info("#unmute");this.connection.unmute()}}};this.restoreState=function(){if(!this.call){return}else{if(this.call.outgoing_kind!=="client"||this.call.status==="completed"){this.state=this.call.status;this.trigger(this.state,this.call)}}};this.clearState=function(){this.call=null};var ReasonMessaging=function(){};ReasonMessaging.prototype={ignoring:false,ignore:function(){this.ignoring=true},reset:function(){this.ignoring=false}};this.reasonMessaging=new ReasonMessaging();this.setCurrentCall=function(call_data){if(!call_data){return this.call}if(call_data.caller){call_data.caller.name=this.truncateString(call_data.caller.name,this.maxDisplayStringLength);if(call_data.caller.organization){call_data.caller.organization.name=this.truncateString(call_data.caller.organization.name,15)}}log.debug("#set-current-call",{call:call_data});this.call=call_data;this.call.calling_number_encoded=encodeURIComponent(call_data.calling_number);return this.call};this.bind("run",function(e){this.app.restoreState()});this.bind("show-console",function(e){log.info("#show-console");this.$element().show()});this.bind("unanswered",function(e){this.trigger("close-console")});this.bind("close-console",function(e){log.info("#close-console");this.$element().hide();this.app.clearState()});this.bind("accept-call",function(e,data){log.info("#accept-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(Zendesk.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.accept()}else{this.app.updateCall("agent_accepts")}this.renderTemplate($("#title_bar_waiting_template"));this.renderTemplate($("#action_bar_accepted_call_template"))});this.bind("deny-call",function(e,data){log.info("#deny-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(Zendesk.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect()}this.app.updateCall("agent_declines");this.app.reasonMessaging.ignore();this.trigger("close-console")});this.bind("end-call",function(e,data){log.info("#end-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(Zendesk.currentUser.availableForVoiceOn==="client"&&this.app.connection){this.app.connection.disconnect()}else{this.app.updateCall("agent_end_call")}this.renderTemplate($("#action_bar_ending_call_template"));this.$element().find(".console-number").slideUp("slow")});this.bind("mute-call",function(e,data){if(this.app.clientAvailable){if(this.$element().find(".mute_call").hasClass("muted")){this.app._muteCall(false)}else{this.app._muteCall(true)}this.$element().find(".mute_call").toggleClass("muted")}});this.bind("finish-call",function(e,data){log.info("#finish-call",{available:Zendesk.currentUser.availableForVoiceOn,conn:this.app.connection&&this.app.connection.parameters});if(!this.app.call){return}if(this.app.audioPlayer){this.app.audioPlayer.pause()}this.app.updateCall("finish");this.trigger("close-console")});this.bind("close",function(e,data){this.trigger("close-console")});this.bind("missed-call",function(e){log.info("#missed-call");if(Zendesk.currentUser.availableForVoiceOn==="client"){Twilio.Device.instance.disconnectAll()}if(this.app.reasonMessaging.ignoring){log.info("#ignore-reason-messaging");this.trigger("close-console");return}var self=this;var processReasons=function(){if(!self.app.call.reasons){return}var reasons=self.app.call.reasons[Zendesk.currentUser.id];if(!reasons){return}var reason=reasons[reasons.length-1];var allReasons=self.app.call.reasons.all;if(reason.title==="call_returned_to_queue"){if(allReasons.length>0){for(var i=allReasons.length-1;i>=0;i--){var all=allReasons[i];var allAt=new Date(all.at);var reasonAt=new Date(reason.at);if(allAt>=reasonAt){return all}}}}return reason};var reason=processReasons();if(!reason){return}log.info("#missed-call",{reason:reason});var title=reason.title;var details=reason.details;if(title!=="call_routed_to_agent"){title=I18n.t("txt.views.voice.call_console.reason.title."+title);if(details){details=I18n.t("txt.views.voice.call_console.reason.detail."+details)}}else{title=I18n.t("txt.views.voice.call_console.reason.title."+title,{name:details});details=null}var both=title&&details;var titleBarTemplate=$("#title_bar_missed_call_template");if($(".console-title-text").hasClass("waiting")){titleBarTemplate=$("#title_bar_unable_to_accept_call_template")}this.renderTemplate(titleBarTemplate,{id:self.app.call.id}).then(function(){var titleContent=$(".console-title-content");titleContent.zclip({path:"/javascripts/ZeroClipboard.swf",copy:""+self.app.call.id,afterCopy:function(){},setCSSEffects:true});titleContent.hover(function(){titleContent.find(".title").hide();titleContent.find(".call-id").show();titleContent.addClass("clickable")},function(){titleContent.find(".title").show();titleContent.find(".call-id").hide();titleContent.removeClass("clickable")})});this.renderTemplate($("#routing_reason_template"),{title:title,details:details,both:both});this.renderTemplate($("#action_bar_close_template"));this.app.showConsoleIfNeeded()});this.setCall=function(call_data){this.call=call_data;this.call.calling_number_encoded=encodeURIComponent(call_data.calling_number)};this.updateCall=function(response){var self=this;var pushVisibility=self.$element().is(":visible");$.ajax({url:"/voice/calls/update_status?call_id="+this.call.id+"&outgoing_sid="+this.call.outgoing_sid,type:"POST",data:{event:response},success:function(data){self.switchBoard.triggerExternal("Zendesk.CallConsoleApp.call",data,data.transaction_uuid)},error:function(){log.error("#update-call-error",{message:"ec4"});alert(I18n.t("txt.voice.error.ec4"));if(pushVisibility){self.showConsoleIfNeeded()}else{self.hideConsoleIfNeeded()}}})};this.startTimer=function(){if(this.timer){return}var timer=new Voice.Timer(this.$element().find(".console-title-text"));if(this.call&&this.call.connected_at){this.timer=new Voice.TimerManager(timer,new Date(this.call.connected_at))}else{this.timer=new Voice.TimerManager(timer,new Date())}};this.stopTimer=function(){if(this.timer){this.timer.stop();delete this.timer}};this.bind("routing",function(e,call_data){log.info("#trigger-routing",{available:Zendesk.currentUser.availableForVoiceOn,gotInfo:this.app.gotCallInfo});if(Zendesk.currentUser.availableForVoiceOn==="client"&&!this.app.gotCallInfo){return}call_data=this.app.setCurrentCall(call_data);var self=this;this.app.reasonMessaging.reset();this.renderTemplate($("#title_bar_incoming_call_template")).then(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call_answer_in"));var timer=new Voice.CountdownTimer(self.$element().find(".console-title-timer"));timer.stop(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"))});self.app.routingTimer=new Voice.TimerManager(timer,new Date((new Date()).valueOf()+call_data.answer_in*1000))});this.renderTemplate($("#number_template"),call_data);this.$element().find(".console-number").show();this.renderTemplate($("#call_console_user_card"),call_data);var template=call_data.outbound?"action_bar_in_call_template":"action_bar_user_calling_template";this.renderTemplate($("#"+template),call_data);this.app.showConsoleIfNeeded()});this.bind("check_agent",function(e,call_data){var self=this;if(self.app.routingTimer){self.app.routingTimer.stop();delete self.app.routingTimer}this.renderTemplate($("#title_bar_incoming_call_template")).then(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call_accept_in"));var timer=new Voice.CountdownTimer(self.$element().find(".console-title-timer"));timer.stop(function(){self.$element().find(".console-title-prefix").html(I18n.t("txt.admin.public.javascripts.views.voice.call_console.incoming_call"))});new Voice.TimerManager(timer,new Date((new Date()).valueOf()+call_data.accept_in*1000))})});this.bind("in_conference",function(e,call_data){log.info("#trigger-in-conference",{available:Zendesk.currentUser.availableForVoiceOn,client:this.app.clientAvailable});if(Zendesk.currentUser.availableForVoiceOn==="client"&&!this.app.clientAvailable){return}call_data=this.app.setCurrentCall(call_data);var self=this;this.renderTemplate($("#action_bar_in_call_template"));this.renderTemplate($("#number_template"),call_data);this.$element().find(".console-number").show();this.renderTemplate($("#call_console_user_card"),call_data);if(!this.app.timer){this.renderTemplate($("#title_bar_in_call_template")).then(function(){if(Zendesk.currentUser.availableForVoiceOn==="client"){self.$element().find(".mute_call").show();self.$element().find(".mute_call").unbind("click");self.$element().find(".mute_call").click(function(){self.app.trigger("mute-call")})}else{self.$element().find(".mute_call").hide()}self.app.startTimer()})}this.app.showConsoleIfNeeded()});this.bind("completed",function(e,call_data){call_data=this.app.setCurrentCall(call_data);var self=this;log.info("#trigger-completed",{wrap:call_data["agent_wrap_up_after_calls?"]});if(call_data["agent_wrap_up_after_calls?"]===false){this.trigger("close-console");return}this.app.stopTimer();this.$element().find(".mute_call").hide();this.$element().find(".console-number").hide();this.renderTemplate($("#title_bar_call_ended_template"));this.renderTemplate($("#action_bar_completed_call_template"));this.renderTemplate($("#call_console_user_card"),call_data).then(function(){self.app.setupAudioPlayer()});this.app.showConsoleIfNeeded()});this.bind("voicemail",function(){this.trigger("missed-call")});this.bind("voicemail_transcription_completed",function(){this.trigger("missed-call")});this.bind("cancelled",function(){this.trigger("missed-call")});this.bind("queued",function(){this.trigger("missed-call")});this.bind("ended",function(){this.trigger("close-console")});this.truncateString=function(string,maxLength){if(string.length>maxLength){string=string.slice(0,maxLength-string.length)+"..."}return string};this.notFound=function(){};this.messageHandler=_.bind(function(message){message=message.message;var messageType=message.name;var data=message.data;var triggers=message.triggers;this.switchBoard.record(data.transaction_uuid);if(_.isUndefined(messageType)){return}this.setCurrentCall(data);if(data.outgoing_kind!=="client"||data.status==="completed"||data.status==="ended"){app.safeTrigger(messageType,data)}},this);this.subscribeForMessages=function(){if(Zendesk.currentUser.voice.in_maintenance){return}log.info("#subscribe-for-messages",{channel:"call_console."+Zendesk.currentUser.id});Zendesk.Pubsub.subscribe("call_console."+Zendesk.currentUser.id,this.messageHandler.bind(this))};this.pubsubChannel="call_console."+Zendesk.currentUser.id;this.initAudioPlayer=function(){var self=this;log.info("#init-audio-player-start",{call:self.call});var player=new Player({domId:"audio_player_console_"+self.call.id,url:self.call.player_recording_urls,swfUrl:"/media/voice/soundmanager"})};this.setupAudioPlayer=function(){var self=this;if(this.call.recording_url&&this.call.is_recording_url_ready){self.initAudioPlayer()}else{if(this.call.outgoing_sid){this.getCallInfo(this.call.outgoing_sid,3,function(call){return call&&call.recording_url&&call.is_recording_url_ready}).done(function(){self.initAudioPlayer()})}}}});Zendesk.CallConsoleApp=app}(jQuery,Zendesk));(function($,Zendesk){Zendesk.CallOverlay=(function(){var _shouldBlockOutgoingLinks,_initializedBlocker;var initializeBlocker=function(){if(!_initializedBlocker){$("#call-console a, #cboxWrapper a").live("click",function(event){if(!_shouldBlockOutgoingLinks){return}event.preventDefault();event.stopPropagation();window.open(this.href,"_blank")});_initializedBlocker=true}};function CallOverlay(){this.show=function(){_shouldBlockOutgoingLinks=true;$("#voice-blocking-banner").slideDown(1000);$("#voice-blocking-overlay").show();initializeBlocker()};this.hide=function(){_shouldBlockOutgoingLinks=false;$("#voice-blocking-banner").slideUp(1000);$("#voice-blocking-overlay").hide()}}return CallOverlay})()}(jQuery,Zendesk));(function($,Zendesk){var log=Minilog("fight");Zendesk.Fight=(function(){function Fight(name,options){this.name="Fight: "+name;this.options=options||{};this.check=options.check||function(){};this.win=options.win||function(){};this.lose=options.lose||function(){};this.channelName=name;this.localSwitchBoard=Zendesk.switchBoard._localStorage;this.stageFight()}Fight.prototype.commenceFight=function(){if(this.check()){this.localSwitchBoard.publish(this.channelName,{kind:"start_fight",uuid:uuid()})}};Fight.prototype.turnOn=function(){log.info("#on");this.win()};Fight.prototype.turnOff=function(){log.info("#off");this.lose()};Fight.prototype.punch=function(){this.stillFighting=true;this.turnOn();this.fightStrength=uuid();this.localSwitchBoard.publish(this.channelName,{kind:"punch",uuid:this.fightStrength})};Fight.prototype.receivePunch=function(punch){this.stillFighting=(punch>=this.fightStrength)&&this.stillFighting;if(!this.stillFighting){this.turnOff()}};Fight.prototype.knockout=function(){this.turnOn();this.localSwitchBoard.publish(this.channelName,{kind:"knockout",uuid:uuid()})};Fight.prototype.receiveKnockout=function(punch){if(punch===this.fightStrength){return}this.turnOff()};Fight.prototype.stageFight=function(){var self=this;this.localSwitchBoard.subscribe(this.channelName,function(message){switch(message.kind){case"knockout":self.receiveKnockout(message.uuid);break;case"start_fight":self.punch();break;case"punch":self.receivePunch(message.uuid);break}});$(window).bind("beforeunload",function(){self.commenceFight()});this.knockout()};return Fight}())}(jQuery,Zendesk));(function($){var msOldDiv="";var dd=function(element,options){var sElement=element;var $this=this;var options=$.extend({height:120,visibleRows:7,rowHeight:23,showIcon:true,zIndex:9999,mainCSS:"dd",useSprite:false,animStyle:"slideDown",onInit:"",style:""},options);this.ddProp=new Object;var oldSelectedValue="";var actionSettings={};actionSettings.insideWindow=true;actionSettings.keyboardAction=false;actionSettings.currentKey=null;var ddList=false;var config={postElementHolder:"_msddHolder",postID:"_msdd",postTitleID:"_title",postTitleTextID:"_titletext",postChildID:"_child",postAID:"_msa",postOPTAID:"_msopta",postInputID:"_msinput",postArrowID:"_arrow",postInputhidden:"_inp"};var styles={dd:options.mainCSS,ddTitle:"ddTitle",arrow:"arrow",ddChild:"ddChild",ddTitleText:"ddTitleText",disabled:0.3,ddOutOfVision:"ddOutOfVision",borderTop:"borderTop",noBorderTop:"noBorderTop",selected:"selected"};var attributes={actions:"focus,blur,change,click,dblclick,mousedown,mouseup,mouseover,mousemove,mouseout,keypress,keydown,keyup",prop:"size,multiple,disabled,tabindex"};this.onActions=new Object;var elementid=$(sElement).prop("id");if(typeof elementid=="undefined"||elementid.length<=0){elementid="msdrpdd"+$.msDropDown.counter++;$(sElement).attr("id",elementid)}var inlineCSS=$(sElement).prop("style");options.style+=inlineCSS==undefined?"":inlineCSS;var allOptions=$(sElement).children();ddList=$(sElement).prop("size")>1||$(sElement).prop("multiple")==true?true:false;if(ddList){options.visibleRows=$(sElement).prop("size")}var a_array={};var currentP=0;var isFilter=false;var oldHeight;var cacheElement={};var getElement=function(a){if(typeof cacheElement[a]=="undefined"){cacheElement[a]=document.getElementById(a)}return cacheElement[a]};var getPostID=function(a){return elementid+config[a]};var getOptionsProperties=function(a){var b=a;var c=$(b).prop("style");return c};var matchIndex=function(a){var b=$("#"+elementid+" option:selected");if(b.length>1){for(var c=0;c<b.length;c++){if(a==b[c].index){return true}}}else{if(b.length==1){if(b[0].index==a){return true}}}return false};var createA=function(a,b,c,d){var e="";var f=d=="opt"?getPostID("postOPTAID"):getPostID("postAID");var g=d=="opt"?f+"_"+b+"_"+c:f+"_"+b;var h="";var i="";if(options.useSprite!=false){i=" "+options.useSprite+" "+a.className}else{h=$(a).prop("title");h=h.length==0?"":'<img src="'+h+'" align="absmiddle" /> '}var j=$(a).text();var k=$(a).val();var l=$(a).prop("disabled")==true?"disabled":"enabled";a_array[g]={html:h+j,value:k,text:j,index:a.index,id:g};var m=getOptionsProperties(a);if(matchIndex(a.index)==true){e+='<a href="javascript:void(0);" class="'+styles.selected+" "+l+i+'"'}else{e+='<a  href="javascript:void(0);" class="'+l+i+'"'}if(m!==false&&m!==undefined){e+=" style='"+m+"'"}e+=' id="'+g+'">';e+=h+'<span class="'+styles.ddTitleText+'">'+j+"</span></a>";return e};var in_array=function(a){var b=a.toLowerCase();if(b.length==0){return -1}var c="";for(var d in a_array){var e=a_array[d].text.toLowerCase();if(e.substr(0,b.length)==b){c+="#"+a_array[d].id+", "}}return c==""?-1:c};var createATags=function(){var a=allOptions;if(a.length==0){return""}var b="";var c=getPostID("postAID");var d=getPostID("postOPTAID");a.each(function(c){var d=a[c];if(d.nodeName=="OPTGROUP"){b+="<div class='opta'>";b+="<span style='font-weight:bold;font-style:italic; clear:both;'>"+$(d).prop("label")+"</span>";var e=$(d).children();e.each(function(a){var d=e[a];b+=createA(d,c,a,"opt")});b+="</div>"}else{b+=createA(d,c,"","")}});return b};var createChildDiv=function(){var a=getPostID("postID");var b=getPostID("postChildID");var c=options.style;sDiv="";sDiv+='<div id="'+b+'" class="'+styles.ddChild+'"';if(!ddList){sDiv+=c!=""?' style="'+c+'"':""}else{sDiv+=c!=""?' style="border-top:1px solid #c3c3c3;display:block;position:relative;'+c+'"':""}sDiv+=">";return sDiv};var createTitleDiv=function(){var a=getPostID("postTitleID");var b=getPostID("postArrowID");var c=getPostID("postTitleTextID");var d=getPostID("postInputhidden");var e="";var f="";if(getElement(elementid).options.length>0){e=$("#"+elementid+" option:selected").text();f=$("#"+elementid+" option:selected").prop("title")}f=f.length==0||f==undefined||options.showIcon==false||options.useSprite!=false?"":'<img src="'+f+'" align="absmiddle" /> ';var g='<div id="'+a+'" class="'+styles.ddTitle+'"';g+=">";g+='<span id="'+b+'" class="'+styles.arrow+'"></span><span class="'+styles.ddTitleText+'" id="'+c+'">'+f+'<span class="'+styles.ddTitleText+'">'+e+"</span></span></div>";return g};var applyEventsOnA=function(){var a=getPostID("postChildID");$("#"+a+" a.enabled").unbind("click");$("#"+a+" a.enabled").bind("click",function(b){b.preventDefault();manageSelection(this);setValue();if(!ddList){$("#"+a).unbind("mouseover");setInsideWindow(false);var c=options.showIcon==false?$(this).text():$(this).html();setTitleText(c);$this.close()}})};var createDropDown=function(){var a=false;var b=getPostID("postID");var c=getPostID("postTitleID");var d=getPostID("postTitleTextID");var e=getPostID("postChildID");var f=getPostID("postArrowID");var g=$("#"+elementid).outerWidth()+20;g=g+2;var h=options.style;if($("#"+b).length>0){$("#"+b).remove();a=true}var i='<div id="'+b+'" class="'+styles.dd+'"';i+=h!=""?' style="'+h+'"':"";i+=">";i+=createTitleDiv();i+=createChildDiv();i+=createATags();i+="</div>";i+="</div>";if(a==true){var j=getPostID("postElementHolder");$("#"+j).after(i)}else{$("#"+elementid).after(i)}if(ddList){var c=getPostID("postTitleID");$("#"+c).hide()}$("#"+b).css("width",g+"px");$("#"+e).css("width",g-2+"px");if(allOptions.length>options.visibleRows){var k=parseInt($("#"+e+" a:first").css("padding-bottom"))+parseInt($("#"+e+" a:first").css("padding-top"));var l=options.rowHeight*options.visibleRows-k;$("#"+e).css("height",l+"px")}else{if(ddList){var l=$("#"+elementid).height();$("#"+e).css("height",l+"px")}}if(a==false){setOutOfVision();addRefreshMethods(elementid)}if($("#"+elementid).prop("disabled")==true){$("#"+b).css("opacity",styles.disabled)}applyEvents();$("#"+c).bind("mouseover",function(a){hightlightArrow(1)});$("#"+c).bind("mouseout",function(a){hightlightArrow(0)});applyEventsOnA();$("#"+e+" a.disabled").css("opacity",styles.disabled);if(ddList){$("#"+e).bind("mouseover",function(a){if(!actionSettings.keyboardAction){actionSettings.keyboardAction=true;$(document).bind("keydown",function(a){var b=a.keyCode;actionSettings.currentKey=b;if(b==39||b==40){a.preventDefault();a.stopPropagation();next();setValue()}if(b==37||b==38){a.preventDefault();a.stopPropagation();previous();setValue()}})}})}$("#"+e).bind("mouseout",function(a){setInsideWindow(false);$(document).unbind("keydown");actionSettings.keyboardAction=false;actionSettings.currentKey=null});$("#"+c).bind("click",function(a){setInsideWindow(false);if($("#"+e+":visible").length==1){$("#"+e).unbind("mouseover")}else{$("#"+e).bind("mouseover",function(a){setInsideWindow(true)});$this.open()}});$("#"+c).bind("mouseout",function(a){setInsideWindow(false)});if(options.showIcon&&options.useSprite!=false){setTitleImageSprite()}};var getByIndex=function(a){for(var b in a_array){if(a_array[b].index==a){return a_array[b]}}return -1};var manageSelection=function(a){var b=getPostID("postChildID");if($("#"+b+" a."+styles.selected).length==1){oldSelectedValue=$("#"+b+" a."+styles.selected).text()}if(!ddList){$("#"+b+" a."+styles.selected).removeClass(styles.selected)}var c=$("#"+b+" a."+styles.selected).prop("id");if(c!=undefined){var d=actionSettings.oldIndex==undefined||actionSettings.oldIndex==null?a_array[c].index:actionSettings.oldIndex}if(a&&!ddList){$(a).addClass(styles.selected)}if(ddList){var e=actionSettings.currentKey;if($("#"+elementid).prop("multiple")==true){if(e==17){actionSettings.oldIndex=a_array[$(a).prop("id")].index;$(a).toggleClass(styles.selected)}else{if(e==16){$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);var f=$(a).prop("id");var g=a_array[f].index;for(var h=Math.min(d,g);h<=Math.max(d,g);h++){$("#"+getByIndex(h).id).addClass(styles.selected)}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index}}}else{$("#"+b+" a."+styles.selected).removeClass(styles.selected);$(a).addClass(styles.selected);actionSettings.oldIndex=a_array[$(a).prop("id")].index}}};var addRefreshMethods=function(a){var b=a;getElement(b).refresh=function(a){$("#"+b).msDropDown(options)}};var setInsideWindow=function(a){actionSettings.insideWindow=a};var getInsideWindow=function(){return actionSettings.insideWindow};var applyEvents=function(){var a=getPostID("postID");var b=attributes.actions.split(",");for(var c=0;c<b.length;c++){var d=b[c];var e=has_handler(d);if(e==true){switch(d){case"focus":$("#"+a).bind("mouseenter",function(a){getElement(elementid).focus()});break;case"click":$("#"+a).bind("click",function(a){$("#"+elementid).trigger("click")});break;case"dblclick":$("#"+a).bind("dblclick",function(a){$("#"+elementid).trigger("dblclick")});break;case"mousedown":$("#"+a).bind("mousedown",function(a){$("#"+elementid).trigger("mousedown")});break;case"mouseup":$("#"+a).bind("mouseup",function(a){$("#"+elementid).trigger("mouseup")});break;case"mouseover":$("#"+a).bind("mouseover",function(a){$("#"+elementid).trigger("mouseover")});break;case"mousemove":$("#"+a).bind("mousemove",function(a){$("#"+elementid).trigger("mousemove")});break;case"mouseout":$("#"+a).bind("mouseout",function(a){$("#"+elementid).trigger("mouseout")});break}}}};var setOutOfVision=function(){var a=getPostID("postElementHolder");$("#"+elementid).after("<div class='"+styles.ddOutOfVision+"' style='height:0px;overflow:hidden;position:absolute;' id='"+a+"'></div>");$("#"+elementid).appendTo($("#"+a))};var setTitleText=function(a){var b=getPostID("postTitleTextID");$("#"+b).html(a)};var navigateA=function(a){var b=a;var c=getPostID("postChildID");var d=$("#"+c+" a:visible");var e=d.length;var f=$("#"+c+" a:visible").index($("#"+c+" a.selected:visible"));var g;switch(b){case"next":if(f<e-1){f++;g=d[f]}break;case"previous":if(f<e&&f>0){f--;g=d[f]}break}if(typeof g=="undefined"){return false}$("#"+c+" a."+styles.selected).removeClass(styles.selected);$(g).addClass(styles.selected);var h=g.id;if(!ddList){var i=options.showIcon==false?a_array[h].text:$("#"+h).html();setTitleText(i);setTitleImageSprite(a_array[h].index)}if(b=="next"){if(parseInt($("#"+h).position().top+$("#"+h).height())>=parseInt($("#"+c).height())){$("#"+c).scrollTop($("#"+c).scrollTop()+$("#"+h).height()+$("#"+h).height())}}else{if(parseInt($("#"+h).position().top+$("#"+h).height())<=0){$("#"+c).scrollTop($("#"+c).scrollTop()-$("#"+c).height()-$("#"+h).height())}}};var next=function(){navigateA("next")};var previous=function(){navigateA("previous")};var setTitleImageSprite=function(a){if(options.useSprite!=false){var b=getPostID("postTitleTextID");var c=typeof a=="undefined"?getElement(elementid).selectedIndex:a;var d=getElement(elementid).options[c].className;if(d.length>0){var e=getPostID("postChildID");var f=$("#"+e+" a."+d).prop("id");var g=$("#"+f).css("background-image");var h=$("#"+f).css("background-position");var i=$("#"+f).css("padding-left");if(g!=undefined){$("#"+b).find("."+styles.ddTitleText).attr("style","background:"+g)}if(h!=undefined){$("#"+b).find("."+styles.ddTitleText).css("background-position",h)}if(i!=undefined){$("#"+b).find("."+styles.ddTitleText).css("padding-left",i)}$("#"+b).find("."+styles.ddTitleText).css("background-repeat","no-repeat");$("#"+b).find("."+styles.ddTitleText).css("padding-bottom","2px")}}};var setValue=function(){var a=getPostID("postChildID");var b=$("#"+a+" a."+styles.selected);if(b.length==1){var c=$("#"+a+" a."+styles.selected).text();var d=$("#"+a+" a."+styles.selected).prop("id");if(d!=undefined){var e=a_array[d].value;getElement(elementid).selectedIndex=a_array[d].index}if(options.showIcon&&options.useSprite!=false){setTitleImageSprite()}}else{if(b.length>1){for(var f=0;f<b.length;f++){var d=$(b[f]).prop("id");var g=a_array[d].index;getElement(elementid).options[g].selected="selected"}}}var h=getElement(elementid).selectedIndex;$this.ddProp.selectedIndex=h};var has_handler=function(a){if($("#"+elementid).prop("on"+a)!=undefined){return true}var b=$("#"+elementid).data("events");if(b&&b[a]){return true}return false};var checkMethodAndApply=function(){var a=getPostID("postChildID");if(has_handler("change")==true){var b=a_array[$("#"+a+" a.selected").prop("id")].text;if($.trim(oldSelectedValue)!==$.trim(b)&&oldSelectedValue!==""){$("#"+elementid).trigger("change")}}if(has_handler("mouseup")==true){$("#"+elementid).trigger("mouseup")}if(has_handler("blur")==true){$(document).bind("mouseup",function(a){$("#"+elementid).focus();$("#"+elementid)[0].blur();setValue();$(document).unbind("mouseup")})}};var hightlightArrow=function(a){var b=getPostID("postArrowID");if(a==1){$("#"+b).css({backgroundPosition:"0 100%"})}else{$("#"+b).css({backgroundPosition:"0 0"})}};var setOriginalProperties=function(){for(var a in getElement(elementid)){if(typeof getElement(elementid)[a]!="function"&&getElement(elementid)[a]!==undefined&&getElement(elementid)[a]!==null){$this.set(a,getElement(elementid)[a],true)}}};var setValueByIndex=function(a,b){if(getByIndex(b)!=-1){getElement(elementid)[a]=b;var c=getPostID("postChildID");$("#"+c+" a."+styles.selected).removeClass(styles.selected);$("#"+getByIndex(b).id).addClass(styles.selected);var d=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(d)}};var addRemoveFromIndex=function(a,b){if(b=="d"){for(var c in a_array){if(a_array[c].index==a){delete a_array[c];break}}}var d=0;for(var c in a_array){a_array[c].index=d;d++}};var shouldOpenOpposite=function(){var a=getPostID("postChildID");var b=getPostID("postID");var c=$("#"+b).position();var d=$("#"+b).height();var e=$(window).height();var f=$(window).scrollTop();var g=$("#"+a).height();var h={zIndex:options.zIndex,top:c.top+d+"px",display:"none"};var i=options.animStyle;var j=false;var k=styles.noBorderTop;$("#"+a).removeClass(styles.noBorderTop);$("#"+a).removeClass(styles.borderTop);if(e+f<Math.floor(g+d+c.top)){var l=c.top-g;if(c.top-g<0){l=10}h={zIndex:options.zIndex,top:l+"px",display:"none"};i="show";j=true;k=styles.borderTop}return{opp:j,ani:i,css:h,border:k}};var fireOpenEvent=function(){if($this.onActions.onOpen!=null){eval($this.onActions.onOpen)($this)}};var fireCloseEvent=function(){checkMethodAndApply();if($this.onActions.onClose!=null){eval($this.onActions.onClose)($this)}};this.open=function(){if($this.get("disabled",true)==true||$this.get("options",true).length==0){return}var a=getPostID("postChildID");if(msOldDiv!=""&&a!=msOldDiv){$("#"+msOldDiv).slideUp("fast");$("#"+msOldDiv).css({zIndex:"0"})}if($("#"+a).css("display")=="none"){oldSelectedValue=a_array[$("#"+a+" a.selected").prop("id")].text;var b="";oldHeight=$("#"+a).height();$("#"+a+" a").show();$(document).bind("keydown",function(c){var d=c.keyCode;if(d==8){c.preventDefault();c.stopPropagation();b=b.length==0?"":b.substr(0,b.length-1)}switch(d){case 39:case 40:c.preventDefault();c.stopPropagation();next();break;case 37:case 38:c.preventDefault();c.stopPropagation();previous();break;case 27:case 13:$this.close();setValue();break;default:if(d>46){b+=String.fromCharCode(d)}var e=in_array(b);if(e!=-1){$("#"+a).css({height:"auto"});$("#"+a+" a").hide();$(e).show();var f=shouldOpenOpposite();$("#"+a).css(f.css);$("#"+a).css({display:"block"})}else{$("#"+a+" a").show();$("#"+a).css({height:oldHeight+"px"})}break}if(has_handler("keydown")==true){getElement(elementid).onkeydown()}});$(document).bind("keyup",function(a){if($("#"+elementid).prop("onkeyup")!=undefined){getElement(elementid).onkeyup()}});$(document).bind("mouseup",function(a){if(getInsideWindow()==false){$this.close()}});var c=shouldOpenOpposite();$("#"+a).css(c.css);if(c.opp==true){$("#"+a).css({display:"block"});$("#"+a).addClass(c.border);fireOpenEvent()}else{$("#"+a)[c.ani]("fast",function(){$("#"+a).addClass(c.border);fireOpenEvent()})}if(a!=msOldDiv){msOldDiv=a}}};this.close=function(){var a=getPostID("postChildID");var b=$("#"+getPostID("postTitleID")).position().top;var c=shouldOpenOpposite();isFilter=false;if(c.opp==true){$("#"+a).animate({height:0,top:b},function(){$("#"+a).css({height:oldHeight+"px",display:"none"});fireCloseEvent()})}else{$("#"+a).slideUp("fast",function(b){fireCloseEvent();$("#"+a).css({zIndex:"0"});$("#"+a).css({height:oldHeight+"px"})})}setTitleImageSprite();$(document).unbind("keydown");$(document).unbind("keyup");$(document).unbind("mouseup")};this.selectedIndex=function(a){if(typeof a=="undefined"){return $this.get("selectedIndex")}else{$this.set("selectedIndex",a)}};this.debug=function(a){if(typeof a=="undefined"||a==true){$("."+styles.ddOutOfVision).removeAttr("style")}else{$("."+styles.ddOutOfVision).attr("style","height:0px;overflow:hidden;position:absolute")}};this.set=function(a,b,c){if(a==undefined||b==undefined){throw {message:"set to what?"}}$this.ddProp[a]=b;if(c!=true){switch(a){case"selectedIndex":setValueByIndex(a,b);break;case"disabled":$this.disabled(b,true);break;case"multiple":getElement(elementid)[a]=b;ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(ddList){var d=$("#"+elementid).height();var e=getPostID("postChildID");$("#"+e).css("height",d+"px");var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"});applyEventsOnA()}break;case"size":getElement(elementid)[a]=b;if(b==0){getElement(elementid).multiple=false}ddList=$(sElement).prop("size")>0||$(sElement).prop("multiple")==true?true:false;if(b==0){var f=getPostID("postTitleID");$("#"+f).show();var e=getPostID("postChildID");$("#"+e).css({display:"none",position:"absolute"});var g="";if(getElement(elementid).selectedIndex>=0){var h=getByIndex(getElement(elementid).selectedIndex);g=h.html;manageSelection($("#"+h.id))}setTitleText(g)}else{var f=getPostID("postTitleID");$("#"+f).hide();var e=getPostID("postChildID");$("#"+e).css({display:"block",position:"relative"})}break;default:try{getElement(elementid)[a]=b}catch(i){}break}}};this.get=function(a,b){if(a==undefined&&b==undefined){return $this.ddProp}if(a!=undefined&&b==undefined){return $this.ddProp[a]!=undefined?$this.ddProp[a]:null}if(a!=undefined&&b!=undefined){return getElement(elementid)[a]}};this.visible=function(a){var b=getPostID("postID");if(a==true){$("#"+b).show()}else{if(a==false){$("#"+b).hide()}else{return $("#"+b).css("display")}}};this.add=function(a,b){var c=a;var d=c.text;var e=c.value==undefined||c.value==null?d:c.value;var f=c.title==undefined||c.title==null?"":c.title;var g=b==undefined||b==null?getElement(elementid).options.length:b;getElement(elementid).options[g]=new Option(d,e);if(f!=""){getElement(elementid).options[g]["title"]=f}var h=getByIndex(g);if(h!=-1){var i=createA(getElement(elementid).options[g],g,"","");$("#"+h.id).html(i)}else{var i=createA(getElement(elementid).options[g],g,"","");var j=getPostID("postChildID");$("#"+j).append(i);applyEventsOnA()}};this.remove=function(a){getElement(elementid).remove(a);if(getByIndex(a)!=-1){$("#"+getByIndex(a).id).remove();addRemoveFromIndex(a,"d")}if(getElement(elementid).length==0){setTitleText("")}else{var b=getByIndex(getElement(elementid).selectedIndex).html;setTitleText(b)}$this.set("selectedIndex",getElement(elementid).selectedIndex)};this.disabled=function(a,b){getElement(elementid).disabled=a;var c=getPostID("postID");if(a==true){$("#"+c).css("opacity",styles.disabled);$this.close()}else{if(a==false){$("#"+c).css("opacity",1)}}if(b!=true){$this.set("disabled",a)}};this.form=function(){return getElement(elementid).form==undefined?null:getElement(elementid).form};this.item=function(){if(arguments.length==1){return getElement(elementid).item(arguments[0])}else{if(arguments.length==2){return getElement(elementid).item(arguments[0],arguments[1])}else{throw {message:"An index is required!"}}}};this.namedItem=function(a){return getElement(elementid).namedItem(a)};this.multiple=function(a){if(typeof a=="undefined"){return $this.get("multiple")}else{$this.set("multiple",a)}};this.size=function(a){if(typeof a=="undefined"){return $this.get("size")}else{$this.set("size",a)}};this.addMyEvent=function(a,b){$this.onActions[a]=b};this.fireEvent=function(nm){eval($this.onActions[nm])($this)};var updateCommonVars=function(){$this.set("version",$.msDropDown.version);$this.set("author",$.msDropDown.author)};var init=function(){createDropDown();setOriginalProperties();updateCommonVars();if(options.onInit!=""){eval(options.onInit)($this)}};init()};$.msDropDown={version:2.37,author:"Marghoob Suleman",counter:20,create:function(a,b){return $(a).msDropDown(b).data("dd")}};$.fn.extend({msDropDown:function(a){return this.each(function(){var b=new dd(this,a);$(this).data("dd",b)})}});if(typeof $.fn.prop=="undefined"){$.fn.prop=function(a){return $(this).attr(a)}}})(jQuery);Zendesk.NS("Voice");(function($,Zendesk){$(".call-history-container a.sortable, .call-history-container .pagination a").live("click",function(){$.getScript(this.href);return false});$("#call_history a.more").live("click",function(){var call_id=$(this).attr("data-call-id");$("#call_history .breakdown[data-call-id="+call_id+"]").toggle();$(this).toggleClass("expanded");if($(this).hasClass("expanded")){$(this).html(I18n.t("txt.views.voice.settings._call_settings.less_label"))}else{$(this).html(I18n.t("txt.views.voice.settings._call_settings.more_label"))}});Zendesk.Voice.History={filter:function(){$.ajax({url:"/voice/settings/call_history_list?period="+$("#call_billing_period").val(),type:"GET",dataType:"script",beforeSend:function(){$("#call_history .loading-placeholder").addClass("loading")}})}}}(jQuery,Zendesk));Zendesk.NS("Voice");Zendesk.Voice.GreetingsPicker=function(containerSelector){this.formContainer=$j(containerSelector)};Zendesk.Voice.GreetingsPicker.prototype={init:function(){this.waitContainer=this.formContainer.find("#wait_greeting_audio");this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");this.holdContainer=this.formContainer.find("#hold_greeting_audio");_(["wait_greeting","voicemail_greeting","hold_greeting"]).each(function(kind){this.setupAudioPlayer(kind);this.bindGreetingsSelect(kind)},this)},containerForKind:function(kind){switch(kind){case"wait_greeting":return this.waitContainer;case"voicemail_greeting":return this.voicemailContainer;case"hold_greeting":return this.holdContainer}},setupAudioPlayer:function(kind){var container=this.containerForKind(kind);container.find(".audio").each(function(n,audio){audio=$j(audio);var audioID=audio.attr("data-audio-id");var audioURL=audio.attr("data-audio-src");var playerAudio=new Player.Audio({domId:audioID,url:audioURL,swfUrl:"/media/voice/soundmanager"});playerAudio.ready(function(sound){audio.click(function(){if(audio.hasClass("playing")){audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));audio.removeClass("playing");sound.pause()}else{audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.pause"));audio.addClass("playing");sound.play({onfinish:function(){audio.val(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.play"));audio.removeClass("playing")}})}})})})},bindGreetingsSelect:function(kind){var container=this.containerForKind(kind);var self=this;container.find(".greeting_options").change(function(e){var greetingSelect=this;if($j(this).val()=="default"){self.resetGreeting(kind)}else{if($j(this).val()=="new_custom"){self.showCustomGreetingFormMainPage(kind)}else{if($j(this).val()=="none"){self.emptyGreeting(kind)}}}if(e){e.preventDefault()}})},showCustomGreetingFormMainPage:function(kind){var container=this.containerForKind(kind);var greetingSelect=container.find(".greeting_options");if(kind==="hold_greeting"){$j("#custom_greeting_form").html($j("#custom_greeting_form_upload_page").html())}else{$j("#custom_greeting_form").html($j("#custom_greeting_form_main_page").html())}$j("#custom_greeting_form #greeting_upload").attr("name",kind);$j("#custom_greeting_form h2.title").hide();switch(kind){case"wait_greeting":$j("#custom_greeting_available_agents_title").show();break;case"voicemail_greeting":$j("#custom_greeting_voicemail_title").show();break}$j.colorbox.resize();var self=this;$j("#voice_custom_greeting_form #record_custom_greeting_button").click(function(e){self.showCustomGreetingFormRecordPage(kind);if(e){e.preventDefault()}});$j("#voice_custom_greeting_form #greeting_upload").change(this.submitCustomGreetingForm);$j.colorbox({inline:true,href:"#custom_greeting_form",scrolling:false,onClosed:function(){$j(greetingSelect).val($j(greetingSelect).attr("data-audio-type"))},onComplete:function(){var uploadElm=$j("#greeting_upload");var buttonElm=$j("#upload_custom_greeting_button");uploadElm.mouseover(function(){buttonElm.addClass("hover")});uploadElm.mouseout(function(){buttonElm.removeClass("hover")});uploadElm.mousedown(function(){buttonElm.addClass("active")});uploadElm.mouseup(function(){buttonElm.removeClass("active")})}})},showCustomGreetingFormRecordPage:function(kind){var self=this;$j("#custom_greeting_form").html($j("#custom_greeting_form_record_page").html());$j("#voice_custom_greeting_form h2.title").hide();switch(kind){case"wait_greeting":$j("#custom_greeting_available_agents_title").show();break;case"voicemail_greeting":$j("#custom_greeting_voicemail_title").show();break}$j.colorbox.resize();$j("#custom_greeting_form #call_phone_number").focus();$j("#custom_greeting_form #call_phone_number_button").click(function(e){self.startRecordingFlow(kind);if(e){e.preventDefault()}})},startRecordingFlow:function(kind){this.callingNumber=$j("#custom_greeting_form #call_phone_number").val();this.recordingKind=kind;if(!this.callingNumber.match(/\d+/)){return}$j.ajax({url:"/voice/calls/greetings/call_number",type:"post",data:{call_phone_number:this.callingNumber,kind:kind}});var message=I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.calling_you_at",{number:this.callingNumber});$j("#custom_greeting_form").html($j.mustache($j("#custom_greeting_form_record_wait_page").html(),{message:message}));$j("#custom_greeting_form h2.title").hide();switch(kind){case"wait_greeting":$j("#custom_greeting_available_agents_title").show();break;case"voicemail_greeting":$j("#custom_greeting_voicemail_title").show();break}_.defer($j.colorbox.resize);Zendesk.Pubsub.subscribe("call_recording."+Zendesk.currentAccount.id,this.recordingUpdateHandler.bind(this))},recordingUpdateHandler:function(msg){var status=msg.message.status;switch(status){case"complete":this.reloadGreeting(this.recordingKind,function(){$j.colorbox.close();window.location.reload(true)});break;case"incomplete":$j("#custom_greeting_form #record_wait_message").html(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.couldnt_complete_recording"));_.defer($j.colorbox.resize);_.delay($j.colorbox.close,2000);break}},reloadGreeting:function(kind,callback){var self=this;$j.ajax({url:"/voice/settings/greeting",type:"get",data:{kind:kind},success:function(responseText){self.renderGreeting(kind,responseText);if(_.isFunction(callback)){callback()}},error:function(){alert("Error fetching greeting");if(_.isFunction(callback)){callback()}}})},resetGreeting:function(kind){var container=this.containerForKind(kind);var greetingSelect=container.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.this_will_reset"))){$j(greetingSelect).val($j(greetingSelect).attr("data-audio-type"));return}var self=this;$j.ajax({url:"/voice/settings/reset_greeting",type:"delete",data:{kind:kind},success:function(responseText){self.renderGreeting(kind,responseText)},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_resetting_greeting"))}})},emptyGreeting:function(kind){var container=this.containerForKind(kind);var greetingSelect=container.find(".greeting_options");if(!confirm(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.empty_greeting_confirm"))){$j(greetingSelect).val($j(greetingSelect).attr("data-audio-type"));return}var self=this;$j.ajax({url:"/voice/settings",type:"put",data:{kind:kind,blank:true},success:function(responseText){self.renderGreeting(kind,responseText)},error:function(){alert(I18n.t("txt.admin.public.javascripts.views.voice.settings.greeting_config.error_updating_greeting"))}})},renderGreeting:function(kind,html){$j("#"+kind+"_audio").html(html).effect("highlight",{},1000);switch(kind){case"wait_greeting":this.waitContainer=this.formContainer.find("#wait_greeting_audio");break;case"voicemail_greeting":this.voicemailContainer=this.formContainer.find("#voicemail_greeting_audio");break;case"hold_greeting":this.holdContainer=this.formContainer.find("#hold_greeting_audio");break}this.bindGreetingsSelect(kind);this.setupAudioPlayer(kind)},submitCustomGreetingForm:function(){$j("#voice_custom_greeting_form").submit()}};Zendesk.NS("Voice");Zendesk.Voice.NumberPicker=function(elem){this.elem=elem;this.pickedNumber=null};Zendesk.Voice.NumberPicker.prototype={fetchAvailableNumbers:function(){var query=this._getQuery();var self=this;this.elem.find(".area_code_loading_spinner").show();$j.colorbox.resize();$j.get("/voice/phone_numbers/available",{country:query.country,area_code:query.areaCode,contains:query.search,mode:query.mode},function(data){$j("#pre_results").hide();$j(".area_code_loading_spinner").hide();$j("#number_results").html(data);$j("#available_number_list input:radio:first").prop("checked",true);var numberPicker=$j("#number_picker");numberPicker.find("#number_info").hide();numberPicker.find("#number_form .submit input").val("Search again");numberPicker.find("#number_results form").submit(function(e){e.preventDefault();var picked=numberPicker.find(".number_list input:radio:checked");self.showConfirmation(picked.attr("friendly"),picked.attr("region"),picked.attr("price"),query);return false});new Zendesk.Pager(numberPicker.find("#available_number_list"),numberPicker.find(".pagination_links .previous"),numberPicker.find(".pagination_links .next")).paginate(function(){$j.colorbox.resize()});_.defer(function(){$j.colorbox.resize()})})},changeAreaCode:function(){var numberPicker=$j("#number_picker");var country=numberPicker.find("#country").val();var resources=Zendesk.Voice.NumberResources;if(resources[country].area_code){numberPicker.find("#area_code_field, .area_code_parens").show()}else{numberPicker.find("#area_code_field, .area_code_parens").hide()}numberPicker.find("#country_code .code").html("+"+resources[country].code);this._setPrefix(country,numberPicker,resources);$j.colorbox.resize()},_setPrefix:function(country,numberPicker,resources){numberPicker.find("#fixed_prefix").html("");numberPicker.find("#toll_free_dropdown").hide();if(resources[country].toll_free){numberPicker.find("#local_picker").show();var mode=numberPicker.find("#local").val();if(mode==="TollFree"){this._setTollFreePrefix(country,numberPicker);this._lastAreaCode=numberPicker.find("#area_code").val()}else{if(mode==="Local"){numberPicker.find("#area_code").val(this._lastAreaCode||"");if(country=="GB"){numberPicker.find("#area_code").attr("maxlength",4)}else{numberPicker.find("#area_code").attr("maxlength",3)}}}}else{numberPicker.find("#local_picker").hide();this._setCountryPrefix(country,numberPicker,resources)}},_setTollFreePrefix:function(country,numberPicker){numberPicker.find("#area_code_field").hide();if(country=="US"||country=="CA"){numberPicker.find(".area_code_parens").show();numberPicker.find("#toll_free_dropdown").show();numberPicker.find("#toll_prefix").msDropDown();numberPicker.find("#toll_prefix_msdd").width("48px")}else{if(country=="GB"){numberPicker.find("#area_code_field, .area_code_parens").hide();numberPicker.find("#fixed_prefix").html("800");numberPicker.find("#area_code").val("")}}},_setCountryPrefix:function(country,numberPicker,resources){var prefix=resources[country].prefix;if(!prefix||(currentAccount.hasFeature("voiceInternational")&&resources[country].certification)){prefix=""}numberPicker.find("#fixed_prefix").html(prefix)},_getQuery:function(){var resources=Zendesk.Voice.NumberResources;var numberPicker=$j("#number_picker");var country=numberPicker.find("#country").val();var areaCode=numberPicker.find("#area_code").val();var search=numberPicker.find("#number").val();var countryCode=resources[country].code;var mode=numberPicker.find("#local").val();if(!resources[country].toll_free||mode==null){mode="Local"}if(country=="US"||country=="CA"){if(mode=="TollFree"){areaCode=numberPicker.find("#toll_prefix").val();numberPicker.find("#area_code").val(areaCode);if(areaCode=="Any"){areaCode=""}}}if(!currentAccount.hasFeature("voiceInternational")){var fixed_prefix=numberPicker.find("#fixed_prefix").text();if(country!="FR"){search=fixed_prefix+search}}var searchByPrefix=this._searchByPrefix(areaCode,country,resources);var customSearch=(search!=="");return{country:country,areaCode:areaCode,search:search,countryCode:countryCode,mode:mode,searchByPrefix:searchByPrefix,customSearch:customSearch}},_searchByPrefix:function(areaCode,country,resources){if(areaCode===""){return false}return resources[country].area_code},showConfirmation:function(number,region,price,query){var self=this;var countryData=Zendesk.Voice.NumberResources[query.country];if(currentAccount.hasFeature("voiceInternational")){var certification=countryData.certification;var countryName=$j("#country_titletext").text().replace(/\s/g,"");if(certification&&countryData.prefix!==""&&number.replace(/\s/g,"").indexOf("+"+countryData.code+countryData.prefix)>-1){certification=false}var certificationText=certification?I18n.t("txt.admin.views.voice.phone_numbers._confirmation.certification",{country:countryName}):null}var data={friendlynumber:number,price:price,certification:certificationText};var confirmationPage=$j.mustache($j("#confirmation").html(),data);this.elem.find("#number_info").html(confirmationPage).show();this.elem.find("#number_form").hide();this.elem.find("#number_results").hide();this.elem.find(".number_select_loading_spinner").hide();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()});this.elem.find("#number_info form").submit(function(e){e.preventDefault();self.addNumber(self.elem.find(".number_list input:radio:checked").val(),query.country,region,query.mode);return false});this.elem.find(".back a").click(function(e){e.preventDefault();self.elem.find("#number_info").hide();self.elem.find("#number_form").show();self.elem.find("#number_results").show();$j.colorbox.resize();_.defer(function(){$j.colorbox.resize()})})},addNumber:function(number,country,region,mode){this.elem.find(".number_select_loading_spinner").show();this.pickedNumber=number;$j.ajax({url:"/voice/phone_numbers/create",type:"POST",data:{phone_number:number,country:country,location:region,mode:mode},success:function(data){$j("#number_info").html(data);$j("#number_info a#finished").click(function(e){e.preventDefault();document.location.href="/voice/settings?number_added="+number});$j.colorbox.resize()},error:function(){$j(".error").html("<p>Error occurred when adding number. Please try again.</p>");$j(".number_select_loading_spinner").hide();$j(".error").show();$j.colorbox.resize()}});Zendesk.Instrumentation.ToTango.track("Enabled Trial","Voice")}};Zendesk.NS("Voice");Zendesk.Voice.Settings={init:function(){this.bindAddNumberLink();this.numberPicker=new Zendesk.Voice.NumberPicker($j("#number_picker"));this.greetingsPicker=new Zendesk.Voice.GreetingsPicker("#greetings_form");this.greetingsPicker.init();this.ajaxHistoryLoad()},bindAddNumberLink:function(){var self=this;$j("#add_number_link").click(function(e){self.showNumberPicker();if(e){e.preventDefault()}})},showNumberPicker:function(){var self=this;$j("#number_form").html($j.mustache($j("#area_code_search_form").html()));$j("#number_results").html("");$j("#number_picker #country").change(function(e){self.numberPicker.changeAreaCode()});$j("#number_picker #local").change(function(e){self.numberPicker.changeAreaCode()});$j("#number_picker form").submit(function(event){event.preventDefault();self.numberPicker.fetchAvailableNumbers();return false});$j.colorbox({inline:true,href:"#number_picker",width:"490px",onComplete:function(){var numberPicker=$j("#number_picker");numberPicker.find("#country").msDropDown();numberPicker.find("#local").msDropDown();numberPicker.find("#prefix").msDropDown();numberPicker.find("#country").focus()}})},ajaxHistoryLoad:function(){$j.sammy(".tab_links a",function(){this.get("#call_activity",function(){Zendesk.Voice.LiveStats.init()});this.get("#call_history",function(){$j("#call_history .loading-placeholder").addClass("loading");$j.get("/voice/settings/call_history_list",{},function(data){$j("#call_history").html(data)}).always(function(){$j("#call_history .loading-placeholder").removeClass("loading")})});this.get("#general_settings",function(){});this.get("#numbers",function(){});this.get("#greetings",function(){})}).run()}};Zendesk.Voice.LiveStats={init:function(){setTimeout(this.refreshLiveStats,2500);setTimeout(this.refreshLast24Stats,15000)},refreshLiveStats:function(){$j.ajax({url:"/voice/calls/current_queue_activity",type:"GET",dataType:"json",success:function(data){var previous=parseInt($j(".stat.current_calls_waiting .val").html());if(data.current_calls_waiting!=previous){if(data.current_calls_waiting>previous){$j(".stat.current_calls_waiting .indicator").addClass("up");$j(".stat.current_calls_waiting .indicator").removeClass("down")}else{$j(".stat.current_calls_waiting .indicator").removeClass("up");$j(".stat.current_calls_waiting .indicator").addClass("down")}$j(".stat.current_calls_waiting .indicator").fadeIn()}else{$j(".stat.current_calls_waiting .indicator").fadeOut()}$j(".stat.current_calls_waiting .val").html(data.current_calls_waiting);$j(".stat.current_avg_wait_time").html(data.current_avg_wait_time);$j(".stat.current_longest_wait_time").html(data.current_longest_wait_time);for(var i=0;i<data.agents.length;i++){var id=data.agents[i][0];var status=data.agents[i][1];$j(".agent-status.agent-"+id).html("<span class='status-"+status+"'>"+data.statuses[status]+"</span>")}}});if(window.location.hash==="#call_activity"){setTimeout(Zendesk.Voice.LiveStats.refreshLiveStats,5000)}},refreshLast24Stats:function(){$j.ajax({url:"/voice/calls/queue_activity_last_24",type:"GET",dataType:"json",success:function(data){$j(".stat.total_calls").html(data.total_calls);$j(".stat.most_calls_waiting").html(data.most_calls_waiting);$j(".stat.avg_wait_time").html(data.avg_wait_time);$j(".stat.longest_wait_time").html(data.longest_wait_time);$j(".stat.avg_talk_time").html(data.avg_talk_time);for(var i=0;i<data.agents.length;i++){var agent_data=data.agents[i];var id=agent_data.id;$j(".agent-stat.available_time.agent-"+id).html(agent_data.available_time);$j(".agent-stat.calls_accepted.agent-"+id).html(agent_data.calls_accepted);$j(".agent-stat.calls_denied.agent-"+id).html(agent_data.calls_denied);$j(".agent-stat.calls_missed.agent-"+id).html(agent_data.calls_missed);$j(".agent-stat.avg_talk_time.agent-"+id).html(agent_data.avg_talk_time)}}});if(window.location.hash==="#call_activity"){setTimeout(Zendesk.Voice.LiveStats.refreshLast24Stats,30000)}}};(function($,Zendesk){Zendesk.VoiceBanner=(function(){function VoiceBanner(){var self=this;var via_was;var banner=Zendesk.Banner.create({text:"",visible:false,reload:true}).addClass("urgent");var scope="user/"+Zendesk.currentUser.id;var content=function(count){if(count===1){return I18n.t("txt.admin.views.voice._voice_banner.You_have_missed_X_phone_calls_and_are_now_offline.one")}else{return I18n.t("txt.admin.views.voice._voice_banner.You_have_missed_X_phone_calls_and_are_now_offline.other",{count:count})}};var syncBannerDisappear=function(){RadarClient.status(scope).set({availability:"ignored"})};$(banner).find(".reload").show();$(banner).find(".reload a").html("make available").unbind("click").click(function(){if(via_was&&(via_was==="phone"||via_was==="client")){Zendesk.voiceMenu.updateAvailability(via_was,"banner-make-available")}banner.disappear();syncBannerDisappear();return false});RadarClient.alloc("agent_availability").once("ready",function(){RadarClient.status(scope).on(function(message){if(!message.value||!message.value.availability){return}if(message.value.availability==="off"){Zendesk.voiceMenu.updateMenu("off");via_was=message.value.via_was;banner.setContent(content(message.value.max));banner.appear()}if(message.value.availability==="ignored"){banner.disappear()}}).subscribe()});$(banner).bind("ignore.zd.banner",function(){syncBannerDisappear()});this.show=function(){banner.appear()}}return VoiceBanner}())}(jQuery,Zendesk));
/*! Socket.IO.js build:0.9.2, development. Copyright(c) 2011 LearnBoost <dev@learnboost.com> MIT Licensed */
(function(exports,global){var io=exports;io.version="0.9.2";io.protocol=1;io.transports=[];io.j=[];io.sockets={};io.connect=function(host,details){var uri=io.util.parseUri(host),uuri,socket;if(global&&global.location){uri.protocol=uri.protocol||global.location.protocol.slice(0,-1);uri.host=uri.host||(global.document?global.document.domain:global.location.hostname);uri.port=uri.port||global.location.port}uuri=io.util.uniqueUri(uri);var options={host:uri.host,secure:"https"==uri.protocol,port:uri.port||("https"==uri.protocol?443:80),query:uri.query||""};io.util.merge(options,details);if(options["force new connection"]||!io.sockets[uuri]){socket=new io.Socket(options)}if(!options["force new connection"]&&socket){io.sockets[uuri]=socket}socket=socket||io.sockets[uuri];return socket.of(uri.path.length>1?uri.path:"")}})("object"===typeof module?module.exports:(this.io={}),this);(function(exports,global){var util=exports.util={};var re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];util.parseUri=function(str){var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}return uri};util.uniqueUri=function(uri){var protocol=uri.protocol,host=uri.host,port=uri.port;if("document" in global){host=host||document.domain;port=port||(protocol=="https"&&document.location.protocol!=="https:"?443:document.location.port)}else{host=host||"localhost";if(!port&&protocol=="https"){port=443}}return(protocol||"http")+"://"+host+":"+(port||80)};util.query=function(base,addition){var query=util.chunkQuery(base||""),components=[];util.merge(query,util.chunkQuery(addition||""));for(var part in query){if(query.hasOwnProperty(part)){components.push(part+"="+query[part])}}return components.length?"?"+components.join("&"):""};util.chunkQuery=function(qs){var query={},params=qs.split("&"),i=0,l=params.length,kv;for(;i<l;++i){kv=params[i].split("=");if(kv[0]){query[kv[0]]=kv[1]}}return query};var pageLoaded=false;util.load=function(fn){if("document" in global&&document.readyState==="complete"||pageLoaded){return fn()}util.on(global,"load",fn,false)};util.on=function(element,event,fn,capture){if(element.attachEvent){element.attachEvent("on"+event,fn)}else{if(element.addEventListener){element.addEventListener(event,fn,capture)}}};util.request=function(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest){return new XDomainRequest()}if("undefined"!=typeof XMLHttpRequest&&(!xdomain||util.ua.hasCORS)){return new XMLHttpRequest()}if(!xdomain){try{return new window[(["Active"].concat("Object").join("X"))]("Microsoft.XMLHTTP")}catch(e){}}return null};if("undefined"!=typeof window){util.load(function(){pageLoaded=true})}util.defer=function(fn){if(!util.ua.webkit||"undefined"!=typeof importScripts){return fn()}util.load(function(){setTimeout(fn,100)})};util.merge=function merge(target,additional,deep,lastseen){var seen=lastseen||[],depth=typeof deep=="undefined"?2:deep,prop;for(prop in additional){if(additional.hasOwnProperty(prop)&&util.indexOf(seen,prop)<0){if(typeof target[prop]!=="object"||!depth){target[prop]=additional[prop];seen.push(additional[prop])}else{util.merge(target[prop],additional[prop],depth-1,seen)}}}return target};util.mixin=function(ctor,ctor2){util.merge(ctor.prototype,ctor2.prototype)};util.inherit=function(ctor,ctor2){function f(){}f.prototype=ctor2.prototype;ctor.prototype=new f};util.isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};util.intersect=function(arr,arr2){var ret=[],longest=arr.length>arr2.length?arr:arr2,shortest=arr.length>arr2.length?arr2:arr;for(var i=0,l=shortest.length;i<l;i++){if(~util.indexOf(longest,shortest[i])){ret.push(shortest[i])}}return ret};util.indexOf=function(arr,o,i){for(var j=arr.length,i=i<0?i+j<0?0:i+j:i||0;i<j&&arr[i]!==o;i++){}return j<=i?-1:i};util.toArray=function(enu){var arr=[];for(var i=0,l=enu.length;i<l;i++){arr.push(enu[i])}return arr};util.ua={};util.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&(function(){try{var a=new XMLHttpRequest()}catch(e){return false}return a.withCredentials!=undefined})();util.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent)})("undefined"!=typeof io?io:module.exports,this);(function(exports,io){exports.EventEmitter=EventEmitter;function EventEmitter(){}EventEmitter.prototype.on=function(name,fn){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=fn}else{if(io.util.isArray(this.$events[name])){this.$events[name].push(fn)}else{this.$events[name]=[this.$events[name],fn]}}return this};EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.once=function(name,fn){var self=this;function on(){self.removeListener(name,on);fn.apply(this,arguments)}on.listener=fn;this.on(name,on);return this};EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(io.util.isArray(list)){var pos=-1;for(var i=0,l=list.length;i<l;i++){if(list[i]===fn||(list[i].listener&&list[i].listener===fn)){pos=i;break}}if(pos<0){return this}list.splice(pos,1);if(!list.length){delete this.$events[name]}}else{if(list===fn||(list.listener&&list.listener===fn)){delete this.$events[name]}}}return this};EventEmitter.prototype.removeAllListeners=function(name){if(this.$events&&this.$events[name]){this.$events[name]=null}return this};EventEmitter.prototype.listeners=function(name){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=[]}if(!io.util.isArray(this.$events[name])){this.$events[name]=[this.$events[name]]}return this.$events[name]};EventEmitter.prototype.emit=function(name){if(!this.$events){return false}var handler=this.$events[name];if(!handler){return false}var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler){handler.apply(this,args)}else{if(io.util.isArray(handler)){var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args)}}else{return false}}return true}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,nativeJSON){if(nativeJSON&&nativeJSON.parse){return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify}}var JSON=exports.JSON={};function f(n){return n<10?"0"+n:n}function date(d,key){return isFinite(d.valueOf())?d.getUTCFullYear()+"-"+f(d.getUTCMonth()+1)+"-"+f(d.getUTCDate())+"T"+f(d.getUTCHours())+":"+f(d.getUTCMinutes())+":"+f(d.getUTCSeconds())+"Z":null}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value instanceof Date){value=date(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})};JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}})("undefined"!=typeof io?io:module.exports,typeof JSON!=="undefined"?JSON:undefined);(function(exports,io){var parser=exports.parser={};var packets=parser.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"];var reasons=parser.reasons=["transport not supported","client not handshaken","unauthorized"];var advice=parser.advice=["reconnect"];var JSON=io.JSON,indexOf=io.util.indexOf;parser.encodePacket=function(packet){var type=indexOf(packets,packet.type),id=packet.id||"",endpoint=packet.endpoint||"",ack=packet.ack,data=null;switch(packet.type){case"error":var reason=packet.reason?indexOf(reasons,packet.reason):"",adv=packet.advice?indexOf(advice,packet.advice):"";if(reason!==""||adv!==""){data=reason+(adv!==""?("+"+adv):"")}break;case"message":if(packet.data!==""){data=packet.data}break;case"event":var ev={name:packet.name};if(packet.args&&packet.args.length){ev.args=packet.args}data=JSON.stringify(ev);break;case"json":data=JSON.stringify(packet.data);break;case"connect":if(packet.qs){data=packet.qs}break;case"ack":data=packet.ackId+(packet.args&&packet.args.length?"+"+JSON.stringify(packet.args):"");break}var encoded=[type,id+(ack=="data"?"+":""),endpoint];if(data!==null&&data!==undefined){encoded.push(data)}return encoded.join(":")};parser.encodePayload=function(packets){var decoded="";if(packets.length==1){return packets[0]}for(var i=0,l=packets.length;i<l;i++){var packet=packets[i];decoded+="\ufffd"+packet.length+"\ufffd"+packets[i]}return decoded};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;parser.decodePacket=function(data){var pieces=data.match(regexp);if(!pieces){return{}}var id=pieces[2]||"",data=pieces[5]||"",packet={type:packets[pieces[1]],endpoint:pieces[4]||""};if(id){packet.id=id;if(pieces[3]){packet.ack="data"}else{packet.ack=true}}switch(packet.type){case"error":var pieces=data.split("+");packet.reason=reasons[pieces[0]]||"";packet.advice=advice[pieces[1]]||"";break;case"message":packet.data=data||"";break;case"event":try{var opts=JSON.parse(data);packet.name=opts.name;packet.args=opts.args}catch(e){}packet.args=packet.args||[];break;case"json":try{packet.data=JSON.parse(data)}catch(e){}break;case"connect":packet.qs=data||"";break;case"ack":var pieces=data.match(/^([0-9]+)(\+)?(.*)/);if(pieces){packet.ackId=pieces[1];packet.args=[];if(pieces[3]){try{packet.args=pieces[3]?JSON.parse(pieces[3]):[]}catch(e){}}}break;case"disconnect":case"heartbeat":break}return packet};parser.decodePayload=function(data){if(data.charAt(0)=="\ufffd"){var ret=[];for(var i=1,length="";i<data.length;i++){if(data.charAt(i)=="\ufffd"){ret.push(parser.decodePacket(data.substr(i+1).substr(0,length)));i+=Number(length)+1;length=""}else{length+=data.charAt(i)}}return ret}else{return[parser.decodePacket(data)]}}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io){exports.Transport=Transport;function Transport(socket,sessid){this.socket=socket;this.sessid=sessid}io.util.mixin(Transport,io.EventEmitter);Transport.prototype.onData=function(data){this.clearCloseTimeout();if(this.socket.connected||this.socket.connecting||this.socket.reconnecting){this.setCloseTimeout()}if(data!==""){var msgs=io.parser.decodePayload(data);if(msgs&&msgs.length){for(var i=0,l=msgs.length;i<l;i++){this.onPacket(msgs[i])}}}return this};Transport.prototype.onPacket=function(packet){this.socket.setHeartbeatTimeout();if(packet.type=="heartbeat"){return this.onHeartbeat()}if(packet.type=="connect"&&packet.endpoint==""){this.onConnect()}this.socket.onPacket(packet);return this};Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var self=this;this.closeTimeout=setTimeout(function(){self.onDisconnect()},this.socket.closeTimeout)}};Transport.prototype.onDisconnect=function(){if(this.close&&this.open){this.close()}this.clearTimeouts();this.socket.onDisconnect();return this};Transport.prototype.onConnect=function(){this.socket.onConnect();return this};Transport.prototype.clearCloseTimeout=function(){if(this.closeTimeout){clearTimeout(this.closeTimeout);this.closeTimeout=null}};Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout();if(this.reopenTimeout){clearTimeout(this.reopenTimeout)}};Transport.prototype.packet=function(packet){this.send(io.parser.encodePacket(packet))};Transport.prototype.onHeartbeat=function(heartbeat){this.packet({type:"heartbeat"})};Transport.prototype.onOpen=function(){this.open=true;this.clearCloseTimeout();this.socket.onOpen()};Transport.prototype.onClose=function(){var self=this;this.open=false;this.socket.onClose();this.onDisconnect()};Transport.prototype.prepareUrl=function(){var options=this.socket.options;return this.scheme()+"://"+options.host+":"+options.port+"/"+options.resource+"/"+io.protocol+"/"+this.name+"/"+this.sessid};Transport.prototype.ready=function(socket,fn){fn.call(this)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.Socket=Socket;function Socket(options){this.options={port:80,secure:false,document:"document" in global?document:false,resource:"socket.io",transports:io.transports,"connect timeout":10000,"try multiple transports":true,reconnect:true,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3000,"max reconnection attempts":10,"sync disconnect on unload":true,"auto connect":true,"flash policy port":10843};io.util.merge(this.options,options);this.connected=false;this.open=false;this.connecting=false;this.reconnecting=false;this.namespaces={};this.buffer=[];this.doBuffer=false;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||io.util.ua.hasCORS)){var self=this;io.util.on(global,"unload",function(){self.disconnectSync()},false)}if(this.options["auto connect"]){this.connect()}}io.util.mixin(Socket,io.EventEmitter);Socket.prototype.of=function(name){if(!this.namespaces[name]){this.namespaces[name]=new io.SocketNamespace(this,name);if(name!==""){this.namespaces[name].packet({type:"connect"})}}return this.namespaces[name]};Socket.prototype.publish=function(){this.emit.apply(this,arguments);var nsp;for(var i in this.namespaces){if(this.namespaces.hasOwnProperty(i)){nsp=this.of(i);nsp.$emit.apply(nsp,arguments)}}};function empty(){}Socket.prototype.handshake=function(fn){var self=this,options=this.options;function complete(data){if(data instanceof Error){self.onError(data.message)}else{fn.apply(null,data.split(":"))}}var url=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,io.protocol,io.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!io.util.ua.hasCORS){var insertAt=document.getElementsByTagName("script")[0],script=document.createElement("script");script.src=url+"&jsonp="+io.j.length;insertAt.parentNode.insertBefore(script,insertAt);io.j.push(function(data){complete(data);script.parentNode.removeChild(script)})}else{var xhr=io.util.request();xhr.open("GET",url,true);xhr.withCredentials=true;xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.onreadystatechange=empty;if(xhr.status==200){complete(xhr.responseText)}else{!self.reconnecting&&self.onError(xhr.responseText)}}};xhr.send(null)}};Socket.prototype.getTransport=function(override){var transports=override||this.transports,match;for(var i=0,transport;transport=transports[i];i++){if(io.Transport[transport]&&io.Transport[transport].check(this)&&(!this.isXDomain()||io.Transport[transport].xdomainCheck(this))){return new io.Transport[transport](this,this.sessionid)}}return null};Socket.prototype.connect=function(fn){if(this.connecting){return this}var self=this;this.handshake(function(sid,heartbeat,close,transports){self.sessionid=sid;self.closeTimeout=close*1000;self.heartbeatTimeout=heartbeat*1000;self.transports=io.util.intersect(transports.split(","),self.options.transports);self.setHeartbeatTimeout();function connect(transports){if(self.transport){self.transport.clearTimeouts()}self.transport=self.getTransport(transports);if(!self.transport){return self.publish("connect_failed")}self.transport.ready(self,function(){self.connecting=true;self.publish("connecting",self.transport.name);self.transport.open();if(self.options["connect timeout"]){self.connectTimeoutTimer=setTimeout(function(){if(!self.connected){self.connecting=false;if(self.options["try multiple transports"]){if(!self.remainingTransports){self.remainingTransports=self.transports.slice(0)}var remaining=self.remainingTransports;while(remaining.length>0&&remaining.splice(0,1)[0]!=self.transport.name){}if(remaining.length){connect(remaining)}else{self.publish("connect_failed")}}}},self.options["connect timeout"])}})}connect(self.options.transports);self.once("connect",function(){clearTimeout(self.connectTimeoutTimer);fn&&typeof fn=="function"&&fn()})});return this};Socket.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);var self=this;this.heartbeatTimeoutTimer=setTimeout(function(){self.transport.onClose()},this.heartbeatTimeout)};Socket.prototype.packet=function(data){if(this.connected&&!this.doBuffer){this.transport.packet(data)}else{this.buffer.push(data)}return this};Socket.prototype.setBuffer=function(v){this.doBuffer=v;if(!v&&this.connected&&this.buffer.length){this.transport.payload(this.buffer);this.buffer=[]}};Socket.prototype.disconnect=function(){if(this.connected||this.connecting){if(this.open){this.of("").packet({type:"disconnect"})}this.onDisconnect("booted")}return this};Socket.prototype.disconnectSync=function(){var xhr=io.util.request(),uri=this.resource+"/"+io.protocol+"/"+this.sessionid;xhr.open("GET",uri,true);this.onDisconnect("booted")};Socket.prototype.isXDomain=function(){var port=global.location.port||("https:"==global.location.protocol?443:80);return this.options.host!==global.location.hostname||this.options.port!=port};Socket.prototype.onConnect=function(){if(!this.connected){this.connected=true;this.connecting=false;if(!this.doBuffer){this.setBuffer(false)}this.emit("connect")}};Socket.prototype.onOpen=function(){this.open=true};Socket.prototype.onClose=function(){this.open=false;clearTimeout(this.heartbeatTimeoutTimer)};Socket.prototype.onPacket=function(packet){this.of(packet.endpoint).onPacket(packet)};Socket.prototype.onError=function(err){if(err&&err.advice){if(err.advice==="reconnect"&&(this.connected||this.connecting)){this.disconnect();if(this.options.reconnect){this.reconnect()}}}this.publish("error",err&&err.reason?err.reason:err)};Socket.prototype.onDisconnect=function(reason){var wasConnected=this.connected,wasConnecting=this.connecting;this.connected=false;this.connecting=false;this.open=false;if(wasConnected||wasConnecting){this.transport.close();this.transport.clearTimeouts();if(wasConnected){this.publish("disconnect",reason);if("booted"!=reason&&this.options.reconnect&&!this.reconnecting){this.reconnect()}}}};Socket.prototype.reconnect=function(){this.reconnecting=true;this.reconnectionAttempts=0;this.reconnectionDelay=this.options["reconnection delay"];var self=this,maxAttempts=this.options["max reconnection attempts"],tryMultiple=this.options["try multiple transports"],limit=this.options["reconnection limit"];function reset(){if(self.connected){for(var i in self.namespaces){if(self.namespaces.hasOwnProperty(i)&&""!==i){self.namespaces[i].packet({type:"connect"})}}self.publish("reconnect",self.transport.name,self.reconnectionAttempts)}clearTimeout(self.reconnectionTimer);self.removeListener("connect_failed",maybeReconnect);self.removeListener("connect",maybeReconnect);self.reconnecting=false;delete self.reconnectionAttempts;delete self.reconnectionDelay;delete self.reconnectionTimer;delete self.redoTransports;self.options["try multiple transports"]=tryMultiple}function maybeReconnect(){if(!self.reconnecting){return}if(self.connected){return reset()}if(self.connecting&&self.reconnecting){return self.reconnectionTimer=setTimeout(maybeReconnect,1000)}if(self.reconnectionAttempts++>=maxAttempts){if(!self.redoTransports){self.on("connect_failed",maybeReconnect);self.options["try multiple transports"]=true;self.transport=self.getTransport();self.redoTransports=true;self.connect()}else{self.publish("reconnect_failed");reset()}}else{if(self.reconnectionDelay<limit){self.reconnectionDelay*=2}self.connect();self.publish("reconnecting",self.reconnectionDelay,self.reconnectionAttempts);self.reconnectionTimer=setTimeout(maybeReconnect,self.reconnectionDelay)}}this.options["try multiple transports"]=false;this.reconnectionTimer=setTimeout(maybeReconnect,this.reconnectionDelay);this.on("connect",maybeReconnect)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.SocketNamespace=SocketNamespace;function SocketNamespace(socket,name){this.socket=socket;this.name=name||"";this.flags={};this.json=new Flag(this,"json");this.ackPackets=0;this.acks={}}io.util.mixin(SocketNamespace,io.EventEmitter);SocketNamespace.prototype.$emit=io.EventEmitter.prototype.emit;SocketNamespace.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)};SocketNamespace.prototype.packet=function(packet){packet.endpoint=this.name;this.socket.packet(packet);this.flags={};return this};SocketNamespace.prototype.send=function(data,fn){var packet={type:this.flags.json?"json":"message",data:data};if("function"==typeof fn){packet.id=++this.ackPackets;packet.ack=true;this.acks[packet.id]=fn}return this.packet(packet)};SocketNamespace.prototype.emit=function(name){var args=Array.prototype.slice.call(arguments,1),lastArg=args[args.length-1],packet={type:"event",name:name};if("function"==typeof lastArg){packet.id=++this.ackPackets;packet.ack="data";this.acks[packet.id]=lastArg;args=args.slice(0,args.length-1)}packet.args=args;return this.packet(packet)};SocketNamespace.prototype.disconnect=function(){if(this.name===""){this.socket.disconnect()}else{this.packet({type:"disconnect"});this.$emit("disconnect")}return this};SocketNamespace.prototype.onPacket=function(packet){var self=this;function ack(){self.packet({type:"ack",args:io.util.toArray(arguments),ackId:packet.id})}switch(packet.type){case"connect":this.$emit("connect");break;case"disconnect":if(this.name===""){this.socket.onDisconnect(packet.reason||"booted")}else{this.$emit("disconnect",packet.reason)}break;case"message":case"json":var params=["message",packet.data];if(packet.ack=="data"){params.push(ack)}else{if(packet.ack){this.packet({type:"ack",ackId:packet.id})}}this.$emit.apply(this,params);break;case"event":var params=[packet.name].concat(packet.args);if(packet.ack=="data"){params.push(ack)}this.$emit.apply(this,params);break;case"ack":if(this.acks[packet.ackId]){this.acks[packet.ackId].apply(this,packet.args);delete this.acks[packet.ackId]}break;case"error":if(packet.advice){this.socket.onError(packet)}else{if(packet.reason=="unauthorized"){this.$emit("connect_failed",packet.reason)}else{this.$emit("error",packet.reason)}}break}};function Flag(nsp,name){this.namespace=nsp;this.name=name}Flag.prototype.send=function(){this.namespace.flags[this.name]=true;this.namespace.send.apply(this.namespace,arguments)};Flag.prototype.emit=function(){this.namespace.flags[this.name]=true;this.namespace.emit.apply(this.namespace,arguments)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.XHR=XHR;function XHR(socket){if(!socket){return}io.Transport.apply(this,arguments);this.sendBuffer=[]}io.util.inherit(XHR,io.Transport);XHR.prototype.open=function(){this.socket.setBuffer(false);this.onOpen();this.get();this.setCloseTimeout();return this};XHR.prototype.payload=function(payload){var msgs=[];for(var i=0,l=payload.length;i<l;i++){msgs.push(io.parser.encodePacket(payload[i]))}this.send(io.parser.encodePayload(msgs))};XHR.prototype.send=function(data){this.post(data);return this};function empty(){}XHR.prototype.post=function(data){var self=this;this.socket.setBuffer(true);function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;self.posting=false;if(this.status==200){self.socket.setBuffer(false)}else{self.onClose()}}}function onload(){this.onload=empty;self.socket.setBuffer(false)}this.sendXHR=this.request("POST");if(global.XDomainRequest&&this.sendXHR instanceof XDomainRequest){this.sendXHR.onload=this.sendXHR.onerror=onload}else{this.sendXHR.onreadystatechange=stateChange}this.sendXHR.send(data)};XHR.prototype.close=function(){this.onClose();return this};XHR.prototype.request=function(method){var req=io.util.request(this.socket.isXDomain()),query=io.util.query(this.socket.options.query,"t="+ +new Date);req.open(method||"GET",this.prepareUrl()+query,true);if(method=="POST"){try{if(req.setRequestHeader){req.setRequestHeader("Content-type","text/plain;charset=UTF-8")}else{req.contentType="text/plain"}}catch(e){}}return req};XHR.prototype.scheme=function(){return this.socket.options.secure?"https":"http"};XHR.check=function(socket,xdomain){try{var request=io.util.request(xdomain);var uses_xdomainrequest=(global.XDomainRequest&&request instanceof XDomainRequest);var socket_protocol=(socket&&socket.options&&socket.options.secure?"https:":"http:");var is_cross_protocol=(socket_protocol!=global.location.protocol);if(request&&!(uses_xdomainrequest&&is_cross_protocol)){return true}}catch(e){}return false};XHR.xdomainCheck=function(socket){return XHR.check(socket,true)}})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.htmlfile=HTMLFile;function HTMLFile(socket){io.Transport.XHR.apply(this,arguments)}io.util.inherit(HTMLFile,io.Transport.XHR);HTMLFile.prototype.name="htmlfile";HTMLFile.prototype.get=function(){this.doc=new window[(["Active"].concat("Object").join("X"))]("htmlfile");this.doc.open();this.doc.write("<html></html>");this.doc.close();this.doc.parentWindow.s=this;var iframeC=this.doc.createElement("div");iframeC.className="socketio";this.doc.body.appendChild(iframeC);this.iframe=this.doc.createElement("iframe");iframeC.appendChild(this.iframe);var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+query;io.util.on(window,"unload",function(){self.destroy()})};HTMLFile.prototype._=function(data,doc){this.onData(data);try{var script=doc.getElementsByTagName("script")[0];script.parentNode.removeChild(script)}catch(e){}};HTMLFile.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null;this.iframe.parentNode.removeChild(this.iframe);this.iframe=null;CollectGarbage()}};HTMLFile.prototype.close=function(){this.destroy();return io.Transport.XHR.prototype.close.call(this)};HTMLFile.check=function(){if(typeof window!="undefined"&&(["Active"].concat("Object").join("X")) in window){try{var a=new window[(["Active"].concat("Object").join("X"))]("htmlfile");return a&&io.Transport.XHR.check()}catch(e){}}return false};HTMLFile.xdomainCheck=function(){return false};io.transports.push("htmlfile")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports["xhr-polling"]=XHRPolling;function XHRPolling(){io.Transport.XHR.apply(this,arguments)}io.util.inherit(XHRPolling,io.Transport.XHR);io.util.merge(XHRPolling,io.Transport.XHR);XHRPolling.prototype.name="xhr-polling";XHRPolling.prototype.open=function(){var self=this;io.Transport.XHR.prototype.open.call(self);return false};function empty(){}XHRPolling.prototype.get=function(){if(!this.open){return}var self=this;function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;if(this.status==200){self.onData(this.responseText);self.get()}else{self.onClose()}}}function onload(){this.onload=empty;this.onerror=empty;self.onData(this.responseText);self.get()}function onerror(){self.onClose()}this.xhr=this.request();if(global.XDomainRequest&&this.xhr instanceof XDomainRequest){this.xhr.onload=onload;this.xhr.onerror=onerror}else{this.xhr.onreadystatechange=stateChange}this.xhr.send(null)};XHRPolling.prototype.onClose=function(){io.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}this.xhr=null}};XHRPolling.prototype.ready=function(socket,fn){var self=this;io.util.defer(function(){fn.call(self)})};io.transports.push("xhr-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io,global){var indicator=global.document&&"MozAppearance" in global.document.documentElement.style;exports["jsonp-polling"]=JSONPPolling;function JSONPPolling(socket){io.Transport["xhr-polling"].apply(this,arguments);this.index=io.j.length;var self=this;io.j.push(function(msg){self._(msg)})}io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]);JSONPPolling.prototype.name="jsonp-polling";JSONPPolling.prototype.post=function(data){var self=this,query=io.util.query(this.socket.options.query,"t="+(+new Date)+"&i="+this.index);if(!this.form){var form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="socketio_iframe_"+this.index,iframe;form.className="socketio";form.style.position="absolute";form.style.top="-1000px";form.style.left="-1000px";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.prepareUrl()+query;function complete(){initIframe();self.socket.setBuffer(false)}function initIframe(){if(self.iframe){self.form.removeChild(self.iframe)}try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();this.area.value=io.JSON.stringify(data);try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){iframe.onreadystatechange=function(){if(self.iframe.readyState=="complete"){complete()}}}else{this.iframe.onload=complete}this.socket.setBuffer(true)};JSONPPolling.prototype.get=function(){var self=this,script=document.createElement("script"),query=io.util.query(this.socket.options.query,"t="+(+new Date)+"&i="+this.index);if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.prepareUrl()+query;script.onerror=function(){self.onClose()};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt);this.script=script;if(indicator){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype._=function(msg){this.onData(msg);if(this.open){this.get()}return this};JSONPPolling.prototype.ready=function(socket,fn){var self=this;if(!indicator){return fn.call(this)}io.util.load(function(){fn.call(self)})};JSONPPolling.check=function(){return"document" in global};JSONPPolling.xdomainCheck=function(){return true};io.transports.push("jsonp-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);var MiniEventEmitter=function(){};MiniEventEmitter.prototype.each=function(obj,iterator,context){var breaker={};if(obj==null){return}if(Array.prototype.forEach&&obj.forEach===Array.prototype.forEach){obj.forEach(iterator,context)}else{if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(i in obj&&iterator.call(context,obj[i],i,obj)===breaker){return}}}else{for(var key in obj){if(obj.hasOwnProperty(key)){if(iterator.call(context,obj[key],key,obj)===breaker){return}}}}}};MiniEventEmitter.prototype.filter=function(obj,iterator,context){var results=[];if(obj==null){return results}if(Array.prototype.filter&&obj.filter===Array.prototype.filter){return obj.filter(iterator,context)}MiniEventEmitter.prototype.each(obj,function(value,index,list){if(iterator.call(context,value,index,list)){results[results.length]=value}});return results};MiniEventEmitter.prototype.on=function(expr,callback){if(expr instanceof RegExp){this._routes||(this._routes=[]);this._routes.unshift([expr,callback])}else{this._events||(this._events={});this._events[expr]||(this._events[expr]=[]);this._events[expr].unshift(callback)}return this};MiniEventEmitter.prototype.addListener=MiniEventEmitter.prototype.on;MiniEventEmitter.prototype.once=function(event,callback){var self=this;function removeAfter(){self.removeListener(event,removeAfter);callback.apply(this,arguments)}removeAfter.listener=callback;self.on(event,removeAfter);return this};MiniEventEmitter.prototype.when=function(event,callback){var self=this;function check(){if(callback.apply(this,arguments)){self.removeListener(event,check)}}check.listener=callback;self.on(event,check);return this};MiniEventEmitter.prototype.removeListener=function(expr,callback){if(expr instanceof RegExp&&this._routes){this._routes=MiniEventEmitter.prototype.filter(this._routes,function(value){return !(value[0].toString()==expr.toString()&&(value[1]===callback||(value[1].listener&&value[1].listener===callback)))})}else{if(this._events&&this._events[expr]){this._events[expr]=MiniEventEmitter.prototype.filter(this._events[expr],function(value){return !(value===callback||(value.listener&&value.listener===callback))})}}return this};MiniEventEmitter.prototype.removeAllListeners=function(expr){if(arguments.length===0){this._events={};this._routes=[];return}if(expr instanceof RegExp&&this._routes){this._routes=MiniEventEmitter.prototype.filter(this._routes,function(value){return !(value[0].toString()==expr.toString())})}else{if(this._events&&this._events[expr]){this._events[expr]=[]}}return this};MiniEventEmitter.prototype.emit=function(event){var args=Array.prototype.slice.call(arguments,1);if(this._events&&this._events[event]){for(var i=this._events[event].length-1;i>-1&&this._events[event]&&this._events[event][i];i--){this._events[event][i].apply(this,args)}}if(this._routes){for(var i=this._routes.length-1;i>-1;i--){if(this._routes[i][0].test(event)){this._routes[i][1].apply(this,args)}}}return this};MiniEventEmitter.mixin=function(destObject){var props=["on","removeListener","removeAllListeners","emit","next","once","when"];for(var i=0;i<props.length;i++){destObject.prototype[props[i]]=MiniEventEmitter.prototype[props[i]]}};(typeof module!="undefined")&&(module.exports=MiniEventEmitter);(function(){var logs=[];var hive=Minilog("hive");var log=function(){hive.info.apply(hive,arguments)};var maxFailedConnections=4;var failedConnections=0;var default_config={def:{transports:["xhr-polling","jsonp-polling"],secure:true,port:843,"connect timeout":7000,"reconnection limit":1,"max reconnection attempts":5},alt:{transports:["xhr-polling","jsonp-polling"],secure:true,port:443,"connect timeout":7000,"reconnection limit":1,"max reconnection attempts":5,"force new connection":true}};function getConfig(firewall,override){var config_name=(firewall.state==firewall.states.fail?"alt":"def");var config=default_config[config_name]||default_config.def;if(override){if(config_name=="alt"&&override.alt){override=override.alt}if(!override.url&&override.subdomain&&override.domain){override.url=override.subdomain+"."+override.domain}_.each(override,function(value,key){if(key=="maxFailedConnections"){maxFailedConnections=value;return}if(key!="alt"&&(typeof exports!="undefined"||key!="port")){config[key]=value}})}return config}var Firewall=function(options){this.timeout=options.timeout||7000;this.fail=options.fail;this.states={unknown:0,fail:1,success:2};this.state=this.states.unknown;this.guard=null};Firewall.prototype.notifyAttempt=function(){var self=this;this.guard&&clearTimeout(this.guard);log("notifyAttempt set timeout",this.timeout);this.guard=setTimeout(function(){self.notifyFailure()},this.timeout)};Firewall.prototype.notifySuccess=function(){log("notifySuccess");this.guard&&clearTimeout(this.guard);this.state=this.states.success};Firewall.prototype.notifyFailure=function(){log("notifyfailure");this.guard&&clearTimeout(this.guard);if(this.state==this.states.unknown){this.state=this.states.fail;this.fail()}};var Node=function(){this.override_config=null;this.queue=[];this.states={permanently_disconnected:-1,disconnected:0,disconnect:1,connect_failed:2,disconnecting:3,connecting:4,connected:5,auth_fail:6,authenticated:7,wait_sync:8,sync_complete:9,ready:10};this.state=this.states.disconnected;this.waitCounter=0;this.transitionTimer=null;var self=this;this.firewall=new Firewall({fail:function(){log("Firewall timeout, disconnecting from current config");self.disconnect()}});this.channelSyncTimes={}};MiniEventEmitter.mixin(Node);Node.prototype.retransition=function(timeout){var self=this;if(!this.transitionTimer){this.transitionTimer=setTimeout(function(){self.transitionTimer=null;self.transition()},timeout)}};Node.prototype.transition=function(to){var self=this;var s=this.states;if(typeof to!=="undefined"){log("change state from",this.state,"to",to);this.state=to}log("run state",this.state);switch(this.state){case s.permanently_disconnected:break;case s.disconnect:this.state=s.disconnected;failedConnections++;this.retransition(3000);this.emit("disconnect");break;case s.disconnected:this.state=s.connecting;this.initSocket();break;case s.connect_failed:failedConnections++;this.firewall.notifyFailure();this.state=s.disconnected;this.retransition(6000);break;case s.disconnecting:case s.connecting:this.retransition(1000);break;case s.connected:this.emit("connect");this.firewall.notifySuccess();var auth_token=getConfig(this.firewall,this.override_config).auth;log("Connected, send auth ",auth_token);this.publish("auth",auth_token);this.once("auth",function(message){if(!message.success){return self.transition("auth_fail")}log("Auth success");self.emit("auth_success",message);self.transition(s.authenticated)});break;case s.auth_fail:this.emit("auth_fail");break;case s.authenticated:this.waitCounter=0;_(self.queue).each(function(item){if(item.persist){self.publish(item.channel,item.message);self.waitCounter++}});this.transition(s.sync_complete);break;case s.wait_sync:if(this.waitCounter==0){this.removeAllListeners("control");this.transition(s.sync_complete)}break;case s.sync_complete:_(this.queue).each(function(item){if(!item.persist){self.publish(item.channel,item.message)}});this.queue=_(this.queue).filter(function(item){return item.persist});this.transition(s.ready);break;case s.ready:this.emit("ready")}};Node.prototype.initSocket=function(){var self=this;var config=getConfig(this.firewall,this.override_config);if(this.socket&&this.socket.disconnect){this.socket.removeAllListeners("connect");this.socket.removeAllListeners("message");this.socket.removeAllListeners("connect_failed");this.socket.removeAllListeners("disconnect");this.socket.disconnect()}if(failedConnections>maxFailedConnections){this.state=this.states.permanently_disconnected;log("Disconnecting permanently due to repeated connection failures");return}log("Connecting",config);this.socket=io.connect(config.url,config);this.socket.on("connect",function(){self.transition(self.states.connected)});this.socket.on("message",function(msg){try{var data=(typeof msg=="string"?JSON.parse(msg):msg)}catch(e){log("Could not parse message as JSON ",msg);return}if(!data.control&&data.to){log("Receive message "+msg);if(data.at&&(!self.channelSyncTimes[data.to]||data.at>self.channelSyncTimes[data.to])){self.channelSyncTimes[data.to]=data.at}self.emit(data.to,data)}else{if(data.control){log("Receive control "+msg);switch(data.state){case"sync":if(data.to&&data.value&&data.time){var current=newest=self.channelSyncTimes[data.to]||0,length=data.value.length,index=0;while(index<length){var time=data.value[index+1],message=data.value[index];if(time>current){self.emit(data.to,message);newest=time}index+=2}self.channelSyncTimes[data.to]=(newest>data.time?newest:data.time)}break;default:self.emit("control",data)}}}});this.socket.on("connect_failed",function(){self.transition(self.states.connect_failed)});this.socket.on("disconnect",function(){self.transition(self.states.disconnect)});this.firewall.notifyAttempt()};Node.prototype.connect=function(config){config&&(this.override_config=config);this.transition();return this};Node.prototype.subscribe=function(channel){this.publish(channel,{state:"available"},true);return this};Node.prototype.unsubscribe=function(channel){this.removeAllListeners(channel);this.queue.filter(function(msg){return !(msg.channel==channel&&msg.persist==true)});this.publish(channel,{state:"unavailable"})};Node.prototype.publish=function(channel,message,persist){if(failedConnections>maxFailedConnections||this.state==this.states.permanently_disconnected){log("Permanently disconnected, so periodic message will not be sent.");return}log("Publish message "+channel+" "+JSON.stringify(message),persist||false);message.to=channel;if(this.state>=this.states.connected){this.socket.send(JSON.stringify(message));if(persist){this.queue.push({channel:channel,message:message,persist:true})}}else{log("Queuing while waiting to connect",channel,message);this.queue.push({channel:channel,message:message,persist:persist||false});this.transition()}};Node.prototype.read=function(channel){this.publish(channel,{state:"read"})};Node.prototype.write=function(channel,message){message.state="write";this.publish(channel,message)};Node.prototype.sync=function(channel){this.publish(channel,{state:"sync"},true)};Node.prototype.disconnect=function(){log("Disconnecting");this.state=this.states.disconnecting;if(this.socket&&this.socket.socket.connected){this.socket.disconnect()}else{log("Not connected, setting state to disconnected");this.transition(this.states.disconnected)}};var _connection=new Node();Zendesk.Pubsub||(Zendesk.Pubsub={});Zendesk.Pubsub.Node={_configuration:false,configure:function(cfg){Zendesk.Pubsub.Node._configuration=cfg},connect:function(){return _connection.connect(Zendesk.Pubsub.Node._configuration)},subscribe:function(channel){return _connection.subscribe(channel)},unsubscribe:function(channel){return _connection.unsubscribe(channel)},publish:function(channel,message){return _connection.publish(channel,message,false)},sync:function(channel){return _connection.sync(channel)},read:function(channel){return _connection.read(channel)},write:function(channel,message){return _connection.write(channel,message)},on:function(expr,callback){return _connection.on(expr,callback)},once:function(expr,callback){return _connection.once(expr,callback)},disconnect:function(){return _connection.disconnect()},logs:logs,_connection:_connection};Zendesk.Pubsub.connect=function(callback){if(Zendesk.Pubsub.disabled){return}return _connection.once("ready",callback).connect(Zendesk.Xmpp.identity)};Zendesk.Pubsub.subscribe=function(channel,callback){if(Zendesk.Pubsub.disabled){return}return _connection.on(channel,callback).connect(Zendesk.Xmpp.identity).subscribe(channel)};if(typeof exports!="undefined"){exports.Node=Node;exports.Zendesk=Zendesk}}());(function($,Zendesk){var log=Minilog("voice-menu");Zendesk.VoiceMenu=function(){this.name="VoiceMenu"};Zendesk.VoiceMenu.prototype={initialize:function(){log.info("#init-start");var self=this;var _pickAvailability=function(element){var availabilityKind=$(element).attr("data-available");self.updateAvailability(availabilityKind,"user")};var _pickAvailabilityThrottled=_.throttle(_pickAvailability,100);$("#phone_menu .pick_availability").click(function(e){_pickAvailabilityThrottled(this);e.preventDefault()});if($.browser.msie&&$.browser.version<8){$("#phone_menu li[data-available='client']").remove()}$("a.audio_settings").click(function(e){e.preventDefault();self.showFlashPermissions(true)});$(window).load(function(){_.defer(function(){Zendesk.switchBoard._localStorage.init();log.info("#localstorage-init");Zendesk.switchBoard.bind("Zendesk.currentUser.availableForVoiceOn",self.updateMenu.bind(self))})});log.info("#init-finish")},updateAvailability:function(availabilityKind,reason){var self=this;var data={available:availabilityKind,reason:reason,from:window.location.toString()};log.info("#update-availability",{from:Zendesk.currentUser.availableForVoiceOn,to:availabilityKind,reason:reason});$.ajax({url:"/voice/settings/availability",type:"POST",data:data,dataType:"json",success:function(data){log.info("#update-availability-success",{result:data.available,reason:reason});self.lastReason=reason;Zendesk.switchBoard.trigger("Zendesk.currentUser.availableForVoiceOn",data.available)},error:function(data,status,error){log.error("#update-availability-error",{result:status,reason:reason})}})},updateMenu:function(availableOn){var lastReason=this.lastReason;this.lastReason=null;log.info("#update-menu",{from:Zendesk.currentUser.availableForVoiceOn,to:availableOn,lastReason:lastReason});Zendesk.currentUser.availableForVoiceOn=availableOn;$("#phone_menu .pick_availability a").removeClass("on");$("#phone_menu li[data-available='client'] a").toggleClass("on",availableOn==="client");$("#phone_menu li[data-available='phone'] a").toggleClass("on",availableOn==="phone");$("#phone_menu li[data-available='off'] a").toggleClass("on",availableOn==="off");$("#phone_menu #phone_menu_item").toggleClass("on",availableOn!="off");if(availableOn!=="off"&&!this._pubsubEnabled){log.info("#pubsub-init");Zendesk.switchBoard._pubsub.init();Zendesk.CallConsoleApp.subscribeForMessages();this._pubsubEnabled=true}if(availableOn==="client"){if(lastReason==="user"){log.info("#update-menu","#show-flash-permissions");var self=this;var bO=this.backOff([1,2,4,8],function(){return Twilio.MediaStream&&Twilio.MediaStream.initialized});bO.done(function(){Twilio.MediaStream.__queue(function(){self.showFlashPermissions()})}).fail(function(){log.error("#twilio-mediastream-error",{message:"ec6"});alert(I18n.t("txt.voice.error.ec6"))})}}},backOff:function(delayList,check){var dfd=$.Deferred(),timeouts=[],self=this;$.each(delayList,function(index,delay){var fails=(index==delayList.length-1);var to=setTimeout(function(){log.info("#twilio-mediastream",{delay:delay});if(check&&check()){dfd.resolve(delay)}else{if(fails){dfd.reject(delay)}}},delay*1000);timeouts.push(to)});dfd.done(function(delay){log.info("#twilio-mediastream-done",{delay:delay});$.each(timeouts,function(i,to){clearTimeout(to)})}).fail(function(delay){log.error("#twilio-mediastream-fail",{delay:delay})});return dfd.promise()},safeIsMicMuted:function(verbose){try{return Twilio.MediaStream.isMicMuted()}catch(err){log.error("#is-mic-muted-fail",{message:err.message,verbose:verbose});if(verbose){alert(I18n.t("txt.voice.error.ec7"))}return true}},catchFlash:function(callback){try{callback.call(this)}catch(err){if(err.message&&err.message.match("Flash")){log.error("#catch-flash-error",{message:err.message});Zendesk.voiceMenu.updateAvailability("off","flash. "+err.message);alert(I18n.t("txt.voice.error.ec8",{error:err.message}))}throw (err)}},showFlashPermissions:function(force){log.info("#show-flash-permissions");var self=this;self.catchFlash(function(){if(!Twilio.Device.instance){Twilio.Device.setup(Zendesk.CallConsoleApp.capabilityToken);log.info("#flash-setup")}if(self.safeIsMicMuted(true)||force){log.info("#flash-show");Twilio.MediaStream.__queue(function(){Twilio.Device.instance.showSettings(function(){if(self.safeIsMicMuted(false)){if(Zendesk.currentUser.availableForVoiceOn==="client"){log.error("#flash-setup-denied");Zendesk.voiceMenu.updateAvailability("off","microphone");alert(I18n.t("txt.voice.error.ec9"))}}})})}})}}}(jQuery,Zendesk));if(typeof(Voice)==="undefined"){Voice={}}Voice.Timer=(function(){function Timer(selector){this.element=jQuery(selector);this.turnOff()}Timer.prototype.off=function(){return this._lastReset===null};Timer.prototype.reset=function(){this._lastReset=new Date();return this};Timer.prototype.turnOff=function(){this._lastReset=null;return this};Timer.prototype.shouldStop=function(){return false};Timer.prototype.update=function(){this.element.html(this._toHTML());return this};Timer.prototype.stop=function(callback){this.stopCallback=callback;return this};Timer.prototype.triggerStop=function(callback){if(this.stopCallback){this.stopCallback()}this.element.hide();return this};Timer.prototype._toHTML=function(){if(this._lastReset){var since=this._sinceLastReset();return I18n.t("txt.admin.public.javascripts.views.voice.voice_timer.time",{minutes:since[0],seconds:since[1]})}else{return"--"}};Timer.prototype._sinceLastReset=function(){var diffInSeconds=this._diffInSeconds();return[Math.floor(diffInSeconds/60),Math.floor(diffInSeconds%60)]};Timer.prototype._diffInSeconds=function(){var diffInSeconds=((new Date())-this._lastReset)/1000;return diffInSeconds};return Timer}());var __hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child};Voice.CountdownTimer=(function(_super){__extends(CountdownTimer,_super);function CountdownTimer(){return CountdownTimer.__super__.constructor.apply(this,arguments)}CountdownTimer.prototype.shouldStop=function(){var diffInSeconds=-1*this._diffInSeconds();diffInSeconds=Math.round(diffInSeconds);if(diffInSeconds<=0){return true}return false};CountdownTimer.prototype._toHTML=function(){if(this._lastReset){var diffInSeconds=-1*this._diffInSeconds();diffInSeconds=Math.round(diffInSeconds);return I18n.t("txt.admin.public.javascripts.views.voice.voice_countdown_timer.seconds",{seconds:diffInSeconds})}else{return"--"}};return CountdownTimer}(Voice.Timer));Voice.TimerManager=(function(){function TimerManager(timer,startTime){timer._lastReset=startTime;var manager=this;this._job=function(){if(timer.shouldStop()){manager.stop();timer.triggerStop()}timer.update()};this.start()}TimerManager.prototype.start=function(){var worker=TimerManager.worker();worker.jobs.push(this._job);worker.start();return this};TimerManager.prototype.stop=function(){var worker=TimerManager.worker();worker.jobs=_(worker.job).without(this._job);if(worker.jobs.length===0){worker.stop()}return this};TimerManager.worker=function(){if(!this._worker){var updatesPerSecond=5;this._worker=new PeriodicWorker(1000/updatesPerSecond)}return this._worker};return TimerManager}());(function(Cookie,$,Zendesk){Zendesk.AlertManager=function(selector,key){this._selector=""+selector;this._key=""+key;$(selector+" a.close").click(this.hide.bind(this))};Zendesk.AlertManager.prototype={show:function(){if(Zendesk.SettingsCookie.get(this._key)==null){$(this._selector).show()}},hide:function(event){event&&event.preventDefault&&event.preventDefault();Zendesk.SettingsCookie.set(this._key,"1");$(this._selector).hide();return false}}}(this.Cookie,this.jQuery,this.Zendesk));