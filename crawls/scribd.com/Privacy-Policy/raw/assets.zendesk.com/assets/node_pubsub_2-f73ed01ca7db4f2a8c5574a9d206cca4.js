(function(){var global=this;function debug(){return debug}function require(p,parent){var path=require.resolve(p),mod=require.modules[path];if(!mod){throw new Error('failed to require "'+p+'" from '+parent)}if(!mod.exports){mod.exports={};mod.call(mod.exports,mod,mod.exports,require.relative(path),global)}return mod.exports}require.modules={};require.resolve=function(path){var orig=path,reg=path+".js",index=path+"/index.js";return require.modules[reg]&&reg||require.modules[index]&&index||orig};require.register=function(path,fn){require.modules[path]=fn};require.relative=function(parent){return function(p){if("debug"==p){return debug}if("."!=p.charAt(0)){return require(p)}var path=parent.split("/"),segs=p.split("/");path.pop();for(var i=0;i<segs.length;i++){var seg=segs[i];if(".."==seg){path.pop()}else{if("."!=seg){path.push(seg)}}}return require(path.join("/"),parent)}};require.register("engine.io-client.js",function(module,exports,require,global){exports.version="0.2.2";exports.protocol=1;exports.util=require("./util");exports.parser=require("./parser");exports.Socket=require("./socket");exports.EventEmitter=require("./event-emitter");exports.Transport=require("./transport");exports.transports=require("./transports")});require.register("event-emitter.js",function(module,exports,require,global){module.exports=EventEmitter;function EventEmitter(){}EventEmitter.prototype.on=function(name,fn){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=fn}else{if(isArray(this.$events[name])){this.$events[name].push(fn)}else{this.$events[name]=[this.$events[name],fn]}}return this};EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.once=function(name,fn){var self=this;function on(){self.removeListener(name,on);fn.apply(this,arguments)}on.listener=fn;this.on(name,on);return this};EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(isArray(list)){var pos=-1;for(var i=0,l=list.length;i<l;i++){if(list[i]===fn||(list[i].listener&&list[i].listener===fn)){pos=i;break}}if(pos<0){return this}list.splice(pos,1);if(!list.length){delete this.$events[name]}}else{if(list===fn||(list.listener&&list.listener===fn)){delete this.$events[name]}}}return this};EventEmitter.prototype.removeAllListeners=function(name){if(name===undefined){this.$events={};return this}if(this.$events&&this.$events[name]){this.$events[name]=null}return this};EventEmitter.prototype.listeners=function(name){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=[]}if(!isArray(this.$events[name])){this.$events[name]=[this.$events[name]]}return this.$events[name]};EventEmitter.prototype.emit=function(name){if(!this.$events){return false}var handler=this.$events[name];if(!handler){return false}var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler){handler.apply(this,args)}else{if(isArray(handler)){var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args)}}else{return false}}return true};function isArray(obj){return"[object Array]"==Object.prototype.toString.call(obj)}EventEmitter.prototype.addEventListener=EventEmitter.prototype.on;EventEmitter.prototype.removeEventListener=EventEmitter.prototype.removeListener;EventEmitter.prototype.dispatchEvent=EventEmitter.prototype.emit});require.register("parser.js",function(module,exports,require,global){var util=require("./util");var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6};var packetslist=util.keys(packets);var err={type:"error",data:"parser error"};exports.encodePacket=function(packet){var encoded=packets[packet.type];if(undefined!==packet.data){encoded+=String(packet.data)}return""+encoded};exports.decodePacket=function(data){var type=data.charAt(0);if(Number(type)!=type||!packetslist[type]){return err}if(data.length>1){return{type:packetslist[type],data:data.substring(1)}}else{return{type:packetslist[type]}}};exports.encodePayload=function(packets){if(!packets.length){return"0:"}var encoded="",message;for(var i=0,l=packets.length;i<l;i++){message=exports.encodePacket(packets[i]);encoded+=message.length+":"+message}return encoded};exports.decodePayload=function(data){if(data==""){return[err]}var packets=[],length="",n,msg,packet;for(var i=0,l=data.length;i<l;i++){var chr=data.charAt(i);if(":"!=chr){length+=chr}else{if(""==length||(length!=(n=Number(length)))){return[err]}msg=data.substr(i+1,n);if(length!=msg.length){return[err]}if(msg.length){packet=exports.decodePacket(msg);if(err.type==packet.type&&err.data==packet.data){return[err]}packets.push(packet)}i+=n;length=""}}if(length!=""){return[err]}return packets}});require.register("socket.js",function(module,exports,require,global){var util=require("./util"),transports=require("./transports"),debug=require("debug")("engine-client:socket"),EventEmitter=require("./event-emitter");module.exports=Socket;function Socket(opts){if("string"==typeof opts){var uri=util.parseUri(opts);opts=arguments[1]||{};opts.host=uri.host;opts.secure=uri.scheme=="https"||uri.scheme=="wss";opts.port=uri.port||(opts.secure?443:80)}opts=opts||{};this.secure=opts.secure||false;this.host=opts.host||opts.hostname||"localhost";this.port=opts.port||80;this.query=opts.query||{};this.query.uid=rnd();this.upgrade=false!==opts.upgrade;this.resource=opts.resource||"default";this.path=(opts.path||"/engine.io").replace(/\/$/,"");this.path+="/"+this.resource+"/";this.forceJSONP=!!opts.forceJSONP;this.timestampParam=opts.timestampParam||"t";this.timestampRequests=!!opts.timestampRequests;this.flashPath=opts.flashPath||"";this.transports=opts.transports||["polling","websocket","flashsocket"];this.readyState="";this.writeBuffer=[];this.policyPort=opts.policyPort||843;this.open()}util.inherits(Socket,EventEmitter);Socket.prototype.createTransport=function(name){debug('creating transport "%s"',name);var query=clone(this.query);query.transport=name;if(this.id){query.sid=this.id}var transport=new transports[name]({host:this.host,port:this.port,secure:this.secure,path:this.path,query:query,forceJSONP:this.forceJSONP,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,flashPath:this.flashPath,policyPort:this.policyPort});return transport};function clone(obj){var o={};for(var i in obj){if(obj.hasOwnProperty(i)){o[i]=obj[i]}}return o}Socket.prototype.open=function(){this.readyState="opening";var transport=this.createTransport(this.transports[0]);transport.open();this.setTransport(transport)};Socket.prototype.setTransport=function(transport){var self=this;if(this.transport){debug("clearing existing transport");this.transport.removeAllListeners()}this.transport=transport;transport.on("drain",function(){self.flush()}).on("packet",function(packet){self.onPacket(packet)}).on("error",function(e){self.onError(e)}).on("close",function(){self.onClose("transport close")})};Socket.prototype.probe=function(name){debug('probing transport "%s"',name);var transport=this.createTransport(name,{probe:1}),self=this;transport.once("open",function(){debug('probe transport "%s" opened',name);transport.send([{type:"ping",data:"probe"}]);transport.once("packet",function(msg){if("pong"==msg.type&&"probe"==msg.data){debug('probe transport "%s" pong',name);self.upgrading=true;self.emit("upgrading",transport);debug('pausing current transport "%s"',self.transport.name);self.transport.pause(function(){if("closed"==self.readyState||"closing"==self.readyState){return}debug("changing transport and sending upgrade packet");self.emit("upgrade",transport);self.setTransport(transport);transport.send([{type:"upgrade"}]);transport=null;self.upgrading=false;self.flush()})}else{debug('probe transport "%s" failed',name);var err=new Error("probe error");err.transport=transport.name;self.emit("error",err)}})});transport.open();this.once("close",function(){if(transport){debug("socket closed prematurely - aborting probe");transport.close();transport=null}});this.once("upgrading",function(to){if(transport&&to.name!=transport.name){debug('"%s" works - aborting "%s"',to.name,transport.name);transport.close();transport=null}})};Socket.prototype.onOpen=function(){debug("socket open");this.readyState="open";this.emit("open");this.onopen&&this.onopen.call(this);this.flush();if(this.upgrade&&this.transport.pause){debug("starting upgrade probes");for(var i=0,l=this.upgrades.length;i<l;i++){this.probe(this.upgrades[i])}}};Socket.prototype.onPacket=function(packet){if("opening"==this.readyState||"open"==this.readyState){debug('socket receive: type "%s", data "%s"',packet.type,packet.data);switch(packet.type){case"open":this.onHandshake(util.parseJSON(packet.data));break;case"ping":this.sendPacket("pong");this.setPingTimeout();break;case"error":var err=new Error("server error");err.code=packet.data;this.emit("error",err);break;case"message":this.emit("message",packet.data);var event={data:packet.data};event.toString=function(){return packet.data};this.onmessage&&this.onmessage.call(this,event);break}}else{debug('packet received with socket readyState "%s"',this.readyState)}};Socket.prototype.onHandshake=function(data){this.emit("handshake",data);this.id=data.sid;this.transport.query.sid=data.sid;this.upgrades=data.upgrades;this.pingTimeout=data.pingTimeout;this.onOpen();this.setPingTimeout()};Socket.prototype.setPingTimeout=function(){clearTimeout(this.pingTimeoutTimer);var self=this;this.pingTimeoutTimer=setTimeout(function(){self.onClose("ping timeout")},this.pingTimeout)};Socket.prototype.flush=function(){if("closed"!=this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){debug("flushing %d packets in socket",this.writeBuffer.length);this.transport.send(this.writeBuffer);this.writeBuffer=[]}};Socket.prototype.send=function(msg){this.sendPacket("message",msg);return this};Socket.prototype.sendPacket=function(type,data){var packet={type:type,data:data};this.writeBuffer.push(packet);this.flush()};Socket.prototype.close=function(){if("opening"==this.readyState||"open"==this.readyState){this.onClose("forced close");debug("socket closing - telling transport to close");this.transport.close()}return this};Socket.prototype.onError=function(err){this.emit("error",err);this.onClose("transport error",err)};Socket.prototype.onClose=function(reason,desc){if("closed"!=this.readyState){debug('socket close with reason: "%s"',reason);this.readyState="closed";this.emit("close",reason,desc);this.onclose&&this.onclose.call(this)}};function rnd(){return String(Math.random()).substr(5)+String(Math.random()).substr(5)}});require.register("transport.js",function(module,exports,require,global){var util=require("./util"),parser=require("./parser"),EventEmitter=require("./event-emitter");module.exports=Transport;function Transport(opts){this.path=opts.path;this.host=opts.host;this.port=opts.port;this.secure=opts.secure;this.query=opts.query;this.timestampParam=opts.timestampParam;this.timestampRequests=opts.timestampRequests;this.readyState=""}util.inherits(Transport,EventEmitter);Transport.prototype.onError=function(msg,desc){var err=new Error(msg);err.type="TransportError";err.description=desc;this.emit("error",err);return this};Transport.prototype.open=function(){if("closed"==this.readyState||""==this.readyState){this.readyState="opening";this.doOpen()}return this};Transport.prototype.close=function(){if("opening"==this.readyState||"open"==this.readyState){this.doClose();this.onClose()}return this};Transport.prototype.send=function(packets){if("open"==this.readyState){this.write(packets)}else{throw new Error("Transport not open")}};Transport.prototype.onOpen=function(){this.readyState="open";this.writable=true;this.emit("open")};Transport.prototype.onData=function(data){this.onPacket(parser.decodePacket(data))};Transport.prototype.onPacket=function(packet){this.emit("packet",packet)};Transport.prototype.onClose=function(){this.readyState="closed";this.emit("close")}});require.register("transports/flashsocket.js",function(module,exports,require,global){var WS=require("./websocket"),util=require("../util");module.exports=FlashWS;function FlashWS(options){WS.call(this,options);this.flashPath=options.flashPath;this.policyPort=options.policyPort}util.inherits(FlashWS,WS);FlashWS.prototype.name="flashsocket";FlashWS.prototype.doOpen=function(){if(!this.check()){return}function log(type){return function(){var str=Array.prototype.join.call(arguments," ")}}WEB_SOCKET_LOGGER={log:log("debug"),error:log("error")};WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=true;WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=true;if("undefined"==typeof WEB_SOCKET_SWF_LOCATION){WEB_SOCKET_SWF_LOCATION=this.flashPath+"WebSocketMainInsecure.swf"}var deps=[this.flashPath+"web_socket.js"];if("undefined"==typeof swfobject){deps.unshift(this.flashPath+"swfobject.js")}var self=this;load(deps,function(){self.ready(function(){WebSocket.__addTask(function(){WS.prototype.doOpen.call(self)})})})};FlashWS.prototype.doClose=function(){if(!this.socket){return}var self=this;WebSocket.__addTask(function(){WS.prototype.doClose.call(self)})};FlashWS.prototype.write=function(){var self=this,args=arguments;WebSocket.__addTask(function(){WS.prototype.write.apply(self,args)})};FlashWS.prototype.ready=function(fn){if(typeof WebSocket=="undefined"||!("__initialize" in WebSocket)||!swfobject){return}if(swfobject.getFlashPlayerVersion().major<10){return}function init(){if(!FlashWS.loaded){if(843!=self.policyPort){WebSocket.loadFlashPolicyFile("xmlsocket://"+self.host+":"+self.policyPort)}WebSocket.__initialize();FlashWS.loaded=true}fn.call(self)}var self=this;if(document.body){return init()}util.load(init)};FlashWS.prototype.check=function(){if(typeof WebSocket!="undefined"&&!("__initialize" in WebSocket)){return false}if(window.ActiveXObject){var control=null;try{control=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){}if(control){return true}}else{for(var i=0,l=navigator.plugins.length;i<l;i++){for(var j=0,m=navigator.plugins[i].length;j<m;j++){if(navigator.plugins[i][j].description=="Shockwave Flash"){return true}}}}return false};var scripts={};function create(path,fn){if(scripts[path]){return fn()}var el=document.createElement("script"),loaded=false;el.onload=el.onreadystatechange=function(){if(loaded||scripts[path]){return}var rs=el.readyState;if(!rs||"loaded"==rs||"complete"==rs){el.onload=el.onreadystatechange=null;loaded=true;scripts[path]=true;fn()}};el.async=1;el.src=path;var head=document.getElementsByTagName("head")[0];head.insertBefore(el,head.firstChild)}function load(arr,fn){function process(i){if(!arr[i]){return fn()}create(arr[i],function(){process(++i)})}process(0)}});require.register("transports/index.js",function(module,exports,require,global){var XHR=require("./polling-xhr"),JSONP=require("./polling-jsonp"),websocket=require("./websocket"),flashsocket=require("./flashsocket"),util=require("../util");exports.polling=polling;exports.websocket=websocket;exports.flashsocket=flashsocket;function polling(opts){var xhr,xd=false,isXProtocol=false;if(global.location){xd=opts.host!=global.location.hostname||global.location.port!=opts.port;isXProtocol=(opts.secure!==(global.location.protocol==="https:"))}xhr=util.request(xd);if(isXProtocol&&global.XDomainRequest&&xhr instanceof global.XDomainRequest){return new JSONP(opts)}if(xhr&&!opts.forceJSONP){return new XHR(opts)}else{return new JSONP(opts)}}});require.register("transports/polling-jsonp.js",function(module,exports,require,global){var Polling=require("./polling"),util=require("../util");module.exports=JSONPPolling;var rNewline=/\n/g;var callbacks;var index=0;function empty(){}function JSONPPolling(opts){Polling.call(this,opts);if(!callbacks){if(!global.___eio){global.___eio=[]}callbacks=global.___eio}this.index=callbacks.length;var self=this;callbacks.push(function(msg){self.onData(msg)});this.query.j=this.index}util.inherits(JSONPPolling,Polling);JSONPPolling.prototype.doOpen=function(){var self=this;util.defer(function(){Polling.prototype.doOpen.call(self)})};JSONPPolling.prototype.doClose=function(){if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}if(this.form){this.form.parentNode.removeChild(this.form);this.form=null}Polling.prototype.doClose.call(this)};JSONPPolling.prototype.doPoll=function(){var script=document.createElement("script");if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.uri();var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt);this.script=script;if(util.ua.gecko){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype.doWrite=function(data,fn){var self=this;if(!this.form){var form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="eio_iframe_"+this.index,iframe;form.className="socketio";form.style.position="absolute";form.style.top="-1000px";form.style.left="-1000px";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.uri();function complete(){initIframe();fn()}function initIframe(){if(self.iframe){self.form.removeChild(self.iframe)}try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();this.area.value=data.replace(rNewline,"\\n");try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){this.iframe.onreadystatechange=function(){if(self.iframe.readyState=="complete"){complete()}}}else{this.iframe.onload=complete}}});require.register("transports/polling-xhr.js",function(module,exports,require,global){var Polling=require("./polling"),EventEmitter=require("../event-emitter"),util=require("../util");module.exports=XHR;module.exports.Request=Request;function empty(){}function XHR(opts){Polling.call(this,opts);if(global.location){this.xd=opts.host!=global.location.hostname||global.location.port!=opts.port}}util.inherits(XHR,Polling);XHR.prototype.doOpen=function(){var self=this;util.defer(function(){Polling.prototype.doOpen.call(self)})};XHR.prototype.request=function(opts){opts=opts||{};opts.uri=this.uri();opts.xd=this.xd;return new Request(opts)};XHR.prototype.doWrite=function(data,fn){var req=this.request({method:"POST",data:data}),self=this;req.on("success",fn);req.on("error",function(err){self.onError("xhr post error",err)});this.sendXhr=req};XHR.prototype.doPoll=function(){var req=this.request(),self=this;req.on("data",function(data){self.onData(data)});req.on("error",function(err){self.onError("xhr poll error",err)});this.pollXhr=req};function Request(opts){this.method=opts.method||"GET";this.uri=opts.uri;this.xd=!!opts.xd;this.async=false!==opts.async;this.data=undefined!=opts.data?opts.data:null;this.create()}util.inherits(Request,EventEmitter);Request.prototype.create=function(){var xhr=this.xhr=util.request(this.xd),self=this;xhr.open(this.method,this.uri,this.async);if("POST"==this.method){try{if(xhr.setRequestHeader){xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}else{xhr.contentType="text/plain"}}catch(e){}}if(this.xd&&global.XDomainRequest&&xhr instanceof XDomainRequest){xhr.onerror=function(e){self.onError(e)};xhr.onload=function(){self.onData(xhr.responseText)};xhr.onprogress=empty}else{if("withCredentials" in xhr){xhr.withCredentials=true}xhr.onreadystatechange=function(){var data;try{if(4!=xhr.readyState){return}if(200==xhr.status||1223==xhr.status){data=xhr.responseText}else{self.onError(xhr.status)}}catch(e){self.onError(e)}if(undefined!==data){self.onData(data)}}}xhr.send(this.data);if(global.ActiveXObject){this.index=Request.requestsCount++;Request.requests[this.index]=this}};Request.prototype.onSuccess=function(){this.emit("success");this.cleanup()};Request.prototype.onData=function(data){this.emit("data",data);this.onSuccess()};Request.prototype.onError=function(err){this.emit("error",err);this.cleanup()};Request.prototype.cleanup=function(){this.xhr.onreadystatechange=empty;this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}if(global.ActiveXObject){delete Request.requests[this.index]}this.xhr=null};Request.prototype.abort=function(){this.cleanup()};if(global.ActiveXObject){Request.requestsCount=0;Request.requests={};global.attachEvent("onunload",function(){for(var i in Request.requests){if(Request.requests.hasOwnProperty(i)){Request.requests[i].abort()}}})}});require.register("transports/polling.js",function(module,exports,require,global){var Transport=require("../transport"),util=require("../util"),parser=require("../parser");module.exports=Polling;function Polling(opts){Transport.call(this,opts)}util.inherits(Polling,Transport);Polling.prototype.name="polling";Polling.prototype.doOpen=function(){this.poll()};Polling.prototype.pause=function(onPause){var pending=0,self=this;this.readyState="pausing";function pause(){self.readyState="paused";onPause()}if(this.polling||!this.writable){var total=0;if(this.polling){total++;this.once("pollComplete",function(){--total||pause()})}if(!this.writable){total++;this.once("drain",function(){--total||pause()})}}else{pause()}};Polling.prototype.poll=function(){this.polling=true;this.doPoll();this.emit("poll")};Polling.prototype.onData=function(data){var packets=parser.decodePayload(data);for(var i=0,l=packets.length;i<l;i++){if("opening"==this.readyState){this.onOpen()}if("close"==packets[i].type){this.onClose();return}this.onPacket(packets[i])}this.polling=false;this.emit("pollComplete");if("open"==this.readyState){this.poll()}else{}};Polling.prototype.doClose=function(){this.send([{type:"close"}])};Polling.prototype.write=function(packets){var self=this;this.writable=false;this.doWrite(parser.encodePayload(packets),function(){self.writable=true;self.emit("drain")})};Polling.prototype.uri=function(){var query=this.query||{},schema=this.secure?"https":"http",port="";if(global.ActiveXObject||util.ua.android||this.timestampRequests){query[this.timestampParam]=+new Date}query=util.qs(query);if(this.port&&(("https"==schema&&this.port!=443)||("http"==schema&&this.port!=80))){port=":"+this.port}if(query.length){query="?"+query}return schema+"://"+this.host+port+this.path+query}});require.register("transports/websocket.js",function(module,exports,require,global){var Transport=require("../transport"),parser=require("../parser"),util=require("../util");module.exports=WS;function WS(opts){Transport.call(this,opts)}util.inherits(WS,Transport);WS.prototype.name="websocket";WS.prototype.doOpen=function(){if(!this.check()){return}var self=this;this.socket=new (ws())(this.uri());this.socket.onopen=function(){self.onOpen()};this.socket.onclose=function(){self.onClose()};this.socket.onmessage=function(ev){self.onData(ev.data)};this.socket.onerror=function(e){self.onError("websocket error",e)}};WS.prototype.write=function(packets){for(var i=0,l=packets.length;i<l;i++){this.socket.send(parser.encodePacket(packets[i]))}};WS.prototype.doClose=function(){if(typeof this.socket!=="undefined"){this.socket.close()}};WS.prototype.uri=function(){var query=this.query||{},schema=this.secure?"wss":"ws",port="";if(this.port&&(("wss"==schema&&this.port!=443)||("ws"==schema&&this.port!=80))){port=":"+this.port}if(this.timestampRequests){query[this.timestampParam]=+new Date}query=util.qs(query);if(query.length){query="?"+query}return schema+"://"+this.host+port+this.path+query};WS.prototype.check=function(){var websocket=ws();return !!websocket&&!("__initialize" in websocket&&this.name===WS.prototype.name)};function ws(){return global.WebSocket||global.MozWebSocket}});require.register("util.js",function(module,exports,require,global){var pageLoaded=false;exports.inherits=function inherits(a,b){function c(){}c.prototype=b.prototype;a.prototype=new c};exports.keys=Object.keys||function(obj){var ret=[],has=Object.prototype.hasOwnProperty;for(var i in obj){if(has.call(obj,i)){ret.push(i)}}return ret};exports.on=function(element,event,fn,capture){if(element.attachEvent){element.attachEvent("on"+event,fn)}else{if(element.addEventListener){element.addEventListener(event,fn,capture)}}};exports.load=function(fn){if(global.document&&document.readyState==="complete"||pageLoaded){return fn()}exports.on(global,"load",fn,false)};if("undefined"!=typeof window){exports.load(function(){pageLoaded=true})}exports.defer=function(fn){if(!exports.ua.webkit||"undefined"!=typeof importScripts){return fn()}exports.load(function(){setTimeout(fn,100)})};var rvalidchars=/^[\],:{}\s]*$/,rvalidescape=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,rvalidtokens=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g,rtrimLeft=/^\s+/,rtrimRight=/\s+$/;exports.parseJSON=function(data){if("string"!=typeof data||!data){return null}data=data.replace(rtrimLeft,"").replace(rtrimRight,"");if(global.JSON&&JSON.parse){return JSON.parse(data)}if(rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,""))){return(new Function("return "+data))()}};exports.ua={};exports.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&(function(){try{var a=new XMLHttpRequest()}catch(e){return false}return a.withCredentials!=undefined})();exports.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent);exports.ua.gecko="undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent);exports.ua.android="undefined"!=typeof navigator&&/android/i.test(navigator.userAgent);exports.request=function request(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest&&!exports.ua.hasCORS){return new XDomainRequest()}try{if("undefined"!=typeof XMLHttpRequest&&(!xdomain||exports.ua.hasCORS)){return new XMLHttpRequest()}}catch(e){}if(!xdomain){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}};var re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];exports.parseUri=function(str){var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}return uri};exports.qs=function(obj){var str="";for(var i in obj){if(obj.hasOwnProperty(i)){if(str.length){str+="&"}str+=i+"="+encodeURIComponent(obj[i])}}return str}});eio=require("engine.io-client")})();var MiniEventEmitter=function(){};MiniEventEmitter.prototype.each=function(obj,iterator,context){var breaker={};if(obj==null){return}if(Array.prototype.forEach&&obj.forEach===Array.prototype.forEach){obj.forEach(iterator,context)}else{if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(i in obj&&iterator.call(context,obj[i],i,obj)===breaker){return}}}else{for(var key in obj){if(obj.hasOwnProperty(key)){if(iterator.call(context,obj[key],key,obj)===breaker){return}}}}}};MiniEventEmitter.prototype.filter=function(obj,iterator,context){var results=[];if(obj==null){return results}if(Array.prototype.filter&&obj.filter===Array.prototype.filter){return obj.filter(iterator,context)}MiniEventEmitter.prototype.each(obj,function(value,index,list){if(iterator.call(context,value,index,list)){results[results.length]=value}});return results};MiniEventEmitter.prototype.on=function(expr,callback){if(expr instanceof RegExp){this._routes||(this._routes=[]);this._routes.unshift([expr,callback])}else{this._events||(this._events={});this._events[expr]||(this._events[expr]=[]);this._events[expr].unshift(callback)}return this};MiniEventEmitter.prototype.addListener=MiniEventEmitter.prototype.on;MiniEventEmitter.prototype.once=function(event,callback){var self=this;function removeAfter(){self.removeListener(event,removeAfter);callback.apply(this,arguments)}removeAfter.listener=callback;self.on(event,removeAfter);return this};MiniEventEmitter.prototype.when=function(event,callback){var self=this;function check(){if(callback.apply(this,arguments)){self.removeListener(event,check)}}check.listener=callback;self.on(event,check);return this};MiniEventEmitter.prototype.removeListener=function(expr,callback){if(expr instanceof RegExp&&this._routes){this._routes=MiniEventEmitter.prototype.filter(this._routes,function(value){return !(value[0].toString()==expr.toString()&&(value[1]===callback||(value[1].listener&&value[1].listener===callback)))})}else{if(this._events&&this._events[expr]){this._events[expr]=MiniEventEmitter.prototype.filter(this._events[expr],function(value){return !(value===callback||(value.listener&&value.listener===callback))})}}return this};MiniEventEmitter.prototype.removeAllListeners=function(expr){if(arguments.length===0){this._events={};this._routes=[];return}if(expr instanceof RegExp&&this._routes){this._routes=MiniEventEmitter.prototype.filter(this._routes,function(value){return !(value[0].toString()==expr.toString())})}else{if(this._events&&this._events[expr]){this._events[expr]=[]}}return this};MiniEventEmitter.prototype.emit=function(event){var args=Array.prototype.slice.call(arguments,1);if(this._events&&this._events[event]){for(var i=this._events[event].length-1;i>-1&&this._events[event]&&this._events[event][i];i--){this._events[event][i].apply(this,args)}}if(this._routes){for(var i=this._routes.length-1;i>-1;i--){if(this._routes[i][0].test(event)){this._routes[i][1].apply(this,args)}}}return this};MiniEventEmitter.mixin=function(destObject){var props=["on","removeListener","removeAllListeners","emit","next","once","when"];for(var i=0;i<props.length;i++){destObject.prototype[props[i]]=MiniEventEmitter.prototype[props[i]]}};(function(){(function(){function require(e,t){for(var n=[],r=e.split("/"),i,s,o=0;s=r[o++];){".."==s?n.pop():"."!=s&&n.push(s)}n=n.join("/"),o=require,s=o.m[t||0],i=s[n+".js"]||s[n+"/index.js"]||s[n];if(s=i.c){i=o.m[t=s][e=i.m]}return i.exports||i(i,i.exports={},function(n){return o("."!=n.charAt(0)?n:e+"/../"+n,t)}),i.exports}require.m=[];require.m[0]={"engine.io-client":{exports:window.eio},"lib/backoff.js":function(module,exports,require){function Backoff(){this.failures=0}Backoff.durations=[1000,2000,4000,8000,16000,32000];Backoff.prototype.get=function(){return Backoff.durations[this.failures]||99999000};Backoff.prototype.increment=function(){this.failures++};Backoff.prototype.success=function(){this.failures=0};module.exports=Backoff},"lib/index.js":function(module,exports,require){var Client=require("./radar_client"),instance=new Client();instance._log=require("minilog");module.exports=instance},"lib/radar_client.js":function(module,exports,require){var log=require("minilog")("radar_client"),MicroEE=require("microee"),eio=require("engine.io-client"),Scope=require("./scope.js"),StateMachine=require("./state.js");function Client(backend){var self=this;this._me={accountName:"",userId:0,userType:0};this._ackCounter=1;this._channelSyncTimes={};this._users={};this.manager=new StateMachine();if(!backend){backend=eio}this.manager.createSocket=function(config){return new backend.Socket(config)};this.manager.handleMessage=function(msg){try{msg=JSON.parse(msg)}catch(e){throw e}switch(msg.op){case"err":case"ack":case"get":self.emit(msg.op,msg);break;case"sync":self._batch(msg);break;default:self.emit(msg.to,msg)}msg.direction="in";log.info(msg)}}MicroEE.mixin(Client);Client.prototype.alloc=function(name,callback){var self=this;log.info({op:"alloc",name:name});this._users[name]=true;callback&&this.once("ready",function(){self._users.hasOwnProperty(name)&&callback()});this.manager.connect();return this};Client.prototype.dealloc=function(name){log.info({op:"dealloc",name:name});delete this._users[name];var count=0,key;for(key in this._users){if(this._users.hasOwnProperty(key)){count++}}if(count===0){this.manager.disconnect()}};Client.prototype.configure=function(config){config||(config={});config.userType||(config.userType=0);this._me=config;this.manager.configure(this,config);return this};Client.prototype.message=function(scope){return new Scope("message:/"+this._me.accountName+"/"+scope,this)};Client.prototype.presence=function(scope){return new Scope("presence:/"+this._me.accountName+"/"+scope,this)};Client.prototype.status=function(scope){return new Scope("status:/"+this._me.accountName+"/"+scope,this)};Client.prototype.set=function(scope,value,callback){return this._write({op:"set",to:scope,value:value,key:this._me.userId,type:this._me.userType},callback)};Client.prototype.publish=function(scope,value,callback){return this._write({op:"publish",to:scope,value:value},callback)};Client.prototype.subscribe=function(scope,callback){return this._write({op:"subscribe",to:scope},callback)};Client.prototype.unsubscribe=function(scope,callback){return this._write({op:"unsubscribe",to:scope},callback)};var init=function(name){Client.prototype[name]=function(scope,options,callback){var message={op:name,to:scope};if(typeof options=="function"){callback=options}else{message.options=options}if(name=="sync"&&!message.options&&scope.match(/^presence.+/)){this.once(scope,callback)}else{this.when("get",function(message){if(!message||!message.to||message.to!=scope){return false}callback&&callback(message);return true})}return this._write(message)}};var props=["get","sync"];for(var i=0;i<props.length;i++){init(props[i])}Client.prototype._write=function(message,callback){if(this._me&&this._me.auth){message.auth=this._me.auth;message.userId=this._me.userId;message.userType=this._me.userType;message.accountName=this._me.accountName}if(callback){message.ack=this._ackCounter++;this.when("ack",function(m){if(!m||!m.value||m.value!=message.ack){return false}callback(message);return true})}this.manager.send(message);return this};Client.prototype._batch=function(msg){if(!(msg.to&&msg.value&&msg.time)){return}var index=0,length=msg.value.length,newest=msg.time,current=this._channelSyncTimes[msg.to]||0;for(;index<length;index=index+2){var message=msg.value[index],time=msg.value[index+1];try{message=JSON.parse(message)}catch(e){throw e}if(time>current){this.emit(msg.to,message)}if(time>newest){newest=time}}this._channelSyncTimes[msg.to]=newest};Client.setBackend=function(lib){eio=lib};module.exports=Client},"lib/reconnector.js":function(module,exports,require){var log=require("minilog")("radar_reconnect");function Reconnector(client){this.subscriptions={};this.presences={};this.mqueue=[];this.client=client;this.waitCounter=0}Reconnector.prototype.memorize=function(message){switch(message.op){case"unsubscribe":if(this.subscriptions[message.to]){delete this.subscriptions[message.to]}break;case"sync":case"subscribe":if(this.subscriptions[message.to]!="sync"){this.subscriptions[message.to]=message.op}break;case"set":if(message.to.substr(0,"presence:/".length)=="presence:/"){this.presences[message.to]=message.value}break}};Reconnector.prototype.queue=function(message){log.info("Queue message",message);this.mqueue.push(message)};Reconnector.prototype.restore=function(done){var self=this,total=0,to,message;function ack(){self.waitCounter--;if(self.waitCounter===0){done()}}log.info({event:"restore-subscriptions"});for(to in this.subscriptions){if(!this.subscriptions.hasOwnProperty(to)){continue}var item=this.subscriptions[to];this.waitCounter++;total++;this.client[item](to,ack)}for(to in this.presences){if(!this.presences.hasOwnProperty(to)){continue}this.waitCounter++;total++;this.client.set(to,this.presences[to],ack)}message=this.mqueue.shift();while(message){this.client.manager._sendPacket(JSON.stringify(message));message=this.mqueue.shift()}if(total===0){done()}};module.exports=Reconnector},"lib/scope.js":function(module,exports,require){function Scope(prefix,client){this.prefix=prefix;this.client=client}var props=["set","get","subscribe","unsubscribe","publish","sync","on","once","when","removeListener","removeAllListeners"];var init=function(name){Scope.prototype[name]=function(){var args=Array.prototype.slice.apply(arguments);args.unshift(this.prefix);this.client[name].apply(this.client,args);return this}};for(var i=0;i<props.length;i++){init(props[i])}module.exports=Scope},"lib/state.js":function(module,exports,require){var log=require("minilog")("radar_state"),Reconnector=require("./reconnector"),MicroEE=require("microee"),Backoff=require("./backoff");function StateMachine(){var self=this;this.connections=0;this._state=StateMachine.states.stopped;this.socket=null;this.queue=[];this.transitionTimer=null;this.socketConfig=null;this.guard=null;this.backoff=new Backoff();this._timeout=null;this.sink=new MicroEE();this.createSocket=null;this.handleMessage=null;this.reconnector=null;this.waitingForConfig=false;this.auditSent=0;this.auditReceived=0}var states=StateMachine.states={permanently_disconnected:-2,stopped:-1,waiting:1,reconnect:2,disconnecting:3,connecting:4,connected:5,ready:6};StateMachine.prototype.set=function(to){if(typeof to!=="undefined"){log.debug({op:"change-state",from:this._state,to:to});this._state=to}};StateMachine.prototype.configure=function(sink,config){config||(config={});config.upgrade=false;this.socketConfig=config;sink&&(this.sink=sink);if(this.waitingForConfig&&this._state==states.stopped){this.waitingForConfig=false;this.connect()}};StateMachine.prototype.connect=function(){if(this._state==states.stopped&&this.socketConfig){this.reconnector=new Reconnector(this.sink);this.set(states.reconnect)}else{this.waitingForConfig=true}this.run()};StateMachine.prototype.send=function(message){if(this._state<0){if(!this.socketConfig||!this.sink){return}this.connect()}this.reconnector.memorize(message);if(this._state<5){this.reconnector.queue(message)}else{this._sendPacket(JSON.stringify(message));message.direction="out";log.info(message)}};StateMachine.prototype._sendPacket=function(data){this.auditSent++;this.socket.sendPacket("message",data)};StateMachine.prototype.disconnect=function(){var self=this;log.info({op:"explicit-disconnect"});if(!this.socketConfig){this.waitingForConfig=false;return}this.set(states.disconnecting);if(this.socket){this.socket.removeAllListeners("close");this.socket.on("close",function(){self.set(states.stopped)});this.socket.close()}this.run()};StateMachine.prototype._connect=function(){if(this._state!=states.reconnect){log.error("Connect is only allowed from reconnecting state!");return}var self=this;var socket=this.socket=this.createSocket(this.socketConfig);this.auditSent=0;this.auditReceived=0;socket.once("open",function(){self.set(states.connected);self.run()});socket.on("message",this.handleMessage);socket.on("message",function(){self.auditReceived++});socket.once("close",function(){self.handleDisconnect()});this._startGuard(function(){log.warn({event:"connection-guard-timeout"});self.handleDisconnect()},this.backoff.get()+6000);this.set(states.connecting)};StateMachine.prototype.handleDisconnect=function(){this._cancelGuard();this.backoff.increment();this.set(states.reconnect);if(this.backoff.get()>9000000){this.set(states.permanently_disconnected);this.retransition(1000)}else{this.retransition(this.backoff.get())}this.sink.emit("disconnected");log.info({event:"disconnected",wait:this.backoff.get()})};StateMachine.prototype.run=function(){var self=this,s=StateMachine.states;if(this.socketConfig){log.debug({op:"run-state",state:this._state})}switch(this._state){case s.permanently_disconnected:this.sink.emit("unavailable");break;case s.stopped:this.sink.emit("disconnected");break;case s.waiting:break;case s.reconnect:this._connect(this.socketConfig);break;case s.disconnecting:case s.connecting:this.retransition(1000);break;case s.connected:this._cancelGuard();this.reconnector.restore(function(){self.set(s.ready);self.run()});break;case s.ready:this.connections++;this.backoff.success();if(this.connections==1){this.sink.emit("connected")}else{this.sink.emit("reconnected")}this.sink.emit("ready");break}};StateMachine.prototype.retransition=function(timeout){var self=this;this._timeout=timeout;if(!this.transitionTimer){this.transitionTimer=setTimeout(function(){self.transitionTimer=null;log.info("Ran transition after",timeout);self.run()},timeout)}};StateMachine.prototype._startGuard=function(callback,timeout){log.debug({event:"start guard",timeout:timeout});this.guard&&clearTimeout(this.guard);this.guard=setTimeout(callback,timeout)};StateMachine.prototype._cancelGuard=function(){log.debug({event:"cancel-guard"});this.guard&&clearTimeout(this.guard)};StateMachine._setTimeout=function(fn){setTimeout=fn};module.exports=StateMachine},microee:{c:1,m:"/index.js"},minilog:{exports:window.Minilog}};require.m[1]={"/index.js":function(module,exports,require){function M(){this._events={}}M.prototype={on:function(ev,cb){this._events||(this._events={});var e=this._events;(e[ev]||(e[ev]=[])).push(cb);return this},removeListener:function(ev,cb){var e=this._events[ev]||[],i;for(i=e.length-1;i>=0&&e[i];i--){if(e[i]===cb||e[i].cb===cb){e.splice(i,1)}}},removeAllListeners:function(ev){if(!ev){this._events={}}else{this._events[ev]&&(this._events[ev]=[])}},emit:function(ev){this._events||(this._events={});var args=Array.prototype.slice.call(arguments,1),i,e=this._events[ev]||[];for(i=e.length-1;i>=0&&e[i];i--){e[i].apply(this,args)}return this},when:function(ev,cb){return this.once(ev,cb,true)},once:function(ev,cb,when){if(!cb){return this}function c(){if(!when){this.removeListener(ev,c)}if(cb.apply(this,arguments)&&when){this.removeListener(ev,c)}}c.cb=cb;this.on(ev,c);return this}};M.mixin=function(dest){var o=M.prototype,k;for(k in o){o.hasOwnProperty(k)&&(dest.prototype[k]=o[k])}};module.exports=M}};RadarClient=require("lib/index.js")}());var lastTry=0,limit=10*60*1000;RadarClient.on("err",function(m){if(m.value=="auth_expiring"&&lastTry<new Date().getTime()-limit){lastTry=new Date().getTime();jQuery.ajax("/api/v2/users/radar_token.json",{dataType:"json",cache:false,success:function(token){if(token.auth){RadarClient._me.auth=token.auth}}})}});window.radarClient={main:function(){return RadarClient}}}());