window.Zendesk.NS("Ticket.ViewingStatus",window.jQuery,window.Zendesk,window.currentUser,function($,Zendesk,currentUser){var pollPeriods=[15*1000,30*1000,45*1000,60*1000],pollPeriodIndex=0,initialized=false,tickedId=0,userCache={},lastUpdated=false,log=(window.Minilog?window.Minilog("collision"):function(){});function loadUser(id,done){(function(){var attempts=0;function get(){if(++attempts>3){return}log("GET /api/v1/users/"+id+".json, attempt "+attempts);$.ajax("/api/v1/users/"+id+".json",{type:"GET",dataType:"json",cache:false,success:function(data,textStatus,XMLHttpRequest){log("GET /api/v1/users/"+id+".json success",data,textStatus);done(data)},error:function(jq,textStatus,errorThrown){if(attempts<3){log("Retrying GET /api/v1/users/"+id+".json due to #api_error",jq.status,jq.statusText,jq.getAllResponseHeaders&&jq.getAllResponseHeaders(),jq.responseText)}get()}})}get()}())}function loadUsers(ids,done){var results=[],len=ids.length,count=0;for(var i=0;i<len;i++){(function(index,id){if(userCache[id]){results[index]=userCache[id];count++;if(count==len){done(results)}return}loadUser(id,function(data){results[index]=userCache[id]=data;count++;if(count==len){done(results)}})})(i,ids[i])}}function Banner(){}Banner.message="";Banner.type="";Banner.banner=false;Banner.updateViewers=function(viewerObj){var viewers=[];var currentUserId=parseInt(Zendesk.currentUser.id,10);for(var userId in viewerObj){if(userId==currentUserId){continue}if(!viewerObj.hasOwnProperty(userId)){continue}viewers.push(userId)}if(viewers.length===0){if(Banner.type!=="urgent"){Banner._hide()}return}Banner.type="normal";loadUsers(viewers.slice(0,3),function(userData){var users=[],len=userData.length;for(var i=0;i<len;i++){userData[i]&&userData[i].name&&users.push(userData[i].name)}if(users.length===0){log("#api_error no responses contained names",users);return}switch(users.length){case 1:Banner.message=I18n.t("txt.ticket.collision.other_viewers.one",{person:users[0]});break;case 2:Banner.message=users.join(" and ")+" are also viewing this ticket.";break;default:Banner.message=users.slice(0,2).join(", ")+", and "+(users.length-2)+(viewers.length>3?" others":" other")+" are also viewing this ticket."}Banner._render()})};Banner.updateTicket=function(){Banner.type="urgent";Banner.message=I18n.t("txt.ticket.collision.updated");Banner._render();Banner.banner.reload().show()};Banner._hide=function(){if(!Banner.banner){Banner.banner=Zendesk.Banner.create()}if(Banner.banner.visible()){Banner.type="";Banner.banner.disappear()}};Banner._render=function(){if(!Banner.banner){Banner.banner=Zendesk.Banner.create()}Banner.banner.setContent(Banner.message).removeClass("normal urgent").addClass(Banner.type).reload().hide();if(Banner.banner.hidden()){Banner.banner.appear()}};function ViewingStatus(ticketId){var self=this,isQuiet=false;this.viewers={};if(!initialized){initialized=true;RadarClient.alloc("collision").once("ready",function(){if(!isQuiet){RadarClient.presence("ticket/"+ticketId).set("online")}RadarClient.presence("ticket/"+ticketId).on(function(message){self.updatePresence(message)}).sync();RadarClient.status("ticket/"+ticketId).on(function(message){self.updateTime(message)}).subscribe()})}}ViewingStatus.prototype.updatePresence=function(message){var nowOnline=!!(message.op==="online"),isChanged=false;for(var userId in message.value){if(!message.value.hasOwnProperty(userId)){continue}userId=parseInt(userId,10);var wasOnline=!!(this.viewers[userId]);if(nowOnline&&!wasOnline){this.viewers[userId]=true;isChanged=true}else{if(!nowOnline&&wasOnline){delete this.viewers[userId];isChanged=true}}}if(isChanged){Banner.updateViewers(this.viewers)}};ViewingStatus.prototype.updateTime=function(message){var data={};if(/updated_at/.test(message.value)){data=JSON.parse(message.value)}else{data.updated_at=message.value;data.updated_by=null}if(message.key=="updated"&&data.updated_at!=lastUpdated&&data.updated_by!=Zendesk.currentUser.id){lastUpdated=data.updated_at;Banner.updateTicket()}};$(function(){if($("#show_agent_collision_for_ticket").length==1){window.viewStatus=new ViewingStatus(window.ticket_id)}})});