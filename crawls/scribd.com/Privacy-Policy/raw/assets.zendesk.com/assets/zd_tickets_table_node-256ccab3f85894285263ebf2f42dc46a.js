Zendesk.NS("Tickets.Table",this.jQuery,function($){var self=this,userCache={},log=(window.Minilog?window.Minilog("collision"):function(){});var viewingStatuses={};function keyFor($tr){return $tr.attr("data-zd-account-id")+","+$tr.attr("data-zd-ticket-nice-id")}function hideTRTooltipOnShowMainTooltip(table){table.find("td.description").hover(function(){$(this).closest("tr[title]").each(function(i,tr){$(tr).attr("data-title",$(tr).attr("title")).removeAttr("title")})},function(){$(this).closest("tr[data-title]").each(function(i,tr){$(tr).attr("title",$(tr).attr("data-title")).removeAttr("data-title")})})}function applyViewStatusToTRs(table){table.find("tbody tr[data-zd-ticket-nice-id][data-zd-account-id]").each(function(){var $tr=$(this);var key=keyFor($tr);var message=viewingStatuses[key];if(message){$tr.find("td:first-child").addClass("beingViewed");$tr.attr("title",message)}})}function loadUser(id,done){(function(){var attempts=0;function get(){if(++attempts>3){return}log("GET /api/v1/users/"+id+".json, attempt "+attempts);$.ajax("/api/v1/users/"+id+".json",{type:"GET",dataType:"json",cache:false,success:function(data,textStatus,XMLHttpRequest){log("GET /api/v1/users/"+id+".json success",data,textStatus);done(data)},error:function(jq,textStatus,errorThrown){if(attempts<3){log("Retrying GET /api/v1/users/"+id+".json due to #api_error",jq.status,jq.statusText,jq.getAllResponseHeaders&&jq.getAllResponseHeaders(),jq.responseText)}get()}})}get()}())}function loadUsers(ids,done){var results=[],len=ids.length,count=0;for(var i=0;i<len;i++){(function(index,id){if(userCache[id]){results[index]=userCache[id];count++;if(count==len){done(results)}return}loadUser(id,function(data){results[index]=userCache[id]=data;count++;if(count==len){done(results)}})})(i,ids[i])}}this.getAndApplyViewingStatuses=function(ticket_ids){$.getJSON("/node/radar/presence",{accountName:currentAccount.subdomain,scopes:ticket_ids.map(function(id){return"ticket/"+id}).join(",")},function(scopes){var scope,total=0,viewers=[],dedup={};viewingStatuses={};for(scope in scopes){if(!scopes.hasOwnProperty(scope)){continue}for(var userId in scopes[scope]){if(!scopes[scope].hasOwnProperty(userId)||dedup[userId]){continue}dedup[userId]=true;viewers.push(userId)}}loadUsers(viewers,function(){for(scope in scopes){if(!scopes.hasOwnProperty(scope)){continue}var key=""+currentAccount.id+","+scope.replace("ticket/",""),names=[];for(var userId in scopes[scope]){if(!scopes[scope].hasOwnProperty(userId)){continue}if(userId==Zendesk.currentUser.id){continue}userCache[userId]&&userCache[userId].name&&names.push(userCache[userId].name)}if(!names.length){continue}if(names.length==1){viewingStatuses[key]=names[0]+" is viewing this ticket."}else{if(names.length>1){viewingStatuses[key]=""+names.length+" agents are viewing this ticket."}}}var table=$("table.tickets");applyViewStatusToTRs(table);hideTRTooltipOnShowMainTooltip(table)})})};this.linkifyRows=function(table){table.find("tbody tr").each(function(){var ticketHref=$(this).attr("data-href");if(!ticketHref||!ticketHref.length){return}$(this).click(function(event){if(!event){return}if($(event.target).attr("href")===ticketHref){return}if(event.ctrlKey||event.metaKey){window.open(ticketHref,"_blank").blur();window.focus()}else{window.location.href=ticketHref}})})};this.applyViewStatusToTooltip=function($trOrChild){$trOrChild=$($trOrChild);var tooltipID=$trOrChild.attr("aria-describedby");if(!tooltipID){return}var $tooltip=$("#"+tooltipID);if($tooltip.length===0){return}if($tooltip.find(".otherViewers").length>0){return}var $tr=$trOrChild.closest("tr[data-zd-account-id][data-zd-ticket-nice-id]");if($tr.length===0){return}var key=keyFor($tr);var message=viewingStatuses[key];if(!message){return}$tooltip.find(".title").prepend('<span class="otherViewers">'+message+"</span>")}});