window.Zendesk.NS("Ticket.ViewingStatus",window.jQuery,window.Zendesk,window.currentUser,function($,Zendesk,currentUser){var pollPeriods=[15*1000,30*1000,45*1000,60*1000],pollPeriodIndex=0,initialized=false,tickedId=0,userCache={},lastUpdated=false;function loadUser(id,done){$.ajax({url:"/api/v2/users/"+id+".json",dataType:"json",type:"GET",success:function(data,textStatus,XMLHttpRequest){done(data.user)},error:function(XMLHttpRequest,textStatus,errorThrown){done({})}})}function loadUsers(ids,done){var results=[],len=ids.length,count=0;for(var i=0;i<len;i++){(function(index,id){if(userCache[id]){results[index]=userCache[id];count++;if(count==len){done(results)}return}loadUser(id,function(data){results[index]=userCache[id]=data;count++;if(count==len){done(results)}})})(i,ids[i])}}function Banner(){}Banner.message="";Banner.type="";Banner.banner=false;Banner.updateViewers=function(viewerObj){var viewers=[];for(var userId in viewerObj){if(userId==Zendesk.currentUser.id){continue}if(!viewerObj.hasOwnProperty(userId)){continue}viewers.push(userId)}if(viewers.length==0){return}Banner.type="normal";loadUsers(viewers.slice(0,3),function(userData){var users=[],len=userData.length;for(var i=0;i<len;i++){userData[i].name&&users.push(userData[i].name)}switch(users.length){case 1:Banner.message=I18n.t("txt.ticket.collision.other_viewers.one",{person:users[0]});break;case 2:Banner.message=users.join(" and ")+" are also viewing this ticket.";break;default:Banner.message=users.slice(0,2).join(", ")+", and "+(users.length-2)+(viewers.length>3?" others":" other")+" are also viewing this ticket."}Banner._render()})};Banner.updateTicket=function(){Banner.type="urgent";this.message=I18n.t("txt.ticket.collision.updated");Banner._render();Banner.banner.reload().show()};Banner._hide=function(){if(!Banner.banner){Banner.banner=Zendesk.Banner.create()}if(Banner.banner.visible()){Banner.banner.disappear()}};Banner._render=function(){if(!Banner.banner){Banner.banner=Zendesk.Banner.create()}Banner.banner.setContent(this.message).removeClass("normal urgent").addClass(this.type).reload().hide();if(Banner.banner.hidden()){Banner.banner.appear()}};function ViewingStatus(){var self=this,isQuiet=false,server=Zendesk.currentAccount.pubsubServers[Math.floor(Math.random()*Zendesk.currentAccount.pubsubServers.length)],hostport=server.split(":"),configuration={host:hostport[0],port:hostport[1],secure:true,upgrade:false,userId:Zendesk.currentUser.id||0,userType:Zendesk.currentUser.role||0,accountName:Zendesk.currentAccount.subdomain};this.viewers={};if(!initialized){initialized=true;RadarClient.configure(configuration).alloc("ticket_collision").once("ready",function(){if(!isQuiet){RadarClient.presence("ticket/"+ticketId).set("online")}RadarClient.presence("ticket/"+ticketId).on(function(message){self.updatePresence(message)}).sync();RadarClient.status("ticket/"+ticketId).on(function(message){self.updateTime(message)}).subscribe()})}}ViewingStatus.prototype.updatePresence=function(message){var nowOnline=!!(message.op=="online"),isChanged=false;for(var userId in message.value){if(!message.value.hasOwnProperty(userId)){continue}var wasOnline=!!(this.viewers[userId]);if(nowOnline&&!wasOnline){this.viewers[userId]=true;isChanged=true}else{if(!nowOnline&&wasOnline){delete this.viewers[userId];isChanged=true}}}if(isChanged){Banner.updateViewers(this.viewers)}};ViewingStatus.prototype.updateTime=function(message){if(message.key=="updated"&&message.value!=lastUpdated){lastUpdated=message.value;Banner.updateTicket()}};$(function(){var data=$("#ticket_viewing_status_data").html();if(data&&data.length>0){ticketId=JSON.parse(data).ticketID;window.viewStatus=new ViewingStatus()}})});