// Copyright (c)2012 and onwards Instart Inc. All rights reserved.
// 3776-3365fdb

if(typeof INSTART==='undefined'){INSTART={};}
if(typeof INSTART.features==='undefined'){INSTART.features={};}
INSTART.features.notouching={};INSTART.features.onlytouching={};(function(){INSTART.features.approvedBrowsers={'msie':{'min':[-1,-1,-1],'max':[-1,-1,-1]},'chrome':{'min':[7,0,0],'max':[25,0,0]},'firefox':{'min':[4,0,0],'max':[19,0,0]},'safari':{'min':[-1,-1,-1],'max':[-1,-1,-1]},'other_browser':{'min':[-1,-1,-1],'max':[-1,-1,-1]},'android':{'min':[-1,-1,-1],'max':[-1,-1,-1]},'ios':{'min':[6,0,0],'max':[6,1,0]},'other_platform':{'min':[-1,-1,-1],'max':[-1,-1,-1]}};INSTART.features.browser=function(userAgent){var stdproc=function(match){return{'major':(match[1]||0),'minor':(match[3]||0),'micro':(match[5]||0)};};var scans={'browser':[{sub:/Chrome\/([\d]+)(\.([\d]+))?(\.([\d]+))?/,name:'chrome',process:stdproc},{sub:/Firefox\/([\d]+)(\.([\d]+))?(\.([\d]+))?/,name:'firefox',process:stdproc},{sub:/MSIE\s([\d]+)(\.([\d]+))?(\.([\d]+))?/,name:'msie',process:stdproc},{sub:/Version\/([\d]+)(\.([\d]+))?(\.([\d]+))?.*Safari/,name:'safari',process:stdproc}],'os':[{sub:/Android\s([\d]+)(\.([\d]+))?(\.([\d]+))?/,name:'android',process:stdproc},{sub:/CPU OS ([\d]+)(_([\d]+))?(_([\d]+))?/,name:'ios',process:stdproc},{sub:/CPU iPhone OS ([\d]+)(_([\d]+))?(_([\d]+))?/,name:'ios',process:stdproc}]};var dev={'browser':{'name':'','ver':[0,0,0]},'os':{'name':'','ver':[0,0,0]}};for(var name in scans){var items=scans[name];for(var i=0;i<items.length;i++){var item=items[i];var match=item.sub.exec(userAgent);if(match!=null){var version=item.process(match);dev[name]={'name':item.name,'ver':[parseInt(version['major'],10),parseInt(version['minor'],10),parseInt(version['micro'],10)]};break;}}}
return dev;};INSTART.features.testbrowser=function(userAgent){var cmp_gte=function(lhs,rhs){if(lhs[0]<rhs[0])
return true;if(lhs[0]==rhs[0]&&lhs[1]<rhs[1])
return true;if(lhs[0]==rhs[0]&&lhs[1]==rhs[1]&&lhs[2]<=rhs[2])
return true;return false;};if(userAgent==null){userAgent=navigator.userAgent;}
var dev=INSTART.features.browser(userAgent);var enable=false;if(dev.os.name=='ios'||dev.os.name=='android'){var bounds=INSTART.features.approvedBrowsers[dev.os.name];if(!cmp_gte(bounds.min,dev.os.ver)){return false;}
if(bounds.max!=-1&&cmp_gte(bounds.max,dev.os.ver)){return false;}
return true;}else if(dev.browser.name=='chrome'||dev.browser.name=='firefox'||dev.browser.name=='msie'||dev.browser.name=='safari'){var bounds=INSTART.features.approvedBrowsers[dev.browser.name];if(!cmp_gte(bounds.min,dev.browser.ver)){return false;}
if(bounds.max!=-1&&cmp_gte(bounds.max,dev.browser.ver)){return false;}
return true;}
return false;};INSTART.features.use_whitelist=false;INSTART.features.okpath=function(){if(INSTART.features.use_whitelist){if(window.location.pathname in INSTART.features.onlytouching){return true;}
return false;}else{if(window.location.pathname in INSTART.features.notouching){return false;}
return true;}};INSTART.features.enabled=function(){if(INSTART.features.testbrowser()&&INSTART.features.okpath()){return true;}else{return false;}};})();INSTART.features.site_config={"apiDomain":"assets.insnw.net","enableImageVirtualization":true,"partialImage":true,"useImageApi":false,"virtualizeDomains":["qph\\.is\\.quoracdn\\.net","qim\\.is\\.quoracdn\\.net"]};if(INSTART.features.enabled()){if(typeof INSTART=='undefined'){INSTART={};}
INSTART.nologging=true;if(typeof INSTART==='undefined'){INSTART={};}
(function(w,d){INSTART.err={};var profile_path='/instart/profile/0/';INSTART.err.url='//assets0.insnw.net'+profile_path;INSTART.err.conf=null;var installErrorHandler=function(){var errorHandler=function(e){INSTART.log('encountered error '+e);var body={"id":"jsdump","data":{"filename":e.filename,"lineno":e.lineno,"message":e.message,"timestamp":e.timeStamp,"useragent":navigator.userAgent,"href":window.location.href,"conf":INSTART.err.conf}};var xhr=new XMLHttpRequest();xhr.open('POST',INSTART.err.url);xhr.withCredentials=false;xhr.onload=function(){INSTART.log('dump sent');};xhr.onerror=function(){INSTART.log('dump failed');};xhr.send(INSTART.common.json.stringify(body));};if(typeof w.addEventListener!=='undefined'&&typeof ErrorEvent!=='undefined'){w.addEventListener('error',errorHandler);}else{var prev_onerror=w.onerror;w.onerror=function(msg,url,line){errorHandler({'message':msg,'filename':url,'lineno':line});if(typeof prev_onerror!=='undefined'){if(typeof prev_onerror==='function'){prev_onerror(msg,url,line);}else if(typeof prev_onerror==='string'){exec(prev_onerror);}}};}};INSTART.err.init=function(config){if('apiDomain'in config){INSTART.err.url='//'+config['apiDomain']+profile_path;}
INSTART.err.conf=config;installErrorHandler();};})(window,document);(function(){var msgWrapper=function(msgType,var_args){if(typeof INSTART.nologging!=='undefined'&&INSTART.nologging==true){return function(msg){}}
try{var a=console[msgType];a('');return console[msgType];}catch(e){return function(msg){console[msgType](msg);}}};var msgTypes=['log','error'];for(var i=0;i<msgTypes.length;i++){if(typeof INSTART[msgTypes[i]]==='undefined'){INSTART[msgTypes[i]]=msgWrapper(msgTypes[i]);}}})();(function(){INSTART.init=function(config){if(typeof INSTART.features!='undefined'){if(!INSTART.features.enabled()){return;}}
for(var i in INSTART){if(typeof INSTART[i].init!='undefined'){INSTART[i].init(config);}}};})();(function(w,d){INSTART.common={};INSTART.common.json=JSON;var areInterceptableImagesPresent=function(){var images=d.getElementsByTagName('img');for(var i=0;i<images.length;i++){if(INSTART.staticImg.isDomainIntercepted(images[i].src)){return true;}}
return false;};INSTART.common.exec_time=new Date().valueOf();w.addEventListener('load',function(){setTimeout(function(){var beacon={};if(typeof w.performance!=='undefined'&&typeof w.performance.timing!=='undefined'&&typeof w.performance.navigation!=='undefined'){var timing=w.performance.timing;var navi=w.performance.navigation;beacon['timing']={};for(var i in w.performance.timing){if(typeof w.performance.timing[i]!='function'){beacon['timing'][i]=w.performance.timing[i];}}
beacon['nav']={'redirectCount':w.performance.navigation.redirectCount,'type':w.performance.navigation.type};}
beacon['interceptableImagesPresent']=areInterceptableImagesPresent();addBeaconInfo('beacon',beacon);},1);});var htmlElementsNames=['HTMLElement','HTMLHtmlElement','HTMLHeadElement','HTMLTitleElement','HTMLBaseElement','HTMLLinkElement','HTMLMetaElement','HTMLStyleElement','HTMLScriptElement','HTMLBodyElement','HTMLHeadingElement','HTMLParagraphElement','HTMLHRElement','HTMLPreElement','HTMLQuoteElement','HTMLOListElement','HTMLUListElement','HTMLLIElement','HTMLDListElement','HTMLDivElement','HTMLAnchorElement','HTMLDataElement','HTMLTimeElement','HTMLSpanElement','HTMLBRElement','HTMLModElement','HTMLImageElement','HTMLIFrameElement','HTMLEmbedElement','HTMLObjectElement','HTMLParamElement','HTMLVideoElement','HTMLAudioElement','HTMLSourceElement','HTMLTrackElement','HTMLMediaElement','HTMLCanvasElement','HTMLMapElement','HTMLAreaElement','HTMLTableElement','HTMLTableCaptionElement','HTMLTableColElement','HTMLTableSectionElement','HTMLTableRowElement','HTMLTableDataCellElement','HTMLTableHeaderCellElement','HTMLTableCellElement','HTMLFormElement','HTMLFieldSetElement','HTMLLegendElement','HTMLLabelElement','HTMLInputElement','HTMLButtonElement','HTMLSelectElement','HTMLDataListElement','HTMLOptGroupElement','HTMLOptionElement','HTMLTextAreaElement','HTMLKeygenElement','HTMLOutputElement','HTMLProgressElement','HTMLMeterElement','HTMLDetailsElement','HTMLCommandElement','HTMLMenuElement','DocumentFragment'];INSTART.common.htmlElements=(function(){var htmlElements=new Array();var htmlElementsNamesLength=htmlElementsNames.length;for(var i=0;i<htmlElementsNamesLength;i++){var elementClass=w[htmlElementsNames[i]];if(!!elementClass){htmlElements.push(elementClass);}}
return htmlElements;})();INSTART.common.onStarAttrs=['abort','afterprint','beforeprint','beforeunload','blur','cancel','canplay','canplaythrough','change','click','close','contextmenu','cuechange','dblclick','drag','dragend','dragenter','dragleave','dragover','dragstart','drop','durationchange','emptied','ended','error','focus','hashchange','input','invalid','keydown','keypress','keyup','load','loadeddata','loadedmetadata','loadstart','message','mousedown','mousemove','mouseout','mouseover','mouseup','mousewheel','offline','online','pause','play','playing','pagehide','pageshow','popstate','progress','ratechange','reset','resize','scroll','seeked','seeking','select','show','stalled','storage','submit','suspend','timeupdate','unload','volumechange','waiting'];INSTART.common.init=function(config){if('apiDomain'in config){INSTART.common.apiDomain=config['apiDomain'];}
if('virtualDomains'in config){INSTART.common.virtualDomains=config['virtualDomains'];}};INSTART.common.absPath=function(url){var tag=d.createElement('A');tag.href=url;return tag.href;};INSTART.common.getDomain=function(url){var tag=d.createElement('A');tag.href=url;return tag.hostname;};var __hashString=function(data){var hash=0;for(var i=0;i<data.length;i++){var c=data.charCodeAt(i);hash=((hash<<5)-hash)+c;hash=hash&hash;}
return hash&2147483647;};var __computeVirtualDomain=function(url){if(INSTART.common.virtualDomains<2){return'';}
return(__hashString(url)%INSTART.common.virtualDomains).toString();};var __currentHost=function(url){var loc=window.location.href;var domain_start=loc.indexOf('://',0)+3;var domain_end=loc.indexOf('/',domain_start);return loc.substring(domain_start,domain_end);};var __virtualHost=function(host,num){if(num==''){return['//',host].join('');}
var parts=host.split('.');if(parts.length>2){var pre=parts.shift();return['//',pre,num,'.',parts.join('.')].join('');}else{return['//',host].join('');}};INSTART.common.apiDomain='api.insnw.net';INSTART.common.virtualDomains=4;INSTART.common.serviceUrl=function(url){return INSTART.common.apiDomain+url;};INSTART.common.vHostServiceUrl=function(url){return __virtualHost(INSTART.common.apiDomain,__computeVirtualDomain(url));};INSTART.common.MutationObserver=(function(){var observerObject=null;if(typeof MutationObserver!=='undefined'){INSTART.log('using MutationObserver');observerObject=MutationObserver;}else if(typeof MozMutationObserver!=='undefined'){INSTART.log('using MozMutationObserver');observerObject=MozMutationObserver;}else if(typeof WebKitMutationObserver!=='undefined'){INSTART.log('using WebKitMutationObserver');observerObject=WebKitMutationObserver;}else{INSTART.log('using DOMAttrModified event');}
return observerObject;})();INSTART.common.getRealObject=function(obj){var retVal=obj;if(!!obj&&!!obj.instartWrapper){retVal=!!Object.getPrototypeOf?Object.getPrototypeOf(arguments[0]):arguments[0].__proto__;}
return retVal;};INSTART.common.loadJSDynamically=function(src,callb){var scriptNode=document.createElement('script');scriptNode.type='text/javascript';if(scriptNode.readyState){scriptNode.onreadystatechange=function(){if(scriptNode.readyState=='loaded'||scriptNode.readyState=='complete'){scriptNode.onreadystatechange=null;callb();}};}else{scriptNode.onload=function(){callb();};}
scriptNode.src=src;d.getElementsByTagName('head')[0].appendChild(scriptNode);};INSTART.common.getConfigRegexList=function(config,key,valueArray){if(key in config){valueArray.length=0;if(typeof config[key]==='object'){var ok=true;for(var i=0;i<config[key].length;i++){var val=config[key][i];if(typeof val==='string'){valueArray.push(new RegExp(val));}else{throw('Invalid virtualizeDomains value type: '+(typeof val));}}
if(!ok){throw'Invalid value in virtualizeDomains';}}else{throw'Invalid value for virtualizeDomains';}}};INSTART.common.beacon=function(info){var track=new INSTART.image2.RealImage();var params=[];for(var i in info){params.push(i+'='+encodeURIComponent(INSTART.common.json.stringify(info[i])));}
params.push('url='+encodeURIComponent(w.location.href));track.src='//'+INSTART.common.apiDomain+'/instart/blank.gif?'+
params.join('&');track.addEventListener('load',function(){track.removeEventListener('load',arguments.callee);});}
var beacons=2;var beaconCount=0;var beaconInfo={};var addBeaconInfo=function(queryArg,dataObject){beaconInfo[queryArg]=dataObject;beaconCount++;if(beaconCount==beacons){INSTART.common.beacon(beaconInfo);}};INSTART.common.getStyleAsString=function(node){var computedStyle=w.getComputedStyle(node);var style='';for(var i in node.style){var value=computedStyle[i];if(typeof value!='function'&&value!=null&&typeof value!='undefined')
{style+=i+':'+value+';'}}
return style;};INSTART.common.addItemMethod=function(arr){arr.item=function(idx){return this[idx];};return arr;};INSTART.common.isNativeMethod=function(method){if(method.toString().indexOf('[native code]')>-1){return true;}
return false;};var imageCount=0;var imageCompleted=0;var imageStats={};(function(){w.addEventListener('load',function(){setTimeout(function(){if(imageCount==0){addBeaconInfo('imgstats',INSTART.common.imageReport());}},5000);});})();INSTART.common.registerImgStatsUrl=function(url){if(typeof imageStats[url]==='undefined'){imageCount++;imageStats[url]={'static':0,'backfill':0,'done':false};}};INSTART.common.imgStats=function(url,staticSize,backfillSize){if(typeof imageStats[url]!=='undefined'){var urlStats=imageStats[url];if(!urlStats['done']){urlStats['static']=staticSize;urlStats['backfill']=backfillSize;urlStats['done']=true;imageCompleted++;if(imageCompleted>=imageCount){addBeaconInfo('imgstats',INSTART.common.imageReport());}}}};INSTART.common.imageReport=function(){var report={};for(var url in imageStats){var stats=imageStats[url];var domain=INSTART.common.getDomain(url);if(typeof report[domain]==='undefined'){report[domain]={'partial_count':0,'partial_bytes':0,'static_count':0,'static_bytes':0};}
var domainStats=report[domain];domainStats['static_count']+=1;domainStats['static_bytes']+=stats['static'];if(stats['backfill']>0){domainStats['partial_count']+=1;domainStats['partial_bytes']+=stats['backfill'];}}
return report;};})(window,document);(function(w,d){INSTART.common.getObjectProperties=function(obj){var retVal={};for(var field in obj){if(typeof obj[field]=='function'){continue;}
retVal[field]={};retVal[field]['get']=(function(){var f=field;return function(){return Object.getPrototypeOf(this)[f];};}());retVal[field]['set']=(function(){var f=field;return function(val){return Object.getPrototypeOf(this)[f]=val;};}());}
return retVal;};INSTART.common.wrapObject=function(obj,customOverides){if(!obj||!!obj.instartWrapper){return obj;}
var properties=INSTART.common.getObjectProperties(obj);properties=customOverides(obj,properties);var retVal=Object.create(obj,properties);for(var field in obj){if(typeof obj[field]!='function')
continue;retVal[field]=(function(){var f=field;var old_function=obj[f];return function(){return old_function.apply(obj,arguments);};})();}
retVal.instartOriginal=obj;retVal.instartWrapper=true;return retVal;};INSTART.common.addDom0EventHandlers=function(pProps){for(var i=0;i<INSTART.common.onStarAttrs.length;i++){var eventName=INSTART.common.onStarAttrs[i];pProps['on'+eventName]=(function(eName){var onEvDup='';var onEvCb=null;return{set:function(val){var wrappedObj=this;if(typeof onEvDup=='function'){wrappedObj.removeEventListener(eName,onEvCb);}
onEvDup=val;onEvCb=function(){INSTART.log('DEBUG: handling '+eName);if(typeof onEvDup==='function'){onEvDup.apply(wrappedObj,arguments);}else{with(wrappedObj){eval(onEvDup);}}};wrappedObj.addEventListener(eName,onEvCb);},get:function(){return onEvDup;}}})(eventName);}
return pProps;};INSTART.common.fixArgs=function(arg_vector){if(!arg_vector)return;for(var i=0;i<arg_vector.length;i++){var obj=arg_vector[i];if(!!obj&&!!obj.instartWrapper){var original_object=INSTART.common.getRealObject(obj);delete arg_vector[i];arg_vector[i]=original_object;}}};})(window,document);(function(w,d){if(typeof INSTART=='undefined'||!INSTART){INSTART={};}
function StringBuffer(){this.buffer=[];}
StringBuffer.prototype.append=function append(string){this.buffer.push(string);return this;};StringBuffer.prototype.toString=function toString(){return this.buffer.join('');};if(typeof INSTART.base64=='undefined'||!INSTART.base64){INSTART.base64={};}
var codex='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';var reverseCodex=[];for(var i=0;i<127;i++){reverseCodex.push(codex.indexOf(String.fromCharCode(i)));}
INSTART.base64.encodebin=function(input){var output=new StringBuffer();for(var i=0;i<input.length;i++){var chr1=input[i];i++;var chr2=input[i];i++;var chr3=input[i];var enc1=chr1>>2;var enc2=((chr1&0x03)<<4)|(chr2>>4);var enc3=((chr2&0x0F)<<2)|(chr3>>6);var enc4=chr3&0x3F;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output.append(codex.charAt(enc1));output.append(codex.charAt(enc2));output.append(codex.charAt(enc3));output.append(codex.charAt(enc4));}
return output.toString();};INSTART.base64.decodebin=function(input){var chr1,chr2,chr3='';var enc1,enc2,enc3,enc4='';var i=0;var base64test=/[^A-Za-z0-9\+\/\=]/g;if(base64test.exec(input)){INSTART.log('invalid base64 characters');}
input=input.replace(/[^A-Za-z0-9\+\/\=]/g,'');var retVal=new Array();do{enc1=reverseCodex[input.charCodeAt(i++)];enc2=reverseCodex[input.charCodeAt(i++)];enc3=reverseCodex[input.charCodeAt(i++)];enc4=reverseCodex[input.charCodeAt(i++)];chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;retVal.push(chr1);if(enc3!=64){retVal.push(chr2);}
if(enc4!=64){retVal.push(chr3);}
chr1=chr2=chr3='';enc1=enc2=enc3=enc4='';}while(i<input.length);return retVal;};})(window,document);(function(w,d){if(typeof INSTART=='undefined'||!INSTART){INSTART={};}
if(typeof INSTART.image2=='undefined'||!INSTART.image2){INSTART.image2={};}
INSTART.image2.dummyApi='/instart/image/0/dummy/';INSTART.image2.jpegAlpha='/instart/image/0/api/';INSTART.image2.profileUrl='/instart/profile/0/';INSTART.image2.partial='/instart/image/0/partial/';INSTART.image2.streamjpeg=0;INSTART.image2.streamingPollInterval=2000;INSTART.image2.useOptDisableHook=true;var counter=0;var waitingLoads=new Array();var incCounter=function(){counter++;};var decCounter=function(){counter--;};INSTART.image2.addImagePartHandler=function(op){waitingLoads.push(op);};INSTART.image2.init=function(config){if(config['enableImageVirtualization']){setInterval(function(){if(counter==0){var replayList=waitingLoads;replayList=new Array();for(var i=0;i<replayList.length;i++){var op=replayList[i];op.method.apply(op.context,op.args);}}},INSTART.image2.streamingPollInterval);w.addEventListener('DOMNodeRemoved',handleDomNodeRemoved);w.addEventListener('DOMContentLoaded',scrapeStaticTags);}};INSTART.image2.reqCache={};INSTART.image2.reqCache._cache={};INSTART.image2.reqCache.set=function(url){INSTART.image2.reqCache._cache[url]='dummy';};INSTART.image2.reqCache.tag=function(url){INSTART.image2.reqCache._cache[url]='tag';};INSTART.image2.reqCache.get=function(url){if(INSTART.image2.reqCache._cache.hasOwnProperty(url)){return INSTART.image2.reqCache._cache[url];}
return'';};INSTART.image2.isJpegStream=function(){return INSTART.image2.streamjpeg;};INSTART.image2.isJpeg=function(buf){return buf[0]==0xFF&&buf[1]==0xD8;}
INSTART.image2.isCompleteJpeg=function(buf){if(typeof buf.length==='undefined'){throw'Invalid type provided to isCompleteJpeg';}
if(buf.length<2){INSTART.log('buf len < 2');return false;}
var et1=buf[buf.length-2];var et2=buf[buf.length-1];return et1==0xFF&&et2==0xD9;}
var addStaticImageTags=function(domNode){var imgTags=domNode.getElementsByTagName('IMG');for(var i=0;i<imgTags.length;i++){var img=imgTags[i];if(img.instartWrapper){img=Object.getPrototypeOf(img);}
if(img.src!=''&&!/^data:/.test(img.src)){INSTART.log('TRACE: adding static tag uri '+img.src);INSTART.image2.reqCache.tag(img.src);}}};var handleDomNodeRemoved=function(eventObj){INSTART.log('TRACE: dom node removed event on '+eventObj.target.nodeName);if(eventObj.target.nodeName=='#text'||eventObj.target.nodeName=='#comment'){return;}
addStaticImageTags(eventObj.target);};var scrapeStaticTags=function(){var start=new Date().valueOf();INSTART.log('TRACE: load handler getting image tags');addStaticImageTags(document);INSTART.log('TRACE: load handler done, total ms '+(new Date().valueOf()-start));w.removeEventListener('DOMNodeRemoved',handleDomNodeRemoved);};var __cleanDotDots=function(url){var urlParts=url.split('/');var urlBuilder=new Array();urlBuilder.push(urlParts[urlParts.length-1]);for(var i=urlParts.length-2;i>=0;){var noOfDotDots=0;while(urlParts[i]=='..'){i--;noOfDotDots++;}
if(noOfDotDots>0){i=i-noOfDotDots;continue;}
urlBuilder.push(urlParts[i]);i--;}
return urlBuilder.reverse().join('/');}
var __absPath=function(url){if(/^https?:\/\//.test(url)){return url;}
var Loc=location.href;if(/^\/\//.test(url)){var scheme=Loc.substring(0,Loc.indexOf('/')+1);return scheme+url;}
if(/^\//.test(url)){var startIndex=Loc.indexOf('//')+2;return Loc.substring(0,Loc.indexOf('/',startIndex))+url;}
Loc=Loc.substring(0,Loc.lastIndexOf('/'));while(/^\.\./.test(url)){Loc=Loc.substring(0,Loc.lastIndexOf('/'));url=url.substring(3);}
return Loc+'/'+url;};var __getDomain=function(url){var abspath=INSTART.common.absPath(url);var start=abspath.indexOf('://')+3;var pathBegin=abspath.indexOf('/',start+1);var authority=abspath.substring(start,pathBegin);var portBegin=authority.lastIndexOf(':');if(portBegin!=-1){return authority.substring(0,portBegin);}else{return authority;}}
var getParamString=function(key,val){if(typeof val!='undefined'){return key+'='+encodeURIComponent(val);}
return'';};var imageApiUrl=function(pathPrefix,url,extraArgs){var params={'resource_id':{'id_type':'relative','relative_id':{'base':location.href,'resource':url}}};if(!!extraArgs){for(var p in extraArgs){if(typeof params[p]=='undefined'){params[p]=extraArgs[p];}else{throw'Overrriding parameter already defined';}}}
var reqPath=pathPrefix+encodeURIComponent(INSTART.common.json.stringify(params));return INSTART.common.vHostServiceUrl(reqPath)+reqPath;};INSTART.image2.getDummyImgUrl=function(url){if(/^$/.test(url)){throw'Cannot get dummy image of empty url';}
if(!INSTART.image2.dummyApi){throw'No INSTART.image2.dummyApi';}
return imageApiUrl(INSTART.image2.dummyApi,url,{});};INSTART.image2.getImageApiUrl=function(url,stream,fragment,width,height){if(/^$/.test(url)){throw'Cannot get image3 of empty url';}
if(!INSTART.image2.jpegAlpha){throw'No INSTART.image2.jpegAlpha';}
var extraArgs={'s':stream,'f':fragment,'w':width,'h':height};return imageApiUrl(INSTART.image2.jpegAlpha,url,extraArgs);};if(typeof INSTART.datauri=='undefined'||!INSTART.datauri){INSTART.datauri={};}
INSTART.datauri.getBase64DataUri=function(array,mimeType){return'data:'+mimeType+';base64,'+INSTART.base64.encodebin(array);};INSTART.datauri.appendToImage=function(oldDataUri,newArray){var lastPart='';var remIndex=oldDataUri.length;if(oldDataUri[oldDataUri.length-1]=='='){remIndex-=4;lastPart=oldDataUri.substring(remIndex);}
var rem=INSTART.base64.decodebin(lastPart);for(var i=0;i<newArray.length;i++){rem.push(newArray[i]);}
return oldDataUri.substring(0,remIndex)+
INSTART.base64.encodebin(rem);};var patchJpegAlpha=function(pngData,jpegData,callb){var pngBase64=INSTART.datauri.getBase64DataUri(pngData,'image/png');var jpegBase64=INSTART.datauri.getBase64DataUri(jpegData,'image/jpeg');var i1=new Image();i1.addEventListener('load',function(){var c=d.createElement('canvas');var ctx=c.getContext('2d');c.height=this.height;c.width=this.width;ctx.drawImage(this,0,0);var i2=new Image();i2.addEventListener('load',function(){ctx.globalCompositeOperation='xor';ctx.drawImage(this,0,0);callb(c.toDataURL());},false);i2.src=pngBase64;},false);i1.src=jpegBase64;};INSTART.image2.fetchImageFragment=function(url,fragNo,callb,errorcallb){var apiurl=INSTART.image2.getImageApiUrl(url,true,fragNo);INSTART.loader.fetchBinary(apiurl,function(buffer,mimeType,status){if(status==0||!buffer){if(!!errorcallb){INSTART.log('error in fetchImage');errorcallb(this,buffer,null,mimeType,status);}}else if(status==200){var b=new Uint8Array(buffer);if(b[0]==2){var imageData=new Uint8Array(buffer,2);callb.call(this,imageData);}else{INSTART.log('Wrong fragment format : '+url
+', fragment no : '+fragNo);}}else{INSTART.log(status+" returned for "+url);}});};INSTART.image2.fetchImage=function(url,callb,errorcallb,stream){INSTART.log('TRACE: '+url+'   '+stream);var s=!!stream;var apiurl=INSTART.image2.getImageApiUrl(url,s);incCounter();INSTART.loader.fetchBinary(apiurl,function(buffer,mimeType,status){decCounter();if(status==0||!buffer){if(!!errorcallb){INSTART.log('error in fetchImage');errorcallb(this,buffer,null,mimeType,status);}else{INSTART.log('error, but no error callback, calling callb '+url);}}else if(status==200){var b=new Uint8Array(buffer);if(b[0]==0){var mimeLength=b[1];var mimeArray=new Uint8Array(buffer,2,mimeLength);var mType='';for(var i=0;i<mimeLength;i++){mType+=String.fromCharCode(mimeArray[i]);}
var imageData=new Uint8Array(buffer,2+mimeLength);var imgBase64=INSTART.datauri.getBase64DataUri(imageData,mType);callb.call(this,imgBase64);}else if(b[0]==1){var pngSize=b[1]|b[2]<<8|b[3]<<16|b[4]<<24;var pngData=new Uint8Array(buffer,5,pngSize);var jpegData=new Uint8Array(buffer,5+pngSize);patchJpegAlpha(pngData,jpegData,function(imgBase64){callb.call(this,imgBase64);});}else if(b[0]==2){INSTART.log(' b[0] == 2 : jpeg streamingi, with fragments : '
+b[1]);var fragmentNo=b[1];var mType='image/jpeg';var imageData=new Uint8Array(buffer,2);var imgBase64=INSTART.datauri.getBase64DataUri(imageData,mType);callb.call(this,imgBase64,fragmentNo);}else{INSTART.log(apiurl);INSTART.log('wrong type or error');callb.call(this,url);}}else{INSTART.log(status+" returned for "+url);}});};var disabled={};INSTART.image2.disableOpts=function(doneCb,useCookies){if(!INSTART.image2.useOptDisableHook){return;}
var loc=window.location.href;if(loc in disabled){return;}else{disabled[loc]=true;}
INSTART.log('disabling opts for page '+loc);var url='//'+INSTART.common.apiDomain+INSTART.image2.profileUrl;var xhr=new XMLHttpRequest();var body=JSON.stringify({'id':'html','data':{'uri':loc}});xhr.open('POST',url);xhr.send(body);xhr.onload=function(){INSTART.log('post sent, got response code '+xhr.status);doneCb();};xhr.onerror=function(){INSTART.log('post sent, got error, code '+xhr.status);doneCb();};};INSTART.image2.fetchPartialFragment=function(url,offset,callb){var apiurl=imageApiUrl(INSTART.image2.partial,url,{'offset':offset});INSTART.log("in fetch partial fragment: "+url);INSTART.loader.fetchBinary(apiurl,function(buffer,mimeType,status){if(status==0||!buffer){INSTART.log('error in fetchImage');}else{var imageData=new Uint8Array(buffer,0);callb.call(this,imageData);}});};})(window,document);(function(w,d){if(typeof INSTART=='undefined'||!INSTART){INSTART={};}
if(typeof INSTART.loader=='undefined'||!INSTART.loader){INSTART.loader={};}
var fetchData=function(url,callback,credentialFlag){var xhr=new XMLHttpRequest();xhr.open('GET',url);xhr.withCredentials=!!credentialFlag;xhr.onreadystatechange=function(){if(xhr.readyState==4&&xhr.response instanceof ArrayBuffer){callback(xhr.response,xhr.getResponseHeader('content-type'),xhr.status);}};xhr.responseType='arraybuffer';xhr.send(null);};INSTART.loader.fetchData=fetchData;INSTART.loader.fetchCachedImageAsBinary=function(url,callback){fetchData(url,callback,false);};INSTART.loader.fetchBinary=function(url,callback){fetchData(url,callback,true);};}(window,document));(function(w,d){if(typeof INSTART=='undefined'){INSTART={};}
INSTART.canvas2d={};var installCanvas2dWrapper=function(){var queueOperation=function(method,args,ctx){this.operationQueue.push({method:method,args:args,context:ctx});};var replayOperations=function(){INSTART.log('CANVAS: running queued ops ('+this.operationQueue.length+')');this.replayingOps=true;var replay_ops=this.operationQueue;this.operationQueue=new Array();var i;for(i=0;i<replay_ops.length&&!this.stopReplayCondition();i++){var op=replay_ops[i];op.method.apply(op.context,op.args);}
for(var j=i+1;j<replay_ops.length;j++){this.operationQueue.push(replay_ops[j]);}
INSTART.log('CANVAS: remaining '+this.operationQueue.length);this.replayingOps=false;};var initOpQueue=function(obj,stopReplayCondition){obj.operationQueue=new Array();obj.queueOperation=queueOperation;obj.replayOperations=replayOperations;if(typeof stopReplayCondition=='undefined'){stopReplayCondition=function(){return false;};}
obj.stopReplayCondition=stopReplayCondition;};var waitingAttributes=['globalAlpha','globalCompositeOperation','strokeStyle','fillStyle','shadowOffsetX','shadowOffsetY','shadowBlur','shadowColor','lineWidth','lineCap','lineJoin','miterLimit','font','textAlign','textBaseline'];HTMLCanvasElement.prototype.getContext=(function(){var old_getContext=HTMLCanvasElement.prototype.getContext;return function(type){if(type=='2d'){var ctx=old_getContext.apply(this,arguments);if(!ctx.shadowCanvas){ctx.shadowCanvas=document.createElement('canvas');var args=arguments;ctx.shadowContext=(function(){return old_getContext.apply(ctx.shadowCanvas,args);})();initOpQueue(ctx,function(){return this.canvas.waiting;});}
return INSTART.common.wrapObject(ctx,function(pCtx,pProps){for(var i=0;i<waitingAttributes.length;i++){(function(){var attrName=waitingAttributes[i];pProps[attrName]={get:function(){INSTART.log('CANVAS: attribute get '+attrName);return Object.getPrototypeOf(this).shadowContext[attrName];},set:function(val){INSTART.log('CANVAS: attribute set '+attrName+' = '+
val);var execCtx=this;var unwrapped=Object.getPrototypeOf(this);if(!unwrapped.replayingOps){INSTART.log('CANVAS: applying attribute update to shadow');unwrapped.shadowContext[attrName]=val;}else{INSTART.log('CANVAS: in replay, skipping shadow update');}
if(!!execCtx.canvas.waiting){execCtx.operationQueue.push({method:function(){INSTART.log('CANVAS: delayed attribute set '+
attrName+' = '+val);execCtx[attrName]=val;},args:arguments,context:execCtx});}else{INSTART.log('CANVAS: immediate attribute set '+
attrName+' = '+val);unwrapped[attrName]=val;}}};})();}
return pProps;});}else if(type=='webgl'||type=='experimental-webgl'){return old_getContext.apply(this,arguments);}else{return old_getContext.apply(this,arguments);}};})();var cCtxProto=CanvasRenderingContext2D.prototype;var waitingOperations={'save':true,'restore':true,'scale':true,'rotate':true,'translate':true,'transform':true,'setTransform':true,'resetTransform':true,'clearRect':false,'fillRect':false,'strokeRect':false,'beginPath':true,'closePath':true,'moveTo':true,'lineTo':true,'quadraticCurveTo':true,'bezierCurveTo':true,'arcTo':true,'rect':true,'arc':true,'fill':true,'stroke':true,'drawSystemFocusRing':false,'drawCustomFocusRing':false,'scrollPathIntoView':false,'clip':true,'fillText':false,'strokeText':false,'rotateText':false};for(var i in waitingOperations){cCtxProto[i]=(function(){var opName=i;var shadow=waitingOperations[opName];var oldOp=cCtxProto[i];return function(){INSTART.log('CANVAS: CanvasRenderingContext2D.'+opName+' '+arguments);if(shadow&&!this.replayingOps){if(!this.replayingOps){INSTART.log('CANVAS: Applying '+opName+' to shadow');oldOp.apply(this.shadowContext,arguments);}else{INSTART.log('CANVAS: In replay, skipping shadow op '+opName);}}
if(!!this.canvas.waiting){INSTART.log('CANVAS: queuing CanvasRenderingContext2D.'+opName+' '+
arguments);this.operationQueue.push({method:arguments.callee,args:arguments,context:this});}else{INSTART.log('CANVAS: applying CanvasRenderingContext2D.'+opName+' '+
arguments);oldOp.apply(this,arguments);}}})();}
var factoryFunctions=['createLinearGradient','createRadialGradient'];var old_createImageData=cCtxProto['createImageData'];cCtxProto['createImageData']=function(){if(arguments.length&&arguments[0].instartWrapper){INSTART.common.fixArgs(arguments);}
old_createImageData.apply(this,arguments);};var old_putImageData=cCtxProto['putImageData'];cCtxProto['putImageData']=function(){INSTART.log('CANVAS: running putImageData');if(this.canvas.waiting){INSTART.log('CANVAS: canvas waiting, queuing draw op');this.queueOperation(arguments.callee,arguments,this);return;}
var imgData=arguments[0];if(imgData.instartWrapper){if(imgData.waiting){INSTART.log('CANVAS: image data waiting, queuing ops');this.canvas.waiting=true;this.queueOperation(arguments.callee,arguments,this);var ctx=this;imgData.queueOperation(function(){ctx.canvas.waiting=false;ctx.replayOperations();});return}else{INSTART.common.fixArgs(arguments);}}
old_putImageData.apply(this,arguments);};var old_getImageData=cCtxProto['getImageData'];cCtxProto['getImageData']=function(){INSTART.log('CANVAS: running getImageData');var orig=old_getImageData.apply(this,arguments);if(!this.canvas.waiting){INSTART.log('CANVAS: not waiting, returning immediate');return orig;}
orig.waiting=true;var wrapped=Object.create(orig,{'data':{'get':function(){if(orig.waiting){INSTART.log('oh crap, they are gettin our datas');throw"ERROR: imageData.data accessed prior to backfill";}
return this.__proto__.data;},'set':function(){}}});wrapped.instartWrapper=true;initOpQueue(wrapped);var ctx=this;var args=arguments;this.operationQueue.push({method:function(){INSTART.log('CANVAS: backfilling the getImageData response');var newProto=old_getImageData.apply(ctx,args);newProto.waiting=false;wrapped.__proto__=newProto;wrapped.replayOperations();},args:null,context:null});return wrapped;};var applyToShadow=['measureText','isPointInPath'];for(var i=0;i<applyToShadow.length;i++){cCtxProto[applyToShadow[i]]=(function(){var opName=applyToShadow[i];var oldOp=cCtxProto[opName];return function(){INSTART.log('CANVAS: Applying '+opName+' to shadow');return oldOp.apply(this.shadowContext,arguments);};})();}
var loadingOperations=['drawImage','createPattern'];for(var i=0;i<loadingOperations.length;i++){cCtxProto[loadingOperations[i]]=(function(){var oldOp=cCtxProto[loadingOperations[i]];return function(){var img=arguments[0];if(!!this.canvas.waiting){INSTART.log('CANVAS: canvas is in waiting');if(img.nodeName=='IMG'){INSTART.log('CANVAS: queuing draw for '+arguments[0].src);if(!!img.intercepted&&img._state!=INSTART.lazyLoad.state.image_loading){img.fixImage(function(){},[]);}}else if(img.nodeName=='CANVAS'){INSTART.log('CANVAS: Queuing draw from canvas');}else{throw"invalid draw argument "+img.nodeName;}
this.operationQueue.push({method:arguments.callee,args:arguments,context:this});}else{if(img.nodeName=='IMG'&&(!img.intercepted||img._state==INSTART.lazyLoad.state.image_loaded)){INSTART.log('CANVAS: immediate image apply '+arguments[0].src);INSTART.common.fixArgs(arguments);oldOp.apply(this,arguments);return;}else if(img.nodeName=='CANVAS'&&!img.waiting){INSTART.log('CANVAS: immediate canvas apply');INSTART.common.fixArgs(arguments);oldOp.apply(this,arguments);return;}
var oargs=arguments;var canvasContext=this;this.canvas.waiting=true;if(img.nodeName=='IMG'){INSTART.log('CANVAS: waiting on '+arguments[0].src);}else{INSTART.log('CANVAS: waiting on canvas '+arguments[0].id);}
var load_cb=function(){canvasContext.canvas.waiting=false;canvasContext.replayOperations();};canvasContext.operationQueue.push({method:arguments.callee,args:arguments,context:this});if(img.nodeName=='IMG'){if(img._state==INSTART.lazyLoad.state.image_loading){INSTART.common.getRealObject(img).addEventListener('load',load_cb,false);}else{img.fixImage(load_cb,oargs);}}else{INSTART.log('CANVAS: queueing canvas to canvas draw');var cctx=arguments[0].getContext('2d');cctx.operationQueue.push({method:load_cb,args:null,context:null});}}};})();}
var old_toDataURL=HTMLCanvasElement.prototype.toDataURL;HTMLCanvasElement.prototype.toDataURL=function(){var ctx=this.getContext('2d');var canvas=this;var oargs=arguments;var retVal=old_toDataURL.apply(this,arguments);if(!ctx.canvas.waiting){return retVal;}else{var s=new String('');var ovr=INSTART.common.getObjectProperties(s);var temp;ovr['content']={set:function(val){temp=val;},get:function(){if(typeof temp=='undefined'){INSTART.image2.disableOpts(function(){},false);temp=old_toDataURL.apply(this,oargs);}
return temp;}};ovr['length']={set:function(val){},get:function(){return temp.length;}};retVal=Object.create(s,ovr);retVal.waiting=true;retVal.waitList=[];retVal.toString=function(){if(typeof temp=='undefined'){INSTART.image2.disableOpts(function(){},false);temp=old_toDataURL.apply(canvas,oargs);}
return temp;};retVal.valueOf=function(){return this.toString();};ctx.operationQueue.push({method:function(){var realRetVal=old_toDataURL.apply(canvas,oargs);retVal.content=realRetVal;ctx.canvas.waiting=false;retVal.waiting=false;var n=retVal.waitList.length;for(var i=0;i<n;i++){var wl=retVal.waitList[i];wl.method.apply(wl.context,[realRetVal]);}
retVal.waitList=[];},args:[],context:this});return retVal;}};};INSTART.canvas2d.init=function(config){if(config['enableImageVirtualization']||config['partialImage']){installCanvas2dWrapper();}};})(window,document);(function(w,d){if(typeof INSTART.image2==='undefined'){INSTART.image2={};}
INSTART.lazyLoad={};INSTART.lazyLoad.state={start:'start',dummy_loading:'dummy_loading',dummy_loaded:'dummy_loaded',image_loading:'image_loading',image_loaded:'image_loaded'};INSTART.image2.useImageApi=false;INSTART.image2.enableImageVirtualization=false;INSTART.image2.virtualizeDomains=[new RegExp('.*')];INSTART.image2.overlayImageTimeOutMs=1000;var generateFragHandler=function(url,fragNo){return function(){INSTART.log('TRACE : generating next part of image for '+url+' frag no '+fragNo);var proto=INSTART.common.getRealObject(this);INSTART.image2.fetchImageFragment(url,fragNo,function(imageData){var newsrc=INSTART.datauri.appendToImage(proto['src'],imageData);INSTART.image2.changeImageSrc(proto,newsrc);});};};var loadImageOnObject=function(image,src,stream){var proto=INSTART.common.getRealObject(image);if(!INSTART.image2.useImageApi){proto['src']=src;if(INSTART.staticImg.partialImagesEnabled){INSTART.staticImg.backPatchImage(image);}}else{INSTART.image2.fetchImage(src,function(base64img,fragNos){proto['src']=base64img;if(fragNos>0){INSTART.image2.addImagePartHandler({method:generateFragHandler(src,1),context:image,args:[]});}},null,stream);}};var fixImage=function(callb,drawargs,stream){INSTART.log('TRACE: fixImage called for "'+this.src+'"');if(!this.instartWrapper){throw'TRACE: fixImage called on non-wrapped image';}
var img=this;var realObj=INSTART.common.getRealObject(img);if(realObj._state==INSTART.lazyLoad.state.image_loaded){INSTART.log('TRACE: image already fixed, returning');return;}else if(realObj._state==INSTART.lazyLoad.state.image_loading){INSTART.log('TRACE: image already loading fixes, returning');return;}
if(realObj._state==INSTART.lazyLoad.state.dummy_loading){realObj.src='';}
realObj._state=INSTART.lazyLoad.state.image_loading;var flag=false;var loadedHandler=function(){if(typeof callb!='undefined'){callb.call(img,flag);}
realObj.removeEventListener('load',loadedHandler);};realObj.addEventListener('load',loadedHandler,false);var imgUrl=this.src;if(realObj.src!=imgUrl){loadImageOnObject(this,imgUrl,stream);}else{if(typeof callb!='undefined'){callb.call(img,flag);}}};var isTobeFixed=function(){return!!this.intercepted&&!(this._state==INSTART.lazyLoad.state.image_loading||this._state==INSTART.lazyLoad.state.image_loaded);};var redefineEventHandler=function(wrappedImg){var old_addEventListener=wrappedImg.addEventListener;var old_removeEventListener=wrappedImg.removeEventListener;var realObj=INSTART.common.getRealObject(wrappedImg);if(!realObj.loadHandlers){realObj.loadHandlers=new Array();}
wrappedImg.addEventListener=function(eventName,callb){INSTART.log('TRACE: wrapped addEventListener '+eventName);if(eventName=='load'){INSTART.log("registering virtual load '"+this.src+"' "+callb);realObj.loadHandlers.push({'eventName':'load','callb':callb});}else{INSTART.log('TRACE: applying addEventListener');old_addEventListener.apply(realObj,arguments);}};wrappedImg.removeEventListener=function(eventName,callb){INSTART.log('TRACE: remove cb requested');if(eventName=='load'){var newHandlers=new Array();for(var i=0;i<realObj.loadHandlers.length;i++){if(callb!=realObj.loadHandlers[i].callb){newHandlers.push(realObj.loadHandlers[i]);}}
realObj.loadHandlers=newHandlers;}else{old_removeEventListener.apply(wrappedImg,arguments);}};};var addVirtualLoadHandler=function(wrappedImg){var proto=INSTART.common.getRealObject(wrappedImg);if(typeof proto.isVirtualLoadHanlderAdded!=='undefined'){return;}
proto.isVirtualLoadHanlderEnabled=true;proto.addEventListener('load',function(){if(!proto.isVirtualLoadHanlderEnabled){return;}
INSTART.log('firing virtual load handlers for '+this._src);if(!!proto.loadHandlers){var handlers=proto.loadHandlers;for(var i=0;i<handlers.length;i++)
{if(typeof handlers[i].callb=='function'){handlers[i].callb.apply(wrappedImg,arguments);}else{handlers[i].callb.handleEvent.apply(handlers[i],arguments);}}}
proto.isVirtualLoadHanlderEnabled=false;return true;});};var imgAttrSrcGet=function(){return this._src;};var imgAttrSrcSet=function(val){var wrappedImg=this;var proto=INSTART.common.getRealObject(this);var oldSrc=this._src;var srcForLog=val;this._src=val;if(/^data/.test(val)){srcForLog=val.substring(0,val.indexOf(';'));}
INSTART.log('TRACE: wrapped img.src.set('+srcForLog+') prev "'+oldSrc+'"');if(val==null||val==""){this._state=INSTART.lazyLoad.state.start;proto['src']=val;return;}
proto.isVirtualLoadHanlderEnabled=true;if(/^data:/.test(val)){this._state=INSTART.lazyLoad.state.image_loading;proto['src']=val;return;}
var domain=INSTART.common.getDomain(val);var virtualizeImage=false;for(var i=0;i<INSTART.image2.virtualizeDomains.length;i++){if(INSTART.image2.virtualizeDomains[i].test(domain)){virtualizeImage=true;break;}}
if(!!val.waitList&&!!val.waiting){val.waitList.push({method:function(newsrc){proto.src=newsrc;},context:this});}
var state=INSTART.image2.reqCache.get(val);if(state=='tag'){virtualizeImage=false;INSTART.log('TRACE: has tag for "'+val+'"');}
if(!virtualizeImage){INSTART.log('Not virtualizing image "'+val+'"');this._state=INSTART.lazyLoad.state.image_loading;proto['src']=val;this.addEventListener('load',function(){INSTART.staticImg.backPatchImage(INSTART.common.getRealObject(this));this.removeEventListener('load',arguments.callee);});return;}
if(INSTART.lazyLoad.notToBeLazyLoaded(val)||!INSTART.image2.enableImageVirtualization)
{this._state=INSTART.lazyLoad.state.image_loading;loadImageOnObject(this,val,INSTART.image2.isJpegStream());}else if(!!proto.parentNode){INSTART.log('TRACE: image "'+val
+'" has parent, performing fetch immediate');this._state=INSTART.lazyLoad.state.image_loading;if(state=='dummy'){INSTART.log('TRACE: priming "'+val+'" with dummy');proto['src']=INSTART.image2.getDummyImgUrl(val);}else{INSTART.log('TRACE: not cached I think '+val);}
var realImg=this;loadImageOnObject(realImg,val,INSTART.image2.isJpegStream());}else{INSTART.log('TRACE: fetching dummy for '+this._src);INSTART.image2.reqCache.set(val);this._state=INSTART.lazyLoad.state.dummy_loading;proto['src']=INSTART.image2.getDummyImgUrl(val);}};var interceptImg=function(img){if(img.intercepted){return img;}
if(!!img._wrapper){return img._wrapper;}
var retVal;{var src;if(/^data:/.test(img.src)){src='data';}else{src=img.src;}
INSTART.log('intercepting image src="'+src+'"');}
if(img.src!=''){img._state=INSTART.lazyLoad.state.image_loaded;img._src=img._src;}else{img._state=INSTART.lazyLoad.state.start;img._src='';}
INSTART.log('TRACE: intercepted image with state '+img._state);img.addEventListener('load',function(){var originalState=img._state;if(img._state==INSTART.lazyLoad.state.dummy_loading){img._state=INSTART.lazyLoad.state.dummy_loaded;}else if(img._state==INSTART.lazyLoad.state.image_loading){img._state=INSTART.lazyLoad.state.image_loaded;}else if(img._state==INSTART.lazyLoad.state.image_loaded){}else{throw"Image load callback called for "+img._src+" while image in state "+img._state;}
INSTART.log('TRACE: img load event for '+retVal.src+' transition from '+originalState+' to '+img._state);},false);img.fixImage=fixImage;img.isTobeFixed=isTobeFixed;retVal=INSTART.common.wrapObject(img,function(pImg,pProps){pProps['src']={get:imgAttrSrcGet,set:imgAttrSrcSet};INSTART.common.addDom0EventHandlers(pProps);return pProps;});retVal.intercepted=true;retVal._src=img.src;img._wrapper=retVal;delete retVal.setAttribute;delete retVal.getAttribute;retVal.fixImage=fixImage;retVal.isTobeFixed=isTobeFixed;redefineEventHandler(retVal);addVirtualLoadHandler(retVal);return retVal;};var wrapImagesInList=function(oRetVal){var retVal=new Array();for(var i=0;i<oRetVal.length;i++){if(oRetVal[i]instanceof HTMLImageElement){var t=interceptImg(oRetVal[i]);retVal[i]=t;}else{retVal[i]=oRetVal[i];}}
return retVal;};var interceptIfImg=function(obj){if(obj&&obj.nodeName=='IMG'){return interceptImg(obj);}
return obj;}
var installWrapping=function(){var htmlElements=INSTART.common.htmlElements;for(var i=0;i<htmlElements.length;i++){if(!!htmlElements[i]&&htmlElements[i].prototype.appendChild&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.appendChild!==HTMLElement.prototype.appendChild)){htmlElements[i].prototype.appendChild=(function(){var old_appendChild=htmlElements[i].prototype.appendChild;return function(elm){var oldSrc=elm.src;var realObj=elm;if(!!elm.instartWrapper){if(realObj.nodeName=='IMG'){INSTART.log('appendChild called for '+elm.src);}
realObj=Object.getPrototypeOf(elm);INSTART.common.fixArgs(arguments);if(realObj.nodeName=='IMG'&&elm.src!=""){elm.fixImage(function(){},[]);}}
return interceptIfImg(old_appendChild.apply(this,arguments));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.insertBefore&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.insertBefore!==HTMLElement.prototype.insertBefore)){htmlElements[i].prototype.insertBefore=(function(){var old_insertBefore=htmlElements[i].prototype.insertBefore;return function(elm){var oldSrc=elm.src;var realObj=elm;if(!!elm.instartWrapper){if(realObj.nodeName=='IMG'){INSTART.log('insertBefore called for '+elm.src);}
realObj=Object.getPrototypeOf(elm);INSTART.common.fixArgs(arguments);if(realObj.nodeName=='IMG'&&elm.src!=""){elm.fixImage(function(){},[]);}}
return interceptIfImg(old_insertBefore.apply(this,arguments));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.replaceChild&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.replaceChild!==HTMLElement.prototype.replaceChild)){htmlElements[i].prototype.replaceChild=(function(){var old_replaceChild=htmlElements[i].prototype.replaceChild;return function(elm,ori){var oldSrc=elm.src;var realObj=elm;if(!!elm.instartWrapper){if(realObj.nodeName=='IMG'){INSTART.log('replaceChild called for '+elm.src);}
realObj=Object.getPrototypeOf(elm);INSTART.common.fixArgs(arguments);if(realObj.nodeName=='IMG'&&elm.src!=""){elm.fixImage(function(){},[],INSTART.image2.isJpegStream());}}
return interceptIfImg(old_replaceChild.apply(this,arguments));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.removeChild&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.removeChild!==HTMLElement.prototype.removeChild)){htmlElements[i].prototype.removeChild=(function(){var old_removeChild=htmlElements[i].prototype.removeChild;return function(elm){if(!!elm.instartWrapper){INSTART.common.fixArgs(arguments);}
return interceptIfImg(old_removeChild.apply(this,arguments));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.getElementsByTagName&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.getElementsByTagName!==HTMLElement.prototype.getElementsByTagName)){htmlElements[i].prototype.getElementsByTagName=(function(){var old_getElementsByTagName=htmlElements[i].prototype.getElementsByTagName;return function(elm){var realObj=elm;if(!!elm.instartWrapper){realObj=Object.getPrototypeOf(elm);INSTART.common.fixArgs(arguments);if(realObj.nodeName=='IMG'&&elm.src!=""){elm.fixImage(function(){},[],INSTART.image2.isJpegStream());}}
return INSTART.common.addItemMethod(wrapImagesInList(old_getElementsByTagName.apply(this,arguments)));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.getElementsByClassName&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.getElementsByClassName!==HTMLElement.prototype.getElementsByClassName)){htmlElements[i].prototype.getElementsByClassName=(function(){var old_getElementsByClassName=htmlElements[i].prototype.getElementsByClassName;return function(){return INSTART.common.addItemMethod(wrapImagesInList(old_getElementsByClassName.apply(this,arguments)));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.querySelectorAll&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.querySelectorAll!==HTMLElement.prototype.querySelectorAll)){htmlElements[i].prototype.querySelectorAll=(function(){var old_querySelectorAll=htmlElements[i].prototype.querySelectorAll;return function(elm){return INSTART.common.addItemMethod(wrapImagesInList(old_querySelectorAll.apply(this,arguments)));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.querySelector&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.querySelector!==HTMLElement.prototype.querySelector)){htmlElements[i].prototype.querySelector=(function(){var old_querySelector=htmlElements[i].prototype.querySelector;return function(elm){return interceptIfImg(old_querySelector.apply(this,arguments));};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.compareDocumentPosition&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.compareDocumentPosition!==HTMLElement.prototype.compareDocumentPosition)){htmlElements[i].prototype.compareDocumentPosition=(function(){var old_compareDocumentPosition=htmlElements[i].prototype.compareDocumentPosition;return function(){INSTART.common.fixArgs(arguments);return old_compareDocumentPosition.apply(INSTART.common.getRealObject(this),arguments);};})();}
if(!!htmlElements[i]&&htmlElements[i].prototype.contains&&(htmlElements[i]===HTMLElement||htmlElements[i].prototype.contains!==HTMLElement.prototype.contains)){htmlElements[i].prototype.contains=(function(){var old_contains=htmlElements[i].prototype.contains;return function(){INSTART.common.fixArgs(arguments);return old_contains.apply(INSTART.common.getRealObject(this),arguments);}})();}}
var documentProto=w['HTMLDocument']&&w['HTMLDocument'].prototype?w['HTMLDocument'].prototype:d;var old_doc_contains=documentProto.contains;documentProto.contains=function(){var realObj=INSTART.common.getRealObject(this);INSTART.common.fixArgs(arguments);return old_doc_contains.apply(realObj,arguments);};var old_doc_getElementsByTagName=documentProto.getElementsByTagName;documentProto.getElementsByTagName=function(){var realObj=INSTART.common.getRealObject(this);var oldValue=old_doc_getElementsByTagName.apply(realObj,arguments);return INSTART.common.addItemMethod(wrapImagesInList(oldValue));};var old_doc_getElementsByClassName=documentProto.getElementsByClassName;documentProto.getElementsByClassName=function(){var realObj=INSTART.common.getRealObject(this);var oldValue=old_doc_getElementsByClassName.apply(realObj,arguments);return INSTART.common.addItemMethod(wrapImagesInList(oldValue));};var old_doc_getElementsByName=documentProto.getElementsByName;documentProto.getElementsByName=function(){var realObj=INSTART.common.getRealObject(this);var oldValue=old_doc_getElementsByName.apply(realObj,arguments);return INSTART.common.addItemMethod(wrapImagesInList(oldValue));};var old_createElement=documentProto.createElement;documentProto.createElement=function(){var retVal=old_createElement.apply(this,arguments);if(arguments[0].toUpperCase()=='IMG'){INSTART.log('TRACE: createElement img');retVal=interceptImg(retVal);}
return retVal;};var old_getElementById=documentProto.getElementById;documentProto.getElementById=function(){var retVal=old_getElementById.apply(this,arguments);return interceptIfImg(retVal);};var old_querySelectorAll=documentProto.querySelectorAll;documentProto.querySelectorAll=function(){INSTART.log('TRACE: begin query selector wrapper '+arguments[0]);var oRetVal=old_querySelectorAll.apply(this,arguments);INSTART.log('TRACE: end query selector wrapper');return INSTART.common.addItemMethod(wrapImagesInList(oRetVal));};var old_querySelector=documentProto.querySelector;documentProto.querySelector=function(){INSTART.log('TRACE: begin query selector wrapper '+arguments[0]);var oRetVal=old_querySelector.apply(this,arguments);INSTART.log('TRACE: end query selector wrapper');return interceptIfImg(oRetVal);};var old_setAttribute=HTMLImageElement.prototype.setAttribute;HTMLImageElement.prototype.setAttribute=function(key,val){if(!!this.intercepted&&key.toUpperCase()=='SRC'){this.src=val;}else if(key.toUpperCase()=='SRC'&&!!this._wrapper){this._wrapper['src']=val;}else{old_setAttribute.apply(INSTART.common.getRealObject(this),arguments);}};var old_getAttribute=HTMLImageElement.prototype.getAttribute;HTMLImageElement.prototype.getAttribute=function(key){if(!!this.intercepted&&key.toUpperCase()=='SRC'){return this._src;}else{return old_getAttribute.apply(INSTART.common.getRealObject(this),arguments);}};var old_getComputedStyle=w.getComputedStyle;w.getComputedStyle=function(elem){if(!!elem.intercepted){INSTART.common.fixArgs(arguments);}
var retVal=old_getComputedStyle.apply(this,arguments);return retVal;};var Image2=Image;Image=(function(){return function(width,height){INSTART.log('TRACE: creating wrapped image');var img;if(!!height){img=new Image2(width,height);}else if(!!width){img=new Image2(width);}else{img=new Image2();}
return interceptImg(img);};})();};if(typeof INSTART=='undefined'||!INSTART){INSTART={};}
if(typeof INSTART.lazyLoad=='undefined'||!INSTART.lazyLoad){INSTART.lazyLoad={};}
var noLazyLoadList=[];INSTART.lazyLoad.setNoLazyLoading=function(url){noLazyLoadList[url]=1;};INSTART.lazyLoad.unsetNoLazyLoading=function(url){noLazyLoadList[url]=0;};INSTART.lazyLoad.notToBeLazyLoaded=function(url){return noLazyLoadList[url]==1;};if(typeof INSTART.image2=='undefined'||!INSTART.image2){INSTART.image2={};}
INSTART.image2.RealImage=Image;var getOffSetOfObject=function(obj){var innerBound=obj.getBoundingClientRect();if(obj.offsetParent){do{}while((obj=obj.offsetParent)&&w.getComputedStyle(obj).position=='static');}
var outerBound={left:0,top:0};if(!!obj){outerBound=obj.getBoundingClientRect();}
return{left:innerBound.left-outerBound.left,top:innerBound.top-outerBound.top};};var isOverlayCorrect=function(obj,overlay){var errMargin=0.1;var oldBound=obj.getBoundingClientRect();var newBound=overlay.getBoundingClientRect();if(Math.abs(oldBound.top-newBound.top)>errMargin||Math.abs(oldBound.bottom-newBound.bottom)>errMargin||Math.abs(oldBound.left-newBound.left)>errMargin||Math.abs(oldBound.right-newBound.right)>errMargin)
{return false;}else{return true;}};INSTART.image2.changeImageSrc=function(realImg,src){if(!!realImg.offsetParent){var position=getOffSetOfObject(realImg);var newImg=realImg.cloneNode(false);newImg.fakeNode=true;newImg.style.cssText=INSTART.common.getStyleAsString(realImg);newImg.id='';realImg.addEventListener('load',function(){newImg.style.opacity='0.5';setTimeout(function(){if(newImg.parentNode){INSTART.log('removing newImg')
newImg.parentNode.removeChild(newImg);}else{if(realImg.parentNode){INSTART.log('newImg missing, assuming remove real')
realImg.parentNode.removeChild(realImg);}else{INSTART.error('both removed, not good');}}},INSTART.image2.overlayImageTimeOutMs);this.removeEventListener('load',arguments.callee);});newImg['src']=src;newImg.style.position='absolute';newImg.style.top=position.top+'px';newImg.style.left=position.left+'px';newImg.addEventListener('load',function(){INSTART.log('In newImage load handler');if(!realImg.parentNode){INSTART.log('realImg orphaned, giving up!');return;}
realImg.parentNode.insertBefore(newImg,realImg);if(!isOverlayCorrect(realImg,newImg)){INSTART.error('Overlay IS NOT correct ');}else{INSTART.log('DEBUG : Overlay IS correct ');}
realImg['src']=src;});}else{realImg['src']=src;}};INSTART.image2.init=function(config){if('dynamicInterception'in config&&config['dynamicInterception']==false){Image=INSTART.image2.RealImage;}
try{INSTART.common.getConfigRegexList(config,'virtualizeDomains',INSTART.image2.virtualizeDomains);}catch(e){console.error('virtualizeDomains config error: '+e);}
if('useImageApi'in config&&typeof config['useImageApi']=='boolean'){INSTART.image2.useImageApi=config['useImageApi'];}
if('enableImageVirtualization'in config&&typeof config['enableImageVirtualization']=='boolean'){INSTART.image2.enableImageVirtualization=config['enableImageVirtualization'];}
if(config['enableImageVirtualization']||config['partialImage']){installWrapping();}};})(window,document);(function(w,d){if(typeof INSTART=='undefined'||!INSTART){INSTART={};}
if(typeof INSTART.staticImg=='undefined'||!INSTART.staticImg){INSTART.staticImg={};}
INSTART.staticImg.partialDomainPatterns=[new RegExp('.*')];INSTART.staticImg.partialImagesEnabled=true;var backPatchManager=(function(){var delay=0;var running=false;var backpatchOpQueue=[];var reserve=function(){if(0<backpatchOpQueue.length){iter();}else{running=false;}};var iter=function(){INSTART.log('backpatch iter');var op=backpatchOpQueue[0];backpatchOpQueue.shift();op.cb(op.newsrc);if(0<backpatchOpQueue.length){setTimeout(iter,delay);}else{setTimeout(reserve,delay);}};var run=function(){running=true;iter();};return{queue:function(cb,newsrc){backpatchOpQueue.push({'cb':cb,'newsrc':newsrc});if(!running){run();}}};})();var loaded=false;var urlState={idle:'idle',checking:'checking'};var pending={};var backPatchUrl=function(url,track,callback){if(!isPartial(url)){return;}
INSTART.log('backpatch called for '+url);var state=null;if(url in pending){state=pending[url];if(state.notPartial){INSTART.log('not a partial image');return;}}else{state={'callbacks':[],'notPartial':false,'state':urlState.idle};pending[url]=state;}
state['callbacks'].push(callback);if(state['state']==urlState.idle){INSTART.log('Checking "'+url+'" for backpatch');state.state=urlState.checking;if(track){INSTART.common.registerImgStatsUrl(url);}
INSTART.loader.fetchCachedImageAsBinary(url,function(buffer,mimeType,status){if(status==0||!buffer){INSTART.log('Error: error in fetching image '+url);}else{var imageData=new Uint8Array(buffer,0);INSTART.log('TRACE: static image: '+url+', '+mimeType+', '+
!INSTART.image2.isCompleteJpeg(imageData));if(!INSTART.image2.isCompleteJpeg(imageData)&&INSTART.image2.isJpeg(imageData)){INSTART.log('Fetching partial for '+url);INSTART.image2.fetchPartialFragment(url,imageData.length,function(remImageData){var fullData;if(INSTART.image2.isJpeg(remImageData)){INSTART.log('got full image as second: '+remImageData.length);fullData=remImageData;}else{INSTART.log('got partial remainder first: '+imageData.length+' second: '+remImageData.length);fullData=new Uint8Array(imageData.length+remImageData.length);fullData.set(imageData,0);fullData.set(remImageData,imageData.length);}
var newsrc=INSTART.datauri.getBase64DataUri(fullData,'image/jpeg');for(var i=0;i<state.callbacks.length;i++){backPatchManager.queue(state.callbacks[i],newsrc);}
state.callbacks=[];state.state=urlState.idle;if(track){INSTART.common.imgStats(url,imageData.length,fullData.length-imageData.length);}});}else{state.callbacks=[];state.state=urlState.idle;state.notPartial=true;if(track){INSTART.common.imgStats(url,imageData.length,0);}}}});}};var dataUrlRe=new RegExp(/^data:/);var queuedBackpatch=[];var backPatchImage=function(img,track){img=INSTART.common.getRealObject(img);if(!INSTART.staticImg.partialImagesEnabled){return;}
if(img.src==''||dataUrlRe.test(img.src)){return;}
if(!loaded){queuedBackpatch.push(img);return;}
var src=img.src;backPatchUrl(src,track,function(dataUri){if(img.src==src){INSTART.log('backpatching for '+src);img._src=src;INSTART.image2.changeImageSrc(img,dataUri);}});};INSTART.staticImg.backPatchImage=function(img){backPatchImage(img,false);};INSTART.staticImg.isDomainIntercepted=function(domain){for(var i=0;i<INSTART.staticImg.partialDomainPatterns.length;i++){var pattern=INSTART.staticImg.partialDomainPatterns[i];if(INSTART.staticImg.partialDomainPatterns[i].test(domain)){return true;}}
return false;};var isPartial=function(url){if(!INSTART.staticImg.partialImagesEnabled||typeof url=='undefined'||/^data:/.test(url)){INSTART.log('what');return false;}
var domain=INSTART.common.getDomain(url);return INSTART.staticImg.isDomainIntercepted(domain);};var backPatchStyle=function(backgroundImage,element){if(!/^url\(/.test(backgroundImage)){INSTART.log('bailing on non-url');return;}
if(/^url\(.?data:/.test(backgroundImage)){INSTART.log('bailing on data uri');return;}
var url;if(backgroundImage[4]=='"'||backgroundImage[4]=="'"){url=backgroundImage.substring(5,backgroundImage.length-2);}else{url=backgroundImage.substring(4,backgroundImage.length-1);}
INSTART.log('url from style: '+url);backPatchUrl(url,false,function(newSrc){INSTART.log('backpatch fetched data uri')
if(element.style.backgroundImage==backgroundImage){element.style.backgroundImage=['url("',newSrc,'")'].join('');}});};var iterBackgroundImages=function(iter){for(var i=0;i<50;i++){var curNode=iter.nextNode()
if(curNode==null){return;}
attrModCommon(curNode);}
setTimeout((function(){return function(){iterBackgroundImages(iter);}})(),1);};var createNodeIterator=function(root,whatToShow,filter,entityReferenceExpansion){return d.createNodeIterator(root,whatToShow,filter,entityReferenceExpansion);};var partialImageOnload=function(){INSTART.log('load event -> backpatch');var imgCollection=d.getElementsByTagName('img');loaded=true;for(var i=0;i<imgCollection.length;i++){backPatchImage(imgCollection[i],true);}
for(var i=0;i<queuedBackpatch.length;i++){backPatchImage(queuedBackpatch[i],true);}
var iter=createNodeIterator(document.body,NodeFilter.SHOW_ELEMENT,null,false);iterBackgroundImages(iter);addStyleHandler();addDomModListener();};var attrModCommon=function(target){if(target.nodeName=='DIV'){if(!/^url\("data:/.test(target.style.backgroundImage)){if(target.style.backgroundImage!=""){INSTART.log('attr modified -> TODO check for style : '+' : '+target.style.backgroundImage);backPatchStyle(target.style.backgroundImage,target);}}}};var addStyleHandler=function(){if(INSTART.common.MutationObserver!==null){}else{d.addEventListener('DOMAttrModified',function(e){if(e.attrChange===MutationEvent.MODIFICATION&&e.attrName==='style'&&e.target.nodeName!='#text'&&e.target.nodeName!='#comment'){attrModCommon(e.target);}},true);}};var nodeId=0;var subtreeModState={};var subtreeModEventQueued=false;var subtreeModAddNode=function(node){if(typeof node.__uid==='undefined'){node.__uid=nodeId;nodeId++;}
subtreeModState[node.__uid]=node;if(!subtreeModEventQueued){subtreeModEventQueued=true;setTimeout(subtreeModProcessNodes,50);}};var subtreeModProcessNodes=function(){var id;for(id in subtreeModState){var cur=subtreeModState[id];setTimeout((function(){var node=cur;var node_uid=id;return function(){subtreeModProcessNode(node,node_uid);}})(),1);break;}
if(typeof id==='undefined'){subtreeModEventQueued=false;}};var subtreeModProcessNode=function(node,node_uid){var imgs=node.getElementsByTagName('img');for(var i=0;i<imgs.length;i++){if(!imgs[i].fakeNode)
backPatchImage(imgs[i],false);}
var iter=createNodeIterator(node,NodeFilter.SHOW_ELEMENT,null,false);iterBackgroundImagesModSubtree(iter,node_uid);};var iterBackgroundImagesModSubtree=function(iter,node_uid){var curNode=null;for(var i=0;i<50;i++){curNode=iter.nextNode()
if(curNode===null){break;}
if(typeof curNode.__uid!=='undefined'){delete subtreeModState[curNode.__uid];}
attrModCommon(curNode);}
if(curNode===null){delete subtreeModState[node_uid];subtreeModProcessNodes();}else{setTimeout((function(){return function(){iterBackgroundImagesModSubtree(iter,node_uid);}})(),1);}};var addDomModListener=function(){d.addEventListener('DOMSubtreeModified',function(e){if(typeof e.target!=='undefined'&&typeof e.target.getElementsByTagName!=='undefined'&&e.target.nodeName!='#text'&&e.target.nodeName!='#comment'){if(!e.target.hasChildNodes()){return;}
subtreeModAddNode(e.target);}},true);};INSTART.staticImg.init=function(config){if(typeof config['partialImage']==='boolean'){INSTART.staticImg.partialImagesEnabled=config['partialImage'];}
try{INSTART.common.getConfigRegexList(config,'virtualizeDomains',INSTART.staticImg.partialDomainPatterns);}catch(e){console.error('virtualizeDomains config error: '+e);}
if(config['partialImage']){w.addEventListener('load',function(){setTimeout(partialImageOnload,1);});}};})(window,document);INSTART.init(INSTART.features.site_config);}
