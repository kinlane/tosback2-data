!function(d,f){var e=$Sq.models.BaseModel.extend({initialize:function(){},save:function(g){var h={id:this.get("lmi"),message:this.get("message"),blurb_data:true,group:this.get("group")};$Sq.api("thread/reply",h,_.bind(function(i){this.set(i[0]);if(d.isFunction(g.success)){g.success(this)}},this),_.bind(function(i){if(d.isFunction(g.error)){g.error(false)}},this))},threadapi:function(g,h){$Sq.api("thread/"+g,{id:this.id},function(i){if(d.isFunction(h)){h(i)}},function(i){if(d.isFunction(h)){h(i)}})},destroy:function(){this.threadapi("delete",_.bind(function(g){this.collection.trigger("destroy",this);this.collection.remove(this)},this))},reply:function(g,i){var h={id:this.get("lmi"),parent:this.id,message:g,blurb_data:true};this.trigger("beforereply",this,h);$Sq.api("thread/reply",h,_.bind(function(j){console.log(j);j[0].level=parseInt(this.get("level"))+1;j[0].levelclass="comment_indent";j[0].lmi=j[0].lens_module_id;this.trigger("afterreply",this,j);var k=new e(j[0]);this.collection.add(k);if(d.isFunction(i)){i(true)}},this),_.bind(function(j){this.trigger("errorreply",this,j);if(d.isFunction(i)){i(false)}},this))}});var c=$Sq.views.View.extend({events:{'click [data-action="cancel-reply"]':function(){this.trigger("cancel");this.$el.hide();return false}},initialize:function(){$Sq.login(this.$el.find('[data-action="reply"]'),_.bind(function(g,h){if(g){this.model.reply(this.$el.find("textarea").val(),_.bind(function(i){if(i){this.$el.hide()}else{}},this))}},this))}});var a;var b=f.View.extend({tagName:"li",className:"comment",events:{'click [data-action="show-reply"]':function(h){var g=d(h.target);a.module.$el.find('[data-action="show-reply"]').show();g.hide();a.model=this.model;this.$el.find(".form").append(a.el);a.$el.show();a.module.$el.find('textarea[name="replymessage"]').focus();return false},'click [data-action="delete"]':function(){this.$el.hide("slow",_.bind(function(){this.model.destroy()},this));return false},'click [data-action="share"]':function(){d("#modal-share-post").modal("toggle");return false}},initialize:function(){a.bind("cancel",_.bind(function(){this.$el.find('[data-action="show-reply"]').show()},this));this.model.bind("afterreply",_.bind(this.afterreply,this));this.model.bind("beforereply",_.bind(this.beforereply,this));this._setup_interact_buttons()},render:function(){this.$el.html($Sq.Templates.render("#blurb_template"+this.module._lmi,this.model.attributes));this.$el.addClass(this.model.get("levelclass"));this.$el.attr("data-level",this.model.get("level"));this.$el.attr("data-blurb_id",this.model.id);this.$el.attr("data-group",this.model.get("group"));this.$el.attr("data-owner",this.model.get("owner").id);this.$el.attr("data-from",this.model.get("from").id);this.$el.hide();return this},afterreply:function(){a.$el.find("textarea").val("").removeClass("loading");this.$el.find('[data-action="show-reply"]').show()},beforereply:function(){a.$el.find("textarea").val("").addClass("loading")},_setup_interact_buttons:function(){var g=this.$el.find('[data-action="flag"], [data-action="unflag"], [data-action="like-comment"], [data-action="unlike-comment"]');$Sq.login(g,_.bind(function(h,i,j){if(h){var k=j,l=k.data("action");if(l==="like-comment"){l="like"}else{if(l==="unlike-comment"){l="unlike"}}this.model.threadapi(l,_.bind(function(m){var p=this.$el.find(".comment_count_rt");var n=0,o=0;if(l=="like"){n=p.html();o=parseInt(n)+1;p.html(o);k.html("Unlike").data("action","unlike")}else{if(l=="unlike"){n=p.html();o=parseInt(n)-1;p.html(o);k.html("Like").data("action","like")}}if(l=="flag"){k.html('<i class="icon-flag"></i> Unflag').attr("title","Unflag").data("action","unflag")}else{if(l=="unflag"){k.html('<i class="icon-flag"></i> Flag').attr("title","Flag").data("action","flag")}}},this))}return false},this))}});$Sq.views.bless("comments",{view:{events:{"submit .comment_form":function(){this.$commentbox=this.$el.find("#comment");if(this._mode=="duel"){this.$commentbox=this.$el.find("#modal_comment")}var h={message:this.$commentbox.val(),lmi:this._lmi};if(this.votebox&&this.votebox.val()==undefined){alert("You need to pick a side");return false}else{if(this.votebox&&this.votebox.val()=="option2"){h.group=1}}var g=new e(h);g.save({success:_.bind(function(k){this.collection.add(k);var j={};if(this.status_update.facebook){j={message:h.message,link:this.share_url};$Sq.api("facebook/status",{params:j},function(l){console.log(l,"facebook")})}if(this.status_update.twitter){var i=h.message.trim();i=(i.length>119?i.substr(0,116)+"... ":i+" ");j={status:i+this.short_url};$Sq.api("twitter/tweet",{params:j},function(l){console.log(l,"tweet")})}},this)});return false}},initialize:function(){console.log("comments initialized");this.status_update={};this.short_url=this.$el.data("short-url");this.share_url=this.$el.data("share-url");this._setup_social();a=new c({el:this.$el.find(".comment_reply")});a.module=this;this._mode=this.$el.data("comments-mode");this._scores={option1:parseInt(this.$el.find("[data-score-option1]").data("score-option1")),option2:parseInt(this.$el.find("[data-score-option2]").data("score-option2"))};setTimeout(_.bind(function(){d(window).trigger("change:duel:score",[this._lmi,this._scores])},this),1000);var g=this.$el.find("textarea");g.expando();g.keyup(function(h){var i=d(h.currentTarget).parents(".comment_bd").find("button[data-action]");if(d(h.currentTarget).attr("id")=="modal_comment"){i=d(h.currentTarget).parents(".modal").find("button")}if(d(h.currentTarget).val().trim().length>0){i.removeClass("disabled");i.removeAttr("disabled")}else{i.addClass("disabled");i.attr("disabled","disabled")}});this.collection=new ($Sq.models.BaseCollection.extend({model:e}));this._$btn_comment=this.$el.find('[data-action="create-blurb"]');$Sq.register(this._$btn_comment,_.bind(function(j,i,h){if(j){d(h).parents(".comment_form").submit();return false}return false},this));this._$btn_facebook=this.$el.find('[data-share="facebook"]');this._$btn_twitter=this.$el.find('[data-share="twitter"]');this._setupShareBtn();this.collection.bind("add",_.bind(this.add,this));this.collection.bind("destroy",_.bind(this.remove,this));this.$el.find("[data-blurb_id]").each(_.bind(function(j,k){var l=d(k);var h=new e({id:l.data("blurb_id"),lmi:this._lmi,level:l.data("level"),group:l.data("group")});this.collection.add(h,{silent:true});new b({el:d(k),model:h});this._turnOnModeration(l)},this));this._setup_follow_btn();this._getLikeCounts();this._setup_sides_nav();this._resetEmbedHeight()},_turnOnModeration:function(g){if(theMember.id==g.data("owner")){g.find('[data-action="delete"]').show()}},_sharePrefs:function(){$Sq.getLoginStatus(_.bind(function(g){if(theMember.prefs["comment.facebook"]!=="false"&&g.facebook){this._$btn_facebook.attr("checked","checked");this.status_update.facebook=true}if(theMember.prefs["comment.twitter"]!=="false"&&g.twitter){this._$btn_twitter.attr("checked","checked");this.status_update.twitter=true}},this))},_setupShareBtn:function(){this._$btn_twitter.unbind("click").unbind("mousedown");this._$btn_facebook.unbind("click").unbind("mousedown");if(window.isLoggedIn){this._sharePrefs();$Sq.Facebook.login(this._$btn_facebook,_.bind(function(g){this._toggleShareBtn("facebook",g)},this));$Sq.oAuth.login(this._$btn_twitter,{service:"twitter"},_.bind(function(g){this._toggleShareBtn("twitter",g)},this))}else{$Sq.register(this._$btn_facebook,"click",_.bind(function(i,h,g){this._toggleShareBtn("facebook",h);this._setupShareBtn()},this),"facebook");$Sq.register(this._$btn_twitter,"click",_.bind(function(i,h,g){this._toggleShareBtn("twitter",h);this._setupShareBtn()},this),"twitter")}},_toggleShareBtn:function(h,g){if(h=="facebook"){if(g.facebook){if(!this.status_update.facebook){this._$btn_facebook.attr("checked","checked");this.status_update.facebook=true;session.prefs.set("comment.facebook",true).save()}else{this._$btn_facebook.removeAttr("checked");this.status_update.facebook=false;session.prefs.set("comment.facebook",false).save()}}}if(h=="twitter"){if(g.twitter){if(!this.status_update.twitter){this._$btn_twitter.attr("checked","checked");this.status_update.twitter=true;session.prefs.set("comment.twitter",true).save()}else{this._$btn_twitter.removeAttr("checked");this.status_update.twitter=false;session.prefs.set("comment.twitter",false).save()}}}},vote:function(g){this.$id("how_you_feel").html(g.message);this.votebox=this.$el.find("#side"+this._lmi);this.votebox.val(g.option);this.$id("modal").modal("show")},add:function(h){var g=new b({model:h});g.module=this;g.render();if(g.model.get("parent")){var i=this.$el.find('[data-blurb_id="'+g.model.get("parent")+'"]');i.after(g.el);i.next().slideDown("slow",_.bind(function(){this._resetEmbedHeight()},this))}else{if(this._mode=="duel"){this.$id("modal").modal("hide")}this.$commentbox.val("");this.$commentbox.removeClass("loading");var j=this.$el.find(".sides_nav");j.after(g.el);j.next().slideDown("slow",_.bind(function(){this._resetEmbedHeight()},this))}if(g.model.get("parent")==0){this.add_score(g.model.get("group"))}if(this._mode=="duel"){d(window).trigger("change:duel:prompt",h)}this._turnOnModeration(g.$el)},_resetEmbedHeight:function(){if(Squidoo.embedded){Squidoo.resetHeight(null,Squidoo.embedded)}},remove:function(g){if(g.get("parent")==0){this.sub_score(g.get("group"))}this._resetEmbedHeight()},add_score:function(g){var h=0;if(g==0){this.$id("option1").text(this._scores.option1=this._scores.option1+1)}else{if(g==1){this.$id("option2").text(this._scores.option2=this._scores.option2+1)}}d(window).trigger("change:duel:score",[this._lmi,this._scores])},sub_score:function(g){var h=0;if(g==0){this.$id("option1").text(this._scores.option1=this._scores.option1-1)}else{if(g==1){this.$id("option2").text(this._scores.option2=this._scores.option2-1)}}d(window).trigger("change:duel:score",[this._lmi,this._scores])},_setup_follow_btn:function(){var g=this.$el.find("[data-subscribe]");g.tooltip();$Sq.login(g,_.bind(function(h,i){if(h){var j=g.data("action");if(j=="subscribe"){g.html('<i class="icon-envelope"></i> Unfollow ');g.data("action","unsubscribe")}else{if(j=="unsubscribe"){g.html('<i class="icon-envelope"></i> Follow ');g.data("action","subscribe")}}$Sq.api("thread/"+j,{id:this._lmi},function(k){},function(k){})}return false},this))},_getLikeCounts:function(){var g=[];g=this.collection.pluck("id");if(g.length){$Sq.api("thread/count_likes","get",{ids:g.join()},_.bind(function(h){for(var j in h){var i=h[j].likecount;this.$el.find('[data-blurb_id="'+j+'"] .comment_count_rt').html(i)}},this),_.bind(function(h){},this))}},_setup_social:function(){var g=this.$el.find(".post_to");$Sq.Facebook.login(g,function(h){if(h){if(g.attr("checked")=="checked"){g.removeAttr("checked");return false}g.attr("checked","checked")}else{g.removeAttr("checked")}return false})},_setup_sides_nav:function(){if(this._mode=="duel"){this.$el.find("[data-showgroup]").click(_.bind(function(g){this.$el.find("[data-showgroup]").parent().removeClass("active");d(g.currentTarget).parent().addClass("active");var h=d(g.currentTarget).data("showgroup");if(h==-1){this.$el.find("[data-group]").show("fast")}else{if(h==0){this.$el.find('[data-group="1"]').hide("fast");this.$el.find('[data-group="'+h+'"]').show("fast")}else{if(h==1){this.$el.find('[data-group="0"]').hide("fast");this.$el.find('[data-group="'+h+'"]').show("fast")}}}return false},this))}}}})}(jQuery,Backbone);