!function(f,a){var b={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};Backbone.sync=function(n,k,j){var l=b[n];j||(j={});var m={type:l,dataType:"json"};if(!j.url){m.url=d(k,"url")||g()}if(!j.data&&k&&(n=="create"||n=="update")){m.data=k.toJSON()}if(Backbone.emulateJSON){m.contentType="application/x-www-form-urlencoded";m.data=m.data?{model:m.data}:{}}if(l==="PUT"||l==="DELETE"){if(Backbone.emulateJSON){m.data._method=l}m.type="POST"}m.beforeSend=function(o){if(l==="PUT"||l==="DELETE"){o.setRequestHeader("X-HTTP-Method-Override",l)}if(l!=="GET"){o.setRequestHeader("X-CSRF",CSRF)}};return f.ajax(_.extend(m,j))};var d=function(j,k){if(!(j&&j[k])){return null}return _.isFunction(j[k])?j[k]():j[k]};var g=function(){throw new Error('A "url" property or function must be specified')};$Sq.models={};$Sq.models.BaseModel=a.Model.extend({parse:function(k,j){return k.result&&_.isArray(k.result)?k.result[0]:k.result}});$Sq.models.BaseModel.extend=function(j){j=j||{};var l=j.initialize||function(){},k=this.prototype;j.initialize=function(){k.initialize.apply(this,arguments);l.apply(this,arguments)};return a.Model.extend.call(this,j)};$Sq.models.BaseCollection=a.Collection.extend({model:$Sq.models.BaseModel,parse:function(k,j){return _.map(_.isArray(k.result)?k.result:[k.result],function(l){return{result:l}})}});$Sq.models.BaseCollection.extend=function(j){j=j||{};var l=j.initialize||function(){},k=this.prototype;j.initialize=function(){k.initialize.apply(this,arguments);l.apply(this,arguments)};return a.Collection.extend.call(this,j)};var i=$Sq.models.BaseModel.extend({initialize:function(k,j){this._member=j?j.member:new $Sq.models.Member();this.save=_.debounce(this.save,100);this._member.on("change:prefs",function(n,m,l){n.prefs=new i(m,{member:n})});this.on("change",function(n,m){n._member.set("prefs",_.extend(n._member.get("prefs"),n.attributes),{silent:true});for(var l in n.changed){n._member.trigger("change:prefs:"+l,n._member,n.get(l),m)}})},url:function(){return"/api/member/prefs?member="+(this._member?this._member.id:"")},toJSON:function(){var j=_.clone(this.attributes);return{prefs:j,member:this._member.id}}});$Sq.models.Member=$Sq.models.BaseModel.extend({initialize:function(){this.prefs=new i(this.get("prefs"),{member:this})},url:function(){return"/api/member?id="+(this.id?this.id:"")}});$Sq.models.Item=$Sq.models.BaseModel.extend({idAttribute:"item_id",url:function(){return"/api/module/items?item_id="+this.id+"&module="+this.collection._module.id+"&draft="+this.collection._module.isDraft()},toJSON:function(){var j=_.clone(this.attributes);if(j.name===null){j.name=""}if(j.caption===null){j.caption=""}return j}});$Sq.models.Item.getForUrl=function(k,j){if(f.isFunction(j)){j={success:j}}else{if(!j){j={success:function(l){console.log(l)}}}}return $Sq.crawl(k,{success:function(l){var m=new $Sq.models.Item({url:l.url,data:l,name:l.hulla.subject,type:"link"});j.success(m)}})};var e=$Sq.models.BaseCollection.extend({initialize:function(k,j){this.model=$Sq.models.Item;this._module=j.module},url:function(){return"/api/module/items?module="+(this._module.id||"")+"&draft="+this._module.isDraft()},addAndSave:function(j,m){var l=this;var k=[];j.each(function(n){k.push(n.toJSON())});$Sq.wait();$Sq.api("module/items","POST",{module:this._module.id,items:k},_.bind(function(n){f.each(n,function(o,p){l.add(new $Sq.models.Item(p))});$Sq.wait(false);if(_.isFunction(m)){m(l)}},this),function(){$Sq.wait(false);$Sq.notify.error("Oops! We failed to save those goodies. Please try again.")})},replace:function(k,l,o){$Sq.wait();var n=this;var j=n.where({item_id:k})[0];if(!j){j=n.where({item_id:k.toString()})[0]}if(!j){$Sq.wait(false);$Sq.notify.error("Oops! Something went wrong. Please refresh the workshop and try again.");console.error("No item found for item_id ["+k+"]");return}l.set("item_id",k);l.set("caption",j.get("caption"));l.set("sort_order",j.get("sort_order"));var m=l.toJSON();m.module=this._module.id;$Sq.api("module/items","PUT",m,_.bind(function(){j.set(l.attributes);$Sq.wait(false);if(_.isFunction(o)){o(n)}},this),function(){$Sq.wait(false);$Sq.notify.error("Oops! We failed to replace that goodie. Please try again.")})}});var c=$Sq.models.BaseCollection.extend({initialize:function(k,j){this.model=$Sq.models.BaseModel.extend({initialize:function(){this.save=_.debounce(this.save,100)},idAttribute:"bit",url:function(){return"/api/module/bits?bit="+this.get("bit")+"&module="+this.collection._module.id+"&draft="+this.collection._module.isDraft()}});this._module=j.module},destroy:function(k,l){var j=this.get(k);if(j){j.destroy({success:l||function(){}})}},set:function(l,j,m){var k=this.get(l);if(k){k.set(j)}else{j.bit=l;var k=new this.model(j);this.add(k)}},save:function(l,j,m){var k=this.get(l);if(k){k.set(j);k.save({},{success:m||function(){}})}else{j.bit=l;this.create(j,{success:m||function(){}})}},get:function(m,k,j){var l=this.where({bit:m});var m=l.length?l[0]:false;if(m){if(k){return m.has(k)?m.get(k):j}else{return m}}else{return j||false}},url:function(){return"/api/module/bits?module="+(this._module.id||"")+"&draft="+this._module.isDraft()},parse:function(k,j){return _.map(k.result,function(l,m){l.bit=m;return{result:l}})}});var h=$Sq.models.BaseModel.extend({initialize:function(k,j){this._module=j?j.module:new $Sq.models.Module({id:k.lens_module_id||k.id});this.save=_.debounce(this.save,100);this._module.on("change:details",function(n,m,l){n.details=new h(m,{module:n})});this.on("change",function(n,m){n._module.set("details",n.attributes,{silent:true});for(var l in n.changed){n._module.trigger("change:details:"+l,n._module,n.get(l),m)}})},url:function(){return"/api/module?module="+(this._module.id||"")+"&draft="+this._module.isDraft()},parse:function(l,k){console.log(l);var j=l.result.id?l.result:l.result[this._module.id];return j.details||{}},toJSON:function(){var j=_.clone(this.attributes);return{details:j,module:this._module.id}}});$Sq.models.SpamListItemModel=$Sq.models.BaseModel.extend({save:function(j){$Sq.api("lens/"+this.get("result"),"POST",{item_id:this.get("item_id"),msg_id:this.get("msg_id")},function(k){if(f.isFunction(j.success)){j.success(k)}},function(k){$Sq.notify.error(k.message());if(f.isFunction(j.error)){j.error()}});return this},url:function(){return"/api/lens/spam?item_id="+(this.get("item_id")||this.get("id"))},isFromGoodList:function(){var j=this.get("list_type");return j==="good"||j==="good_greenlight"},isFromBadList:function(){return !this.isFromGoodList()}});$Sq.models.Module=$Sq.models.BaseModel.extend({initialize:function(){this.details=new h(this.get("details"),{module:this});this.items=new e(this.get("items"),{module:this});this.bits=new c(this.get("bits"),{module:this});this.save=_.debounce(this.save,1000)},isDraft:function(){return this.get("draft")?1:0},url:function(){return"/api/module?id="+(this.id||"")},publish:function(j){this._publish=true;this._flush=j.flush;var k=!this.get("published");this.save({},{all:true,success:_.bind(function(){var l=this.get("length"),m=this.get("type"),n="";if(l<70){n="less-than-half-tweet"}if(l>=70&&l<140){n="more-than-half-tweet"}if(l===140){n="tweet"}if(l>140){n="more-than-tweet"}$Sq.withTracker(tracker,_.bind(function(){var p=k?"Publish Postcard":"Update Postcard";var o={publish_content_length:n,post_type:m};tracker.push(["track",p,o]);this.trigger("publish",this);if(_.isFunction(j.success)){j.success()}},this))},this),error:j.error})},setOpenGraphImage:function(k,j){$Sq.api("module/og","POST",{id:this.id||"",image_url:k},function(l){if(j&&_.isFunction(j.success)){j.success(l)}},function(){if(j&&_.isFunction(j.error)){j.error()}})},_waitingForSnapshot:false,_onSnapshotCallbacks:{success:[],error:[]},getSnapshot:function(k,j){if(this.get("snapshot")){if(_.isFunction(k)){k(this.get("snapshot"),this);return true}}if(_.isFunction(k)){this._onSnapshotCallbacks.success.push(k)}if(_.isFunction(j)){this._onSnapshotCallbacks.error.push(j)}if(this._waitingForSnapshot){return true}this._waitingForSnapshot=true;$Sq.api("module/snapshot","GET",{id:this.id},_.bind(function(l){this.set("snapshot",l);this._waitingForSnapshot=false;this._onSnapshotCallbacks.error=[];this._onSnapshotCallbacks.success.each(_.bind(function(m){m(l,this)},this))},this),_.bind(function(){this._waitingForSnapshot=false;this._onSnapshotCallbacks.success=[];this._onSnapshotCallbacks.error.each(_.bind(function(l){l(false,this)},this))},this))},toJSON:function(j){j=j||{};var k=_.clone(this.attributes);delete k.items;delete k.bits;if(!this._saveDetails&&!j.details&&!j.all){delete k.details;this._saveDetails=true}if(this._saveItems||j.items||j.all){k.items=this.items.toJSON();this._saveItems=false}else{if(this._saveItemOrder||j.itemOrder){k.items=[];this.items.each(function(l){k.items.push({item_id:l.get("item_id"),sort:l.get("sort")})});this._saveItemOrder=false}}if(this._saveBits||j.bits||j.all){k.bits=this.bits.toJSON();this._saveBits=false}if(this._publish){k.publish=true;this._publish=false}if(this._flush){k.flush=true;this._flush=false}delete k.links;return k},setBackground:function(m,k,j){var l=this.get("background")||{};if(!l.style){l.style="scaled"}if(!l.color){l.color="#fff"}this.set("background",{media:m.get?m.attributes:m,style:k||l.style,color:j||l.color})},save:function(l,m,k){var j,n;this.attributes.markup="";if(_.isObject(l)||l==null){j=l;k=m}else{j={};j[l]=m}k=k?_.clone(k):{};this._saveItems=k.items||k.all;this._saveItemOrder=!this.saveItems&&k.itemOrder;this._saveBits=k.bits||k.all;this._saveDetails=k.details!==false||k.all;this._flush=k.flush;return $Sq.models.BaseModel.prototype.save.apply(this,arguments)}});window.session=new $Sq.models.Member(theMember);f.fn.preference=function(j){return this.each(function(){var m=f(this);var l=m.data("session-pref")||j;if(!l){return}var k=session.get("prefs")[l];if(this.type=="checkbox"){m.prop("checked",parseInt(k));m.click(function(){session.prefs.set(l,this.checked?1:0).save()})}else{m.text(k)}})};f(function(){f("[data-session-pref]").preference()})}(jQuery,Backbone);