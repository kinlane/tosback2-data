KBB.modules.social=(function(){var b,a=gigya.services.socialize;KBB.events.register("Social.OnGetCountsComplete");return{init:function(){b=this;$(".social[id]").each(this.socialBar.init)},gigyaConfig:{moreEnabledProviders:"linkedIn,digg,yahoobookmarks,delicious,tumblr,stumbleupon,orkut",showEmailButton:false},socialBar:(function(){return{init:function(){var k=$(this),m={},c=k.data("social-buttons"),f=k.data("social-icons-only"),n=k.data("social-show-counts"),d=k.data("social-cid"),j=k.data("social-link")||k.attr("href"),o=k.data("social-title")||k.attr("title"),g=k.data("social-media-url")||k.data("social-image")||k.attr("src"),l=k.data("social-media-type"),e=k.data("social-description"),h=k.data("social-lazy-show");if(typeof c!=="undefined"){m.shareButtons=c}if(typeof f!=="undefined"){m.iconsOnly=f}if(typeof n!=="undefined"){m.showCounts=n==true?"right":n}if(typeof j!=="undefined"){m.link=j}if(typeof o!=="undefined"){m.title=o}if(typeof g!=="undefined"){m.image=g}if(typeof l!=="undefined"){m.mediaType=l}if(typeof e!=="undefined"){m.description=e}if(typeof d!=="undefined"){m.cid=$.tmpl(d).text().toLowerCase();m.onSendDone=b.socialBar.createOnSendDoneHandler(m.cid,k);m.onShareButtonClicked=b.socialBar.createOnShareButtonClickedHandler(m.cid,k)}if(!(typeof f!=="undefined"&&f)&&(typeof n==="undefined"||n==="right")){k.addClass("right-count")}if(typeof h!=="undefined"){m.onLoad=function(){(h==true?k:$("#"+h)).show()}}k.social(m)},createOnShareButtonClickedHandler:function(c,d){return function(f){if(f.shareItem&&f.shareItem.provider){PartnerLink(f.shareItem.provider,c,"",d)}}},createOnSendDoneHandler:function(c,d){return function(f){if(f.providers){var g=f.providers.split(",");for(i=0;i<g.length;i++){PartnerLink(g[i],c+"_confirm","",d)}}}}}}()),Providers:{Facebook:"facebook",Twitter:"twitter",Google:"google"},GetCounts:function(c){a.getProviderShareCounts(this.gigyaConfig,{callback:function(d){if(c&&d&&d.errorCode===0&&d.shareCounts){for(var e in d.shareCounts){if(e==c){d=d.shareCounts[e];break}}}KBB.events.fire("Social.OnGetCountsComplete",d)}})},OnGetCountsComplete:function(c){KBB.events.on("Social.OnGetCountsComplete",c)}}}());(function(a){function b(c,d){this.defaults={containerID:c.id,shareButtons:"facebook-like,google-plusone,twitter-tweet,share",iconsOnly:false,showCounts:"right",cid:"",link:"",title:"",image:"",mediaType:"image",description:"",onSendDone:null,onShareButtonClicked:null};this.opts=a.extend({},this.defaults,d);this.$el=a(c);this._gig=gigya.services.socialize;this._isUserActionDefined=this.opts.link||this.opts.title||this.opts.description||this.opts.image;this.opts.userAction=this._isUserActionDefined?new this._gig.UserAction():KBB.social.openGraphUserAction;if(!this.opts.userAction){KBB.log("No UserAction defined for Social plugin, please provide at least a link, title, description and/or image. Or, render a KBB.social.openGraphUserAction using Html.RenderGigyaUserAction().");return}if(this._isUserActionDefined){this.opts.link=this.opts.link||self.location;this.opts.title=this.opts.title||document.title;this.opts.userAction.addActionLink(this.opts.title,this.opts.link);this.opts.userAction.setLinkBack(this.opts.link);this.opts.userAction.setTitle(this.opts.title);if(this.opts.description){this.opts.userAction.setDescription(this.opts.description)}if(this.opts.image){this.opts.userAction.addMediaItem({type:this.opts.mediaType,src:this.opts.image,href:this.opts.link})}}if(this.opts.iconsOnly||this.opts.iconsOnly=="true"){if(typeof d.shareButtons==="undefined"){this.opts.shareButtons="facebook,google-plusone,twitter,share"}if(typeof d.showCounts==="undefined"){this.opts.showCounts="none"}}if(typeof d.showCounts!=="undefined"){this.opts.showCounts=!d.showCounts?"none":d.showCounts}}b.prototype={init:function(){var c=this;if(!c.opts.containerID){KBB.log("Social element needs an id")}c._gig.showShareBarUI(KBB.modules.social.gigyaConfig,c.opts)}};a.fn.social=function(c){if(this.length){this.each(function(){var d=new b(this,c);d.init();a(this).data("social",d)})}}})(jQuery);KBB.modules.myKbb=(function(){var a=Math.round(new Date().getTime()),c=$("#Login-service").val()+"?jsoncallback=?",d=$("#Logout-service").val(),e=$("#Personalizaton-service").val(),j=$("#Set-recently-viewed-service").val(),b=$("#Forgot-password-service").val()+"?jsoncallback=?",k=$("#Create-account-service").val()+"?jsoncallback=?",h=$("#Save-vehicle-service").val(),g=$("#Remove-vehicle-service").val(),f=$("#Signout-redirect-url").val();return{isAuthenticated:isMyKBBUser,currentUser:null,init:function(){e=KBB.helpers.appendUrlParameter(e,"r",a);if(this.isAuthenticated){this.getPersonalizationData()}},isAuthenticationRequired:$("#Requires-auth").val()=="true",signIn:function(r,o,p,l){var m=r||$("#sign-in-email").val(),n=o||$("#sign-in-password").val(),q=$("#sign-in-remember-me").is(":checked");if(typeof p!=="undefined"){q=p}$.postJSON(c,{email:m,password:n,rememberme:q,redirect:false},function(s){if(KBB.modules.myKbb.isAuthenticated!==s.data.success){KBB.events.fire("MyKbb.OnLogin");KBB.modules.myKbb.getPersonalizationData()}if(l&&$.isFunction(l)){l(s.data)}})},signOut:function(l){if(!KBB.modules.myKbb.isAuthenticated){return}$.postJSON(d,null,function(){if(KBB.modules.myKbb.isAuthenticationRequired){self.location.href=f;return}KBB.modules.myKbb.getPersonalizationData();if($.isFunction(l)){l()}})},forgotPassword:function(m,l){$.postJSON(b,{email:m,redirect:false},function(n){if(l&&$.isFunction(l)){l(n.data)}})},getPersonalizationData:function(l){$.ajax({url:e,cache:false,success:function(m){var n=KBB.modules.myKbb.isAuthenticated;KBB.modules.myKbb.currentUser=m.User;KBB.modules.myKbb.isAuthenticated=m.IsAuthenticated;if(n!==m.IsAuthenticated){KBB.events.fire("MyKbb.OnAuthenticationChanged",m)}KBB.events.fire("MyKbb.OnGetPersonalizationDataComplete",m);if($.isFunction(l)){l(m)}}})},signUp:function(l,o,p,m){var n={email:l,password:o,displayname:p,emailoptin:m,redirect:false};$.postJSON(k,n,function(q){if(q.data.success){KBB.modules.myKbb.getPersonalizationData()}KBB.events.fire("MyKbb.OnSignUpComplete",q.data)})},saveVehicles:function(m,l){this.saveVehicle({list:m},l)},saveVehicle:function(p,m){if(!p){return}if(!p.selectionhistory||p.selectionhistory===""){p.selectionhistory="0|0|0|0|0|"}else{var o=p.selectionhistory.split("|");if(o[0]==p.vehicleId){p.selectionhistory="0|0|0|0|0|";for(var n=5;n<o.length;n++){p.selectionhistory+=p.selectionHistory+o[n]+"|"}}p.selectionhistory=p.selectionhistory.substr(p.selectionhistory.length-1)}var l=function(q){if(q&&q.success){KBB.modules.myKbb.getPersonalizationData()}KBB.events.fire("MyKbb.OnSaveVehicleComplete",q);if($.isFunction(m)){m(q)}};$.getJSON(h,p,l)},removeVehicles:function(o,m){if(!o){return}var n=$.isArray(o)?o.join("|"):o;var l=function(p){if(p&&p.success){KBB.modules.myKbb.getPersonalizationData()}KBB.events.fire("MyKbb.OnRemoveVehiclesComplete",p);if($.isFunction(m)){m(p)}};$.postJSON(g,{list:n},l)},saveRecentlyViewed:function(p,n,m,o){var l={vehicleId:p};if(n&&n>0){l.price=n}if(m&&m.length){l.intent=m}$.postJSON(j,l,function(q){if($.isFunction(o)){o(q)}})},onAuthenticationChange:function(l){KBB.events.on("MyKbb.OnAuthenticationChanged",l)},onGetPersonalizationDataComplete:function(l){KBB.events.on("MyKbb.OnGetPersonalizationDataComplete",l)},onSignUpComplete:function(l){KBB.events.on("MyKbb.OnSignUpComplete",l)},onSaveVehicleComplete:function(l){KBB.events.on("MyKbb.OnSaveVehicleComplete",l)},onRemoveVehicleComplete:function(l){KBB.events.on("MyKbb.OnRemoveVehicleComplete",l)}}}());KBB.validation=function(c){var a={parent:[],errorMessageClass:"validation-error",fieldErrorClass:"errortitle",emailValidationService:$("#Email-validator-service").val()},d=$.extend({},a,c),b=$(".{0}".format(d.errorMessageClass),d.parent);if(!d.parent.length){KBB.log("A parent attribute is required for the KBB.validator")}return{ShowError:function(f,e){if(f){b.html(f)}b.show();if(typeof e!=="undefined"&&e.length&&$(e).length){this.AddFieldError(e)}},AddFieldError:function(e){e=$(e);if(e.length){e.siblings("label").addClass(d.fieldErrorClass)}},RemoveFieldError:function(e){e=$(e);if(e.length){e.siblings("label").removeClass(d.fieldErrorClass)}},ClearErrors:function(){var e="label.{0}".format(d.fieldErrorClass);b.html("").hide();$(e,d.parent).removeClass(d.fieldErrorClass)},ValidEmailFormat:function(e){if(!e){return false}var f=/^([A-Za-z0-9_\-\.\+])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return f.test(e)},ValidProfileName:function(e){var f=/(^[a-zA-Z0-9]+)$/;return f.test(e)},EmailExists:function(e){var f=false;$.postJSON(d.emailValidationService,{email:e},function(g){f=g},false);return f},ValidAllInputsArePopulated:function(g,e){var f=this,h=0;d.parent.find(e||"input").each(function(){var j=$(this);if(j.val()===""){f.ShowError(j.attr("title"),j);h++}});if(h>1){if(g!==false){f.ShowError(g||"Please enter all required information")}return false}return true}}};KBB.modules.headerShare=(function(){var a,e=[],b=$("#sign-in-message"),d=true,c=function(f){for(var g=0;g<e.length;g++){if(f(e[g],g)===false){break}}};return{init:function(){a=this;e=[this.userOptionsMenu,this.signInPopUp,this.zipCodePopUp,this.signUpPopUp,this.signUpCompletePopUp];c(this.initPanel);if(!KBB.modules.myKbb.isAuthenticated){this.authenticationChange({IsAuthenticated:false})}KBB.modules.myKbb.onAuthenticationChange(this.authenticationChange);KBB.modules.myKbb.onGetPersonalizationDataComplete(this.getPersonalizationData)},authenticationChange:function(f){if(!f){return}b.html($("#sign-in-message-template").tmpl(f)).show();$("#Header-signin").show()},getPersonalizationData:function(f){if(d&&f.IsAuthenticated){a.authenticationChange(f);d=false}$("#saved-vehicle-count").html("({0})".format(f.SavedVehicleCount))},initPanel:function(g,f){g.init();g.trigger.live("click",function(h){h.stopPropagation();a.showPanel(g)})},showPanel:function(g,f){if(f&&f.stopPropagation){f.stopPropagation()}$(document).unbind("click.headerShare");c(function(j){var h=!j.element.is(":visible");if(j===g){$(document).bind("click.headerShare",function(k){var l=false;c(function(n){$(n.trigger.selector).each(function(o,p){if(k.currentTarget===p){l=true;return false}});if(l){return false}});if(j.element[0]!==k.currentTarget&&!l){var m=false;$(k.target).parents().each(function(o,n){if(n===j.element[0]){m=true;return false}});if(!m){a.hideAll()}}})}j.element.toggle(j===g&&h);if($.isFunction(j.onToggle)){j.onToggle.call(this,f,h)}})},hideAll:function(){a.showPanel()}}}());KBB.modules.headerShare.userOptionsMenu=(function(){var a=KBB.modules.headerShare;return{element:$("#User-menu-options"),trigger:$("#sign-in-name-header"),init:function(){$("#sign-out-option").click(this.signOutClick);$("#saved-vehicles-option").click(this.savedVehiclesClick)},signOutClick:function(b){KBB.modules.myKbb.signOut(function(){a.hideAll()})},savedVehiclesClick:function(b){if(KBB.modules.socialToolbar){KBB.modules.socialToolbar.panels.savedVehicles.Show(b);b.preventDefault()}},Show:function(b){a.showPanel(a.userOptionsMenu,b);window.scrollTo(_this.element.scrollTop,0)}}}());KBB.modules.headerShare.zipCodePopUp=(function(){var a,d=$("#zipcode-input-header"),c=$("#zipcode-update-btn"),b=KBB.modules.headerShare;el=$("#ZipCode-pop");return{element:el,trigger:$("#zip-code-header, #change-zip-option"),init:function(){a=this;c.click(this.updateZip);d.keypress(this.updateZip)},updateZip:function(f){if(f.target==d[0]&&f.keyCode!="13"){return}var h=d.val();if(!(validateZip(h)&&verifyZip(h))){a.validator.ShowError();return}var g=window.location.href.replace(/zipcode=\d+/i,"zipcode="+h);if(window.location.href==g){window.location.reload(true)}else{window.location=g}},onToggle:function(f,g){if(g){d.select()}},validator:KBB.validation({parent:el}),Show:function(f){b.showPanel(a,f);window.scrollTo(a.element.scrollTop,0)}}}());KBB.modules.headerShare.signUpPopUp=(function(){var a,b=KBB.modules.headerShare,c=$("#sign-up-btn-header"),d=$("#Sign-up-pop"),e=function(h){c.toggle(!h);$("#sign-up-loading").toggle(h)},f={mismatchEmail:"The Email Addresses and Confirm Email Address fields must match.",invalidEmail:"Please enter a valid email address.",mismatchPassword:"The Password and Confirm Password fields must match.",invalidPassword:"Passwords must be at least 6 characters in length.",invalidProfileName:"Your Profile Name must be at least 6 characters in length.",termsNotChecked:"You must accept the Terms of Use.",invalidProfileNameSpecial:"Your Profile Name may not contain special characters.",emailExists:"An account for email {0} already exists"},g=$("#Sign-up-pop .terms-of-use-overlay");return{element:d,trigger:$("#sign-up-header"),init:function(){a=this;c.click(this.signUp);KBB.modules.myKbb.onSignUpComplete(this.signUpComplete);$("#termsOfUseLink").click(this.showTermsOfUse)},showTermsOfUse:function(){g.find("iframe").attr("src",$("#Terms-of-use-url").val());g.jqm({modal:true,overlay:70,toTop:true}).css("top",$(document).scrollTop()+170).jqmShow().jqmAddClose($(".close"));return false},signUp:function(h){var j=$("#sign-up-email-header").val(),k=$("#sign-up-email2-header").val(),n=$("#sign-up-password-header").val(),o=$("#sign-up-password2-header").val(),p=$("#sign-up-profile-name-header").val(),q=$("#terms-of-use-header").is(":checked"),l=$("#email-opt-in-header").is(":checked"),r=KBB.modules.headerShare.signUpPopUp.validator,m=false;e(true);r.ClearErrors();if(!r.ValidAllInputsArePopulated()){}else{if(j!==k){r.ShowErrormismatchEmail(f.mismatchEmail,"#sign-up-email-header, #sign-up-email2-header")}else{if(!r.ValidEmailFormat(j)){r.ShowError(f.invalidEmail,"#sign-up-email-header")}else{if(n!=o){r.ShowError(f.mismatchPassword,"#sign-up-password-header, #sign-up-password2-header")}else{if($.trim(n).length<6){r.ShowError(f.invalidPassword,"#sign-up-password-header")}else{if($.trim(p).length<6){r.ShowError(f.invalidProfileName,"#sign-up-profile-name-header")}else{if(!q){r.ShowError(f.termsNotChecked,"#terms-of-use-header")}else{if(!r.ValidProfileName(p)){r.ShowError(f.invalidProfileNameSpecial,"#sign-up-profile-name-header")}else{if(r.EmailExists(j)){r.ShowError(f.emailExists.format(j),"#sign-up-email-header")}else{m=true;KBB.modules.myKbb.signUp(j,n,p,l)}}}}}}}}}if(!m){e(false)}},signUpComplete:function(h){e(false);if(!h.success){a.validator.ShowError(h.errormessage,"#sign-up-{0}".format(h.field))}else{b.showPanel(b.signUpCompletePopUp)}},validator:KBB.validation({parent:d}),Show:function(h){b.showPanel(a,h);window.scrollTo(a.element.scrollTop,0)}}}());KBB.modules.headerShare.signUpCompletePopUp=(function(){return{element:$("#Sign-up-complete-pop"),trigger:$([]),init:function(){}}}());KBB.modules.headerShare.signInPopUp=(function(){var a,b=KBB.modules.headerShare,c=$("#sign-in-popup-header"),d={invalidEmail:"Please enter a valid email address.",emailExists:"The email address you entered is not associated with an account.",forgotPassword:"An email has been sent to {0} with your new password."},e={email:"#sign-in-email-header",pass:"#sign-in-password-header",remember:"#sign-in-remember-me-header"};return{element:c,trigger:$("#sign-in-header, #account-already-header"),init:function(){a=this;$(".sign","#sign-in-form-header").click(this.signIn);$("input","#sign-in-form-header ").keypress(function(f){if(f.keyCode=="13"){a.signIn()}});$("a.forgot-email-btn",this.element).click(this.forgotPassword);$("#forgot-email-header").keypress(function(f){if(f.keyCode=="13"){a.forgotPassword()}});$(".forgot-password-link",this.element).click(a.toggleForgotPassword)},signIn:function(f){var g=$(e.email).val(),j=$(e.pass).val(),k=$(e.remember).is(":checked"),h=a.validate(g);if(!h){return}KBB.modules.myKbb.signIn(g,j,k,a.authenticationComplete)},forgotPassword:function(f){$("#Forgot-password-message").text("");var g=$("#forgot-email-header").val(),h=a.validateForgotPassword(g);if(h){KBB.modules.myKbb.forgotPassword(g,function(j){a.forgotPasswordComplete(j)})}},validate:function(f){var g=0;this.validator.ClearErrors();if(!this.validator.ValidAllInputsArePopulated()){}else{if(!this.validator.ValidEmailFormat(f)){a.validator.ShowError(d.invalidEmail,e.email)}else{if(!this.validator.EmailExists(f)){a.validator.ShowError(d.emailExists,e.email)}else{return true}}}return false},authenticationComplete:function(f){if(f.success){b.hideAll()}else{a.validator.ShowError(f.errormessage,"#sign-in-{0}-header".format(f.field))}},forgotPasswordComplete:function(f){var g=new KBB.validation({parent:$("#Forgot-password")});if(f.success){$("#Forgot-password-message").text(f.errormessage)}else{g.ShowError(f.errormessage,"#Social-popup .forgot-password")}},validateForgotPassword:function(f){var g=new KBB.validation({parent:$("#Forgot-password")});g.ClearErrors();if(!g.ValidEmailFormat(f)){g.ShowError(d.invalidEmail)}else{if(!g.EmailExists(f)){g.ShowError(d.emailExists)}else{return true}}return false},toggleForgotPassword:function(f,g){g=typeof g===typeof true?g:true;$(".sign-in-form",a.element).toggle(!g);$(".forgot-password",a.element).toggle(g)},onToggle:function(f,g){if(g){$(e.email).select().focus()}else{a.toggleForgotPassword(f,false)}},validator:KBB.validation({parent:c}),Show:function(f){b.showPanel(a,f);window.scrollTo(a.element.scrollTop,0)}}}());