window.imgCheckCounter = 0;
window.currentNode = null;

function FormDesigner(opt)
{

	this.settings = {
		"node" : null,
		"buttonContainerClass" : "buttonContainer",
		"activeClass" : "act",
		"masterCheckbox" : null,
		"buttonHideClass" : "btn",
		"tempShowClass" : "show",
		"contentMargin" : 42,
		"checkImageEnabled" : false,
		"imageEnabledClass" : "images_enabled",
		"imageDisabledClass" : "images_disabled",
		"template" : "<div class='button_left'></div>\
					  <div class='button_middle'><span class='link'><!--text--></span></div>\
					  <div class='button_right'></div>",
		"customDropDown" : false,
		"customDropDownClass" : "btndd",
		"dropDownTemplate" : "<div class='dropdown_container'><!--itemtemplate--></div>",
		"dropDownItemTemplate" : "<a class='dropdown_item' href=''><!--text--></a>",
		"commonSelector": "formdesigner_dropdown",
		"customSelectEvent" : "customselect",
		"customOptionFirstClass" : "first",
		"customOptionLastClass" : "last",
		"jsPositioning" : false,
		"customScroll" : false,
		"customScrollContentClass" : "scroll_content",
		"customScrollContainerClass" : "scroll_container",
		"customScrollerClass" : "scroll_bar"
	};

	this.exception = null;
	this.temp = null;
	this.delayedFunc = null;
	this.imageEnabled = true;
	
	this.scrollTop = 0;
	this.scrollHeight = 0;
	this.contentHeight = 0;
	this.containerHeight = 0;
	this.container = null;
	this.scroller = null;

    this.settings = $.extend(this.settings, opt);
    if (this.settings.node != null && this.settings.node != "")
    this.init();

}

FormDesigner.prototype.init=function(){try{var e=this;e.imageEnabled=true;if(this.settings.checkImageEnabled){if($("html").hasClass(this.settings.imageEnabledClass)){e.imageEnabled=true;window.imgCheckCounter=0;this.prepare()}else if($("html").hasClass(this.settings.imageDisabledClass)){e.imageEnabled=false;window.imgCheckCounter=0;this.prepare()}else{if(window.imgCheckCounter<20){if(this.delayedFunc!=null)clearTimeout(this.delayedFunc);this.delayedFunc=setTimeout(function(){e.init()},600);window.imgCheckCounter++}else this.prepare()}}else{this.prepare()}}catch(t){this.exception=t;alert(t)}};FormDesigner.prototype.prepare=function(){try{var e=this;if(e.settings.node!=null&&e.settings.node!=""){if(e.settings.node.is("input[type=checkbox]")&&e.settings.masterCheckbox!=null){e.settings.node.push(e.settings.masterCheckbox);e.settings.masterCheckbox.unbind("click",e.selectInputs).bind("click",{obj:e},e.selectInputs)}e.settings.node.each(function(){var t=$(this);if(t.is("input[type=button]")||t.is("input[type=submit]")||t.is("select")){if(e.settings.checkImageEnabled==true&&e.imageEnabled==true||e.settings.checkImageEnabled==false){if(t.hasClass(e.settings.buttonHideClass)==false){var n=t.attr("class");t.wrap("<div class='"+n+"'></div>");t.removeClass(n);if(t.is("select"))var r=t.find("option:selected").text();else var r=t.val();if(t.hasClass(e.settings.buttonHideClass)==false)t.addClass(e.settings.buttonHideClass);if(t.is("select")){if(e.settings.customDropDown){var i="<a href='javascript:void(0)' class='"+e.settings.buttonContainerClass+"'>"+e.settings.template.replace("<!--text-->",r)+"</a>";t.after(i);e.addCustomDropDown(t)}else{var i="<div class='"+e.settings.buttonContainerClass+"'>"+e.settings.template.replace("<!--text-->",r)+"</div>";t.after(i)}t.unbind("change keyup",e.selectedIndexChange).bind("change keyup",{obj:e},e.selectedIndexChange)}if(t.css("z-index")=="auto"||t.css("z-index")==0)t.css({"z-index":"15000"});t.css({opacity:"0",filter:"alpha(opacity=0)",position:"absolute"});var s=t.parent();if(s.css("display")=="none"||s.parents().css("display")=="none"){var o=new Array;if(s.parents().css("display")=="none"){s.parents().each(function(){if($(this).css("display")=="none"){o.push($(this));$(this).addClass(e.settings.tempShowClass)}})}var u=false;if(s.css("display")=="none"){u=true;t.addClass(e.settings.tempShowClass)}var a=s.width();var f=s.height();for(var l=0;l<o.length;l++){o[l].removeClass(e.settings.tempShowClass)}if(u){t.removeClass(e.settings.tempShowClass)}}else{var a=s.width();var f=s.height()}t.width(a);t.height(f);var c=null;s.children("."+e.settings.buttonContainerClass).find("*").each(function(){if($(this).html()==r)c=$(this)});var h=a-e.settings.contentMargin;e.ellipsis(c,h)}}}else if(t.is("input[type=text]")||t.is("input[type=password]")){if(e.settings.checkImageEnabled==true&&e.imageEnabled==true||e.settings.checkImageEnabled==false){if(t.hasClass(e.settings.buttonHideClass)==false){var n=t.attr("class");t.wrap("<div class='"+n+"'></div>");t.removeClass(n);var i=e.settings.template.replace("<!--text-->","<div id='tempNodePlaceHolder'></div>");if(t.hasClass(e.settings.buttonHideClass)==false)t.addClass(e.settings.buttonHideClass);t.after(i);var p=$("#tempNodePlaceHolder").parent();t.appendTo(p);$("#tempNodePlaceHolder").remove();t.css({border:"0",background:"transparent"})}}}else if(t.is("input[type=checkbox]")||t.is("input[type=radio]")){if(e.settings.checkImageEnabled==true&&e.imageEnabled==true||e.settings.checkImageEnabled==false){if(t.hasClass(e.settings.buttonHideClass)==false){var n=t.attr("class");t.wrap("<div class='"+n+"'></div>");t.removeClass(n);if(t.hasClass(e.settings.buttonHideClass)==false)t.addClass(e.settings.buttonHideClass);var s=t.parent();var a=s.width();var f=s.height();t.width(a);t.height(f);if(t.css("z-index")=="auto"||t.css("z-index")==0)t.css({"z-index":"15000"});t.css({opacity:"0",filter:"alpha(opacity=0)",position:"absolute",margin:"0",padding:"0"});if(t.attr("checked")=="checked"&&t.parent().hasClass(e.settings.activeClass)==false)t.parent().addClass(e.settings.activeClass)}}if(t.is("input[type=checkbox]")&&t.is(e.settings.masterCheckbox)==false)t.unbind("change",e.updateCheckbox).bind("change",{obj:e},e.updateCheckbox);else if(t.is("input[type=radio]")){if(e.settings.checkImageEnabled==true&&e.imageEnabled==true||e.settings.checkImageEnabled==false){t.unbind("click",e.updateRadio).bind("click",{settings:e.settings},e.updateRadio)}}}else if(t.is("a")){if(e.settings.checkImageEnabled==true&&e.imageEnabled==true||e.settings.checkImageEnabled==false){if(t.hasClass(e.settings.buttonHideClass)==false){var r=t.html();var i=e.settings.template.replace("<!--text-->",r);t.html(i);t.addClass(e.settings.buttonHideClass)}}}else{}})}else{if(this.settings.node==null){throw"Element is not provided"}else{throw"Required parameters not found."}}this.exception=null}catch(t){this.exception=t}};FormDesigner.prototype.updateCheckbox=function(e){try{var t=e!==undefined?e.data.obj:this;var n=t.settings;var r=n.node;var i=true;r.each(function(){r=$(this);if(r.attr("checked")=="checked"){if(n.checkImageEnabled==true&&t.imageEnabled==true||n.checkImageEnabled==false){if(r.parent().hasClass(n.activeClass)==false)r.parent().addClass(n.activeClass)}}else{if(n.checkImageEnabled==true&&t.imageEnabled==true||n.checkImageEnabled==false){if(r.parent().hasClass(n.activeClass))r.parent().removeClass(n.activeClass)}if(n.masterCheckbox!=null){if(r.is(n.masterCheckbox)==false)i=false}}});if(n.masterCheckbox!=null){if(i==true){n.masterCheckbox.attr("checked","checked");if(n.checkImageEnabled==true&&t.imageEnabled==true||n.checkImageEnabled==false){if(n.masterCheckbox.parent().hasClass(n.activeClass)==false)n.masterCheckbox.parent().addClass(n.activeClass)}}else{n.masterCheckbox.removeAttr("checked");if(n.checkImageEnabled==true&&t.imageEnabled==true||n.checkImageEnabled==false){if(n.masterCheckbox.parent().hasClass(n.activeClass))n.masterCheckbox.parent().removeClass(n.activeClass)}}}}catch(s){this.exception=s}};FormDesigner.prototype.updateRadio=function(e){try{var t=e.data.settings;var n=$(this).attr("name");var r=$("input[name="+n+"]");r.each(function(){var e=$(this);if(e.attr("checked")=="checked"){if(e.parent().hasClass(t.activeClass)==false)e.parent().addClass(t.activeClass)}else{if(e.parent().hasClass(t.activeClass))e.parent().removeClass(t.activeClass)}})}catch(i){this.exception=i}};FormDesigner.prototype.selectInputs=function(e){try{var t=e!==undefined?e.data.obj:this;var n=t.settings.masterCheckbox;var r=t.settings.node;if(n.attr("checked")=="checked"){r.attr("checked","checked")}else{r.removeAttr("checked")}t.updateCheckbox()}catch(i){this.exception=i}};FormDesigner.prototype.addCustomDropDown=function(e){try{var t=this;if(e==null||e===undefined)throw"addCustomDropDown(node) - required parameter is missing";var n="";var r=0;var i=e.find("option");i.each(function(){var e=$(this).val();var s=t.settings.dropDownItemTemplate.replace("<!--text-->",$(this).text());s=$(s);if(r==0)s.addClass(t.settings.customOptionFirstClass);else if(r==i.length-1)s.addClass(t.settings.customOptionLastClass);if($(this).attr("selected")=="selected")s=s.attr("value",e).addClass(t.settings.activeClass);else s=s.attr("value",e);s=s.wrap("<div>").parent().html();n=n+s;r++});var s=n;n='<div class="'+t.settings.customScrollContentClass+'">'+n+'</div><div class="'+t.settings.customScrollContainerClass+'"><div class="'+t.settings.customScrollerClass+'"></div></div>';n=$(t.settings.dropDownTemplate.replace("<!--itemtemplate-->",n)).addClass(t.settings.commonSelector).css("display","block").unbind("click",t.customSelect).bind("click",{obj:t},t.customSelect);if(t.settings.jsPositioning){var o=parseInt(e.parent().position().top)+e.parent().height();var u=e.parent().position().left}e.siblings().last().after(n);var a=e.siblings().last();var f=a.find("."+t.settings.customScrollContentClass);if(f.height()>a.height()){if(t.settings.customScroll){var l=a.find("."+t.settings.customScrollerClass);var c=a.find("."+t.settings.customScrollContainerClass);c.height(f.parent().height());var h=c.height()-parseInt(l.css("margin-top"))-parseInt(l.css("margin-bottom"));var p=f.height();var d=h/p;l.height(h*d);l.unbind("mousedown").bind("mousedown",{obj:t},t.bindScrollEvents);f.unbind("mousedown").bind("mousedown",{obj:t},t.bindScrollEvents);f.unbind("touchstart",t.bindTouchEvents).bind("touchstart",{obj:t},t.bindTouchEvents);a.unbind("mouseenter").bind("mouseenter",function(){window.currentNode=$(this).find("div").eq(0);$(this).attr("unselectable","on").css("user-select","none").bind("selectstart",false);if(window.addEventListener)window.addEventListener("DOMMouseScroll",t.mouseWheel,false);window.onmousewheel=document.onmousewheel=t.mouseWheel});a.bind("mouseleave",function(){window.currentNode=null;$(document).unbind("DOMMouseScroll",t.mouseWheel);$(window).unbind("DOMMouseScroll",t.mouseWheel);if(window.addEventListener)window.removeEventListener("DOMMouseScroll",t.mouseWheel,false);window.onmousewheel=document.onmousewheel=null})}else{a.remove();n=$(t.settings.dropDownTemplate.replace("<!--itemtemplate-->",s)).addClass(t.settings.commonSelector).css("display","block").unbind("click",t.customSelect).bind("click",{obj:t},t.customSelect);e.siblings().last().after(n);a=e.siblings().last();a.css({"overflow-y":"scroll","overflow-x":"hidden"})}}else{a.remove();n=$(t.settings.dropDownTemplate.replace("<!--itemtemplate-->",s)).addClass(t.settings.commonSelector).css("display","block").unbind("click",t.customSelect).bind("click",{obj:t},t.customSelect);e.siblings().last().after(n);a=e.siblings().last()}if(a.parent().width()>a.width())a.width(a.parent().width());if(t.settings.jsPositioning){a.css({top:o,left:u})}var v=e.next();e.hide();a.hide();v.unbind("click",t.toggleCustomDropDown).bind("click",{obj:t},t.toggleCustomDropDown);$(document).unbind("click",t.hideCustomDropDown).bind("click",{obj:t},t.hideCustomDropDown)}catch(m){this.exception=m;alert(m)}};FormDesigner.prototype.toggleCustomDropDown=function(e){try{var t=e.data.obj;var n=t.settings.dropDownTemplate;var r=$(this);var i=$(n).attr("class");var s=r.parent().find("."+i).eq(0);if(s.css("display")=="none"){$("."+t.settings.commonSelector).hide();s.show();s.children("."+t.settings.activeClass).focus()}else{$("."+t.settings.commonSelector).hide()}}catch(o){this.exception=o;alert(o)}};FormDesigner.prototype.bindScrollEvents=function(e){e.stopPropagation();e.preventDefault();var t=e.data.obj;var n=$(this).parents("."+t.settings.commonSelector);t.container=n.find("."+t.settings.customScrollContentClass);t.scroller=n.find("."+t.settings.customScrollerClass);t.scrollerContainer=n.find("."+t.settings.customScrollContainerClass);t.containerHeight=t.container.parent().height();t.contentHeight=t.container.height();t.scrollerPart=parseInt(e.pageY)-parseInt(t.scroller.offset().top);t.scrollTop=parseInt(t.scrollerContainer.offset().top)+t.scrollerPart;t.scrollHeight=parseInt(t.scrollerContainer.offset().top)+t.scrollerContainer.height()-t.scroller.height()+t.scrollerPart;$(document).bind("mousemove",{obj:t},t.updateScrollPosition);$(document).bind("mouseup",{obj:t},function(e){var t=e.data.obj;e.stopPropagation();e.preventDefault();$(document).unbind("mousemove",t.updateScrollPosition)})};FormDesigner.prototype.bindTouchEvents=function(e){e.preventDefault();var t=e.data.obj;var n=$(this).parents("."+t.settings.commonSelector);t.container=n.find("."+t.settings.customScrollContentClass);t.scroller=n.find("."+t.settings.customScrollerClass);t.scrollerContainer=n.find("."+t.settings.customScrollContainerClass);t.containerHeight=t.container.parent().height();t.contentHeight=t.container.height();t.scrollerPart=parseInt(e.pageY)-parseInt(t.scroller.offset().top);t.scrollTop=parseInt(t.scrollerContainer.offset().top)+t.scrollerPart;t.scrollHeight=parseInt(t.scrollerContainer.offset().top)+t.scrollerContainer.height()-t.scroller.height()+t.scrollerPart;var r=0;var i=0;if(window.addEventListener)window.addEventListener("touchmove",t.updateTouchPosition,false);else window.touchmove=document.touchmove=t.updateTouchPosition;$(document).bind("touchend",{obj:t},function(e){var t=e.data.obj;e.stopPropagation();e.preventDefault();$(document).unbind("mousemove",t.updateTouchPosition)})};FormDesigner.prototype.hideCustomDropDown=function(e){try{var t=e.data.obj;var n=$(e.target);if(n.hasClass(t.settings.buttonHideClass)==false&&n.parents().hasClass(t.settings.buttonContainerClass)==false&&n.parents().hasClass(t.settings.customScrollContainerClass)==false){$("."+t.settings.commonSelector).hide()}}catch(r){this.exception=r}};FormDesigner.prototype.customSelect=function(e){try{e.preventDefault();var t=e.data.obj;var n=$(e.target);var r=n.attr("value");var i=n.index();if(r!==undefined&&r!=null){n.addClass(t.settings.activeClass);n.siblings().removeClass(t.settings.activeClass);var s=$(this).siblings("select."+t.settings.buttonHideClass);var o=$(this).siblings("."+t.settings.buttonContainerClass);var u=n.text();o.attr("value",r);s.get(0).selectedIndex=i;o.html(t.settings.template.replace("<!--text-->",u));var a=o.parent();var f=a.width()-t.settings.contentMargin;var l=null;o.find("*").each(function(){if($(this).html()==u)l=$(this)});t.ellipsis(l,f);s.trigger("change");o.trigger(t.settings.customSelectEvent)}}catch(c){this.exception=c}};FormDesigner.prototype.mouseWheel=function(e){try{if(!e)e=window.event;if(e.wheelDelta){delta=e.wheelDelta/120}else if(e.detail){delta=-e.detail/3}if(e.wheelDelta){delta=e.wheelDelta/120}else if(e.detail){delta=-e.detail/3}if(e.preventDefault)e.preventDefault();e.returnValue=false;e.cancelBubble=true;var t=0-(window.currentNode.height()-window.currentNode.parent().height());var n=parseInt(window.currentNode.css("margin-top"));var r=50;if(delta<0)r=n-r<t?t-n:0-r;else r=n+r>0?0-n:r;var i=n+r;if(0>=i&&t<=i&&r!=0){window.currentNode.css("margin-top",i);var s=window.currentNode.next().children();var o=Math.abs(i/t);var u=s.parent().height()-s.height()-parseInt(s.css("margin-bottom"));s.css("top",u*o)}}catch(a){this.exception=a}};FormDesigner.prototype.selectedIndexChange=function(e){try{var t=e.data.obj;var n=t.settings.template;var r=$(this);var i=r.parent().attr("class");var s=r.find("option:selected").text();r.next().html(n.replace("<!--text-->",s));var o=r.parent();r.width(o.width());r.height(o.height());var u=o.width()-t.settings.contentMargin;var a=null;r.next().find("*").each(function(){if($(this).html()==s)a=$(this)});t.ellipsis(a,u)}catch(f){this.exception=f}};FormDesigner.prototype.ellipsis=function(e,t){try{var n=e.html();var r=e.clone(true,true).show();$("body").append(r);r.html("");var i="";var s=3;n=n.split("");for(var o=0;o<n.length;o++){r.append(n[o]);s=o;if(r.width()>=t)break}if(r.width()>=t)i=r.text().substr(0,s-3)+"...";else i=r.text();r.remove();e.html(i)}catch(u){this.exception=u}};FormDesigner.prototype.updateScrollPosition=function(e){try{var t=e.data.obj;if(e.pageY>=t.scrollTop&&e.pageY<t.scrollHeight){var n=Math.abs((t.scrollTop-e.pageY)/t.containerHeight);t.container.css("margin-top",0-t.contentHeight*n);t.scroller.css("top",e.pageY-t.scrollTop)}}catch(r){this.exception=r}};FormDesigner.prototype.updateTouchPosition=function(e){try{}catch(t){this.exception=t}};FormDesigner.prototype.setNode=function(e){this.settings.node=e};FormDesigner.prototype.getNode=function(){return this.settings.node};FormDesigner.prototype.setMasterCheckbox=function(e){this.settings.masterCheckbox=e};FormDesigner.prototype.getMasterCheckbox=function(){return this.settings.masterCheckbox};FormDesigner.prototype.setButtonContainerClass=function(e){this.settings.buttonContainerClass=e};FormDesigner.prototype.getButtonContainerClass=function(){return this.settings.buttonContainerClass};FormDesigner.prototype.setTemplate=function(e){this.settings.template=e};FormDesigner.prototype.getTemplate=function(){return this.settings.template};FormDesigner.prototype.setButtonHideClass=function(e){this.settings.buttonHideClass=e};FormDesigner.prototype.getButtonHideClass=function(){return this.settings.buttonHideClass};FormDesigner.prototype.setCheckImageEnabled=function(e){this.settings.checkImageEnabled=e};FormDesigner.prototype.getCheckImageEnabled=function(){return this.settings.checkImageEnabled};FormDesigner.prototype.setActiveClass=function(e){this.settings.activeClass=e};FormDesigner.prototype.getActiveClass=function(){return this.settings.activeClass};FormDesigner.prototype.setCustomDropDown=function(e){this.settings.customDropDown=e};FormDesigner.prototype.setCustomDropDownClass=function(e){this.settings.customDropDownClass=e};FormDesigner.prototype.setDropDownTemplate=function(e){this.settings.dropDownTemplate=e};FormDesigner.prototype.setDropDownItemTemplate=function(e){this.settings.dropDownItemTemplate=e};FormDesigner.prototype.setCommonSelector=function(e){this.settings.commonSelector=e};FormDesigner.prototype.setCustomSelectEvent=function(e){this.settings.customSelectEvent=e};FormDesigner.prototype.setCustomOptionFirstClass=function(e){this.settings.customOptionFirstClass=e};FormDesigner.prototype.setCustomOptionLastClass=function(e){this.settings.customOptionLastClass=e};FormDesigner.prototype.setJSPositioning=function(e){this.settings.jsPositioning=e};FormDesigner.prototype.setCustomScroll=function(e){this.settings.customScroll=e};FormDesigner.prototype.setCustomScrollContentClass=function(e){this.settings.customScrollContentClass=e};FormDesigner.prototype.setCustomScrollContainerClass=function(e){this.settings.customScrollContainerClass=e};FormDesigner.prototype.setCustomScrollerClass=function(e){this.settings.customScrollerClass=e}
