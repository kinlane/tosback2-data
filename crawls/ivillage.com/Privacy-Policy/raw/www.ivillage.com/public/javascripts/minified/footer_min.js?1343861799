iVillage.loyalty=(function(window,$){var defaults={loyaltyReady:false,readyForExternalCall:false,stillHaveHope:true,userData:{},isActive:false,verbs:{readArticle:"iv_article_read",readHomePage:"iv_home_page_read",masterShare:"iv_master_share",twitterShare:"iv_share_on_twitter",facebookShare:"iv_share_on_facebook",emailShare:"iv_share_on_email",videoWatch:"iv_watch_videos_ad_roll",submitPoll:"iv_poll",facebookLike:"iv_did_facebook_like",viewSlide:"iv_slide",viewPromoSlide:"iv_slide_promo",commentPost:"iv_chimes_legacy_drupal",assignmentRead:"iv_active_challenge_page"},suppressNotification:true,attemptsMade:0,maxAttempts:60,initInProcess:false},options={},creditsQueue=[],exceptionEmails=["vikesh.mittal@nbcuni.com","vikesh.mittal84@gmail.com","johnish@gmail.com","john.wetsell@nbcuni.com"],getNodeId=function(){var pathName=window.location.pathname;var pathBreakup=pathName.split("/");if(pathBreakup instanceof Array&&pathBreakup.length>2){var nodeString=pathBreakup[pathBreakup.length-1];if(nodeString.indexOf("-")!=-1){var nodeBreakup=nodeString.split("-");if(nodeBreakup instanceof Array&&nodeBreakup.length>2){return parseInt(nodeBreakup[2]);}}}return false;},getPageId=function(){if(typeof iv_pageid!="undefined"){return iv_pageid;}return false;},getVerticalId=function(){if(typeof iVillage.vertical_id!="undefined"){return iVillage.vertical_id;}return false;},getBrandingId=function(){if(typeof iVillage.branding_id!="undefined"){return iVillage.branding_id;}return false;},prepare_meta_data=function(){var nodeId=getNodeId(),pageId=getPageId(),verticalId=getVerticalId(),brandingId=getBrandingId(),loyaltyData={};loyaltyData.unique_id=(nodeId)?nodeId:pageId;if(nodeId){loyaltyData.node_id=nodeId;}if(pageId){loyaltyData.page_id=pageId;}if(verticalId){loyaltyData.vertical_id=verticalId;}if(brandingId){loyaltyData.branding_id=brandingId;}return loyaltyData;},checkPageEligibility=function(){if(typeof iVillage.loyalty_denied!="undefined"&&iVillage.loyalty_denied){log("checkPageEligibility(): This page is not eligible for loyalty program credit.");return false;}return true;},creditPageReadPoints=function(){log("creditPageReadPoints() > Switch on iVillage.controller > "+iVillage.controller);var loyaltyData=prepare_meta_data();log("creditPageReadPoints() > Meta Data to submit is: ",loyaltyData);switch(iVillage.controller){case"Ivillage_Controller":if(typeof s_iv.pageType=="undefined"||(typeof s_iv.pageType!="undefined"&&s_iv.pageType!="errorPage")){homepageRead(loyaltyData);}break;case"Articles_Controller":articleRead(loyaltyData);break;case"Panel_Pages_Controller":if(iv_subsection1=="HP"){homepageRead(loyaltyData);}break;case"Recipes_Controller":recipePrintReward(loyaltyData);break;case"Challenges_Panel_Controller":if(typeof iVillage.isCommunityAssignment!="undefined"&&iVillage.isCommunityAssignment){activeChallengeRead(loyaltyData);}break;default:log("creditPageReadPoints() > This controller is not valid for PageReadPoints ");break;}},checkLoyaltyStatus=function(){if(typeof(iVillage.loyalty_status)!="undefined"&&iVillage.loyalty_status){log("checkLoyaltyStatus() > Loyalty is active.");options.isActive=iVillage.loyalty_status;}else{if(typeof(iVillage.arw_token)!="undefined"&&$.inArray(iVillage.arw_email,exceptionEmails)!=-1){log("checkLoyaltyStatus() > Loyalty is inactive but your email got exception.");options.isActive=true;}else{if(typeof(iVillage.show_other_users_loyalty)!="undefined"&&typeof(iVillage.other_users_email)!="undefined"){options.isActive=true;}else{log("checkLoyaltyStatus() > Loyalty is inactive.");options.isActive=false;}}}return;},initialLoyaltyCall=function(){var is_eligible=checkPageEligibility();if(!is_eligible){options.stillHaveHope=false;log("initialLoyaltyCall() > This page is not eligible for loyalty credit. So no initial call is made.");return false;}log("initialLoyaltyCall() > Making initial call.");if(options.loyaltyReady&&typeof(Badgeville)!="undefined"){if(typeof(iVillage.show_other_users_loyalty)!="undefined"&&typeof(iVillage.other_users_email)!="undefined"){options.userData.email=iVillage.other_users_email.toLowerCase();Badgeville.Settings.user=options.userData;if(options.suppressNotification){Badgeville.Settings.croutonShow=0;Badgeville.Settings.showToast=0;}Badgeville.setUser(options.userData);log("initialLoyaltyCall() > Initial call made for other user.");return true;}else{if(typeof(iVillage.arw_token)!="undefined"&&(typeof(iVillage.arw_loyalty_status)=="undefined"||(typeof(iVillage.arw_loyalty_status)!="undefined"&&iVillage.arw_loyalty_status=="1"))){if(verticalExcluded()){log("initialLoyaltyCall() > Loyalty program is not supposed to run on this vertical.");return false;}options.userData.email=iVillage.arw_email.toLowerCase();options.userData.display_name=iVillage.arw_username;options.userData.first_name=iVillage.arw_fname;options.userData.last_name=iVillage.arw_lname;options.userData.picture_url="http://"+window.location.host+"/photo/get-avatar?person_id="+iVillage.arw_person_id;log("initialLoyaltyCall() > User Data: ",options.userData);Badgeville.Settings.user=options.userData;if(options.suppressNotification){Badgeville.Settings.croutonShow=0;Badgeville.Settings.showToast=0;}Badgeville.setUser(options.userData);log("initialLoyaltyCall() > Initial call made.");return true;}else{if(typeof(iVillage.arw_token)!="undefined"){log("initialLoyaltyCall() > User has been opted out from Loyalty program.");return false;}else{log("initialLoyaltyCall() > User is not logged in.");return false;}}}}else{log("initialLoyaltyCall() > Badgeville is not ready!!");return false;}},articleRead=function(loyaltyData){if(options.isActive&&typeof(Badgeville)!="undefined"){log("articleRead() > Calling loyalty vendor for article page read credit.");loyaltyData.verb=options.verbs.readArticle;creditToVendor(loyaltyData);}},homepageRead=function(loyaltyData){if(options.isActive&&typeof(Badgeville)!="undefined"){log("homepageRead() > Calling loyalty vendor for home page read credit.");loyaltyData.verb=options.verbs.readHomePage;creditToVendor(loyaltyData);}},activeChallengeRead=function(loyaltyData){if(options.isActive&&typeof(Badgeville)!="undefined"){log("activeChallengeRead() > Calling loyalty vendor for challenge's active assignment read credit.");loyaltyData.verb=options.verbs.assignmentRead;creditToVendor(loyaltyData);}},recipePrintReward=function(loyaltyData){log("recipePrintReward() > Checking eligibility for this reward.");var queryString=window.location.search;if(typeof queryString!="undefined"&&queryString.length>0&&queryString.indexOf("mode=print")!=-1){log("recipePrintReward() > Calling loyalty vendor for recipe print credit.");if(options.isActive&&typeof(Badgeville)!="undefined"){loyaltyData.verb="iv_printing_recipe";creditToVendor(loyaltyData);}}},masterShare=function(provider){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("twitterShare() > Calling loyalty vendor for share credit on "+provider);loyaltyData.verb=options.verbs.masterShare;loyaltyData.social_provider=provider;loyaltyData.unique_id=loyaltyData.unique_id+"_"+provider;creditToVendor(loyaltyData);}},submitPoll=function(){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("submitPoll() > Calling loyalty vendor for submit poll credit.");loyaltyData.verb=options.verbs.submitPoll;creditToVendor(loyaltyData);}},videoCredit=function(video_ref_id){log("videoCredit() > About to call loyalty vendor for watching this video credit.");var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("videoCredit() > Calling loyalty vendor for watching video credit.");loyaltyData.verb=options.verbs.videoWatch;if(typeof video_ref_id!="undefined"){creditToVendor($.extend({video_id:video_ref_id},loyaltyData));}else{creditToVendor(loyaltyData);}}},creditSlideViewPoints=function(slideshowId,slideId,isPromoted){var loyaltyData=prepare_meta_data();if(typeof loyaltyData.node_id=="undefined"||loyaltyData.node_id!=slideshowId){log("creditSlideViewPoints() > Node Id doesn't match with slideshow id, so no points.");return;}if(options.isActive&&typeof(Badgeville)!="undefined"){log("creditSlideViewPoints() > Calling loyalty vendor for slide view credit.");loyaltyData.verb=options.verbs.viewSlide;loyaltyData.slide_id=slideId;creditToVendor(loyaltyData);if(typeof isPromoted!="undefined"&&isPromoted){var moreLoyaltyData=prepare_meta_data();moreLoyaltyData.slide_id=slideId;moreLoyaltyData.verb=options.verbs.viewPromoSlide;creditToVendor(moreLoyaltyData);}}},postedComment=function(providers){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){if(typeof providers!="undefined"){loyaltyData.shared_on=providers;}log("postedComment() > Calling loyalty vendor for posting a comment.");loyaltyData.verb=options.verbs.commentPost;creditToVendor(loyaltyData);}},creditToVendor=function(userData){var is_eligible=checkPageEligibility();if(!is_eligible){log("initialLoyaltyCall() > This page is not eligible for loyalty credit. So no initial call is made.");return false;}if(typeof(iVillage.arw_token)=="undefined"){log("creditToVendor() > User is not logged in.");return false;}else{if(typeof(iVillage.arw_loyalty_status)!="undefined"&&iVillage.arw_loyalty_status!="1"){log("creditToVendor() > 2. User has been opted out from Loyalty program.");return false;}else{if(verticalExcluded()){log("initialLoyaltyCall() > Loyalty program is not supposed to run on this vertical.");return false;}}}if(typeof userData!="undefined"){log("Loyalty Data before submit:",userData);var key=userData.unique_id+"_"+userData.verb;if(typeof userData.slide_id!="undefined"){key=key+"_"+userData.slide_id;}pushToQueue(key,userData);}},pushToQueue=function(key,data){creditsQueue[key]=data;log("Current Queue after push is:",$.extend({},creditsQueue));},popFromQueue=function(){for(var key in creditsQueue){var dataToReturn=creditsQueue[key];delete creditsQueue[key];log("Current Queue after pop is:",$.extend({},creditsQueue));
return dataToReturn;}},processCreditQueue=function(){var userData=popFromQueue();Badgeville.credit(userData,function(data){log("Data returned from Badgeville: ",data);if(typeof data.rewards!="undefined"){log("User just got a reward:",data.rewards);Badgeville.trigger("badgeEarned",data.rewards);}});setTimeout(function(){processCreditQueue();},3000);},getUserStats=function(callback){log("getUserStats()");Badgeville.ready(function(){log("getUserStats(): Ready to get user stats");Badgeville.getAPI("user",{email:Badgeville.Settings.user.email},function(user){log("getUserStats(): Got user stats",user);var userStats={total_points:user.points_all,weekly_points:user.points_week};if(typeof(user.leaderboards)!="undefined"&&typeof(user.leaderboards.all.position)!="undefined"){userStats.overall_rank=user.leaderboards.all.position;}callback(userStats);});});},printLastFewRewards=function(container,badges_count,reverse_order){Badgeville.ready(function(){log("printLastFewRewards(): About to make badges call");Badgeville.getAPI("user_badges",{id:Badgeville.Settings.user.id},function(data){$(container).parent().parent().hide().removeClass("hide").show();log("printLastFewRewards(): Badge data ",data);$(container).parent().find(".loading-bar").remove();var displayed=0;var target=Badgeville(container);if(reverse_order){data.rewards.reverse();}Badgeville.$.each(data.rewards,function(){if(this.name==null){return true;}Badgeville.Gears.reward(this).appendTo(target);displayed++;if(displayed==badges_count){return false;}});if(displayed<badges_count){for(var count=displayed;count<badges_count;count++){$("<img src='/public/images/icons/community/profile/badge_placeholder.png' />").appendTo(target);}}});});},printEarnedRewards=function(container,totalContainer,reverse_order){Badgeville.ready(function(){log("printEarnedRewards() > About to make badges call");Badgeville.getAPI("user_badges",{id:Badgeville.Settings.user.id},function(data){log("printEarnedRewards(): Badge data ",data);$(container).parent().find(".loading-bar").remove();var target=Badgeville(container);if(reverse_order){data.rewards.reverse();}log("printEarnedRewards(): total points container is ",totalContainer);$(totalContainer).html("("+data.rewards.length.toString()+")");var badge_count=0;var badge_list=$("<ul class='clearfix'/>");Badgeville.$.each(data.rewards,function(){if(this.name==null){return true;}badge_count++;var badge_item=(badge_count%4==0)?$("<li class='last' />"):$("<li />");var badge_image=$("<img src='"+this.definition.image_url+"' />");var badge_name=$("<div class='badge_name' />").append(this.name);var badge_date_obj=new Date(this.earned);var badge_date=$("<div class='badge_date' />").html((badge_date_obj.getMonth()+1).toString()+"/"+badge_date_obj.getDate().toString()+"/"+badge_date_obj.getFullYear().toString());var just_earned=(badge_count==1)?$("<div class='just-earned' />"):null;badge_item.append(badge_image,badge_name,badge_date,just_earned);badge_list.append(badge_item);});target.append(badge_list);});});},verticalExcluded=function(){return false;},updateActivityWidget=function(){if($(".bv_activitiesFeed").length){log("updateActivityWidget() > Updating User tool tip in activity widget");var origUserTip=Badgeville.Gears.userTip;Badgeville.Gears.userTip=function(data,params){var myOptions=origUserTip.apply(origUserTip,arguments);if(myOptions.is("a")&&myOptions.text()!="Unknown User"){myOptions.removeClass("bv_hastooltip").die("mouseenter mouseleave").unbind("mouseenter mouseleave").unbind("click","userPic").click(function(){window.location.href="/profiles/user/"+myOptions.text();}).attr("href","/profiles/user/"+myOptions.text());}return myOptions;};}},doInitialSetup=function(){if(options.initInProcess){return false;}options.initInProcess=true;log("doInitialSetup() > Doint initial setup.");options.loyaltyReady=true;if(typeof(Badgeville)!="undefined"){if($(".bv_activitiesFeed").length){updateActivityWidget();}log("Badgeville is defined.");Badgeville.ready(function(){log("Badgeville is ready.");var userStatus=initialLoyaltyCall();log("User status is: ",userStatus);if(userStatus){log("init() > Loyalty vendor is ready to accept further calls.");setTimeout(function(){log("calling pageReadCredit");iVillage.loyalty.pageReadCredit();options.readyForExternalCall=true;},1000);}else{if(typeof(iVillage.show_other_users_loyalty)!="undefined"&&typeof(iVillage.other_users_email)!="undefined"){options.readyForExternalCall=true;}else{log("Something happened....to userStatus");}}processCreditQueue();});}else{window.BadgevilleAsynchInit=function(){};}},log=function(str,vars){if(typeof iVillage!="undefined"&&typeof iVillage.showLogs!="undefined"&&iVillage.showLogs){if(window.console&&window.console.log){var date=new Date();var hours=date.getHours().toString();var mins=date.getMinutes().toString();var secs=date.getSeconds().toString();var msecs=date.getMilliseconds().toString();hours=(hours.length===1)?"0"+hours:hours;mins=(mins.length===1)?"0"+mins:mins;secs=(secs.length===1)?"0"+secs:secs;msecs+=(msecs.length===1)?"    ":(msecs.length===2)?" ":"";str=hours+":"+mins+":"+secs+":"+msecs+" > Loyalty > "+str;if(vars){console.log(str,vars);}else{console.log(str);}}}};return{init:function(params){log("init() > Plugin initiated.");options=$.extend(defaults,params);if(!options.loyaltyReady){checkLoyaltyStatus();if(options.isActive){if(typeof(Badgeville)=="undefined"){log("init() > creating BadgevilleAsynchInit which will get called on/by Badgeville JS load.");window.BadgevilleAsynchInit=function(){doInitialSetup();};log("init() > Loading Loyalty API.");var s=document.createElement("script");s.async=true;s.src="http://"+iVillage.loyalty_vendor_domain+"/v2/badgeville-current.js?key="+iVillage.loyalty_public_key+"&domain="+iVillage.loyalty_iv_domain;document.body.appendChild(s);log("init() > Loaded Loyalty API.");}else{}}else{if(typeof(Badgeville)=="undefined"){log("init() > creating BadgevilleAsynchInit which will get called on/by Badgeville JS load.");window.BadgevilleAsynchInit=function(){updateActivityWidget();};log("init() > Loading Loyalty API.");var s=document.createElement("script");s.async=true;s.src="http://"+iVillage.loyalty_vendor_domain+"/v2/badgeville-current.js?key="+iVillage.loyalty_public_key+"&domain="+iVillage.loyalty_iv_domain;document.body.appendChild(s);log("init() > Loaded Loyalty API.");}else{updateActivityWidget();}}}},socialShareCredit:function(provider){if(typeof provider=="undefined"||!provider||provider=="email"){return;}masterShare(provider);},videoViewCredit:function(video_ref_id){log("videoViewCredit() > ");videoCredit(video_ref_id);},submitPollCredit:function(){log("submitPollCredit() >");submitPoll();},pageReadCredit:function(){log("pageReadCredit()");creditPageReadPoints();},slideViewCredit:function(slideshowId,slideId,attemptsCount,isPromoted){if(typeof attemptsCount=="undefined"){attemptsCount=1;}if(typeof isPromoted=="undefined"){isPromoted=false;}log("slideViewCredit() > Attempt: "+attemptsCount);if(typeof slideshowId=="undefined"||typeof slideId=="undefined"){log("slideViewCredit() > slideshowId and slideId can not be undefined.");return;}else{if(slideshowId==slideId){log("slideViewCredit() > slideshowId and slideId can not be same.");return;}}if(!options.stillHaveHope){log("No more hope for Badgeville on this page. Exiting...");return false;}if(!options.readyForExternalCall&&attemptsCount<options.maxAttempts){setTimeout(function(){iVillage.loyalty.slideViewCredit(slideshowId,slideId,attemptsCount+1,isPromoted);},1000);}else{creditSlideViewPoints(slideshowId,slideId,isPromoted);}},updateUserLoyaltyStatus:function(optinSetting){log("public updateUserLoyaltyStatus() > Updating iVillage.arw_loyalty_status to '"+optinSetting+"'");if(typeof(iVillage.arw_token)!="undefined"&&typeof(optinSetting)!="undefined"&&$.inArray(optinSetting,["in","out"])){iVillage.arw_loyalty_status=optinSetting;log("public updateUserLoyaltyStatus() > Updated iVillage.arw_loyalty_status to '"+optinSetting+"'");}},updateUserStats:function(attempts,callback){if(!options.stillHaveHope){log("No more hope for Badgeville on this page. Exiting...");return false;}if(!options.readyForExternalCall&&attempts<options.maxAttempts){log("Attempt #"+attempts+" to update user stats.");setTimeout(function(){iVillage.loyalty.updateUserStats(attempts+1,callback);},1000);}else{if(options.readyForExternalCall){log("updateUserStats()");getUserStats(function(userStats){log("User Stats are: ",userStats);callback(userStats);});}else{log("updateUserStats(): Badgeville is not ready till end.");callback();}}},getLastFewRewards:function(container,badges_count,reverse_order,attempts){if(!options.stillHaveHope){log("No more hope for Badgeville on this page. Exiting...");return false;}if(!options.readyForExternalCall&&attempts<options.maxAttempts){log("Attempt #"+attempts+" to get user badges.");setTimeout(function(){iVillage.loyalty.getLastFewRewards(container,badges_count,reverse_order,attempts+1);},1000);}else{if(options.readyForExternalCall){log("getLastFewRewards()");printLastFewRewards(container,badges_count,reverse_order);}else{log("getLastFewRewards(): Badgeville is not ready till end.");}}},getEarnedRewards:function(container,totalContainer,reverse_order,attempts){if(!options.stillHaveHope){log("No more hope for Badgeville on this page. Exiting...");return false;}if(!options.readyForExternalCall&&attempts<options.maxAttempts){log("Attempt #"+attempts+" to get user badges.");setTimeout(function(){iVillage.loyalty.getEarnedRewards(container,totalContainer,reverse_order,attempts+1);},1000);}else{if(options.readyForExternalCall){log("getEarnedRewards()");printEarnedRewards(container,totalContainer,reverse_order);}else{log("getEarnedRewards(): Badgeville is not ready till end.");$(container).parent().find(".loading-bar").html("<span class='error'>Unable to get the rewards details at this moment. Please check back again.</span>");}}},commentPostCredit:function(providers){log("commentPostCredit() >");postedComment(providers);
}};})(this,jQuery);require.config({baseUrl:"/public/javascripts",waitSeconds:15});require(["ivillage/ui/widget/loyalty/LoyaltyToolbar","jquery/plugin/deferred"],function(){if(typeof iVillage!="undefined"&&typeof iVillage.hide_toolbar!="undefined"&&iVillage.hide_toolbar){return;}$(document).ready(function(){if(document.location.href.match("mode=print")!=null){return;}var toolbarDomNode=$("<div/>").append("<div/>").children().last().addClass("loyalty toolbar nointelliTXT").append("<div/>").children().last().addClass("notifications").append("<a/>").children().last().addClass("close").append("<img/>").children().last().attr("src","/public/images/components/loyalty/close-x.gif").attr("alt","close button").parent().parent().append("<div/>").children().last().addClass("tiles").parent().parent().append("<div/>").children().last().addClass("minimizeToggle").parent().append("<div/>").children().last().addClass("main").append("<div/>").children().last().addClass("default").append("<div/>").children().last().addClass("branding").append("<a/>").children().last().addClass("logo").attr("href","/rewards").append("<img/>").children().last().attr("src","/public/images/components/loyalty/rewards-bar-logo-f.png").attr("alt","iVillage Rewards").parent().parent().append("<div/>").children().last().addClass("sponsor").html('<a class="sponsorLink" href="http://www.facebook.com/Tostitos">Sponsored by Tostitos&reg;</a>').parent().parent().append("<div/>").children().last().addClass("userOverview").parent().parent().append("<div/>").children().last().addClass("userDetail").parent().append("<div/>").children().last().addClass("expanded").append("<div/>").children().last().addClass("sponsors").append("<h3/>").children().last().html("Our Sponsor").parent().append("<div/>").children().last().addClass("tiles").append("<div/>").children().last().addClass("tile").append("<a/>").children().last().attr("href","http://www.facebook.com/Tostitos").addClass("sponsorLogo sponsorLink").append("<img/>").children().last().attr("src","/public/images/components/loyalty/tostitoslogo.png").attr("alt","Sponsors!").parent().parent().parent().parent().parent().append("<div/>").children().last().addClass("everyonesRewards").append("<h3/>").children().last().html("Recently Rewarded iVillagers").parent().append("<ul/>").children().last().addClass("tiles bv_activitiesFeed").parent().append("<div/>").children().last().addClass("cover").parent().parent().parent().parent();var lt=new ivillage.ui.widget.loyalty.LoyaltyToolbar({domNode:toolbarDomNode});lt.init();window.toolbar=lt;$("body").append(lt.get("domNode"));});});