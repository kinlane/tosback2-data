iVillage.loyalty=(function(window,$){var defaults={loyaltyReady:false,readyForExternalCall:false,userData:{},isActive:false,verbs:{readArticle:"iv_article_read",readHomePage:"iv_home_page_read",twitterShare:"iv_share_on_twitter",facebookShare:"iv_share_on_facebook",emailShare:"iv_share_on_email",videoWatch:"iv_watch_videos_ad_roll",submitPoll:"iv_poll",facebookLike:"iv_did_facebook_like",viewSlide:"iv_slide"},suppressNotification:true,attemptsMade:0},options={},exceptionEmails=["vikesh.mittal@nbcuni.com","vikesh.mittal84@gmail.com","johnish@gmail.com","john.wetsell@nbcuni.com","akash.jha@nbcuni.com","manjeera@gmail.com"],getNodeId=function(){var pathName=window.location.pathname;var pathBreakup=pathName.split("/");if(pathBreakup instanceof Array&&pathBreakup.length>2){var nodeString=pathBreakup[pathBreakup.length-1];if(nodeString.indexOf("-")!=-1){var nodeBreakup=nodeString.split("-");if(nodeBreakup instanceof Array&&nodeBreakup.length>2){return parseInt(nodeBreakup[2]);}}}return false;},getPageId=function(){if(typeof iv_pageid!="undefined"){return iv_pageid;}return false;},getVerticalId=function(){if(typeof iVillage.vertical_id!="undefined"){return iVillage.vertical_id;}return false;},prepare_meta_data=function(){var nodeId=getNodeId(),pageId=getPageId(),verticalId=getVerticalId(),loyaltyData={};loyaltyData.unique_id=(nodeId)?nodeId:pageId;if(nodeId){loyaltyData.node_id=nodeId;}if(pageId){loyaltyData.page_id=pageId;}if(verticalId){loyaltyData.vertical_id=verticalId;}return loyaltyData;},creditPageReadPoints=function(){log("creditPageReadPoints() > Switch on iVillage.controller > "+iVillage.controller);var loyaltyData=prepare_meta_data();switch(iVillage.controller){case"Ivillage_Controller":if(typeof s_iv.pageType=="undefined"||(typeof s_iv.pageType!="undefined"&&s_iv.pageType!="errorPage")){homepageRead(loyaltyData);}break;case"Articles_Controller":articleRead(loyaltyData);break;case"Panel_Pages_Controller":if(iv_subsection1=="HP"){homepageRead(loyaltyData);}break;case"Recipes_Controller":recipePrintReward(loyaltyData);break;default:break;}},checkLoyaltyStatus=function(){if(typeof(iVillage.loyalty_status)!="undefined"&&iVillage.loyalty_status){log("checkLoyaltyStatus() > Loyalty is active.");options.isActive=iVillage.loyalty_status;}else{if(typeof(iVillage.arw_token)!="undefined"&&$.inArray(iVillage.arw_email,exceptionEmails)!=-1){log("checkLoyaltyStatus() > Loyalty is inactive but your email got exception.");options.isActive=true;}else{log("checkLoyaltyStatus() > Loyalty is inactive.");options.isActive=false;}}return;},initialLoyaltyCall=function(){log("initialLoyaltyCall() > Making initial call.");if(options.loyaltyReady&&typeof(Badgeville)!="undefined"&&typeof(iVillage.arw_token)!="undefined"){if(typeof(iVillage.arw_loyalty_status)=="undefined"||(typeof(iVillage.arw_loyalty_status)!="undefined"&&iVillage.arw_loyalty_status=="in")){options.userData.email=iVillage.arw_email.toLowerCase();options.userData.display_name=iVillage.arw_username;options.userData.first_name=iVillage.arw_fname;options.userData.last_name=iVillage.arw_lname;options.userData.picture_url="http://"+window.location.host+"/photo/get-avatar?person_id="+iVillage.arw_person_id;log("initialLoyaltyCall() > User Data: ",options.userData);Badgeville.Settings.user=options.userData;if(options.suppressNotification){Badgeville.Settings.croutonShow=0;Badgeville.Settings.showToast=0;}Badgeville.setUser(options.userData);log("initialLoyaltyCall() > Initial call made.");return true;}else{log("initialLoyaltyCall() > 1. User has been opted out from Loyalty program.");return false;}}else{log("initialLoyaltyCall() > User is not login.");return false;}},articleRead=function(loyaltyData){if(options.isActive&&typeof(Badgeville)!="undefined"){log("articleRead() > Calling loyalty vendor for article page read credit.");loyaltyData.verb=options.verbs.readArticle;creditToVendor(loyaltyData);}},homepageRead=function(loyaltyData){if(options.isActive&&typeof(Badgeville)!="undefined"){log("homepageRead() > Calling loyalty vendor for home page read credit.");loyaltyData.verb=options.verbs.readHomePage;creditToVendor(loyaltyData);}},recipePrintReward=function(loyaltyData){log("recipePrintReward() > Checking eligibility for this reward.");var queryString=window.location.search;if(typeof queryString!="undefined"&&queryString.length>0&&queryString.indexOf("mode=print")!=-1){log("recipePrintReward() > Calling loyalty vendor for recipe print credit.");if(options.isActive&&typeof(Badgeville)!="undefined"){loyaltyData.verb="iv_printing_recipe";creditToVendor(loyaltyData);}}},twitterShare=function(){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("twitterShare() > Calling loyalty vendor for twitter share credit.");loyaltyData.verb=options.verbs.twitterShare;creditToVendor(loyaltyData);}},fbShare=function(){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("fbShare() > Calling loyalty vendor for facebook share credit.");loyaltyData.verb=options.verbs.facebookShare;creditToVendor(loyaltyData);}},fbLike=function(){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("fbShare() > Calling loyalty vendor for facebook share credit.");loyaltyData.verb=options.verbs.facebookLike;creditToVendor(loyaltyData);}},emailShare=function(){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("emailShare() > Calling loyalty vendor for email share credit.");loyaltyData.verb=options.verbs.emailShare;creditToVendor(loyaltyData);}},submitPoll=function(){var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("submitPoll() > Calling loyalty vendor for submit poll credit.");loyaltyData.verb=options.verbs.submitPoll;creditToVendor(loyaltyData);}},videoCredit=function(video_id){log("videoCredit() > About to call loyalty vendor for watching video "+video_id+" credit.");var loyaltyData=prepare_meta_data();if(options.isActive&&typeof(Badgeville)!="undefined"){log("videoCredit() > Calling loyalty vendor for watching video credit.");loyaltyData.verb=options.verbs.videoWatch;creditToVendor($.extend({video_id:video_id},loyaltyData));}},creditSlideViewPoints=function(slideshowId,slideId){var loyaltyData=prepare_meta_data();if(typeof loyaltyData.node_id=="undefined"||loyaltyData.node_id!=slideshowId){log("creditSlideViewPoints() > Node Id doesn't match with slideshow id, so no points.");return;}if(options.isActive&&typeof(Badgeville)!="undefined"){log("creditSlideViewPoints() > Calling loyalty vendor for slide view credit.");loyaltyData.verb=options.verbs.viewSlide;loyaltyData.slide_id=slideId;creditToVendor(loyaltyData);}},creditToVendor=function(userData){if(typeof(iVillage.arw_token)=="undefined"){log("creditToVendor() > User is not logged in.");return false;}else{if(typeof(iVillage.arw_loyalty_status)!="undefined"&&iVillage.arw_loyalty_status!="in"){log("creditToVendor() > 2. User has been opted out from Loyalty program.");return false;}}if(typeof userData!="undefined"){log("Loyalty Data before submit:",userData);Badgeville.credit(userData,function(data){log("Data returned from Badgeville: ",data);});}},log=function(str,vars){if(typeof iVillage!="undefined"&&typeof iVillage.showLogs!="undefined"&&iVillage.showLogs){if(window.console&&window.console.log){var date=new Date();var hours=date.getHours().toString();var mins=date.getMinutes().toString();var secs=date.getSeconds().toString();var msecs=date.getMilliseconds().toString();hours=(hours.length===1)?"0"+hours:hours;mins=(mins.length===1)?"0"+mins:mins;secs=(secs.length===1)?"0"+secs:secs;msecs+=(msecs.length===1)?"    ":(msecs.length===2)?" ":"";str=hours+":"+mins+":"+secs+":"+msecs+" > Loyalty > "+str;if(vars){console.log(str,vars);}else{console.log(str);}}}};return{init:function(params){log("init() > Plugin initiated.");options=$.extend(defaults,params);if(!options.loyaltyReady){checkLoyaltyStatus();if(options.isActive){log("init() > Loading Loyalty API.");$.getScript("http://"+iVillage.loyalty_vendor_domain+"/v2/badgeville-current.js?key="+iVillage.loyalty_public_key+"&domain="+iVillage.loyalty_iv_domain,function(){log("init() > Loaded Loyalty API.");options.loyaltyReady=true;if(typeof(Badgeville)!="undefined"){Badgeville.ready(function(){var userStatus=initialLoyaltyCall();if(userStatus){log("init() > Loyalty vendor is ready to accept further calls.");setTimeout(function(){log("calling pageReadCredit");iVillage.loyalty.pageReadCredit();options.readyForExternalCall=true;},1000);}});}else{log("Something happened....");}});}}},socialShareCredit:function(provider){if(typeof provider=="undefined"||!provider){return;}switch(provider){case"facebook":fbShare();break;case"twitter":twitterShare();break;case"email":emailShare();break;case"facebook-like":fbLike();break;}},videoViewCredit:function(video_id){log("videoViewCredit() > Checking video eligibility for video: "+video_id);var videoPlaylist="";if(data_for_playlist[video_id]=="undefined"){log("videoViewCredit() > Video with ID "+video_id+"not found on page");return false;}else{log("videoViewCredit() > Congrats! You are eligible to get points for watching video: "+video_id);videoCredit(video_id);}},submitPollCredit:function(){log("submitPollCredit() >");submitPoll();},pageReadCredit:function(){log("pageReadCredit()");creditPageReadPoints();},slideViewCredit:function(slideshowId,slideId){log("slideViewCredit() > Attempt: "+(options.attemptsMade+1));if(typeof slideshowId=="undefined"||typeof slideId=="undefined"){log("slideViewCredit() > slideshowId and slideId can not be undefined.");return;}else{if(slideshowId==slideId){log("slideViewCredit() > slideshowId and slideId can not be same.");return;}}if(!options.readyForExternalCall&&options.attemptsMade<19){options.attemptsMade++;setTimeout(function(){iVillage.loyalty.slideViewCredit(slideshowId,slideId);},1000);}else{creditSlideViewPoints(slideshowId,slideId);}},updateUserLoyaltyStatus:function(optinSetting){log("public updateUserLoyaltyStatus() > Updating iVillage.arw_loyalty_status to '"+optinSetting+"'");if(typeof(iVillage.arw_token)!="undefined"&&typeof(optinSetting)!="undefined"&&$.inArray(optinSetting,["in","out"])){iVillage.arw_loyalty_status=optinSetting;log("public updateUserLoyaltyStatus() > Updated iVillage.arw_loyalty_status to '"+optinSetting+"'");}}};})(this,jQuery);