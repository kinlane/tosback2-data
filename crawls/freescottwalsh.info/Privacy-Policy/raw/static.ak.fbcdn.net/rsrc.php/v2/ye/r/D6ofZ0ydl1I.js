/*1348584663,178142531*/

if (window.CavalryLogger) { CavalryLogger.start_js(["Ls2In"]); }

__d("FullScreen",["event-extensions","Arbiter","CSS","UserAgent","copyProperties","throttle"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('CSS'),i=b('UserAgent'),j=b('copyProperties'),k=b('throttle'),l=j(new g(),{listenForEvent:function(m){var n=k(this.onChange,0,this);Event.listen(m,{webkitfullscreenchange:n,mozfullscreenchange:n,fullscreenchange:n});Event.listen(document,{webkitfullscreenchange:n,mozfullscreenchange:n,fullscreenchange:n});},enableFullScreen:function(m){this.listenForEvent(m);if(m.webkitRequestFullScreen){if(i.chrome()){m.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);}else m.webkitRequestFullScreen();}else if(m.mozRequestFullScreen){m.mozRequestFullScreen();}else if(m.requestFullScreen){m.requestFullScreen();}else return false;return true;},disableFullScreen:function(){if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.exitFullScreen){document.exitFullScreen();}else return false;return true;},isFullScreen:function(){return (document.webkitIsFullScreen||document.fullScreen||document.mozFullScreen);},toggleFullScreen:function(m){if(this.isFullScreen()){this.disableFullScreen();return false;}else return this.enableFullScreen(m);return false;},onChange:function(){var m=this.isFullScreen();h.conditionClass(document.body,'fullScreen',m);this.inform('changed');},isSupported:function(){return (document.webkitCancelFullScreen&&i.chrome())||document.mozCancelFullScreen||document.cancelFullScreen||document.exitFullScreen;}});e.exports=l;});
__d("ImageUtils",["UserAgent"],function(a,b,c,d,e,f){var g=b('UserAgent'),h={hasLoaded:function(i){if(i.naturalWidth!==undefined){return i.complete&&i.width!==0;}else if(i.height==20&&i.width==20&&i.complete){return false;}else if(i.complete===undefined&&g.safari()<500){var j=new Image();j.src=i.src;return j.complete;}return i.complete;}};e.exports=h;});
__d("PhotoEverstoreLogger",["event-extensions","AsyncRequest","copyProperties","ImageUtils"],function(a,b,c,d,e,f){b('event-extensions');var g=b('AsyncRequest'),h=b('copyProperties'),i=b('ImageUtils'),j={BATCH_WINDOW_MS:500,storedLog:[]};function k(){}h(k,{_log:function(m){j.storedLog.push(m);if(j.storedLog.length==1)setTimeout(l,j.BATCH_WINDOW_MS,false);},logImmediately:function(m){k._log(m);},registerForLogging:function(m){if(i.hasLoaded(m)){k._log(m.src);}else Event.listen(m,'load',function(event){k._log(m.src);});}});function l(){var m=j.storedLog;j.storedLog=[];var n=JSON.stringify(m);new g().setURI('/ajax/photos/logging/everstore_logging.php').setData({loggedUrls:n}).setMethod('POST').setOption('suppressErrorHandlerWarning',true).setOption('suppressErrorAlerts',true).send();}e.exports=k;});
__d("PhotoSessionLog",["AsyncRequest","Run","Vector","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('Run'),i=b('Vector'),j=b('copyProperties');function k(){}j(k,{UNKNOWN:0,ESC:1,X:2,OUTSIDE:3,UNLOAD:4,NAVIGATE:5,AGGREGATE:6,LEAVE:7,PERMALINK:0,SNOWLIFT:6,AGGREGATION_COUNT:20,set:null,time:null,views:0,fbidList:[],details:{},width:0,height:0,first:false,last:false,logIds:false,version:null,buttonLikes:0,pagingAction:'',faceTagImpressions:0,cycle:false,endOfRelevant:false,relevantCount:0,initLogging:function(l){this.set=null;this.time=new Date();this.views=0;this.hiResLoads=0;this.fullScreenViews={};this.first=true;this.last=false;this.logIds=false;this.version=l;this.buttonLikes=0;this.pagingAction='';this.faceTagImpressions=0;this.cycle=false;this.endOfRelevant=false;this.relevantCount=0;if(l===k.SNOWLIFT){var m=i.getViewportDimensions();this.width=m.x;this.height=m.y;}},setLogFbids:function(l){this.logIds=l;},setPhotoSet:function(l){this.set=l;},addButtonLike:function(){this.buttonLikes++;},setPagingAction:function(l){this.pagingAction=l;},addFaceTagImpression:function(){this.faceTagImpressions++;},setCycle:function(l){this.cycle=l;},setEndOfRelevant:function(l){this.endOfRelevant=l;},setRelevantCount:function(l){this.relevantCount=l;},setEndMetrics:function(l){this.endMetrics=l;},addPhotoView:function(l,m,n){if(this.logIds&&this.views>=this.AGGREGATION_COUNT)this.logPhotoViews(this.AGGREGATE);this.views++;if(l)this.fbidList.push([l.fbid,l.owner,Date.now()]);if(m)this.hiResLoads++;if(n)this.fullScreenViews[l.fbid]=true;},logEnterFullScreen:function(l){this.fullScreenViews[l]=true;},addDetailData:function(l,m){if(!this.details[l])this.details[l]={t:m.num_tags,l:m.has_location,c:m.has_caption,cm:m.comment_count,lk:m.like_count,w:m.width,h:m.height,ad:'{}',p:this.pagingAction};},updateAdData:function(l,m){if(this.details[l])this.details[l].ad=JSON.stringify(m);},logPhotoViews:function(l){if((!this.views)||(this.version===k.SNOWLIFT&&l==k.LEAVE))return;if(l!=this.AGGREGATE)this.last=true;var m={set:this.set,time:new Date()-this.time,fbids:this.logIds?this.fbidList:[],details:this.logIds?this.details:{},first:this.first,last:this.last,close:l?l:this.UNKNOWN,button_likes:this.buttonLikes,version:this.version,face_imp:this.faceTagImpressions,endmetric:this.endMetrics,cycle:this.cycle,end_relev:this.endOfRelevant,relev_count:this.relevantCount};if(this.version===k.SNOWLIFT){var n=i.getViewportDimensions();m.width=n.x||this.width;m.height=n.y||this.height;if(this.hiResLoads>0)m.hires_loads=this.hiResLoads;if(this.last){var o=Object.keys(this.fullScreenViews).length;if(o>0)m.fullscreen=o;}}new g().setURI('/ajax/photos/logging/session_logging.php').setAllowCrossPageTransition(true).setOption('asynchronous',(l!=k.UNLOAD)).setOption('suppressErrorHandlerWarning',true).setData(m).send();this.views=0;this.hiResLoads=0;this.fbidList=[];this.details={};this.first=false;this.buttonLikes=0;if(this.last){this.set=null;this.logIds=false;this.fullScreenViews={};}}});h.onUnload(function(){k.logPhotoViews(k.UNLOAD);});h.onLeave(function(){k.logPhotoViews(k.LEAVE);});e.exports=k;});
__d("PhotosConst",[],function(a,b,c,d,e,f){var g={VIEWER_PERMALINK:0,VIEWER_SNOWLIFT:6,VIEWER_VAULTBOX:8,BULK_EDITOR:3,FLASH_UPLOADER:4,HTML5_UPLOADER:10,SIZE_NORMAL:'n',PIC_NORMAL_FBX_SIZE:180};e.exports=g;});
__d("PhotosUtils",["copyProperties","Rect","Vector"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('Rect'),i=b('Vector');function j(){}g(j,{getNearestBox:function(k,l){var m=Infinity,n=null;for(var o in k){var p=k[o];if(p.contains(l)){var q=l.distanceTo(p.getCenter());if(q<m){m=q;n=o;}}}return n;},absoluteToNormalizedPosition:function(k,l){var m=i.getElementPosition(k),n=i.getElementDimensions(k),o=l.sub(m).mul(100/n.x,100/n.y);o.domain='pure';return o;},normalizedToAbsolutePosition:function(k,l){var m=i.getElementPosition(k),n=i.getElementDimensions(k),o=l.mul(n.x/100,n.y/100).add(m);o.domain='document';return o;},isFacebox:function(k){return k.match(/^face:/);}});e.exports=j;});
__d("PhotoStreamCache",["array-extensions","HTML","PhotosConst","PhotoEverstoreLogger","Rect","UIPagelet","URI","Vector","copyProperties","createArrayFrom"],function(a,b,c,d,e,f){b('array-extensions');var g=b('HTML'),h=b('PhotosConst'),i=b('PhotoEverstoreLogger'),j=b('Rect'),k=b('UIPagelet'),l=b('URI'),m=b('Vector'),n=b('copyProperties'),o=b('createArrayFrom');function p(){}n(p,{ERROR:'error',HTML:'html',IMAGE_DATA:'image',EXTRA:'extra',BUFFER_SIZE:3,INIT_BUCKET_SIZE:4,FULL_BUCKET_SIZE:12,ERROR_ID:-1,INIT_PLACEHOLDER:1});n(p.prototype,{init:function(q,r){this.version=q;this.pageletName=r;this.bufferSize=p.BUFFER_SIZE;this.fullBucketSize=p.FULL_BUCKET_SIZE;this.initError=false;this.isActive=true;this.leftLock=false;this.rightLock=false;this.reset();},reset:function(){this.cache={image:{},extra:{},html:{}};this.fbidList=[];this.loaded=false;this.allLoaded=false;this.permalinkMap={};this.position=0;this.totalCount=null;this.firstCursor=null;this.firstCursorIndex=null;},waitForInitData:function(){this.fbidList.push(p.INIT_PLACEHOLDER);},destroy:function(){this.reset();this.isActive=false;},isLoaded:function(){return this.loaded;},canPage:function(){if(!this.isLoaded())return false;if(this.totalCount!==null)return this.totalCount>1;return this.getLength()>1;},errorInCurrent:function(){if(this.initError){return true;}else if(!this.isLoaded())return false;return this.checkErrorAt(this.getCursor());},getLength:function(){return this.fbidList.length;},getPhotoSet:function(){return this.photoSetQuery.set;},getPhotoSetQuery:function(){return this.photoSetQuery;},getCurrentImageData:function(){return this.getImageData(this.getCursor());},getImageData:function(q){return this.getCacheContent(q,p.IMAGE_DATA);},getCurrentHtml:function(){return this.getCacheContent(this.getCursor(),p.HTML);},getCurrentExtraData:function(){return this.getCacheContent(this.getCursor(),p.EXTRA);},getCacheContent:function(q,r){if(!q||q===p.ERROR_ID||q===p.INIT_PLACEHOLDER)return null;return this.cache[r][q];},getCursorPos:function(){return this.position;},getCursor:function(){if(this.position>=0&&this.position<this.getLength())return this.fbidList[this.position];return null;},getCursorForURI:function(q){return this.permalinkMap[q];},calculatePositionForMovement:function(q){var r=this.position+q;if(this.allLoaded){var s=this.getLength();r=(s+r%s)%s;}return r;},isValidMovement:function(q){if(!this.isLoaded()||!this.canPage())return false;var r=this.calculatePositionForMovement(q);return this.getCursor()>0||(r>=0&&r<this.getLength());},moveCursor:function(q){if(!this.isValidMovement(q))return;this.position=this.calculatePositionForMovement(q);if(q!==0)this.loadMoreIfNeccessary(q>0);},checkErrorAt:function(q){if(!this.isLoaded())return false;if(q===p.ERROR_ID)return true;return false;},getRelativeMovement:function(q){for(var r=0;r<this.getLength();r++)if(this.fbidList[r]==q)return r-this.position;return null;},preloadImages:function(q){var r,s,t=this.getLength(),u=this.cache.image,v=p.BUFFER_SIZE;if(t>v*2){r=(this.position+t-v%t)%t;s=(this.position+v)%t;}else{r=0;s=t-1;}while(r!=s){var w=this.fbidList[r];if(u[w]&&u[w].url)if(q&&!u[w].resource){u[w].resource=new Image();u[w].resource.src=u[w].url;if(u[w].everstoreLogThis===true)i.logImmediately(u[w].resource.src);}else if(!q&&!u[w].small){u[w].small=new Image();u[w].small.src=u[w].smallurl||u[w].url;if(u[w].everstoreLogThis===true)i.logImmediately(u[w].small.src);}r=(r+1)%t;}},loadMoreIfNeccessary:function(q){if(this.allLoaded||(q&&this.rightLock)||(!q&&this.leftLock))return;var r=q?1:-1,s=this.position+this.bufferSize*r;if(s<0&&!this.checkErrorAt(this.getEndCursor(false))){this.leftLock=true;this.fetch(this.fullBucketSize,false);}else if(s>this.getLength()&&!this.checkErrorAt(this.getEndCursor(true))){this.rightLock=true;this.fetch(this.fullBucketSize,true);}},getEndCursor:function(q){return q?this.fbidList[this.getLength()-1]:this.fbidList[0];},calculateRelativeIndex:function(q,r,s){if(!this.totalCount)return null;var t=this.fbidList.indexOf(r),u=this.fbidList.indexOf(s);if(t===-1||u===-1)return null;var v=u-t;return (q+v+this.totalCount)%this.totalCount;},calculateDistance:function(q,r){var s=this.fbidList.indexOf(q),t=this.fbidList.indexOf(r);if(s===-1||t===-1)return null;return (t-s+this.getLength())%this.getLength();},fetch:function(q,r){var s=this.getEndCursor(r),t=n({cursor:s,version:this.version,end:this.getEndCursor(!r),fetchSize:r?q:-1*q,relevant_count:this.relevantCount},this.photoSetQuery);if(this.totalCount&&this.firstCursorIndex!==null){t.total=this.totalCount;t.cursorIndex=this.calculateRelativeIndex(this.firstCursorIndex,this.firstCursor,s);}k.loadFromEndpoint(this.pageletName,null,t,{usePipe:true,jsNonblock:true,crossPage:true});},storeToCache:function(q){var r={};if(!this.isActive)return r;if('error' in q){this.processErrorResult(q.error);r.error=true;return r;}if('init' in q){this.processInitResult(q.init);r.init={logids:q.init.logids,fbid:q.init.fbid,loggedin:q.init.loggedin,fromad:q.init.fromad};}if('image' in q){this.processImageResult(q.image);r.image=true;}if('data' in q){this.processDataResult(q.data);r.data=true;}return r;},processInitResult:function(q){if(this.loaded)return;this.loaded=true;this.photoSetQuery=q.query;if(q.bufferSize)this.bufferSize=q.bufferSize;if(q.fullBucketSize)this.fullBucketSize=q.fullBucketSize;if(this.fbidList.length===0){this.fbidList.push(q.fbid);this.rightLock=true;}else{var r=this.fbidList.indexOf(p.INIT_PLACEHOLDER);if(r!=-1)this.fbidList[r]=q.fbid;}this.firstCursor=q.fbid;if('initIndex' in q&&'totalCount' in q){this.firstCursorIndex=q.initIndex;this.totalCount=q.totalCount;}if(this.version==h.VIEWER_PERMALINK)this.fetch(p.INIT_BUCKET_SIZE,true);},processImageResult:function(q){for(var r in q){if(r===this.firstCursor&&q[r].everstoreLogThis)i.logImmediately(q[r].url);this.cache.image[r]=q[r];if(q[r].dimensions)this.cache.image[r].dimensions=m.deserialize(q[r].dimensions);if(q[r].smalldims)this.cache.image[r].smalldims=m.deserialize(q[r].smalldims);this.permalinkMap[l(q[r].info.permalink).getUnqualifiedURI().toString()]=r;}},attachToFbidsList:function(q,r,s){if(this.allLoaded)return;if(r===-1){for(var t=q.length-1;t>=0;t--){this.fbidList.unshift(q[t]);this.position++;}this.leftLock=false;}else{for(var u=0;u<q.length;u++)this.fbidList.push(q[u]);this.rightLock=false;}if(s)this.setAllLoaded();},setAllLoaded:function(){this.allLoaded=true;if(this.getCursor()===null)this.position=this.calculatePositionForMovement(0);},processDataResult:function(q){for(var r in q){if(!this.cache.html[r])this.cache.html[r]={};for(var s in q[r].html){var t=q[r].html[s];if(typeof t==='string')t=g(t).getRootNode();this.cache.html[r][s]=o(t.childNodes);}if(!('extra' in q[r])){this.cache.extra[r]=null;continue;}this.cache.extra[r]={tagRects:{}};if(!Array.isArray(q[r].extra.tagRects))for(var u in q[r].extra.tagRects)if(q[r].extra.tagRects[u])this.cache.extra[r].tagRects[u]=j.deserialize(q[r].extra.tagRects[u]);Object.keys(q[r].extra).forEach(function(v){if(v=='tagRects')return;this.cache.extra[r][v]=q[r].extra[v];}.bind(this));}},processErrorResult:function(q){if(!this.isLoaded()){this.initError=true;return;}var r=q.side,s=[p.ERROR_ID];this.attachToFbidsList(s,r);},setTotalCount:function(q){this.totalCount=q;},setFirstCursorIndex:function(q){this.firstCursorIndex=q;}});e.exports=p;});
__d("PhotoSnowliftAds",["array-extensions","event-extensions","copyProperties","CSS","csx","DataStore","DOM","PhotoSessionLog","UIPagelet","URI","Vector"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');var g=b('copyProperties'),h=b('CSS'),i=b('csx'),j=b('DataStore'),k=b('DOM'),l=b('PhotoSessionLog'),m=b('UIPagelet'),n=b('URI'),o=b('Vector'),p={DEFAULT_UNITS_REFRESH_RATE:30000,UNITS_REGISTER_DELAY:1000,root:null,availableDimensions:null,loadQuery:null,lastLoadTime:0,minAds:100,units:null,isLogAdData:null,refreshUnitsRate:null,adsStatus:'null',adsEvents:{},resetEvents:function(){this.adsStatus='reset';this.adsEvents={};},addEvent:function(q,r){if(r)this.adsStatus=q;var s=Date.now();this.adsEvents[q+'_'+s]=s;},init:function(q,r,s){this.reset();this.root=q;this.snowlift=r;this.minAds=s.min_ads;this.addEvent('init',true);this.refreshUnitsRate=p.DEFAULT_UNITS_REFRESH_RATE;if(s.refresh_fast)this.refreshUnitsRate=s.refresh_rate;},reset:function(){this.lastLoadTime=0;this.units=[];this.resetEvents();this.addEvent('reset',true);},resize:function(q){this.availableDimensions=q;this.loadQuery=this.snowlift.getLoadQuery();this.processResize();},calculateUnitSizes:function(q,r){var s={};q.forEach(function(t){var u=t.root.firstChild.offsetHeight;t.units.forEach(function(w){if(!h.hasClass(w,'hidden')){var x=this.getHeight(w.firstChild,r);u-=x;}}.bind(this));var v={height:u,visible:false};t.units.forEach(function(w){var x=this.getIsAds(w),y=this.getHeight(w.firstChild,r),z=this.getUnitId(w);s[z]={height:y,visible:false,priority:0,is_ads:x,section_ref:v};}.bind(this));}.bind(this));return s;},calculateVisibleUnits:function(q,r,s){var t=0,u=this.getUnitPriority(r);u.forEach(function(v){if(r.hasOwnProperty(v)){var w=r[v],x=w.height;if(!w.section_ref.visible)x+=w.section_ref.height;w.height_below=s-x;w.visible=w.height_below>=0&&x>0;if(w.visible){w.section_ref.visible=true;s-=x;t++;}}}.bind(this));return r;},displayUnits:function(q,r){q.forEach(function(s){var t=false;s.units.forEach(function(u){var v=this.getUnitId(u),w=r[v],x=w.visible,y=w.height_below,z=w.is_ads;h.conditionClass(u,'hidden',!x);t=t||x;this.calcUnitStats(this.units[z][v],x,y);}.bind(this));h.conditionClass(s.root,'hidden',!t);}.bind(this));},getUnitPriority:function(q){var r=[],s=0,t=0;for(var u in q){var v=q[u];r.push(u);var w=this.minAds+s+t;if(v.is_ads){if(t<this.minAds)w=t;t++;}else s++;v.priority=w;}r=r.sort(function(x,y){var z=q[x],aa=q[y];return z.priority-aa.priority;}.bind(this));return r;},updateUnitsStatus:function(){var q=this.availableDimensions.x,r=this.availableDimensions.y,s=this.calculateUnitSizes(this.sections,q);s=this.calculateVisibleUnits(this.sections,s,r);this.displayUnits(this.sections,s);},calcUnitStats:function(q,r,s){var t=Date.now();if(q.visible)q.totalTime+=t-q.lastShowTime;if(q.trackingCode!==null&&q.totalTime>=this.UNITS_REGISTER_DELAY){var u=q.trackingCode;q.trackingCode=null;this.registerImpression(u,q.registerUrl);}q.visible=r;q.heightBelow=s;q.lastShowTime=t;},prepareResize:function(){var q=function(r){var s=k.create('div',{className:'inner'}),t=k.create('div',{className:'wrapper'},s);k.replace(r,t);k.setContent(s,r);return t;};this.sections=k.scry(this.root,'div.ego_section').map(function(r){return {root:q(r),units:k.scry(r,'div.ego_unit').map(q)};});},processResize:function(){if(this.isLoading||this.lastLoadTime===0||this.availableDimensions===null){this.setLogData();return;}this.updateUnitsStatus();this.setLogData();var q=this.nextRegisterTime();if(q!==Infinity)this.processResize.bind(this).defer(q,true);},setIsLogAdData:function(q){this.isLogAdData=q;this.addEvent('setIsLogAdData',false);this.setLogData();},setLogData:function(){var q=this.snowlift.getImageId();if(this.isLogAdData&&q){var r=o.getElementDimensions(this.snowlift.getImage()),s=o.getElementDimensions(this.snowlift.getRHCHeader()),t=o.getElementDimensions(this.snowlift.getRHCBody()),u=o.getElementDimensions(this.snowlift.getRHCFooter()),v={query_set:this.snowlift.getLoadQuery().set,window_x:window.innerWidth,window_y:window.innerHeight,image_x:r.x,image_y:r.y,header_x:s.x,header_y:s.y,body_x:t.x,body_y:t.y,footer_x:u.x,footer_y:u.y,ads_below_space:this.getAdsBelowSpace(),time:Date.now(),adsStatus:this.adsStatus,adsEvents:this.adsEvents};l.updateAdData(q,v);}},getAdsBelowSpace:function(){var q=[],r=this.units[1];for(var s in r)if(r.hasOwnProperty(s))q.push(r[s].heightBelow);return q;},getIsAds:function(q){var r=k.scry(q,"div._4u8");return r.length;},getUnitId:function(q){if(this.getIsAds(q)){return this.getAdId(q);}else return this.getEgoId(q);},getEgoId:function(q){var r=k.find(q,'div.ego_unit');return r.getAttribute('data-ego-fbid');},getAdId:function(q){var r=k.find(q,"div._4u8"),s=r.getAttribute('data-ad'),t=JSON.parse(s).adid;return t;},nextRegisterTime:function(){var q=Infinity,r=g(g({},this.units[0]),this.units[1]);for(var s in r)if(r.hasOwnProperty(s)){var t=r[s];if(t.trackingCode!==null&&t.visible)q=Math.min(q,this.UNITS_REGISTER_DELAY-t.totalTime);}return q;},getHeight:function(q,r){var s=j.get(q,'height');if(s&&s.x===r)return s.y;return this.cacheHeight(q,r);},cacheHeight:function(q,r){var s={x:r,y:q.offsetHeight};j.set(q,'height',s);return s.y;},loadAdsAndEgo:function(){this.resetEvents();this.addEvent('adsRequested',true);m.loadFromEndpoint('WebEgoPane',this.root,{pid:34,data:[this.loadQuery.set,true]},{crossPage:true,bundle:false});},unitsLoaded:function(q,r){var s;if(r){s='/ai.php';this.addEvent('adsLoaded',true);}else{s='/ajax/ei.php';this.addEvent('egoLoaded',true);}var t={};for(var u in q)if(q.hasOwnProperty(u))t[u]={trackingCode:q[u],totalTime:0,lastShowTime:0,heightBelow:-10000,visible:false,registerUrl:s};this.units[r]=t;if(r)this.waitForImages(this.imagesLoaded.bind(this));},imagesLoaded:function(){this.prepareResize();this.addEvent('imagesLoaded',true);this.lastLoadTime=Date.now();this.isLoading=false;this.processResize();h.removeClass(this.root,'loading');},loadAdsFromUserActivity:function(){var q=Date.now(),r=this.refreshUnitsRate;if(!this.isLoading&&q-this.lastLoadTime>r){h.addClass(this.root,'loading');this.isLoading=true;this.loadAdsAndEgo();}},registerImpression:function(q,r){var s=k.create('iframe',{src:n(r).addQueryData({aed:q}),width:0,height:0,frameborder:0,scrolling:'no',className:'fbEmuTracking'});s.setAttribute('aria-hidden','true');k.appendContent(this.root,s);},waitForImages:function(q){var r=k.scry(this.root,'img.img'),s=r.length,t=s;if(t===0)q();var u=function(){t--;if(t===0)q.defer();};for(var v=0;v<s;v++){var w=r[v];if(w.complete){u();}else Event.listen(w,{load:u,error:u,abort:u});}}};e.exports=p;});
__d("PhotoViewer",["Bootloader","copyProperties"],function(a,b,c,d,e,f){var g=b('Bootloader'),h=b('copyProperties');function i(){this.image=null;this.root=null;this.stream=null;}h(i,{bootstrap:function(j,k){g.loadModules(['PhotoSnowlift'],function(l){l.bootstrap(j,k);});}});h(i.prototype,{getEventPrefix:bagof(null),getEventString:function(j){var k=this.getEventPrefix();if(k)return k+'.'+j;return null;},getImage:function(){return this.image;},getPosition:function(){return this.stream?this.stream.getCursor():null;},getRoot:function(){return this.root;},getSourceString:bagof(null),getVersionConst:bagof(null)});e.exports=i;});
__d("PhotoSnowlift",["array-extensions","event-extensions","function-extensions","Arbiter","AsyncDialog","AsyncRequest","Bootloader","Class","CSS","Dialog","DOM","DOMControl","FullScreen","ImageUtils","Keys","LinkController","Locale","PageTransitions","Parent","PhotosConst","PhotoSessionLog","PhotoSnowliftAds","PhotoStreamCache","PhotosUtils","PhotoViewer","Rect","ScrollableArea","Style","Toggler","UIPagelet","URI","UserAgent","Vector","$","computeRelativeURI","copyProperties","createArrayFrom","ge","goURI","tx","csx","userAction"],function(a,b,c,d,e,f){b('array-extensions');b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('AsyncDialog'),i=b('AsyncRequest'),j=b('Bootloader'),k=b('Class'),l=b('CSS'),m=b('Dialog'),n=b('DOM'),o=b('DOMControl'),p=b('FullScreen'),q=b('ImageUtils'),r=b('Keys'),s=b('LinkController'),t=b('Locale'),u=b('PageTransitions'),v=b('Parent'),w=b('PhotosConst'),x=b('PhotoSessionLog'),y=b('PhotoSnowliftAds'),z=b('PhotoStreamCache'),aa=b('PhotosUtils'),ba=b('PhotoViewer'),ca=b('Rect'),da=b('ScrollableArea'),ea=b('Style'),fa=b('Toggler'),ga=b('UIPagelet'),ha=b('URI'),ia=b('UserAgent'),ja=b('Vector'),ka=b('$'),la=b('computeRelativeURI'),ma=b('copyProperties'),na=b('createArrayFrom'),oa=b('ge'),pa=b('goURI'),qa=b('tx'),ra=b('csx'),sa=b('userAction'),ta=b('event-extensions').$E;function ua(){this.parent.construct(this);}ma(ua,{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_PIXELS:'image_pixels',STATE_IMAGE_DATA:'image',LOADING_TIMEOUT:2000,PAGER_FADE:3000,FULL_SCREEN_PADDING:10,STAGE_HIRES_MAX:{x:2048,y:2048},STAGE_NORMAL_MAX:{x:960,y:960},STAGE_MIN:{x:520,y:520},SIDEBAR_SIZE_MAX:340,SIDEBAR_SIZE_MIN:285,STAGE_CHROME:{x:102,y:42},VIDEO_BOTTOM_BAR_SPACE:40,GOPREV_AREA:120,TIMELINE_STRETCH_WIDTH:843,TIMELINE_STRETCH_MIN:480,MIN_TAG_DISTANCE:83,PADDING_MIN:40,_instance:null,getInstance:function(){if(!ua._instance)ua._instance=new ua();return ua._instance;},initWithSpotlight:function(va,wa){ua.getInstance().init(va,wa);},touch:bagofholding,addPhotoFbids:function(va,wa,xa,ya){ua.getInstance().addPhotoFbids(va,wa,xa,ya);},attachFollowFlyout:function(va){n.insertAfter(ka('fbPhotoSnowliftSubscribe'),va);},attachSubscribeFlyout:function(va){n.insertAfter(ka('fbPhotoSnowliftSubscribe'),va);},attachTagger:function(va){ua.getInstance().attachTagger(va);},preload:function(va,wa){ua.getInstance().preload(va,wa);},bootstrap:function(va,wa){if(va&&ha(va).getQueryData().hasOwnProperty('share_id')){j.loadModules(['SpotlightShareViewer'],function(xa){xa.bootstrap(va,wa);});return;}ua.getInstance().bootstrap(va,wa);},closeRefresh:function(){ua.getInstance().closeRefresh();},deletePhoto:function(va){ua.getInstance().deletePhoto(va);},getImage:function(){return ua.getInstance().getImage();},getImageId:function(){return ua.getInstance().getImageId();},getLoadQuery:function(){return ua.getInstance().getLoadQuery();},getRHCBody:function(){return ua.getInstance().getRHCBody();},getRHCFooter:function(){return ua.getInstance().getRHCFooter();},getRHCHeader:function(){return ua.getInstance().getRHCHeader();},getRoot:function(){return ua.getInstance().getRoot();},likePhotoSkipConfirmation:function(va){ua.getInstance().likePhotoSkipConfirmation(va);},saveTagsFromPayload:function(va){ua.getInstance().saveTagsFromPayload(va);},saveTagsFromPayloadDelayed:function(va){ua.saveTagsFromPayload.curry(va).defer(2000);},handleServerError:function(va,wa){ua.getInstance().handleServerError(va,wa);},storeFromData:function(va){ua.getInstance().storeFromData(va);},swapData:function(){ua.getInstance().swapData();},touchMarkup:bagofholding,updateTotalCount:function(va,wa,xa){ua.getInstance().updateTotalCount(va,wa,xa);}});k.extend(ua,ba);ma(ua.prototype,{switchTimer:null,imageRefreshTimer:null,imageLoadingTimer:null,lastPage:0,currentMinSize:null,currentImageSize:null,resetUriStack:true,thumbSrc:null,shouldStretch:false,stageMax:ua.STAGE_NORMAL_MAX,stageChrome:ua.STAGE_CHROME,stagePagerPrev:null,ua:null,PhotoTagger:null,showHover:false,skipLikePhotoConfirmation:false,isShowingLikePhotoConfirmation:false,preload:function(va,wa){j.loadModules(['PhotoTagger','fb-photos-snowlift-css','Live','PhotoTagApproval','PhotoTags','TagTokenizer','fb-photos-snowlift-fullscreen-css'],function(ya){this.PhotoTagger=ya;}.bind(this));var xa=this.getImageSrc(ha(va).getQueryData());if(xa)(new Image()).src=xa;},bootstrap:function(va,wa){if(va&&ha(va).getQueryData().makeprofile){this.enableCropperOnInit=true;this.isUserProfilePic=ha(va).getQueryData().makeuserprofile;this.isInProfilePicAlbum=ha(va).getQueryData().inprofilepicalbum;}this.preload(va,wa);y.reset();this.resetUriStack=true;if(this.isOpen)if(this.openExplicitly){this.closeCleanup();this.resetUriStack=false;}else return;this.ua=sa('snowlift',wa).uai('open');this.returningToStart=false;this.loading&&l.removeClass(this.loading,'loading');if(wa){l.addClass((this.loading=wa),'loading');this.getThumbAndSize(wa);}else this.loading=null;g.inform('PhotoSnowlift.GO',va,g.BEHAVIOR_STATE);this.loadFrameIfUninitialized();},getCurrentImageServerSizeDimensions:function(){return this.stream.getCurrentImageData().dimensions;},getEventPrefix:function(){return 'PhotoSnowlift';},getRoot:function(){return this.root;},getSourceString:function(){return 'snowlift';},getVersionConst:function(){return w.VIEWER_SNOWLIFT;},getImage:function(){return this.image;},getImageId:function(){return this.stream.getCursor();},getRHCHeader:function(){return this.rhcHeader;},getRHCBody:function(){return this.ufiForm;},getRHCFooter:function(){return this.rhcFooter;},getLoadQuery:function(){return this.loadQuery;},getCurrentPhotoInfo:function(){var va=this.stream.getCurrentImageData();if(va)return va.info;return null;},getOwnerId:function(){var va=this.stream.getCurrentImageData();if(va)return va.info.owner;return null;},getThumbAndSize:function(va){this.currentImageSize=null;this.thumbSrc=null;var wa=ha(va.getAttribute('ajaxify')).getQueryData();if(!wa.size)return;var xa=ja.deserialize(wa.size);if(!xa.x||!xa.y)return;this.currentImageSize=xa;if(!l.hasClass(va,'uiMediaThumb')&&!l.hasClass(va,'uiPhotoThumb')&&!l.hasClass(va,'uiScaledThumb'))return;if(va.getAttribute('data-cropped'))return;var ya=n.scry(va,'img')[0],za=n.scry(va,'i')[0],ab=v.byAttribute(va,'data-size');this.shouldStretch=ab&&this.currentImageSize&&ya&&ab.getAttribute('data-size')==="2"&&this.currentImageSize.x>this.currentImageSize.y&&this.currentImageSize.x<=ua.TIMELINE_STRETCH_WIDTH&&ya.offsetWidth===ua.TIMELINE_STRETCH_WIDTH;var bb;if(ya){bb=ya.src;}else if(za){bb=ea.get(za,'backgroundImage').replace(/.*url\("?([^"]*)"?\).*/,'$1');}else return;this.thumbSrc=bb;},loadFrameIfUninitialized:function(){if(this.root)return;new i('/ajax/photos/snowlift/init.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();},init:function(va,wa){this.init=bagofholding;this.showHover=wa.pivot_hover;x.setEndMetrics(wa.pivot_end_metric);this.showEndPivot=wa.pivot_end;this.enableSnowliftProfilePicCropper=wa.snowlift_profile_pic_cropper;this.fullscreen=p.isSupported();this.showOGVideos=wa.og_videos;this.stageMax=ua.STAGE_HIRES_MAX;this.spotlight=va;this.spotlight.subscribe('blur',function(){this.closingAction=x.OUTSIDE;}.bind(this));this.spotlight.subscribe('hide',this.closeHandler.shield(this));this.spotlight.subscribe('key',this.keyHandler.bind(this));this.initializeNodes(this.spotlight.getRoot());y.init(this.sideAdUnit,this,wa);if(!this.subscription){s.registerHandler(this.handleNavigateAway.bind(this));this.subscription=g.subscribe('PhotoSnowlift.GO',function(xa,ya){this.openExplicitly=true;this.loading&&l.removeClass(this.loading,'loading');this.open(ya);}.bind(this));}this.transitionHandlerRegistered=false;this.returningToStart=false;u.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;g.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));g.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));if(this.fullscreen)p.subscribe('changed',this.onFullScreenChange.bind(this));},onFullScreenChange:function(){var va=p.isFullScreen();l.conditionClass(document.body,'fbPhotoSnowliftFullScreenMode',va);if(va){if(!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.collapseRHC();var wa=this.stream.getCurrentImageData();if(wa&&wa.url&&this.image.src!==wa.url&&this.shouldShowHiRes(wa))this.switchImage(wa.url);this.adjustForResize();}else{this.uncollapseRHC();if(ia.chrome()&&!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))this.page(0,false);g.inform('reflow');}fa.hide();if(this.cropper)this.cropper.resetPhoto();},initializeNodes:function(va){this.root=va;this.container=n.find(va,'div.fbPhotoSnowliftContainer');this.snowliftPopup=n.find(this.container,'div.fbPhotoSnowliftPopup');this.rhc=n.find(this.snowliftPopup,'div.rhc');this.rhcHeader=n.find(this.rhc,'div.rhcHeader');this.rhcFooter=n.find(this.rhc,'div.rhcFooter');this.ufiForm=n.find(this.rhc,'form.fbPhotosSnowliftFeedbackForm');this.ufiInputContainer=n.find(this.rhc,'div.fbPhotosSnowboxFeedbackInput');this.scroller=n.find(this.ufiForm,'div.rhcScroller');this.scrollerBody=n.find(this.scroller,'div.uiScrollableAreaBody');this.stageWrapper=n.find(this.snowliftPopup,'div.stageWrapper');this.overlay=n.find(this.snowliftPopup,'div.snowliftOverlay');this.errorBox=n.find(this.stageWrapper,'div.stageError');this.image=n.find(this.stageWrapper,'img.spotlight');this.stage=n.find(this.stageWrapper,'div.stage');this.videoStage=n.find(this.stageWrapper,'div.videoStage');this.prevPager=n.find(this.snowliftPopup,'a.snowliftPager.prev');this.nextPager=n.find(this.snowliftPopup,'a.snowliftPager.next');this.stageActions=n.find(va,'div.stageActions');this.buttonActions=n.find(this.stageActions,'div.fbPhotosPhotoButtons');this.sideAdUnit=n.find(va,"._24q");g.inform('Amoeba/instrumentMulti',[[this.container,'snowlift'],[this.rhc,'rhc'],[this.rhcHeader,'rhc_header'],[this.ufiForm,'ufi_form'],[this.ufiInputContainer,'ufi_input'],[this.prevPager,'prev_pager'],[this.nextPager,'next_pager'],[this.stageActions,'stage_actions'],[this.sideAdUnit,'side_ads']],g.BEHAVIOR_PERSISTENT);l.conditionClass(this.root,'fullScreenAvailable',this.fullscreen);},initializeScroller:function(){this.initializeScroller=bagofholding;this.scrollableArea=da.fromNative(this.scroller,{fade:true,persistent:true});var va=function(event){var wa=ta(event).getTarget();if(n.contains(this.ufiInputContainer,wa)){var xa=o.getInstance(wa);if(xa){this.scrollableArea.scrollToBottom();var ya=xa.subscribe('resize',function(){var ab=this.scrollableArea.isScrolledToBottom();this.adjustScroller();ab&&this.scrollableArea.scrollToBottom();}.bind(this)),za=Event.listen(wa,'blur',function(){xa.unsubscribe(ya);za.remove();});}}}.bind(this);g.subscribe('ufi/comment',function(wa,xa){if(this.ufiForm===xa.form){this.adjustScrollerIfNecessary();this.scrollableArea.scrollToBottom();}}.bind(this));Event.listen(this.rhc,'click',function(event){var wa=event.getTarget();if(v.byTag(wa,'a')||v.byTag(wa,'button')||n.isNodeOfType(wa,'input'))this.adjustScrollerIfNecessary();}.bind(this));g.subscribe(['reflow','CommentUFI.Pager'],function(){if(this.isOpen)this.adjustScroller();}.bind(this));if(this.ufiForm.attachEvent){this.ufiForm.attachEvent('onfocusin',va);}else this.ufiForm.addEventListener('focus',va,true);},openHandler:function(va){if(this.isOpen||va.getPath()!='/photo.php'||this.returningToStart||va.getQueryData().closeTheater||va.getQueryData().permPage||va.getQueryData().makeprofile){this.openHandlerRegistered=false;return false;}this.open(va);this._uriStack.push(ha(va).getQualifiedURI().toString());u.transitionComplete(true);return true;},getImageSrc:function(va){if(va.smallsrc){if(!va.size)return va.smallsrc;var wa=ja.deserialize(va.size),xa=this.getStageSize(wa);if(xa.x<=ua.STAGE_NORMAL_MAX.x&&xa.y<=ua.STAGE_NORMAL_MAX.y)return va.smallsrc;}return va.src;},open:function(va){var wa=ha(va).getQueryData(),xa=this.getImageSrc(wa);if(xa){delete wa.src;delete wa.smallsrc;}if(this.resetUriStack)this._uriStack=[];if(!this.initialLoad){wa.firstLoad=true;this.initialLoad=true;}this.sessionID=Date.now();this.loadQuery=ma(wa,{ssid:this.sessionID});this.isOpen=true;this.pagersShown=false;this.refreshOnClose=false;this.hilitedTag=null;this.loadingStates={image:false,html:false};this.replaceUrl=false;this.stream=new z();this.stream.init(w.VIEWER_SNOWLIFT,'PhotoViewerPagelet');this.fetchInitialData();this.setLoadingState(ua.STATE_HTML,true);this.rhcCollapsed=false;j.loadModules(['fb-photos-snowlift-css'],this._open.bind(this,va,xa));if(this.showEndPivot)j.loadModules(['PhotoPivot'],function(ya){this.pivots=ya.getInstance();if(wa.relevant_count)this.pivots.setRelevantCount(wa.relevant_count);}.bind(this));if(this.enableSnowliftProfilePicCropper)j.loadModules(['SnowliftPicCropper'],function(ya){this.cropper=ya.getInstance(this);this.cropper.init();if(this.enableCropperOnInit){var za=g.subscribe('PhotoSnowlift.SWITCH_IMAGE',function(){if(this.isInProfilePicAlbum){this.cropper.showPicInProfileAlbumDialog();}else this.cropper.enableCropping(this.isUserProfilePic);g.unsubscribe(za);}.bind(this));this.enableCropperOnInit=false;}}.bind(this));j.loadModules(['PhotosButtonTooltips'],function(ya){ya.init();});},_open:function(va,wa){this.createLoader(wa);this.spotlight.show();this.ua&&this.ua.add_event('frame');g.inform('layer_shown',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.OPEN');this.stageHandlers=[Event.listen(window,'resize',this.adjustForResize.bind(this)),Event.listen(this.stageWrapper,'click',this.buttonListener.bind(this)),Event.listen(this.stageWrapper,'mouseleave',function(event){this.unhiliteAllTags();this.hidePagers();}.bind(this)),Event.listen(this.stageWrapper,'mousemove',this.hilitePagerOnMouseMove.bind(this)),Event.listen(this.stageWrapper,'mousemove',this.hiliteTagsOnMouseMove.bind(this)),Event.listen(this.overlay,'mouseenter',this.unhiliteAllTags.bind(this))];this.stageHandlers.push(Event.listen(this.container,'click',(function(event){var za=event.getTarget();if(v.byClass(za,'rotateRight')){this.rotate('right');}else if(v.byClass(za,'rotateLeft')){this.rotate('left');}else if(v.byClass(za,'closeTheater')){if(p.isFullScreen()){p.toggleFullScreen();return;}this.closingAction=x.X;this.closeHandler();}else if(this.fullscreen)if(v.byClass(za,'fbPhotoSnowliftFullScreen')){this.toggleFullScreen();}else if(v.byClass(za,'fbPhotoSnowliftCollapse'))this.toggleCollapse();}).bind(this)));var xa=oa('fbPhotoSnowliftFeedback');if(xa)this.stageHandlers.push(Event.listen(xa,'click',function(event){if(v.byClass(event.getTarget(),'like_link')||v.byClass(event.getTarget(),'UFILikeLink'))this.toggleLikeButton();var za=v.byClass(event.getTarget(),'uiUfiCollapsedComment');if(za)l.addClass(za,'uiUfiCollapsedCommentToggle');}.bind(this)));var ya=oa('fbPhotoSnowliftOnProfile');if(ya)this.stageHandlers.push(Event.listen(ya,'click',function(event){if(v.byClass(event.getTarget(),'fbPhotoRemoveFromProfileLink'))this.refreshOnClose=true;}.bind(this)));if(this.resetUriStack)this.startingURI=ha.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();if(!wa)this.setLoadingState(ua.STATE_IMAGE_DATA,true);if(!this.transitionHandlerRegistered){u.registerHandler(this.transitionHandler.bind(this));this.transitionHandlerRegistered=true;}x.initLogging(x.SNOWLIFT);if(this.pivots)x.setRelevantCount(this.pivots.relevantCount);},toggleFullScreen:function(){var va=p.toggleFullScreen(document.documentElement);if(va){var wa=this.stream.getCurrentImageData();if(wa&&wa.url&&this.image.src!==wa.url&&this.shouldShowHiRes(wa))(new Image()).src=wa.url;x.logEnterFullScreen(this.stream.getCursor());}},getStream:function(){return this.stream;},fetchInitialData:function(){this.ua&&this.ua.add_event('init_data');this.stream.waitForInitData();ga.loadFromEndpoint('PhotoViewerInitPagelet',null,this.loadQuery,{usePipe:true,jsNonblock:true,crossPage:true});},toggleCollapse:function(){if(this.rhcCollapsed){this.uncollapseRHC();}else this.collapseRHC();},collapseRHC:function(){this.rhcCollapsed=true;l.addClass(this.root,'collapseRHC');this.adjustForResize();},uncollapseRHC:function(){this.rhcCollapsed=false;l.removeClass(this.root,'collapseRHC');this.adjustForResize();},closeHandler:function(){if(!this.isOpen)return;this.closingAction=this.closingAction||x.ESC;if(ha.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.returnToStartingURI(this.refreshOnClose);this.close();},returnToStartingURI:function(va,wa){if(!va)if(wa){this.squashNextTransition(pa.curry(wa));}else this.squashNextTransition();this.returningToStart=true;var xa=g.subscribe('page_transition',function(){this.returningToStart=false;xa.unsubscribe();}),ya=va||isNaN(ia.opera()),za=this._uriStack.length;if(ya&&za<window.history.length){window.history.go(-za);}else{var ab=this.startingURI,bb=new ha(ab).removeQueryData('closeTheater');if(ab.getQueryData().sk=='approve'&&ab.getPath()=='/profile.php'){bb.removeQueryData('highlight');bb.removeQueryData('notif_t');}pa(bb);}},squashNextTransition:function(va){this.squashNext=true;u.registerHandler(function wa(){if(this.squashNext){this.squashNext=false;if(va)va.defer();u.transitionComplete(true);return true;}return false;}.bind(this),7);},handleNavigateAway:function(va){var wa=la(u._most_recent_uri.getQualifiedURI(),va.getAttribute('href'));if(this.isOpen&&(wa instanceof ha)&&wa.getUnqualifiedURI().toString()!=this.startingURI.toString()&&wa.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=x.NAVIGATE;this.returnToStartingURI(false,wa);this.close();return false;}return true;},close:function(){if(!this.isOpen)return;this.isOpen=false;if(this.fullscreen)p.disableFullScreen();sa('snowlift').uai('close');this.cropper&&this.cropper.disableCropping();this.spotlight.hide();this.openExplicitly=false;this.closeCleanup.bind(this).defer();},closeCleanup:function(){l.removeClass(this.root,'dataLoading');x.logPhotoViews(this.closingAction);this.destroy();l.hide(this.errorBox);l.hide(this.image);this.currentImageSize=null;this.thumbSrc=null;this.shouldStretch=false;this.resetUriStack=true;l.removeClass(this.stageWrapper,'showVideo');n.empty(this.videoStage);this.uncollapseRHC();this.currentMinSize=null;this.setStagePagersState('reset');this.recacheData();n.empty(this.sideAdUnit);this.stream.destroy();var va=this.closingAction===x.NAVIGATE;this.closingAction=null;if(!this.openHandlerRegistered){u.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;}g.inform('layer_hidden',{type:'PhotoSnowlift'});g.inform('PhotoSnowlift.CLOSE',va);this.root.setAttribute('aria-busy','true');},createLoader:function(va){if(this.currentImageSize===null){this.adjustStageSize(ua.STAGE_MIN);}else{var wa=this.getStageSize(this.currentImageSize);wa=new ja(Math.max(wa.x,ua.STAGE_MIN.x),Math.max(wa.y,ua.STAGE_MIN.y));var xa=this.getImageSizeInStage(this.currentImageSize,wa);if(this.thumbSrc===null){this.adjustStageSize(xa);}else this.useImage(n.create('img',{className:'spotlight',alt:'',src:this.thumbSrc,style:{width:xa.x+'px',height:xa.y+'px'}}),xa,false);}this.setLoadingState(this.STATE_IMAGE_PIXELS,true);if(va)(function(){var ya=new Image();ya.onload=a.async_callback(function(){if(!this.isOpen||this.pendingImageUrl!=va)return;if(!this.stream||!this.stream.errorInCurrent()){this.switchImage(va,this.currentImageSize);this.ua&&this.ua.add_event('image');this.setLoadingState(ua.STATE_IMAGE_DATA,false);}}.bind(this),'photo_theater');ya.src=this.pendingImageUrl=va;}).bind(this).defer();l.hide(this.stageActions);this.setStagePagersState('disabled');},initDataFetched:function(va){x.setPhotoSet(this.stream.getPhotoSet());x.setLogFbids(va.logids);var wa=this.stream.getCurrentImageData();x.addPhotoView(wa.info,this.shouldShowHiRes(wa),this.fullscreen&&p.isFullScreen());if(!this.pageHandlers)this.pageHandlers=[Event.listen(this.root,'click',this.pageListener.bind(this)),Event.listen(this.root,'mouseleave',this.mouseLeaveListener.bind(this))];l.show(this.stageActions);this.root.setAttribute('aria-busy','false');this.isLoggedInViewer=va.loggedin;this.disableAds=!this.isLoggedInViewer||va.fromad;this.loadAds();},adjustScrollerIfNecessary:function(){clearTimeout(this.scrollerTimeout);this.scrollerTimeout=this.adjustScroller.bind(this).defer();},adjustScroller:function(){clearTimeout(this.scrollerTimeout);this.initializeScroller();this.scrollableArea.resize();var va=ja.getElementDimensions(this.rhc),wa=va.y;wa-=ja.getElementDimensions(this.rhcHeader).y;wa-=ja.getElementDimensions(this.ufiInputContainer).y;var xa=ja.getElementDimensions(this.scrollerBody).y;if(xa>=wa){ea.set(this.scroller,'height',wa+'px');l.addClass(this.rhc,'pinnedUfi');wa=0;}else{ea.set(this.scroller,'height','auto');l.removeClass(this.rhc,'pinnedUfi');wa-=xa;}var ya=ja.getElementDimensions(this.ufiInputContainer).y;ea.set(this.ufiForm,'padding-bottom',ya+'px');y.resize(new ja(va.x,wa));this.scrollableArea.adjustGripper();},adjustForResize:function(){this.currentMinSize=null;this.adjustStageSize();this.adjustForNewData();},shouldShowHiRes:function(va){if(!va||!va.smallurl)return false;var wa=this.getStageSize(va.dimensions),xa=this.getImageSizeInStage(va.dimensions,wa);return (xa.x>ua.STAGE_NORMAL_MAX.x||xa.y>ua.STAGE_NORMAL_MAX.y);},getImageURL:function(va){if(va.video){return null;}else if(va.smallurl&&!this.shouldShowHiRes(va))return va.smallurl;return va.url;},getImageDimensions:function(va){if(va.smalldims&&(!this.shouldShowHiRes(va)||this.image.src===va.smallurl))return va.smalldims;return va.dimensions;},getStageSize:function(va,wa){var xa=ja.getViewportDimensions(),ya=new ja(va.x,va.y);if(wa)ya=new ja(Math.max(va.x,wa.x),Math.max(va.y,wa.y));var za,ab;if(this.fullscreen&&p.isFullScreen()){return new ja((this.rhcCollapsed?screen.width:screen.width-ua.SIDEBAR_SIZE_MAX),screen.height-ua.FULL_SCREEN_PADDING*2);}else{za=Math.min(ya.x,this.stageMax.x,(xa.x-ua.SIDEBAR_SIZE_MAX-ua.STAGE_CHROME.x));ab=Math.min(ya.y,this.stageMax.y,xa.y-ua.STAGE_CHROME.y);}if(za===0&&ab===0)return new ja(0,0);var bb=za/ab,cb=ya.x/ya.y;if(bb<cb)return new ja(za,Math.ceil(za/cb));return new ja(Math.ceil(ab*cb),ab);},getImageSizeInStage:function(va,wa){var xa=va.x,ya=va.y;if(xa>=wa.x||ya>=wa.y){var za=wa.x/wa.y,ab=xa/ya;if(za<ab){xa=wa.x;ya=Math.ceil(xa/ab);}else if(za>ab){ya=wa.y;xa=Math.ceil(ya*ab);}else{xa=wa.x;ya=wa.y;}}return new ja(xa,ya);},adjustStageSize:function(va){var wa=this.currentImageSize;if(va){wa=va;}else{var xa=this.stream&&this.stream.getCurrentImageData();if(xa)wa=this.getImageDimensions(xa);}if(!wa)return;this.currentImageSize=wa;var ya=0;if(this.shouldStretch&&!this.getVideoOnStage()&&wa.x>wa.y&&wa.x<=ua.TIMELINE_STRETCH_WIDTH&&wa.x>=ua.TIMELINE_STRETCH_MIN){wa.y=Math.round(wa.y*ua.TIMELINE_STRETCH_WIDTH/wa.x);wa.x=ua.TIMELINE_STRETCH_WIDTH;}else if(this.getVideoOnStage()){ya=ua.VIDEO_BOTTOM_BAR_SPACE*2;wa.y+=ya;}var za=this.getStageSize(wa,this.currentMinSize);if(!this.currentMinSize)this.currentMinSize=new ja(0,0);this.currentMinSize=new ja(Math.max(za.x,ua.STAGE_MIN.x,this.currentMinSize.x),Math.max(za.y,ua.STAGE_MIN.y,this.currentMinSize.y));var ab=this.getImageSizeInStage(wa,this.currentMinSize),bb=this.currentMinSize.x-ab.x,cb=this.currentMinSize.y-ab.y;if(bb>0&&bb<ua.PADDING_MIN){this.currentMinSize.x-=bb;}else if(cb>0&&cb<ua.PADDING_MIN)this.currentMinSize.y-=cb;var db=this.currentMinSize.x+ua.SIDEBAR_SIZE_MAX;if(this.rhcCollapsed)db=this.currentMinSize.x;this.snowliftPopup.style.cssText='width:'+db+'px;'+'height:'+this.currentMinSize.y+'px;';var eb=this.currentMinSize.y-ya+'px';if(ia.firefox()||ia.ie()<8){var fb=ea.get(this.stageWrapper,'font-size');if(ia.ie()&&fb.indexOf('px')<0){var gb=n.create('div');gb.style.fontSize=fb;gb.style.height='1em';fb=gb.style.pixelHeight;}eb=((this.currentMinSize.y-ya)/parseFloat(fb))+'em';}this.stageWrapper.style.cssText='width:'+this.currentMinSize.x+'px;'+'line-height:'+eb+';';if(ia.ie()<8){ea.set(this.root,'height',ja.getViewportDimensions().y+'px');ea.set(this.container,'min-height',(this.currentMinSize.y+ua.STAGE_CHROME.y)+'px');}this.image.style.cssText='width:'+ab.x+'px;'+'height:'+ab.y+'px;';this.adjustScrollerIfNecessary();},adjustForNewData:function(){if(!this.image)return;var va=n.scry(this.stage,'div.tagsWrapper')[0],wa=ja.getElementDimensions(this.image);if(va){ea.set(va,'width',wa.x+'px');ea.set(va,'height',wa.y+'px');if(ia.ie()<=7){var xa=n.scry(this.root,'div.tagContainer')[0];if(xa)l.conditionClass(va,'ie7VerticalFix',ja.getElementDimensions(xa).y>wa.y);}}},setLoadingState:function(va,wa){switch(va){case ua.STATE_IMAGE_PIXELS:l.conditionClass(this.root,'imagePixelsLoading',wa);break;case ua.STATE_IMAGE_DATA:this.loadingStates[va]=wa;l.conditionClass(this.root,'imageLoading',wa);break;case ua.STATE_HTML:this.loadingStates[va]=wa;l.conditionClass(this.root,'dataLoading',wa);this.rhc.setAttribute('aria-busy',wa?'true':'false');break;}},destroy:function(){this.stageHandlers.forEach(function(va){va.remove();});if(this.pageHandlers){this.pageHandlers.forEach(function(va){va.remove();});this.pageHandlers=null;}},checkState:function(va){if(va!=ua.STATE_ERROR&&!this.loadingStates[va])return;switch(va){case ua.STATE_IMAGE_DATA:var wa=this.stream.getCurrentImageData();if(wa){var xa=this.getImageURL(wa);if(xa){this.switchImage(xa,null,true);}else if(wa.video)this.switchVideo(wa.video,true);this.setLoadingState(va,false);}break;case ua.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(va,false);}break;default:if(this.stream.errorInCurrent()){l.hide(this.image);l.show(this.errorBox);}break;}},buttonListener:function(event){var va=event.getTarget(),wa=Date.now();if(v.byClass(va,'fbPhotoTagApprovalBox'))return;if(wa-this.lastPage<350)return;if(v.byClass(va,'fbPhotosPhotoLike')){this.likePhoto();}else if(v.byClass(va,'tagApproveIgnore'))this.updateTagBox(event,va);},likePhoto:function(){x.addButtonLike();var va=ka('fbPhotoSnowliftFeedback'),wa=n.scry(va,'button.like_link')[0];if(!wa)wa=n.scry(va,'a.UFILikeLink')[0];var xa=wa.getAttribute('href');if(p.isFullScreen())if(ia.chrome())wa.setAttribute('href','javascript:;');wa.click();wa.setAttribute('href',xa);},toggleLikeButton:function(){var va=n.scry(this.buttonActions,'a.fbPhotosPhotoLike')[0];if(va){l.toggleClass(va,'viewerLikesThis');l.removeClass(va,'viewerAlreadyLikedThis');}},likePhotoWithKey:function(){if(this.isShowingLikePhotoConfirmation)return;if(this.skipLikePhotoConfirmation){this.likePhoto();}else h.send(new i('/photos/confirm_like.php'),function(va){this.isShowingLikePhotoConfirmation=true;va.subscribe('confirm',this.onCloseLikePhotoConfirmDialog.bind(this));va.subscribe('cancel',this.onCloseLikePhotoConfirmDialog.bind(this));}.bind(this));return false;},likePhotoSkipConfirmation:function(va){this.skipLikePhotoConfirmation=va;this.likePhoto();},onCloseLikePhotoConfirmDialog:function(){this.isShowingLikePhotoConfirmation=false;},updateTagBox:function(va,wa){this.unhiliteAllTags();var xa=oa(va);if(!xa)return;l.addClass(xa,'tagBox');l.addClass(xa,'tagBoxPendingResponse');l.removeClass(xa,'tagBoxPending');l.hide(n.find(xa,'span.tagForm'));if(wa){l.show(n.find(xa,'span.tagApproved'));}else l.show(n.find(xa,'span.tagIgnored'));},rotate:function(va){var wa=this.stream.getCursor();if(this.getVideoOnStage()){var xa=(va=='left')?270:90;j.loadModules(['VideoRotate'],function(za){new za(wa).motionRotate(xa);});return;}var ya=ma({fbid:wa,cs_ver:w.VIEWER_SNOWLIFT},this.stream.getPhotoSetQuery());ya[va]=1;this.setLoadingState(ua.STATE_IMAGE_DATA,true);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);l.hide(this.image);new i('/ajax/photos/photo/rotate/').setAllowCrossPageTransition(true).setData(ya).setErrorHandler(this.rotationError.bind(this,wa)).setFinallyHandler(this.rotationComplete.bind(this,wa)).setMethod('POST').setReadOnly(false).send();},rotationComplete:function(va,wa){if(va==this.stream.getCursor()){this.setLoadingState(ua.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));this.swapData();}},rotationError:function(va,wa){if(va==this.stream.getCursor()){this.setLoadingState(ua.STATE_IMAGE_DATA,false);this.switchImage(this.getImageURL(this.stream.getCurrentImageData()));j.loadModules(['AsyncResponse'],function(xa){xa.defaultErrorHandler(wa);});}},saveTagsFromPayload:function(va){this.storeFromData(va);if('data' in va&&this.stream.getCursor() in va.data)this.swapData();},saveEdit:function(){if(!l.hasClass(this.root,'fbPhotoSnowliftEditMode'))return;j.loadModules(['PhotoInlineEditor','Form'],function(va,wa){var xa=va.getInstance(this.getViewerConst());xa&&wa.bootstrap(xa.getForm().controller);}.bind(this));},mouseLeaveListener:function(event){this.unhiliteAllTags();this.reHilitePendingTag();},hilitePagerOnMouseMove:function(event){var va=ja.getEventPosition(event),wa=ja.getElementPosition(this.stage);if(t.isRTL()){var xa=ja.getElementDimensions(this.stage);this.stagePagerPrev=xa.x-(va.x-wa.x)<ua.GOPREV_AREA;}else this.stagePagerPrev=va.x-wa.x<ua.GOPREV_AREA;l.conditionClass(this.prevPager,'hilightPager',this.stagePagerPrev);l.conditionClass(this.nextPager,'hilightPager',!this.stagePagerPrev);var ya,za=event.getTarget();if(!v.byClass(za,'snowliftOverlay')&&!v.byClass(za,'bottomBarActions')&&!v.byClass(za,'snowliftPager'))ya=ua.PAGER_FADE;this.showPagers(ya);},showPagers:function(va){clearTimeout(this.fadePagerTimer);this.setStagePagersState('active');if(typeof va!=='undefined')this.fadePagerTimer=this.hidePagers.bind(this).defer(va);},hidePagers:function(){var va=n.scry(this.getRoot(),'.fbPhotosPhotoActionsMenu')[0];if(va)return;clearTimeout(this.fadePagerTimer);this.setStagePagersState('inactive');},getTagger:function(){if(!this.PhotoTagger)return null;var va=this.PhotoTagger.getInstance(w.VIEWER_SNOWLIFT);if(!va||!va.tagHoverFacebox)return null;return va;},unhiliteAllTags:function(){n.scry(this.stage,'div.tagsWrapper div.hover').forEach(function(wa){l.removeClass(wa,'hover');});this.hilitedTag=null;if(!l.hasClass(this.root,'taggingMode')){var va=this.getTagger();if(va){va.hideTagger();va.setCurrentFacebox(null);}}},switchHilitedTags:function(va,wa){if(this.switchTimer!==null){clearTimeout(this.switchTimer);this.switchTimer=null;}this.unhiliteAllTags();var xa=oa(va);if(xa){this.hilitedTag=va;if(!l.hasClass(this.root,'taggingMode')&&aa.isFacebox(this.hilitedTag)){var ya=this.getTagger();if(ya){l.addClass(xa,'hover');var za=ya.getFacebox(va);ya.setCurrentFacebox(za);if(za)ya.addTagFromFacebox(za);}}else l.addClass(xa,'hover');if(l.hasClass(xa,'tagBoxPending')&&!l.hasClass(xa,'showPendingTagName')&&wa===true){n.scry(this.stage,'div.tagsWrapper div.showPendingTagName').forEach(function(ab){l.removeClass(ab,'showPendingTagName');});l.addClass(xa,'showPendingTagName');}}},reHilitePendingTag:function(){var va=oa(this.hilitedTag);if(va&&l.hasClass(va,'showPendingTagName'))return;var wa=n.scry(this.stage,'div.tagsWrapper div.showPendingTagName')[0];if(wa)this.switchHilitedTags(wa.id);},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.switchTimer!==null)return;var va=event.getTarget();if(v.byClass(va,'snowliftOverlay')||v.byClass(va,'fbPhotoSnowliftTagApproval')||v.byClass(va,'tagPointer')||v.byClass(va,'photoTagTypeahead'))return;var wa=v.byClass(va,'tagBoxPending'),xa=false;if(this.hilitedTag){var ya=oa(this.hilitedTag);xa=ya&&l.hasClass(ya,'tagBoxPending');}var za=((!this.hilitedTag&&wa)||(!xa&&wa));if(za){this.switchHilitedTags(wa.id);return;}if(wa&&(wa.id==this.hilitedTag))return;var ab=250,bb=aa.absoluteToNormalizedPosition(this.image,ja.getEventPosition(event));if(this.currentTagHasPrecedence(bb))return;var cb=aa.getNearestBox(this.stream.getCurrentExtraData().tagRects,bb);if(!cb){if(!xa){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var db=null;if(xa){var eb={};eb[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];db=aa.getNearestBox(eb,bb);}if(db!==null&&xa)return;if(this.hilitedTag!=cb)if(xa){this.switchTimer=this.switchHilitedTags.bind(this,cb).defer(ab);}else{if(this.showHover){if(!this.seenTags)this.seenTags=[];if(!this.seenTags[cb]){x.addFaceTagImpression();this.seenTags[cb]=true;}}this.switchHilitedTags(cb);}},currentTagHasPrecedence:function(va){if(!this.hilitedTag)return false;var wa=this.stream.getCurrentExtraData().tagRects[this.hilitedTag],xa=new ca(wa.t+(wa.h()/2),wa.r,wa.b+(aa.isFacebox(this.hilitedTag)?10:0),wa.l,wa.domain);return xa.contains(va);},getVideoOnStage:function(){var va=this.stream&&this.stream.getCurrentImageData();return va&&va.video;},shouldPageOnAction:function(va,wa){if(!this.isOpen||this.isShowingLikePhotoConfirmation)return false;var xa=n.isNode(wa)&&(v.byClass(wa,'snowliftPager')||v.byClass(wa,'stagePagers')||v.byClass(wa,'pivotPageColumn')),ya=n.isNode(wa)&&v.byClass(wa,'stage'),za=l.hasClass(wa,'faceBox'),ab=((ya&&l.hasClass(this.root,'taggingMode'))||v.byClass(wa,'tagBoxPending')||v.byClass(wa,'tagBoxPendingResponse')||v.byClass(wa,'fbPhotoTagApprovalBox')||v.byClass(wa,'tag')||(this.cropper&&this.cropper.croppingMode));if(ab)return false;return va==r.LEFT||va==r.RIGHT||(!l.hasClass(this.root,'taggingMode')&&za)||xa||ya;},keyHandler:function(va,event){if(event.getModifiers().any)return true;switch(Event.getKeyCode(event)){case r.LEFT:case r.RIGHT:this.pageListener(event);return false;case 76:return this.likePhotoWithKey();}},pageListener:function(event){var va=Event.getKeyCode(event),wa=event.getTarget();if(!this.shouldPageOnAction(va,wa))return;var xa=0;if(va==r.RIGHT){xa=1;x.setPagingAction('key_right');}else if(va==r.LEFT){xa=-1;x.setPagingAction('key_left');}else if(v.byClass(wa,'next')){xa=1;x.setPagingAction('click_next');}else if(v.byClass(wa,'prev')){xa=-1;x.setPagingAction('click_prev');}else if(!this.stagePagerPrev){xa=1;x.setPagingAction('click_stage');}else{xa=-1;x.setPagingAction('click_stage_back');}if(l.hasClass(this.root,'fbPhotoSnowliftEditMode')||(this.cropper&&this.cropper.croppingMode)){this.warnLeavePage(xa);}else{this.page(xa,ia.chrome()&&p.isFullScreen());sa('snowlift',wa,event).uai(x.pagingAction);}},warnLeavePage:function(va){new m().setTitle("Are you sure you want to leave this page?").setBody("You have unsaved changes that will be lost if you leave the page.").setButtons([{name:'leave_page',label:"Leave this Page",handler:this.page.bind(this,va)},{name:'continue_editing',label:"Stay on this Page",className:'inputaux'}]).setModal(true).show();},page:function(va,wa){if(!this.stream.isValidMovement(va)){this.showPagers(ua.PAGER_FADE);return;}this.lastPage=Date.now();this.unhiliteAllTags();this.seenTags=[];var xa=this.getVideoOnStage();if(xa)this.switchVideo(xa,false);if(this.pivots&&this.pivots.page(va))return;g.inform('PhotoSnowlift.PAGE');fa.hide();this.recacheData();this.stream.moveCursor(va);l.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(ua.STATE_HTML,true);l.show(this.errorBox);return;}var ya=this.stream.getCurrentImageData();if(ya){var za=this.getImageURL(ya);if(za){this.switchImage(za,null,true);}else if(ya.video)this.switchVideo(ya.video,true);if(!wa){this.replaceUrl=true;pa(ya.info.permalink);}this.setLoadingState(ua.STATE_IMAGE_DATA,false);}else{this.setLoadingState(ua.STATE_IMAGE_PIXELS,true);this.setLoadingState(ua.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(ua.STATE_HTML,true);this.disableAds=!this.isLoggedInViewer;this.loadAds();if(this.cropper)this.cropper.resetPhoto();},logImpressionDetailsForPhoto:function(){var va=[].concat(n.scry(ka('fbPhotoSnowliftTagList'),'input.photoImpressionDetails'),n.scry(ka('fbPhotoSnowliftFeedback'),'input.photoImpressionDetails'));if(va.length===0)return;var wa={};for(var xa=0;xa<va.length;xa++)wa[va[xa].name]=va[xa].value;if(this.getVideoOnStage()){wa.width=0;wa.height=0;}else{var ya=this.getImageDimensions(this.stream.getCurrentImageData());wa.width=ya.x;wa.height=ya.y;}x.addDetailData(this.stream.getCursor(),wa);y.setIsLogAdData(true);},loadAds:function(){if(this.disableAds)return;y.loadAdsFromUserActivity();},transitionHandler:function(va){if(va.getQueryData().closeTheater||va.getQueryData().permPage||va.getQueryData().makeprofile||this.returningToStart){if(this.isOpen)this.close();this.transitionHandlerRegistered=false;return false;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(va.getQualifiedURI().toString());u.transitionComplete(true);return true;}var wa=this._uriStack.length;if(wa>=2&&this._uriStack[wa-2]==va.getQualifiedURI().toString())this._uriStack.pop();var xa=this.stream.getCursorForURI(va.getUnqualifiedURI().toString());if(xa){var ya=this.stream.getRelativeMovement(xa);this.page(ya,true);u.transitionComplete(false);return true;}if(this.isOpen){u.transitionComplete(true);this.close();return true;}this.transitionHandlerRegistered=false;return false;},recacheData:function(){if(!this.loadingStates.html){var va=this.stream.getCurrentHtml();for(var wa in va){va[wa]=na(ka(wa).childNodes);n.empty(ka(wa));}}},reloadIfTimeout:function(){if(!q.hasLoaded(this.image)){var va=this.makeNewImage(this.image.src,true);Event.listen(va,'load',this.useImage.bind(this,va,null,true));}},useImage:function(va,wa,xa){if(xa&&q.hasLoaded(this.image))return;n.replace(this.image,va);this.image=va;g.inform('Amoeba/instrument',[this.image,'image'],g.BEHAVIOR_PERSISTENT);this.adjustStageSize(wa);},makeNewImage:function(va,wa){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}else if(!wa)this.imageRefreshTimer=setTimeout(this.reloadIfTimeout.bind(this),ua.LOADING_TIMEOUT);var xa=n.create('img',{className:'spotlight',alt:''});xa.setAttribute('aria-describedby','fbPhotosSnowliftCaption');xa.setAttribute('aria-busy','true');Event.listen(xa,'load',a.async_callback(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');this.setLoadingState(this.STATE_IMAGE_PIXELS,false);(function(){if(this.isOpen){this.adjustStageSize();this.adjustForNewData();}}).bind(this).defer();}.bind(this),'photo_theater'));xa.src=va;return xa;},switchImage:function(va,wa,xa){l.hide(this.image);l.hide(this.errorBox);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);var ya=this.stream&&this.stream.getCurrentImageData();if(ya)x.addPhotoView(ya.info,this.shouldShowHiRes(ya),this.fullscreen&&p.isFullScreen());this.useImage(this.makeNewImage(va,false),wa,false);if(xa)this.stream.preloadImages(this.shouldShowHiRes(ya));if(this.cropper&&this.cropper.croppingMode)this.cropper.resetPhoto();g.inform('PhotoSnowlift.SWITCH_IMAGE');},switchVideo:function(va,wa){var xa='swf_'+va;if(wa){l.addClass(this.stageWrapper,'showVideo');var ya=n.create('div',{className:'videoStageContainer'});n.appendContent(this.videoStage,ya);ya.id=va;if(window[xa]&&!oa(xa))window[xa].write(va);this.adjustStageSizeForVideo.bind(this,xa).defer();}else{window[xa]&&window[xa].addVariable('video_autoplay',0);this.videoLoadTimer&&clearTimeout(this.videoLoadTimer);n.empty(this.videoStage);l.removeClass(this.stageWrapper,'showVideo');}},checkVideoStatus:function(va){if(this.videoLoadTimer)clearTimeout(this.videoLoadTimer);var wa=this.getVideoOnStage();if(!wa){return;}else{var xa='swf_'+wa;if(va!==xa)return;this.adjustStageSizeForVideo(va);}},adjustStageSizeForVideo:function(va){var wa=oa(va);if(!wa){this.videoLoadTimer=setTimeout(this.checkVideoStatus.bind(this,va),200);}else this.adjustStageSize(new ja(wa.width,wa.height));},handleServerError:function(va,wa){n.setContent(this.errorBox,va);this.storeFromData(wa);},swapData:function(){var va,wa=this.stream.getCurrentHtml();if(wa){this.setLoadingState(ua.STATE_HTML,false);for(var xa in wa){va=oa(xa);va&&n.setContent(va,wa[xa]);}g.inform('PhotoSnowlift.DATA_CHANGE',this.stream.getCurrentImageData().info,g.BEHAVIOR_STATE);if(this.stream.getCurrentExtraData())g.inform('PhotoSnowlift.EXTRA_DATA_CHANGE',this.stream.getCurrentExtraData(),g.BEHAVIOR_STATE);}this.showPagers(ua.PAGER_FADE);this.adjustScroller();this.scrollableArea.showScrollbar(false);this.adjustForNewData();this.logImpressionDetailsForPhoto();},updateTotalCount:function(va,wa,xa){var ya=this.stream.getCurrentHtml();if(ya){var za=ka('fbPhotoSnowliftPositionAndCount');n.replace(za,xa);za=xa;l.show(za);var ab='fbPhotoSnowliftPositionAndCount';ya[ab]=na(za.childNodes);}this.stream.setTotalCount(va);this.stream.setFirstCursorIndex(wa);},addPhotoFbids:function(va,wa,xa,ya){if(ya&&this.sessionID&&ya!=this.sessionID)return;var za=this.stream.getCursor()===null;this.stream.attachToFbidsList(va,wa,xa);if(xa&&za)this.page(0,true);if(this.pivots&&xa)this.pivots.setCycleCount(this.stream.calculateDistance(this.stream.getCursor(),this.stream.firstCursor));if(!this.pagersShown&&this.stream.canPage())this.setStagePagersState('ready');},attachTagger:function(va){n.appendContent(this.stageActions,va);},storeFromData:function(va){if(!this.isOpen)return;if(va.ssid&&this.sessionID&&this.sessionID!=va.ssid)return;var wa=this.stream.storeToCache(va);if('error' in wa){this.checkState(ua.STATE_ERROR);return;}if('init' in wa){this.initDataFetched(wa.init);if(this.openExplicitly){this.replaceUrl=true;pa(this.stream.getCurrentImageData().info.permalink);}if(this.stream.canPage())this.setStagePagersState('ready');this.ua&&this.ua.add_event('ufi');}if('image' in wa)this.checkState(ua.STATE_IMAGE_DATA);if('data' in wa)this.checkState(ua.STATE_HTML);},setStagePagersState:function(va){switch(va){case 'ready':l.addClass(this.root,'pagingReady');this.pagersShown=true;this.ua&&this.ua.add_event('arrows');return;case 'active':l.addClass(this.root,'pagingActivated');return;case 'inactive':l.removeClass(this.root,'pagingActivated');return;case 'disabled':case 'reset':l.removeClass(this.root,'pagingReady');return;}},deletePhoto:function(va){this.closeRefresh();},closeRefresh:function(){this.refreshOnClose=true;this.closeHandler();},onHiliteTag:function(va,wa){if(wa.version!=w.VIEWER_SNOWLIFT)return;var xa=wa.tag;if(xa)this.switchHilitedTags(xa,true);},onUpdateTagBox:function(va,wa){if(wa.version==w.VIEWER_SNOWLIFT)this.updateTagBox(wa.id,wa.approve);}});e.exports=ua;});
__d("Spotlight",["JSXDOM","Arbiter","ArbiterMixin","Class","DOM","Layer","LayerTabIsolation","ModalLayer","Vector","copyProperties","csx","cx"],function(a,b,c,d,e,f){var g=b('JSXDOM'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('Class'),k=b('DOM'),l=b('Layer'),m=b('LayerTabIsolation'),n=b('ModalLayer'),o=b('Vector'),p=b('copyProperties'),q=b('csx'),r=b('cx');function s(u,v){this.parent.construct(this,u,v);this.stageMinSize=new o(0,0);this.stagePadding=new o(0,0);}j.extend(s,l);p(s.prototype,i,{stageMinSize:null,stagePadding:null,_buildWrapper:function(u,v){return (g.div({className:"_n8 _3qx",children:g.div({className:"_n9",children:v})}));},_getDefaultBehaviors:function(){return this.parent._getDefaultBehaviors().concat([t,m,n]);},getContentRoot:function(){if(!this._content)this._content=k.find(this.getRoot(),"div._n3");return this._content;},configure:function(u){if(u.stageMinSize)this.stageMinSize=u.stageMinSize;if(u.stagePadding)this.stagePadding=u.stagePadding;},onContentLoaded:function(){this.inform('content-load');},updatePermalink:function(u){this.inform('permalinkchange',u);}});function t(u){this._layer=u;}p(t.prototype,{_subscription:null,enable:function(){this._subscription=this._layer.subscribe(['show','hide'],function(u,v){if(u==='show'){h.inform('layer_shown',{type:'Spotlight'});}else h.inform('layer_hidden',{type:'Spotlight'});});},disable:function(){this._subscription.unsubscribe();this._subscription=null;}});e.exports=s;});
function AlbumScroller(){}copyProperties(AlbumScroller.prototype,{init:function(a,b){this.photoGroups={};this.scrollListener={};if(a.length){var c=a.shift(),d=c,e=0,f=c.id;while(d){if(!this.photoGroups[f])this.photoGroups[f]=[];var g=DOM.scry(d,'a.uiScrollableThumb');if(g.length>0)this.photoGroups[f].push(g[0]);d=this.getNextPhotoCell(d);if(++e%b==0){this.scrollListener[f]=new OnVisible(c,this.showPage.bind(this,c));c=a.shift();if(c)f=c.id;}}if(c)this.scrollListener[f]=new OnVisible(c,this.showPage.bind(this,c));}},showPage:function(a){var b=this.photoGroups[a.id];if(b)for(var c=0,d=b.length;c<d;c++)DOM.find(b[c],'i').style.backgroundImage='url('+b[c].getAttribute('data-src')+')';},getNextPhotoCell:function(a){var b=null;if(a.nextSibling){b=a.nextSibling;}else if(a.parentNode.nextSibling)b=a.parentNode.nextSibling.firstChild;if(b&&b.childElementCount!==0)return b;return null;}});
__d("MediaSetLikeButtonController",["event-extensions","CSS","DOMQuery","ge"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOMQuery'),i=b('ge'),j={enableOn:function(k){Event.listen(k,'click',function(){var l=i('mediaSetUfiLikeLink'),m=l&&h.scry(l,'.like_link')[0]||h.scry(l,'.UFILikeLink')[0];m&&m.click();g.hide(k);});}};e.exports=j;});