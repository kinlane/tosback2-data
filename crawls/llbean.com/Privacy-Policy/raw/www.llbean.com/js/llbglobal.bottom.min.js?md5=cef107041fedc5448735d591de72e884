/*
 Contains: jquery.postmessage.js,llbean.global.js  */
(function($){"$:nomunge";var interval_id,last_hash,cache_bust=1,rm_callback,window=this,FALSE=!1,postMessage="postMessage",addEventListener="addEventListener",p_receiveMessage,has_postMessage=window[postMessage];$[postMessage]=function(message,target_url,target){if(!target_url)return;message=typeof message==="string"?message:$.param(message);target=target||parent;if(has_postMessage)target[postMessage](message,target_url.replace(/([^:]+:\/\/[^\/]+).*/,"$1"));else if(target_url)target.location=target_url.replace(/#.*$/,
"")+"#"+ +new Date+cache_bust++ +"&"+message};$.receiveMessage=p_receiveMessage=function(callback,source_origin,delay){if(has_postMessage){if(callback){rm_callback&&p_receiveMessage();rm_callback=function(e){if(typeof source_origin==="string"&&e.origin!==source_origin||$.isFunction(source_origin)&&source_origin(e.origin)===FALSE)return FALSE;callback(e)}}if(window[addEventListener])window[callback?addEventListener:"removeEventListener"]("message",rm_callback,FALSE);else window[callback?"attachEvent":
"detachEvent"]("onmessage",rm_callback)}else{interval_id&&clearInterval(interval_id);interval_id=null;if(callback){delay=typeof source_origin==="number"?source_origin:typeof delay==="number"?delay:100;interval_id=setInterval(function(){var hash=document.location.hash,re=/^#?\d+&/;if(hash!==last_hash&&re.test(hash)){last_hash=hash;callback({data:hash.replace(re,"")})}},delay)}}}})(jQuery);
$(document).ready(function(){$.ajaxSetup({converters:{"text json":function(stringData){return jQuery.parseJSON(stringData.replace("for(;;);",""))}}})});
var loginConfig={displayType:"GL",isSignature:typeof sbConfig==="undefined"?"":sbConfig.miscobj.isSignature,iframeSource:"https://"+window.location.hostname+"/webapp/wcs/stores/servlet/ShowLoginDialog",layerWidth:"620",layerHeight:"auto",layerCSS:"background: url('/images/ajax-loader.gif') no-repeat 50% 50%;",layerMinHeight:"300",layerTitle:"",redirectURL:"",currentURL:window.location.href};var config={};
function globalLoginLayer(){loginConfig.displayType="GL";loginConfig.layerWidth="620";loginConfig.layerHeight="auto";loginConfig.layerCSS="background: url('/images/ajax-loader.gif') no-repeat 50% 50%; padding: 15px;";loginConfig.layerMinHeight="300";loginConfig.layerTitle="";loginConfig.redirectURL="";loginConfig.currentURL=window.location;if(typeof window.postMessage==="undefined")window.location="https://"+window.location.hostname+"/webapp/wcs/stores/servlet/MSProtect?storeId=1";else loginLayer()}
function loginLayer(configObj){if(typeof configObj=="undefined")configObj={};config=$.extend({},loginConfig,configObj);if(!$(".ui-dialog").is(":visible"))$(this).dialog("close");callIframe();openLoginDialog();sendMetricsTagLoginLayer()}function callIframe(){var $loginDialog=$("#loginDialog");if(!$loginDialog.length)$("body").append('<div id="loginDialog" style="'+config.layerCSS+'"></div>')}
function openLoginDialog(){var loginClass;if(config.isSignature!="true")loginClass="coreDialog";else loginClass="sigDialog";$("#loginDialog").dialog({modal:true,resizable:false,draggable:false,zIndex:1001,dialogClass:loginClass,title:config.layerTitle,minHeight:config.layerMinHeight,width:config.layerWidth,height:config.layerHeight,create:function(event,ui){},open:function(event,ui){var iframeURL=""+config.iframeSource+"?displayType="+config.displayType+"&isSignature="+config.isSignature+"";if(typeof config.isPPCC!==
"undefined")iframeURL+="&isPP="+config.isPPCC;$(this).append('<IFRAME id="loginLayer" name="loginLayer" src="'+iframeURL+'" scrolling="no" width="100%"  marginheight="0" marginwidth="0"  frameborder="0">')},close:function(event,ui){$("#loginDialog").empty()}});$(".ui-widget-overlay").click(function(){$("#loginDialog").dialog("close")})}
$.receiveMessage(function(e){var message=e.data.split("+");if(message[0]=="layerTitle")if(message[1]!=""&&config.layerTitle==""){config.layerTitle=message[1];$("#ui-dialog-title-loginDialog").empty().append(message[1])}if(message[0]==="redirectURL"){if(config.redirectURL!==""){$("#loginDialog").dialog("close");if(typeof sb_blockUI==typeof Function&&config.displayType!="GL"&&config.displayType!="WL")sb_blockUI();window.location=config.redirectURL}else if(message[1]!==""){$("#loginDialog").dialog("close");
if(typeof gnJsonData!=="undefined")window.location.reload();else{if(typeof sb_blockUI==typeof Function&&config.displayType!="GL"&&config.displayType!="WL")sb_blockUI();window.location=message[1]}return false}if(message[1]!=""&&config.redirectURL==""){config.redirectURL=message[1];$("#loginDialog").dialog("close");window.location.href=message[1]}else if(config.redirectURL!=""){$("#loginDialog").dialog("close");window.location.href=config.redirectURL}else if(message[1]==""&&config.redirectURL==""){var currentURL=
config.currentURL;if(currentURL.indexOf("krypto")!==-1){$("#loginDialog").dialog("close");window.location.href="http://www.llbean.com"}else{$("#loginDialog").dialog("close");window.location.href=config.currentURL}}}if($.inArray(message[0],["createAccount","checkoutAsGuest","forgotPassword","notYouURL"])>-1){$("#loginDialog").dialog("close");window.location.href=message[1]}if(message[0]=="iframeHeight")$("#loginLayer").attr("height",message[1]);if(e.data=="cancelLogin")$("#loginDialog").dialog("destroy").remove()});


/*
JOY Promo Test
v5
 */

var nowjoy = new Date();

var ab_joy = {
	qei :'',
	cookieVal : [], // array containig the values separated by | in the cookie value
	emailSeg: 2,
	emailSegVal: 'joy10_excluded',
	options: {
		ck_domain 		: '.llbean.com',
		ck_start		: new Date('Dec 6, 2012'),
		ck_expiration	: new Date('Dec 13, 2012'),
		e_var			: 'eVar36',
		domain			: 'ww' + 'w.llbean.com',
		name 			: 'joy10Promo',
		segments		: ['joy10_holdout', 'joy10_show'],
		seg				: 0,
		value			: '' // the cookie value should be as follows => segment|value|expires
	},
	readCookieAb : function (cookieName) {
		if (cookieName.length < 1) {
			return null; // No cookie name to read, was passed
		}
		var docCookies = document.cookie;	
		if (docCookies.length < 1) return null;
		
		var c_start = docCookies.indexOf(cookieName + "=");

		if (c_start === -1) return null;
		
		c_start += cookieName.length + 1;		
		var c_end = docCookies.indexOf(";", c_start);

		if (c_end === -1) c_end = docCookies.length;
		var returnval = unescape(docCookies.substring(c_start, c_end));		
		return returnval;
	},
	createCookieAb: function (name, value, expires, path, domain) {
		var cookie_string = name + "=" + value + "; expires=" + expires + "; path=" + path + "; domain=" + domain;
		document.cookie = cookie_string;
		return true;
	},
	param: function(p) {
		var re=new RegExp("[\\&|\\?]"+p+"=([^\\&|\\?|\\n]*)");
		var s=re.exec(window.location.search);
		return (s!= null) ? unescape(s[1]) : null;
	},

	getRandInt: function() {

		var seg = Math.floor( Math.random() * 4 );
		var porcentage = [0,1,1,1];

		var segVal = porcentage[seg];
	    return segVal;
	},
	inArray: function ( elem, array ) {
		if ( array.indexOf ) return array.indexOf( elem );
		for ( var i = 0, length = array.length; i < length; i++ ) {
			if ( array[ i ] === elem ) return i;
		}
		return -1;
	},
	createPopin: function(){

		var localSubrnd = ab_joy.param('subrnd');
		localSubrnd= ( localSubrnd !== null && localSubrnd == 1 ) ? true : false ;

		var bannerimage = '<div id="joydialog" style="padding:0;background-color: #9C100A;"><a href="#" id="joy10" style="outline: none;" title="Click here to activate"><img src="/images/121212_promo10_popin_clickthru.gif" width="527" height="246" border="0" style="border:0;" alt="Get 10% OFF Your Entire Purchase. Offer ends today. Promo code JOY10." /></a></div>';
		if ( localSubrnd === true ) {
			bannerimage = '<div id="joydialog" style="padding:0;background-color: #ffffff;"><a href="#" id="joy10" style="outline: none;" title="Click here to activate"><img src="/signature/images/121212_promo10_popin_clickthru_sig.gif" width="527" height="360" border="0" style="border:0;" alt="ENDS TODAY Get 10% Off your entire purchase, offer ends today, promo code JOY10" /></a></div>'; 
		}
		
		var dialogHtml = $(bannerimage);
      	dialogHtml.prependTo('body');

      	var globalClass = ( localSubrnd ) ? "sigDialog" : "coreDialog";

		var objDialog = dialogHtml.dialog({
	      autoOpen: true,
	      modal: true,
	      width: 527,
	      stack: true,
	      dialogClass: globalClass,
	      resizable: false,
	      zIndex: 1001,
	      open: function(event, ui) {
	        $('.ui-widget-overlay').css('zIndex', 1000);
	      }     
	    });

		util.uri.getParams();
	   	util.uri.deleteParam('pcd');

	    $(document).delegate('#joy10', 'click', function(e){
	    	e.preventDefault();

	    	log('Before Promo JOY', util.uri.params);
	    	util.uri.addParam('pcd', 'JOY10');
	    	log('Promo JOY', util.uri.params);	

	    	var params = util.uri.toString();    	
	    	util.uri.doSearch(params);
	    	
	    	$('#joydialog').remove();
	    });
	},
	fireMetrics: function(title) {
		
		ll_o['eVar36'] = title;
		s_o_sc.eVar36 = title;

	},
	showJoy: function() {
		ab_joy.fireMetrics('joy10_show');
	},
	holdOut: function() {
		ab_joy.fireMetrics('joy10_holdout');
	},
	init: function () {
	   	
	   	// here we capture the source code (qs) if specified
	   	ab_joy.qei = ab_joy.param('qei');

		// here we check to find if the cookie alreay exists
		var joy = ab_joy.readCookieAb(ab_joy.options.name);

		if ( ab_joy.qei !== null ) {

			var value = ab_joy.emailSeg + '|' + ab_joy.emailSegVal;

			ab_joy.createCookieAb(ab_joy.options.name, value, ab_joy.options.ck_expiration, '/', ab_joy.options.ck_domain);

			ab_joy.fireMetrics(ab_joy.emailSegVal);

			return;
		}

		// if the cookie does not exists we get our segment and create the cookie
		if ( joy === null ) {

			ab_joy.options.seg = ab_joy.getRandInt(); // get segment index
			ab_joy.options.value = ab_joy.options.segments[ab_joy.options.seg]; // get segment value

			var value = ab_joy.options.seg + '|' + ab_joy.options.value;

			ab_joy.createCookieAb(ab_joy.options.name, value, ab_joy.options.ck_expiration, '/', ab_joy.options.ck_domain);

			ab_joy.cookieVal = value.split('|');

			if ( ab_joy.options.seg === 0 ) {
				ab_joy.fireMetrics('joy10_holdout');

			} else if ( ab_joy.options.seg === 1 ) {
				ab_joy.createPopin();
				ab_joy.fireMetrics('joy10_show');
			}

		} else {

			ab_joy.cookieVal = joy.split('|'); // create an array with the values in the cookie

			log('JOY', ab_joy.cookieVal);

			if ( ab_joy.cookieVal[0] == 0 ) {
				ab_joy.fireMetrics('joy10_holdout');

			} else if ( ab_joy.cookieVal[0] == 1 ) {
				ab_joy.fireMetrics('joy10_show');

			} else if ( ab_joy.cookieVal[0] == ab_joy.emailSeg ) {
				ab_joy.fireMetrics(ab_joy.emailSegVal);
			}

		}

	}
};
ab_joy.init();

