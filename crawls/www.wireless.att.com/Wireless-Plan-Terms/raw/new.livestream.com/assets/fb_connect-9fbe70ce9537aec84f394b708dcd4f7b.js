var Facebook=function(){window.fbAsyncInit=function(){FB.init({appId:$('meta[name="fb-app-id"]').attr("content"),status:!0,cookie:!0,oauth:!0,xfbml:!0}),window.fbApiInitialized=!0,FB.Event.subscribe("edge.create",function(e,t){var n,r;if(t._attr&&t._attr.ref){var i=$(t.dom.parentNode),s=i.data("account_id"),o=i.data("event_id"),u=i.data("post_id"),a=i.data("days_since_account_creation"),n={shared_event_id:o,shared_account_id:s,days_since_account_creation:a};u!==undefined?(n.shared_post_id=u,n.shared_resource_type="post"):n.shared_resource_type="event",r="Facebook Like"}else r="Facebook Like from Share",n=typeof _trackingParameters=="undefined"?{}:_trackingParameters;mixpanel.track("Shared",$.extend({type:r},n))})},function(){var e=document.createElement("script");e.type="text/javascript",e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js",e.async=!0,document.getElementById("fb-root").appendChild(e)}();var e=function(t){window.fbApiInitialized?t&&t():setTimeout(function(){e(t)},50)},t=function(e){e.preventDefault();var t=$(e.currentTarget);t.setLoadingState(),FB.login(function(e){e.authResponse?FB.api("/me",function(e){e.error?t.removeLoadingState():($(".facebook_connected").attr("disabled",!1),$.get("/my_account/connection/facebook/search",function(e){if(e.available===!0)t.closest("div").find("form.fb_join_form").submit();else{var n=t.closest("div").find("form.form_login_fb");n.find("input[name='authenticity_token']").val(e.token),n.submit()}}))}):t.removeLoadingState()},Common.facebookPermissions)},n=function(e){FB.getLoginStatus(function(t){t.authResponse?FB.logout(function(t){e&&e()}):e&&e()})},r=function(e){e.preventDefault();var t=$(e.currentTarget);t.setLoadingState(),FB.login(function(e){e.authResponse?Common.reloadPage():t.removeLoadingState()},{scope:"publish_stream, manage_pages"})},i=function(e){e.preventDefault();var t=$(e.currentTarget);t.setLoadingState(),$("#form_fb_install_page #page_id").val(t.data("id")),$("#form_fb_install_page").submit()},s=function(e,t){function r(e){e&&($("#fancybox-content")[0]!=undefined?$.fancybox.closeModal(t):window.location.href=$("a.#cancel[data-refresh]").attr("href"))}e.preventDefault();var n={method:"feed",link:$("#link_to_share").val(),display:"popup"};FB.ui(n,r)},o=function(e){e.preventDefault(),$(".facebook_join").setLoadingState(),$("#form_login_livestream").disableFormFields(),$("#login_button").attr("disabled",!0),FB.login(function(e){e.authResponse?u():($(".facebook_join").removeLoadingState(),$("#form_login_livestream").enableFormFields(),$("#login_button").attr("disabled",!1))},Common.facebookPermissions)},u=function(){FB.api("/me",function(e){e.error||(_registerEmail=e.email,a())})},a=function(){$("#form_login_fb").submit()},f=function(e){e.preventDefault();var t=$(e.currentTarget);FB.login(function(e){e.authResponse?(t.addClass("loading_state"),$.get("/welcome/friends?connect_facebook=1",function(e){$(".content .left").html(e)})):t.removeClass("loading_state")},Common.facebookPermissions)},l=function(e){e.preventDefault();var t=$(e.currentTarget),n=$(e.target).data("fbid");FB.ui({method:"feed",link:"http://new.livestream.com",display:"popup",to:n},function(e){e&&(t.text("Invited").removeClass("fb_invite").addClass("invited red"),mixpanel.track("Welcome Invite Facebook friend",{account_id:account_id,fb_id:n}))})},c=function(e){var t={target:e,data:{alert_type:e.data("type"),social_on:!e.hasClass("off")}};e.hasClass("off")?d(t):FB.getLoginStatus(function(e){var n=e.status==="connected";n?FB.api("/me",function(e){e.error?p():h(t)}):FB.login(function(e){e.authResponse?h(t):p()},Common.facebookPermissions)})},h=function(e){v({success:function(){d(e)},error:function(){p()}})},p=function(e){e?$("a.slider").removeClass("off"):$("a.slider").addClass("off")},d=function(e){e.data._method="put",$.ajax({type:"POST",url:"/my_account/notification",data:e.data,complete:function(){Common.closeLoadingStatus(),e.target!=undefined&&e.target.hasClass("reconnect_social_on")?(NavBar.hideFbTokenNotice(),p(e.data.social_on)):e.target!=undefined&&!e.target.hasClass("reconnect_social_on")?NavBar.hideFbTokenNotice():e.target==undefined&&p(e.data.social_on)},statusCode:{400:function(t){e.target==undefined&&(ogTarget.toggleClass("off"),g())}}})},v=function(e){var t={};t._method="put",t.through_social_on="true",$.ajax({type:"POST",url:"/my_account/connection/facebook",data:t,beforeSend:function(){var e=$("#user-details div.sharing div.body");e.length>0&&(e.find("#box_panel_overlay").show(),e.find(".social_on_loading").show())},complete:function(){var e=$("#user-details div.sharing div.body");e.length>0&&(e.find("#box_panel_overlay").hide(),e.find(".social_on_loading").hide())},success:function(){e!=undefined&&e.success!=undefined&&e.success()},error:function(){e!=undefined&&e.error!=undefined&&e.error()},statusCode:{400:function(e){m()}}})},m=function(){$.fancybox({lsType:"alert",wrapCSS:"warning",title:TextStrings.lightbox.fbAlreadyConnected.title,message:TextStrings.lightbox.fbAlreadyConnected.message,cancel:TextStrings.lightbox.ok})},g=function(){$.fancybox({lsType:"alert",wrapCSS:"warning",title:TextStrings.lightbox.socialOnFailed.title,message:TextStrings.lightbox.socialOnFailed.message,cancel:TextStrings.lightbox.ok})};return{publishToFBWall:s,initFBJoin:t,ensureInit:e,logout:n,loginWithFb:o,findFriends:f,fbInvite:l,authenticateForManagePages:r,installEventOnPage:i,socialON:c}}();