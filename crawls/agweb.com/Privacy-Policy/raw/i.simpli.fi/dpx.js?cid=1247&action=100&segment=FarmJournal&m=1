(function(win) {

    var hostname_as_int = parseInt(location.hostname || "local", 36);

    if (typeof win['dpx_'+hostname_as_int] != 'undefined') {
        win['dpx_'+hostname_as_int].run();
        return;
    }

    var dpx = {
        sifi_pixel_url: '//i.simpli.fi/dpx?',
        pixels: [],
        matching_pixels: [
            '//um.simpli.fi/pm_match?http://image2.pubmatic.com/AdServer/Pug?vcode=bz0yJnR5cGU9MSZjb2RlPTgwNiZ0bD01MTg0MDA=&piggybackCookie=uid:$UID',
            '//um.simpli.fi/ab_match',
            '//cm.g.doubleclick.net/pixel?nid=simplifi',
            '//um.simpli.fi/ox_match',
            '//um.simpli.fi/rb_match',
            '//um.simpli.fi/cw_match',
            '//um.simpli.fi/lj_match',
            '//ib.adnxs.com/getuid?http%3A//um.simpli.fi/an%3Fappnexus_uid%3D%24UID',
            '//www.googleadservices.com/pagead/conversion/1026675585/?random='+(new Date()).getTime()+'&cv=7&fst='+(new Date()).getTime()+'&fmt=3&value=0&label=eGG0CO2U2AIQgafH6QM&guid=ON'
        ],
        protocol: (document && document.location && document.location.protocol) || "http:",
        pixels_to_drop: [],
        dropping_pixels: false,
        rescue_pixel: null,

        drop_pixels: function() {
            var sifi_pixels = dpx.get_pixels();
            for (var i = sifi_pixels.length-1; i >= 0; i--) {
                dpx.drop_sifi_pixel(sifi_pixels[i]);
            }
            if (dpx.does_allow_matching() && !dpx.already_dropped_matching) {
                for (var i = dpx.matching_pixels.length-1; i >= 0; i--) {
                    dpx.pixels_to_drop.push(dpx.matching_pixels[i]);
                }
                dpx.already_dropped_matching = true;
            }
            if (!dpx.dropping_pixels) dpx._next_pixel();
            dpx.dropping_pixels = true;
        },

        get_pixels: function() {
            var nodes = document.scripts || document.getElementsByTagName('script'),
                pixels = [];
            for (var i = nodes.length-1; i >= 0; i--) {
                var node = nodes[i],
                    src = node.src || '';
                if (src.indexOf('/dpx.js') > 0 && !node.getAttribute('data-sifi-parsed')) {
                    node.setAttribute('data-sifi-parsed', true);
                    var params = dpx.get_query_string(src);
                    pixels.push(params);
                    dpx.pixels.push(params);
                }
            }
            return pixels;
        },

        get_query_string: function(src) {
            var str = src.substr(src.indexOf('dpx.js?')+7);
            return str;
        },

        drop_sifi_pixel: function(params) {
            params += "&cbri=" + Math.floor(Math.random()*(new Date().getTime()));
            params += "&referrer=" + escape(document.referrer);
            dpx.pixels_to_drop.push(dpx.sifi_pixel_url + params);
        },

        _next_pixel: function() {
            if (dpx.pixels_to_drop.length == 0) return;
            var src = dpx.pixels_to_drop.shift(),
                img = new Image();
            img.onload = img.onerror = function() {
              dpx.rescue_pixel = null;
              dpx._next_pixel();
            };
            img.src = dpx.protocol + src;

            dpx.rescue_pixel = setTimeout(function() {
              img.onload = img.onerror = null;
              dpx._next_pixel();
            },1000);
        },

        does_allow_matching: function() {
            if (typeof dpx.allow_matching != 'undefined') return dpx.allow_matching;

            if (location.protocol == 'https:') {
                dpx.allow_matching = false;
                return false;
            }

            for (var i = dpx.pixels.length-1; i >= 0; i--) {
                var params = dpx.pixels[i];
                if (params.indexOf('m=0') > 0) {
                    dpx.allow_matching = false;
                    return false;
                }
            }

            dpx.allow_matching = true;
            return true;
        },

        run: function() {
            dpx.drop_pixels();
        }
    };

    win['dpx_'+hostname_as_int] = dpx;

    dpx.run();

})(window);
