(function($){$.fn.buildecho=function(options){return this.each(function(){new $.buildecho(this,options);
});
};
var dserv=TWP.eidosBase||"http://devprev.digitalink.com";
var defaults={config:{dserv:dserv,badgeText:dserv+"/Fragment/SysConfig/WebPortal/twpweb/modules/comments/badge_text.jpt",echoContainer:"echo_container",badgeTextContainer:"echo-tip-text-container",echoVars:"comment-vars"},submitboxTemplate:'<!--  submit box container --><div id="echo_comment_box_container{elementIndex}" class="echo_comment_box_wrapper"><div class="comment-box-header" id="echo_comment_box_header{elementIndex}"> <span class="weigh-in" id="weighIn">{commentType}</span> <div id="comment-info-links"><span class="discussion-policy"><a class="iframe-overlay" config="overlayOpacity=.5&width=600&height=600" href="http://www.washingtonpost.com/wp-srv/interactivity/policy/discussion_policy.html">Discussion Policy</a></span><span class="faq-policy"> | <a class="iframe-overlay" config="overlayOpacity=.5&width=600&height=600" href="http://www.washingtonpost.com/wp-srv/interactivity/policy/discussion_faq.html#faq">FAQ</a></span><span class="about-comments"> | <a class="iframe-overlay" config="overlayOpacity=.5&width=600&height=600" href="http://www.washingtonpost.com/wp-srv/interactivity/policy/discussion_faq.html">{linkText}</a></span></div><!-- /weigh in box --> <!-- Submit form container --> <div class="echo-comment comment-box hidden" id="echo_comment_box{elementIndex}"> </div><div style="clear: both;height:0px;">&#160;</div> </div></div> <!-- /submit form container -->',countTemplate:'<!-- Comment count container --> <div  id="echo_count_container{elementIndex}" class="comment-count comment-count-primary echo-count-container"><span class="count-bubble smoother-dark"> <span  id="echo_counter{elementIndex}" class="comment-number echo-counter count-bubble-number{elementIndex}"><span class="loading">Loading...</span></span> <span class="count-bubble-end"></span> </span> <span class="count-label smoother-light">{commentType}</span> </div><!-- /Comment count container -->',streamTemplate:'<!-- Stream container --> <div id="echo_stream_container{elementIndex}" class="echo_stream_container margin-bottom-20"><div class="comment-header" rel="{streamtarget}"> {tablinks}</div> <!-- /comment tab container --><!-- comment stream container --> <div id="echo_comment_stream{elementIndex}" class="echo-stream"></div> </div><!--  /stream container -->',tablinks:'<div class="stream-header-info"><span class="others-saying">Read what others are saying</span><span class="about-badges"><a href="http://www.washingtonpost.com/wp-srv/interactivity/get-a-badge.html">About Badges</a></span></div><ul id="comment-stream-tabs" class="header-primary comment-stream-tabs"></ul>',sortlinks:'<ul id="comment-stream-sortorder" class="header-secondary comment-stream-sortorder"> <li class="option active"><a href="#" rel="reverseChronological">Newest first</a> </li> <li class="option last"> <a href="#" rel="chronological">Oldest first</a></li> <li class="option last"><a href="#" rel="likesDescending">Most Recommended first</a></li></ul> '};
$.buildecho=function(el,options){this.options=$.extend(defaults,options);
this.props={};
this.init(el);
};
$.buildecho.fn=$.buildecho.prototype={};
$.buildecho.fn.extend=$.buildecho.extend=jQuery.extend;
$.buildecho.fn.extend({createDataObject:function(elm){var data={};
if(typeof elm.attr("data")!=="undefined"&&elm.attr("data").length>0){var attrbs=elm.attr("data").split("&");
for(var i=0;
i<attrbs.length;
i++){if(attrbs[i]!=""){var valArry=attrbs[i].split("=");
data[valArry[0].toLowerCase()]=(valArry[1]=="true")?true:(valArry[1])=="false"?false:valArry[1];
}}}else{var attrbs;
attrbs=elm[0].attributes;
for(var i=0;
i<attrbs.length;
i++){var thisVal=attrbs[i].nodeValue;
data[attrbs[i].nodeName.toLowerCase()]=(thisVal=="true")?true:(thisVal)=="false"?false:thisVal;
}}return data;
},init:function(el){var self=this;
var commentContainers=$(el);
if(commentContainers.length==0){return ;
}commentContainers.each(function(i,echoObj){var echoContainer=$(echoObj);
var curDate="";
var elementKey="";
if(echoContainer.children().length==0){curDate=new Date();
elementKey="_"+curDate.getTime()+"_"+(Math.floor(Math.random()*22));
echoContainer.attr("id",(self.options.config.echoContainer+elementKey));
var thisCommentContainer=$('<div class="comments" id="comments'+elementKey+'"></div>');
echoContainer.append(thisCommentContainer);
if($("#echo-tip-text-container").length==0){echoContainer.append('<div id="'+self.options.config.badgeTextContainer+'"></div>');
}if($(".badgetext").length==0){self.loadTextFile(self.options.config.badgeText,$("#"+self.options.config.badgeTextContainer));
}var classList=echoContainer.attr("class").replace(/\s+/g," ").split(" ");
var data=self.createDataObject(echoContainer);
$.each(classList,function(index,value){if(value!=self.options.config.echoContainer&&value!=self.options.config.echoVars){value=value.replace("-","");
var thisEcho="";
var thisStream="";
try{thisStream=self.options[value+"Template"];
}catch(e){}if(value=="stream"){thisStream=thisStream.replace("{streamtarget}","echo_comment_stream"+elementKey);
thisStream=(data.includetabs!=false)?thisStream.replace("{tablinks}",self.options.tablinks):thisStream.replace("{tablinks}","");
}if(value=="count"){var commentType=(data.webtype=="discussion_story")?"Posts":"Comments";
thisStream=thisStream.replace("{commentType}",commentType);
}if(value=="submitbox"){var tempText=(data.webtype=="discussion_story")?"Your Posts":((data.webtype=="ugc_photo_story")?"Post a Photo":(data.webtype=="topic_story")?"Start a conversation":(data.webtype=="promo_story")?"Add your thoughts":"Weigh In");
thisStream=thisStream.replace("{commentType}",tempText);
tempText=(data.webtype=="ugc_photo_story")?"About Photo Galleries":"About Discussions";
thisStream=thisStream.replace("{linkText}",tempText);
tempText=(data.webtype=="ugc_photo_story")?"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;":"";
thisStream=thisStream.replace("{linkSpacer}",tempText);
}if(value=="count"||value=="submitbox"||value=="stream"){thisEcho=$(thisStream.replace(/{elementIndex}/gi,elementKey));
$(".echo-counter",thisEcho).attr("guid",data.guid);
$(".echo-comment",thisEcho).attr("guid",data.guid);
$(".echo-stream",thisEcho).attr("guid",data.guid);
$(echoContainer).append(thisEcho);
}}});
echoContainer.addClass("comments");
}else{}});
},loadTextFile:function(fileName,thisNode){var request="";
request=$.ajax({url:fileName,async:false});
thisNode.append($(request.responseText));
}});
})(jQuery);
function editAvatar(event){var modal=TWP.Objs.modal;
var href=jQuery(event.target).parent().attr("href");
var $modalBar=jQuery("#modal_bar");
var $modalClose=jQuery("#modal_close");
modal.showModal({content:"iframe",url:href,width:600,height:300,clone:false,ads:true,skin:"email",callback:function(){cssObj={display:"block","background-color":"#ffffff"};
$modalBar.css(cssObj);
closeCssObj={right:-34,top:-52};
jQuery("img",$modalBar).remove();
$modalClose.css(closeCssObj);
$modalClose.click(function(){TWP.Modules.Action.objs.modal.closeModal();
});
}});
}wp_e2=window.wp_e2||{};
wp_e2.extensions=$.extend({},wp_e2.extensions);
wp_e2.options=$.extend({},wp_e2.options);
wp_e2_defaults={allow_comments:true,allow_links:true,allow_photos:false,allow_videos:false,apiBaseURL:"http://echoapi.wpdigital.net",echoSubmissionProxyURL:"http://apps.echoenabled.com/v2/esp/activity",appkey:"dev.washpost.com",backplaneSettings:{serverBaseURL:"http://api.echoenabled.com/v1",busName:"washpost.com"},bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",commentMaxLength:3000,counterTarget:".echo-counter",debug:false,default_items:15,defaultTab:"top",display_ugc_photos:false,display_more:true,displayPhotoGalleryPluginArray:[{name:"TWP_UGC_Gallery"}],environment:{dev:{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.registrationcommentsurl_page+"?destination=",registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://iddevreg.digitalink.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",appkey:"dev.washpost.com"},qa:{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.registrationcommentsurl_page+"?destination=",registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"https://idstg.digitalink.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",appkey:"dev.washpost.com"},stage:{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.registrationcommentsurl_page+"?destination=",registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://idstg.washingtonpost.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://testapp12b:7001/bookmarklet/edit-comment.html",appkey:"prod.washpost.com"},prod:{logOutURL:TWP.signin.logouturl_page+"?destination=",logInURL:TWP.signin.logincommentsurl_page+"?destination=",profileURL:TWP.signin.registrationcommentsurl_page+"?destination=",registerURL:TWP.signin.registrationcommentsurl_page+"?destination=",proxyURL:"http://bunsen.wapolabs.com/identity/1.5.2/js/wapo_jskit_login_redirect.js",twp_echojsUrl:"/rw/sites/twpweb/js/echo2/v2/core/twp_comments_echo2.js",metaUrl:"http://id.washingtonpost.com/identity/public/visitor/submit_metadata.json",bookmarkletUrl:"https://liveadmin.washingtonpost.com/bookmarklet/edit-comment.html",appkey:"prod.washpost.com"}},guid:window.location.href,identityjsUrl:"",isAllComments:false,liveUpdatesTimeout:{counter:{"default":20,closed:0,no_webtype:60},stream:{"default":20,closed:0,no_webtype:0}},logOutURL:"",logInURL:"",markerDisplay:{top_commenter:"Post Forum Member",top_local:"Washingtologist",top_sports:"SuperFan",staff:"Post Writer",fact_checker:"Fact Checker",post_recommended:"Post Recommended",world_watcher:"World Watcher",culture_connoisseur:"Culture Connoisseur"},max_items_to_display:0,maxItemsTop:3,maxItems:15,metaUrl:"",moderation_required:false,pageURL:window.location.href,photoCommentMaxLength:500,profileURL:"",proxyURL:"",registerURL:"",sectionId:"",source:"washpost.com",streamPluginArray:[{name:"Whirlpools",after:0,clickable:true}],streamSettings:{defaults:{appkey:"dev.washpost.com",target:"#comment-stream",apiBaseURL:"",children:{additionalItemsPerPage:300,moreButtonSlideTimeout:400,itemsSlideTimeout:400},childrenItemsPerPage:10,childrenSortOrder:"chronological",plugins:[],truncateReplies:{after:0,clickable:true},streamStateLabel:{icon:true,text:true},viaLabel:{icon:true,text:true},reTag:false,streamStateToggleBy:"button",maxBodyCharacters:3000,aggressiveSanitization:false,openLinksInNewWindow:false,sortOrder:"reverseChronological",reply:false,request:"childrenof",allowedItemStates:["Untouched","CommunityFlagged","ModeratorApproved"],allowedUserStates:["ModeratorApproved"],safeHTML:"aggressive",childrenMaxDepth:1}},streamTabs:{all:{active:false,userMarkers:[""],childrenMaxDepth:1,childrenItemsPerPage:3,childrenSortOrder:"chronological",maxBodyCharacters:3000,title:"All Comments"},top:{active:false,userMarkers:["top_commenter","top_local","top_sports","staff"],itemMarkers:["post_recommended"],title:"Top Comments",childrenMaxDepth:1,childrenItemsPerPage:1,childrenSortOrder:"chronological",tabUrl:"",maxBodyCharacters:500,request:"childrenof"}},submitPluginArray:[],streamClient:null,streamId:"",streamTarget:"#echo_comment_stream",submitTarget:"#comment-box",topicCommentMaxLength:140,twp_echojsUrl:"",uploadPhotoPluginArray:[{name:"FileUpload",thumbnailRes:[90,60],previewRes:[300,200],webRes:[610,407],showDefaultInputs:false,fileSizeMax:5120,fileSizeMin:0,filesMax:1,storageServer:"http://s3.amazonaws.com/twp_echo_ugc",authorName:""}]};
$.extend(wp_e2,wp_e2_defaults,wp_e2.options,wp_e2.extensions);
(function($){wp_e2.createDataObject=function(elm){var data={};
if(typeof elm.attr("data")!=="undefined"&&elm.attr("data").length>0){var attrs=elm.attr("data").split("&");
for(var i=0;
i<attrs.length;
i++){if(attrs[i]!=""){valArry=attrs[i].split("=");
data[valArry[0].toLowerCase()]=(valArry[1]=="true")?true:(valArry[1])=="false"?false:valArry[1];
}}}else{var attrs=elm[0].attributes;
for(var i=0;
i<attrs.length;
i++){data[attrs[i].nodeName.toLowerCase()]=(attrs[i].nodeValue=="true")?true:(attrs[i].nodeValue)=="false"?false:attrs[i].nodeValue;
}}return data;
};
wp_e2.initDataObject=function(elm){var thisContainerElm=(typeof elm!="undefined")?elm:$(".comment-vars");
thisContainerElm.each(function(index,thisElm){var commentVars=$(thisElm);
data=wp_e2.createDataObject(commentVars);
var thisContainer=commentVars.attr("id");
wp_e2[thisContainer]={};
wp_e2[thisContainer].allCommentsURL=data.articleurlfacet;
wp_e2[thisContainer].allow_comments=(typeof data.allow_comments!=="undefined"&&data.allow_comments!=="")?data.allow_comments:wp_e2.allow_comments;
wp_e2[thisContainer].allow_links=(typeof data.allow_links!=="undefined"&&data.allow_links!=="")?data.allow_links:wp_e2.allow_links;
wp_e2[thisContainer].allow_photos=(typeof data.allow_photos!=="undefined"&&data.allow_photos!=="")?data.allow_photos:wp_e2.allow_photos;
wp_e2[thisContainer].allow_videos=(typeof data.allow_videos!=="undefined"&&data.allow_videos!=="")?data.allow_videos:wp_e2.allow_videos;
wp_e2[thisContainer].defaultTab=(typeof data.defaulttab!=="undefined"&&data.defaulttab!="")?data.defaulttab:wp_e2.defaultTab;
wp_e2.streamSettings.defaults.sortOrder=(typeof data.defaultsort!=="undefined"&&data.defaultsort!="")?data.defaultsort:wp_e2.streamSettings.defaults.sortOrder;
wp_e2[thisContainer].display_more=(typeof data.display_more!=="undefined"&&data.display_more!="")?wp_e2.display_more:data.display_more;
wp_e2[thisContainer].display_ugc_photos=(typeof data.display_ugc_photos!=="undefined"&&data.display_ugc_photos!=="")?data.display_ugc_photos:wp_e2.display_ugc_photos;
wp_e2[thisContainer].guid=data.guid;
wp_e2[thisContainer].includechildren=(typeof data.includechildren=="undefined")?true:data.includechildren;
wp_e2[thisContainer].includepause=(typeof data.includepause=="undefined")?true:data.includepause;
wp_e2[thisContainer].includetabs=(typeof data.includetabs=="undefined")?true:data.includetabs;
wp_e2[thisContainer].includesorts=(typeof data.includesorts=="undefined")?true:data.includesorts;
wp_e2[thisContainer].includereply=(typeof data.includereply=="undefined")?true:data.includereply;
wp_e2[thisContainer].includereport=(typeof data.includereport=="undefined")?true:data.includereport;
wp_e2[thisContainer].includerecommend=(typeof data.includerecommend=="undefined")?true:data.includerecommend;
wp_e2[thisContainer].isAllComments=(typeof data.isallcomments!=="undefined"&&data.isallcomments!=="")?data.isallcomments:wp_e2.isAllComments;
wp_e2[thisContainer].itemMarkersTop=data.markers;
wp_e2[thisContainer].itemMarkers=data.markersall;
wp_e2[thisContainer].itemUrl=data.itemurl;
wp_e2[thisContainer].markerDisplay=(typeof data.markerdisplay!=="undefined"&&data.markerdisplay!="")?jQuery.parseJSON("{"+data.markerdisplay.replace(/'/g,'"')+"}"):wp_e2.markerDisplay;
wp_e2.streamTabs.all.maxItems=(typeof data.maxitems!=="undefined"&&data.maxitems!="")?data.maxitems:wp_e2.maxItems;
wp_e2[thisContainer].moderation_required=(typeof data.moderationrequired!=="undefined"&&data.moderationrequired!=="")?data.moderationrequired:wp_e2.moderation_required;
wp_e2[thisContainer].numberOfChildren=data.childrennumber;
wp_e2[thisContainer].parentUrl=data.parenturl;
wp_e2[thisContainer].sectionId=data.sectionid;
wp_e2[thisContainer].source=(typeof data.commentssource!=="undefined"&&data.commentssource!=="")?data.commentssource:wp_e2.source;
wp_e2[thisContainer].streamId=data.streamid;
wp_e2[thisContainer].userMarkersTop=data.usermarkers;
wp_e2[thisContainer].userMarkers=data.usermarkersall;
wp_e2[thisContainer].webType=(typeof data.webtype=="undefined")?"article_story":data.webtype;
if(wp_e2[thisContainer].includetabs==true){wp_e2[thisContainer].streamTabs=$.extend(true,{},wp_e2.streamTabs);
}else{wp_e2[thisContainer].streamTabs={};
wp_e2[thisContainer].streamTabs[wp_e2[thisContainer].defaultTab]={};
wp_e2[thisContainer].streamTabs[wp_e2[thisContainer].defaultTab]=$.extend(true,{},wp_e2.streamTabs[wp_e2[thisContainer].defaultTab]);
}if(wp_e2[thisContainer].streamTabs.top){wp_e2[thisContainer].streamTabs.top.maxItems=(typeof data.maxitemstop!=="undefined"&&data.maxitemstop!="")?data.maxitemstop:wp_e2.maxItemsTop;
}if(wp_e2[thisContainer].streamTabs.all){wp_e2[thisContainer].streamTabs.all.maxItems=(typeof data.maxitems!=="undefined"&&data.maxitems!="")?data.maxitems:wp_e2.maxItems;
if(typeof data.markersall!=="undefined"&&data.markersall!=""){wp_e2[thisContainer].streamTabs.all.itemMarkers=wp_e2[thisContainer].itemMarkers.split(",");
}if(typeof data.usermarkersall!=="undefined"&&data.usermarkersall!=""){wp_e2[thisContainer].streamTabs.all.userMarkers=wp_e2[thisContainer].userMarkers.split(",");
}if(wp_e2[thisContainer].streamTabs.top&&(parseInt(wp_e2[thisContainer].streamTabs.all.maxItems)<=parseInt(wp_e2[thisContainer].streamTabs.top.maxItems))){wp_e2[thisContainer].streamTabs.all.maxItems=wp_e2.maxItems;
}}if(wp_e2[thisContainer].defaultTab=="all"){wp_e2[thisContainer].streamTabs.all.active=true;
}if(wp_e2[thisContainer].defaultTab=="top"){wp_e2[thisContainer].streamTabs.top.active=true;
if(typeof data.usermarkers!=="undefined"&&data.usermarkers!=""){wp_e2[thisContainer].streamTabs.top.userMarkers=wp_e2[thisContainer].userMarkersTop.split(",");
}if(typeof data.markers!=="undefined"&&data.markers!=""){wp_e2[thisContainer].streamTabs.top.itemMarkers=wp_e2[thisContainer].itemMarkersTop.split(",");
}}if(wp_e2[thisContainer].allow_photos||wp_e2[thisContainer].allow_videos){wp_e2.streamSettings.defaults.safeHTML="false";
}if(!data.isallcomments&&data.maxitems>0){wp_e2[thisContainer].max_items_to_display=data.maxitems;
if((wp_e2[thisContainer].webType).toLowerCase().indexOf("blogstory")<0&&(wp_e2[thisContainer].webType).toLowerCase().indexOf("discussion_story")<0){wp_e2[thisContainer].streamTabs.top=$.extend(true,{},wp_e2[thisContainer].streamTabs.top,{tabUrl:data.articleurlfacet+"?ctab=top_&#comments"});
wp_e2[thisContainer].streamTabs.all=$.extend(true,{},wp_e2[thisContainer].streamTabs.all,{tabUrl:data.articleurlfacet+"?ctab=all_&#comments"});
}}if((wp_e2[thisContainer].webType).toLowerCase().indexOf("discussion_story")>=0){wp_e2[thisContainer].streamTabs.top.title="Top Posts";
wp_e2[thisContainer].streamTabs.all.title="All Posts";
}if((wp_e2[thisContainer].webType).toLowerCase().indexOf("topic_story")>=0){wp_e2[thisContainer].commentMaxLength=(typeof wp_e2.options.topicCommentMaxLength!="undefined")?wp_e2.options.topicCommentMaxLength:wp_e2.topicCommentMaxLength;
}else{wp_e2[thisContainer].commentMaxLength=wp_e2.commentMaxLength;
}if(jQuery("#ugc-photo-gallery").length>0){wp_e2[thisContainer].commentMaxLength=wp_e2.photoCommentMaxLength;
}});
};
$(".echo_container").not(".processed").buildecho(wp_e2.options);
wp_e2.initDataObject();
wp_e2.streamSettings.defaults.apiBaseURL=wp_e2.apiBaseURL;
var currEnvironment=((typeof TWP==="undefined")||(typeof TWP.Data==="undefined")||(typeof TWP.Data.environment)==="undefined")?"dev":TWP.Data.environment;
var baseURL=(typeof eidosBase!=="undefined"&&eidosBase!=="")?eidosBase:"";
wp_e2.logOutURL=wp_e2.environment[currEnvironment].logOutURL;
wp_e2.logInURL=wp_e2.environment[currEnvironment].logInURL;
wp_e2.profileURL=wp_e2.environment[currEnvironment].profileURL;
wp_e2.proxyURL=wp_e2.environment[currEnvironment].proxyURL;
wp_e2.registerURL=wp_e2.environment[currEnvironment].registerURL;
wp_e2.twp_echojsUrl=baseURL+wp_e2.environment[currEnvironment].twp_echojsUrl;
wp_e2.metaUrl=wp_e2.environment[currEnvironment].metaUrl;
wp_e2.appkey=wp_e2.environment[currEnvironment].appkey;
wp_e2.bookmarkletUrl=wp_e2.environment[currEnvironment].bookmarkletUrl;
if(window.location.href.indexOf("echodebug=true",0)>0){wp_e2.debug=true;
}if(typeof TWP_Debug=="undefined"||TWP_Debug==""){TWP_Debug={};
}if(!TWP_Debug.initialTime){TWP_Debug.initialTime=new Date();
}wp_e2.debug&&window.console&&console.log&&console.log("["+(new Date()-TWP_Debug.initialTime)/1000+"]echo2/v2/core/twp_comments_echo2_identity.js - Starting Identity Load");
})(jQuery);
var dateFormat=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){val=String(val);
len=len||2;
while(val.length<len){val="0"+val;
}return val;
};
return function(date,mask,utc){var dF=dateFormat;
if(arguments.length==1&&Object.prototype.toString.call(date)=="[object String]"&&!/\d/.test(date)){mask=date;
date=undefined;
}date=date?new Date(date):new Date;
if(isNaN(date)){throw SyntaxError("invalid date");
}mask=String(dF.masks[mask]||mask||dF.masks["default"]);
if(mask.slice(0,4)=="UTC:"){mask=mask.slice(4);
utc=true;
}var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:dF.i18n.dayNames[D],dddd:dF.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:dF.i18n.monthNames[m],mmmm:dF.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:H<12?"a":"p",tt:H<12?"am":"pm",T:H<12?"A":"P",TT:H<12?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};
return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1);
});
};
}();
dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};
dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};
Date.prototype.format=function(mask,utc){return dateFormat(this,mask,utc);
};
Date.prototype.setISO8601=function(dString){var regexp=/(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;
if(dString.toString().match(new RegExp(regexp))){var d=dString.match(new RegExp(regexp));
var offset=0;
this.setUTCDate(1);
this.setUTCFullYear(parseInt(d[1],10));
this.setUTCMonth(parseInt(d[3],10)-1);
this.setUTCDate(parseInt(d[5],10));
this.setUTCHours(parseInt(d[7],10));
this.setUTCMinutes(parseInt(d[9],10));
this.setUTCSeconds(parseInt(d[11],10));
if(d[12]){this.setUTCMilliseconds(parseFloat(d[12])*1000);
}else{this.setUTCMilliseconds(0);
}if(d[13]!="Z"){offset=(d[15]*60)+parseInt(d[17],10);
offset*=((d[14]=="-")?-1:1);
this.setTime(this.getTime()-offset*60*1000);
}}else{this.setTime(Date.parse(dString));
}return this;
};
var thisStreamTab="all";
var thisEchoContainer="echo_container_a";
var thisEchoGUID=wp_e2[thisEchoContainer].guid;
var thisEchoId="echo_comment_stream";
var thisItemurl="";
wp_e2.initCommentStreamLite=function(elm){var thisContainerElm=(typeof elm!="undefined")?$(".echo-stream",elm):$(".echo-stream");
thisContainerElm.each(function(){var thisId=$(this).attr("id");
var thisContainer=$(this).closest(".echo_container").attr("id");
var guid=wp_e2[thisContainer].guid;
if(typeof $(this).attr("guid")!=="undefined"){guid=$(this).attr("guid");
}var itemurl=wp_e2[thisContainer].itemUrl;
wp_e2[thisContainer][thisId]={};
wp_e2[thisContainer][thisId].streamSettings=$.extend(true,{},wp_e2.streamSettings);
wp_e2.initStreamTabsLite(thisContainer,thisId);
});
};
wp_e2.initCommentCountLite=function(){var thisContainerElm=(typeof elm!="undefined")?$(elm):$(".echo_container");
thisContainerElm.each(function(index,elm){thisContainer=$(elm).attr("id");
if($(".echo-counter",elm).length>0||$(elm).hasClass("echo-counter")){thisId="echo-counter";
wp_e2[thisContainer][thisId]={};
wp_e2[thisContainer][thisId].streamSettings=$.extend(true,{},wp_e2.streamSettings);
wp_e2.initStreamTabsLite(thisContainer,thisId);
}});
};
wp_e2.initStreamTabsLite=function(thisContainer,thisId){$.each(wp_e2[thisContainer].streamTabs,function(key,obj){tab=key.toLowerCase();
wp_e2[thisContainer][thisId].streamSettings[tab]=$.extend(true,{},wp_e2[thisContainer][thisId].streamSettings.defaults,obj);
if((typeof obj.userMarkers!="undefined")&&obj.userMarkers.toString()!==""){wp_e2[thisContainer][thisId].streamSettings[tab].allowedUserMarkers=obj.userMarkers;
}if((typeof obj.userStates!="undefined")&&obj.userStates.toString()!==""){wp_e2[thisContainer][thisId].streamSettings[tab].allowedUserStates=obj.userStates;
}if((typeof obj.itemMarkers!="undefined")&&obj.itemMarkers.toString()!==""){wp_e2[thisContainer][thisId].streamSettings[tab].allowedItemMarkers=obj.itemMarkers;
}if((typeof obj.itemStates!="undefined")&&obj.itemStates.toString()!==""){wp_e2[thisContainer][thisId].streamSettings[tab].allowedItemStates=obj.itemStates;
}if((typeof obj.children!="undefined")&&obj.children!==""){wp_e2[thisContainer][thisId].streamSettings[tab].children=obj.children;
}if((typeof obj.maxItems!="undefined")&&obj.maxItems!==""){wp_e2[thisContainer][thisId].streamSettings[tab].maxItems=obj.maxItems;
}if((typeof obj.request!="undefined")&&obj.request!==""){wp_e2[thisContainer][thisId].streamSettings[tab].request=obj.request;
}});
};
function getQueryLite(streamTab,guid,thisContainer,thisId,itemurl){var currContainer=(typeof thisContainer=="undefined")?wp_e2:wp_e2[thisContainer];
var currElement=(typeof thisContainer=="undefined"||typeof thisId=="undefined")?wp_e2:wp_e2[thisContainer][thisId];
var webType=(typeof currContainer.webType!=="undefined")?currContainer.webType.toLowerCase():"";
var guid=(!guid)?currContainer.guid:guid;
itemurl=(typeof itemurl=="undefined")?"":itemurl;
var streamTab=streamTab.toLowerCase();
wp_e2.MODERATOR_APPROVED="ModeratorApproved";
wp_e2.MODERATOR_BANNED="ModeratorBanned";
wp_e2.MODERATOR_DELETED="ModeratorDeleted";
wp_e2.COMMUNITY_FLAGGED="CommunityFlagged";
wp_e2.MODERATOR_FLAGGED="ModeratorFlagged";
wp_e2.SYSTEM_FLAGGED="SystemFlagged";
wp_e2.STREAM_BASE="http://www.washingtonpost.com";
wp_e2.UNTOUCHED="Untouched";
var itemMarkerQuery=((typeof currElement.streamSettings[streamTab].allowedItemMarkers!="undefined")?" markers: "+currElement.streamSettings[streamTab].allowedItemMarkers.toString()+" ":"");
var userMarkerQuery=((typeof currElement.streamSettings[streamTab].allowedUserMarkers!="undefined"&&currElement.streamSettings[streamTab].allowedUserMarkers.toString()!="")?" user.markers: "+currElement.streamSettings[streamTab].allowedUserMarkers.toString()+" ":"");
var stateQuery="";
if(currContainer.moderation_required===true){stateQuery="(state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+" ) ";
}else{stateQuery="(state:Untouched user.state:"+wp_e2.MODERATOR_APPROVED+") OR (state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+","+wp_e2.MODERATOR_DELETED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";
}var streamStateQuery="";
if(webType===wp_e2.WEBTYPE_PHOTO){streamStateQuery="(state:"+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";
}else{if(currContainer.moderation_required===true){streamStateQuery="(state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+" ) ";
}else{streamStateQuery="(state:Untouched user.state:"+wp_e2.MODERATOR_APPROVED+","+wp_e2.UNTOUCHED+") OR (state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+","+wp_e2.MODERATOR_DELETED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";
}}var markerQuery="";
if(itemMarkerQuery!=""&&userMarkerQuery!=""){markerQuery="("+itemMarkerQuery+" OR "+userMarkerQuery+") ";
}else{if(itemMarkerQuery!=""){markerQuery="("+itemMarkerQuery+") ";
}else{if(userMarkerQuery!=""){markerQuery="("+userMarkerQuery+")";
}}}var childrenStateQuery="";
if(currContainer.moderation_required===true){childrenStateQuery="(state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+" ) ";
}else{childrenStateQuery="(state:Untouched user.state:"+wp_e2.MODERATOR_APPROVED+") OR (state:"+wp_e2.COMMUNITY_FLAGGED+","+wp_e2.MODERATOR_APPROVED+" -user.state:"+wp_e2.MODERATOR_BANNED+","+wp_e2.MODERATOR_DELETED+") ";
}var filterQuery=" (("+stateQuery+") "+(markerQuery!=""?" AND "+markerQuery:"")+")  ";
var twitterQuery="";
if((typeof currContainer.source!="undefined"&&currContainer.source.indexOf("Twitter")>=0)){twitterQuery="("+currElement.streamSettings[streamTab].request+": "+guid+" ("+streamStateQuery+") "+markerQuery+" source:Twitter) ";
}var washpostQuery="";
if((typeof currContainer.source!="undefined"&&currContainer.source.indexOf("washpost.com")>=0)){washpostQuery="("+currElement.streamSettings[streamTab].request+": "+guid+" source:"+currContainer.source.toString()+filterQuery+" )";
}var streamIdQuery="";
if(typeof currContainer.streamId!="undefined"&&currContainer.streamId!=""){streamIdQuery="("+currElement.streamSettings[streamTab].request+":"+wp_e2.STREAM_BASE+"/"+currContainer.streamId+((typeof currElement.streamSettings[streamTab].allowedItemMarkers!=="undefined"&&currElement.streamSettings[streamTab].allowedItemMarkers.toString()!="")?" markers: "+currElement.streamSettings[streamTab].allowedItemMarkers.toString():"")+" ("+streamStateQuery+"))";
}var allCommentsQuery=(washpostQuery!="")?washpostQuery:"";
allCommentsQuery=allCommentsQuery+((streamIdQuery!=""&&allCommentsQuery!=="")?" OR "+streamIdQuery:streamIdQuery);
allCommentsQuery=allCommentsQuery+((twitterQuery!=""&&allCommentsQuery!=="")?" OR "+twitterQuery:twitterQuery);
if(itemurl==""){allCommentsQuery="("+allCommentsQuery+") itemsPerPage: 10 sortOrder: "+currElement.streamSettings[streamTab].sortOrder+" safeHTML:"+currElement.streamSettings[streamTab].safeHTML+" childrenSortOrder:"+currElement.streamSettings[streamTab].childrenSortOrder+" childrenItemsPerPage:"+currElement.streamSettings[streamTab].childrenItemsPerPage+" children: "+currElement.streamSettings[streamTab].childrenMaxDepth+"  (("+childrenStateQuery+") "+((streamTab==="top")?"":(markerQuery!=""?" AND "+markerQuery:""))+") ";
}var allCommentsQueryString="http://echoapi.wpdigital.net/v1/count?q="+allCommentsQuery+"&appkey="+wp_e2.appkey;
commentCountLite(allCommentsQuery);
}function commentCountLite(allCommentsQuery){var echoCountApi="http://echoapi.wpdigital.net/v1/count?q="+allCommentsQuery+"&appkey="+wp_e2.appkey;
var echoSearchApi="http://echoapi.wpdigital.net/v1/search?q="+allCommentsQuery+"&appkey="+wp_e2.appkey;
var allCommentsURL=wp_e2.echo_container_a.allCommentsURL;
var viewAllCommentsDiv='<div id="view-all-comments-ie78"><div id="view-all-comments-message-ie78"><p class="view-comments-link-ie78"><a href="'+allCommentsURL+'?ctab=all_&">View all comments &raquo;</a></p><p class="comment-controls-ie78"><a href="'+allCommentsURL+'?ctab=all_&">Add your comment | Reply to a comment | Recommend a comment | Report an offensive comment</a></p></div></div>';
var noCommentsDiv='<div class="echo-application-message"><span class="echo-application-message-icon echo-application-message-empty echo-primaryFont"><span class="note">No comments are available at the moment. <a href="'+allCommentsURL+'?ctab=all_&">Leave a comment</a></span></span></div>';
var numberOfComments=0;
var commentsUsedCounter=0;
var streamWrapper='<div class="echo-stream-container comments-wrapper-ie78"><div class="echo-stream-body"></div></div>';
var itemRootTop='<div class="echo-item-content"><div class="echo-item-container echo-item-container-root echo-item-depth-0"><div class="echo-item-wrapper echo-item-wrapper-root">';
var itemChildTop=' <div class="echo-item-content"><div class="echo-item-container echo-item-container-child echo-item-depth-1"><div class="echo-item-wrapper echo-item-wrapper-child">';
var itemAvatarWrapper='<div class="echo-item-subwrapper"><div class="echo-item-header-wrapper"><div class="echo-item-avatar-wrapper"><div class="echo-item-avatar">';
var itemAuthorWrapper='</div></div><div class="echo-item-authorName echo-linkColor">';
var itemTimeWrapper='</div><div class="echo-item-date">';
var itemTextWrapper='</div></div><div class="echo-item-subcontainer"><div class="echo-item-frame"><div class="echo-item-modeSwitch echo-clickable" style="display: none; "></div><span></span><div class="echo-clear"></div><div class="echo-item-data"><div class="echo-item-re"></div><div class="echo-item-body echo-primaryColor"><span class="echo-item-text">';
var itemBottom='</span></div></div></div></div><div class="echo-clear"></div></div></div><div class="echo-clear"></div></div></div>';
$("span.count-bubble-number").each(function(index,el){jQuery.ajax({url:echoCountApi,dataType:"jsonp",cache:false,context:el,success:function(data,status){if(data.count){$(el).html(data.count);
}else{if(data.errorCode=="more_than"){$(el).html("5000+");
}else{$(el).html("0");
}}},error:function(data,status){$(el).html("0");
}});
});
$("div#echo_comment_stream").append(streamWrapper).addClass("echo-ui");
$("div.echo-stream-body").each(function(index,el){$("div#comments").addClass("comments-full-wrapper-ie78");
jQuery.ajax({url:echoSearchApi,dataType:"jsonp",cache:false,context:el,success:function(data,status){if(status!="error"&&data.entries!="undefined"){if(data.entries.length>0){numberOfComments=data.entries.length;
var i=0;
while(i<numberOfComments&&commentsUsedCounter<3){if(data.entries[i].object.status!="ModeratorDeleted"){var formattedTimeDate=new Date();
formattedTimeDate.setISO8601(data.entries[i].object.published);
currDateFmt=formattedTimeDate.format("h:MM TT Z");
prevDateFmt=formattedTimeDate.format("m/d/yyyy h:MM TT Z");
if(formattedTimeDate.format("m/d/yyyy")==new Date().format("m/d/yyyy")){formattedTimeDate=currDateFmt;
}else{formattedTimeDate=prevDateFmt;
}var itemText=new String(data.entries[i].object.content);
var formattedItemText=itemText.replace(/\n+/g,"<br><br>");
if(data.entries[i].targets[0].id!=data.entries[i].targets[0].conversationID){$(el).append(itemRootTop+itemAvatarWrapper+'<img src="'+data.entries[i].actor.avatar+'">'+itemAuthorWrapper+data.entries[i].actor.title+itemTimeWrapper+formattedTimeDate+itemTextWrapper+formattedItemText+itemBottom);
if(commentsUsedCounter==0){currentItemContainer=$("div.echo-item-container")[commentsUsedCounter];
$(currentItemContainer).css("border-top","none");
}if(data.entries[i].actor.markers!=undefined){markersObject=data.entries[i].actor.markers;
markersNum=data.entries[i].actor.markers.length;
currentItemSubWrapper=$("div.echo-item-subwrapper")[i];
for(x=0;
x<markersNum;
x++){markerString=markersObject[x];
$(currentItemSubWrapper).addClass("echo-item-user-marker-"+markerString);
markerDivString='<div class="marker"><span class="marker echo-item-user-'+markerString+'"></span></div>';
$(currentItemSubWrapper).prepend(markerDivString);
}}if(data.entries[i].object.markers!=undefined){markersObject=data.entries[i].object.markers;
markersNum=data.entries[i].object.markers.length;
currentItemSubWrapper=$("div.echo-item-subwrapper")[i];
for(x=0;
x<markersNum;
x++){if(markersObject[x]=="post_recommended"){markerString=markersObject[x];
$(currentItemSubWrapper).addClass("echo-item-marker-"+markerString);
markerDivString='<div class="marker"><span class="marker echo-item-marker-'+markerString+'"></span></div>';
$(currentItemSubWrapper).prepend(markerDivString);
}}}}else{$(el).append(itemChildTop+itemAvatarWrapper+'<img src="'+data.entries[i].actor.avatar+'">'+itemAuthorWrapper+data.entries[i].actor.title+itemTimeWrapper+formattedTimeDate+itemTextWrapper+formattedItemText+itemBottom);
if(data.entries[i].actor.markers!=undefined){markersObject=data.entries[i].actor.markers;
markersNum=data.entries[i].actor.markers.length;
currentItemSubWrapper=$("div.echo-item-subwrapper")[i];
for(x=0;
x<markersNum;
x++){markerString=markersObject[x];
$(currentItemSubWrapper).addClass("echo-item-user-marker-"+markerString);
markerDivString='<div class="marker"><span class="marker echo-item-user-'+markerString+'"></span></div>';
$(currentItemSubWrapper).prepend(markerDivString);
}}if(data.entries[i].object.markers!=undefined){markersObject=data.entries[i].object.markers;
markersNum=data.entries[i].object.markers.length;
currentItemSubWrapper=$("div.echo-item-subwrapper")[i];
for(x=0;
x<markersNum;
x++){if(markersObject[x]=="post_recommended"){markerString=markersObject[x];
$(currentItemSubWrapper).addClass("echo-item-marker-"+markerString);
markerDivString='<div class="marker"><span class="marker echo-item-marker-'+markerString+'"></span></div>';
$(currentItemSubWrapper).prepend(markerDivString);
}}}}}i++;
commentsUsedCounter++;
if(commentsUsedCounter==3||commentsUsedCounter==numberOfComments){$(el).append(viewAllCommentsDiv);
}}}else{$(el).prepend(noCommentsDiv);
}}else{$(el).prepend(noCommentsDiv);
}},error:function(data,status){$(el).prepend(noCommentsDiv);
}});
$("span.weigh-in").remove();
$("div.stream-header-info").remove();
$("ul.header-primary").css("display","none");
$("div#comment-info-links").append('<span class="about-badges"> | <a href="http://www.washingtonpost.com/wp-srv/interactivity/get-a-badge.html">About Badges</a></span>');
});
}$(document).ready(function(){wp_e2.initCommentCountLite();
wp_e2.initCommentStreamLite();
getQueryLite(thisStreamTab,thisEchoGUID,thisEchoContainer,thisEchoId,thisItemurl);
});
