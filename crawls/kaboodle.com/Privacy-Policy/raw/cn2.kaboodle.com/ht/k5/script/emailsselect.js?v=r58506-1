(function(d,e){var b=function(f,g){if(typeof(g)!="function"){throw"Not a function"}var h=Array.prototype.slice.call(arguments,2);return function(){var i=h.concat(Array.prototype.slice.call(arguments));return g.apply(f,i)}};var a=function(g,f){return g.replace(/\{([^\}]+)\}/gi,function(i,h){return typeof(f[h])=="undefined"?h:f[h]})};var c=function(g,h){if(!g.is("input[type=text]")){d.error("$.emailsSelect: Element is not a text input");return null}this.options=h;g.wrap('<div class="emailsSelectWrap"><label></label></div>').closest("label").append('<span class="fieldplaceholder"></span><span class="errorBubble">Error test here</span>').closest(".emailsSelectWrap").prepend('<span class="items"></span>');var f=g.attr("placeholder");f=h.placeholder||f;g.attr("placeholder","").closest("label").find(".fieldplaceholder").text(f);g.bind({focus:b(this,this.focusHandler,g),blur:b(this,this.blurHandler,g),paste:b(this,this.pasteHandler,g),keyup:b(this,this.keyupHandler,g),keydown:b(this,this.keydownHandler,g)});g.closest(".emailsSelectWrap").click(b(this,function(i){i.focus();return false},g));if(h.autocomplete){this.createAutocomplete(g,h.autocomplete)}if(!!h.value){this.setVal(g,h.value)}return{getvalue:b(this,this.getVal,g),setvalue:b(this,this.setVal,g)}};c.prototype={selectedItems:null,options:null,focusHandler:function(g,f){this.toggleError(g,false);g.closest("label").find(".fieldplaceholder").hide()},blurHandler:function(g,f){this.toggleError(g,false);if(!d.trim(g.val())){g.closest("label").find(".fieldplaceholder").show()}},pasteHandler:function(g,f){this.toggleError(g,false)},keyupHandler:function(g,f){var h=d.trim(g.val());if(h&&({";":true,",":true})[h[h.length-1]]){g.val(h.replace(/[;,]/gi,""));this.addItem(g)}},removeItem:function(g,h){this.toggleError(g,false);if(h){if(this.selectedItems){var f=h.data("item.emailsSelect").value+","}var i=d("#msgToID").val();i=i.replace(f,"");d("#msgToID").val(i);delete this.selectedItems[h.data("item.emailsSelect")];h.remove()}return false},validate:function(f,h){var g=true;if(!!this.options.validate){if(typeof(this.options.validate)=="function"){g=this.options.validate(h)}else{if(typeof(this.options.validate)=="string"){g=new RegExp(this.options.validate,"i").test(h)}else{if(!!this.options.validate&&typeof(this.options.validate.test)=="function"){g=this.options.validate.test(h)}}}g=typeof(g)==e?true:!!g}this.toggleError(f,!g?"Please enter a valid Email address":!!g);return g},addItem:function(g,f){var j=d.extend({value:d.trim(g.val())},(f||{}));this.selectedItems=this.selectedItems||{};if(j&&(f||this.validate(g,j.value))){var h=d(a((this.options.tagtemplate||c.defaults.tagtemplate),j));h.appendTo(g.closest(".emailsSelectWrap").find(".items")).find(".emailsSelectItemCloseBtn").click(b(this,this.removeItem,g,h));var i=d("#msgToID").val();i=i+g.val()+",";d("#msgToID").val(i);h.data("item.emailsSelect",j);g.val("").focus();this.selectedItems[j.value]=true}},keydownHandler:function(g,f){this.toggleError(g,false);var h;switch(f.which){case 13:case 9:case 32:h=false;this.addItem(g);break;case 8:h=this.checkRemove(g);default:console.log(f.which);break}return h},checkRemove:function(g){var i=g.val();if(i.length==0){var h=g.closest(".emailsSelectWrap").find(".items").children().last();var f=h.data("item.emailsSelect");if(h.length>0&&!!f){this.removeItem(g,h);g.val(f.value);return false}}return true},toggleError:function(g,h){var f=g.closest(".emailsSelectWrap").toggleClass("error",!!h);if(typeof(h)=="string"&&!!h){f.find(".errorBubble").text(h)}},getVal:function(f){var g=[];f.closest(".emailsSelectWrap").find(".items").children().each(function(){var h=d(this).data("item.emailsSelect");if(h&&"value" in h){g.push(h.value)}});return g},setVal:function(h,k){var g=[];if(typeof(k)=="string"||k instanceof String){g=k.split(new RegExp("["+(this.options.separator||"").replace(/([\.\[\]\{\}\(\)\-\_])/ig,"\\$1")+"]","i"))}else{if(k instanceof Array){g=k}}for(var j=0,f=g.length;j<f;j++){if(!!g[j]){this.addItem(h,((typeof(g[j])=="string"||g[j] instanceof String)?{value:g[j]}:g[j]))}}},autocompleteSelect:function(f,g,h){this.addItem(f,h.item);if(typeof(this.options.autocomplete.onitemselect)=="function"){return this.options.autocomplete.onitemselect(h.item)}else{return false}},createAutocomplete:function(n,h){if(!!h.labelprop){var f=h.labelprop||"value";for(var p=0,m=h.source.length;p<m;p++){var q=h.source[p];if(!!q&&(!q.value||!q.label)){q.value=q[f]}}}delete h.focus;delete h.select;var k=d.extend({focus:function(i,l){n.val(l.item[h.labelprop]);return false},select:b(this,this.autocompleteSelect,n)},h);for(var g in c.defaults.autocomplete){if(k.hasOwnProperty(g)){delete k[g]}}var j=n.autocomplete(k).data("autocomplete");j._resizeMenu=function(){var i=this.element.closest(".emailsSelectWrap");this.menu.element.outerWidth(i.outerWidth());this.options.position=this.options.position||{};this.options.position.of=i;this.options.position.offset="0 -5"};j._renderItem=function(i,l){if(!this.selectedItems||!this.selectedItems[l.value]){return d('<li class="listItem"></li>').addClass(h.itemClass).data("item.autocomplete",l).append(a((h.itemtemplate||c.defaults.autocomplete.itemtemplate),l)).appendTo(i.addClass("emailsSelectAutocomplete"+(h.listClass||"")))}}}};c.defaults={placeholder:"",value:"",separator:",",validate:"^\\w[a-z0-9\\-_\\.]*\\@\\w[a-z0-9\\-_\\.]*\\.\\w\\w+$",tagtemplate:'<span class="emailsSelectItem">{value}<span class="emailsSelectItemCloseBtn">x</span></span>',autocomplete:{itemClass:"",labelprop:"label",itemtemplate:"<a>{label}</a>"}};c.create=function(g,f){var h=g.data("emailsSelect");if(!h){var i=d.extend({},this.defaults,f);if(!("autocomplete" in (f||{}))){delete i.autocomplete}h=new this(g,i);if(h){g.data("emailsSelect",h)}}return h};c.callMethod=function(h,f,g){var i=h.data("emailsSelect");if(i){if(typeof(i[f])=="function"){return i[f].apply(i,g)}else{d.error("$.emailsSelect  has no method "+f)}}else{d.error("Element "+h.selector+" is not an $.emailsSelect")}};d.fn.emailsSelect=function(f){if(typeof(f)=="object"||!f){return this.each(function(){return c.create(d(this),f)})}else{if(typeof(f)=="string"){return this.each(function(){return c.callMethod(d(this),f,Array.prototype.slice.call(arguments,1))})}else{d.error("$.emailsSelect: not supported")}}}})(jQuery);