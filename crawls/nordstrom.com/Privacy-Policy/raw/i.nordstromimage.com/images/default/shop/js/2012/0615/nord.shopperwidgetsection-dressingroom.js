
(function(window,$,undefined){"use strict";'nord'in window||(window.nord={});'shopperWidgetSection'in window.nord||(window.nord.shopperWidgetSection={});$.extend(nord.shopperWidgetSection,{dressingRoom:{settings:{cssClass:{fullDressingRoom:'full',newItem:'new-dressing-room-item',removedItem:'removed-dressing-room-item'},dataAttr:{alias:'data-alias',brand:'data-brand',colorId:'data-color-id',flaggedForRemoval:'data-flagged-for-removal',itemId:'data-item-id',photoGroupId:'data-photo-group-id',priceRegular:'data-price-regular',priceSale:'data-price-sale',pricePercentOff:'data-price-percent-off',styleId:'data-style-id'},dataKey:{roomId:'dressingRoomId',tooltipText:'nordTooltipText',tooltipTitle:'nordTooltipTitle',unshownItemCount:'unshownItemCount'},selector:{deleteButton:'.delete-item',addToBagButton:'.item-add-to-bag',dropIndicator:'.drop-placement-indicator',dropTarget:'.shopper-widget-scroll-content',emptyItem:'.empty-item',emptyItemTemplate:'#dressing-room-empty-item-template',errorItem:'.error-item',errorItemTemplate:'#dressing-room-error-item-template',fashionItem:'.fashion-item',fashionPhoto:'div.fashion-photo',fullDressingRoom:'.full',helpIndicator:'.help-indicator',itemImageContainer:'.item-image',item:'.dressing-room-item',itemAddToBagButton:'.item-add-to-bag',itemInfo:'.item-info',itemOptions:'.item-options',itemTemplate:'#dressing-room-item-template',itemUnavailableOverlayTemplate:'#dressing-room-item-unavailable-overlay-template',outfit:'.outfit',removedItem:'.removed-dressing-room-item',scrollContainer:'.shopper-widget-scroll',section:'#dressing-room-shopper-widget-section',sectionContent:'.shopper-widget-section-content',widget:'#shopper-widget',widgetContent:'.shopper-widget-content'},easing:'swing',fadeSpeed:250,scrollSpeed:250,resizeSpeed:400},init:function(dressingRoomSection){this.sectionElement=dressingRoomSection||$(this.settings.selector.section);nord.dressingRoom.roomId=this.sectionElement.data(this.settings.dataKey.roomId);this.unshownItemCount=this.sectionElement.data(this.settings.dataKey.unshownItemCount)||0;if(!$.isNumeric(this.unshownItemCount)){this.unshownItemCount=0;}
this._setupInteraction();this._bindEvents();},_makeFashionItemsDraggable:function(){var
context=this,fashionItems=$([this.settings.selector.fashionItem,'[',this.settings.dataAttr.styleId,']:not(.ui-draggable, ',this.settings.selector.outfit,')'].join(''));if(fashionItems.length==0){return;}
fashionItems.draggable({cursorAt:{'top':nord.galleryImages.sizes.thumbnail.height/2,'left':nord.galleryImages.sizes.thumbnail.width/2},handle:this.settings.selector.fashionPhoto,helper:function(e){var
fashionItem=$(this),fashionImg=fashionItem.find(context.settings.selector.fashionPhoto+' img'),helper=fashionItem.find(context.settings.selector.fashionPhoto).clone();helper.removeAttr('style').addClass(context.settings.cssClass.newItem).find('img').attr('src',nord.galleryImages.getImageUrl(fashionItem.attr(context.settings.dataAttr.photoGroupId),'medium')).removeAttr('style').css({height:fashionImg.height(),width:fashionImg.width()}).end().prependTo('body');return helper;},opacity:0.9,start:function(e,ui){var
img=ui.helper.find('img'),shopperWidget=$(context.settings.selector.widget);function openSectionAccordion(){if(!context.sectionElement.hasClass(nord.shopperWidget.settings.cssClass.expanded)){context.sectionElement.nordAccordion('change',context.sectionElement.find(context.settings.selector.sectionContent));}}
if(!shopperWidget.hasClass(nord.shopperWidget.settings.cssClass.expanded)){shopperWidget.nordAccordion('change',shopperWidget.find(context.settings.selector.widgetContent),openSectionAccordion);}else{openSectionAccordion();}
if(parseInt(img.width(),10)!==nord.galleryImages.sizes.thumbnail.width){img.animate({height:nord.galleryImages.sizes.thumbnail.height,width:nord.galleryImages.sizes.thumbnail.width},context.settings.resizeSpeed,context.settings.easing);}},zIndex:10001});},_cleanupFashionItemDrop:function(e){var dropIndicator=$(e.target).find(this.settings.selector.dropIndicator);if(dropIndicator.is(':visible')){dropIndicator.fadeOut(this.settings.fadeSpeed,this.settings.easing);}},_setupInteraction:function(){var context=this;this._makeFashionItemsDraggable();$(document).on('FashionResults.ResultsReturned Recommendations.ResultsReturned',function(){context._makeFashionItemsDraggable();});this.sectionElement.droppable({accept:context.settings.selector.fashionItem,drop:function(e,ui){var
fashionItem=ui.draggable.closest(context.settings.selector.fashionItem),styleId=fashionItem.attr(context.settings.dataAttr.styleId),photoGroupId=fashionItem.attr(context.settings.dataAttr.photoGroupId);if(fashionItem.is(context.settings.selector.outfit)){context.addOutfit(styleId);}else{context.addItem({"StyleId":styleId,"ColorId":fashionItem.attr(context.settings.dataAttr.colorId)||null,"PhotoGroupId":photoGroupId,"ImageUrl":nord.galleryImages.getImageUrl(photoGroupId,'thumbnail'),"StyleInfo":{"isAvailable":true}},ui.helper.find('img').clone().removeAttr('style'));}
cmCreateElementTag('Dressing Room Widget','Drag to Widget','-_--_--_--_--_--_--_-'+styleId);context._cleanupFashionItemDrop(e);},out:function(e){context._cleanupFashionItemDrop(e);},over:function(e,ui){var scrollContainer=context.sectionElement.find(context.settings.selector.scrollContainer);scrollContainer.animate({'scrollTop':0},scrollContainer.scrollTop()>0?context.settings.scrollSpeed:0,context.settings.easing,function(){context.sectionElement.find(context.settings.selector.dropIndicator).fadeIn(context.settings.fadeSpeed,context.settings.easing);});},tolerance:'pointer'}).on('mouseover',this.settings.selector.item+':not(.ui-draggable, '+this.settings.selector.emptyItem+')',function(e){$(this).draggable({helper:function(e){return $(this).find('img').clone().prependTo('body');},opacity:0.9,stop:function(e,ui){var
originalItem=$(e.target),draggedItem=ui.helper;draggedItem.remove();if(draggedItem.is('['+context.settings.dataAttr.flaggedForRemoval+'=true]')){context.removeItem(originalItem,true);}},zIndex:10001});}).find(this.settings.selector.sectionContent).droppable({accept:this.settings.selector.item,over:function(e,ui){ui.helper.removeAttr(context.settings.dataAttr.flaggedForRemoval);},out:function(e,ui){ui.helper.attr(context.settings.dataAttr.flaggedForRemoval,true);}}).end().find(this.settings.selector.scrollContainer).nordTooltip({descendantSelector:'[data-nord-tooltip]',mouseover:function(target){target.closest(context.settings.selector.item).addClass('active');},mouseout:function(target){target.closest(context.settings.selector.item).removeClass('active');},template:function(target){var styleId=target.closest(context.settings.selector.item).attr(context.settings.dataAttr.styleId);return nord.dressingRoom.getStyleTooltipTemplate(styleId,target,true);},useDelegate:true}).end().find(this.settings.selector.helpIndicator).nordTooltip({template:function(target){return['<div class="nord-tooltip help-tooltip">','<header><h1>',(target.data(context.settings.dataKey.tooltipTitle)||''),'</h1></header>','<p>',(target.data(context.settings.dataKey.tooltipText)||''),'</p>','</div>'].join('');}});},_bindEvents:function(){var context=this;this.sectionElement.on('click.removeItem.widget.dressingRoom',this.settings.selector.deleteButton,function(e){e.preventDefault();context.removeItem($(this).closest(context.settings.selector.item),true);}).on('click.addToBag.widget.dressingRoom',this.settings.selector.addToBagButton,function(e){e.preventDefault();var styleInfo=nord.dressingRoom.getPreBagItemData($(this).closest(context.settings.selector.item));nord.preBagModal.init(styleInfo);});},addItem:function(itemData,itemImg){if(this.checkForFullDressingRoom()){return;}
itemImg||(itemImg=$('<img src="'+itemData.ImageUrl+'">'));var
context=this,template=this.sectionElement.find(this.settings.selector.itemTemplate).html(),target=this.sectionElement.find(context.settings.selector.dropTarget),item=$(Mustache.render(template,itemData)).find(this.settings.selector.itemImageContainer).append(itemImg).end();if(itemData.hasOwnProperty('Styleid')){item.attr(context.settings.dataAttr.styleId,itemData.Styleid);}
target.prepend(item);$('<img src="'+itemData.ImageUrl+'">').on('load',function(e){var thumb=$(this);itemImg.attr('src',thumb.attr('src'));thumb.remove();});this.recalcEmptyItems(target.find(this.settings.selector.item));nord.dressingRoom.makeApiCall(nord.dressingRoom.roomId,{data:itemData,success:function(data,status,xhr){var
itemOptions=item.find(context.settings.selector.itemOptions),itemInfo=itemOptions.find(context.settings.selector.itemInfo);if((!$.isNumeric(nord.dressingRoom.roomId)||nord.dressingRoom.roomId===0)){nord.dressingRoom.roomId=data.RoomId||nord.dressingRoom.roomId;}
item.attr(context.settings.dataAttr.itemId,data.Id);if(data.IsAvailable){itemInfo.attr(context.settings.dataAttr.brand,data.StyleInfo.BrandName).attr(context.settings.dataAttr.priceRegular,data.StyleInfo.RegularPrice).attr(context.settings.dataAttr.priceSale,data.StyleInfo.SalePrice).attr(context.settings.dataAttr.pricePercentOff,data.StyleInfo.PercentOff).attr(context.settings.dataAttr.alias,data.StyleInfo.PathAlias);}else{itemInfo.remove();itemOptions.after($(Mustache.render($(context.settings.selector.itemUnavailableOverlayTemplate).html(),{}))).find(context.settings.selector.itemAddToBagButton).remove().end();}
context.checkForFullDressingRoom();},error:function(xhr,status,error){console.log(error);}});},addOutfit:function(outfitId){nord.dressingRoom.makeApiCall(nord.dressingRoom.roomId,{itemId:outfitId,itemType:'os',success:function(data,status,xhr){},error:function(xhr,status,error){}});},removeItem:function(item,allowUndo){var context=this;item.addClass(this.settings.cssClass.removedItem);this.recalcEmptyItems(item.siblings());item.each(function(){var itemId=$(this).attr(context.settings.dataAttr.itemId);if(!itemId){return;}
nord.dressingRoom.makeApiCall(nord.dressingRoom.roomId,{itemId:itemId,type:'DELETE'});});this.checkForFullDressingRoom();},recalcEmptyItems:function(items){items=items.not(this.settings.selector.removedItem);if(items.length===0||this.unshownItemCount>0){return;}
var
parent=items.parent(),emptyItems=items.filter(this.settings.selector.emptyItem),mod=(items.length<=7&&emptyItems.length>=3)?6:3,emptyItemTarget=mod-(items.not(this.settings.selector.emptyItem).length%mod),emptyItemGap=emptyItemTarget-emptyItems.length,emptyItemTemplate=$(this.settings.selector.emptyItemTemplate).html(),i;if(emptyItemGap<0){emptyItems.filter(':gt('+(emptyItemTarget-1)+')').remove();}else{for(i=0;i<emptyItemGap;i++){parent.append(emptyItemTemplate);}}},checkForFullDressingRoom:function(){var
dropTarget=this.sectionElement.find(this.settings.selector.dropTarget),errorItem=dropTarget.find(this.settings.selector.errorItem),itemCount=this.sectionElement.find(this.settings.selector.item+':not('+this.settings.selector.emptyItem+','+this.settings.selector.removedItem+')').length;if(itemCount+this.unshownItemCount>=PageParameters.dressingRoomMaxStyles){this.sectionElement.addClass(this.settings.cssClass.fullDressingRoom);if(errorItem.length==0){dropTarget.prepend(Mustache.render(this.sectionElement.find(this.settings.selector.errorItemTemplate).html(),{}));}
return true;}else{this.sectionElement.removeClass(this.settings.cssClass.fullDressingRoom);errorItem.remove();return false;}}}});$(function(){var dressingRoomSection=$(nord.shopperWidgetSection.dressingRoom.settings.selector.section);if(dressingRoomSection.length>0){nord.shopperWidgetSection.dressingRoom.init(dressingRoomSection);}});})(window,jQuery);