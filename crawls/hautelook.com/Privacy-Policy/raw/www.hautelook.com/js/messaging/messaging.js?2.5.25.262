var messaging=function(n){function i(a){var c=$(document.createElement(a.type));typeof a.opts!="undefined"&&$.each(a.opts,function(d,e){c.attr(d,e)});typeof a.txt!="undefined"&&c.html(a.txt);typeof a.where=="undefined"?c.appendTo(a.into):c.prependTo(a.into);return c}var b=$.extend(true,{},{shadowbox:{content:null,height:110,initialHeight:110,initialWidth:310,player:"html",title:null,width:310,options:{animSequence:"sync",enableKeys:false,setKeys:{"27":"Shadowbox.close()"},onFinish:function(){},onClose:function(){$(document).trigger("shadowbox_closed")},
modal:true}},base_url:false,cache_html:true,additional_params:"",cache_response:false,require_response:true,messaging_id:false},n),j=false,g=false,k=0,l=0,h={init:function(){document.getElementById("messaging_popups")||i({into:"body",type:"div",opts:{id:"messaging_popups",style:"display: none;"}});if(b.messaging_id===false||$("#"+b.messaging_id).length==1){b.messaging_id=b.base_url.replace(/-/,"_")+"_"+String((new Date).getTime()).replace(/\D/gi,"");i({into:$("#messaging_popups"),type:"div",opts:{id:"messaging_placeholder_"+
b.messaging_id,style:"width:"+b.shadowbox.initialWidth+"px; height:"+b.shadowbox.initialHeight+"px;"}});i({into:"#messaging_placeholder_"+b.messaging_id,type:"div",opts:{id:b.messaging_id,"class":"messaging"}});b.shadowbox.href="#messaging_placeholder_"+b.messaging_id;h.getHtml()}},getHtml:function(){$.ajax({url:"/messaging/"+(b.cache_html?"cache/":"")+b.base_url+"/html"+b.additional_params,cache:true,success:function(a){if($("#"+b.messaging_id).length==1){$("#"+b.messaging_id).empty();$("#"+b.messaging_id).html(a)}else i({into:$("#messaging_popups"),
type:"div",opts:{id:b.messaging_id,"class":"messaging"},txt:a})}})},getResponse:function(a,c,d){if(typeof a=="undefined"||a===null)a={empty:0};$.ajax({type:"post",url:"/messaging/"+(b.cache_response?"cache/":"")+b.base_url+b.additional_params,data:a,dataType:"json",success:function(e){if(b.cache_response)j=e;g||h.processResponseAndDisplayShadowbox($.extend(true,a,e),c,d)}})},processResponseAndDisplayShadowbox:function(a,c,d){if(typeof a.success!="undefined"&&a.success===true&&g===false){g=true;$.each(a.data.messaging_js,
function(e,f){k+=1;$.getScript(f,function(){k-=1})});$.each(a.data.messaging_css,function(e,f){l+=1;$.getScript(f,function(){l-=1},"css")});$("#"+b.messaging_id).ready(function(){if(typeof a.data=="undefined")a.data={};var e=setInterval(function(){var f,m;if(k===0&&l===0){f=$("#messaging_placeholder_"+b.messaging_id);clearInterval(e);b.shadowbox.content=f.html();m=f.find("#"+b.messaging_id).detach();b.shadowbox.options.onFinish=function(){g=false;if(typeof c=="function")c(a);else typeof c=="string"&&
typeof d=="string"&&window[d][c](a);m.appendTo(f)};Shadowbox.open(b.shadowbox)}},225)})}}};this.resize=function(){};this.close=function(a,c){Shadowbox.close();if(typeof a=="function")a(response);else typeof a=="string"&&typeof c=="string"&&window[c][a](response)};this.display=function(a,c,d){if(typeof Shadowbox.open==="function"&&!g){g=true;if(b.require_response)b.cache_response&&j!==false?h.processResponseAndDisplayShadowbox(j,c,d):h.getResponse(a,c,d);else h.processResponseAndDisplayShadowbox({success:true,
data:a},c,d);g=false}};h.init()};
