
var bach={version:"1.0.1"};
jQuery.Controller("bach.ChooseSource",{defaults:{srcs:"",playOn:"",errorOn:"error",onDone:$.noop,onFail:$.noop}},{init:function(){this.sourceCache={};this.defer();this.setSrc();this.bind(this.options.playOn,this.callback("play"));this.bind(this.options.errorOn,this.callback("errored"));},update:function(options){this.defer();this._super(options);this.setSrc();},getSrc:function(){var currSrc=String(this.options.srcs);var parsed;if(currSrc){var cache=this.sourceCache[currSrc];if(typeof cache!="undefined"){return cache;}
parsed=this.parseSource(currSrc);}else{parsed=[];}
return this.sourceCache[currSrc]=parsed;},parseSource:function(src){return src.match(/[^\s]+/g);},setSrc:function(){var sources=this.getSrc();if(sources&&sources.length){this.element.prop("src",this.getSrc()[0]);this.element.get(0).load();}},fallBack:function(){var srcList=this.getSrc();var rejected=srcList.shift();if(!srcList.length){this.deferred.reject(this.makePromise(rejected));}else{this.setSrc();}},errored:function(){var err=this.element.prop("error");if(err&&err.code==err.MEDIA_ERR_SRC_NOT_SUPPORTED){this.fallBack();}else{this.deferred.reject(this.makePromise(this.getSrc()[0]));}}," loadeddata":function(el,ev){this.loaded();},makePromise:function(src){srcList=[].concat(src);return{srcs:function(){return srcList.concat([]);}}},loaded:function(){var loadedSrc=this.getSrc()[0];this.deferred.resolve(this.makePromise(loadedSrc));},defer:function(){if(this.deferred&&this.deferred.status=="pending"){this.deferred.reject(this.makePromise(this.getSrc()));delete this.deferred;}
this.deferred=$.Deferred();this.deferred.then(this.options.onDone,this.options.onFail);},play:function(){if(this.element.prop("paused")){this.element.get(0).play();}}});
jQuery.Controller("bach.ControlOverVideo",{events:{blocked:"bach:controlovervideoblocked",unblocked:"bach:controlovervideounblocked"},defaults:{touchEnd:"touchend",touchStart:"touchstart",enableOn:"pause",disableOn:"play webkitfullscreenchange"}},{init:function(){this.element.data("controls",Boolean(this.element.prop("controls")));this.setControls(this.element.data("controls"),0);this.bind(this.options.enableOn,"enable");this.bind(this.options.disableOn,"disable");},destroy:function(){this.disable();this._super();},saveUIState:function(){this.element.data("saveduistate",{currentTime:this.element.prop("currentTime"),volume:this.element.prop("volume"),muted:this.element.prop("muted"),paused:this.element.prop("paused")});},deleteUIState:function(){this.element.removeData("saveduistate");},hasUIChanged:function(){var previousState=this.element.data("saveduistate");return(previousState&&(previousState.paused!==this.element.prop("paused")||previousState.currentTime!==this.element.prop("currentTime")||previousState.volume!==this.element.prop("volume")||previousState.muted!==this.element.prop("muted")));},setControls:function(yes,delay){yes=Boolean(yes);if(typeof this.delayer!="undefined"){this.delayer.reject();delete this.delayer;}
if(delay){this.delayer=jQuery.Deferred(function(dfr){var tmr=window.setTimeout(doControls,delay);function doControls(){dfr.resolve(tmr);}
dfr.fail(function(){window.clearTimeout(tmr);});});this.delayer.done(this.callback("setControls",yes,0));}else{if(this.hasUIChanged()){this.saveUIState();this.setControls(yes,1500);}else{this.element.prop("controls",yes);this.element.trigger((yes)?this.constructor.events.blocked:this.constructor.events.unblocked);}}},enable:function(){if(this.element.prop("webkitDisplayingFullscreen")){return;}
this.saveUIState();this.setControls(false,0);},disable:function(){this.setControls(Boolean(this.element.data("controls")),0);this.deleteUIState();},"{touchStart}":function(el,ev){if(!this.element.prop("paused")){return;}
if(typeof this.delayer!="undefined"){this.delayer.reject();delete this.delayer;}
this.saveUIState();},"{touchEnd}":function(el,ev){if(!this.element.prop("paused")){return;}
if(this.element.prop("controls")){this.setControls(false,500);}else{this.saveUIState();this.setControls(true,0);this.setControls(false,1500);}}});
jQuery.Controller("bach.EchoEvents",{eventMapping:["abort","canplay","canplaythrough","durationchange","emptied","ended","error","loadeddata","loadedmetadata","loadstart","mozfullscreenchange","pause","play","playing","progress","ratechange","reset","seeking","seeked","stalled","suspend","timeupdate","volumechange","waiting","webkitfullscreenchange"],defaults:{echoIn:"echo",filterOut:"progress seeked seeking timeupdate"}},{init:function(){this.proxiedTypes={};var mappings=this.constructor.eventMapping;for(var i=0;i<mappings.length;i++){var nativeEventType=mappings[i];if(this.options.filterOut&&this.options.filterOut.indexOf(nativeEventType)>-1){continue;}
if(typeof this.options.echoIn=="function"){this.bind(nativeEventType,"proxyEcho");}else{var proxiedEventType=this.options.echoIn.concat(":",nativeEventType);this.proxiedTypes[nativeEventType]=proxiedEventType;this.bind(nativeEventType,"echo");}}},proxyEcho:function(el,ev){this.options.echoIn(el,ev);},echo:function(el,ev){var proxied_type=this.proxiedTypes[ev.type];if(proxied_type){this.element.trigger(proxied_type,ev);}}});
jQuery.Controller("bach.Player",{pluginName:"bach_player",listensTo:["stop"],defaults:{type:"video",height:"",width:"",buttonDownEvent:('ontouchstart'in window)?"touchstart":"mousedown",buttonUpEvent:('ontouchend'in window)?"touchend":"mouseup",buttonDoneEvent:"click"},mediaEventFilters:"abort canplay canplaythrough durationchange loadedmetadata mozfullscreenchange playing progress ratechange reset seeking seeked seeking timeupdate volumechange webkitfullscreenchange",supports:{audio:Boolean(window.HTMLAudioElement),video:Boolean(window.HTMLVideoElement)},plays:{inline:/ipad|xoom|gt-p/i.test(window.navigator.userAgent)},downloads:{video:/android|silk/i.test(window.navigator.userAgent)},buttonNames:{src:"bach:(video|audio)",playlist:"bach:playlist",player:"bach:player"},SEE_INITIAL:1,SEE_UI_LOADING:2,SEE_UI_LOADED:3,SEE_UI_RESET:4,SEE_UI_ERROR:5,SEE_MEDIA_EMPTY:6,SEE_MEDIA_LOADING:7,SEE_MEDIA_LOADED:8,SEE_MEDIA_ERROR:9,SEE_PLAYING:10,SEE_PAUSED:11,SEE_ENDED:12},{init:function(){this.currentMediaType(this.options.type);this.mediaView=this.element.find("div.BachMediaView");this.playlistView=this.element.find("div.BachPlaylistView");this.metadataView=this.element.find("div.BachMetadataView");this.playerStopButton=this.element.find("[name='bach:player']").filter("[value='stop']");this.see(this.constructor.SEE_INITIAL,this.seeing);this.loadUI(true);},update:function(options){this._super(options);},loadUI:function(){this.see(null,this.constructor.SEE_UI_LOADING);var video=$("<video>").addClass("BachMediaNone BachOnTop BachShade LayoutPTop LayoutPLeft LayoutMax PanelShadow").css("direction","ltr").prop({tabIndex:"1",webkitPlaysInline:true,controls:true}).appendTo(this.mediaView).bach_echo_events({filterOut:this.constructor.mediaEventFilters});if(this.constructor.downloads.video&&!this.constructor.plays.inline){this.delegate(video,"","playing",this.callback("see",video,this.constructor.SEE_ENDED));}
if(this.constructor.plays.inline&&!this.constructor.downloads.video){video.bach_control_over_video();}
var audio=$("<audio>").addClass("BachMediaNone BachOnTop LayoutPBottom LayoutPLeft LayoutMaxH PanelShadow").css("direction","ltr").prop({tabIndex:"1"}).appendTo(this.mediaView).bach_echo_events({filterOut:this.constructor.mediaEventFilters});var posters=this.playlistView.find("div.BachPosterView");if(posters.size()>1){var sweestak=this.playlistView.bach_sweestak({stak:"div.BachPosterView"}).controller();if(!sweestak){return this.see(null,this.constructor.SEE_UI_ERROR);}
this.currentPosterView(sweestak.getCurrStak());this.element.find(".BachOnTop").each(function(){$(this).css("zIndex",parseInt($(this).css("zIndex"))+sweestak.stakSize())});this.element.find("button").each(function(){$(this).attr("tabIndex","0").css("zIndex",$(this).css("zIndex")+1)});}else{this.currentPosterView($(posters.get(0)));}
return this.see(null,this.constructor.SEE_UI_LOADED);},see:function(media,request){switch(this.seeing){case request:break;case this.constructor.SEE_MEDIA_LOADING:this.seeMediaLoading(false);this.doSee(media,request);break;case this.constructor.SEE_ENDED:if(request==this.constructor.SEE_PAUSED){break;}
if(request==this.constructor.SEE_PLAYING){break;}
if(request==this.constructor.SEE_MEDIA_LOADING){break;}
if(request==this.constructor.SEE_MEDIA_LOADED){this.seeMediaLoading(false);break;}
this.doSee(media,request);break;default:this.doSee(media,request);}},doSee:function(media,request){switch(request){case this.constructor.SEE_INITIAL:this.seeCanvas(true);break;case this.constructor.SEE_UI_LOADING:this.seePlaylist(false);this.seeClock(true);break;case this.constructor.SEE_UI_RESET:break;case this.constructor.SEE_UI_LOADED:this.seePlaylist(true);this.seeClock(false);break;case this.constructor.SEE_UI_ERROR:this.seeClock(false);break;case this.constructor.SEE_MEDIA_EMPTY:this.seeMediaLoading(false);this.seeMedia(false);break;case this.constructor.SEE_MEDIA_LOADING:this.seeMediaLoading(true);break;case this.constructor.SEE_MEDIA_LOADED:this.seeMediaLoaded(media,true);break;case this.constructor.SEE_MEDIA_ERROR:this.seeMediaLoaded(false);this.seeMediaError(true);break;case this.constructor.SEE_PLAYING:this.seePlaying(media,true);break;case this.constructor.SEE_PAUSED:this.seePaused(media,true);break;case this.constructor.SEE_ENDED:this.seeEnded(media,true);break;default:this.seeCanvas(false);}
this.seeing=request;},seeCanvas:function(yes){if(this.options.height){this.element.height((yes)?this.options.height:"");}
if(this.options.width){this.element.width((yes)?this.options.width:"");}},seeClock:function(yes){this.element.find(".BachClock").toggleClass("LayoutHidden",!yes);},seeEnded:function(media,yes){var no=!yes;this.seeMedia(no);if(media.controllers(bach.ControlOverVideo).length){media.bach_control_over_video("disable");}
this.playerStopButton.toggleClass("LayoutHidden",no);media.currentTime=0.1;this.seeStoppable(no);this.seeMetadata(yes);},seeMedia:function(yes){if(this.playlistView.controllers(bach.Sweestak).length){this.playlistView.bach_sweestak("sweeble",!yes);}
this.mediaView.toggleClass("BachMediaNone",!yes).find(this.currentMediaType()).toggleClass("BachMediaNone",!yes);},seeMediaError:function(yes){this.playlistView.toggleClass("BachShader",yes);},seeMediaLoaded:function(media,yes){this.seeMetadata(false);this.seeMedia(yes);},seeMediaLoading:function(yes){this.playlistView.toggleClass("BachShader",yes);this.seeClock(yes);},seeMetadata:function(yes){this.currentPosterView().find("div.BachMetadataView").toggleClass("BachMediaNone",!yes);},seePlaying:function(media,yes){this.seeMetadata(!yes);this.seeStoppable(!yes);},seePaused:function(media,yes){this.seeStoppable(yes);},seePlaylist:function(yes){this.playlistView.toggleClass("BachMediaNone",!yes);},seeStoppable:function(yes){this.playerStopButton.toggleClass("LayoutHidden",!yes);},seePlayable:function(yes){this.currentPosterView().find("button.BachButtonStart").toggleClass("LayoutHidden",!yes);},currentMediaType:function(type){if(arguments.length||typeof type!=="undefined"){this._currentMediaType=type;}
return this._currentMediaType;},currentPosterView:function(el){if(arguments.length||typeof type!=="undefined"){this._currentPosterView=$(el);}
return this._currentPosterView;},startMedia:function(type,srcs){this.see(null,this.constructor.SEE_MEDIA_EMPTY);this.see(null,this.constructor.SEE_MEDIA_LOADING);var media=this.mediaView.find(type),loadedSrcs=new $.Deferred();this.currentMediaType(type);media.bach_choose_source({srcs:srcs,onDone:loadedSrcs.resolve,onFail:loadedSrcs.reject,playOn:(this.constructor.downloads[type])?"loadstart":"loadeddata",errorOn:(this.constructor.downloads[type])?"load":"error"});var failCallback=this.callback("see",media,this.constructor.SEE_ENDED);loadedSrcs.fail(function(failedSrcs){failCallback();});},play:function(el){if(el.get(0).prop("paused")){el.get(0).play();}},stop:function(){this.see(this.element.find(this.currentMediaType()),this.constructor.SEE_ENDED);},"button {buttonDoneEvent}":function(el){var v=$(el).val(),n=$(el).prop("name");if(n==this.constructor.buttonNames.playlist){return $("div.BachPlaylistView").trigger(v);}else if(n==this.constructor.buttonNames.player){return this.element.trigger(v);}else{var x=n.match(RegExp(this.constructor.buttonNames.src));if(x){var type=x[1];this.startMedia(type,v);}}},"div.BachPlaylistView bach:sweed":function(el,ev){this.currentPosterView(ev.target);this.see(null,this.constructor.SEE_UI_RESET);},"video,audio echo:loadeddata":function(el){this.see(el,this.constructor.SEE_MEDIA_LOADED);},"video,audio echo:ended":function(el){this.see(el,this.constructor.SEE_ENDED);},"video,audio echo:pause":function(el){if(el.prop("webkitDisplayingFullscreen")){this.see(el,this.constructor.SEE_ENDED);}else{this.see(el,this.constructor.SEE_PAUSED);}},"audio echo:play":function(el){el.css("webkitTransform","translateX(0)");},"video,audio echo:play":function(el){if(el.prop("webkitDisplayingFullscreen")){this.see(el,this.constructor.SEE_ENDED);}else{this.see(el,this.constructor.SEE_PLAYING);}},"video bach:controlovervideoblocked":function(){this.seeStoppable(false);},"video bach:controlovervideounblocked":function(){this.seeStoppable(true);}});
jQuery.Controller("bach.Sweestak",{pluginName:"bach_sweestak",defaults:{stak:"img",height:"100%",width:"100%",speed:420},canvasCss:"BachSweestak LayoutMask LayoutP",stakCss:"Swee LayoutMax Layout LayoutMask LayoutPTop LayoutPLeft StakShadow"},{init:function(){this.element.addClass(this.constructor.canvasCss).width(this.options.width);this.element.height(this.options.height);this.sweelength=this.element.width();this.currStak=0;this.stak();this.parent=this.element.offsetParent();this.bind(this.parent,"resize",$.throttle(500,this.callback("sweeSize")));this.sweeble(true);},update:function(options){var update_options=options;this._super(options);this.sweeSize();if(typeof update_options.stak!="undefined"){this.unStak(update_options.stak);this.stak();}
if(typeof options.height!="undefined"){this.element.height(this.options.height);}},sweeSize:function(){this.sweelength=$(this.parent).width();},destroy:function(){this._super();this.unStak();this.element.removeClass(this.constructor.canvasCss);},hasBackId:function(curr){return this.currStak>0;},hasNext:function(curr){return this.getNextId(curr)!==curr;},getBackId:function(curr){return Math.max(curr-1,0);},getNextId:function(curr){return Math.min(curr+1,this.staks.size()-1);},getCurrStak:function(){return this.staks.get(this.currStak);},backStak:function(){if(this.isSweeble&&this.hasBackId(this.currStak)){this.currStak=this.getBackId(this.currStak);this.swee(this.currStak,0,this.options.speed*0.5);this.sweed();}},nextStak:function(){if(this.isSweeble&&this.hasNext(this.currStak)){this.swee(this.currStak,this.sweelength,this.options.speed);this.currStak=this.getNextId(this.currStak);this.sweed();}},sweeble:function(yes){this.isSweeble=Boolean(yes);},_handleSwipe:function(event,phase,direction,distance){if(!this.isSweeble){return;}
if(phase=="move"&&(direction=="left"||direction=="right")){var duration=0;if(direction=="left"&&this.hasNext(this.currStak)){this.swee(this.currStak,distance,duration);}
else if(direction=="right"&&this.hasBackId(this.currStak)){this.swee(this.getBackId(this.currStak),this.sweelength-distance,duration);}}else if(phase=="cancel"){if(direction=="right"){this.swee(this.getBackId(this.currStak),this.sweelength,this.options.speed);}else if(direction=="left"){this.swee(this.currStak,0,this.options.speed);}}
else if(phase=="end"){if(direction=="right"){this.backStak();}else if(direction=="left"){this.nextStak();}}
return;},swee:function(imgIndex,distance,duration){$(this.staks.get(imgIndex)).css({"webkitTransitionDuration":(duration/1000).toFixed(1)+"s","webkitTransform":"translate3d("+(distance*-1).toString()+"px,0px,0px)"});},sweed:function(){$(this.getCurrStak()).trigger("bach:sweed");},stakSize:function(){return this.staks.size();},stak:function(){this.staks=this.find(this.options.stak).addClass(this.constructor.stakCss).css("overflow","hidden").swipe({triggerOnTouchEnd:true,swipeStatus:this.callback("_handleSwipe"),allowPageScroll:"vertical"});var size=this.staks.size();$.each(this.staks,function(i){var jel=$(this);jel.css("zIndex",String(size-i));});},unStak:function(selector){this.staks=this.find(selector).removeClass(this.constructor.stakCss).css("zIndex","");},"bach:back":function(){this.backStak();},"bach:next":function(){this.nextStak();}});