(function(){function af(b,o,n){if(b===o){return 0!==b||1/b==1/o}if(null==b||null==o){return b===o}b._chain&&(b=b._wrapped);o._chain&&(o=o._wrapped);if(b.isEqual&&ar.isFunction(b.isEqual)){return b.isEqual(o)}if(o.isEqual&&ar.isFunction(o.isEqual)){return o.isEqual(b)}var m=an.call(b);if(m!=an.call(o)){return !1}switch(m){case"[object String]":return b==""+o;case"[object Number]":return b!=+b?o!=+o:0==b?1/b==1/o:b==+o;case"[object Date]":case"[object Boolean]":return +b==+o;case"[object RegExp]":return b.source==o.source&&b.global==o.global&&b.multiline==o.multiline&&b.ignoreCase==o.ignoreCase}if("object"!=typeof b||"object"!=typeof o){return !1}for(var l=n.length;l--;){if(n[l]==b){return !0}}n.push(b);var l=0,j=!0;if("[object Array]"==m){if(l=b.length,j=l==o.length){for(;l--&&(j=l in b==l in o&&af(b[l],o[l],n));){}}}else{if("constructor" in b!="constructor" in o||b.constructor!=o.constructor){return !1}for(var i in b){if(ar.has(b,i)&&(l++,!(j=ar.has(o,i)&&af(b[i],o[i],n)))){break}}if(j){for(i in o){if(ar.has(o,i)&&!l--){break}}j=!l}}n.pop();return j}var ac=this,T=ac._,ak={},ao=Array.prototype,aj=Object.prototype,aq=ao.slice,Q=ao.unshift,an=aj.toString,g=aj.hasOwnProperty,R=ao.forEach,h=ao.map,ai=ao.reduce,ah=ao.reduceRight,ae=ao.filter,ad=ao.every,ab=ao.some,ag=ao.indexOf,Z=ao.lastIndexOf,aj=Array.isArray,f=Object.keys,aa=Function.prototype.bind,ar=function(b){return new am(b)};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=ar),exports._=ar):ac._=ar;ar.VERSION="1.3.3";var ap=ar.each=ar.forEach=function(b,m,l){if(b!=null){if(R&&b.forEach===R){b.forEach(m,l)}else{if(b.length===+b.length){for(var j=0,i=b.length;j<i;j++){if(j in b&&m.call(l,b[j],j,b)===ak){break}}}else{for(j in b){if(ar.has(b,j)&&m.call(l,b[j],j,b)===ak){break}}}}}};ar.map=ar.collect=function(j,m,i){var l=[];if(j==null){return l}if(h&&j.map===h){return j.map(m,i)}ap(j,function(b,o,n){l[l.length]=m.call(i,b,o,n)});if(j.length===+j.length){l.length=j.length}return l};ar.reduce=ar.foldl=ar.inject=function(b,m,l,j){var i=arguments.length>2;b==null&&(b=[]);if(ai&&b.reduce===ai){j&&(m=ar.bind(m,j));return i?b.reduce(m,l):b.reduce(m)}ap(b,function(o,n,p){if(i){l=m.call(j,l,o,n,p)}else{l=o;i=true}});if(!i){throw new TypeError("Reduce of empty array with no initial value")}return l};ar.reduceRight=ar.foldr=function(b,n,m,l){var j=arguments.length>2;b==null&&(b=[]);if(ah&&b.reduceRight===ah){l&&(n=ar.bind(n,l));return j?b.reduceRight(n,m):b.reduceRight(n)}var i=ar.toArray(b).reverse();l&&!j&&(n=ar.bind(n,l));return j?ar.reduce(i,n,m,l):ar.reduce(i,n)};ar.find=ar.detect=function(j,m,i){var l;X(j,function(b,o,n){if(m.call(i,b,o,n)){l=b;return true}});return l};ar.filter=ar.select=function(j,m,i){var l=[];if(j==null){return l}if(ae&&j.filter===ae){return j.filter(m,i)}ap(j,function(b,o,n){m.call(i,b,o,n)&&(l[l.length]=b)});return l};ar.reject=function(j,m,i){var l=[];if(j==null){return l}ap(j,function(b,o,n){m.call(i,b,o,n)||(l[l.length]=b)});return l};ar.every=ar.all=function(j,m,i){var l=true;if(j==null){return l}if(ad&&j.every===ad){return j.every(m,i)}ap(j,function(b,o,n){if(!(l=l&&m.call(i,b,o,n))){return ak}});return !!l};var X=ar.some=ar.any=function(b,l,j){l||(l=ar.identity);var i=false;if(b==null){return i}if(ab&&b.some===ab){return b.some(l,j)}ap(b,function(n,m,o){if(i||(i=l.call(j,n,m,o))){return ak}});return !!i};ar.include=ar.contains=function(j,l){var i=false;if(j==null){return i}if(ag&&j.indexOf===ag){return j.indexOf(l)!=-1}return i=X(j,function(b){return b===l})};ar.invoke=function(b,j){var i=aq.call(arguments,2);return ar.map(b,function(l){return(ar.isFunction(j)?j||l:l[j]).apply(l,i)})};ar.pluck=function(b,i){return ar.map(b,function(j){return j[i]})};ar.max=function(b,l,j){if(!l&&ar.isArray(b)&&b[0]===+b[0]){return Math.max.apply(Math,b)}if(!l&&ar.isEmpty(b)){return -Infinity}var i={computed:-Infinity};ap(b,function(n,m,o){m=l?l.call(j,n,m,o):n;m>=i.computed&&(i={value:n,computed:m})});return i.value};ar.min=function(b,l,j){if(!l&&ar.isArray(b)&&b[0]===+b[0]){return Math.min.apply(Math,b)}if(!l&&ar.isEmpty(b)){return Infinity}var i={computed:Infinity};ap(b,function(n,m,o){m=l?l.call(j,n,m,o):n;m<i.computed&&(i={value:n,computed:m})});return i.value};ar.shuffle=function(j){var i=[],l;ap(j,function(b,m){l=Math.floor(Math.random()*(m+1));i[m]=i[l];i[l]=b});return i};ar.sortBy=function(b,l,j){var i=ar.isFunction(l)?l:function(m){return m[l]};return ar.pluck(ar.map(b,function(n,m,o){return{value:n,criteria:i.call(j,n,m,o)}}).sort(function(n,m){var p=n.criteria,o=m.criteria;return p===void 0?1:o===void 0?-1:p<o?-1:p>o?1:0}),"value")};ar.groupBy=function(b,l){var j={},i=ar.isFunction(l)?l:function(m){return m[l]};ap(b,function(n,m){var o=i(n,m);(j[o]||(j[o]=[])).push(n)});return j};ar.sortedIndex=function(b,n,m){m||(m=ar.identity);for(var l=0,j=b.length;l<j;){var i=l+j>>1;m(b[i])<m(n)?l=i+1:j=i}return l};ar.toArray=function(b){return !b?[]:ar.isArray(b)||ar.isArguments(b)?aq.call(b):b.toArray&&ar.isFunction(b.toArray)?b.toArray():ar.values(b)};ar.size=function(b){return ar.isArray(b)?b.length:ar.keys(b).length};ar.first=ar.head=ar.take=function(j,i,l){return i!=null&&!l?aq.call(j,0,i):j[0]};ar.initial=function(j,i,l){return aq.call(j,0,j.length-(i==null||l?1:i))};ar.last=function(j,i,l){return i!=null&&!l?aq.call(j,Math.max(j.length-i,0)):j[j.length-1]};ar.rest=ar.tail=function(j,i,l){return aq.call(j,i==null||l?1:i)};ar.compact=function(b){return ar.filter(b,function(i){return !!i})};ar.flatten=function(b,i){return ar.reduce(b,function(j,l){if(ar.isArray(l)){return j.concat(i?l:ar.flatten(l))}j[j.length]=l;return j},[])};ar.without=function(b){return ar.difference(b,aq.call(arguments,1))};ar.uniq=ar.unique=function(b,l,j){var j=j?ar.map(b,j):b,i=[];b.length<3&&(l=true);ar.reduce(j,function(o,n,m){if(l?ar.last(o)!==n||!o.length:!ar.include(o,n)){o.push(n);i.push(b[m])}return o},[]);return i};ar.union=function(){return ar.uniq(ar.flatten(arguments,true))};ar.intersection=ar.intersect=function(b){var i=aq.call(arguments,1);return ar.filter(ar.uniq(b),function(j){return ar.every(i,function(l){return ar.indexOf(l,j)>=0})})};ar.difference=function(b){var i=ar.flatten(aq.call(arguments,1),true);return ar.filter(b,function(j){return !ar.include(i,j)})};ar.zip=function(){for(var b=aq.call(arguments),l=ar.max(ar.pluck(b,"length")),j=Array(l),i=0;i<l;i++){j[i]=ar.pluck(b,""+i)}return j};ar.indexOf=function(b,l,j){if(b==null){return -1}var i;if(j){j=ar.sortedIndex(b,l);return b[j]===l?j:-1}if(ag&&b.indexOf===ag){return b.indexOf(l)}j=0;for(i=b.length;j<i;j++){if(j in b&&b[j]===l){return j}}return -1};ar.lastIndexOf=function(j,i){if(j==null){return -1}if(Z&&j.lastIndexOf===Z){return j.lastIndexOf(i)}for(var l=j.length;l--;){if(l in j&&j[l]===i){return l}}return -1};ar.range=function(j,i,o){if(arguments.length<=1){i=j||0;j=0}for(var o=arguments[2]||1,n=Math.max(Math.ceil((i-j)/o),0),m=0,l=Array(n);m<n;){l[m++]=j;j=j+o}return l};var V=function(){};ar.bind=function(b,l){var j,i;if(b.bind===aa&&aa){return aa.apply(b,aq.call(arguments,1))}if(!ar.isFunction(b)){throw new TypeError}i=aq.call(arguments,2);return j=function(){if(!(this instanceof j)){return b.apply(l,i.concat(aq.call(arguments)))}V.prototype=b.prototype;var m=new V,n=b.apply(m,i.concat(aq.call(arguments)));return Object(n)===n?n:m}};ar.bindAll=function(b){var i=aq.call(arguments,1);i.length==0&&(i=ar.functions(b));ap(i,function(j){b[j]=ar.bind(b[j],b)});return b};ar.memoize=function(b,j){var i={};j||(j=ar.identity);return function(){var l=j.apply(this,arguments);return ar.has(i,l)?i[l]:i[l]=b.apply(this,arguments)}};ar.delay=function(j,i){var l=aq.call(arguments,2);return setTimeout(function(){return j.apply(null,l)},i)};ar.defer=function(b){return ar.delay.apply(ar,[b,1].concat(aq.call(arguments,1)))};ar.throttle=function(s,r){var q,p,o,n,m,l,b=ar.debounce(function(){m=n=false},r);return function(){q=this;p=arguments;o||(o=setTimeout(function(){o=null;m&&s.apply(q,p);b()},r));n?m=true:l=s.apply(q,p);b();n=true;return l}};ar.debounce=function(j,i,m){var l;return function(){var n=this,b=arguments;m&&!l&&j.apply(n,b);clearTimeout(l);l=setTimeout(function(){l=null;m||j.apply(n,b)},i)}};ar.once=function(j){var i=false,l;return function(){if(i){return l}i=true;return l=j.apply(this,arguments)}};ar.wrap=function(j,i){return function(){var b=[j].concat(aq.call(arguments,0));return i.apply(this,b)}};ar.compose=function(){var b=arguments;return function(){for(var i=arguments,j=b.length-1;j>=0;j--){i=[b[j].apply(this,i)]}return i[0]}};ar.after=function(j,i){return j<=0?i():function(){if(--j<1){return i.apply(this,arguments)}}};ar.keys=f||function(b){if(b!==Object(b)){throw new TypeError("Invalid object")}var j=[],i;for(i in b){ar.has(b,i)&&(j[j.length]=i)}return j};ar.values=function(b){return ar.map(b,ar.identity)};ar.functions=ar.methods=function(b){var j=[],i;for(i in b){ar.isFunction(b[i])&&j.push(i)}return j.sort()};ar.extend=function(b){ap(aq.call(arguments,1),function(i){for(var j in i){b[j]=i[j]}});return b};ar.pick=function(b){var i={};ap(ar.flatten(aq.call(arguments,1)),function(j){j in b&&(i[j]=b[j])});return i};ar.defaults=function(b){ap(aq.call(arguments,1),function(i){for(var j in i){b[j]==null&&(b[j]=i[j])}});return b};ar.clone=function(b){return !ar.isObject(b)?b:ar.isArray(b)?b.slice():ar.extend({},b)};ar.tap=function(j,i){i(j);return j};ar.isEqual=function(j,i){return af(j,i,[])};ar.isEmpty=function(b){if(b==null){return true}if(ar.isArray(b)||ar.isString(b)){return b.length===0}for(var i in b){if(ar.has(b,i)){return false}}return true};ar.isElement=function(b){return !!(b&&b.nodeType==1)};ar.isArray=aj||function(b){return an.call(b)=="[object Array]"};ar.isObject=function(b){return b===Object(b)};ar.isArguments=function(b){return an.call(b)=="[object Arguments]"};ar.isArguments(arguments)||(ar.isArguments=function(b){return !(!b||!ar.has(b,"callee"))});ar.isFunction=function(b){return an.call(b)=="[object Function]"};ar.isString=function(b){return an.call(b)=="[object String]"};ar.isNumber=function(b){return an.call(b)=="[object Number]"};ar.isFinite=function(b){return ar.isNumber(b)&&isFinite(b)};ar.isNaN=function(b){return b!==b};ar.isBoolean=function(b){return b===true||b===false||an.call(b)=="[object Boolean]"};ar.isDate=function(b){return an.call(b)=="[object Date]"};ar.isRegExp=function(b){return an.call(b)=="[object RegExp]"};ar.isNull=function(b){return b===null};ar.isUndefined=function(b){return b===void 0};ar.has=function(j,i){return g.call(j,i)};ar.noConflict=function(){ac._=T;return this};ar.identity=function(b){return b};ar.times=function(j,i,m){for(var l=0;l<j;l++){i.call(m,l)}};ar.escape=function(b){return(""+b).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")};ar.result=function(b,j){if(b==null){return null}var i=b[j];return ar.isFunction(i)?i.call(b):i};ar.mixin=function(b){ap(ar.functions(b),function(i){e(i,ar[i]=b[i])})};var d=0;ar.uniqueId=function(j){var i=d++;return j?j+i:i};ar.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var Y=/.^/,al={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"},W;for(W in al){al[al[W]]=W}var c=/\\|'|\r|\n|\t|\u2028|\u2029/g,a=/\\(\\|'|r|n|t|u2028|u2029)/g,U=function(b){return b.replace(a,function(j,i){return al[i]})};ar.template=function(b,l,j){j=ar.defaults(j||{},ar.templateSettings);b="__p+='"+b.replace(c,function(m){return"\\"+al[m]}).replace(j.escape||Y,function(n,m){return"'+\n_.escape("+U(m)+")+\n'"}).replace(j.interpolate||Y,function(n,m){return"'+\n("+U(m)+")+\n'"}).replace(j.evaluate||Y,function(n,m){return"';\n"+U(m)+"\n;__p+='"})+"';\n";j.variable||(b="with(obj||{}){\n"+b+"}\n");var b="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+b+"return __p;\n",i=new Function(j.variable||"obj","_",b);if(l){return i(l,ar)}l=function(m){return i.call(this,m,ar)};l.source="function("+(j.variable||"obj")+"){\n"+b+"}";return l};ar.chain=function(b){return ar(b).chain()};var am=function(b){this._wrapped=b};ar.prototype=am.prototype;var S=function(b,i){return i?ar(b).chain():b},e=function(b,i){am.prototype[b]=function(){var j=aq.call(arguments);Q.call(j,this._wrapped);return S(i.apply(ar,j),this._chain)}};ar.mixin(ar);ap("pop,push,reverse,shift,sort,splice,unshift".split(","),function(j){var i=ao[j];am.prototype[j]=function(){var l=this._wrapped;i.apply(l,arguments);var b=l.length;(j=="shift"||j=="splice")&&b===0&&delete l[0];return S(l,this._chain)}});ap(["concat","join","slice"],function(j){var i=ao[j];am.prototype[j]=function(){return S(i.apply(this._wrapped,arguments),this._chain)}});am.prototype.chain=function(){this._chain=true;return this};am.prototype.value=function(){return this._wrapped}}).call(this);shortcut={all_shortcuts:{},add:function(b,h,d){var g={type:"keydown",propagate:false,disable_in_input:false,target:document,keycode:false};if(!d){d=g}else{for(var a in g){if(typeof d[a]=="undefined"){d[a]=g[a]}}}var f=d.target;if(typeof d.target=="string"){f=document.getElementById(d.target)}var c=this;b=b.toLowerCase();var e=function(o){o=o||window.event;if(d.disable_in_input){var l;if(o.target){l=o.target}else{if(o.srcElement){l=o.srcElement}}if(l.nodeType==3){l=l.parentNode}if(l.tagName=="INPUT"||l.tagName=="TEXTAREA"){return}}if(o.keyCode){code=o.keyCode}else{if(o.which){code=o.which}}var n=String.fromCharCode(code).toLowerCase();if(code==188){n=","}if(code==190){n="."}var s=b.split("+");var r=0;var p={"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"};var m={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123};var q={shift:{wanted:false,pressed:false},ctrl:{wanted:false,pressed:false},alt:{wanted:false,pressed:false},meta:{wanted:false,pressed:false}};if(o.ctrlKey){q.ctrl.pressed=true}if(o.shiftKey){q.shift.pressed=true}if(o.altKey){q.alt.pressed=true}if(o.metaKey){q.meta.pressed=true}for(var j=0;k=s[j],j<s.length;j++){if(k=="ctrl"||k=="control"){r++;q.ctrl.wanted=true}else{if(k=="shift"){r++;q.shift.wanted=true}else{if(k=="alt"){r++;q.alt.wanted=true}else{if(k=="meta"){r++;q.meta.wanted=true}else{if(k.length>1){if(m[k]==code){r++}}else{if(d.keycode){if(d.keycode==code){r++}}else{if(n==k){r++}else{if(p[n]&&o.shiftKey){n=p[n];if(n==k){r++}}}}}}}}}}if(r==s.length&&q.ctrl.pressed==q.ctrl.wanted&&q.shift.pressed==q.shift.wanted&&q.alt.pressed==q.alt.wanted&&q.meta.pressed==q.meta.wanted){h(o);if(!d.propagate){o.cancelBubble=true;o.returnValue=false;if(o.stopPropagation){o.stopPropagation();o.preventDefault()}return false}}};this.all_shortcuts[b]={callback:e,target:f,event:d.type};if(f.addEventListener){f.addEventListener(d.type,e,false)}else{if(f.attachEvent){f.attachEvent("on"+d.type,e)}else{f["on"+d.type]=e}}},remove:function(a){a=a.toLowerCase();var d=this.all_shortcuts[a];delete (this.all_shortcuts[a]);if(!d){return}var b=d.event;var c=d.target;var e=d.callback;if(c.detachEvent){c.detachEvent("on"+b,e)}else{if(c.removeEventListener){c.removeEventListener(b,e,false)}else{c["on"+b]=false}}}};(function($){$.fn.markItUp=function(settings,extraSettings){var method,params,options,ctrlKey,shiftKey,altKey;ctrlKey=shiftKey=altKey=false;if(typeof settings=="string"){method=settings;params=extraSettings}options={id:"",nameSpace:"",root:"",previewHandler:false,previewInWindow:"",previewInElement:"",previewAutoRefresh:true,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:false,previewParserPath:"",previewParserVar:"data",resizeHandle:true,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};$.extend(options,settings,extraSettings);if(!options.root){$("script").each(function(a,tag){miuScript=$(tag).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==null){options.root=miuScript[1]}})}return this.each(function(){var $$,textarea,levels,scrollPosition,caretPosition,caretOffset,clicked,hash,header,footer,previewWindow,template,iFrame,abort;$$=$(this);textarea=this;levels=[];abort=false;scrollPosition=caretPosition=0;caretOffset=-1;options.previewParserPath=localize(options.previewParserPath);options.previewTemplatePath=localize(options.previewTemplatePath);if(method){switch(method){case"remove":remove();break;case"insert":markup(params);break;default:$.error("Method "+method+" does not exist on jQuery.markItUp")}return}function localize(data,inText){if(inText){return data.replace(/("|')~\//g,"$1"+options.root)}return data.replace(/^~\//,options.root)}function init(){id="";nameSpace="";if(options.id){id='id="'+options.id+'"'}else{if($$.attr("id")){id='id="markItUp'+($$.attr("id").substr(0,1).toUpperCase())+($$.attr("id").substr(1))+'"'}}if(options.nameSpace){nameSpace='class="'+options.nameSpace+'"'}$$.wrap("<div "+nameSpace+"></div>");$$.wrap("<div "+id+' class="markItUp"></div>');$$.wrap('<div class="markItUpContainer"></div>');$$.addClass("markItUpEditor");header=$('<div class="markItUpHeader"></div>').insertBefore($$);$(dropMenus(options.markupSet)).appendTo(header);footer=$('<div class="markItUpFooter"></div>').insertAfter($$);if(options.resizeHandle===true&&$.browser.safari!==true){resizeHandle=$('<div class="markItUpResizeHandle"></div>').insertAfter($$).bind("mousedown.markItUp",function(e){var h=$$.height(),y=e.clientY,mouseMove,mouseUp;mouseMove=function(e){$$.css("height",Math.max(20,e.clientY+h-y)+"px");return false};mouseUp=function(e){$("html").unbind("mousemove.markItUp",mouseMove).unbind("mouseup.markItUp",mouseUp);return false};$("html").bind("mousemove.markItUp",mouseMove).bind("mouseup.markItUp",mouseUp)});footer.append(resizeHandle)}$$.bind("keydown.markItUp",keyPressed).bind("keyup",keyPressed);$$.bind("insertion.markItUp",function(e,settings){if(settings.target!==false){get()}if(textarea===$.markItUp.focused){markup(settings)}});$$.bind("focus.markItUp",function(){$.markItUp.focused=this});if(options.previewInElement){refreshPreview()}}function dropMenus(markupSet){var ul=$("<ul></ul>"),i=0;$("li:hover > ul",ul).css("display","block");$.each(markupSet,function(){var button=this,t="",title,li,j;title=(button.key)?(button.name||"")+" [Ctrl+"+button.key+"]":(button.name||"");key=(button.key)?'accesskey="'+button.key+'"':"";if(button.separator){li=$('<li class="markItUpSeparator">'+(button.separator||"")+"</li>").appendTo(ul)}else{i++;for(j=levels.length-1;j>=0;j--){t+=levels[j]+"-"}li=$('<li class="markItUpButton markItUpButton'+t+(i)+" "+(button.className||"")+'"><a href="" '+key+' title="'+title+'">'+(button.name||"")+"</a></li>").bind("contextmenu.markItUp",function(){return false}).bind("click.markItUp",function(){return false}).bind("focusin.markItUp",function(){$$.focus()}).bind("mouseup",function(){if(button.call){eval(button.call)()}markup(button);return false}).bind("mouseenter.markItUp",function(){$("> ul",this).show();$(document).one("click",function(){$("ul ul",header).hide()})}).bind("mouseleave.markItUp",function(){$("> ul",this).hide()}).appendTo(ul);if(button.dropMenu){levels.push(i);$(li).addClass("markItUpDropMenu").append(dropMenus(button.dropMenu))}}});levels.pop();return ul}function magicMarkups(string){if(string){string=string.toString();string=string.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(x,a){var b=a.split("|!|");if(altKey===true){return(b[1]!==undefined)?b[1]:b[0]}else{return(b[1]===undefined)?"":b[0]}});string=string.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(x,a){var b=a.split(":!:");if(abort===true){return false}value=prompt(b[0],(b[1])?b[1]:"");if(value===null){abort=true}return value});return string}return""}function prepare(action){if($.isFunction(action)){action=action(hash)}return magicMarkups(action)}function build(string){var openWith=prepare(clicked.openWith);var placeHolder=prepare(clicked.placeHolder);var replaceWith=prepare(clicked.replaceWith);var closeWith=prepare(clicked.closeWith);var openBlockWith=prepare(clicked.openBlockWith);var closeBlockWith=prepare(clicked.closeBlockWith);var multiline=clicked.multiline;if(replaceWith!==""){block=openWith+replaceWith+closeWith}else{if(selection===""&&placeHolder!==""){block=openWith+placeHolder+closeWith}else{string=string||selection;var lines=[string],blocks=[];if(multiline===true){lines=string.split(/\r?\n/)}for(var l=0;l<lines.length;l++){line=lines[l];var trailingSpaces;if(trailingSpaces=line.match(/ *$/)){blocks.push(openWith+line.replace(/ *$/g,"")+closeWith+trailingSpaces)}else{blocks.push(openWith+line+closeWith)}}block=blocks.join("\n")}}block=openBlockWith+block+closeBlockWith;return{block:block,openWith:openWith,replaceWith:replaceWith,placeHolder:placeHolder,closeWith:closeWith}}function markup(button){var len,j,n,i;hash=clicked=button;get();$.extend(hash,{line:"",root:options.root,textarea:textarea,selection:(selection||""),caretPosition:caretPosition,ctrlKey:ctrlKey,shiftKey:shiftKey,altKey:altKey});prepare(options.beforeInsert);prepare(clicked.beforeInsert);if((ctrlKey===true&&shiftKey===true)||button.multiline===true){prepare(clicked.beforeMultiInsert)}$.extend(hash,{line:1});if((ctrlKey===true&&shiftKey===true)){lines=selection.split(/\r?\n/);for(j=0,n=lines.length,i=0;i<n;i++){if($.trim(lines[i])!==""){$.extend(hash,{line:++j,selection:lines[i]});lines[i]=build(lines[i]).block}else{lines[i]=""}}string={block:lines.join("\n")};start=caretPosition;len=string.block.length+(($.browser.opera)?n-1:0)}else{if(ctrlKey===true){string=build(selection);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;len=len-(string.block.match(/ $/)?1:0);len-=fixIeBug(string.block)}else{if(shiftKey===true){string=build(selection);start=caretPosition;len=string.block.length;len-=fixIeBug(string.block)}else{string=build(selection);start=caretPosition+string.block.length;len=0;start-=fixIeBug(string.block)}}}if((selection===""&&string.replaceWith==="")){caretOffset+=fixOperaBug(string.block);start=caretPosition+string.openWith.length;len=string.block.length-string.openWith.length-string.closeWith.length;caretOffset=$$.val().substring(caretPosition,$$.val().length).length;caretOffset-=fixOperaBug($$.val().substring(0,caretPosition))}$.extend(hash,{caretPosition:caretPosition,scrollPosition:scrollPosition});if(string.block!==selection&&abort===false){insert(string.block);set(start,len)}else{caretOffset=-1}get();$.extend(hash,{line:"",selection:selection});if((ctrlKey===true&&shiftKey===true)||button.multiline===true){prepare(clicked.afterMultiInsert)}prepare(clicked.afterInsert);prepare(options.afterInsert);if(previewWindow&&options.previewAutoRefresh){refreshPreview()}shiftKey=altKey=ctrlKey=abort=false}function fixOperaBug(string){if($.browser.opera){return string.length-string.replace(/\n*/g,"").length}return 0}function fixIeBug(string){if($.browser.msie){return string.length-string.replace(/\r*/g,"").length}return 0}function insert(block){if(document.selection){var newSelection=document.selection.createRange();newSelection.text=block}else{textarea.value=textarea.value.substring(0,caretPosition)+block+textarea.value.substring(caretPosition+selection.length,textarea.value.length)}}function set(start,len){if(textarea.createTextRange){if($.browser.opera&&$.browser.version>=9.5&&len==0){return false}range=textarea.createTextRange();range.collapse(true);range.moveStart("character",start);range.moveEnd("character",len);range.select()}else{if(textarea.setSelectionRange){textarea.setSelectionRange(start,start+len)}}textarea.scrollTop=scrollPosition;textarea.focus()}function get(){textarea.focus();scrollPosition=textarea.scrollTop;if(document.selection){selection=document.selection.createRange().text;if($.browser.msie){var range=document.selection.createRange(),rangeCopy=range.duplicate();rangeCopy.moveToElementText(textarea);caretPosition=-1;while(rangeCopy.inRange(range)){rangeCopy.moveStart("character");caretPosition++}}else{caretPosition=textarea.selectionStart}}else{caretPosition=textarea.selectionStart;selection=textarea.value.substring(caretPosition,textarea.selectionEnd)}return selection}function preview(){if(typeof options.previewHandler==="function"){previewWindow=true}else{if(options.previewInElement){previewWindow=$(options.previewInElement)}else{if(!previewWindow||previewWindow.closed){if(options.previewInWindow){previewWindow=window.open("","preview",options.previewInWindow);$(window).unload(function(){previewWindow.close()})}else{iFrame=$('<iframe class="markItUpPreviewFrame"></iframe>');if(options.previewPosition=="after"){iFrame.insertAfter(footer)}else{iFrame.insertBefore(header)}previewWindow=iFrame[iFrame.length-1].contentWindow||frame[iFrame.length-1]}}else{if(altKey===true){if(iFrame){iFrame.remove()}else{previewWindow.close()}previewWindow=iFrame=false}}}}if(!options.previewAutoRefresh){refreshPreview()}if(options.previewInWindow){previewWindow.focus()}}function refreshPreview(){renderPreview()}function renderPreview(){var phtml;if(options.previewHandler&&typeof options.previewHandler==="function"){options.previewHandler($$.val())}else{if(options.previewParser&&typeof options.previewParser==="function"){var data=options.previewParser($$.val());writeInPreview(localize(data,1))}else{if(options.previewParserPath!==""){$.ajax({type:"POST",dataType:"text",global:false,url:options.previewParserPath,data:options.previewParserVar+"="+encodeURIComponent($$.val()),success:function(data){writeInPreview(localize(data,1))}})}else{if(!template){$.ajax({url:options.previewTemplatePath,dataType:"text",global:false,success:function(data){writeInPreview(localize(data,1).replace(/<!-- content -->/g,$$.val()))}})}}}}return false}function writeInPreview(data){if(options.previewInElement){$(options.previewInElement).html(data)}else{if(previewWindow&&previewWindow.document){try{sp=previewWindow.document.documentElement.scrollTop}catch(e){sp=0}previewWindow.document.open();previewWindow.document.write(data);previewWindow.document.close();previewWindow.document.documentElement.scrollTop=sp}}}function keyPressed(e){shiftKey=e.shiftKey;altKey=e.altKey;ctrlKey=(!(e.altKey&&e.ctrlKey))?(e.ctrlKey||e.metaKey):false;if(e.type==="keydown"){if(ctrlKey===true){li=$('a[accesskey="'+((e.keyCode==13)?"\\n":String.fromCharCode(e.keyCode))+'"]',header).parent("li");if(li.length!==0){ctrlKey=false;li.triggerHandler("mouseup");return false}}if(e.keyCode===13||e.keyCode===10){if(ctrlKey===true){ctrlKey=false;markup(options.onCtrlEnter);return options.onCtrlEnter.keepDefault}else{if(shiftKey===true){shiftKey=false;markup(options.onShiftEnter);return options.onShiftEnter.keepDefault}else{markup(options.onEnter);return options.onEnter.keepDefault}}}if(e.keyCode===9){if(shiftKey==true||ctrlKey==true||altKey==true){return false}if(caretOffset!==-1){get();caretOffset=$$.val().length-caretOffset;set(caretOffset,0);caretOffset=-1;return false}else{markup(options.onTab);return options.onTab.keepDefault}}}}function remove(){$$.unbind(".markItUp").removeClass("markItUpEditor");$$.parent("div").parent("div.markItUp").parent("div").replaceWith($$);$$.data("markItUp",null)}init()})};$.fn.markItUpRemove=function(){return this.each(function(){$(this).markItUp("remove")})};$.markItUp=function(settings){var options={target:false};$.extend(options,settings);if(options.target){return $(options.target).each(function(){$(this).focus();$(this).trigger("insertion",[options])})}else{$("textarea").trigger("insertion",[options])}}})(jQuery);(function(u){var Z,B="2.0.0",ad=Math.round,af,Q={},P=(typeof module!=="undefined"&&module.exports),y=/^\/?Date\((\-?\d+)/i,m=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,s=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,ai=/([0-9a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)/gi,g=/\d\d?/,R=/\d{1,3}/,T=/\d{3}/,J=/\d{1,4}/,r=/[+\-]?\d{1,6}/,K=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,b=/Z|[\+\-]\d\d:?\d\d/i,v=/T/i,q=/[\+\-]?\d+(\.\d{1,3})?/,L=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,d="YYYY-MM-DDTHH:mm:ssZ",j=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],D=/([\+\-]|\d\d)/gi,o="Month|Date|Hours|Minutes|Seconds|Milliseconds".split("|"),aa={Milliseconds:1,Seconds:1000,Minutes:60000,Hours:3600000,Days:86400000,Months:2592000000,Years:31536000000},n={},G="DDD w W M D d".split(" "),x="M D H h m s w W".split(" "),h={M:function(){return this.month()+1},MMM:function(i){return this.lang().monthsShort(this,i)},MMMM:function(i){return this.lang().months(this,i)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(i){return this.lang().weekdaysMin(this,i)},ddd:function(i){return this.lang().weekdaysShort(this,i)},dddd:function(i){return this.lang().weekdays(this,i)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return ac(this.year()%100,2)},YYYY:function(){return ac(this.year(),4)},YYYYY:function(){return ac(this.year(),5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),true)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),false)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return ~~(this.milliseconds()/100)},SS:function(){return ac(~~(this.milliseconds()/10),2)},SSS:function(){return ac(this.milliseconds(),3)},Z:function(){var ak=-this.zone(),i="+";if(ak<0){ak=-ak;i="-"}return i+ac(~~(ak/60),2)+":"+ac(~~ak%60,2)},ZZ:function(){var ak=-this.zone(),i="+";if(ak<0){ak=-ak;i="-"}return i+ac(~~(10*ak/6),4)},X:function(){return this.unix()}};function N(ak,i){return function(al){return ac(ak.call(this,al),i)}}function H(i){return function(ak){return this.lang().ordinal(i.call(this,ak))}}while(G.length){af=G.pop();h[af+"o"]=H(h[af])}while(x.length){af=x.pop();h[af+af]=N(h[af],2)}h.DDDD=N(h.DDD,3);function ah(){}function w(i){t(this,i)}function aj(am){var ao=this._data={},ap=am.years||am.year||am.y||0,ak=am.months||am.month||am.M||0,i=am.weeks||am.week||am.w||0,at=am.days||am.day||am.d||0,aq=am.hours||am.hour||am.h||0,an=am.minutes||am.minute||am.m||0,ar=am.seconds||am.second||am.s||0,al=am.milliseconds||am.millisecond||am.ms||0;this._milliseconds=al+ar*1000+an*60000+aq*3600000;this._days=at+i*7;this._months=ak+ap*12;ao.milliseconds=al%1000;ar+=Y(al/1000);ao.seconds=ar%60;an+=Y(ar/60);ao.minutes=an%60;aq+=Y(an/60);ao.hours=aq%24;at+=Y(aq/24);at+=i*7;ao.days=at%30;ak+=Y(at/30);ao.months=ak%12;ap+=Y(ak/12);ao.years=ap}function t(al,ak){for(var am in ak){if(ak.hasOwnProperty(am)){al[am]=ak[am]}}return al}function Y(i){if(i<0){return Math.ceil(i)}else{return Math.floor(i)}}function ac(al,ak){var i=al+"";while(i.length<ak){i="0"+i}return i}function V(al,an,am){var ak=an._milliseconds,ao=an._days,ap=an._months,i;if(ak){al._d.setTime(+al+ak*am)}if(ao){al.date(al.date()+ao*am)}if(ap){i=al.date();al.date(1).month(al.month()+ap*am).date(Math.min(i,al.daysInMonth()))}}function E(i){return Object.prototype.toString.call(i)==="[object Array]"}function U(ao,an){var ak=Math.min(ao.length,an.length),al=Math.abs(ao.length-an.length),ap=0,am;for(am=0;am<ak;am++){if(~~ao[am]!==~~an[am]){ap++}}return ap+al}ah.prototype={set:function(ak){var am,al;for(al in ak){am=ak[al];if(typeof am==="function"){this[al]=am}else{this["_"+al]=am}}},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(i){return this._months[i.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(i){return this._monthsShort[i.month()]},monthsParse:function(ak){var am,ao,an,al;if(!this._monthsParse){this._monthsParse=[]}for(am=0;am<12;am++){if(!this._monthsParse[am]){ao=Z([2000,am]);an="^"+this.months(ao,"")+"|^"+this.monthsShort(ao,"");this._monthsParse[am]=new RegExp(an.replace(".",""),"i")}if(this._monthsParse[am].test(ak)){return am}}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(i){return this._weekdays[i.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(i){return this._weekdaysShort[i.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(i){return this._weekdaysMin[i.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(ak){var i=this._longDateFormat[ak];if(!i&&this._longDateFormat[ak.toUpperCase()]){i=this._longDateFormat[ak.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(al){return al.slice(1)});this._longDateFormat[ak]=i}return i},meridiem:function(i,ak,al){if(i>11){return al?"pm":"PM"}else{return al?"am":"AM"}},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(ak,al){var i=this._calendar[ak];return typeof i==="function"?i.apply(al):i},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(am,al,ak,an){var i=this._relativeTime[ak];return(typeof i==="function")?i(am,al,ak,an):i.replace(/%d/i,am)},pastFuture:function(al,i){var ak=this._relativeTime[al>0?"future":"past"];return typeof ak==="function"?ak(i):ak.replace(/%s/i,i)},ordinal:function(i){return this._ordinal.replace("%d",i)},_ordinal:"%d",preparse:function(i){return i},postformat:function(i){return i},week:function(i){return S(i,this._week.dow,this._week.doy)},_week:{dow:0,doy:6}};function A(ak,i){i.abbr=ak;if(!Q[ak]){Q[ak]=new ah()}Q[ak].set(i);return Q[ak]}function z(i){if(!i){return Z.fn._lang}if(!Q[i]&&P){require("./lang/"+i)}return Q[i]}function I(i){if(i.match(/\[.*\]/)){return i.replace(/^\[|\]$/g,"")}return i.replace(/\\/g,"")}function X(am){var an=am.match(m),ak,al;for(ak=0,al=an.length;ak<al;ak++){if(h[an[ak]]){an[ak]=h[an[ak]]}else{an[ak]=I(an[ak])}}return function(ao){var i="";for(ak=0;ak<al;ak++){i+=typeof an[ak].call==="function"?an[ak].call(ao,am):an[ak]}return i}}function O(ak,an){var al=5;function am(i){return ak.lang().longDateFormat(i)||i}while(al--&&s.test(an)){an=an.replace(s,am)}if(!n[an]){n[an]=X(an)}return n[an](ak)}function f(i){switch(i){case"DDDD":return T;case"YYYY":return J;case"YYYYY":return r;case"S":case"SS":case"SSS":case"DDD":return R;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":case"a":case"A":return K;case"X":return q;case"Z":case"ZZ":return b;case"T":return v;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return g;default:return new RegExp(i.replace("\\",""))}}function e(ao,am,an){var al,i,ak=an._a;switch(ao){case"M":case"MM":ak[1]=(am==null)?0:~~am-1;break;case"MMM":case"MMMM":al=z(an._l).monthsParse(am);if(al!=null){ak[1]=al}else{an._isValid=false}break;case"D":case"DD":case"DDD":case"DDDD":if(am!=null){ak[2]=~~am}break;case"YY":ak[0]=~~am+(~~am>68?1900:2000);break;case"YYYY":case"YYYYY":ak[0]=~~am;break;case"a":case"A":an._isPm=((am+"").toLowerCase()==="pm");break;case"H":case"HH":case"h":case"hh":ak[3]=~~am;break;case"m":case"mm":ak[4]=~~am;break;case"s":case"ss":ak[5]=~~am;break;case"S":case"SS":case"SSS":ak[6]=~~(("0."+am)*1000);break;case"X":an._d=new Date(parseFloat(am)*1000);break;case"Z":case"ZZ":an._useUTC=true;al=(am+"").match(D);if(al&&al[1]){an._tzh=~~al[1]}if(al&&al[2]){an._tzm=~~al[2]}if(al&&al[0]==="+"){an._tzh=-an._tzh;an._tzm=-an._tzm}break}if(am==null){an._isValid=false}}function l(am){var an,al,ak=[];if(am._d){return}for(an=0;an<7;an++){am._a[an]=ak[an]=(am._a[an]==null)?(an===2?1:0):am._a[an]}ak[3]+=am._tzh||0;ak[4]+=am._tzm||0;al=new Date(0);if(am._useUTC){al.setUTCFullYear(ak[0],ak[1],ak[2]);al.setUTCHours(ak[3],ak[4],ak[5],ak[6])}else{al.setFullYear(ak[0],ak[1],ak[2]);al.setHours(ak[3],ak[4],ak[5],ak[6])}am._d=al}function M(al){var ao=al._f.match(m),ak=al._i,am,an;al._a=[];for(am=0;am<ao.length;am++){an=(f(ao[am]).exec(ak)||[])[0];if(an){ak=ak.slice(ak.indexOf(an)+an.length)}if(h[ao[am]]){e(ao[am],an,al)}}if(al._isPm&&al._a[3]<12){al._a[3]+=12}if(al._isPm===false&&al._a[3]===12){al._a[3]=0}l(al)}function C(am){var aq,ak,ao,ap=99,an,al,ar;while(am._f.length){aq=t({},am);aq._f=am._f.pop();M(aq);ak=new w(aq);if(ak.isValid()){ao=ak;break}ar=U(aq._a,ak.toArray());if(ar<ap){ap=ar;ao=ak}}t(am,ao)}function ab(al){var am,ak=al._i;if(L.exec(ak)){al._f="YYYY-MM-DDT";for(am=0;am<4;am++){if(j[am][1].exec(ak)){al._f+=j[am][0];break}}if(b.exec(ak)){al._f+=" Z"}M(al)}else{al._d=new Date(ak)}}function ag(al){var ak=al._i,i=y.exec(ak);if(ak===u){al._d=new Date()}else{if(i){al._d=new Date(+i[1])}else{if(typeof ak==="string"){ab(al)}else{if(E(ak)){al._a=ak.slice(0);l(al)}else{al._d=ak instanceof Date?new Date(+ak):new Date(ak)}}}}}function W(i,al,ak,am,an){return an.relativeTime(al||1,!!ak,i,am)}function F(al,i,ak){var aq=ad(Math.abs(al)/1000),am=ad(aq/60),ap=ad(am/60),ar=ad(ap/24),an=ad(ar/365),ao=aq<45&&["s",aq]||am===1&&["m"]||am<45&&["mm",am]||ap===1&&["h"]||ap<22&&["hh",ap]||ar===1&&["d"]||ar<=25&&["dd",ar]||ar<=45&&["M"]||ar<345&&["MM",ad(ar/30)]||an===1&&["y"]||["yy",an];ao[2]=i;ao[3]=al>0;ao[4]=ak;return W.apply({},ao)}function S(am,al,an){var ak=an-al,i=an-am.day();if(i>ak){i-=7}if(i<ak-7){i+=7}return Math.ceil(Z(am).add("d",i).dayOfYear()/7)}function ae(ak){var i=ak._i,al=ak._f;if(i===null||i===""){return null}if(typeof i==="string"){ak._i=i=z().preparse(i)}if(Z.isMoment(i)){ak=t({},i);ak._d=new Date(+i._d)}else{if(al){if(E(al)){C(ak)}else{M(ak)}}else{ag(ak)}}return new w(ak)}Z=function(i,ak,al){return ae({_i:i,_f:ak,_l:al,_isUTC:false})};Z.utc=function(i,ak,al){return ae({_useUTC:true,_isUTC:true,_l:al,_i:i,_f:ak})};Z.unix=function(i){return Z(i*1000)};Z.duration=function(i,an){var am=Z.isDuration(i),al=(typeof i==="number"),ao=(am?i._data:(al?{}:i)),ak;if(al){if(an){ao[an]=i}else{ao.milliseconds=i}}ak=new aj(ao);if(am&&i.hasOwnProperty("_lang")){ak._lang=i._lang}return ak};Z.version=B;Z.defaultFormat=d;Z.lang=function(am,ak){var al;if(!am){return Z.fn._lang._abbr}if(ak){A(am,ak)}else{if(!Q[am]){z(am)}}Z.duration.fn._lang=Z.fn._lang=z(am)};Z.langData=function(i){if(i&&i._lang&&i._lang._abbr){i=i._lang._abbr}return z(i)};Z.isMoment=function(i){return i instanceof w};Z.isDuration=function(i){return i instanceof aj};Z.fn=w.prototype={clone:function(){return Z(this)},valueOf:function(){return +this._d},unix:function(){return Math.floor(+this._d/1000)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return Z.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var i=this;return[i.year(),i.month(),i.date(),i.hours(),i.minutes(),i.seconds(),i.milliseconds()]},isValid:function(){if(this._isValid==null){if(this._a){this._isValid=!U(this._a,(this._isUTC?Z.utc(this._a):Z(this._a)).toArray())}else{this._isValid=!isNaN(this._d.getTime())}}return !!this._isValid},utc:function(){this._isUTC=true;return this},local:function(){this._isUTC=false;return this},format:function(ak){var i=O(this,ak||Z.defaultFormat);return this.lang().postformat(i)},add:function(i,al){var ak;if(typeof i==="string"){ak=Z.duration(+al,i)}else{ak=Z.duration(i,al)}V(this,ak,1);return this},subtract:function(i,al){var ak;if(typeof i==="string"){ak=Z.duration(+al,i)}else{ak=Z.duration(i,al)}V(this,ak,-1);return this},diff:function(an,am,i){var ao=this._isUTC?Z(an).utc():Z(an).local(),ak=(this.zone()-ao.zone())*60000,ap,al;if(am){am=am.replace(/s$/,"")}if(am==="year"||am==="month"){ap=(this.daysInMonth()+ao.daysInMonth())*43200000;al=((this.year()-ao.year())*12)+(this.month()-ao.month());al+=((this-Z(this).startOf("month"))-(ao-Z(ao).startOf("month")))/ap;if(am==="year"){al=al/12}}else{ap=(this-ao)-ak;al=am==="second"?ap/1000:am==="minute"?ap/60000:am==="hour"?ap/3600000:am==="day"?ap/86400000:am==="week"?ap/604800000:ap}return i?al:Y(al)},from:function(ak,i){return Z.duration(this.diff(ak)).lang(this.lang()._abbr).humanize(!i)},fromNow:function(i){return this.from(Z(),i)},calendar:function(){var ak=this.diff(Z().startOf("day"),"days",true),i=ak<-6?"sameElse":ak<-1?"lastWeek":ak<0?"lastDay":ak<1?"sameDay":ak<2?"nextDay":ak<7?"nextWeek":"sameElse";return this.format(this.lang().calendar(i,this))},isLeapYear:function(){var i=this.year();return(i%4===0&&i%100!==0)||i%400===0},isDST:function(){return(this.zone()<Z([this.year()]).zone()||this.zone()<Z([this.year(),5]).zone())},day:function(ak){var i=this._isUTC?this._d.getUTCDay():this._d.getDay();return ak==null?i:this.add({d:ak-i})},startOf:function(i){i=i.replace(/s$/,"");switch(i){case"year":this.month(0);case"month":this.date(1);case"week":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}if(i==="week"){this.day(0)}return this},endOf:function(i){return this.startOf(i).add(i.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(ak,i){i=typeof i!=="undefined"?i:"millisecond";return +this.clone().startOf(i)>+Z(ak).startOf(i)},isBefore:function(ak,i){i=typeof i!=="undefined"?i:"millisecond";return +this.clone().startOf(i)<+Z(ak).startOf(i)},isSame:function(ak,i){i=typeof i!=="undefined"?i:"millisecond";return +this.clone().startOf(i)===+Z(ak).startOf(i)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},daysInMonth:function(){return Z.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(i){var ak=ad((Z(this).startOf("day")-Z(this).startOf("year"))/86400000)+1;return i==null?ak:this.add("d",(i-ak))},isoWeek:function(i){var ak=S(this,1,4);return i==null?ak:this.add("d",(i-ak)*7)},week:function(i){var ak=this.lang().week(this);return i==null?ak:this.add("d",(i-ak)*7)},lang:function(i){if(i===u){return this._lang}else{this._lang=z(i);return this}}};function p(i,ak){Z.fn[i]=Z.fn[i+"s"]=function(al){var am=this._isUTC?"UTC":"";if(al!=null){this._d["set"+am+ak](al);return this}else{return this._d["get"+am+ak]()}}}for(af=0;af<o.length;af++){p(o[af].toLowerCase().replace(/s$/,""),o[af])}p("year","FullYear");Z.fn.days=Z.fn.day;Z.fn.weeks=Z.fn.week;Z.fn.isoWeeks=Z.fn.isoWeek;Z.duration.fn=aj.prototype={weeks:function(){return Y(this.days()/7)},valueOf:function(){return this._milliseconds+this._days*86400000+this._months*2592000000},humanize:function(ak){var al=+this,i=F(al,!ak,this.lang());if(ak){i=this.lang().pastFuture(al,i)}return this.lang().postformat(i)},lang:Z.fn.lang};function a(i){Z.duration.fn[i]=function(){return this._data[i]}}function c(i,ak){Z.duration.fn["as"+i]=function(){return +this/ak}}for(af in aa){if(aa.hasOwnProperty(af)){c(af,aa[af]);a(af.toLowerCase())}}c("Weeks",604800000);Z.lang("en",{ordinal:function(al){var i=al%10,ak=(~~(al%100/10)===1)?"th":(i===1)?"st":(i===2)?"nd":(i===3)?"rd":"th";return al+ak}});if(P){module.exports=Z}else{this["moment"]=Z}if(typeof define==="function"&&define.amd){define("moment",[],function(){return Z})}}).call(this);(function(d){window.Chorus=window.Chorus||{};window.Chorus.Comments=Chorus.Comments||{};var c={onShiftEnter:{keepDefault:false,replaceWith:"<br />\n"},onCtrlEnter:{keepDefault:false,openWith:"\n<p>",closeWith:"</p>"},onTab:{keepDefault:false,replaceWith:"    "},markupSet:[{name:"Bold",key:"B",openWith:"(!(<strong>|!|<b>)!)",closeWith:"(!(</strong>|!|</b>)!)"},{name:"Italic",key:"I",openWith:"(!(<em>|!|<i>)!)",closeWith:"(!(</em>|!|</i>)!)"},{name:"Strike through",key:"S",openWith:"<del>",closeWith:"</del>"},{name:"Spoilers",key:"F",openWith:'<p class="spoiler">',closeWith:"</p>"},{separator:"---------------"},{name:"Bulleted List",openWith:"    <li>",closeWith:"</li>",multiline:true,openBlockWith:"<ul>\n",closeBlockWith:"\n</ul>"},{name:"Numeric List",openWith:"    <li>",closeWith:"</li>",multiline:true,openBlockWith:"<ol>\n",closeBlockWith:"\n</ol>"},{separator:"---------------"},{name:"Picture",key:"P",replaceWith:'<img src="[![Source:!:http://]!]" alt="[![Alternative text]!]" />'},{name:"Link",key:"L",openWith:'<a rel="nofollow" target="_blank" href="[![Link:!:http://]!]"(!( title="[![Title]!]")!)>',closeWith:"</a>",placeHolder:"Your text to link..."},{separator:"---------------"},{name:"Clean",className:"clean",replaceWith:function(f){return f.selection.replace(/<(.*?)>/g,"")}}]};var b={previewParserPath:"",onShiftEnter:{keepDefault:false,replaceWith:"\n\n"},markupSet:[{name:"Bold",key:"B",closeWith:"*",openWith:"*"},{name:"Italic",key:"I",closeWith:"_",openWith:"_"},{name:"Strike through",key:"S",closeWith:"-",openWith:"-"},{name:"Spoilers",key:"F",openWith:"%(spoiler)",closeWith:"%"},{separator:"---------------"},{name:"Bulleted list",openWith:"* "},{name:"Numeric list",openWith:"# "},{separator:"---------------"},{name:"Picture",replaceWith:"![![Source:!:http://]!]([![Alternative text (Shown on hover)]!])!"},{name:"Link",openWith:'"',closeWith:'(!(([![Title (Shown on hover)]!]))!)":[![Link:!:http://]!]',placeHolder:"Your text to link here..."},{separator:"---------------"},{name:"Quotes",openWith:"bq. "}]};var a={previewParserPath:"",onShiftEnter:{keepDefault:false,replaceWith:"\n\n"},markupSet:[{name:"Bold",key:"B",closeWith:"</strong>",openWith:"<strong>"},{name:"Italic",key:"I",closeWith:"</em>",openWith:"<em>"},{name:"Strike through",key:"S",closeWith:"</strike>",openWith:"<strike>"},{name:"Quote",openWith:"<blockquote>",closeWith:"</blockquote>",multiline:true},{separator:"---------------"},{name:"Bulleted list",openWith:"* "},{name:"Numeric list",openWith:"# "},{separator:"---------------"},{name:"Picture",replaceWith:"![![Source:!:http://]!]([![Alternative text (Shown on hover)]!])!"},{name:"Link",openWith:'"',closeWith:'(!(([![Title (Shown on hover)]!]))!)":[![Link:!:http://]!]',placeHolder:"Your text to link here"},{name:"Spoilers",key:"F",openWith:"%(spoiler)",closeWith:"%",placeHolder:"Spoiler text here"},]};var e={};Chorus.Comments={UPDATE_INTERVAL:20000,SLOW_UPDATE_INTERVAL:60000,current_update_interval:20000,auto_updater:null,scrollOffset:-200,comments_per_page:5,current_page:0,previewDisabled:{},empty_count:0,lastRequestId:0,busy:false,loaded:false,edit_timer:90,comments_container:"comments_list",collapsed_class:"collapsed",expanded_class:"expanded",hidden_class:"hidden",hidden_mobile_class:"hidden-for-mobile",touch_enabled_class:"touch_enabled",new_comment_class:"new",touchTools:{control:"#touch-tools",toggle:"#touch-tools-toggle",bar:"#touch-bar",newCommentsClass:"new-comments"},UIAdapter:{openModal:function(f){if(Chorus.Modal){Chorus.Modal.open(f)}if(Vox&&Vox.EventDispatcher){Vox.EventDispatcher.publish("requestOpenModalWithContents",{contents:f})}},closeModal:function(){if(Chorus.Modal){Chorus.Modal.close()}if(Vox&&Vox.EventDispatcher){Vox.EventDispatcher.publish("requestCloseModal")}}},Options:{able_to_comment:false,able_to_moderate:false,show_new_comment_alert:true,comments_closed:false,auto_update:false,depth_to_start_contextualizing:10,click_event:"click",fixed_header_height:60,toggle_children_with_collapse:true,include_preview_controls:false,button_options:b,animate_scroll_to:true,scroll_animation_duration:300},initialize:function(g){this.Options=d.extend({},this.Options,g);var f={reply_link:"reply",edit_link:"edit",post_edit_comment:"edit_comment",cancel_edit_comment:"cancel_edit_form",recommend_link:"recommend_comment",flag_link:"flag_comment_dialog",delete_link:"delete_comment",hide_link:"hide_comment",cancel_comment_button:"cancel_comment_form"};_.each(f,function(i,h){d(document).on(Chorus.Comments.Options.click_event,"."+h,function(l){l.preventDefault();var j=d(this).closest(".citem");var m=Chorus.Comments[i];if(j.length>0&&m){m(j.data("comment-id"))}})});d(document).on(Chorus.Comments.Options.click_event,".go_to_comment",function(h){h.preventDefault();Chorus.Comments.Cycle.goToComment(d(this).data("target-comment-id"))});d(document).on(Chorus.Comments.Options.click_event,".close_autoupdate",function(h){h.preventDefault();Chorus.Comments.hide_auto_update_info()});d(document).on(Chorus.Comments.Options.click_event,".post_comment_button",function(i){i.preventDefault();var h=d(this).closest("form.comment_form");if(h.length>0){Chorus.Comments.post_comment(h)}});d(document).on(Chorus.Comments.Options.click_event,".preview_comment_button",function(i){i.preventDefault();var h=d(this).closest("form.comment_form");if(h.length>0){Chorus.Comments.preview_comment(h)}});d("#formatting_guide_links").on(Chorus.Comments.Options.click_event,Chorus.Comments.toggle_formatting_guide);d(document).on(Chorus.Comments.Options.click_event,".link_to_parent",function(h){h.preventDefault();Chorus.Comments.scroll_to(d(this).data("parent-id"))});this.Json.initialize();d(document).on(Chorus.Comments.Options.click_event,".collapse_toggle",Chorus.Comments.Collapse.toggle);d(".comments_wrapper").addClass("ui-state-unloaded");if(Vox.Environment.touch()){Chorus.Comments.TouchControls.init()}Chorus.Comments.loading_indicator=d("#comment_loader_gif");Chorus.Comments.initializeKeyboardShortcuts()},Collapse:{toggle:function(){var h=d(this).closest(".citem");var g=h.data("comment-id");var f=(Chorus.Comments.Options.toggle_children_with_collapse===true)?f=Chorus.Comments.Json.getChildrenOfComment(g):d();if(h.hasClass(Chorus.Comments.collapsed_class)||h.hasClass(Chorus.Comments.collapsed_class+"-child")){Chorus.Comments.Collapse.expand_it(h,f)}else{Chorus.Comments.Collapse.collapse_it(h,f)}return false},collapse_it:function(g,f){f.addClass(Chorus.Comments.collapsed_class+"-child");g.addClass(Chorus.Comments.collapsed_class)},expand_it:function(g,f){f.removeClass(Chorus.Comments.collapsed_class+"-child");f.removeClass(Chorus.Comments.collapsed_class);g.removeClass(Chorus.Comments.collapsed_class);g.removeClass(Chorus.Comments.collapsed_class+"-child")}},TouchControls:{init:function(){d(Chorus.Comments.touchTools.control).show();d(Chorus.Comments.touchTools.control).on(Chorus.Comments.Options.click_event,Chorus.Comments.TouchControls.toggle);d(Chorus.Comments.touchTools.bar).find("a").on(Chorus.Comments.Options.click_event,Chorus.Comments.TouchControls.fire);Chorus.Comments.TouchControls.positionBar()},positionBar:function(){var f=d(Chorus.Comments.touchTools.bar);f.data("height",f.outerHeight(true));f.appendTo(d("body")).css("bottom",f.data("height")*-1)},toggle:function(){var g=d(Chorus.Comments.touchTools.bar);var f=(parseInt(g.css("bottom"),10)<0)?0:g.data().height*-1;g.css("visibility","visible").animate({bottom:f},300);return false},fire:function(f){switch(d(this).data().keypress){case"next":Chorus.Comments.Cycle.remove();Chorus.Comments.Cycle.next();break;case"unmark":Chorus.Comments.Cycle.removeAll();break;case"refresh":d("."+Chorus.Comments.hidden_mobile_class).removeClass(Chorus.Comments.hidden_mobile_class).addClass(Chorus.Comments.new_comment_class);d(Chorus.Comments.touchTools.bar).removeClass(Chorus.Comments.touchTools.newCommentsClass);Chorus.Comments.Cycle.refresh();Chorus.Comments.Json.check_for_updates();break;case"close":Chorus.Comments.TouchControls.toggle();break;case"z":Chorus.Comments.Cycle.remove();Chorus.Comments.Cycle.next();break;case"j":Chorus.Comments.Cycle.next();break;case"k":Chorus.Comments.Cycle.previous();break;case"A":Chorus.Comments.Cycle.removeAll();break;case"C":Chorus.Comments.Cycle.previous();break;case"c":Chorus.Comments.Cycle.next();break;case"x":Chorus.Comments.Cycle.remove();break;case"r":Chorus.Comments.Cycle.reply();break}return false}},supportsTransitions:function(){var f=document.body||document.documentElement;var j=f.style;var l="transition";var g=["Moz","Webkit","Khtml","O","ms"];if(typeof j[l]==="string"){return true}l=l.charAt(0).toUpperCase()+l.substr(1);for(var h=0;h<g.length;h++){if(typeof j[g[h]+l]==="string"){return true}}return false},load_comments_success:function(){Chorus.Comments.busy=false;Chorus.Comments.loaded=true;d("#main-comment-form").css("display","block");this.Cycle.refresh();var i=d(".comments_wrapper");i.removeClass("ui-state-unloaded");i.removeClass("ui-state-loading");i.addClass("ui-state-loaded");var g=window.location.hash.replace("#","");if(/[0-9]+/.test(g)){var h=parseInt(g,10);if(d("#"+h).length>0){window.location.hash="";Chorus.Comments.scroll_to(h)}}if(this.Options.auto_update===true){var f=Vox.Environment.currentBreakpoint();if(!!f&&_.indexOf(["xsmall","small"],f.name)===-1){this.start_auto_update()}}},load_comments_failure:function(){var g=d(".comments_wrapper");g.removeClass("ui-state-unloaded");g.removeClass("ui-state-loading");g.removeClass("ui-state-loaded");g.addClass("ui-state-load-error");var f=d("#"+Chorus.Comments.comments_container);f.html('<h2 class="comments-load-error-msg">There was an error loading the comments. Please try again later.</h2>')},contextualize_flat_comments:function(g,h){var j="";var f=Chorus.Comments.Options.depth_to_start_contextualizing;for(f;f<h&&j.length<8;f++){j+="> "}g.find(".by").prepend('<span class="context">'+j+"</span>")},post_comment_success:function(f,g){if(g.parent_id){Chorus.Comments.cancel_comment_form(g.parent_id)}else{Chorus.Comments.cancel_comment_form()}Chorus.Comments.highlight_comment(g)},preview_comment:function(h){d(h).find(".preview").val("Previewing...").prop("disabled",true);var j="/comments/preview_comment";var i=function(n){if(n.success===true){var p=n.comments[0];if(p){d(h).find(".preview").val("Preview").prop("disabled",false);if(!!p.parent_id){var f=Chorus.Comments.Json.get(p.parent_id);p.ancestry=f.ancestry+"/123123123";p.depth=f.depth+1}else{p.depth=1;p.ancestry="123123123"}Chorus.Comments.Json.Users.add(n.users);Chorus.Comments.Json.initialize_comment(p);var m=d("#"+p.preview_element);m.html("");m.append(p.html);if(Chorus.Comments.Options.include_preview_controls){var l=Chorus.Comments.Json.Templates["comment-preview-controls-template"];var o=l({comment:p});m.append(o)}}}else{alert(n.message)}};var g=function(m,f,l){alert("Unable to preview comment: "+l)};d.ajax({url:j,dataType:"json",data:d(h).serialize(),method:"post",timeout:15000,success:i,error:g});return false},flag_comment:function(h,g){var l=Chorus.Comments.Json.get(g);var j="/comments/flag_comment";var i=function(m){if(m.success!==true){alert(m.message);l.is_flagged_by_user=false;l.bad_flags_count-=1;Chorus.Comments.Json.update_comment_actions(l)}};var f=function(o,m,n){alert("Unable to flag comment: "+n)};l.is_flagged_by_user=true;l.bad_flags_count+=1;Chorus.Comments.Json.update_comment_actions(l);Chorus.Comments.UIAdapter.closeModal();d.ajax({url:j,dataType:"json",data:d(h).serialize(),method:"post",timeout:15000,success:i,error:f});return false},flag_comment_dialog:function(h){var i=Chorus.Comments.Json.get(h);if(i.is_flagged_by_user){Chorus.Comments.unflag_comment(h)}else{var g=Chorus.Comments.Json.Templates["comment-flag-template"];var f=g({comment:i});Chorus.Comments.UIAdapter.openModal(f)}},unflag_comment:function(g){var j=Chorus.Comments.Json.get(g);var i="/comments/unflag_comment";var h=function(l){if(l.success!==true){alert(l.message);j.is_flagged_by_user=true;j.bad_flags_count+=1;Chorus.Comments.Json.update_comment_actions(j)}};var f=function(n,l,m){alert("Unable to unflag comment: "+m)};j.is_flagged_by_user=false;j.bad_flags_count-=1;Chorus.Comments.Json.update_comment_actions(j);d.ajax({url:i,dataType:"json",data:{id:g},method:"post",timeout:15000,success:h,error:f});return false},recommend_comment:function(g){var j=Chorus.Comments.Json.get(g);if(j.is_recommended_by_user){return Chorus.Comments.unrecommend_comment(g)}var i="/comments/recommend_comment";var h=function(l){if(!l.success){alert(l.message);j.is_recommended_by_user=false;j.recommended_flags_count-=1;Chorus.Comments.Json.update_comment_actions(j)}};var f=function(n,l,m){alert("Unable to recommend comment: "+m)};j.is_recommended_by_user=true;j.recommended_flags_count+=1;Chorus.Comments.Json.update_comment_actions(j);d.ajax({url:i,dataType:"json",data:{id:g},method:"post",timeout:15000,success:h,error:f});return false},unrecommend_comment:function(h){var l=Chorus.Comments.Json.get(h);var j="/comments/unflag_comment";var f=d("#"+l.element);var i=function(m){if(m.success!==true){alert(m.message);l.is_recommended_by_user=true;l.recommended_flags_count+=1;Chorus.Comments.Json.update_comment_actions(l)}};var g=function(o,m,n){alert("Unable to unflag comment: "+n)};f.removeClass("recommended");l.is_recommended_by_user=false;l.recommended_flags_count-=1;Chorus.Comments.Json.update_comment_actions(l);d.ajax({url:j,dataType:"json",data:{id:h},method:"post",timeout:15000,success:i,error:g});return false},hide_comment:function(h){var n=d("#comment_item_"+h);var i=n.is(".hidden");var m=Chorus.Comments.Json.get(h);if(!!m.parent_id&&Chorus.Comments.Json.has_hidden_parent(m.parent_id)){var l="You can't "+(i?"unhide":"hide")+" this comment, fool! You need to unhide parents of this comment first.";alert(l);return false}if(i){if(!confirm("Are you sure you want to unhide this comment?")){return false}}else{if(!confirm("Are you sure you want to hide this comment and all of its replies?")){return false}}var f=d("#comment_mod_tools_"+h).find(".hide");f.text(i?"Unhiding...":"Hiding...");var j=function(o){if(o.success===true){if(!i){n.addClass("hidden");f.text("Unhide");Chorus.Comments.Json.get(n.data("comment-id")).hidden=true;Chorus.Comments.Json.getChildrenOfComment(h).each(function(){Chorus.Comments.Json.get(d(this).data("comment-id")).hidden=true;d(this).addClass("hidden");d(this).find(".mod_tools").find(".hide").text("Unhide")})}else{Chorus.Comments.Json.get(n.data("comment-id")).hidden=false;n.removeClass("hidden");f.text("Hide")}}else{alert(o.message)}};var g=function(q,o,p){alert("Unable to hide comment: "+p)};d.ajax({url:"/comments/hide_comment",dataType:"json",data:{id:h},method:"post",timeout:15000,success:j,error:g});return false},delete_comment:function(g){if(confirm("Are you sure you want to delete this comment and all of its replies?")){d("#comment_mod_tools_"+g).find(".delete").text("Deleting...");var i="/comments/destroy_comment";var h=function(j){if(j.success===true){Chorus.Comments.Json.getChildrenOfComment(g).remove();d("#comment_item_"+g).remove()}else{alert(j.message)}};var f=function(m,j,l){alert("Unable to delete comment: "+l);d("#comment_mod_tools_"+g).find(".ss-delete").text("Delete")};d.ajax({url:i,dataType:"json",data:{id:g},method:"post",timeout:15000,success:h,error:f})}return false},edit_comment:function(h){var l="/comments/edit_comment";var g=d("#comment_edit_body_"+h).val();var i=d("#comment_edit_title_"+h).val();var m=Chorus.Comments.Json.get(h);var j=function(o){if(o.success===true){var n=o.comments[0];m.submitted_body=g;m.body=n.body;d("#"+m.element).find(".cbody, .body").html(m.body);d("#"+m.element).find(".ctitle, .title").html(m.title);Chorus.Comments.cancel_edit_form(m.id)}else{alert(o.message);Chorus.Comments.cancel_edit_form(h)}};var f=function(p,n,o){e["_"+h]=false;alert("Unable to edit comment: "+o)};d("#comment_edit_save_button_"+h).val("Saving...");d.ajax({url:l,dataType:"json",data:{entry_id:m.entry_id,comment_id:h,new_body:g,new_title:i},method:"post",timeout:15000,success:j,error:f});return false},post_comment:function(i){if(Chorus.Comments.busy){return true}Chorus.Comments.busy=true;var g=d(i);if(g.hasClass("reply_form")){g.find(".submit_action").prop("disabled",true).val("Replying...");d(".preview-controls .post").prop("disabled",true).val("Replying...")}else{if(g.hasClass("post_form")){g.find(".submit_action").prop("disabled",true).val("Posting...");d(".preview-controls .post").prop("disabled",true).val("Posting...")}}var l="/comments/post_comment";var j=function(f){if(f.success===true){var m=f.comments[0];if(g.hasClass("post_form")){g.find(".submit_action").val("Post");g.find(".submit_action").prop("disabled",false)}m.submitted_body=g[0]["comment[body]"].value;g[0].reset();Chorus.Comments.busy=false;Chorus.Comments.Json.Users.add(f.users);Chorus.Comments.Json.initialize_comment(m);Chorus.Comments.Json.add(m);Chorus.Comments.lastId=m.id;Chorus.Comments.Json.insert_comment(m.id,true);Chorus.Comments.post_comment_success(f,m);Chorus.Comments.scroll_to(m.id)}else{alert(f.message);Chorus.Comments.busy=false;if(g.hasClass("reply_form")){g.find(".submit_action").prop("disabled",false);g.find(".submit_action").val("Reply")}else{if(g.hasClass("post_form")){g.find(".submit_action").prop("disabled",false);g.find(".submit_action").val("Post")}}}};var h=function(n,f,m){alert("Unable to post comment: "+m);Chorus.Comments.busy=false;if(g.hasClass("reply_form")){g.find(".submit_action").prop("disabled",false);g.find(".submit_action").val("Reply")}else{if(g.hasClass("post_form")){g.find(".submit_action").prop("disabled",false);g.find(".submit_action").val("Post")}}};d.ajax({url:l,dataType:"json",data:g.serialize(),method:"post",timeout:15000,success:j,error:h});return false},highlight_comment:function(f){},mark_all_as_new:function(){this.mark_new_comments(Chorus.Comments.Json._comments)},mark_new_comments:function(g){for(var f=0;f<g.length;f++){d("#comment_item_"+g[f].id).removeClass("not-new").addClass("new")}},scroll_to:function(f,h){var j=d("#comment_item_"+f);if(j.length>0){var g=(h>-1)?h:Chorus.Comments.Options.fixed_header_height;var i=j.offset().top-g;d("html, body").animate({scrollTop:i},(Chorus.Comments.Options.animate_scroll_to===true)?Chorus.Comments.Options.scroll_animation_duration:1,function(){})}},start_auto_update:function(){Chorus.Comments.stop_auto_update();Chorus.Comments.auto_updater=setInterval(Chorus.Comments.Json.check_for_updates,Chorus.Comments.current_update_interval)},stop_auto_update:function(){if(Chorus.Comments.auto_updater!==undefined){clearInterval(Chorus.Comments.auto_updater);Chorus.Comments.auto_updater=undefined}},check_empty_count:function(f){Chorus.Comments.empty_count=f;var g=false;if(f===0&&(Chorus.Comments.current_update_interval!==Chorus.Comments.UPDATE_INTERVAL)){Chorus.Comments.current_update_interval=Chorus.Comments.UPDATE_INTERVAL;g=true}else{if(Chorus.Comments.empty_count===5){Chorus.Comments.current_update_interval=Chorus.Comments.SLOW_UPDATE_INTERVAL;g=true}}if(g){Chorus.Comments.start_auto_update()}},is_editable:function(f){var g=moment().unix();return(g-f)<Chorus.Comments.edit_timer},edit_countdown:function(g){var h=moment().unix();var l=d("#comment_item_"+g).data("timestamp");var j=Chorus.Comments.edit_timer-(h-l);var m=d("#countdown_timer_"+g);var o=d("#countdown_bar_"+g);var n=d("#comment_edit_"+g);m.html(j);o.show();if(Chorus.Comments.supportsTransitions()){var i="width "+j+"s";o.css({transition:i,"-moz-transition":i,"-webkit-transition":i,"-o-transition":i,"transition-timing-function":"linear","-moz-transition-timing-function":"linear","-webkit-transition-timing-function":"linear","-o-transition-timing-function":"linear"});setTimeout(function(){o.css("width","0%")},50)}else{o.animate({width:0},j*1000)}var f=setInterval(function(){var q=moment().unix();var p=Chorus.Comments.edit_timer-(q-l);if(p<=0){clearInterval(f);n.hide()}else{m.html(p)}},1000)},cancel_edit_form:function(f){e["_"+f]=false;d("#comment_edit_"+f).remove();d("#comment_body_"+f+", #comment_title_"+f).show()},cancel_comment_form:function(f){if(f!==undefined){d("#comment_form_container_"+f).html("")}else{d("#main_comment_form_head").val("");d("#main_comment_form_body").val("");d("#main_comment_preview").html("")}},edit:function(l){if(e["_"+l]===true){return}e["_"+l]=true;var m=Chorus.Comments.Json.get(l);var f=d("#comment_body_"+l);var i=d("#comment_title_"+l);f.hide();i.hide();var j=Chorus.Comments.Json.Templates["comment-edit-template"];if(m.submitted_body){m.body=m.submitted_body}var h=j({comment:m});var g=d('<div id="comment_edit_'+l+'"></div>');g.html(h);f.after(g);d("#comment_edit_body_"+l).markItUp(Chorus.Comments.Options.button_options);d("#comment_edit_form_"+l+" .text-input").focus()},reply:function(i){if(Chorus.Comments.user_id&&!Chorus.Comments.Options.able_to_comment){var j=d("#comment_tease").offset();if(j){d(window).scrollTop(j.top-Chorus.Comments.Options.fixed_header_height)}return false}else{if(!Chorus.Comments.user_id){var g=Chorus.Comments.Json.Templates["comment-modal-login-template"];Chorus.Comments.UIAdapter.openModal(g());return false}}var l=Chorus.Comments.Json.get(i);var f=d("#comment_form_container_"+i);var h=Chorus.Comments.Json.Templates["comment-reply-template"];f.html(h({comment:l}));d("#comment_reply_body_"+i).markItUp(Chorus.Comments.Options.button_options);d("#comment_reply_form_"+i+" .text-input").focus()},hide_autoupdate_info:function(){d("#autoupdate_info").hide();return false},show_new_comment_alert:function(){this.Options.show_new_comment_alert=true;return this.Options.show_new_comment_alert},hide_new_comment_alert:function(){this.Options.show_new_comment_alert=false;return this.Options.show_new_comment_alert},toggle_formatting_guide:function(){d("#formatting_guide_links a").toggle();d("#comment_formatting_guide").slideToggle();return false},inspect_flags:function(f){Chorus.Comments.Json.load_flags(f)},Json:{initialize:function(){Chorus.Comments.loaded=false;this._comments={};this.Users.initialize();this.Templates={};var h=d("script.template");for(var g=0;g<h.length;g++){var j=h[g];var l=d(j).html();var f=d(j).attr("id");this.Templates[f]=_.template(l)}d(".speed-read-link").on(Chorus.Comments.Options.click_event,function(i){i.preventDefault();d(".comments_wrapper").toggleClass("ui-state-speed-read-tips-active")})},reload_comments:function(){this.initialize();this.load_comments()},load_comments:function(g){if(Chorus.Comments.busy||Chorus.Comments.loaded){return}Chorus.Comments.busy=true;Chorus.Comments.loading_indicator.show();if(g===undefined){g=false}var h="/comments/load_comments/"+Chorus.Comments.entry_id;if(g){h+="?t="+(new Date()).getTime()}var f=d("#show_comments_link");d("#load_more button").text("Loading...");Chorus.Comments.current_page++;var i=d(".comments_wrapper");i.removeClass("ui-state-unloaded");i.addClass("ui-state-loading");i.removeClass("ui-state-loaded");d.ajax({url:h,dataType:"json",success:function(j){Chorus.Comments.Json.comment_template=Chorus.Comments.Json.Templates["comment-template"];Chorus.Comments.Json.load(j);Chorus.Comments.Json.Users.load(j.users);Chorus.Comments.Json.renderPage(j.comments);Chorus.Comments.lastId=j.last_comment_id;d("#load_more button").text("Load More");d("#load_more").show();d(Chorus.Comments).trigger("comments_loaded");Chorus.Comments.loading_indicator.hide();if(f.length>0){f.hide()}},error:function(j){Chorus.Comments.busy=false;Chorus.Comments.loading_indicator.hide();Chorus.Comments.load_comments_failure()}})},load_flags:function(g){var f=Chorus.Comments.Json._comments[g];if(f){var h="/comments/ajax_comment_flags/"+g;d.ajax({url:h,dataType:"json",success:function(l){Chorus.Comments.Json.Users.load(l.users);var j=Chorus.Comments.Json.Templates["comment-flags-modal-template"];var i=j({comment:f,flaggings:l.flaggings});Chorus.Comments.UIAdapter.openModal(i)},error:function(i){alert("Couldn't load flags for "+g)}})}},initialize_comment:function(g){if(!!g.parent_id){g.parent_element="comment_item_"+g.parent_id;g.preview_element="comment_preview_"+g.parent_id;g.parent=Chorus.Comments.Json.get(g.parent_id);if(!g.parent){g.parent_id=null}}else{g.preview_element="main_comment_preview";g.parent_element=Chorus.Comments.comments_container}g.element="comment_item_"+g.id;if(!g.ancestry&&!!g.id){if(g.parent){g.ancestry=g.parent.ancestry+"/"+g.id}else{g.ancestry=g.id.toString()}g.depth=g.ancestry.split("/").length}g.user=Chorus.Comments.Json.Users.find(g.user_id);if(g.user===undefined){g.user={display_name:"anonymous"}}var f=(!!g.created_on)?moment(g.created_on):moment();g.created_on_date=f.format("MMM D, YYYY | h:mm A");g.created_on_date_mobile=f.format("MM.DD.YY h:mma").slice(0,-1);g.created_timestamp=f.unix();g.bad_flags_count=g.troll_flags_count+g.spam_flags_count+g.inappropriate_flags_count;if(g.user.author_profile){g.user.profile_image=g.user.author_profile.image_url;g.user.profile_url=g.user.author_profile.url}else{if(g.user.network_membership){g.user.profile_image=g.user.network_membership.image_url;g.user.profile_url=g.user.network_membership.url}}g.html=Chorus.Comments.Json.comment_template({comment:g})},exists:function(f){return this._comments[parseInt(f.id,10)]!==undefined},add:function(g,f){if(!f&&this.exists(g)){return false}else{this._comments[parseInt(g.id,10)]=g;return true}},get:function(f){return this._comments[parseInt(f,10)]},has_hidden_parent:function(f){if(!f){return false}var g=Chorus.Comments.Json.get(f);if(!!g.parent_id){return !!g.hidden||Chorus.Comments.Json.has_hidden_parent(g.parent_id)}else{return !!g.hidden}},insert_comment:function(j,h){var n=Chorus.Comments.Json.get(j);if(!n){return}var g=d("#"+n.parent_element);if(!n.parent_id){g.append(n.html)}else{var f=g.next();var m=g.data("commentDepth");var i=f.data("commentDepth");var l=null;while(f&&f.length>0){if(i<=m){l=f.prev();f=null}else{f=f.next();i=f.data("commentDepth")}}if(l==null){l=g.parent().children().last()}l.after(n.html);if(n.depth>Chorus.Comments.Options.depth_to_start_contextualizing){Chorus.Comments.contextualize_flat_comments(d("#"+n.element),n.depth)}if(g.hasClass(Chorus.Comments.collapsed_class)||g.hasClass(Chorus.Comments.collapsed_class+"-child")){d("#"+n.element).addClass(Chorus.Comments.collapsed_class+"-child")}}if(Chorus.Comments.user_id===n.user_id&&Chorus.Comments.is_editable(n.created_timestamp)){Chorus.Comments.edit_countdown(j)}if(Vox.Environment.touch()){d("#"+n.element).addClass(Chorus.Comments.touch_enabled_class)}if(Util.UserAgentProfiler.isMobile()&&!h){d("#"+n.element).removeClass(Chorus.Comments.new_comment_class).addClass(Chorus.Comments.hidden_mobile_class)}},load:function(j){var l=j.comments;var h=j.new_comment_ids;var f,m;for(f=0;f<l.length;f++){this.add(l[f])}for(f=0;f<h.length;f++){var g=parseInt(h[f],10);m=this._comments[g];if(m!==undefined){m.is_new=true}}},update_comment_actions:function(i){var f=d("#comment_item_"+i.id);var h=d(".cactions",f).first();var g=this.render_comment_actions(i);h.html(g)},render_comment_actions:function(h){var g=Chorus.Comments.Json.Templates["comment-actions-template"];var f=g({comment:h});return f},getChildrenOfComment:function(i){var j=d("#comment_item_"+i);var h=j.data("commentDepth");var g=j.next(".citem");var f=d();while(g.data("commentDepth")>h){f=f.add(g);g=g.next(".citem")}return f},renderPage:function(p){var g=d("#"+Chorus.Comments.comments_container);var n,m,l=[],h=200;for(n=0,m=p.length;n<m;n+=h){l.push(p.slice(n,n+h))}var f=0;var o=function(){var i="";_.each(l[f],function(j){Chorus.Comments.Json.initialize_comment(j);i+=j.html});g.append(i);g.find(".citem").each(function(){var j=d(this).data();if(j.commentDepth>Chorus.Comments.Options.depth_to_start_contextualizing){Chorus.Comments.contextualize_flat_comments(d(this),j.commentDepth)}if(j.userId===Chorus.Comments.user_id&&Chorus.Comments.is_editable(j.timestamp)){Chorus.Comments.edit_countdown(j.commentId)}if(Vox.Environment.touch()){d(this).addClass(Chorus.Comments.touch_enabled_class)}});f++;if(f<l.length){setTimeout(o,Math.min(f*50,300))}else{Chorus.Comments.load_comments_success()}};setTimeout(o,0)},check_for_updates:function(){if(Chorus.Comments.auto_updating===true){return false}else{Chorus.Comments.auto_updating=true}var f="/comments/ajax_comments_update/"+Chorus.Comments.entry_id+"?last_version="+Chorus.Comments.entry_version+"&last_id="+Chorus.Comments.lastId+"&type=Entry&request_id="+(++Chorus.Comments.lastRequestId);d.ajax({url:f,dataType:"json",timeout:15000,error:function(){Chorus.Comments.auto_updating=false;Chorus.Comments.check_empty_count(Chorus.Comments.empty_count+1)},success:function(m){Chorus.Comments.auto_updating=false;if(Chorus.Comments.lastRequestId===parseInt(m.last_request_id,10)){Chorus.Comments.lastId=m.last_id;Chorus.Comments.entry_version=m.last_version;Chorus.Comments.Json.Users.add(m.users);for(var h=0,g=m.deleted_comment_ids.length;h<g;h++){var l=m.deleted_comment_ids[h];Chorus.Comments.Json.getChildrenOfComment(l).remove();d("#comment_item_"+l).remove()}var j=[];for(var h=0;h<m.comments.length;h++){var n=m.comments[h];if(Chorus.Comments.Json.add(n)===true){n.is_new=true;Chorus.Comments.Json.initialize_comment(n);Chorus.Comments.Json.insert_comment(n.id,true);j.push(n);Chorus.Comments.highlight_comment(n)}}if(j.length>0){Chorus.Comments.check_empty_count(0);Chorus.Comments.Cycle.refresh();if(Util.UserAgentProfiler.isMobile()===true){d(Chorus.Comments.touchTools.bar).addClass(Chorus.Comments.touchTools.newCommentsClass)}else{Chorus.Comments.Json.render_autoupdate_info(j)}}else{Chorus.Comments.check_empty_count(Chorus.Comments.empty_count+1)}}}})},render_autoupdate_info:function(l){if(Chorus.Comments.Options.show_new_comment_alert!==true){return false}var n=l;var f=5;var m=(n.length-f);var j=Chorus.Comments.Json.Templates["comment-alert-template"];var g=j({max_comments:f,comments:n,additional_comments:m});var i=d("#autoupdate_info_list");var h=d("#autoupdate_info");h.show();i.html(g);h.fadeIn(1000);setTimeout(function(){h.fadeOut(500)},6500)},Users:{initialize:function(){this.users={}},find:function(f){return this._users[f]},add:function(h){if((h instanceof Array)===false){h=[h]}var f;for(var g=0;g<h.length;g++){f=h[g];this._users[f.id]=f}},load:function(f){this._users={};this.add(f)}}}};Chorus.Comments.Cycle={};Chorus.Comments.Cycle.list=[];Chorus.Comments.Cycle.action_queue=[];Chorus.Comments.Cycle.index=-1;Chorus.Comments.Cycle.lookingAtComment=true;Chorus.Comments.Cycle.inAction=false;Chorus.Comments.Cycle.inRefresh=false;Chorus.Comments.Cycle.previous=function(){if(!Chorus.Comments.Cycle.lookingAtComment){++Chorus.Comments.Cycle.index}var f=(Chorus.Comments.Cycle.index<=0)?Chorus.Comments.Cycle.list.length-1:Chorus.Comments.Cycle.index-1;Chorus.Comments.Cycle.goToIndex(f)};Chorus.Comments.Cycle.next=function(){var f=(Chorus.Comments.Cycle.index>=Chorus.Comments.Cycle.list.length-1)?0:Chorus.Comments.Cycle.index+1;Chorus.Comments.Cycle.goToIndex(f)};Chorus.Comments.Cycle.remove=function(){if(!Chorus.Comments.Cycle.lookingAtComment){return}else{var f=Chorus.Comments.Cycle.currentComment();if(f===null){return}else{f.find(".comment").removeClass("new");f.removeClass("new");Chorus.Comments.Cycle.notCurrent(f);Chorus.Comments.Cycle.list.splice(Chorus.Comments.Cycle.index,1);Chorus.Comments.Cycle.lookingAtComment=false;--Chorus.Comments.Cycle.index}}};Chorus.Comments.Cycle.removeAll=function(){if(false&&Chorus.Comments.Cycle.list.length>=50){Chorus.openModalWithContents("Unmarking "+Chorus.Comments.Cycle.list.length+" comments.",{overlayDisplay:false,fade:true,fadeDuration:0});setTimeout(Chorus.Comments.doRemoveAll,100)}else{Chorus.Comments.doRemoveAll()}};Chorus.Comments.doRemoveAll=function(){var g=Chorus.Comments.Cycle.currentComment();var f=Chorus.Comments.Cycle.list;Chorus.Comments.Cycle.list=[];if(g!==null){Chorus.Comments.Cycle.notCurrent(g)}_.each(f,function(i){var h=d("#"+i);h.find(".comment").removeClass("new");h.removeClass("new")})};Chorus.Comments.Cycle.currentComment=function(){if(Chorus.Comments.Cycle.index<0||Chorus.Comments.Cycle.index>=Chorus.Comments.Cycle.list.length){return null}else{return d("#"+Chorus.Comments.Cycle.list[Chorus.Comments.Cycle.index])}};Chorus.Comments.Cycle.goToComment=function(f){Chorus.Comments.Cycle.goToIndex(_.indexOf(Chorus.Comments.Cycle.list,f))};Chorus.Comments.Cycle.goToIndex=function(f){if(Chorus.Comments.Cycle.list.length===0){return}else{var i=Chorus.Comments.Cycle.currentComment();if(i!==null){Chorus.Comments.Cycle.notCurrent(i)}Chorus.Comments.Cycle.index=f;var g=Chorus.Comments.Cycle.currentComment();var h=g.attr("data-comment-id");Chorus.Comments.Cycle.current(g);Chorus.Comments.scroll_to(h);Chorus.Comments.Cycle.lookingAtComment=true}};Chorus.Comments.Cycle.current=function(f){f.addClass("active_comment")};Chorus.Comments.Cycle.notCurrent=function(f){f.removeClass("active_comment")};Chorus.Comments.Cycle.reply=function(){var f=d(Chorus.Comments.Cycle.currentComment());var g=d(".reply_link",f);if(g){g.trigger(Chorus.Comments.Options.click_event)}};Chorus.Comments.Cycle.safeAction=function(f){return function(){Chorus.Comments.Cycle.action_queue.push(f);if(!Chorus.Comments.loaded){d(window).scrollTop(d("#comments").offset().top-Chorus.Comments.Options.fixed_header_height);Chorus.Comments.Json.load_comments(true);return}if(Chorus.Comments.Cycle.inRefresh){return}Chorus.Comments.Cycle.performActionQueue()}};Chorus.Comments.Cycle.performActionQueue=function(){Chorus.Comments.Cycle.inAction=true;var g=50;var f=0;while(Chorus.Comments.Cycle.action_queue.length>0&&f<g){(Chorus.Comments.Cycle.action_queue.shift())();f++}Chorus.Comments.Cycle.inAction=false};Chorus.Comments.Cycle.refresh=function(){if(Chorus.Comments.Cycle.inAction){setTimeout(Chorus.Comments.Cycle.refresh,50);return}Chorus.Comments.Cycle.inRefresh=true;var f=Chorus.Comments.Cycle.currentComment();Chorus.Comments.Cycle.list=_.map(d("#"+Chorus.Comments.comments_container+" .citem.new"),function(g){return g.id});if(!!f){Chorus.Comments.Cycle.index=_.indexOf(Chorus.Comments.Cycle.list,f[0].id)}Chorus.Comments.Cycle.inRefresh=false;Chorus.Comments.Cycle.performActionQueue()};Chorus.Comments.toggleActions=function(f){d(".sbn-comment[data-comment-id="+f+"]").toggleClass("ui-state-tools-active")};Chorus.Comments.initializeKeyboardShortcuts=function(){shortcut.add("Shift+a",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.removeAll()}),{disable_in_input:true});shortcut.add("Shift+c",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.previous()}),{disable_in_input:true});shortcut.add("c",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.next()}),{disable_in_input:true});shortcut.add("j",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.next()}),{disable_in_input:true});shortcut.add("k",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.previous()}),{disable_in_input:true});shortcut.add("x",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.remove()}),{disable_in_input:true});shortcut.add("z",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.remove();Chorus.Comments.Cycle.next()}),{disable_in_input:true});shortcut.add("r",Chorus.Comments.Cycle.safeAction(function(){Chorus.Comments.Cycle.reply()}),{disable_in_input:true})}})(jQuery);